const __vite__fileDeps=["../chunks/browser.BVZztmgU.js","../chunks/viewport.CNTsduTY.js","../chunks/index.BCKwTHzZ.js","../chunks/scheduler.DWvxBnEd.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
var Vz=Object.defineProperty;var jz=(t,e,i)=>e in t?Vz(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var fe=(t,e,i)=>(jz(t,typeof e!="symbol"?e+"":e,i),i);import{s as zl,e as Vt,k as df,C as nk,c as jt,d as bt,p as tt,f as Et,n as Es,H as e1,i as Zi,N as sk,ac as a3,_ as l3,a4 as ok,h as Fc,o as t1,a as $i,q as An,Z as Wo,r as vw,j as or,w as rn,l as ar,E as Ss,ad as Rc,ae as $z,t as so,b as oo,x as c3,af as Wz,L as Gc,G as L_,g as Uc,a9 as ak,aa as lk,$ as e_,a0 as t_,ag as u3,ah as Hz,a6 as h3}from"../chunks/scheduler.DWvxBnEd.js";import{S as Xc,i as Zc,n as qz,l as Gz,h as nl,a as yr,g as Fo,t as Kr,c as Bo,j as QT,b as mh,d as _h,m as gh,e as yh,k as Xz}from"../chunks/index.C32fdg8C.js";import{e as Vc}from"../chunks/each.D6YF6ztN.js";import{g as i1,c as oh,a as Zz,l as Yz,v as Kz}from"../chunks/viewport.CNTsduTY.js";import{d as Jz,i as Qz}from"../chunks/transform.BIl3ljzv.js";import{w as r1}from"../chunks/index.BCKwTHzZ.js";import{_ as ff}from"../chunks/preload-helper.D6kgxu3v.js";function e5(t,e){for(var i=0;i<e.length;i++){const s=e[i];if(typeof s!="string"&&!Array.isArray(s)){for(const c in s)if(c!=="default"&&!(c in t)){const h=Object.getOwnPropertyDescriptor(s,c);h&&Object.defineProperty(t,c,h.get?h:{enumerable:!0,get:()=>s[c]})}}}return Object.freeze(Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}))}function d3(t,e,i){const s=t.slice();return s[1]=e[i],s}function f3(t){let e;return{c(){e=Vt("link"),this.h()},l(i){e=jt(i,"LINK",{rel:!0,href:!0,as:!0,type:!0,crossorigin:!0}),this.h()},h(){tt(e,"rel","preload"),tt(e,"href",t[1]),tt(e,"as","font"),tt(e,"type","font/woff2"),tt(e,"crossorigin","")},m(i,s){Zi(i,e,s)},p:Es,d(i){i&&bt(e)}}}function t5(t){let e,i,s,c,h,p,v,l,A,P,O,L,U,H,Y,J,oe,me,pe,be,Oe,je,st;document.title=e=Ly;let ut=Vc(t[0]),xe=[];for(let it=0;it<ut.length;it+=1)xe[it]=f3(d3(t,ut,it));return{c(){i=Vt("meta"),s=Vt("meta"),c=Vt("meta"),h=Vt("meta"),p=Vt("meta"),v=Vt("meta"),l=Vt("meta"),A=Vt("meta"),P=Vt("meta"),O=Vt("meta"),L=Vt("meta"),U=Vt("meta"),H=Vt("meta"),Y=Vt("meta"),J=Vt("meta"),oe=Vt("meta"),me=Vt("meta"),pe=Vt("meta"),be=Vt("meta"),Oe=Vt("meta"),je=Vt("link");for(let it=0;it<xe.length;it+=1)xe[it].c();st=df(),this.h()},l(it){const Be=nk("svelte-1req58p",document.head);i=jt(Be,"META",{name:!0,content:!0}),s=jt(Be,"META",{name:!0,content:!0}),c=jt(Be,"META",{name:!0,content:!0}),h=jt(Be,"META",{property:!0,content:!0}),p=jt(Be,"META",{property:!0,content:!0}),v=jt(Be,"META",{property:!0,content:!0}),l=jt(Be,"META",{property:!0,content:!0}),A=jt(Be,"META",{property:!0,content:!0}),P=jt(Be,"META",{property:!0,content:!0}),O=jt(Be,"META",{property:!0,content:!0}),L=jt(Be,"META",{property:!0,content:!0}),U=jt(Be,"META",{property:!0,content:!0}),H=jt(Be,"META",{property:!0,content:!0}),Y=jt(Be,"META",{name:!0,content:!0}),J=jt(Be,"META",{name:!0,content:!0}),oe=jt(Be,"META",{name:!0,content:!0}),me=jt(Be,"META",{name:!0,content:!0}),pe=jt(Be,"META",{name:!0,content:!0}),be=jt(Be,"META",{name:!0,content:!0}),Oe=jt(Be,"META",{name:!0,content:!0}),je=jt(Be,"LINK",{rel:!0,href:!0});for(let Qe=0;Qe<xe.length;Qe+=1)xe[Qe].l(Be);st=df(),Be.forEach(bt),this.h()},h(){tt(i,"name","description"),tt(i,"content",db),tt(s,"name","author"),tt(s,"content","The Pudding"),tt(c,"name","news_keywords"),tt(c,"content",i5),tt(h,"property","og:title"),tt(h,"content",Ly),tt(p,"property","og:site_name"),tt(p,"content","The Pudding"),tt(v,"property","og:url"),tt(v,"content",Ny),tt(l,"property","og:description"),tt(l,"content",db),tt(A,"property","og:type"),tt(A,"content","article"),tt(P,"property","og:locale"),tt(P,"content","en_US"),tt(O,"property","og:image"),tt(O,"content",Ny+"/assets/social.jpg"),tt(L,"property","og:image:type"),tt(L,"content","image/jpeg"),tt(U,"property","og:image:width"),tt(U,"content","1200"),tt(H,"property","og:image:height"),tt(H,"content","630"),tt(Y,"name","twitter:card"),tt(Y,"content","summary_large_image"),tt(J,"name","twitter:site"),tt(J,"content","https://pudding.cool"),tt(oe,"name","twitter:creator"),tt(oe,"content","@puddingviz"),tt(me,"name","twitter:title"),tt(me,"content",Ly),tt(pe,"name","twitter:description"),tt(pe,"content",db),tt(be,"name","twitter:image:src"),tt(be,"content",Ny+"/assets/social.jpg"),tt(Oe,"name","robots"),tt(Oe,"content","max-image-preview:large"),tt(je,"rel","canonical"),tt(je,"href",Ny+"/")},m(it,Be){Et(document.head,i),Et(document.head,s),Et(document.head,c),Et(document.head,h),Et(document.head,p),Et(document.head,v),Et(document.head,l),Et(document.head,A),Et(document.head,P),Et(document.head,O),Et(document.head,L),Et(document.head,U),Et(document.head,H),Et(document.head,Y),Et(document.head,J),Et(document.head,oe),Et(document.head,me),Et(document.head,pe),Et(document.head,be),Et(document.head,Oe),Et(document.head,je);for(let Qe=0;Qe<xe.length;Qe+=1)xe[Qe]&&xe[Qe].m(document.head,null);Et(document.head,st)},p(it,[Be]){if(Be&0&&e!==(e=Ly)&&(document.title=e),Be&1){ut=Vc(it[0]);let Qe;for(Qe=0;Qe<ut.length;Qe+=1){const Ct=d3(it,ut,Qe);xe[Qe]?xe[Qe].p(Ct,Be):(xe[Qe]=f3(Ct),xe[Qe].c(),xe[Qe].m(st.parentNode,st))}for(;Qe<xe.length;Qe+=1)xe[Qe].d(1);xe.length=ut.length}},i:Es,o:Es,d(it){bt(i),bt(s),bt(c),bt(h),bt(p),bt(v),bt(l),bt(A),bt(P),bt(O),bt(L),bt(U),bt(H),bt(Y),bt(J),bt(oe),bt(me),bt(pe),bt(be),bt(Oe),bt(je),e1(xe,it),bt(st)}}}let Ly="Every Outdoor Basketball Court in the U.S.A.",db="Explore Satellite Imagery of 59,507 Basketball Courts",Ny="https://pudding.cool/2024/09/courts",i5="basketball,courts,satellite,images";function r5(t){return[[]]}class n5 extends Xc{constructor(e){super(),Zc(this,e,r5,t5,zl,{})}}function S0(t,e){return t==null||e==null?NaN:t<e?-1:t>e?1:t>=e?0:NaN}function ck(t){let e,i,s;t.length!==2?(e=S0,i=(v,l)=>S0(t(v),l),s=(v,l)=>t(v)-l):(e=t===S0||t===Jz?t:s5,i=t,s=t);function c(v,l,A=0,P=v.length){if(A<P){if(e(l,l)!==0)return P;do{const O=A+P>>>1;i(v[O],l)<0?A=O+1:P=O}while(A<P)}return A}function h(v,l,A=0,P=v.length){if(A<P){if(e(l,l)!==0)return P;do{const O=A+P>>>1;i(v[O],l)<=0?A=O+1:P=O}while(A<P)}return A}function p(v,l,A=0,P=v.length){const O=c(v,l,A,P-1);return O>A&&s(v[O-1],l)>-s(v[O],l)?O-1:O}return{left:c,center:p,right:h}}function s5(){return 0}function o5(t){return t===null?NaN:+t}const a5=ck(S0),l5=a5.right;ck(o5).center;class vh{constructor(){this._partials=new Float64Array(32),this._n=0}add(e){const i=this._partials;let s=0;for(let c=0;c<this._n&&c<32;c++){const h=i[c],p=e+h,v=Math.abs(e)<Math.abs(h)?e-(p-h):h-(p-e);v&&(i[s++]=v),e=p}return i[s]=e,this._n=s+1,this}valueOf(){const e=this._partials;let i=this._n,s,c,h,p=0;if(i>0){for(p=e[--i];i>0&&(s=p,c=e[--i],p=s+c,h=c-(p-s),!h););i>0&&(h<0&&e[i-1]<0||h>0&&e[i-1]>0)&&(c=h*2,s=p+c,c==s-p&&(p=s))}return p}}const c5=Math.sqrt(50),u5=Math.sqrt(10),h5=Math.sqrt(2);function F0(t,e,i){const s=(e-t)/Math.max(0,i),c=Math.floor(Math.log10(s)),h=s/Math.pow(10,c),p=h>=c5?10:h>=u5?5:h>=h5?2:1;let v,l,A;return c<0?(A=Math.pow(10,-c)/p,v=Math.round(t*A),l=Math.round(e*A),v/A<t&&++v,l/A>e&&--l,A=-A):(A=Math.pow(10,c)*p,v=Math.round(t/A),l=Math.round(e/A),v*A<t&&++v,l*A>e&&--l),l<v&&.5<=i&&i<2?F0(t,e,i*2):[v,l,A]}function d5(t,e,i){if(e=+e,t=+t,i=+i,!(i>0))return[];if(t===e)return[t];const s=e<t,[c,h,p]=s?F0(e,t,i):F0(t,e,i);if(!(h>=c))return[];const v=h-c+1,l=new Array(v);if(s)if(p<0)for(let A=0;A<v;++A)l[A]=(h-A)/-p;else for(let A=0;A<v;++A)l[A]=(h-A)*p;else if(p<0)for(let A=0;A<v;++A)l[A]=(c+A)/-p;else for(let A=0;A<v;++A)l[A]=(c+A)*p;return l}function xw(t,e,i){return e=+e,t=+t,i=+i,F0(t,e,i)[2]}function f5(t,e,i){e=+e,t=+t,i=+i;const s=e<t,c=s?xw(e,t,i):xw(t,e,i);return(s?-1:1)*(c<0?1/-c:c)}function*p5(t){for(const e of t)yield*e}function uk(t){return Array.from(p5(t))}function eE(t,e,i){t.prototype=e.prototype=i,i.constructor=t}function hk(t,e){var i=Object.create(t.prototype);for(var s in e)i[s]=e[s];return i}function N_(){}var __=.7,B0=1/__,nf="\\s*([+-]?\\d+)\\s*",g_="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",rl="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",m5=/^#([0-9a-f]{3,8})$/,_5=new RegExp(`^rgb\\(${nf},${nf},${nf}\\)$`),g5=new RegExp(`^rgb\\(${rl},${rl},${rl}\\)$`),y5=new RegExp(`^rgba\\(${nf},${nf},${nf},${g_}\\)$`),v5=new RegExp(`^rgba\\(${rl},${rl},${rl},${g_}\\)$`),x5=new RegExp(`^hsl\\(${g_},${rl},${rl}\\)$`),b5=new RegExp(`^hsla\\(${g_},${rl},${rl},${g_}\\)$`),p3={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};eE(N_,y_,{copy(t){return Object.assign(new this.constructor,this,t)},displayable(){return this.rgb().displayable()},hex:m3,formatHex:m3,formatHex8:w5,formatHsl:T5,formatRgb:_3,toString:_3});function m3(){return this.rgb().formatHex()}function w5(){return this.rgb().formatHex8()}function T5(){return dk(this).formatHsl()}function _3(){return this.rgb().formatRgb()}function y_(t){var e,i;return t=(t+"").trim().toLowerCase(),(e=m5.exec(t))?(i=e[1].length,e=parseInt(e[1],16),i===6?g3(e):i===3?new yo(e>>8&15|e>>4&240,e>>4&15|e&240,(e&15)<<4|e&15,1):i===8?Fy(e>>24&255,e>>16&255,e>>8&255,(e&255)/255):i===4?Fy(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|e&240,((e&15)<<4|e&15)/255):null):(e=_5.exec(t))?new yo(e[1],e[2],e[3],1):(e=g5.exec(t))?new yo(e[1]*255/100,e[2]*255/100,e[3]*255/100,1):(e=y5.exec(t))?Fy(e[1],e[2],e[3],e[4]):(e=v5.exec(t))?Fy(e[1]*255/100,e[2]*255/100,e[3]*255/100,e[4]):(e=x5.exec(t))?x3(e[1],e[2]/100,e[3]/100,1):(e=b5.exec(t))?x3(e[1],e[2]/100,e[3]/100,e[4]):p3.hasOwnProperty(t)?g3(p3[t]):t==="transparent"?new yo(NaN,NaN,NaN,0):null}function g3(t){return new yo(t>>16&255,t>>8&255,t&255,1)}function Fy(t,e,i,s){return s<=0&&(t=e=i=NaN),new yo(t,e,i,s)}function E5(t){return t instanceof N_||(t=y_(t)),t?(t=t.rgb(),new yo(t.r,t.g,t.b,t.opacity)):new yo}function bw(t,e,i,s){return arguments.length===1?E5(t):new yo(t,e,i,s??1)}function yo(t,e,i,s){this.r=+t,this.g=+e,this.b=+i,this.opacity=+s}eE(yo,bw,hk(N_,{brighter(t){return t=t==null?B0:Math.pow(B0,t),new yo(this.r*t,this.g*t,this.b*t,this.opacity)},darker(t){return t=t==null?__:Math.pow(__,t),new yo(this.r*t,this.g*t,this.b*t,this.opacity)},rgb(){return this},clamp(){return new yo(ah(this.r),ah(this.g),ah(this.b),z0(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:y3,formatHex:y3,formatHex8:S5,formatRgb:v3,toString:v3}));function y3(){return`#${ih(this.r)}${ih(this.g)}${ih(this.b)}`}function S5(){return`#${ih(this.r)}${ih(this.g)}${ih(this.b)}${ih((isNaN(this.opacity)?1:this.opacity)*255)}`}function v3(){const t=z0(this.opacity);return`${t===1?"rgb(":"rgba("}${ah(this.r)}, ${ah(this.g)}, ${ah(this.b)}${t===1?")":`, ${t})`}`}function z0(t){return isNaN(t)?1:Math.max(0,Math.min(1,t))}function ah(t){return Math.max(0,Math.min(255,Math.round(t)||0))}function ih(t){return t=ah(t),(t<16?"0":"")+t.toString(16)}function x3(t,e,i,s){return s<=0?t=e=i=NaN:i<=0||i>=1?t=e=NaN:e<=0&&(t=NaN),new ga(t,e,i,s)}function dk(t){if(t instanceof ga)return new ga(t.h,t.s,t.l,t.opacity);if(t instanceof N_||(t=y_(t)),!t)return new ga;if(t instanceof ga)return t;t=t.rgb();var e=t.r/255,i=t.g/255,s=t.b/255,c=Math.min(e,i,s),h=Math.max(e,i,s),p=NaN,v=h-c,l=(h+c)/2;return v?(e===h?p=(i-s)/v+(i<s)*6:i===h?p=(s-e)/v+2:p=(e-i)/v+4,v/=l<.5?h+c:2-h-c,p*=60):v=l>0&&l<1?0:p,new ga(p,v,l,t.opacity)}function ww(t,e,i,s){return arguments.length===1?dk(t):new ga(t,e,i,s??1)}function ga(t,e,i,s){this.h=+t,this.s=+e,this.l=+i,this.opacity=+s}eE(ga,ww,hk(N_,{brighter(t){return t=t==null?B0:Math.pow(B0,t),new ga(this.h,this.s,this.l*t,this.opacity)},darker(t){return t=t==null?__:Math.pow(__,t),new ga(this.h,this.s,this.l*t,this.opacity)},rgb(){var t=this.h%360+(this.h<0)*360,e=isNaN(t)||isNaN(this.s)?0:this.s,i=this.l,s=i+(i<.5?i:1-i)*e,c=2*i-s;return new yo(fb(t>=240?t-240:t+120,c,s),fb(t,c,s),fb(t<120?t+240:t-120,c,s),this.opacity)},clamp(){return new ga(b3(this.h),By(this.s),By(this.l),z0(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const t=z0(this.opacity);return`${t===1?"hsl(":"hsla("}${b3(this.h)}, ${By(this.s)*100}%, ${By(this.l)*100}%${t===1?")":`, ${t})`}`}}));function b3(t){return t=(t||0)%360,t<0?t+360:t}function By(t){return Math.max(0,Math.min(1,t||0))}function fb(t,e,i){return(t<60?e+(i-e)*t/60:t<180?i:t<240?e+(i-e)*(240-t)/60:e)*255}const tE=t=>()=>t;function A5(t,e){return function(i){return t+i*e}}function M5(t,e,i){return t=Math.pow(t,i),e=Math.pow(e,i)-t,i=1/i,function(s){return Math.pow(t+s*e,i)}}function C5(t){return(t=+t)==1?fk:function(e,i){return i-e?M5(e,i,t):tE(isNaN(e)?i:e)}}function fk(t,e){var i=e-t;return i?A5(t,i):tE(isNaN(t)?e:t)}const w3=function t(e){var i=C5(e);function s(c,h){var p=i((c=bw(c)).r,(h=bw(h)).r),v=i(c.g,h.g),l=i(c.b,h.b),A=fk(c.opacity,h.opacity);return function(P){return c.r=p(P),c.g=v(P),c.b=l(P),c.opacity=A(P),c+""}}return s.gamma=t,s}(1);function pk(t,e){e||(e=[]);var i=t?Math.min(e.length,t.length):0,s=e.slice(),c;return function(h){for(c=0;c<i;++c)s[c]=t[c]*(1-h)+e[c]*h;return s}}function P5(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)}function I5(t,e){var i=e?e.length:0,s=t?Math.min(i,t.length):0,c=new Array(s),h=new Array(i),p;for(p=0;p<s;++p)c[p]=iE(t[p],e[p]);for(;p<i;++p)h[p]=e[p];return function(v){for(p=0;p<s;++p)h[p]=c[p](v);return h}}function R5(t,e){var i=new Date;return t=+t,e=+e,function(s){return i.setTime(t*(1-s)+e*s),i}}function v_(t,e){return t=+t,e=+e,function(i){return t*(1-i)+e*i}}function O5(t,e){var i={},s={},c;(t===null||typeof t!="object")&&(t={}),(e===null||typeof e!="object")&&(e={});for(c in e)c in t?i[c]=iE(t[c],e[c]):s[c]=e[c];return function(h){for(c in i)s[c]=i[c](h);return s}}var Tw=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,pb=new RegExp(Tw.source,"g");function k5(t){return function(){return t}}function D5(t){return function(e){return t(e)+""}}function L5(t,e){var i=Tw.lastIndex=pb.lastIndex=0,s,c,h,p=-1,v=[],l=[];for(t=t+"",e=e+"";(s=Tw.exec(t))&&(c=pb.exec(e));)(h=c.index)>i&&(h=e.slice(i,h),v[p]?v[p]+=h:v[++p]=h),(s=s[0])===(c=c[0])?v[p]?v[p]+=c:v[++p]=c:(v[++p]=null,l.push({i:p,x:v_(s,c)})),i=pb.lastIndex;return i<e.length&&(h=e.slice(i),v[p]?v[p]+=h:v[++p]=h),v.length<2?l[0]?D5(l[0].x):k5(e):(e=l.length,function(A){for(var P=0,O;P<e;++P)v[(O=l[P]).i]=O.x(A);return v.join("")})}function iE(t,e){var i=typeof e,s;return e==null||i==="boolean"?tE(e):(i==="number"?v_:i==="string"?(s=y_(e))?(e=s,w3):L5:e instanceof y_?w3:e instanceof Date?R5:P5(e)?pk:Array.isArray(e)?I5:typeof e.valueOf!="function"&&typeof e.toString!="function"||isNaN(e)?O5:v_)(t,e)}function N5(t,e){return t=+t,e=+e,function(i){return Math.round(t*(1-i)+e*i)}}function zy(t){return((t*=2)<=1?t*t*t:(t-=2)*t*t+2)/2}var T3={},mb={},_b=34,Rm=10,gb=13;function mk(t){return new Function("d","return {"+t.map(function(e,i){return JSON.stringify(e)+": d["+i+'] || ""'}).join(",")+"}")}function F5(t,e){var i=mk(t);return function(s,c){return e(i(s),c,t)}}function E3(t){var e=Object.create(null),i=[];return t.forEach(function(s){for(var c in s)c in e||i.push(e[c]=c)}),i}function go(t,e){var i=t+"",s=i.length;return s<e?new Array(e-s+1).join(0)+i:i}function B5(t){return t<0?"-"+go(-t,6):t>9999?"+"+go(t,6):go(t,4)}function z5(t){var e=t.getUTCHours(),i=t.getUTCMinutes(),s=t.getUTCSeconds(),c=t.getUTCMilliseconds();return isNaN(t)?"Invalid Date":B5(t.getUTCFullYear())+"-"+go(t.getUTCMonth()+1,2)+"-"+go(t.getUTCDate(),2)+(c?"T"+go(e,2)+":"+go(i,2)+":"+go(s,2)+"."+go(c,3)+"Z":s?"T"+go(e,2)+":"+go(i,2)+":"+go(s,2)+"Z":i||e?"T"+go(e,2)+":"+go(i,2)+"Z":"")}function U5(t){var e=new RegExp('["'+t+`
\r]`),i=t.charCodeAt(0);function s(O,L){var U,H,Y=c(O,function(J,oe){if(U)return U(J,oe-1);H=J,U=L?F5(J,L):mk(J)});return Y.columns=H||[],Y}function c(O,L){var U=[],H=O.length,Y=0,J=0,oe,me=H<=0,pe=!1;O.charCodeAt(H-1)===Rm&&--H,O.charCodeAt(H-1)===gb&&--H;function be(){if(me)return mb;if(pe)return pe=!1,T3;var je,st=Y,ut;if(O.charCodeAt(st)===_b){for(;Y++<H&&O.charCodeAt(Y)!==_b||O.charCodeAt(++Y)===_b;);return(je=Y)>=H?me=!0:(ut=O.charCodeAt(Y++))===Rm?pe=!0:ut===gb&&(pe=!0,O.charCodeAt(Y)===Rm&&++Y),O.slice(st+1,je-1).replace(/""/g,'"')}for(;Y<H;){if((ut=O.charCodeAt(je=Y++))===Rm)pe=!0;else if(ut===gb)pe=!0,O.charCodeAt(Y)===Rm&&++Y;else if(ut!==i)continue;return O.slice(st,je)}return me=!0,O.slice(st,H)}for(;(oe=be())!==mb;){for(var Oe=[];oe!==T3&&oe!==mb;)Oe.push(oe),oe=be();L&&(Oe=L(Oe,J++))==null||U.push(Oe)}return U}function h(O,L){return O.map(function(U){return L.map(function(H){return P(U[H])}).join(t)})}function p(O,L){return L==null&&(L=E3(O)),[L.map(P).join(t)].concat(h(O,L)).join(`
`)}function v(O,L){return L==null&&(L=E3(O)),h(O,L).join(`
`)}function l(O){return O.map(A).join(`
`)}function A(O){return O.map(P).join(t)}function P(O){return O==null?"":O instanceof Date?z5(O):e.test(O+="")?'"'+O.replace(/"/g,'""')+'"':O}return{parse:s,parseRows:c,format:p,formatBody:v,formatRows:l,formatRow:A,formatValue:P}}var V5=U5(","),j5=V5.parse;function $5(t){if(!t.ok)throw new Error(t.status+" "+t.statusText);return t.text()}function W5(t,e){return fetch(t,e).then($5)}function H5(t){return function(e,i,s){return arguments.length===2&&typeof i=="function"&&(s=i,i=void 0),W5(e,i).then(function(c){return t(c,s)})}}var q5=H5(j5);function G5(t){return Math.abs(t=Math.round(t))>=1e21?t.toLocaleString("en").replace(/,/g,""):t.toString(10)}function U0(t,e){if((i=(t=e?t.toExponential(e-1):t.toExponential()).indexOf("e"))<0)return null;var i,s=t.slice(0,i);return[s.length>1?s[0]+s.slice(2):s,+t.slice(i+1)]}function pf(t){return t=U0(Math.abs(t)),t?t[1]:NaN}function X5(t,e){return function(i,s){for(var c=i.length,h=[],p=0,v=t[0],l=0;c>0&&v>0&&(l+v+1>s&&(v=Math.max(1,s-l)),h.push(i.substring(c-=v,c+v)),!((l+=v+1)>s));)v=t[p=(p+1)%t.length];return h.reverse().join(e)}}function Z5(t){return function(e){return e.replace(/[0-9]/g,function(i){return t[+i]})}}var Y5=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function V0(t){if(!(e=Y5.exec(t)))throw new Error("invalid format: "+t);var e;return new rE({fill:e[1],align:e[2],sign:e[3],symbol:e[4],zero:e[5],width:e[6],comma:e[7],precision:e[8]&&e[8].slice(1),trim:e[9],type:e[10]})}V0.prototype=rE.prototype;function rE(t){this.fill=t.fill===void 0?" ":t.fill+"",this.align=t.align===void 0?">":t.align+"",this.sign=t.sign===void 0?"-":t.sign+"",this.symbol=t.symbol===void 0?"":t.symbol+"",this.zero=!!t.zero,this.width=t.width===void 0?void 0:+t.width,this.comma=!!t.comma,this.precision=t.precision===void 0?void 0:+t.precision,this.trim=!!t.trim,this.type=t.type===void 0?"":t.type+""}rE.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(this.width===void 0?"":Math.max(1,this.width|0))+(this.comma?",":"")+(this.precision===void 0?"":"."+Math.max(0,this.precision|0))+(this.trim?"~":"")+this.type};function K5(t){e:for(var e=t.length,i=1,s=-1,c;i<e;++i)switch(t[i]){case".":s=c=i;break;case"0":s===0&&(s=i),c=i;break;default:if(!+t[i])break e;s>0&&(s=0);break}return s>0?t.slice(0,s)+t.slice(c+1):t}var _k;function J5(t,e){var i=U0(t,e);if(!i)return t+"";var s=i[0],c=i[1],h=c-(_k=Math.max(-8,Math.min(8,Math.floor(c/3)))*3)+1,p=s.length;return h===p?s:h>p?s+new Array(h-p+1).join("0"):h>0?s.slice(0,h)+"."+s.slice(h):"0."+new Array(1-h).join("0")+U0(t,Math.max(0,e+h-1))[0]}function S3(t,e){var i=U0(t,e);if(!i)return t+"";var s=i[0],c=i[1];return c<0?"0."+new Array(-c).join("0")+s:s.length>c+1?s.slice(0,c+1)+"."+s.slice(c+1):s+new Array(c-s.length+2).join("0")}const A3={"%":(t,e)=>(t*100).toFixed(e),b:t=>Math.round(t).toString(2),c:t=>t+"",d:G5,e:(t,e)=>t.toExponential(e),f:(t,e)=>t.toFixed(e),g:(t,e)=>t.toPrecision(e),o:t=>Math.round(t).toString(8),p:(t,e)=>S3(t*100,e),r:S3,s:J5,X:t=>Math.round(t).toString(16).toUpperCase(),x:t=>Math.round(t).toString(16)};function M3(t){return t}var C3=Array.prototype.map,P3=["y","z","a","f","p","n","µ","m","","k","M","G","T","P","E","Z","Y"];function Q5(t){var e=t.grouping===void 0||t.thousands===void 0?M3:X5(C3.call(t.grouping,Number),t.thousands+""),i=t.currency===void 0?"":t.currency[0]+"",s=t.currency===void 0?"":t.currency[1]+"",c=t.decimal===void 0?".":t.decimal+"",h=t.numerals===void 0?M3:Z5(C3.call(t.numerals,String)),p=t.percent===void 0?"%":t.percent+"",v=t.minus===void 0?"−":t.minus+"",l=t.nan===void 0?"NaN":t.nan+"";function A(O){O=V0(O);var L=O.fill,U=O.align,H=O.sign,Y=O.symbol,J=O.zero,oe=O.width,me=O.comma,pe=O.precision,be=O.trim,Oe=O.type;Oe==="n"?(me=!0,Oe="g"):A3[Oe]||(pe===void 0&&(pe=12),be=!0,Oe="g"),(J||L==="0"&&U==="=")&&(J=!0,L="0",U="=");var je=Y==="$"?i:Y==="#"&&/[boxX]/.test(Oe)?"0"+Oe.toLowerCase():"",st=Y==="$"?s:/[%p]/.test(Oe)?p:"",ut=A3[Oe],xe=/[defgprs%]/.test(Oe);pe=pe===void 0?6:/[gprs]/.test(Oe)?Math.max(1,Math.min(21,pe)):Math.max(0,Math.min(20,pe));function it(Be){var Qe=je,Ct=st,Kt,Ie,fi;if(Oe==="c")Ct=ut(Be)+Ct,Be="";else{Be=+Be;var Yi=Be<0||1/Be<0;if(Be=isNaN(Be)?l:ut(Math.abs(Be),pe),be&&(Be=K5(Be)),Yi&&+Be==0&&H!=="+"&&(Yi=!1),Qe=(Yi?H==="("?H:v:H==="-"||H==="("?"":H)+Qe,Ct=(Oe==="s"?P3[8+_k/3]:"")+Ct+(Yi&&H==="("?")":""),xe){for(Kt=-1,Ie=Be.length;++Kt<Ie;)if(fi=Be.charCodeAt(Kt),48>fi||fi>57){Ct=(fi===46?c+Be.slice(Kt+1):Be.slice(Kt))+Ct,Be=Be.slice(0,Kt);break}}}me&&!J&&(Be=e(Be,1/0));var ri=Qe.length+Be.length+Ct.length,vr=ri<oe?new Array(oe-ri+1).join(L):"";switch(me&&J&&(Be=e(vr+Be,vr.length?oe-Ct.length:1/0),vr=""),U){case"<":Be=Qe+Be+Ct+vr;break;case"=":Be=Qe+vr+Be+Ct;break;case"^":Be=vr.slice(0,ri=vr.length>>1)+Qe+Be+Ct+vr.slice(ri);break;default:Be=vr+Qe+Be+Ct;break}return h(Be)}return it.toString=function(){return O+""},it}function P(O,L){var U=A((O=V0(O),O.type="f",O)),H=Math.max(-8,Math.min(8,Math.floor(pf(L)/3)))*3,Y=Math.pow(10,-H),J=P3[8+H/3];return function(oe){return U(Y*oe)+J}}return{format:A,formatPrefix:P}}var Uy,nE,gk;e6({thousands:",",grouping:[3],currency:["$",""]});function e6(t){return Uy=Q5(t),nE=Uy.format,gk=Uy.formatPrefix,Uy}function t6(t){return Math.max(0,-pf(Math.abs(t)))}function i6(t,e){return Math.max(0,Math.max(-8,Math.min(8,Math.floor(pf(e)/3)))*3-pf(Math.abs(t)))}function r6(t,e){return t=Math.abs(t),e=Math.abs(e)-t,Math.max(0,pf(e)-pf(t))+1}var Dn=1e-6,n6=1e-12,Jr=Math.PI,qo=Jr/2,I3=Jr/4,Ko=Jr*2,Pl=180/Jr,No=Jr/180,is=Math.abs,s6=Math.atan,mf=Math.atan2,es=Math.cos,Zn=Math.sin,o6=Math.sign||function(t){return t>0?1:t<0?-1:0},Yc=Math.sqrt;function a6(t){return t>1?0:t<-1?Jr:Math.acos(t)}function xh(t){return t>1?qo:t<-1?-qo:Math.asin(t)}function Go(){}function j0(t,e){t&&O3.hasOwnProperty(t.type)&&O3[t.type](t,e)}var R3={Feature:function(t,e){j0(t.geometry,e)},FeatureCollection:function(t,e){for(var i=t.features,s=-1,c=i.length;++s<c;)j0(i[s].geometry,e)}},O3={Sphere:function(t,e){e.sphere()},Point:function(t,e){t=t.coordinates,e.point(t[0],t[1],t[2])},MultiPoint:function(t,e){for(var i=t.coordinates,s=-1,c=i.length;++s<c;)t=i[s],e.point(t[0],t[1],t[2])},LineString:function(t,e){Ew(t.coordinates,e,0)},MultiLineString:function(t,e){for(var i=t.coordinates,s=-1,c=i.length;++s<c;)Ew(i[s],e,0)},Polygon:function(t,e){k3(t.coordinates,e)},MultiPolygon:function(t,e){for(var i=t.coordinates,s=-1,c=i.length;++s<c;)k3(i[s],e)},GeometryCollection:function(t,e){for(var i=t.geometries,s=-1,c=i.length;++s<c;)j0(i[s],e)}};function Ew(t,e,i){var s=-1,c=t.length-i,h;for(e.lineStart();++s<c;)h=t[s],e.point(h[0],h[1],h[2]);e.lineEnd()}function k3(t,e){var i=-1,s=t.length;for(e.polygonStart();++i<s;)Ew(t[i],e,1);e.polygonEnd()}function $d(t,e){t&&R3.hasOwnProperty(t.type)?R3[t.type](t,e):j0(t,e)}function Sw(t){return[mf(t[1],t[0]),xh(t[2])]}function _f(t){var e=t[0],i=t[1],s=es(i);return[s*es(e),s*Zn(e),Zn(i)]}function Vy(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function $0(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}function yb(t,e){t[0]+=e[0],t[1]+=e[1],t[2]+=e[2]}function jy(t,e){return[t[0]*e,t[1]*e,t[2]*e]}function Aw(t){var e=Yc(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]/=e,t[1]/=e,t[2]/=e}function Mw(t,e){function i(s,c){return s=t(s,c),e(s[0],s[1])}return t.invert&&e.invert&&(i.invert=function(s,c){return s=e.invert(s,c),s&&t.invert(s[0],s[1])}),i}function Cw(t,e){return is(t)>Jr&&(t-=Math.round(t/Ko)*Ko),[t,e]}Cw.invert=Cw;function l6(t,e,i){return(t%=Ko)?e||i?Mw(L3(t),N3(e,i)):L3(t):e||i?N3(e,i):Cw}function D3(t){return function(e,i){return e+=t,is(e)>Jr&&(e-=Math.round(e/Ko)*Ko),[e,i]}}function L3(t){var e=D3(t);return e.invert=D3(-t),e}function N3(t,e){var i=es(t),s=Zn(t),c=es(e),h=Zn(e);function p(v,l){var A=es(l),P=es(v)*A,O=Zn(v)*A,L=Zn(l),U=L*i+P*s;return[mf(O*c-U*h,P*i-L*s),xh(U*c+O*h)]}return p.invert=function(v,l){var A=es(l),P=es(v)*A,O=Zn(v)*A,L=Zn(l),U=L*c-O*h;return[mf(O*c+L*h,P*i+U*s),xh(U*i-P*s)]},p}function c6(t,e,i,s,c,h){if(i){var p=es(e),v=Zn(e),l=s*i;c==null?(c=e+s*Ko,h=e-l/2):(c=F3(p,c),h=F3(p,h),(s>0?c<h:c>h)&&(c+=s*Ko));for(var A,P=c;s>0?P>h:P<h;P-=l)A=Sw([p,-v*es(P),-v*Zn(P)]),t.point(A[0],A[1])}}function F3(t,e){e=_f(e),e[0]-=t,Aw(e);var i=a6(-e[1]);return((-e[2]<0?-i:i)+Ko-Dn)%Ko}function yk(){var t=[],e;return{point:function(i,s,c){e.push([i,s,c])},lineStart:function(){t.push(e=[])},lineEnd:Go,rejoin:function(){t.length>1&&t.push(t.pop().concat(t.shift()))},result:function(){var i=t;return t=[],e=null,i}}}function A0(t,e){return is(t[0]-e[0])<Dn&&is(t[1]-e[1])<Dn}function $y(t,e,i,s){this.x=t,this.z=e,this.o=i,this.e=s,this.v=!1,this.n=this.p=null}function vk(t,e,i,s,c){var h=[],p=[],v,l;if(t.forEach(function(H){if(!((Y=H.length-1)<=0)){var Y,J=H[0],oe=H[Y],me;if(A0(J,oe)){if(!J[2]&&!oe[2]){for(c.lineStart(),v=0;v<Y;++v)c.point((J=H[v])[0],J[1]);c.lineEnd();return}oe[0]+=2*Dn}h.push(me=new $y(J,H,null,!0)),p.push(me.o=new $y(J,null,me,!1)),h.push(me=new $y(oe,H,null,!1)),p.push(me.o=new $y(oe,null,me,!0))}}),!!h.length){for(p.sort(e),B3(h),B3(p),v=0,l=p.length;v<l;++v)p[v].e=i=!i;for(var A=h[0],P,O;;){for(var L=A,U=!0;L.v;)if((L=L.n)===A)return;P=L.z,c.lineStart();do{if(L.v=L.o.v=!0,L.e){if(U)for(v=0,l=P.length;v<l;++v)c.point((O=P[v])[0],O[1]);else s(L.x,L.n.x,1,c);L=L.n}else{if(U)for(P=L.p.z,v=P.length-1;v>=0;--v)c.point((O=P[v])[0],O[1]);else s(L.x,L.p.x,-1,c);L=L.p}L=L.o,P=L.z,U=!U}while(!L.v);c.lineEnd()}}}function B3(t){if(e=t.length){for(var e,i=0,s=t[0],c;++i<e;)s.n=c=t[i],c.p=s,s=c;s.n=c=t[0],c.p=s}}function vb(t){return is(t[0])<=Jr?t[0]:o6(t[0])*((is(t[0])+Jr)%Ko-Jr)}function u6(t,e){var i=vb(e),s=e[1],c=Zn(s),h=[Zn(i),-es(i),0],p=0,v=0,l=new vh;c===1?s=qo+Dn:c===-1&&(s=-qo-Dn);for(var A=0,P=t.length;A<P;++A)if(L=(O=t[A]).length)for(var O,L,U=O[L-1],H=vb(U),Y=U[1]/2+I3,J=Zn(Y),oe=es(Y),me=0;me<L;++me,H=be,J=je,oe=st,U=pe){var pe=O[me],be=vb(pe),Oe=pe[1]/2+I3,je=Zn(Oe),st=es(Oe),ut=be-H,xe=ut>=0?1:-1,it=xe*ut,Be=it>Jr,Qe=J*je;if(l.add(mf(Qe*xe*Zn(it),oe*st+Qe*es(it))),p+=Be?ut+xe*Ko:ut,Be^H>=i^be>=i){var Ct=$0(_f(U),_f(pe));Aw(Ct);var Kt=$0(h,Ct);Aw(Kt);var Ie=(Be^ut>=0?-1:1)*xh(Kt[2]);(s>Ie||s===Ie&&(Ct[0]||Ct[1]))&&(v+=Be^ut>=0?1:-1)}}return(p<-Dn||p<Dn&&l<-n6)^v&1}function xk(t,e,i,s){return function(c){var h=e(c),p=yk(),v=e(p),l=!1,A,P,O,L={point:U,lineStart:Y,lineEnd:J,polygonStart:function(){L.point=oe,L.lineStart=me,L.lineEnd=pe,P=[],A=[]},polygonEnd:function(){L.point=U,L.lineStart=Y,L.lineEnd=J,P=uk(P);var be=u6(A,s);P.length?(l||(c.polygonStart(),l=!0),vk(P,d6,be,i,c)):be&&(l||(c.polygonStart(),l=!0),c.lineStart(),i(null,null,1,c),c.lineEnd()),l&&(c.polygonEnd(),l=!1),P=A=null},sphere:function(){c.polygonStart(),c.lineStart(),i(null,null,1,c),c.lineEnd(),c.polygonEnd()}};function U(be,Oe){t(be,Oe)&&c.point(be,Oe)}function H(be,Oe){h.point(be,Oe)}function Y(){L.point=H,h.lineStart()}function J(){L.point=U,h.lineEnd()}function oe(be,Oe){O.push([be,Oe]),v.point(be,Oe)}function me(){v.lineStart(),O=[]}function pe(){oe(O[0][0],O[0][1]),v.lineEnd();var be=v.clean(),Oe=p.result(),je,st=Oe.length,ut,xe,it;if(O.pop(),A.push(O),O=null,!!st){if(be&1){if(xe=Oe[0],(ut=xe.length-1)>0){for(l||(c.polygonStart(),l=!0),c.lineStart(),je=0;je<ut;++je)c.point((it=xe[je])[0],it[1]);c.lineEnd()}return}st>1&&be&2&&Oe.push(Oe.pop().concat(Oe.shift())),P.push(Oe.filter(h6))}}return L}}function h6(t){return t.length>1}function d6(t,e){return((t=t.x)[0]<0?t[1]-qo-Dn:qo-t[1])-((e=e.x)[0]<0?e[1]-qo-Dn:qo-e[1])}const z3=xk(function(){return!0},f6,m6,[-Jr,-qo]);function f6(t){var e=NaN,i=NaN,s=NaN,c;return{lineStart:function(){t.lineStart(),c=1},point:function(h,p){var v=h>0?Jr:-Jr,l=is(h-e);is(l-Jr)<Dn?(t.point(e,i=(i+p)/2>0?qo:-qo),t.point(s,i),t.lineEnd(),t.lineStart(),t.point(v,i),t.point(h,i),c=0):s!==v&&l>=Jr&&(is(e-s)<Dn&&(e-=s*Dn),is(h-v)<Dn&&(h-=v*Dn),i=p6(e,i,h,p),t.point(s,i),t.lineEnd(),t.lineStart(),t.point(v,i),c=0),t.point(e=h,i=p),s=v},lineEnd:function(){t.lineEnd(),e=i=NaN},clean:function(){return 2-c}}}function p6(t,e,i,s){var c,h,p=Zn(t-i);return is(p)>Dn?s6((Zn(e)*(h=es(s))*Zn(i)-Zn(s)*(c=es(e))*Zn(t))/(c*h*p)):(e+s)/2}function m6(t,e,i,s){var c;if(t==null)c=i*qo,s.point(-Jr,c),s.point(0,c),s.point(Jr,c),s.point(Jr,0),s.point(Jr,-c),s.point(0,-c),s.point(-Jr,-c),s.point(-Jr,0),s.point(-Jr,c);else if(is(t[0]-e[0])>Dn){var h=t[0]<e[0]?Jr:-Jr;c=i*h/2,s.point(-h,c),s.point(0,c),s.point(h,c)}else s.point(e[0],e[1])}function _6(t){var e=es(t),i=2*No,s=e>0,c=is(e)>Dn;function h(P,O,L,U){c6(U,t,i,L,P,O)}function p(P,O){return es(P)*es(O)>e}function v(P){var O,L,U,H,Y;return{lineStart:function(){H=U=!1,Y=1},point:function(J,oe){var me=[J,oe],pe,be=p(J,oe),Oe=s?be?0:A(J,oe):be?A(J+(J<0?Jr:-Jr),oe):0;if(!O&&(H=U=be)&&P.lineStart(),be!==U&&(pe=l(O,me),(!pe||A0(O,pe)||A0(me,pe))&&(me[2]=1)),be!==U)Y=0,be?(P.lineStart(),pe=l(me,O),P.point(pe[0],pe[1])):(pe=l(O,me),P.point(pe[0],pe[1],2),P.lineEnd()),O=pe;else if(c&&O&&s^be){var je;!(Oe&L)&&(je=l(me,O,!0))&&(Y=0,s?(P.lineStart(),P.point(je[0][0],je[0][1]),P.point(je[1][0],je[1][1]),P.lineEnd()):(P.point(je[1][0],je[1][1]),P.lineEnd(),P.lineStart(),P.point(je[0][0],je[0][1],3)))}be&&(!O||!A0(O,me))&&P.point(me[0],me[1]),O=me,U=be,L=Oe},lineEnd:function(){U&&P.lineEnd(),O=null},clean:function(){return Y|(H&&U)<<1}}}function l(P,O,L){var U=_f(P),H=_f(O),Y=[1,0,0],J=$0(U,H),oe=Vy(J,J),me=J[0],pe=oe-me*me;if(!pe)return!L&&P;var be=e*oe/pe,Oe=-e*me/pe,je=$0(Y,J),st=jy(Y,be),ut=jy(J,Oe);yb(st,ut);var xe=je,it=Vy(st,xe),Be=Vy(xe,xe),Qe=it*it-Be*(Vy(st,st)-1);if(!(Qe<0)){var Ct=Yc(Qe),Kt=jy(xe,(-it-Ct)/Be);if(yb(Kt,st),Kt=Sw(Kt),!L)return Kt;var Ie=P[0],fi=O[0],Yi=P[1],ri=O[1],vr;fi<Ie&&(vr=Ie,Ie=fi,fi=vr);var Gr=fi-Ie,Tr=is(Gr-Jr)<Dn,Ar=Tr||Gr<Dn;if(!Tr&&ri<Yi&&(vr=Yi,Yi=ri,ri=vr),Ar?Tr?Yi+ri>0^Kt[1]<(is(Kt[0]-Ie)<Dn?Yi:ri):Yi<=Kt[1]&&Kt[1]<=ri:Gr>Jr^(Ie<=Kt[0]&&Kt[0]<=fi)){var kr=jy(xe,(-it+Ct)/Be);return yb(kr,st),[Kt,Sw(kr)]}}}function A(P,O){var L=s?t:Jr-t,U=0;return P<-L?U|=1:P>L&&(U|=2),O<-L?U|=4:O>L&&(U|=8),U}return xk(p,v,h,s?[0,-t]:[-Jr,t-Jr])}function g6(t,e,i,s,c,h){var p=t[0],v=t[1],l=e[0],A=e[1],P=0,O=1,L=l-p,U=A-v,H;if(H=i-p,!(!L&&H>0)){if(H/=L,L<0){if(H<P)return;H<O&&(O=H)}else if(L>0){if(H>O)return;H>P&&(P=H)}if(H=c-p,!(!L&&H<0)){if(H/=L,L<0){if(H>O)return;H>P&&(P=H)}else if(L>0){if(H<P)return;H<O&&(O=H)}if(H=s-v,!(!U&&H>0)){if(H/=U,U<0){if(H<P)return;H<O&&(O=H)}else if(U>0){if(H>O)return;H>P&&(P=H)}if(H=h-v,!(!U&&H<0)){if(H/=U,U<0){if(H>O)return;H>P&&(P=H)}else if(U>0){if(H<P)return;H<O&&(O=H)}return P>0&&(t[0]=p+P*L,t[1]=v+P*U),O<1&&(e[0]=p+O*L,e[1]=v+O*U),!0}}}}}var jm=1e9,Wy=-jm;function y6(t,e,i,s){function c(A,P){return t<=A&&A<=i&&e<=P&&P<=s}function h(A,P,O,L){var U=0,H=0;if(A==null||(U=p(A,O))!==(H=p(P,O))||l(A,P)<0^O>0)do L.point(U===0||U===3?t:i,U>1?s:e);while((U=(U+O+4)%4)!==H);else L.point(P[0],P[1])}function p(A,P){return is(A[0]-t)<Dn?P>0?0:3:is(A[0]-i)<Dn?P>0?2:1:is(A[1]-e)<Dn?P>0?1:0:P>0?3:2}function v(A,P){return l(A.x,P.x)}function l(A,P){var O=p(A,1),L=p(P,1);return O!==L?O-L:O===0?P[1]-A[1]:O===1?A[0]-P[0]:O===2?A[1]-P[1]:P[0]-A[0]}return function(A){var P=A,O=yk(),L,U,H,Y,J,oe,me,pe,be,Oe,je,st={point:ut,lineStart:Qe,lineEnd:Ct,polygonStart:it,polygonEnd:Be};function ut(Ie,fi){c(Ie,fi)&&P.point(Ie,fi)}function xe(){for(var Ie=0,fi=0,Yi=U.length;fi<Yi;++fi)for(var ri=U[fi],vr=1,Gr=ri.length,Tr=ri[0],Ar,kr,$r=Tr[0],Vn=Tr[1];vr<Gr;++vr)Ar=$r,kr=Vn,Tr=ri[vr],$r=Tr[0],Vn=Tr[1],kr<=s?Vn>s&&($r-Ar)*(s-kr)>(Vn-kr)*(t-Ar)&&++Ie:Vn<=s&&($r-Ar)*(s-kr)<(Vn-kr)*(t-Ar)&&--Ie;return Ie}function it(){P=O,L=[],U=[],je=!0}function Be(){var Ie=xe(),fi=je&&Ie,Yi=(L=uk(L)).length;(fi||Yi)&&(A.polygonStart(),fi&&(A.lineStart(),h(null,null,1,A),A.lineEnd()),Yi&&vk(L,v,Ie,h,A),A.polygonEnd()),P=A,L=U=H=null}function Qe(){st.point=Kt,U&&U.push(H=[]),Oe=!0,be=!1,me=pe=NaN}function Ct(){L&&(Kt(Y,J),oe&&be&&O.rejoin(),L.push(O.result())),st.point=ut,be&&P.lineEnd()}function Kt(Ie,fi){var Yi=c(Ie,fi);if(U&&H.push([Ie,fi]),Oe)Y=Ie,J=fi,oe=Yi,Oe=!1,Yi&&(P.lineStart(),P.point(Ie,fi));else if(Yi&&be)P.point(Ie,fi);else{var ri=[me=Math.max(Wy,Math.min(jm,me)),pe=Math.max(Wy,Math.min(jm,pe))],vr=[Ie=Math.max(Wy,Math.min(jm,Ie)),fi=Math.max(Wy,Math.min(jm,fi))];g6(ri,vr,t,e,i,s)?(be||(P.lineStart(),P.point(ri[0],ri[1])),P.point(vr[0],vr[1]),Yi||P.lineEnd(),je=!1):Yi&&(P.lineStart(),P.point(Ie,fi),je=!1)}me=Ie,pe=fi,be=Yi}return st}}const Pw=t=>t;var xb=new vh,Iw=new vh,bk,wk,Rw,Ow,Ol={point:Go,lineStart:Go,lineEnd:Go,polygonStart:function(){Ol.lineStart=v6,Ol.lineEnd=b6},polygonEnd:function(){Ol.lineStart=Ol.lineEnd=Ol.point=Go,xb.add(is(Iw)),Iw=new vh},result:function(){var t=xb/2;return xb=new vh,t}};function v6(){Ol.point=x6}function x6(t,e){Ol.point=Tk,bk=Rw=t,wk=Ow=e}function Tk(t,e){Iw.add(Ow*t-Rw*e),Rw=t,Ow=e}function b6(){Tk(bk,wk)}var gf=1/0,W0=gf,x_=-gf,H0=x_,q0={point:w6,lineStart:Go,lineEnd:Go,polygonStart:Go,polygonEnd:Go,result:function(){var t=[[gf,W0],[x_,H0]];return x_=H0=-(W0=gf=1/0),t}};function w6(t,e){t<gf&&(gf=t),t>x_&&(x_=t),e<W0&&(W0=e),e>H0&&(H0=e)}var kw=0,Dw=0,$m=0,G0=0,X0=0,qd=0,Lw=0,Nw=0,Wm=0,Ek,Sk,Qa,el,Ho={point:bh,lineStart:U3,lineEnd:V3,polygonStart:function(){Ho.lineStart=S6,Ho.lineEnd=A6},polygonEnd:function(){Ho.point=bh,Ho.lineStart=U3,Ho.lineEnd=V3},result:function(){var t=Wm?[Lw/Wm,Nw/Wm]:qd?[G0/qd,X0/qd]:$m?[kw/$m,Dw/$m]:[NaN,NaN];return kw=Dw=$m=G0=X0=qd=Lw=Nw=Wm=0,t}};function bh(t,e){kw+=t,Dw+=e,++$m}function U3(){Ho.point=T6}function T6(t,e){Ho.point=E6,bh(Qa=t,el=e)}function E6(t,e){var i=t-Qa,s=e-el,c=Yc(i*i+s*s);G0+=c*(Qa+t)/2,X0+=c*(el+e)/2,qd+=c,bh(Qa=t,el=e)}function V3(){Ho.point=bh}function S6(){Ho.point=M6}function A6(){Ak(Ek,Sk)}function M6(t,e){Ho.point=Ak,bh(Ek=Qa=t,Sk=el=e)}function Ak(t,e){var i=t-Qa,s=e-el,c=Yc(i*i+s*s);G0+=c*(Qa+t)/2,X0+=c*(el+e)/2,qd+=c,c=el*t-Qa*e,Lw+=c*(Qa+t),Nw+=c*(el+e),Wm+=c*3,bh(Qa=t,el=e)}function Mk(t){this._context=t}Mk.prototype={_radius:4.5,pointRadius:function(t){return this._radius=t,this},polygonStart:function(){this._line=0},polygonEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){this._line===0&&this._context.closePath(),this._point=NaN},point:function(t,e){switch(this._point){case 0:{this._context.moveTo(t,e),this._point=1;break}case 1:{this._context.lineTo(t,e);break}default:{this._context.moveTo(t+this._radius,e),this._context.arc(t,e,this._radius,0,Ko);break}}},result:Go};var Fw=new vh,bb,Ck,Pk,Hm,qm,b_={point:Go,lineStart:function(){b_.point=C6},lineEnd:function(){bb&&Ik(Ck,Pk),b_.point=Go},polygonStart:function(){bb=!0},polygonEnd:function(){bb=null},result:function(){var t=+Fw;return Fw=new vh,t}};function C6(t,e){b_.point=Ik,Ck=Hm=t,Pk=qm=e}function Ik(t,e){Hm-=t,qm-=e,Fw.add(Yc(Hm*Hm+qm*qm)),Hm=t,qm=e}let j3,Z0,$3,W3;class H3{constructor(e){this._append=e==null?Rk:P6(e),this._radius=4.5,this._=""}pointRadius(e){return this._radius=+e,this}polygonStart(){this._line=0}polygonEnd(){this._line=NaN}lineStart(){this._point=0}lineEnd(){this._line===0&&(this._+="Z"),this._point=NaN}point(e,i){switch(this._point){case 0:{this._append`M${e},${i}`,this._point=1;break}case 1:{this._append`L${e},${i}`;break}default:{if(this._append`M${e},${i}`,this._radius!==$3||this._append!==Z0){const s=this._radius,c=this._;this._="",this._append`m0,${s}a${s},${s} 0 1,1 0,${-2*s}a${s},${s} 0 1,1 0,${2*s}z`,$3=s,Z0=this._append,W3=this._,this._=c}this._+=W3;break}}}result(){const e=this._;return this._="",e.length?e:null}}function Rk(t){let e=1;this._+=t[0];for(const i=t.length;e<i;++e)this._+=arguments[e]+t[e]}function P6(t){const e=Math.floor(t);if(!(e>=0))throw new RangeError(`invalid digits: ${t}`);if(e>15)return Rk;if(e!==j3){const i=10**e;j3=e,Z0=function(c){let h=1;this._+=c[0];for(const p=c.length;h<p;++h)this._+=Math.round(arguments[h]*i)/i+c[h]}}return Z0}function I6(t,e){let i=3,s=4.5,c,h;function p(v){return v&&(typeof s=="function"&&h.pointRadius(+s.apply(this,arguments)),$d(v,c(h))),h.result()}return p.area=function(v){return $d(v,c(Ol)),Ol.result()},p.measure=function(v){return $d(v,c(b_)),b_.result()},p.bounds=function(v){return $d(v,c(q0)),q0.result()},p.centroid=function(v){return $d(v,c(Ho)),Ho.result()},p.projection=function(v){return arguments.length?(c=v==null?(t=null,Pw):(t=v).stream,p):t},p.context=function(v){return arguments.length?(h=v==null?(e=null,new H3(i)):new Mk(e=v),typeof s!="function"&&h.pointRadius(s),p):e},p.pointRadius=function(v){return arguments.length?(s=typeof v=="function"?v:(h.pointRadius(+v),+v),p):s},p.digits=function(v){if(!arguments.length)return i;if(v==null)i=null;else{const l=Math.floor(v);if(!(l>=0))throw new RangeError(`invalid digits: ${v}`);i=l}return e===null&&(h=new H3(i)),p},p.projection(t).digits(i).context(e)}function sE(t){return function(e){var i=new Bw;for(var s in t)i[s]=t[s];return i.stream=e,i}}function Bw(){}Bw.prototype={constructor:Bw,point:function(t,e){this.stream.point(t,e)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};function oE(t,e,i){var s=t.clipExtent&&t.clipExtent();return t.scale(150).translate([0,0]),s!=null&&t.clipExtent(null),$d(i,t.stream(q0)),e(q0.result()),s!=null&&t.clipExtent(s),t}function Ok(t,e,i){return oE(t,function(s){var c=e[1][0]-e[0][0],h=e[1][1]-e[0][1],p=Math.min(c/(s[1][0]-s[0][0]),h/(s[1][1]-s[0][1])),v=+e[0][0]+(c-p*(s[1][0]+s[0][0]))/2,l=+e[0][1]+(h-p*(s[1][1]+s[0][1]))/2;t.scale(150*p).translate([v,l])},i)}function R6(t,e,i){return Ok(t,[[0,0],e],i)}function O6(t,e,i){return oE(t,function(s){var c=+e,h=c/(s[1][0]-s[0][0]),p=(c-h*(s[1][0]+s[0][0]))/2,v=-h*s[0][1];t.scale(150*h).translate([p,v])},i)}function k6(t,e,i){return oE(t,function(s){var c=+e,h=c/(s[1][1]-s[0][1]),p=-h*s[0][0],v=(c-h*(s[1][1]+s[0][1]))/2;t.scale(150*h).translate([p,v])},i)}var q3=16,D6=es(30*No);function G3(t,e){return+e?N6(t,e):L6(t)}function L6(t){return sE({point:function(e,i){e=t(e,i),this.stream.point(e[0],e[1])}})}function N6(t,e){function i(s,c,h,p,v,l,A,P,O,L,U,H,Y,J){var oe=A-s,me=P-c,pe=oe*oe+me*me;if(pe>4*e&&Y--){var be=p+L,Oe=v+U,je=l+H,st=Yc(be*be+Oe*Oe+je*je),ut=xh(je/=st),xe=is(is(je)-1)<Dn||is(h-O)<Dn?(h+O)/2:mf(Oe,be),it=t(xe,ut),Be=it[0],Qe=it[1],Ct=Be-s,Kt=Qe-c,Ie=me*Ct-oe*Kt;(Ie*Ie/pe>e||is((oe*Ct+me*Kt)/pe-.5)>.3||p*L+v*U+l*H<D6)&&(i(s,c,h,p,v,l,Be,Qe,xe,be/=st,Oe/=st,je,Y,J),J.point(Be,Qe),i(Be,Qe,xe,be,Oe,je,A,P,O,L,U,H,Y,J))}}return function(s){var c,h,p,v,l,A,P,O,L,U,H,Y,J={point:oe,lineStart:me,lineEnd:be,polygonStart:function(){s.polygonStart(),J.lineStart=Oe},polygonEnd:function(){s.polygonEnd(),J.lineStart=me}};function oe(ut,xe){ut=t(ut,xe),s.point(ut[0],ut[1])}function me(){O=NaN,J.point=pe,s.lineStart()}function pe(ut,xe){var it=_f([ut,xe]),Be=t(ut,xe);i(O,L,P,U,H,Y,O=Be[0],L=Be[1],P=ut,U=it[0],H=it[1],Y=it[2],q3,s),s.point(O,L)}function be(){J.point=oe,s.lineEnd()}function Oe(){me(),J.point=je,J.lineEnd=st}function je(ut,xe){pe(c=ut,xe),h=O,p=L,v=U,l=H,A=Y,J.point=pe}function st(){i(O,L,P,U,H,Y,h,p,c,v,l,A,q3,s),J.lineEnd=be,be()}return J}}var F6=sE({point:function(t,e){this.stream.point(t*No,e*No)}});function B6(t){return sE({point:function(e,i){var s=t(e,i);return this.stream.point(s[0],s[1])}})}function z6(t,e,i,s,c){function h(p,v){return p*=s,v*=c,[e+t*p,i-t*v]}return h.invert=function(p,v){return[(p-e)/t*s,(i-v)/t*c]},h}function X3(t,e,i,s,c,h){if(!h)return z6(t,e,i,s,c);var p=es(h),v=Zn(h),l=p*t,A=v*t,P=p/t,O=v/t,L=(v*i-p*e)/t,U=(v*e+p*i)/t;function H(Y,J){return Y*=s,J*=c,[l*Y-A*J+e,i-A*Y-l*J]}return H.invert=function(Y,J){return[s*(P*Y-O*J+L),c*(U-O*Y-P*J)]},H}function kk(t){return U6(function(){return t})()}function U6(t){var e,i=150,s=480,c=250,h=0,p=0,v=0,l=0,A=0,P,O=0,L=1,U=1,H=null,Y=z3,J=null,oe,me,pe,be=Pw,Oe=.5,je,st,ut,xe,it;function Be(Ie){return ut(Ie[0]*No,Ie[1]*No)}function Qe(Ie){return Ie=ut.invert(Ie[0],Ie[1]),Ie&&[Ie[0]*Pl,Ie[1]*Pl]}Be.stream=function(Ie){return xe&&it===Ie?xe:xe=F6(B6(P)(Y(je(be(it=Ie)))))},Be.preclip=function(Ie){return arguments.length?(Y=Ie,H=void 0,Kt()):Y},Be.postclip=function(Ie){return arguments.length?(be=Ie,J=oe=me=pe=null,Kt()):be},Be.clipAngle=function(Ie){return arguments.length?(Y=+Ie?_6(H=Ie*No):(H=null,z3),Kt()):H*Pl},Be.clipExtent=function(Ie){return arguments.length?(be=Ie==null?(J=oe=me=pe=null,Pw):y6(J=+Ie[0][0],oe=+Ie[0][1],me=+Ie[1][0],pe=+Ie[1][1]),Kt()):J==null?null:[[J,oe],[me,pe]]},Be.scale=function(Ie){return arguments.length?(i=+Ie,Ct()):i},Be.translate=function(Ie){return arguments.length?(s=+Ie[0],c=+Ie[1],Ct()):[s,c]},Be.center=function(Ie){return arguments.length?(h=Ie[0]%360*No,p=Ie[1]%360*No,Ct()):[h*Pl,p*Pl]},Be.rotate=function(Ie){return arguments.length?(v=Ie[0]%360*No,l=Ie[1]%360*No,A=Ie.length>2?Ie[2]%360*No:0,Ct()):[v*Pl,l*Pl,A*Pl]},Be.angle=function(Ie){return arguments.length?(O=Ie%360*No,Ct()):O*Pl},Be.reflectX=function(Ie){return arguments.length?(L=Ie?-1:1,Ct()):L<0},Be.reflectY=function(Ie){return arguments.length?(U=Ie?-1:1,Ct()):U<0},Be.precision=function(Ie){return arguments.length?(je=G3(st,Oe=Ie*Ie),Kt()):Yc(Oe)},Be.fitExtent=function(Ie,fi){return Ok(Be,Ie,fi)},Be.fitSize=function(Ie,fi){return R6(Be,Ie,fi)},Be.fitWidth=function(Ie,fi){return O6(Be,Ie,fi)},Be.fitHeight=function(Ie,fi){return k6(Be,Ie,fi)};function Ct(){var Ie=X3(i,0,0,L,U,O).apply(null,e(h,p)),fi=X3(i,s-Ie[0],c-Ie[1],L,U,O);return P=l6(v,l,A),st=Mw(e,fi),ut=Mw(P,st),je=G3(st,Oe),Kt()}function Kt(){return xe=it=null,Be}return function(){return e=t.apply(this,arguments),Be.invert=e.invert&&Qe,Ct()}}function V6(t){return function(e,i){var s=Yc(e*e+i*i),c=t(s),h=Zn(c),p=es(c);return[mf(e*h,s*p),xh(s&&i*h/s)]}}function Dk(t,e){return[es(e)*Zn(t),Zn(e)]}Dk.invert=V6(xh);function j6(){return kk(Dk).scale(249.5).clipAngle(90+Dn)}function $6(t,e){switch(arguments.length){case 0:break;case 1:this.range(t);break;default:this.range(e).domain(t);break}return this}function W6(t){return function(){return t}}function H6(t){return+t}var Z3=[0,1];function kc(t){return t}function zw(t,e){return(e-=t=+t)?function(i){return(i-t)/e}:W6(isNaN(e)?NaN:.5)}function q6(t,e){var i;return t>e&&(i=t,t=e,e=i),function(s){return Math.max(t,Math.min(e,s))}}function G6(t,e,i){var s=t[0],c=t[1],h=e[0],p=e[1];return c<s?(s=zw(c,s),h=i(p,h)):(s=zw(s,c),h=i(h,p)),function(v){return h(s(v))}}function X6(t,e,i){var s=Math.min(t.length,e.length)-1,c=new Array(s),h=new Array(s),p=-1;for(t[s]<t[0]&&(t=t.slice().reverse(),e=e.slice().reverse());++p<s;)c[p]=zw(t[p],t[p+1]),h[p]=i(e[p],e[p+1]);return function(v){var l=l5(t,v,1,s)-1;return h[l](c[l](v))}}function Z6(t,e){return e.domain(t.domain()).range(t.range()).interpolate(t.interpolate()).clamp(t.clamp()).unknown(t.unknown())}function Y6(){var t=Z3,e=Z3,i=iE,s,c,h,p=kc,v,l,A;function P(){var L=Math.min(t.length,e.length);return p!==kc&&(p=q6(t[0],t[L-1])),v=L>2?X6:G6,l=A=null,O}function O(L){return L==null||isNaN(L=+L)?h:(l||(l=v(t.map(s),e,i)))(s(p(L)))}return O.invert=function(L){return p(c((A||(A=v(e,t.map(s),v_)))(L)))},O.domain=function(L){return arguments.length?(t=Array.from(L,H6),P()):t.slice()},O.range=function(L){return arguments.length?(e=Array.from(L),P()):e.slice()},O.rangeRound=function(L){return e=Array.from(L),i=N5,P()},O.clamp=function(L){return arguments.length?(p=L?!0:kc,P()):p!==kc},O.interpolate=function(L){return arguments.length?(i=L,P()):i},O.unknown=function(L){return arguments.length?(h=L,O):h},function(L,U){return s=L,c=U,P()}}function K6(t,e,i,s){var c=f5(t,e,i),h;switch(s=V0(s??",f"),s.type){case"s":{var p=Math.max(Math.abs(t),Math.abs(e));return s.precision==null&&!isNaN(h=i6(c,p))&&(s.precision=h),gk(s,p)}case"":case"e":case"g":case"p":case"r":{s.precision==null&&!isNaN(h=r6(c,Math.max(Math.abs(t),Math.abs(e))))&&(s.precision=h-(s.type==="e"));break}case"f":case"%":{s.precision==null&&!isNaN(h=t6(c))&&(s.precision=h-(s.type==="%")*2);break}}return nE(s)}function J6(t){var e=t.domain;return t.ticks=function(i){var s=e();return d5(s[0],s[s.length-1],i??10)},t.tickFormat=function(i,s){var c=e();return K6(c[0],c[c.length-1],i??10,s)},t.nice=function(i){i==null&&(i=10);var s=e(),c=0,h=s.length-1,p=s[c],v=s[h],l,A,P=10;for(v<p&&(A=p,p=v,v=A,A=c,c=h,h=A);P-- >0;){if(A=xw(p,v,i),A===l)return s[c]=p,s[h]=v,e(s);if(A>0)p=Math.floor(p/A)*A,v=Math.ceil(v/A)*A;else if(A<0)p=Math.ceil(p*A)/A,v=Math.floor(v*A)/A;else break;l=A}return t},t}function Y3(t){return function(e){return e<0?-Math.pow(-e,t):Math.pow(e,t)}}function Q6(t){return t<0?-Math.sqrt(-t):Math.sqrt(t)}function eU(t){return t<0?-t*t:t*t}function tU(t){var e=t(kc,kc),i=1;function s(){return i===1?t(kc,kc):i===.5?t(Q6,eU):t(Y3(i),Y3(1/i))}return e.exponent=function(c){return arguments.length?(i=+c,s()):i},J6(e)}function Uw(){var t=tU(Y6());return t.copy=function(){return Z6(t,Uw()).exponent(t.exponent())},$6.apply(t,arguments),t}function aE(t,e,i){i===void 0&&(i={});var s={type:"Feature"};return(i.id===0||i.id)&&(s.id=i.id),i.bbox&&(s.bbox=i.bbox),s.properties=e||{},s.geometry=t,s}function iU(t,e,i){if(i===void 0&&(i={}),!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!K3(t[0])||!K3(t[1]))throw new Error("coordinates must contain numbers");var s={type:"Point",coordinates:t};return aE(s,e,i)}function rU(t,e,i){i===void 0&&(i={});for(var s=0,c=t;s<c.length;s++){var h=c[s];if(h.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var p=0;p<h[h.length-1].length;p++)if(h[h.length-1][p]!==h[0][p])throw new Error("First and last Position are not equivalent.")}var v={type:"Polygon",coordinates:t};return aE(v,e,i)}function nU(t,e){e===void 0&&(e={});var i={type:"FeatureCollection"};return e.id&&(i.id=e.id),e.bbox&&(i.bbox=e.bbox),i.features=t,i}function sU(t,e,i){i===void 0&&(i={});var s={type:"MultiPoint",coordinates:t};return aE(s,e,i)}function K3(t){return!isNaN(t)&&t!==null&&!Array.isArray(t)}function Lk(t,e,i){if(t!==null)for(var s,c,h,p,v,l,A,P=0,O=0,L,U=t.type,H=U==="FeatureCollection",Y=U==="Feature",J=H?t.features.length:1,oe=0;oe<J;oe++){A=H?t.features[oe].geometry:Y?t.geometry:t,L=A?A.type==="GeometryCollection":!1,v=L?A.geometries.length:1;for(var me=0;me<v;me++){var pe=0,be=0;if(p=L?A.geometries[me]:A,p!==null){l=p.coordinates;var Oe=p.type;switch(P=i&&(Oe==="Polygon"||Oe==="MultiPolygon")?1:0,Oe){case null:break;case"Point":if(e(l,O,oe,pe,be)===!1)return!1;O++,pe++;break;case"LineString":case"MultiPoint":for(s=0;s<l.length;s++){if(e(l[s],O,oe,pe,be)===!1)return!1;O++,Oe==="MultiPoint"&&pe++}Oe==="LineString"&&pe++;break;case"Polygon":case"MultiLineString":for(s=0;s<l.length;s++){for(c=0;c<l[s].length-P;c++){if(e(l[s][c],O,oe,pe,be)===!1)return!1;O++}Oe==="MultiLineString"&&pe++,Oe==="Polygon"&&be++}Oe==="Polygon"&&pe++;break;case"MultiPolygon":for(s=0;s<l.length;s++){for(be=0,c=0;c<l[s].length;c++){for(h=0;h<l[s][c].length-P;h++){if(e(l[s][c][h],O,oe,pe,be)===!1)return!1;O++}be++}pe++}break;case"GeometryCollection":for(s=0;s<p.geometries.length;s++)if(Lk(p.geometries[s],e,i)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function oU(t,e){if(t.type==="Feature")e(t,0);else if(t.type==="FeatureCollection")for(var i=0;i<t.features.length&&e(t.features[i],i)!==!1;i++);}function J3(t,e){var i,s,c,h,p,v,l,A,P,O,L=0,U=t.type==="FeatureCollection",H=t.type==="Feature",Y=U?t.features.length:1;for(i=0;i<Y;i++){for(v=U?t.features[i].geometry:H?t.geometry:t,A=U?t.features[i].properties:H?t.properties:{},P=U?t.features[i].bbox:H?t.bbox:void 0,O=U?t.features[i].id:H?t.id:void 0,l=v?v.type==="GeometryCollection":!1,p=l?v.geometries.length:1,c=0;c<p;c++){if(h=l?v.geometries[c]:v,h===null){if(e(null,L,A,P,O)===!1)return!1;continue}switch(h.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(e(h,L,A,P,O)===!1)return!1;break}case"GeometryCollection":{for(s=0;s<h.geometries.length;s++)if(e(h.geometries[s],L,A,P,O)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}L++}}function aU(t){if(!t)throw new Error("coord is required");if(!Array.isArray(t)){if(t.type==="Feature"&&t.geometry!==null&&t.geometry.type==="Point")return t.geometry.coordinates;if(t.type==="Point")return t.coordinates}if(Array.isArray(t)&&t.length>=2&&!Array.isArray(t[0])&&!Array.isArray(t[1]))return t;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function lU(t){return t.type==="Feature"?t.geometry:t}function Q3(t,e,i){if(i===void 0&&(i={}),!t)throw new Error("point is required");if(!e)throw new Error("polygon is required");var s=aU(t),c=lU(e),h=c.type,p=e.bbox,v=c.coordinates;if(p&&cU(s,p)===!1)return!1;h==="Polygon"&&(v=[v]);for(var l=!1,A=0;A<v.length&&!l;A++)if(eP(s,v[A][0],i.ignoreBoundary)){for(var P=!1,O=1;O<v[A].length&&!P;)eP(s,v[A][O],!i.ignoreBoundary)&&(P=!0),O++;P||(l=!0)}return l}function eP(t,e,i){var s=!1;e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]&&(e=e.slice(0,e.length-1));for(var c=0,h=e.length-1;c<e.length;h=c++){var p=e[c][0],v=e[c][1],l=e[h][0],A=e[h][1],P=t[1]*(p-l)+v*(l-t[0])+A*(t[0]-p)===0&&(p-t[0])*(l-t[0])<=0&&(v-t[1])*(A-t[1])<=0;if(P)return!i;var O=v>t[1]!=A>t[1]&&t[0]<(l-p)*(t[1]-v)/(A-v)+p;O&&(s=!s)}return s}function cU(t,e){return e[0]<=t[0]&&e[1]<=t[1]&&e[2]>=t[0]&&e[3]>=t[1]}function uU(t,e){var i=[];return oU(t,function(s){var c=!1;if(s.geometry.type==="Point")J3(e,function(p){Q3(s,p)&&(c=!0)}),c&&i.push(s);else if(s.geometry.type==="MultiPoint"){var h=[];J3(e,function(p){Lk(s,function(v){Q3(v,p)&&(c=!0,h.push(v))})}),c&&i.push(sU(h))}else throw new Error("Input geometry must be a Point or MultiPoint")}),nU(i)}function hU(t){return t}function dU(t){if(t==null)return hU;var e,i,s=t.scale[0],c=t.scale[1],h=t.translate[0],p=t.translate[1];return function(v,l){l||(e=i=0);var A=2,P=v.length,O=new Array(P);for(O[0]=(e+=v[0])*s+h,O[1]=(i+=v[1])*c+p;A<P;)O[A]=v[A],++A;return O}}function fU(t,e){for(var i,s=t.length,c=s-e;c<--s;)i=t[c],t[c++]=t[s],t[s]=i}function pU(t,e){return typeof e=="string"&&(e=t.objects[e]),e.type==="GeometryCollection"?{type:"FeatureCollection",features:e.geometries.map(function(i){return tP(t,i)})}:tP(t,e)}function tP(t,e){var i=e.id,s=e.bbox,c=e.properties==null?{}:e.properties,h=mU(t,e);return i==null&&s==null?{type:"Feature",properties:c,geometry:h}:s==null?{type:"Feature",id:i,properties:c,geometry:h}:{type:"Feature",id:i,bbox:s,properties:c,geometry:h}}function mU(t,e){var i=dU(t.transform),s=t.arcs;function c(P,O){O.length&&O.pop();for(var L=s[P<0?~P:P],U=0,H=L.length;U<H;++U)O.push(i(L[U],U));P<0&&fU(O,H)}function h(P){return i(P)}function p(P){for(var O=[],L=0,U=P.length;L<U;++L)c(P[L],O);return O.length<2&&O.push(O[0]),O}function v(P){for(var O=p(P);O.length<4;)O.push(O[0]);return O}function l(P){return P.map(v)}function A(P){var O=P.type,L;switch(O){case"GeometryCollection":return{type:O,geometries:P.geometries.map(A)};case"Point":L=h(P.coordinates);break;case"MultiPoint":L=P.coordinates.map(h);break;case"LineString":L=p(P.arcs);break;case"MultiLineString":L=P.arcs.map(p);break;case"Polygon":L=l(P.arcs);break;case"MultiPolygon":L=P.arcs.map(l);break;default:return null}return{type:O,coordinates:L}}return A(e)}function _U(t,e){e===void 0&&(e={});var i=Number(t[0]),s=Number(t[1]),c=Number(t[2]),h=Number(t[3]);if(t.length===6)throw new Error("@turf/bbox-polygon does not support BBox with 6 positions");var p=[i,s],v=[i,h],l=[c,h],A=[c,s];return rU([[p,A,l,v,p]],e.properties,{bbox:t,id:e.id})}var lE={exports:{}};lE.exports=n1;lE.exports.default=n1;function n1(t,e,i){i=i||2;var s=e&&e.length,c=s?e[0]*i:t.length,h=Nk(t,0,c,i,!0),p=[];if(!h||h.next===h.prev)return p;var v,l,A,P,O,L,U;if(s&&(h=bU(t,e,h,i)),t.length>80*i){v=A=t[0],l=P=t[1];for(var H=i;H<c;H+=i)O=t[H],L=t[H+1],O<v&&(v=O),L<l&&(l=L),O>A&&(A=O),L>P&&(P=L);U=Math.max(A-v,P-l),U=U!==0?32767/U:0}return w_(h,p,i,v,l,U,0),p}function Nk(t,e,i,s,c){var h,p;if(c===$w(t,e,i,s)>0)for(h=e;h<i;h+=s)p=iP(h,t[h],t[h+1],p);else for(h=i-s;h>=e;h-=s)p=iP(h,t[h],t[h+1],p);return p&&s1(p,p.next)&&(E_(p),p=p.next),p}function wh(t,e){if(!t)return t;e||(e=t);var i=t,s;do if(s=!1,!i.steiner&&(s1(i,i.next)||ts(i.prev,i,i.next)===0)){if(E_(i),i=e=i.prev,i===i.next)break;s=!0}else i=i.next;while(s||i!==e);return e}function w_(t,e,i,s,c,h,p){if(t){!p&&h&&AU(t,s,c,h);for(var v=t,l,A;t.prev!==t.next;){if(l=t.prev,A=t.next,h?yU(t,s,c,h):gU(t)){e.push(l.i/i|0),e.push(t.i/i|0),e.push(A.i/i|0),E_(t),t=A.next,v=A.next;continue}if(t=A,t===v){p?p===1?(t=vU(wh(t),e,i),w_(t,e,i,s,c,h,2)):p===2&&xU(t,e,i,s,c,h):w_(wh(t),e,i,s,c,h,1);break}}}}function gU(t){var e=t.prev,i=t,s=t.next;if(ts(e,i,s)>=0)return!1;for(var c=e.x,h=i.x,p=s.x,v=e.y,l=i.y,A=s.y,P=c<h?c<p?c:p:h<p?h:p,O=v<l?v<A?v:A:l<A?l:A,L=c>h?c>p?c:p:h>p?h:p,U=v>l?v>A?v:A:l>A?l:A,H=s.next;H!==e;){if(H.x>=P&&H.x<=L&&H.y>=O&&H.y<=U&&Gd(c,v,h,l,p,A,H.x,H.y)&&ts(H.prev,H,H.next)>=0)return!1;H=H.next}return!0}function yU(t,e,i,s){var c=t.prev,h=t,p=t.next;if(ts(c,h,p)>=0)return!1;for(var v=c.x,l=h.x,A=p.x,P=c.y,O=h.y,L=p.y,U=v<l?v<A?v:A:l<A?l:A,H=P<O?P<L?P:L:O<L?O:L,Y=v>l?v>A?v:A:l>A?l:A,J=P>O?P>L?P:L:O>L?O:L,oe=Vw(U,H,e,i,s),me=Vw(Y,J,e,i,s),pe=t.prevZ,be=t.nextZ;pe&&pe.z>=oe&&be&&be.z<=me;){if(pe.x>=U&&pe.x<=Y&&pe.y>=H&&pe.y<=J&&pe!==c&&pe!==p&&Gd(v,P,l,O,A,L,pe.x,pe.y)&&ts(pe.prev,pe,pe.next)>=0||(pe=pe.prevZ,be.x>=U&&be.x<=Y&&be.y>=H&&be.y<=J&&be!==c&&be!==p&&Gd(v,P,l,O,A,L,be.x,be.y)&&ts(be.prev,be,be.next)>=0))return!1;be=be.nextZ}for(;pe&&pe.z>=oe;){if(pe.x>=U&&pe.x<=Y&&pe.y>=H&&pe.y<=J&&pe!==c&&pe!==p&&Gd(v,P,l,O,A,L,pe.x,pe.y)&&ts(pe.prev,pe,pe.next)>=0)return!1;pe=pe.prevZ}for(;be&&be.z<=me;){if(be.x>=U&&be.x<=Y&&be.y>=H&&be.y<=J&&be!==c&&be!==p&&Gd(v,P,l,O,A,L,be.x,be.y)&&ts(be.prev,be,be.next)>=0)return!1;be=be.nextZ}return!0}function vU(t,e,i){var s=t;do{var c=s.prev,h=s.next.next;!s1(c,h)&&Fk(c,s,s.next,h)&&T_(c,h)&&T_(h,c)&&(e.push(c.i/i|0),e.push(s.i/i|0),e.push(h.i/i|0),E_(s),E_(s.next),s=t=h),s=s.next}while(s!==t);return wh(s)}function xU(t,e,i,s,c,h){var p=t;do{for(var v=p.next.next;v!==p.prev;){if(p.i!==v.i&&PU(p,v)){var l=Bk(p,v);p=wh(p,p.next),l=wh(l,l.next),w_(p,e,i,s,c,h,0),w_(l,e,i,s,c,h,0);return}v=v.next}p=p.next}while(p!==t)}function bU(t,e,i,s){var c=[],h,p,v,l,A;for(h=0,p=e.length;h<p;h++)v=e[h]*s,l=h<p-1?e[h+1]*s:t.length,A=Nk(t,v,l,s,!1),A===A.next&&(A.steiner=!0),c.push(CU(A));for(c.sort(wU),h=0;h<c.length;h++)i=TU(c[h],i);return i}function wU(t,e){return t.x-e.x}function TU(t,e){var i=EU(t,e);if(!i)return e;var s=Bk(i,t);return wh(s,s.next),wh(i,i.next)}function EU(t,e){var i=e,s=t.x,c=t.y,h=-1/0,p;do{if(c<=i.y&&c>=i.next.y&&i.next.y!==i.y){var v=i.x+(c-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(v<=s&&v>h&&(h=v,p=i.x<i.next.x?i:i.next,v===s))return p}i=i.next}while(i!==e);if(!p)return null;var l=p,A=p.x,P=p.y,O=1/0,L;i=p;do s>=i.x&&i.x>=A&&s!==i.x&&Gd(c<P?s:h,c,A,P,c<P?h:s,c,i.x,i.y)&&(L=Math.abs(c-i.y)/(s-i.x),T_(i,t)&&(L<O||L===O&&(i.x>p.x||i.x===p.x&&SU(p,i)))&&(p=i,O=L)),i=i.next;while(i!==l);return p}function SU(t,e){return ts(t.prev,t,e.prev)<0&&ts(e.next,t,t.next)<0}function AU(t,e,i,s){var c=t;do c.z===0&&(c.z=Vw(c.x,c.y,e,i,s)),c.prevZ=c.prev,c.nextZ=c.next,c=c.next;while(c!==t);c.prevZ.nextZ=null,c.prevZ=null,MU(c)}function MU(t){var e,i,s,c,h,p,v,l,A=1;do{for(i=t,t=null,h=null,p=0;i;){for(p++,s=i,v=0,e=0;e<A&&(v++,s=s.nextZ,!!s);e++);for(l=A;v>0||l>0&&s;)v!==0&&(l===0||!s||i.z<=s.z)?(c=i,i=i.nextZ,v--):(c=s,s=s.nextZ,l--),h?h.nextZ=c:t=c,c.prevZ=h,h=c;i=s}h.nextZ=null,A*=2}while(p>1);return t}function Vw(t,e,i,s,c){return t=(t-i)*c|0,e=(e-s)*c|0,t=(t|t<<8)&16711935,t=(t|t<<4)&252645135,t=(t|t<<2)&858993459,t=(t|t<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,t|e<<1}function CU(t){var e=t,i=t;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==t);return i}function Gd(t,e,i,s,c,h,p,v){return(c-p)*(e-v)>=(t-p)*(h-v)&&(t-p)*(s-v)>=(i-p)*(e-v)&&(i-p)*(h-v)>=(c-p)*(s-v)}function PU(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!IU(t,e)&&(T_(t,e)&&T_(e,t)&&RU(t,e)&&(ts(t.prev,t,e.prev)||ts(t,e.prev,e))||s1(t,e)&&ts(t.prev,t,t.next)>0&&ts(e.prev,e,e.next)>0)}function ts(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function s1(t,e){return t.x===e.x&&t.y===e.y}function Fk(t,e,i,s){var c=qy(ts(t,e,i)),h=qy(ts(t,e,s)),p=qy(ts(i,s,t)),v=qy(ts(i,s,e));return!!(c!==h&&p!==v||c===0&&Hy(t,i,e)||h===0&&Hy(t,s,e)||p===0&&Hy(i,t,s)||v===0&&Hy(i,e,s))}function Hy(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function qy(t){return t>0?1:t<0?-1:0}function IU(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&Fk(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}function T_(t,e){return ts(t.prev,t,t.next)<0?ts(t,e,t.next)>=0&&ts(t,t.prev,e)>=0:ts(t,e,t.prev)<0||ts(t,t.next,e)<0}function RU(t,e){var i=t,s=!1,c=(t.x+e.x)/2,h=(t.y+e.y)/2;do i.y>h!=i.next.y>h&&i.next.y!==i.y&&c<(i.next.x-i.x)*(h-i.y)/(i.next.y-i.y)+i.x&&(s=!s),i=i.next;while(i!==t);return s}function Bk(t,e){var i=new jw(t.i,t.x,t.y),s=new jw(e.i,e.x,e.y),c=t.next,h=e.prev;return t.next=e,e.prev=t,i.next=c,c.prev=i,s.next=i,i.prev=s,h.next=s,s.prev=h,s}function iP(t,e,i,s){var c=new jw(t,e,i);return s?(c.next=s.next,c.prev=s,s.next.prev=c,s.next=c):(c.prev=c,c.next=c),c}function E_(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function jw(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}n1.deviation=function(t,e,i,s){var c=e&&e.length,h=c?e[0]*i:t.length,p=Math.abs($w(t,0,h,i));if(c)for(var v=0,l=e.length;v<l;v++){var A=e[v]*i,P=v<l-1?e[v+1]*i:t.length;p-=Math.abs($w(t,A,P,i))}var O=0;for(v=0;v<s.length;v+=3){var L=s[v]*i,U=s[v+1]*i,H=s[v+2]*i;O+=Math.abs((t[L]-t[H])*(t[U+1]-t[L+1])-(t[L]-t[U])*(t[H+1]-t[L+1]))}return p===0&&O===0?0:Math.abs((O-p)/p)};function $w(t,e,i,s){for(var c=0,h=e,p=i-s;h<i;h+=s)c+=(t[p]-t[h])*(t[h+1]+t[p+1]),p=h;return c}n1.flatten=function(t){for(var e=t[0][0].length,i={vertices:[],holes:[],dimensions:e},s=0,c=0;c<t.length;c++){for(var h=0;h<t[c].length;h++)for(var p=0;p<e;p++)i.vertices.push(t[c][h][p]);c>0&&(s+=t[c-1].length,i.holes.push(s))}return i};var OU=lE.exports;const kU=i1(OU);function DU(t,e,i){if(console.log(e),i=="bbox"){let s=e.result.bbox,c=_U(s),h=t.map(v=>iU(v.center.split(","),{id:v.id}));return h={type:"FeatureCollection",features:h},uU(h,c).features.map(v=>v.properties.id)}}function LU(t,e){let i=t.filter(s=>{let c=s.color,h=ww(c),p=ww(e),v=h.s,l=h.h-p.h;if(l<70&&l>-70&&v>.3)return s}).map(s=>s.id);return console.log(i.length),i}function rP(t,e){if(!t)throw new Error(e||"loader assertion failed.")}const zk=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),nP=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);nP&&parseFloat(nP[1]);const Gy=globalThis,Od=globalThis.process||{},NU=globalThis.navigator||{};function Uk(t){var s,c;if(typeof window<"u"&&((s=window.process)==null?void 0:s.type)==="renderer"||typeof process<"u"&&((c=process.versions)!=null&&c.electron))return!0;const e=typeof navigator<"u"&&navigator.userAgent,i=t||e;return!!(i&&i.indexOf("Electron")>=0)}function Kc(){return!(typeof process=="object"&&String(process)==="[object process]"&&!(process!=null&&process.browser))||Uk()}function FU(t){return!t&&!Kc()?"Node":Uk(t)?"Electron":(t||NU.userAgent||"").indexOf("Edge")>-1?"Edge":globalThis.chrome?"Chrome":globalThis.safari?"Safari":globalThis.mozInnerScreenX?"Firefox":"Unknown"}const Vk="4.0.7";function BU(t){try{const e=window[t],i="__storage_test__";return e.setItem(i,i),e.removeItem(i),e}catch{return null}}class zU{constructor(e,i,s="sessionStorage"){this.storage=BU(s),this.id=e,this.config=i,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const i=JSON.stringify(this.config);this.storage.setItem(this.id,i)}}_loadConfiguration(){let e={};if(this.storage){const i=this.storage.getItem(this.id);e=i?JSON.parse(i):{}}return Object.assign(this.config,e),this}}function UU(t){let e;return t<10?e=`${t.toFixed(2)}ms`:t<100?e=`${t.toFixed(1)}ms`:t<1e3?e=`${t.toFixed(0)}ms`:e=`${(t/1e3).toFixed(2)}s`,e}function VU(t,e=8){const i=Math.max(e-t.length,0);return`${" ".repeat(i)}${t}`}var Y0;(function(t){t[t.BLACK=30]="BLACK",t[t.RED=31]="RED",t[t.GREEN=32]="GREEN",t[t.YELLOW=33]="YELLOW",t[t.BLUE=34]="BLUE",t[t.MAGENTA=35]="MAGENTA",t[t.CYAN=36]="CYAN",t[t.WHITE=37]="WHITE",t[t.BRIGHT_BLACK=90]="BRIGHT_BLACK",t[t.BRIGHT_RED=91]="BRIGHT_RED",t[t.BRIGHT_GREEN=92]="BRIGHT_GREEN",t[t.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",t[t.BRIGHT_BLUE=94]="BRIGHT_BLUE",t[t.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",t[t.BRIGHT_CYAN=96]="BRIGHT_CYAN",t[t.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(Y0||(Y0={}));const jU=10;function sP(t){return typeof t!="string"?t:(t=t.toUpperCase(),Y0[t]||Y0.WHITE)}function $U(t,e,i){return!Kc&&typeof t=="string"&&(e&&(t=`\x1B[${sP(e)}m${t}\x1B[39m`),i&&(t=`\x1B[${sP(i)+jU}m${t}\x1B[49m`)),t}function WU(t,e=["constructor"]){const i=Object.getPrototypeOf(t),s=Object.getOwnPropertyNames(i),c=t;for(const h of s){const p=c[h];typeof p=="function"&&(e.find(v=>h===v)||(c[h]=p.bind(t)))}}function cE(t,e){if(!t)throw new Error(e||"Assertion failed")}function kd(){var e,i,s;let t;if(Kc()&&Gy.performance)t=(i=(e=Gy==null?void 0:Gy.performance)==null?void 0:e.now)==null?void 0:i.call(e);else if("hrtime"in Od){const c=(s=Od==null?void 0:Od.hrtime)==null?void 0:s.call(Od);t=c[0]*1e3+c[1]/1e6}else t=Date.now();return t}const Dd={debug:Kc()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},HU={enabled:!0,level:0};function Ld(){}const oP={},aP={once:!0};class F_{constructor({id:e}={id:""}){this.VERSION=Vk,this._startTs=kd(),this._deltaTs=kd(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new zU(`__probe-${this.id}__`,HU),this.timeStamp(`${this.id} started`),WU(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((kd()-this._startTs).toPrecision(10))}getDelta(){return Number((kd()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,i){this._storage.setConfiguration({[e]:i})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,i){if(!e)throw new Error(i||"Assertion failed")}warn(e){return this._getLogFunction(0,e,Dd.warn,arguments,aP)}error(e){return this._getLogFunction(0,e,Dd.error,arguments)}deprecated(e,i){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${i}\` instead`)}removed(e,i){return this.error(`\`${e}\` has been removed. Use \`${i}\` instead`)}probe(e,i){return this._getLogFunction(e,i,Dd.log,arguments,{time:!0,once:!0})}log(e,i){return this._getLogFunction(e,i,Dd.debug,arguments)}info(e,i){return this._getLogFunction(e,i,console.info,arguments)}once(e,i){return this._getLogFunction(e,i,Dd.debug||Dd.info,arguments,aP)}table(e,i,s){return i?this._getLogFunction(e,i,console.table||Ld,s&&[s],{tag:GU(i)}):Ld}time(e,i){return this._getLogFunction(e,i,console.time?console.time:console.info)}timeEnd(e,i){return this._getLogFunction(e,i,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,i){return this._getLogFunction(e,i,console.timeStamp||Ld)}group(e,i,s={collapsed:!1}){const c=lP({logLevel:e,message:i,opts:s}),{collapsed:h}=s;return c.method=(h?console.groupCollapsed:console.group)||console.info,this._getLogFunction(c)}groupCollapsed(e,i,s={}){return this.group(e,i,Object.assign({},s,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Ld)}withGroup(e,i,s){this.group(e,i)();try{s()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=jk(e)}_getLogFunction(e,i,s,c,h){if(this._shouldLog(e)){h=lP({logLevel:e,message:i,args:c,opts:h}),s=s||h.method,cE(s),h.total=this.getTotal(),h.delta=this.getDelta(),this._deltaTs=kd();const p=h.tag||h.message;if(h.once&&p)if(!oP[p])oP[p]=kd();else return Ld;return i=qU(this.id,h.message,h),s.bind(console,i,...h.args)}return Ld}}F_.VERSION=Vk;function jk(t){if(!t)return 0;let e;switch(typeof t){case"number":e=t;break;case"object":e=t.logLevel||t.priority||0;break;default:return 0}return cE(Number.isFinite(e)&&e>=0),e}function lP(t){const{logLevel:e,message:i}=t;t.logLevel=jk(e);const s=t.args?Array.from(t.args):[];for(;s.length&&s.shift()!==i;);switch(typeof e){case"string":case"function":i!==void 0&&s.unshift(i),t.message=e;break;case"object":Object.assign(t,e);break}typeof t.message=="function"&&(t.message=t.message());const c=typeof t.message;return cE(c==="string"||c==="object"),Object.assign(t,{args:s},t.opts)}function qU(t,e,i){if(typeof e=="string"){const s=i.time?VU(UU(i.total)):"";e=i.time?`${t}: ${s}  ${e}`:`${t}: ${e}`,e=$U(e,i.color,i.background)}return e}function GU(t){for(const e in t)for(const i in t[e])return i||"untitled";return"empty"}function XU(t,e){return $k(t||{},e)}function $k(t,e,i=0){if(i>3)return e;const s={...t};for(const[c,h]of Object.entries(e))h&&typeof h=="object"&&!Array.isArray(h)?s[c]=$k(s[c]||{},e[c],i+1):s[c]=e[c];return s}function ZU(t){var e;globalThis.loaders||(globalThis.loaders={}),(e=globalThis.loaders).modules||(e.modules={}),Object.assign(globalThis.loaders.modules,t)}const YU="latest";function KU(){var t;return(t=globalThis._loadersgl_)!=null&&t.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.2.0-beta.2"),globalThis._loadersgl_.version}const JU=KU();function jc(t,e){if(!t)throw new Error(e||"loaders.gl assertion failed.")}const lh=typeof process!="object"||String(process)!=="[object process]"||process.browser,QU=typeof window<"u"&&typeof window.orientation<"u",cP=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);cP&&parseFloat(cP[1]);class e8{constructor(e,i){fe(this,"name");fe(this,"workerThread");fe(this,"isRunning",!0);fe(this,"result");fe(this,"_resolve",()=>{});fe(this,"_reject",()=>{});this.name=e,this.workerThread=i,this.result=new Promise((s,c)=>{this._resolve=s,this._reject=c})}postMessage(e,i){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:i})}done(e){jc(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){jc(this.isRunning),this.isRunning=!1,this._reject(e)}}class wb{terminate(){}}const Tb=new Map;function t8(t){jc(t.source&&!t.url||!t.source&&t.url);let e=Tb.get(t.source||t.url);return e||(t.url&&(e=i8(t.url),Tb.set(t.url,e)),t.source&&(e=Wk(t.source),Tb.set(t.source,e))),jc(e),e}function i8(t){if(!t.startsWith("http"))return t;const e=r8(t);return Wk(e)}function Wk(t){const e=new Blob([t],{type:"application/javascript"});return URL.createObjectURL(e)}function r8(t){return`try {
  importScripts('${t}');
} catch (error) {
  console.error(error);
  throw error;
}`}function Hk(t,e=!0,i){const s=i||new Set;if(t){if(uP(t))s.add(t);else if(uP(t.buffer))s.add(t.buffer);else if(!ArrayBuffer.isView(t)){if(e&&typeof t=="object")for(const c in t)Hk(t[c],e,s)}}return i===void 0?Array.from(s):[]}function uP(t){return t?t instanceof ArrayBuffer||typeof MessagePort<"u"&&t instanceof MessagePort||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas:!1}const Eb=()=>{};class Ww{constructor(e){fe(this,"name");fe(this,"source");fe(this,"url");fe(this,"terminated",!1);fe(this,"worker");fe(this,"onMessage");fe(this,"onError");fe(this,"_loadableURL","");const{name:i,source:s,url:c}=e;jc(s||c),this.name=i,this.source=s,this.url=c,this.onMessage=Eb,this.onError=h=>console.log(h),this.worker=lh?this._createBrowserWorker():this._createNodeWorker()}static isSupported(){return typeof Worker<"u"&&lh||typeof wb<"u"&&!lh}destroy(){this.onMessage=Eb,this.onError=Eb,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,i){i=i||Hk(e),this.worker.postMessage(e,i)}_getErrorFromErrorEvent(e){let i="Failed to load ";return i+=`worker ${this.name} from ${this.url}. `,e.message&&(i+=`${e.message} in `),e.lineno&&(i+=`:${e.lineno}:${e.colno}`),new Error(i)}_createBrowserWorker(){this._loadableURL=t8({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=i=>{i.data?this.onMessage(i.data):this.onError(new Error("No data received"))},e.onerror=i=>{this.onError(this._getErrorFromErrorEvent(i)),this.terminated=!0},e.onmessageerror=i=>console.error(i),e}_createNodeWorker(){let e;if(this.url){const s=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new wb(s,{eval:!1})}else if(this.source)e=new wb(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",i=>{this.onMessage(i)}),e.on("error",i=>{this.onError(i)}),e.on("exit",i=>{}),e}}class n8{constructor(e){fe(this,"name","unnamed");fe(this,"source");fe(this,"url");fe(this,"maxConcurrency",1);fe(this,"maxMobileConcurrency",1);fe(this,"onDebug",()=>{});fe(this,"reuseWorkers",!0);fe(this,"props",{});fe(this,"jobQueue",[]);fe(this,"idleQueue",[]);fe(this,"count",0);fe(this,"isDestroyed",!1);this.source=e.source,this.url=e.url,this.setProps(e)}static isSupported(){return Ww.isSupported()}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,i=(c,h,p)=>c.done(p),s=(c,h)=>c.error(h)){const c=new Promise(h=>(this.jobQueue.push({name:e,onMessage:i,onError:s,onStart:h}),this));return this._startQueuedJob(),await c}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const i=this.jobQueue.shift();if(i){this.onDebug({message:"Starting job",name:i.name,workerThread:e,backlog:this.jobQueue.length});const s=new e8(i.name,e);e.onMessage=c=>i.onMessage(s,c.type,c.payload),e.onError=c=>i.onError(s,c),i.onStart(s);try{await s.result}catch(c){console.error(`Worker exception: ${c}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!lh||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new Ww({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return QU?this.maxMobileConcurrency:this.maxConcurrency}}const s8={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},Ic=class Ic{constructor(e){fe(this,"props");fe(this,"workerPools",new Map);this.props={...s8},this.setProps(e),this.workerPools=new Map}static isSupported(){return Ww.isSupported()}static getWorkerFarm(e={}){return Ic._workerFarm=Ic._workerFarm||new Ic({}),Ic._workerFarm.setProps(e),Ic._workerFarm}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const i of this.workerPools.values())i.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:i,source:s,url:c}=e;let h=this.workerPools.get(i);return h||(h=new n8({name:i,source:s,url:c}),h.setProps(this._getWorkerPoolProps()),this.workerPools.set(i,h)),h}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};fe(Ic,"_workerFarm");let K0=Ic;function o8(t,e={}){const i=e[t.id]||{},s=lh?`${t.id}-worker.js`:`${t.id}-worker-node.js`;let c=i.workerUrl;if(!c&&t.id==="compression"&&(c=e.workerUrl),e._workerType==="test"&&(lh?c=`modules/${t.module}/dist/${s}`:c=`modules/${t.module}/src/workers/${t.id}-worker-node.ts`),!c){let h=t.version;h==="latest"&&(h=YU);const p=h?`@${h}`:"";c=`https://unpkg.com/@loaders.gl/${t.module}${p}/dist/${s}`}return jc(c),c}function a8(t,e=JU){jc(t,"no worker provided");const i=t.version;return!(!e||!i)}function l8(t,e){return!K0.isSupported()||!lh&&!(e!=null&&e._nodeWorkers)?!1:t.worker&&(e==null?void 0:e.worker)}async function c8(t,e,i,s,c){const h=t.id,p=o8(t,i),l=K0.getWorkerFarm(i).getWorkerPool({name:h,url:p});i=JSON.parse(JSON.stringify(i)),s=JSON.parse(JSON.stringify(s||{}));const A=await l.startJob("process-on-worker",u8.bind(null,c));return A.postMessage("process",{input:e,options:i,context:s}),await(await A.result).result}async function u8(t,e,i,s){switch(i){case"done":e.done(s);break;case"error":e.error(new Error(s.error));break;case"process":const{id:c,input:h,options:p}=s;try{const v=await t(h,p);e.postMessage("done",{id:c,result:v})}catch(v){const l=v instanceof Error?v.message:"unknown error";e.postMessage("error",{id:c,error:l})}break;default:console.warn(`parse-with-worker unknown message ${i}`)}}function h8(t,e,i){if(i=i||t.byteLength,t.byteLength<i||e.byteLength<i)return!1;const s=new Uint8Array(t),c=new Uint8Array(e);for(let h=0;h<s.length;++h)if(s[h]!==c[h])return!1;return!0}function d8(...t){return f8(t)}function f8(t){const e=t.map(h=>h instanceof ArrayBuffer?new Uint8Array(h):h),i=e.reduce((h,p)=>h+p.byteLength,0),s=new Uint8Array(i);let c=0;for(const h of e)s.set(h,c),c+=h.byteLength;return s.buffer}async function p8(t){const e=[];for await(const i of t)e.push(i);return d8(...e)}function hP(){let t;if(typeof window<"u"&&window.performance)t=window.performance.now();else if(typeof process<"u"&&process.hrtime){const e=process.hrtime();t=e[0]*1e3+e[1]/1e6}else t=Date.now();return t}class dP{constructor(e,i){this.sampleSize=1,this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this.name=e,this.type=i,this.reset()}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=hP(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(hP()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class B_{constructor(e){this.stats={},this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e,i="count"){return this._getOrCreate({name:e,type:i})}get size(){return Object.keys(this.stats).length}reset(){for(const e of Object.values(this.stats))e.reset();return this}forEach(e){for(const i of Object.values(this.stats))e(i)}getTable(){const e={};return this.forEach(i=>{e[i.name]={time:i.time||0,count:i.count||0,average:i.getAverageTime()||0,hz:i.getHz()||0}}),e}_initializeStats(e=[]){e.forEach(i=>this._getOrCreate(i))}_getOrCreate(e){const{name:i,type:s}=e;let c=this.stats[i];return c||(e instanceof dP?c=e:c=new dP(i,s),this.stats[i]=c),c}}const m8="Queued Requests",_8="Active Requests",g8="Cancelled Requests",y8="Queued Requests Ever",v8="Active Requests Ever",x8={id:"request-scheduler",throttleRequests:!0,maxRequests:6,debounceTime:0};class b8{constructor(e={}){fe(this,"props");fe(this,"stats");fe(this,"activeRequestCount",0);fe(this,"requestQueue",[]);fe(this,"requestMap",new Map);fe(this,"updateTimer",null);this.props={...x8,...e},this.stats=new B_({id:this.props.id}),this.stats.get(m8),this.stats.get(_8),this.stats.get(g8),this.stats.get(y8),this.stats.get(v8)}scheduleRequest(e,i=()=>0){if(!this.props.throttleRequests)return Promise.resolve({done:()=>{}});if(this.requestMap.has(e))return this.requestMap.get(e);const s={handle:e,priority:0,getPriority:i},c=new Promise(h=>(s.resolve=h,s));return this.requestQueue.push(s),this.requestMap.set(e,c),this._issueNewRequests(),c}_issueRequest(e){const{handle:i,resolve:s}=e;let c=!1;const h=()=>{c||(c=!0,this.requestMap.delete(i),this.activeRequestCount--,this._issueNewRequests())};return this.activeRequestCount++,s?s({done:h}):Promise.resolve({done:h})}_issueNewRequests(){this.updateTimer!==null&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>this._issueNewRequestsAsync(),this.props.debounceTime)}_issueNewRequestsAsync(){this.updateTimer!==null&&clearTimeout(this.updateTimer),this.updateTimer=null;const e=Math.max(this.props.maxRequests-this.activeRequestCount,0);if(e!==0){this._updateAllRequests();for(let i=0;i<e;++i){const s=this.requestQueue.shift();s&&this._issueRequest(s)}}}_updateAllRequests(){const e=this.requestQueue;for(let i=0;i<e.length;++i){const s=e[i];this._updateRequest(s)||(e.splice(i,1),this.requestMap.delete(s.handle),i--)}e.sort((i,s)=>i.priority-s.priority)}_updateRequest(e){return e.priority=e.getPriority(e.handle),e.priority<0?(e.resolve(null),!1):!0}}let w8="";const fP={};function T8(t){for(const e in fP)if(t.startsWith(e)){const i=fP[e];t=t.replace(e,i)}return!t.startsWith("http://")&&!t.startsWith("https://")&&(t=`${w8}${t}`),t}function E8(t){return t&&typeof t=="object"&&t.isBuffer}function qk(t){if(E8(t))return t;if(t instanceof ArrayBuffer)return t;if(ArrayBuffer.isView(t))return t.byteOffset===0&&t.byteLength===t.buffer.byteLength?t.buffer:t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength);if(typeof t=="string"){const e=t;return new TextEncoder().encode(e).buffer}if(t&&typeof t=="object"&&t._toArrayBuffer)return t._toArrayBuffer();throw new Error("toArrayBuffer")}function Gk(t){const e=t?t.lastIndexOf("/"):-1;return e>=0?t.substr(e+1):""}function S8(t){const e=t?t.lastIndexOf("/"):-1;return e>=0?t.substr(0,e):""}const A8=t=>typeof t=="boolean",i_=t=>typeof t=="function",z_=t=>t!==null&&typeof t=="object",pP=t=>z_(t)&&t.constructor==={}.constructor,M8=t=>!!t&&typeof t[Symbol.iterator]=="function",C8=t=>t&&typeof t[Symbol.asyncIterator]=="function",Mh=t=>typeof Response<"u"&&t instanceof Response||t&&t.arrayBuffer&&t.text&&t.json,Ch=t=>typeof Blob<"u"&&t instanceof Blob,P8=t=>t&&typeof t=="object"&&t.isBuffer,I8=t=>typeof ReadableStream<"u"&&t instanceof ReadableStream||z_(t)&&i_(t.tee)&&i_(t.cancel)&&i_(t.getReader),R8=t=>z_(t)&&i_(t.read)&&i_(t.pipe)&&A8(t.readable),Xk=t=>I8(t)||R8(t);class O8 extends Error{constructor(i,s){super(i);fe(this,"reason");fe(this,"url");fe(this,"response");this.reason=s.reason,this.url=s.url,this.response=s.response}}const k8=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,D8=/^([-\w.]+\/[-\w.+]+)/;function mP(t,e){return t.toLowerCase()===e.toLowerCase()}function L8(t){const e=D8.exec(t);return e?e[1]:t}function _P(t){const e=k8.exec(t);return e?e[1]:""}const Zk=/\?.*/;function N8(t){const e=t.match(Zk);return e&&e[0]}function uE(t){return t.replace(Zk,"")}function F8(t){if(t.length<50)return t;const e=t.slice(t.length-15);return`${t.substr(0,32)}...${e}`}function o1(t){return Mh(t)?t.url:Ch(t)?t.name||"":typeof t=="string"?t:""}function hE(t){if(Mh(t)){const e=t,i=e.headers.get("content-type")||"",s=uE(e.url);return L8(i)||_P(s)}return Ch(t)?t.type||"":typeof t=="string"?_P(t):""}function B8(t){return Mh(t)?t.headers["content-length"]||-1:Ch(t)?t.size:typeof t=="string"?t.length:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?t.byteLength:-1}async function Yk(t){if(Mh(t))return t;const e={},i=B8(t);i>=0&&(e["content-length"]=String(i));const s=o1(t),c=hE(t);c&&(e["content-type"]=c);const h=await V8(t);h&&(e["x-first-bytes"]=h),typeof t=="string"&&(t=new TextEncoder().encode(t));const p=new Response(t,{headers:e});return Object.defineProperty(p,"url",{value:s}),p}async function z8(t){if(!t.ok)throw await U8(t)}async function U8(t){const e=F8(t.url);let i=`Failed to fetch resource (${t.status}) ${t.statusText}: ${e}`;i=i.length>100?`${i.slice(0,100)}...`:i;const s={reason:t.statusText,url:t.url,response:t};try{const c=t.headers.get("Content-Type");s.reason=c!=null&&c.includes("application/json")?await t.json():t.text()}catch{}return new O8(i,s)}async function V8(t){if(typeof t=="string")return`data:,${t.slice(0,5)}`;if(t instanceof Blob){const i=t.slice(0,5);return await new Promise(s=>{const c=new FileReader;c.onload=h=>{var p;return s((p=h==null?void 0:h.target)==null?void 0:p.result)},c.readAsDataURL(i)})}if(t instanceof ArrayBuffer){const i=t.slice(0,5);return`data:base64,${j8(i)}`}return null}function j8(t){let e="";const i=new Uint8Array(t);for(let s=0;s<i.byteLength;s++)e+=String.fromCharCode(i[s]);return btoa(e)}function $8(t){return!W8(t)&&!H8(t)}function W8(t){return t.startsWith("http:")||t.startsWith("https:")}function H8(t){return t.startsWith("data:")}async function gP(t,e){var i,s;if(typeof t=="string"){const c=T8(t);return $8(c)&&(i=globalThis.loaders)!=null&&i.fetchNode?(s=globalThis.loaders)==null?void 0:s.fetchNode(c,e):await fetch(c,e)}return await Yk(t)}const yP=new F_({id:"loaders.gl"});class q8{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class G8{constructor(){fe(this,"console");this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}const Kk={fetch:null,mimeType:void 0,nothrow:!1,log:new G8,useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:zk,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},X8={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function dE(){globalThis.loaders=globalThis.loaders||{};const{loaders:t}=globalThis;return t._state||(t._state={}),t._state}function fE(){const t=dE();return t.globalOptions=t.globalOptions||{...Kk},t.globalOptions}function Z8(t){const e=dE(),i=fE();e.globalOptions=Jk(i,t),ZU(t.modules)}function Y8(t,e,i,s){return i=i||[],i=Array.isArray(i)?i:[i],K8(t,i),Jk(e,t,s)}function K8(t,e){vP(t,null,Kk,X8,e);for(const i of e){const s=t&&t[i.id]||{},c=i.options&&i.options[i.id]||{},h=i.deprecatedOptions&&i.deprecatedOptions[i.id]||{};vP(s,i.id,c,h,e)}}function vP(t,e,i,s,c){const h=e||"Top level",p=e?`${e}.`:"";for(const v in t){const l=!e&&z_(t[v]),A=v==="baseUri"&&!e,P=v==="workerUrl"&&e;if(!(v in i)&&!A&&!P){if(v in s)yP.warn(`${h} loader option '${p}${v}' no longer supported, use '${s[v]}'`)();else if(!l){const O=J8(v,c);yP.warn(`${h} loader option '${p}${v}' not recognized. ${O}`)()}}}}function J8(t,e){const i=t.toLowerCase();let s="";for(const c of e)for(const h in c.options){if(t===h)return`Did you mean '${c.id}.${h}'?`;const p=h.toLowerCase();(i.startsWith(p)||p.startsWith(i))&&(s=s||`Did you mean '${c.id}.${h}'?`)}return s}function Jk(t,e,i){const c={...t.options||{}};return Q8(c,i),c.log===null&&(c.log=new q8),xP(c,fE()),xP(c,e),c}function xP(t,e){for(const i in e)if(i in e){const s=e[i];pP(s)&&pP(t[i])?t[i]={...t[i],...e[i]}:t[i]=e[i]}}function Q8(t,e){e&&!("baseUri"in t)&&(t.baseUri=e)}function pE(t){return t?(Array.isArray(t)&&(t=t[0]),Array.isArray(t==null?void 0:t.extensions)):!1}function mE(t){rP(t,"null loader"),rP(pE(t),"invalid loader");let e;return Array.isArray(t)&&(e=t[1],t=t[0],t={...t,options:{...t.options,...e}}),(t!=null&&t.parseTextSync||t!=null&&t.parseText)&&(t.text=!0),t.text||(t.binary=!0),t}const Qk=()=>{const t=dE();return t.loaderRegistry=t.loaderRegistry||[],t.loaderRegistry};function eD(t){const e=Qk();t=Array.isArray(t)?t:[t];for(const i of t){const s=mE(i);e.find(c=>s===c)||e.unshift(s)}}function eV(){return Qk()}const tV=new F_({id:"loaders.gl"}),iV=/\.([^.]+)$/;async function rV(t,e=[],i,s){if(!tD(t))return null;let c=bP(t,e,{...i,nothrow:!0},s);if(c)return c;if(Ch(t)&&(t=await t.slice(0,10).arrayBuffer(),c=bP(t,e,i,s)),!c&&!(i!=null&&i.nothrow))throw new Error(iD(t));return c}function bP(t,e=[],i,s){if(!tD(t))return null;if(e&&!Array.isArray(e))return mE(e);let c=[];e&&(c=c.concat(e)),i!=null&&i.ignoreRegisteredLoaders||c.push(...eV()),sV(c);const h=nV(t,c,i,s);if(!h&&!(i!=null&&i.nothrow))throw new Error(iD(t));return h}function nV(t,e,i,s){const c=o1(t),h=hE(t),p=uE(c)||(s==null?void 0:s.url);let v=null,l="";return i!=null&&i.mimeType&&(v=Sb(e,i==null?void 0:i.mimeType),l=`match forced by supplied MIME type ${i==null?void 0:i.mimeType}`),v=v||oV(e,p),l=l||(v?`matched url ${p}`:""),v=v||Sb(e,h),l=l||(v?`matched MIME type ${h}`:""),v=v||lV(e,t),l=l||(v?`matched initial data ${rD(t)}`:""),i!=null&&i.fallbackMimeType&&(v=v||Sb(e,i==null?void 0:i.fallbackMimeType),l=l||(v?`matched fallback MIME type ${h}`:"")),l&&tV.log(1,`selectLoader selected ${v==null?void 0:v.name}: ${l}.`),v}function tD(t){return!(t instanceof Response&&t.status===204)}function iD(t){const e=o1(t),i=hE(t);let s="No valid loader found (";s+=e?`${Gk(e)}, `:"no url provided, ",s+=`MIME type: ${i?`"${i}"`:"not provided"}, `;const c=t?rD(t):"";return s+=c?` first bytes: "${c}"`:"first bytes: not available",s+=")",s}function sV(t){for(const e of t)mE(e)}function oV(t,e){const i=e&&iV.exec(e),s=i&&i[1];return s?aV(t,s):null}function aV(t,e){e=e.toLowerCase();for(const i of t)for(const s of i.extensions)if(s.toLowerCase()===e)return i;return null}function Sb(t,e){var i;for(const s of t)if((i=s.mimeTypes)!=null&&i.some(c=>mP(e,c))||mP(e,`application/x.${s.id}`))return s;return null}function lV(t,e){if(!e)return null;for(const i of t)if(typeof e=="string"){if(cV(e,i))return i}else if(ArrayBuffer.isView(e)){if(wP(e.buffer,e.byteOffset,i))return i}else if(e instanceof ArrayBuffer&&wP(e,0,i))return i;return null}function cV(t,e){return e.testText?e.testText(t):(Array.isArray(e.tests)?e.tests:[e.tests]).some(s=>t.startsWith(s))}function wP(t,e,i){return(Array.isArray(i.tests)?i.tests:[i.tests]).some(c=>uV(t,e,i,c))}function uV(t,e,i,s){if(s instanceof ArrayBuffer)return h8(s,t,s.byteLength);switch(typeof s){case"function":return s(t);case"string":const c=Hw(t,e,s.length);return s===c;default:return!1}}function rD(t,e=5){return typeof t=="string"?t.slice(0,e):ArrayBuffer.isView(t)?Hw(t.buffer,t.byteOffset,e):t instanceof ArrayBuffer?Hw(t,0,e):""}function Hw(t,e,i){if(t.byteLength<e+i)return"";const s=new DataView(t);let c="";for(let h=0;h<i;h++)c+=String.fromCharCode(s.getUint8(e+h));return c}const hV=256*1024;function*dV(t,e){const i=(e==null?void 0:e.chunkSize)||hV;let s=0;const c=new TextEncoder;for(;s<t.length;){const h=Math.min(t.length-s,i),p=t.slice(s,s+h);s+=h,yield c.encode(p)}}const fV=256*1024;function*pV(t,e={}){const{chunkSize:i=fV}=e;let s=0;for(;s<t.byteLength;){const c=Math.min(t.byteLength-s,i),h=new ArrayBuffer(c),p=new Uint8Array(t,s,c);new Uint8Array(h).set(p),s+=c,yield h}}const mV=1024*1024;async function*_V(t,e){const i=(e==null?void 0:e.chunkSize)||mV;let s=0;for(;s<t.size;){const c=s+i,h=await t.slice(s,c).arrayBuffer();s=c,yield h}}function TP(t,e){return zk?gV(t,e):yV(t)}async function*gV(t,e){const i=t.getReader();let s;try{for(;;){const c=s||i.read();e!=null&&e._streamReadAhead&&(s=i.read());const{done:h,value:p}=await c;if(h)return;yield qk(p)}}catch{i.releaseLock()}}async function*yV(t,e){for await(const i of t)yield qk(i)}function vV(t,e){if(typeof t=="string")return dV(t,e);if(t instanceof ArrayBuffer)return pV(t,e);if(Ch(t))return _V(t,e);if(Xk(t))return TP(t,e);if(Mh(t))return TP(t.body,e);throw new Error("makeIterator")}const nD="Cannot convert supplied data type";function xV(t,e,i){if(e.text&&typeof t=="string")return t;if(P8(t)&&(t=t.buffer),t instanceof ArrayBuffer){const s=t;return e.text&&!e.binary?new TextDecoder("utf8").decode(s):s}if(ArrayBuffer.isView(t)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(t);let s=t.buffer;const c=t.byteLength||t.length;return(t.byteOffset!==0||c!==s.byteLength)&&(s=s.slice(t.byteOffset,t.byteOffset+c)),s}throw new Error(nD)}async function bV(t,e,i){const s=t instanceof ArrayBuffer||ArrayBuffer.isView(t);if(typeof t=="string"||s)return xV(t,e);if(Ch(t)&&(t=await Yk(t)),Mh(t)){const c=t;return await z8(c),e.binary?await c.arrayBuffer():await c.text()}if(Xk(t)&&(t=vV(t,i)),M8(t)||C8(t))return p8(t);throw new Error(nD)}function sD(t,e){const i=fE(),s=t||i;return typeof s.fetch=="function"?s.fetch:z_(s.fetch)?c=>gP(c,s.fetch):e!=null&&e.fetch?e==null?void 0:e.fetch:gP}function wV(t,e,i){if(i)return i;const s={fetch:sD(e,t),...t};if(s.url){const c=uE(s.url);s.baseUrl=c,s.queryString=N8(s.url),s.filename=Gk(c),s.baseUrl=S8(c)}return Array.isArray(s.loaders)||(s.loaders=null),s}function TV(t,e){if(t&&!Array.isArray(t))return t;let i;if(t&&(i=Array.isArray(t)?t:[t]),e&&e.loaders){const s=Array.isArray(e.loaders)?e.loaders:[e.loaders];i=i?[...i,...s]:s}return i&&i.length?i:void 0}async function J0(t,e,i,s){e&&!Array.isArray(e)&&!pE(e)&&(s=void 0,i=e,e=void 0),t=await t,i=i||{};const c=o1(t),p=TV(e,s),v=await rV(t,p,i);return v?(i=Y8(i,v,p,c),s=wV({url:c,_parse:J0,loaders:p},i,s||null),await EV(v,t,i,s)):null}async function EV(t,e,i,s){if(a8(t),i=XU(t.options,i),Mh(e)){const h=e,{ok:p,redirected:v,status:l,statusText:A,type:P,url:O}=h,L=Object.fromEntries(h.headers.entries());s.response={headers:L,ok:p,redirected:v,status:l,statusText:A,type:P,url:O}}e=await bV(e,t,i);const c=t;if(c.parseTextSync&&typeof e=="string")return c.parseTextSync(e,i,s);if(l8(t,i))return await c8(t,e,i,s,J0);if(c.parseText&&typeof e=="string")return await c.parseText(e,i,s);if(c.parse)return await c.parse(e,i,s);throw jc(!c.parseSync),new Error(`${t.id} loader - no parser found and worker is disabled`)}async function ch(t,e,i,s){let c,h;!Array.isArray(e)&&!pE(e)?(c=[],h=e):(c=e,h=i);const p=sD(h);let v=t;return typeof t=="string"&&(v=await p(t)),Ch(t)&&(v=await p(t)),Array.isArray(c)?await J0(v,c,h):await J0(v,c,h)}const SV="4.2.0";function oD(t,e){if(!t)throw new Error(e||"loader assertion failed.")}const AV=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),EP=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);EP&&parseFloat(EP[1]);var rk;const MV=(rk=globalThis.loaders)==null?void 0:rk.parseImageNode,qw=typeof Image<"u",Gw=typeof ImageBitmap<"u",CV=!!MV,Xw=AV?!0:CV;function PV(t){switch(t){case"auto":return Gw||qw||Xw;case"imagebitmap":return Gw;case"image":return qw;case"data":return Xw;default:throw new Error(`@loaders.gl/images: image ${t} not supported in this environment`)}}function IV(){if(Gw)return"imagebitmap";if(qw)return"image";if(Xw)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function RV(t){const e=kV(t);if(!e)throw new Error("Not an image");return e}function OV(t){switch(RV(t)){case"data":return t;case"image":case"imagebitmap":const e=document.createElement("canvas"),i=e.getContext("2d");if(!i)throw new Error("getImageData");return e.width=t.width,e.height=t.height,i.drawImage(t,0,0),i.getImageData(0,0,t.width,t.height);default:throw new Error("getImageData")}}function kV(t){return typeof ImageBitmap<"u"&&t instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&t instanceof Image?"image":t&&typeof t=="object"&&t.data&&t.width&&t.height?"data":null}const DV=/^data:image\/svg\+xml/,LV=/\.svg((\?|#).*)?$/;function _E(t){return t&&(DV.test(t)||LV.test(t))}function NV(t,e){if(_E(e)){let s=new TextDecoder().decode(t);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(s=unescape(encodeURIComponent(s)))}catch(h){throw new Error(h.message)}return`data:image/svg+xml;base64,${btoa(s)}`}return aD(t,e)}function aD(t,e){if(_E(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(t)])}async function lD(t,e,i){const s=NV(t,i),c=self.URL||self.webkitURL,h=typeof s!="string"&&c.createObjectURL(s);try{return await FV(h||s,e)}finally{h&&c.revokeObjectURL(h)}}async function FV(t,e){const i=new Image;return i.src=t,e.image&&e.image.decode&&i.decode?(await i.decode(),i):await new Promise((s,c)=>{try{i.onload=()=>s(i),i.onerror=h=>{const p=h instanceof Error?h.message:"error";c(new Error(p))}}catch(h){c(h)}})}const BV={};let SP=!0;async function zV(t,e,i){let s;_E(i)?s=await lD(t,e,i):s=aD(t,i);const c=e&&e.imagebitmap;return await UV(s,c)}async function UV(t,e=null){if((VV(e)||!SP)&&(e=null),e)try{return await createImageBitmap(t,e)}catch(i){console.warn(i),SP=!1}return await createImageBitmap(t)}function VV(t){for(const e in t||BV)return!1;return!0}function jV(t){return!qV(t,"ftyp",4)||!(t[8]&96)?null:$V(t)}function $V(t){switch(WV(t,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function WV(t,e,i){return String.fromCharCode(...t.slice(e,i))}function HV(t){return[...t].map(e=>e.charCodeAt(0))}function qV(t,e,i=0){const s=HV(e);for(let c=0;c<s.length;++c)if(s[c]!==t[c+i])return!1;return!0}const tl=!1,r_=!0;function cD(t){const e=U_(t);return XV(e)||KV(e)||ZV(e)||YV(e)||GV(e)}function GV(t){const e=new Uint8Array(t instanceof DataView?t.buffer:t),i=jV(e);return i?{mimeType:i.mimeType,width:0,height:0}:null}function XV(t){const e=U_(t);return e.byteLength>=24&&e.getUint32(0,tl)===2303741511?{mimeType:"image/png",width:e.getUint32(16,tl),height:e.getUint32(20,tl)}:null}function ZV(t){const e=U_(t);return e.byteLength>=10&&e.getUint32(0,tl)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,r_),height:e.getUint16(8,r_)}:null}function YV(t){const e=U_(t);return e.byteLength>=14&&e.getUint16(0,tl)===16973&&e.getUint32(2,r_)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,r_),height:e.getUint32(22,r_)}:null}function KV(t){const e=U_(t);if(!(e.byteLength>=3&&e.getUint16(0,tl)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:s,sofMarkers:c}=JV();let h=2;for(;h+9<e.byteLength;){const p=e.getUint16(h,tl);if(c.has(p))return{mimeType:"image/jpeg",height:e.getUint16(h+5,tl),width:e.getUint16(h+7,tl)};if(!s.has(p))return null;h+=2,h+=e.getUint16(h,tl)}return null}function JV(){const t=new Set([65499,65476,65484,65501,65534]);for(let i=65504;i<65520;++i)t.add(i);return{tableMarkers:t,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function U_(t){if(t instanceof DataView)return t;if(ArrayBuffer.isView(t))return new DataView(t.buffer);if(t instanceof ArrayBuffer)return new DataView(t);throw new Error("toDataView")}async function QV(t,e){var c;const{mimeType:i}=cD(t)||{},s=(c=globalThis.loaders)==null?void 0:c.parseImageNode;return oD(s),await s(t,i)}async function ej(t,e,i){e=e||{};const c=(e.image||{}).type||"auto",{url:h}=i||{},p=tj(c);let v;switch(p){case"imagebitmap":v=await zV(t,e,h);break;case"image":v=await lD(t,e,h);break;case"data":v=await QV(t);break;default:oD(!1)}return c==="data"&&(v=OV(v)),v}function tj(t){switch(t){case"auto":case"data":return IV();default:return PV(t),t}}const ij=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],rj=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],nj={image:{type:"auto",decode:!0}},sj={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:SV,mimeTypes:rj,extensions:ij,parse:ej,tests:[t=>!!cD(new DataView(t))],options:nj},jr=new F_({id:"deck"});let Zw={};function oj(t){Zw=t}function Ks(t,e,i,s){jr.level>0&&Zw[t]&&Zw[t].call(null,e,i,s)}function aj(t){const e=t[0],i=t[t.length-1];return e==="{"&&i==="}"||e==="["&&i==="]"}const lj={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:aj,parseTextSync:JSON.parse};function cj(){const t="9.0.9",e=globalThis.deck&&globalThis.deck.VERSION;if(e&&e!==t)throw new Error(`deck.gl - multiple versions detected: ${e} vs ${t}`);return e||(jr.log(1,`deck.gl ${t}`)(),globalThis.deck={...globalThis.deck,VERSION:t,version:t,log:jr,_registerLoggers:oj},eD([lj,[sj,{imagebitmap:{premultiplyAlpha:"none"}}]])),t}const uj=cj();function rh(t,e){if(!t)throw new Error(e||"shadertools: assertion failed.")}const Ab={number:{type:"number",validate(t,e){return Number.isFinite(t)&&typeof e=="object"&&(e.max===void 0||t<=e.max)&&(e.min===void 0||t>=e.min)}},array:{type:"array",validate(t,e){return Array.isArray(t)||ArrayBuffer.isView(t)}}};function hj(t){const e={};for(const[i,s]of Object.entries(t))e[i]=fj(s);return e}function dj(t,e,i){const s={};for(const[c,h]of Object.entries(e))t&&c in t&&!h.private?(h.validate&&rh(h.validate(t[c],h),`${i}: invalid ${c}`),s[c]=t[c]):s[c]=h.value;return s}function fj(t){let e=AP(t);if(e!=="object")return{value:t,...Ab[e],type:e};if(typeof t=="object")return t?t.type!==void 0?{...t,...Ab[t.type],type:t.type}:t.value===void 0?{type:"object",value:t}:(e=AP(t.value),{...t,...Ab[e],type:e}):{type:"object",value:null};throw new Error("props")}function AP(t){return Array.isArray(t)||ArrayBuffer.isView(t)?"array":typeof t}const pj=`#ifdef MODULE_LOGDEPTH
logdepth_adjustPosition(gl_Position);
#endif
`,mj=`#ifdef MODULE_MATERIAL
gl_FragColor = material_filterColor(gl_FragColor);
#endif
#ifdef MODULE_LIGHTING
gl_FragColor = lighting_filterColor(gl_FragColor);
#endif
#ifdef MODULE_FOG
gl_FragColor = fog_filterColor(gl_FragColor);
#endif
#ifdef MODULE_PICKING
gl_FragColor = picking_filterHighlightColor(gl_FragColor);
gl_FragColor = picking_filterPickingColor(gl_FragColor);
#endif
#ifdef MODULE_LOGDEPTH
logdepth_setFragDepth();
#endif
`,_j={vertex:pj,fragment:mj},MP=/void\s+main\s*\([^)]*\)\s*\{\n?/,CP=/}\n?[^{}]*$/,Mb=[],M0="__LUMA_INJECT_DECLARATIONS__";function gj(t){const e={vertex:{},fragment:{}};for(const i in t){let s=t[i];const c=yj(i);typeof s=="string"&&(s={order:0,injection:s}),e[c][i]=s}return e}function yj(t){const e=t.slice(0,2);switch(e){case"vs":return"vertex";case"fs":return"fragment";default:throw new Error(e)}}function Q0(t,e,i,s=!1){const c=e==="vertex";for(const h in i){const p=i[h];p.sort((l,A)=>l.order-A.order),Mb.length=p.length;for(let l=0,A=p.length;l<A;++l)Mb[l]=p[l].injection;const v=`${Mb.join(`
`)}
`;switch(h){case"vs:#decl":c&&(t=t.replace(M0,v));break;case"vs:#main-start":c&&(t=t.replace(MP,l=>l+v));break;case"vs:#main-end":c&&(t=t.replace(CP,l=>v+l));break;case"fs:#decl":c||(t=t.replace(M0,v));break;case"fs:#main-start":c||(t=t.replace(MP,l=>l+v));break;case"fs:#main-end":c||(t=t.replace(CP,l=>v+l));break;default:t=t.replace(h,l=>l+v)}}return t=t.replace(M0,""),s&&(t=t.replace(/\}\s*$/,h=>h+_j[e])),t}let vj=1;class nh{constructor(e){fe(this,"name");fe(this,"vs");fe(this,"fs");fe(this,"getModuleUniforms");fe(this,"dependencies");fe(this,"deprecations");fe(this,"defines");fe(this,"injections");fe(this,"uniforms",{});fe(this,"uniformTypes",{});const{name:i,vs:s,fs:c,dependencies:h=[],uniformPropTypes:p={},getUniforms:v,deprecations:l=[],defines:A={},inject:P={}}=e;rh(typeof i=="string"),this.name=i,this.vs=s,this.fs=c,this.getModuleUniforms=v,this.dependencies=nh.instantiateModules(h),this.deprecations=this._parseDeprecationDefinitions(l),this.defines=A,this.injections=gj(P),p&&(this.uniforms=hj(p))}static instantiateModules(e){return e.map(i=>{if(i instanceof nh)return i;rh(typeof i!="string",`Shader module use by name is deprecated. Import shader module '${JSON.stringify(i)}' and use it directly.`),i.name||(console.warn("shader module has no name"),i.name=`shader-module-${vj++}`);const s=new nh(i);return s.dependencies=nh.instantiateModules(i.dependencies||[]),s})}getModuleSource(e){let i;switch(e){case"vertex":i=this.vs||"";break;case"fragment":i=this.fs||"";break;default:rh(!1)}const s=this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_");return`// ----- MODULE ${this.name} ---------------

#define MODULE_${s}
${i}

`}getUniforms(e,i){return this.getModuleUniforms?this.getModuleUniforms(e,i):dj(e,this.uniforms,this.name)}getDefines(){return this.defines}checkDeprecations(e,i){this.deprecations.forEach(s=>{var c;(c=s.regex)!=null&&c.test(e)&&(s.deprecated?i.deprecated(s.old,s.new)():i.removed(s.old,s.new)())})}_parseDeprecationDefinitions(e){return e.forEach(i=>{switch(i.type){case"function":i.regex=new RegExp(`\\b${i.old}\\(`);break;default:i.regex=new RegExp(`${i.type} ${i.old};`)}}),e}_defaultGetUniforms(e={}){const i={},s=this.uniforms;for(const c in s){const h=s[c];c in e&&!h.private?(h.validate&&rh(h.validate(e[c],h),`${this.name}: invalid ${c}`),i[c]=e[c]):i[c]=h.value}return i}}function PP(t){if(t.source&&t.platformInfo.type==="webgpu")return{...t,vs:void 0,fs:void 0};if(!t.vs)throw new Error("no vertex shader");const e=IP(t.platformInfo,t.vs);let i;return t.fs&&(i=IP(t.platformInfo,t.fs)),{...t,vs:e,fs:i}}function IP(t,e){if(typeof e=="string")return e;switch(t.type){case"webgpu":if(e!=null&&e.wgsl)return e.wgsl;throw new Error("WebGPU does not support GLSL shaders");default:if(e!=null&&e.glsl)return e.glsl;throw new Error("WebGL does not support WGSL shaders")}}function a1(t){const e=nh.instantiateModules(t);return xj(e)}function xj(t){const e={},i={};return uD({modules:t,level:0,moduleMap:e,moduleDepth:i}),Object.keys(i).sort((s,c)=>i[c]-i[s]).map(s=>e[s])}function uD(t){const{modules:e,level:i,moduleMap:s,moduleDepth:c}=t;if(i>=5)throw new Error("Possible loop in shader dependency graph");for(const h of e)s[h.name]=h,(c[h.name]===void 0||c[h.name]<i)&&(c[h.name]=i);for(const h of e)h.dependencies&&uD({modules:h.dependencies,level:i+1,moduleMap:s,moduleDepth:c})}function bj(t){switch(t==null?void 0:t.gpu.toLowerCase()){case"apple":return`#define APPLE_GPU
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"nvidia":return`#define NVIDIA_GPU
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function wj(t,e){var s;if(Number(((s=t.match(/^#version[ \t]+(\d+)/m))==null?void 0:s[1])||100)!==300)throw new Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(e){case"vertex":return t=RP(t,Tj),t;case"fragment":return t=RP(t,Ej),t;default:throw new Error(e)}}const hD=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],Tj=[...hD,[Yw("attribute"),"in $1"],[Yw("varying"),"out $1"]],Ej=[...hD,[Yw("varying"),"in $1"]];function RP(t,e){for(const[i,s]of e)t=t.replace(i,s);return t}function Yw(t){return new RegExp(`\\b${t}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function dD(t,e){let i="";for(const s in t){const c=t[s];if(i+=`void ${c.signature} {
`,c.header&&(i+=`  ${c.header}`),e[s]){const h=e[s];h.sort((p,v)=>p.order-v.order);for(const p of h)i+=`  ${p.injection}
`}c.footer&&(i+=`  ${c.footer}`),i+=`}
`}return i}function fD(t){const e={vertex:{},fragment:{}};for(const i of t){let s,c;typeof i!="string"?(s=i,c=s.hook):(s={},c=i),c=c.trim();const[h,p]=c.split(":"),v=c.replace(/\(.+/,""),l=Object.assign(s,{signature:p});switch(h){case"vs":e.vertex[v]=l;break;case"fs":e.fragment[v]=l;break;default:throw new Error(h)}}return e}function Sj(t,e){return{name:Aj(t,e),language:"glsl",version:Mj(t)}}function Aj(t,e="unnamed"){const s=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(t);return s?s[1]:e}function Mj(t){let e=100;const i=t.match(/[^\s]+/g);if(i&&i.length>=2&&i[0]==="#version"){const s=parseInt(i[1],10);Number.isFinite(s)&&(e=s)}if(e!==100&&e!==300)throw new Error(`Invalid GLSL version ${e}`);return e}const pD=`

${M0}
`,Cj=`precision highp float;
`;function Pj(t){const e=a1(t.modules||[]);return{source:Kw(t.platformInfo,{...t,source:t.source,stage:"vertex",modules:e}),getUniforms:gE(e)}}function Ij(t){const e=a1(t.modules||[]);return{vs:Kw(t.platformInfo,{...t,source:t.vs,stage:"vertex",modules:e}),fs:Kw(t.platformInfo,{...t,source:t.fs,stage:"fragment",modules:e}),getUniforms:gE(e)}}function Rj(t){const{vs:e,fs:i}=t,s=a1(t.modules||[]);return{vs:OP(t.platformInfo,{...t,source:e,stage:"vertex",modules:s}),fs:OP(t.platformInfo,{...t,source:i,stage:"fragment",modules:s}),getUniforms:gE(s)}}function Kw(t,e){const{source:i,stage:s,modules:c,hookFunctions:h=[],inject:p={},log:v}=e;rh(typeof i=="string","shader source must be a string");const l=i;let A="";const P=fD(h),O={},L={},U={};for(const Y in p){const J=typeof p[Y]=="string"?{injection:p[Y],order:0}:p[Y],oe=/^(v|f)s:(#)?([\w-]+)$/.exec(Y);if(oe){const me=oe[2],pe=oe[3];me?pe==="decl"?L[Y]=[J]:U[Y]=[J]:O[Y]=[J]}else U[Y]=[J]}const H=t.type!=="webgpu"?c:[];for(const Y of H){v&&Y.checkDeprecations(l,v);const J=Y.getModuleSource(s,"wgsl");A+=J;const oe=Y.injections[s];for(const me in oe){const pe=/^(v|f)s:#([\w-]+)$/.exec(me);if(pe){const Oe=pe[2]==="decl"?L:U;Oe[me]=Oe[me]||[],Oe[me].push(oe[me])}else O[me]=O[me]||[],O[me].push(oe[me])}}return A+=pD,A=Q0(A,s,L),A+=dD(P[s],O),A+=l,A=Q0(A,s,U),A}function OP(t,e){const{id:i,source:s,stage:c,language:h="glsl",modules:p,defines:v={},hookFunctions:l=[],inject:A={},prologue:P=!0,log:O}=e;rh(typeof s=="string","shader source must be a string");const L=h==="glsl"?Sj(s).version:-1,U=t.shaderLanguageVersion,H=L===100?"#version 100":"#version 300 es",J=s.split(`
`).slice(1).join(`
`),oe={};p.forEach(st=>{Object.assign(oe,st.getDefines())}),Object.assign(oe,v);let me="";switch(h){case"wgsl":break;case"glsl":me=P?`${H}

// ----- PROLOGUE -------------------------
${Oj({id:i,source:s,stage:c})}
${`#define SHADER_TYPE_${c.toUpperCase()}`}
${bj(t)}
${c==="fragment"?Cj:""}

// ----- APPLICATION DEFINES -------------------------

${kj(oe)}

`:`${H}
`;break}const pe=fD(l),be={},Oe={},je={};for(const st in A){const ut=typeof A[st]=="string"?{injection:A[st],order:0}:A[st],xe=/^(v|f)s:(#)?([\w-]+)$/.exec(st);if(xe){const it=xe[2],Be=xe[3];it?Be==="decl"?Oe[st]=[ut]:je[st]=[ut]:be[st]=[ut]}else je[st]=[ut]}for(const st of p){O&&st.checkDeprecations(J,O);const ut=st.getModuleSource(c);me+=ut;const xe=st.injections[c];for(const it in xe){const Be=/^(v|f)s:#([\w-]+)$/.exec(it);if(Be){const Ct=Be[2]==="decl"?Oe:je;Ct[it]=Ct[it]||[],Ct[it].push(xe[it])}else be[it]=be[it]||[],be[it].push(xe[it])}}return me+="// ----- MAIN SHADER SOURCE -------------------------",me+=pD,me=Q0(me,c,Oe),me+=dD(pe[c],be),me+=J,me=Q0(me,c,je),h==="glsl"&&L!==U&&(me=wj(me,c)),me.trim()}function gE(t){return function(i){const s={};for(const c of t){const h=c.getUniforms(i,s);Object.assign(s,h)}return s}}function Oj(t){const{id:e,source:i,stage:s}=t;return e&&i.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME ${e}_${s}

`:""}function kj(t={}){let e="";for(const i in t){const s=t[i];(s||Number.isFinite(s))&&(e+=`#define ${i.toUpperCase()} ${t[i]}
`)}return e}const eh=class eh{constructor(){fe(this,"_hookFunctions",[]);fe(this,"_defaultModules",[])}static getDefaultShaderAssembler(){return eh.defaultShaderAssembler=eh.defaultShaderAssembler||new eh,eh.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find(i=>i.name===(typeof e=="string"?e:e.name))||this._defaultModules.push(e)}removeDefaultModule(e){const i=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(s=>s.name!==i)}addShaderHook(e,i){i&&(e=Object.assign(i,{hook:e})),this._hookFunctions.push(e)}assembleShader(e){const i=this._getModuleList(e.modules),s=this._hookFunctions,c=PP(e);return{...Pj({platformInfo:e.platformInfo,...c,modules:i,hookFunctions:s}),modules:i}}assembleShaderPair(e){const i=PP(e),s=this._getModuleList(e.modules),c=this._hookFunctions,{platformInfo:h}=e;return{...e.platformInfo.shaderLanguage==="wgsl"?Ij({platformInfo:h,...i,modules:s,hookFunctions:c}):Rj({platformInfo:h,...i,modules:s,hookFunctions:c}),modules:s}}_getModuleList(e=[]){const i=new Array(this._defaultModules.length+e.length),s={};let c=0;for(let h=0,p=this._defaultModules.length;h<p;++h){const v=this._defaultModules[h],l=v.name;i[c++]=v,s[l]=!0}for(let h=0,p=e.length;h<p;++h){const v=e[h],l=v.name;s[l]||(i[c++]=v,s[l]=!0)}return i.length=c,nh.instantiateModules(i)}};fe(eh,"defaultShaderAssembler");let ev=eh;const Dj=`out vec4 transform_output;
void main() {
transform_output = vec4(0);
}`,Lj=`#version 300 es
${Dj}`;function Nj(t){const{input:e,inputChannels:i,output:s}=t||{};if(!e)return Lj;if(!i)throw new Error("inputChannels");const c=Fj(i),h=Bj(e,i);return`#version 300 es
in ${c} ${e};
out vec4 ${s};
void main() {
  ${s} = ${h};
}`}function Fj(t){switch(t){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`invalid channels: ${t}`)}}function Bj(t,e){switch(e){case 1:return`vec4(${t}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${t}, 0.0, 1.0)`;case 3:return`vec4(${t}, 1.0)`;case 4:return t;default:throw new Error(`invalid channels: ${e}`)}}const Jt=new F_({id:"luma.gl"});class zj{constructor(){fe(this,"stats",new Map)}getStats(e){return this.get(e)}get(e){return this.stats.has(e)||this.stats.set(e,new B_({id:e})),this.stats.get(e)}}const yE=new zj;function Uj(){const t="9.0.11",e="set luma.log.level=1 (or higher) to trace rendering";if(globalThis.luma&&globalThis.luma.VERSION!==t)throw new Error(`luma.gl - multiple VERSIONs detected: ${globalThis.luma.VERSION} vs ${t}`);return globalThis.luma||(Kc()&&Jt.log(1,`${t} - ${e}`)(),globalThis.luma=globalThis.luma||{VERSION:t,version:t,log:Jt,stats:yE}),t}const Vj=Uj();function jj(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)?t:null}function S_(t){return Array.isArray(t)?t.length===0||typeof t[0]=="number"?t:null:jj(t)}const Cb={};function Ph(t="id"){Cb[t]=Cb[t]||1;const e=Cb[t]++;return`${t}-${e}`}function tv(t){let e=!0;for(const i in t){e=!1;break}return e}var yw;let Mn=(yw=class{constructor(e,i,s){fe(this,"id");fe(this,"props");fe(this,"userData",{});fe(this,"_device");fe(this,"destroyed",!1);fe(this,"allocatedBytes",0);fe(this,"_attachedResources",new Set);if(!e)throw new Error("no device");this._device=e,this.props=$j(i,s);const c=this.props.id!=="undefined"?this.props.id:Ph(this[Symbol.toStringTag]);this.props.id=c,this.id=c,this.userData=this.props.userData||{},this.addStats()}destroy(){this.destroyResource()}delete(){return this.destroy(),this}toString(){return`${this[Symbol.toStringTag]||this.constructor.name}(${this.id})`}getProps(){return this.props}attachResource(e){this._attachedResources.add(e)}detachResource(e){this._attachedResources.delete(e)}destroyAttachedResource(e){this._attachedResources.delete(e)&&e.destroy()}destroyAttachedResources(){for(const e of Object.values(this._attachedResources))e.destroy();this._attachedResources=new Set}destroyResource(){this.destroyAttachedResources(),this.removeStats(),this.destroyed=!0}removeStats(){const e=this._device.statsManager.getStats("Resource Counts"),i=this[Symbol.toStringTag];e.get(`${i}s Active`).decrementCount()}trackAllocatedMemory(e,i=this[Symbol.toStringTag]){const s=this._device.statsManager.getStats("Resource Counts");s.get("GPU Memory").addCount(e),s.get(`${i} Memory`).addCount(e),this.allocatedBytes=e}trackDeallocatedMemory(e=this[Symbol.toStringTag]){const i=this._device.statsManager.getStats("Resource Counts");i.get("GPU Memory").subtractCount(this.allocatedBytes),i.get(`${e} Memory`).subtractCount(this.allocatedBytes),this.allocatedBytes=0}addStats(){const e=this._device.statsManager.getStats("Resource Counts"),i=this[Symbol.toStringTag];e.get("Resources Created").incrementCount(),e.get(`${i}s Created`).incrementCount(),e.get(`${i}s Active`).incrementCount()}},fe(yw,"defaultProps",{id:"undefined",handle:void 0,userData:void 0}),yw);function $j(t,e){const i={...e};for(const s in t)t[s]!==void 0&&(i[s]=t[s]);return i}const Bs=class Bs extends Mn{constructor(i,s){const c={...s};(s.usage||0)&Bs.INDEX&&!s.indexType&&(s.data instanceof Uint32Array?c.indexType="uint32":s.data instanceof Uint16Array&&(c.indexType="uint16"));super(i,c,Bs.defaultProps);fe(this,"usage");fe(this,"indexType");fe(this,"updateTimestamp");fe(this,"debugData",new ArrayBuffer(0));this.usage=s.usage||0,this.indexType=c.indexType,this.updateTimestamp=i.incrementTimestamp()}get[Symbol.toStringTag](){return"Buffer"}readSyncWebGL(i,s){throw new Error("not implemented")}_setDebugData(i,s,c){const h=ArrayBuffer.isView(i)?i.buffer:i,p=Math.min(i?i.byteLength:c,Bs.DEBUG_DATA_MAX_LENGTH);i===null?this.debugData=new ArrayBuffer(p):s===0&&c===i.byteLength?this.debugData=h.slice(0,p):this.debugData=h.slice(s,s+p)}};fe(Bs,"defaultProps",{...Mn.defaultProps,usage:0,byteLength:0,byteOffset:0,data:null,indexType:"uint16",mappedAtCreation:!1}),fe(Bs,"MAP_READ",1),fe(Bs,"MAP_WRITE",2),fe(Bs,"COPY_SRC",4),fe(Bs,"COPY_DST",8),fe(Bs,"INDEX",16),fe(Bs,"VERTEX",32),fe(Bs,"UNIFORM",64),fe(Bs,"STORAGE",128),fe(Bs,"INDIRECT",256),fe(Bs,"QUERY_RESOLVE",512),fe(Bs,"DEBUG_DATA_MAX_LENGTH",32);let Yn=Bs;function mD(t){const e=kP[t],i=Wj(e),s=t.includes("norm"),c=!s&&!t.startsWith("float"),h=t.startsWith("s");return{dataType:kP[t],byteLength:i,integer:c,signed:h,normalized:s}}function Wj(t){return Hj[t]}const kP={uint8:"uint8",sint8:"sint8",unorm8:"uint8",snorm8:"sint8",uint16:"uint16",sint16:"sint16",unorm16:"uint16",snorm16:"sint16",float16:"float16",float32:"float32",uint32:"uint32",sint32:"sint32"},Hj={uint8:1,sint8:1,uint16:2,sint16:2,float16:2,float32:4,uint32:4,sint32:4},qj=["bc1","bc2","bc3","bc4","bc5","bc6","bc7","etc1","etc2","eac","atc","astc","pvrtc"],Gj=/^(rg?b?a?)([0-9]*)([a-z]*)(-srgb)?(-webgl|-unsized)?$/;function Xj(t){return qj.some(e=>t.startsWith(e))}function _D(t){const e=Gj.exec(t);if(e){const[,i,s,c,h,p]=e;if(i){const v=`${c}${s}`,l=mD(v);return{format:i,components:i.length,srgb:h==="-srgb",unsized:p==="-unsized",webgl:p==="-webgl",...l}}}return Yj(t)}const Zj={"rgba4unorm-webgl":{format:"rgba",bpp:2},"rgb565unorm-webgl":{format:"rgb",bpp:2},"rgb5a1unorm-webgl":{format:"rgba",bbp:2},rgb9e5ufloat:{format:"rgb",bbp:4},rg11b10ufloat:{format:"rgb",bbp:4},rgb10a2unorm:{format:"rgba",bbp:4},"rgb10a2uint-webgl":{format:"rgba",bbp:4},stencil8:{components:1,bpp:1,a:"stencil"},depth16unorm:{components:1,bpp:2,a:"depth"},depth24plus:{components:1,bpp:3,a:"depth"},depth32float:{components:1,bpp:4,a:"depth"},"depth24plus-stencil8":{components:2,bpp:4,a:"depth-stencil"},"depth24unorm-stencil8":{components:2,bpp:4,a:"depth-stencil"},"depth32float-stencil8":{components:2,bpp:4,a:"depth-stencil"}};function Yj(t){var i;const e=Zj[t];if(!e)throw new Error(`Unknown format ${t}`);return{format:e.format||"",components:e.components||((i=e.format)==null?void 0:i.length)||1,byteLength:e.bpp||1,srgb:!1,unsized:!1}}class Kj{}class Jj{constructor(e=[],i){fe(this,"features");fe(this,"disabledFeatures");this.features=new Set(e),this.disabledFeatures=i||{}}*[Symbol.iterator](){yield*this.features}has(e){return!this.disabledFeatures[e]&&this.features.has(e)}}const f_=class f_{constructor(e){fe(this,"id");fe(this,"props");fe(this,"userData",{});fe(this,"statsManager",yE);fe(this,"_lumaData",{});fe(this,"timestamp",0);this.props={...f_.defaultProps,...e},this.id=this.props.id||Ph(this[Symbol.toStringTag].toLowerCase())}get[Symbol.toStringTag](){return"Device"}isTextureFormatCompressed(e){return Xj(e)}loseDevice(){return!1}getCanvasContext(){if(!this.canvasContext)throw new Error("Device has no CanvasContext");return this.canvasContext}createTexture(e){return(e instanceof Promise||typeof e=="string")&&(e={data:e}),this._createTexture(e)}createCommandEncoder(e={}){throw new Error("not implemented")}readPixelsToArrayWebGL(e,i){throw new Error("not implemented")}readPixelsToBufferWebGL(e,i){throw new Error("not implemented")}setParametersWebGL(e){throw new Error("not implemented")}getParametersWebGL(e){throw new Error("not implemented")}withParametersWebGL(e,i){throw new Error("not implemented")}clearWebGL(e){throw new Error("not implemented")}resetWebGL(){throw new Error("not implemented")}incrementTimestamp(){return this.timestamp++}onError(e){this.props.onError(e)}_getBufferProps(e){(e instanceof ArrayBuffer||ArrayBuffer.isView(e))&&(e={data:e});const i={...e};return(e.usage||0)&Yn.INDEX&&!e.indexType&&(e.data instanceof Uint32Array?i.indexType="uint32":e.data instanceof Uint16Array?i.indexType="uint16":Jt.warn("indices buffer content must be of integer type")()),i}};fe(f_,"defaultProps",{id:null,canvas:null,container:null,manageState:!0,width:800,height:600,requestMaxLimits:!0,debug:!!Jt.get("debug"),spector:!!Jt.get("spector"),break:[],initalizeFeatures:!0,disabledFeatures:{"compilation-status-async-webgl":!0},gl:null,onError:e=>Jt.error(e.message)}),fe(f_,"VERSION",Vj);let uh=f_;function Bn(t,e){if(!t)throw new Error(e||"luma.gl: assertion failed.")}const Om=new Map;class hh{static registerDevices(e){for(const i of e)Bn(i.type&&i.isSupported&&i.create),Om.set(i.type,i)}static getAvailableDevices(){return Array.from(Om).map(e=>e.type)}static getSupportedDevices(){return Array.from(Om).filter(e=>e.isSupported()).map(e=>e.type)}static setDefaultDeviceProps(e){Object.assign(uh.defaultProps,e)}static async attachDevice(e){const i=DP(e.devices)||Om;if(e.handle instanceof WebGL2RenderingContext){const s=i.get("webgl");if(s)return await s.attach(e.handle)}if(e.handle===null){const s=i.get("unknown");if(s)return await s.attach(null)}throw new Error("Failed to attach device. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.")}static async createDevice(e={}){var s,c;e={...uh.defaultProps,...e},e.gl&&(e.type="webgl");const i=DP(e.devices)||Om;switch(e.type){case"webgpu":let h=i.get("webgpu");if(h)return await h.create(e);break;case"webgl":let p=i.get("webgl");if(p)return await p.create(e);break;case"unknown":const v=i.get("unknown");if(v)return await v.create(e);break;case"best-available":if(h=i.get("webgpu"),(s=h==null?void 0:h.isSupported)!=null&&s.call(h))return await h.create(e);if(p=i.get("webgl"),(c=p==null?void 0:p.isSupported)!=null&&c.call(p))return await p.create(e);break}throw new Error("No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.")}static enforceWebGL2(e=!0){const i=HTMLCanvasElement.prototype;if(!e&&i.originalGetContext){i.getContext=i.originalGetContext,i.originalGetContext=void 0;return}i.originalGetContext=i.getContext,i.getContext=function(s,c){return s==="webgl"||s==="experimental-webgl"?this.originalGetContext("webgl2",c):this.originalGetContext(s,c)}}}fe(hh,"defaultProps",{...uh.defaultProps,type:"best-available",devices:void 0}),fe(hh,"stats",yE),fe(hh,"log",Jt);function DP(t){if(!t||(t==null?void 0:t.length)===0)return null;const e=new Map;for(const i of t)e.set(i.type,i);return e}const Qj=Kc()&&typeof document<"u",l1=()=>Qj&&document.readyState==="complete",e7={canvas:null,width:800,height:600,useDevicePixels:!0,autoResize:!0,container:null,visible:!0,colorSpace:"srgb",alphaMode:"opaque"};class vE{constructor(e){fe(this,"id");fe(this,"props");fe(this,"canvas");fe(this,"htmlCanvas");fe(this,"offscreenCanvas");fe(this,"type");fe(this,"width",1);fe(this,"height",1);fe(this,"resizeObserver");fe(this,"_canvasSizeInfo",{clientWidth:0,clientHeight:0,devicePixelRatio:1});if(this.props={...e7,...e},e=this.props,!Kc()){this.id="node-canvas-context",this.type="node",this.width=this.props.width,this.height=this.props.height,this.canvas=null;return}if(e.canvas)typeof e.canvas=="string"?this.canvas=r7(e.canvas):this.canvas=e.canvas;else{const i=n7(e),s=i7((e==null?void 0:e.container)||null);s.insertBefore(i,s.firstChild),this.canvas=i,e!=null&&e.visible||(this.canvas.style.visibility="hidden")}this.canvas instanceof HTMLCanvasElement?(this.id=this.canvas.id,this.type="html-canvas",this.htmlCanvas=this.canvas):(this.id="offscreen-canvas",this.type="offscreen-canvas",this.offscreenCanvas=this.canvas),this.canvas instanceof HTMLCanvasElement&&e.autoResize&&(this.resizeObserver=new ResizeObserver(i=>{for(const s of i)s.target===this.canvas&&this.update()}),this.resizeObserver.observe(this.canvas))}static get isPageLoaded(){return l1()}getDevicePixelRatio(e){return typeof OffscreenCanvas<"u"&&this.canvas instanceof OffscreenCanvas||(e=e===void 0?this.props.useDevicePixels:e,!e||e<=0)?1:e===!0?typeof window<"u"&&window.devicePixelRatio||1:e}getPixelSize(){switch(this.type){case"node":return[this.width,this.height];case"offscreen-canvas":return[this.canvas.width,this.canvas.height];case"html-canvas":const e=this.getDevicePixelRatio(),i=this.canvas;return i.parentElement?[i.clientWidth*e,i.clientHeight*e]:[this.canvas.width,this.canvas.height];default:throw new Error(this.type)}}getAspect(){const[e,i]=this.getPixelSize();return e/i}cssToDeviceRatio(){try{const[e]=this.getDrawingBufferSize(),{clientWidth:i}=this._canvasSizeInfo;return i?e/i:1}catch{return 1}}cssToDevicePixels(e,i=!0){const s=this.cssToDeviceRatio(),[c,h]=this.getDrawingBufferSize();return s7(e,s,c,h,i)}setDevicePixelRatio(e,i={}){if(!this.htmlCanvas)return;let s="width"in i?i.width:this.htmlCanvas.clientWidth,c="height"in i?i.height:this.htmlCanvas.clientHeight;(!s||!c)&&(Jt.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,s=this.htmlCanvas.width||1,c=this.htmlCanvas.height||1);const h=this._canvasSizeInfo;if(h.clientWidth!==s||h.clientHeight!==c||h.devicePixelRatio!==e){let p=e;const v=Math.floor(s*p),l=Math.floor(c*p);this.htmlCanvas.width=v,this.htmlCanvas.height=l;const[A,P]=this.getDrawingBufferSize();(A!==v||P!==l)&&(p=Math.min(A/s,P/c),this.htmlCanvas.width=Math.floor(s*p),this.htmlCanvas.height=Math.floor(c*p),Jt.warn("Device pixel ratio clamped")()),this._canvasSizeInfo.clientWidth=s,this._canvasSizeInfo.clientHeight=c,this._canvasSizeInfo.devicePixelRatio=e}}getDrawingBufferSize(){const e=this.device.gl;if(!e)throw new Error("canvas size");return[e.drawingBufferWidth,e.drawingBufferHeight]}_setAutoCreatedCanvasId(e){var i;((i=this.htmlCanvas)==null?void 0:i.id)==="lumagl-auto-created-canvas"&&(this.htmlCanvas.id=e)}}fe(vE,"pageLoaded",t7());function t7(){return l1()||typeof window>"u"?Promise.resolve():new Promise(t=>{window.addEventListener("load",()=>t())})}function i7(t){if(typeof t=="string"){const e=document.getElementById(t);if(!e&&!l1())throw new Error(`Accessing '${t}' before page was loaded`);if(!e)throw new Error(`${t} is not an HTML element`);return e}else if(t)return t;return document.body}function r7(t){const e=document.getElementById(t);if(!e&&!l1())throw new Error(`Accessing '${t}' before page was loaded`);if(!(e instanceof HTMLCanvasElement))throw new Error("Object is not a canvas element");return e}function n7(t){const{width:e,height:i}=t,s=document.createElement("canvas");return s.id="lumagl-auto-created-canvas",s.width=e||1,s.height=i||1,s.style.width=Number.isFinite(e)?`${e}px`:"100%",s.style.height=Number.isFinite(i)?`${i}px`:"100%",s}function s7(t,e,i,s,c){const h=t,p=LP(h[0],e,i);let v=NP(h[1],e,s,c),l=LP(h[0]+1,e,i);const A=l===i-1?l:l-1;l=NP(h[1]+1,e,s,c);let P;return c?(l=l===0?l:l+1,P=v,v=l):P=l===s-1?l:l-1,{x:p,y:v,width:Math.max(A-p+1,1),height:Math.max(P-v+1,1)}}function LP(t,e,i){return Math.min(Math.round(t*e),i-1)}function NP(t,e,i,s){return s?Math.max(0,i-1-Math.round(t*e)):Math.min(Math.round(t*e),i-1)}const Rl=class Rl extends Mn{constructor(i,s,c=Rl.defaultProps){super(i,s,c);fe(this,"dimension");fe(this,"format");fe(this,"width");fe(this,"height");fe(this,"depth");fe(this,"updateTimestamp");this.dimension=this.props.dimension,this.format=this.props.format,this.width=this.props.width,this.height=this.props.height,this.depth=this.props.depth,this.updateTimestamp=i.incrementTimestamp()}get[Symbol.toStringTag](){return"Texture"}};fe(Rl,"defaultProps",{...Mn.defaultProps,data:null,dimension:"2d",format:"rgba8unorm",width:void 0,height:void 0,depth:1,mipmaps:!0,compressed:!1,usage:0,mipLevels:void 0,samples:void 0,type:void 0,sampler:{},view:void 0}),fe(Rl,"COPY_SRC",1),fe(Rl,"COPY_DST",2),fe(Rl,"TEXTURE_BINDING",4),fe(Rl,"STORAGE_BINDING",8),fe(Rl,"RENDER_ATTACHMENT",16);let Xo=Rl;const Sv=class Sv extends Mn{get[Symbol.toStringTag](){return"TextureView"}constructor(e,i){super(e,i,Sv.defaultProps)}};fe(Sv,"defaultProps",{...Mn.defaultProps,format:void 0,dimension:void 0,aspect:"all",baseMipLevel:0,mipLevelCount:void 0,baseArrayLayer:0,arrayLayerCount:void 0});let iv=Sv;function o7(t,e,i){let s="";const c=e.split(/\r?\n/),h=t.slice().sort((p,v)=>p.lineNum-v.lineNum);switch((i==null?void 0:i.showSourceCode)||"no"){case"all":let p=0;for(let v=1;v<=c.length;v++)for(s+=gD(c[v-1],v,i);h.length>p&&h[p].lineNum===v;){const l=h[p++];s+=FP(l,c,l.lineNum,{...i,inlineSource:!1})}return s;case"issues":case"no":for(const v of t)s+=FP(v,c,v.lineNum,{inlineSource:(i==null?void 0:i.showSourceCode)!=="no"});return s}}function FP(t,e,i,s){if(s!=null&&s.inlineSource){const c=a7(e,i),h=t.linePos>0?`${" ".repeat(t.linePos+5)}^^^
`:"";return`
${c}${h}${t.type.toUpperCase()}: ${t.message}

`}return s!=null&&s.html?`<div class='luma-compiler-log-error' style="color:red;"><b> ${t.type.toUpperCase()}: ${t.message}</b></div>`:`${t.type.toUpperCase()}: ${t.message}`}function a7(t,e,i){let s="";for(let c=e-2;c<=e;c++){const h=t[c-1];h!==void 0&&(s+=gD(h,e,i))}return s}function gD(t,e,i){const s=i!=null&&i.html?c7(t):t;return`${l7(String(e),4)}: ${s}${i!=null&&i.html?"<br/>":`
`}`}function l7(t,e){let i="";for(let s=t.length;s<e;++s)i+=" ";return i+t}function c7(t){return t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function yD(t,e){return{name:u7(t,e),language:"glsl",version:h7(t)}}function u7(t,e="unnamed"){const s=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/.exec(t);return s?s[1]:e}function h7(t){let e=100;const i=t.match(/[^\s]+/g);if(i&&i.length>=2&&i[0]==="#version"){const s=parseInt(i[1],10);Number.isFinite(s)&&(e=s)}return e}const Av=class Av extends Mn{constructor(i,s){super(i,{id:d7(s),...s},Av.defaultProps);fe(this,"stage");fe(this,"source");fe(this,"compilationStatus","pending");this.stage=this.props.stage,this.source=this.props.source}get[Symbol.toStringTag](){return"Shader"}getCompilationInfoSync(){return null}getTranslatedSource(){return null}async debugShader(i=this.props.debug){switch(i){case"never":return;case"errors":if(this.compilationStatus==="success")return;break}const s=await this.getCompilationInfo();this.props.debug==="warnings"&&(s==null?void 0:s.length)===0||this._displayShaderLog(s)}_displayShaderLog(i){var A;if(typeof document>"u"||!(document!=null&&document.createElement))return;const s=yD(this.source).name,c=`${this.stage} ${s}`;let h=o7(i,this.source,{showSourceCode:"all",html:!0});const p=this.getTranslatedSource();p&&(h+=`<br /><br /><h1>Translated Source</h1><br /><br /><code style="user-select:text;"><pre>${p}</pre></code>`);const v=document.createElement("Button");v.innerHTML=`
<h1>Shader Compilation Error in ${c}</h1><br /><br />
<code style="user-select:text;"><pre>
${h}
</pre></code>`,v.style.top="10px",v.style.left="10px",v.style.position="absolute",v.style.zIndex="9999",v.style.width="100%",v.style.textAlign="left",document.body.appendChild(v);const l=document.getElementsByClassName("luma-compiler-log-error");(A=l[0])!=null&&A.scrollIntoView&&l[0].scrollIntoView(),v.onclick=()=>{const P=`data:text/plain,${encodeURIComponent(this.source)}`;navigator.clipboard.writeText(P)}}};fe(Av,"defaultProps",{...Mn.defaultProps,language:"auto",stage:void 0,source:"",sourceMap:null,entryPoint:"main",debug:"errors"});let rv=Av;function d7(t){return yD(t.source).name||t.id||Ph(`unnamed ${t.stage}-shader`)}const Mv=class Mv extends Mn{get[Symbol.toStringTag](){return"Sampler"}constructor(e,i){super(e,i,Mv.defaultProps)}};fe(Mv,"defaultProps",{...Mn.defaultProps,type:"color-sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest",lodMinClamp:0,lodMaxClamp:32,compare:"less-equal",maxAnisotropy:1});let nv=Mv;const Cv=class Cv extends Mn{constructor(i,s={}){super(i,s,Cv.defaultProps);fe(this,"width");fe(this,"height");fe(this,"colorAttachments",[]);fe(this,"depthStencilAttachment",null);this.width=this.props.width,this.height=this.props.height}get[Symbol.toStringTag](){return"Framebuffer"}resize(i){let s=!i;if(i){const[c,h]=Array.isArray(i)?i:[i.width,i.height];s=s||h!==this.height||c!==this.width,this.width=c,this.height=h}s&&(Jt.log(2,`Resizing framebuffer ${this.id} to ${this.width}x${this.height}`)(),this.resizeAttachments(this.width,this.height))}autoCreateAttachmentTextures(){if(this.props.colorAttachments.length===0&&!this.props.depthStencilAttachment)throw new Error("Framebuffer has noattachments");this.colorAttachments=this.props.colorAttachments.map(s=>{if(typeof s=="string"){const c=this.createColorTexture(s);return this.attachResource(c),c.view}return s instanceof Xo?s.view:s});const i=this.props.depthStencilAttachment;if(i)if(typeof i=="string"){const s=this.createDepthStencilTexture(i);this.attachResource(s),this.depthStencilAttachment=s.view}else i instanceof Xo?this.depthStencilAttachment=i.view:this.depthStencilAttachment=i}createColorTexture(i){return this.device.createTexture({id:"color-attachment",usage:Xo.RENDER_ATTACHMENT,format:i,width:this.width,height:this.height})}createDepthStencilTexture(i){return this.device.createTexture({id:"depth-stencil-attachment",usage:Xo.RENDER_ATTACHMENT,format:i,width:this.width,height:this.height})}resizeAttachments(i,s){for(let c=0;c<this.colorAttachments.length;++c)if(this.colorAttachments[c]){const h=this.device._createTexture({...this.colorAttachments[c].props,width:i,height:s});this.destroyAttachedResource(this.colorAttachments[c]),this.colorAttachments[c]=h.view,this.attachResource(h.view)}if(this.depthStencilAttachment){const c=this.device._createTexture({...this.depthStencilAttachment.props,width:i,height:s});this.destroyAttachedResource(this.depthStencilAttachment),this.depthStencilAttachment=c.view,this.attachResource(c)}}};fe(Cv,"defaultProps",{...Mn.defaultProps,width:1,height:1,colorAttachments:[],depthStencilAttachment:null});let sv=Cv;const Pv=class Pv extends Mn{constructor(i,s){super(i,s,Pv.defaultProps);fe(this,"shaderLayout");fe(this,"bufferLayout");fe(this,"linkStatus","pending");fe(this,"hash","");this.shaderLayout=this.props.shaderLayout,this.bufferLayout=this.props.bufferLayout||[]}get[Symbol.toStringTag](){return"RenderPipeline"}setUniformsWebGL(i){throw new Error("Use uniform blocks")}};fe(Pv,"defaultProps",{...Mn.defaultProps,vs:null,vertexEntryPoint:"vertexMain",vsConstants:{},fs:null,fragmentEntryPoint:"fragmentMain",fsConstants:{},shaderLayout:null,bufferLayout:[],topology:"triangle-list",parameters:{},bindings:{},uniforms:{}});let yf=Pv;const Iv=class Iv extends Mn{get[Symbol.toStringTag](){return"RenderPass"}constructor(e,i){super(e,i,Iv.defaultProps)}};fe(Iv,"defaultProps",{...Mn.defaultProps,framebuffer:null,parameters:void 0,clearColor:[0,0,0,0],clearDepth:1,clearStencil:0,depthReadOnly:!1,stencilReadOnly:!1,discard:!1,occlusionQuerySet:void 0,timestampQuerySet:void 0,beginTimestampIndex:void 0,endTimestampIndex:void 0});let Jw=Iv;const Rv=class Rv extends Mn{constructor(i,s){super(i,s,Rv.defaultProps);fe(this,"hash","")}get[Symbol.toStringTag](){return"ComputePipeline"}};fe(Rv,"defaultProps",{...Mn.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0});let ov=Rv;const Ov=class Ov extends Mn{get[Symbol.toStringTag](){return"CommandEncoder"}constructor(e,i){super(e,i,Ov.defaultProps)}};fe(Ov,"defaultProps",{...Mn.defaultProps,measureExecutionTime:void 0});let Qw=Ov;const kv=class kv extends Mn{get[Symbol.toStringTag](){return"CommandBuffer"}constructor(e,i){super(e,i,kv.defaultProps)}};fe(kv,"defaultProps",{...Mn.defaultProps});let eT=kv;function f7(t){const[e,i]=m7[t],s=e==="i32"||e==="u32",c=e!=="u32",h=_7[e]*i,p=p7(e,i);return{dataType:e,components:i,defaultVertexFormat:p,byteLength:h,integer:s,signed:c}}function p7(t,e){let i;switch(t){case"f32":i="float32";break;case"i32":i="sint32";break;case"u32":i="uint32";break;case"f16":return e<=2?"float16x2":"float16x4"}return e===1?i:`${i}x${e}`}const m7={f32:["f32",1],"vec2<f32>":["f32",2],"vec3<f32>":["f32",3],"vec4<f32>":["f32",4],f16:["f16",1],"vec2<f16>":["f16",2],"vec3<f16>":["f16",3],"vec4<f16>":["f16",4],i32:["i32",1],"vec2<i32>":["i32",2],"vec3<i32>":["i32",3],"vec4<i32>":["i32",4],u32:["u32",1],"vec2<u32>":["u32",2],"vec3<u32>":["u32",3],"vec4<u32>":["u32",4]},_7={f32:4,f16:2,i32:4,u32:4};function vD(t){let e;t.endsWith("-webgl")&&(t.replace("-webgl",""),e=!0);const[i,s]=t.split("x"),c=i,h=s?parseInt(s):1,p=mD(c),v={type:c,components:h,byteLength:p.byteLength*h,integer:p.integer,signed:p.signed,normalized:p.normalized};return e&&(v.webglOnly=!0),v}function xD(t,e){const i={};for(const s of t.attributes)i[s.name]=y7(t,e,s.name);return i}function g7(t,e,i=16){const s=xD(t,e),c=new Array(i).fill(null);for(const h of Object.values(s))c[h.location]=h;return c}function y7(t,e,i){const s=v7(t,i),c=x7(e,i);if(!s)return null;const h=f7(s.type),p=(c==null?void 0:c.vertexFormat)||h.defaultVertexFormat,v=vD(p);return{attributeName:(c==null?void 0:c.attributeName)||s.name,bufferName:(c==null?void 0:c.bufferName)||s.name,location:s.location,shaderType:s.type,shaderDataType:h.dataType,shaderComponents:h.components,vertexFormat:p,bufferDataType:v.type,bufferComponents:v.components,normalized:v.normalized,integer:h.integer,stepMode:(c==null?void 0:c.stepMode)||s.stepMode,byteOffset:(c==null?void 0:c.byteOffset)||0,byteStride:(c==null?void 0:c.byteStride)||0}}function v7(t,e){const i=t.attributes.find(s=>s.name===e);return i||Jt.warn(`shader layout attribute "${e}" not present in shader`),i||null}function x7(t,e){b7(t);let i=w7(t,e);return i||(i=T7(t,e),i)?i:(Jt.warn(`layout for attribute "${e}" not present in buffer layout`),null)}function b7(t){for(const e of t)(e.attributes&&e.format||!e.attributes&&!e.format)&&Jt.warn(`BufferLayout ${name} must have either 'attributes' or 'format' field`)}function w7(t,e){for(const i of t)if(i.format&&i.name===e)return{attributeName:i.name,bufferName:e,stepMode:i.stepMode,vertexFormat:i.format,byteOffset:0,byteStride:i.byteStride||0};return null}function T7(t,e){var i;for(const s of t){let c=s.byteStride;if(typeof s.byteStride!="number")for(const p of s.attributes||[]){const v=vD(p.format);c+=v.byteLength}const h=(i=s.attributes)==null?void 0:i.find(p=>p.attribute===e);if(h)return{attributeName:h.attribute,bufferName:s.name,stepMode:s.stepMode,vertexFormat:h.format,byteOffset:h.byteOffset,byteStride:c}}return null}function E7(t,e){const i={...t,attributes:t.attributes.map(s=>({...s}))};for(const s of(e==null?void 0:e.attributes)||[]){const c=i.attributes.find(h=>h.name===s.name);c?(c.type=s.type||c.type,c.stepMode=s.stepMode||c.stepMode):Jt.warn(`shader layout attribute ${s.name} not present in shader`)}return i}const Dv=class Dv extends Mn{constructor(i,s){super(i,s,Dv.defaultProps);fe(this,"maxVertexAttributes");fe(this,"attributeInfos");fe(this,"indexBuffer",null);fe(this,"attributes");this.maxVertexAttributes=i.limits.maxVertexAttributes,this.attributes=new Array(this.maxVertexAttributes).fill(null),this.attributeInfos=g7(s.renderPipeline.shaderLayout,s.renderPipeline.bufferLayout,this.maxVertexAttributes)}get[Symbol.toStringTag](){return"VertexArray"}setConstantWebGL(i,s){throw new Error("constant attributes not supported")}};fe(Dv,"defaultProps",{...Mn.defaultProps,renderPipeline:null});let tT=Dv;const Lv=class Lv extends Mn{get[Symbol.toStringTag](){return"TransformFeedback"}constructor(e,i){super(e,i,Lv.defaultProps)}};fe(Lv,"defaultProps",{...Mn.defaultProps,layout:void 0,buffers:{}});let iT=Lv;const Nv=class Nv extends Mn{get[Symbol.toStringTag](){return"QuerySet"}constructor(e,i){super(e,i,Nv.defaultProps)}};fe(Nv,"defaultProps",{...Mn.defaultProps,type:void 0,count:void 0});let rT=Nv;const S7={f32:{type:"f32",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16}};function A7(t){const e=S7[t];return Bn(t),e}function M7(t,e){switch(e){case 1:return t;case 2:return t+t%2;default:return t+(4-t%4)%4}}let Xy;function bD(t){return(!Xy||Xy.byteLength<t)&&(Xy=new ArrayBuffer(t)),Xy}function C7(t,e){const i=bD(t.BYTES_PER_ELEMENT*e);return new t(i,0,e)}function P7(t){const{target:e,source:i,start:s=0,count:c=1}=t,h=i.length,p=c*h;let v=0;for(let l=s;v<h;v++)e[l++]=i[v];for(;v<p;)v<p-v?(e.copyWithin(s+v,s,s+v),v*=2):(e.copyWithin(s+v,s,s+p-v),v=p);return t.target}const BP=1024;class I7{constructor(e){fe(this,"layout",{});fe(this,"byteLength");let i=0;for(const[c,h]of Object.entries(e)){const p=A7(h),{type:v,components:l}=p;i=M7(i,l);const A=i;i+=l,this.layout[c]={type:v,size:l,offset:A}}i+=(4-i%4)%4;const s=i*4;this.byteLength=Math.max(s,BP)}getData(e){const i=Math.max(this.byteLength,BP),s=bD(i),c={i32:new Int32Array(s),u32:new Uint32Array(s),f32:new Float32Array(s),f16:new Uint16Array(s)};for(const[h,p]of Object.entries(e)){const v=this.layout[h];if(!v){Jt.warn(`Supplied uniform value ${h} not present in uniform block layout`)();continue}const{type:l,size:A,offset:P}=v,O=c[l];if(A===1){if(typeof p!="number"&&typeof p!="boolean"){Jt.warn(`Supplied value for single component uniform ${h} is not a number: ${p}`)();continue}O[P]=Number(p)}else{const L=S_(p);if(!L){Jt.warn(`Supplied value for multi component / array uniform ${h} is not a numeric array: ${p}`)();continue}O.set(L,P)}}return new Uint8Array(s)}has(e){return!!this.layout[e]}get(e){return this.layout[e]}}function R7(t,e,i=16){if(t!==e)return!1;const s=S_(t);if(!s)return!1;const c=S_(e);if(c&&s.length===c.length){for(let h=0;h<s.length;++h)if(c[h]!==s[h])return!1}return!0}function O7(t){const e=S_(t);return e?e.slice():t}class k7{constructor(e){fe(this,"name");fe(this,"uniforms",{});fe(this,"modifiedUniforms",{});fe(this,"modified",!0);fe(this,"bindingLayout",{});fe(this,"needsRedraw","initialized");var i;if(this.name=e==null?void 0:e.name,e!=null&&e.name&&(e!=null&&e.shaderLayout)){const s=(i=e==null?void 0:e.shaderLayout.bindings)==null?void 0:i.find(h=>h.type==="uniform"&&h.name===(e==null?void 0:e.name));if(!s)throw new Error(e==null?void 0:e.name);const c=s;for(const h of c.uniforms||[])this.bindingLayout[h.name]=h}}setUniforms(e){for(const[i,s]of Object.entries(e))this._setUniform(i,s),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${i}=${s}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,i){R7(this.uniforms[e],i)||(this.uniforms[e]=O7(i),this.modifiedUniforms[e]=!0,this.modified=!0)}}class D7{constructor(e){fe(this,"uniformBlocks",new Map);fe(this,"uniformBufferLayouts",new Map);fe(this,"uniformBuffers",new Map);for(const[i,s]of Object.entries(e)){const c=i,h=new I7(s.uniformTypes||{});this.uniformBufferLayouts.set(c,h);const p=new k7({name:i});p.setUniforms(s.defaultUniforms||{}),this.uniformBlocks.set(c,p)}}destroy(){for(const e of this.uniformBuffers.values())e.destroy()}setUniforms(e){for(const[i,s]of Object.entries(e))this.uniformBlocks.get(i).setUniforms(s);this.updateUniformBuffers()}getUniformBufferByteLength(e){return this.uniformBufferLayouts.get(e).byteLength}getUniformBufferData(e){const i=this.uniformBlocks.get(e).getAllUniforms();return this.uniformBufferLayouts.get(e).getData(i)}createUniformBuffer(e,i,s){s&&this.setUniforms(s);const c=this.getUniformBufferByteLength(i),h=e.createBuffer({usage:Yn.UNIFORM|Yn.COPY_DST,byteLength:c}),p=this.getUniformBufferData(i);return h.write(p),h}getManagedUniformBuffer(e,i){if(!this.uniformBuffers.get(i)){const s=this.getUniformBufferByteLength(i),c=e.createBuffer({usage:Yn.UNIFORM|Yn.COPY_DST,byteLength:s});this.uniformBuffers.set(i,c)}return this.uniformBuffers.get(i)}updateUniformBuffers(){let e=!1;for(const i of this.uniformBlocks.keys()){const s=this.updateUniformBuffer(i);e||(e=s)}return e&&Jt.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){const i=this.uniformBlocks.get(e),s=this.uniformBuffers.get(e);let c=!1;if(s&&i.needsRedraw){c||(c=i.needsRedraw);const h=this.getUniformBufferData(e);this.uniformBuffers.get(e).write(h);const v=this.uniformBlocks.get(e).getAllUniforms();Jt.log(4,`Writing to uniform buffer ${String(e)}`,h,v)()}return c}}function wD(t){const e=ArrayBuffer.isView(t)?t.constructor:t;switch(e){case Float32Array:return"float32";case Uint16Array:return"uint16";case Uint32Array:return"uint32";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int8Array:return"sint8";case Int16Array:return"sint16";case Int32Array:return"sint32";default:throw new Error(e.constructor.name)}}function TD(t){switch(t){case"float32":return Float32Array;case"uint32":return Uint32Array;case"sint32":return Int32Array;case"uint16":case"unorm16":return Uint16Array;case"sint16":case"snorm16":return Int16Array;case"uint8":case"unorm8":return Uint8Array;case"sint8":case"snorm8":return Int8Array;default:throw new Error(t)}}function L7(t,e,i){if(!e||e>4)throw new Error(`size ${e}`);const s=e;let c=wD(t);if(c==="uint8"||c==="sint8"){if(s===1||s===3)throw new Error(`size: ${e}`);return i&&(c=c.replace("int","norm")),`${c}x${s}`}if(c==="uint16"||c==="sint16"){if(s===1||s===3)throw new Error(`size: ${e}`);return i&&(c=c.replace("int","norm")),`${c}x${s}`}return s===1?c:`${c}x${s}`}function N7(t){return S_(t)!==null||typeof t=="number"||typeof t=="boolean"}function ED(t){const e={bindings:{},uniforms:{}};return Object.keys(t).forEach(i=>{const s=t[i];N7(s)?e.uniforms[i]=s:e.bindings[i]=s}),e}function F7(t,e,i){const{removedProps:s={},deprecatedProps:c={},replacedProps:h={}}=i;for(const v in s)if(v in e){const A=s[v]?`${t}.${s[v]}`:"N/A";Jt.removed(`${t}.${v}`,A)()}for(const v in c)if(v in e){const l=c[v];Jt.deprecated(`${t}.${v}`,`${t}.${l}`)()}let p=null;for(const[v,l]of Object.entries(h))v in e&&(Jt.deprecated(`${t}.${v}`,`${t}.${l}`)(),p=p||Object.assign({},e),p[l]=e[v],delete p[v]);return p||e}let B7="";async function z7(t,e){return await new Promise((i,s)=>{try{const c=new Image;c.onload=()=>i(c),c.onerror=()=>s(new Error(`Could not load image ${t}.`)),c.crossOrigin=(e==null?void 0:e.crossOrigin)||"anonymous",c.src=t.startsWith("http")?t:B7+t}catch(c){s(c)}})}async function SD(t,e){const i=document.getElementsByTagName("head")[0];if(!i)throw new Error("loadScript");const s=document.createElement("script");return s.setAttribute("type","text/javascript"),s.setAttribute("src",t),e&&(s.id=e),new Promise((c,h)=>{s.onload=c,s.onerror=p=>h(new Error(`Unable to load script '${t}': ${p}`)),i.appendChild(s)})}function nT(t,e,i){if(t===e)return!0;if(!i||!t||!e)return!1;if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(!nT(t[s],e[s],i-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof t=="object"&&typeof e=="object"){const s=Object.keys(t),c=Object.keys(e);if(s.length!==c.length)return!1;for(const h of s)if(!e.hasOwnProperty(h)||!nT(t[h],e[h],i-1))return!1;return!0}return!1}function U7(t){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(t):setTimeout(t,1e3/60)}function V7(t){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(t):clearTimeout(t)}class j7{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class Ih{constructor(){}get isAstNode(){return!0}get astNodeType(){return""}evaluate(e){throw new Error("Cannot evaluate node")}evaluateString(e){return this.evaluate(e).toString()}}class us extends Ih{constructor(){super()}}let AD=class extends us{constructor(e,i,s,c){super(),this.name=e,this.args=i,this.returnType=s,this.body=c}get astNodeType(){return"function"}};class $7 extends us{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}}class W7 extends us{constructor(e,i){super(),this.condition=e,this.body=i}get astNodeType(){return"while"}}class H7 extends us{constructor(e){super(),this.body=e}get astNodeType(){return"continuing"}}class q7 extends us{constructor(e,i,s,c){super(),this.init=e,this.condition=i,this.increment=s,this.body=c}get astNodeType(){return"for"}}class Xd extends us{constructor(e,i,s,c,h){super(),this.name=e,this.type=i,this.storage=s,this.access=c,this.value=h}get astNodeType(){return"var"}}class MD extends us{constructor(e,i,s){super(),this.name=e,this.type=i,this.value=s}get astNodeType(){return"override"}}class zP extends us{constructor(e,i,s,c,h){super(),this.name=e,this.type=i,this.storage=s,this.access=c,this.value=h}get astNodeType(){return"let"}}class UP extends us{constructor(e,i,s,c,h){super(),this.name=e,this.type=i,this.storage=s,this.access=c,this.value=h}get astNodeType(){return"const"}evaluate(e){return this.value.evaluate(e)}}var vf;(function(t){t.increment="++",t.decrement="--"})(vf||(vf={}));(function(t){function e(i){const s=i;if(s=="parse")throw new Error("Invalid value for IncrementOperator");return t[s]}t.parse=e})(vf||(vf={}));class G7 extends us{constructor(e,i){super(),this.operator=e,this.variable=i}get astNodeType(){return"increment"}}var A_;(function(t){t.assign="=",t.addAssign="+=",t.subtractAssin="-=",t.multiplyAssign="*=",t.divideAssign="/=",t.moduloAssign="%=",t.andAssign="&=",t.orAssign="|=",t.xorAssign="^=",t.shiftLeftAssign="<<=",t.shiftRightAssign=">>="})(A_||(A_={}));(function(t){function e(i){const s=i;if(s=="parse")throw new Error("Invalid value for AssignOperator");return t[s]}t.parse=e})(A_||(A_={}));class X7 extends us{constructor(e,i,s){super(),this.operator=e,this.variable=i,this.value=s}get astNodeType(){return"assign"}}class Z7 extends us{constructor(e,i){super(),this.name=e,this.args=i}get astNodeType(){return"call"}}class Y7 extends us{constructor(e,i){super(),this.body=e,this.continuing=i}get astNodeType(){return"loop"}}class K7 extends us{constructor(e,i){super(),this.condition=e,this.body=i}get astNodeType(){return"body"}}class J7 extends us{constructor(e,i,s,c){super(),this.condition=e,this.body=i,this.elseif=s,this.else=c}get astNodeType(){return"if"}}class Q7 extends us{constructor(e){super(),this.value=e}get astNodeType(){return"return"}}class e9 extends us{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class CD extends us{constructor(e,i){super(),this.name=e,this.type=i}get astNodeType(){return"alias"}}class t9 extends us{constructor(){super()}get astNodeType(){return"discard"}}class i9 extends us{constructor(){super()}get astNodeType(){return"break"}}class r9 extends us{constructor(){super()}get astNodeType(){return"continue"}}class Rh extends us{constructor(e){super(),this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}}class Yu extends Rh{constructor(e,i){super(e),this.members=i}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let i=0;i<this.members.length;i++)if(this.members[i].name==e)return i;return-1}}class PD extends Rh{constructor(e,i,s){super(e),this.format=i,this.access=s}get astNodeType(){return"template"}}class n9 extends Rh{constructor(e,i,s,c){super(e),this.storage=i,this.type=s,this.access=c}get astNodeType(){return"pointer"}}class ID extends Rh{constructor(e,i,s,c){super(e),this.attributes=i,this.format=s,this.count=c}get astNodeType(){return"array"}get isArray(){return!0}}class Gm extends Rh{constructor(e,i,s){super(e),this.format=i,this.access=s}get astNodeType(){return"sampler"}}class ol extends Ih{constructor(){super()}}class VP extends ol{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}evaluateString(){return this.value}}class Xm extends ol{constructor(e,i){super(),this.type=e,this.args=i}get astNodeType(){return"createExpr"}}class s9 extends ol{constructor(e,i){super(),this.name=e,this.args=i}get astNodeType(){return"callExpr"}evaluate(e){switch(this.name){case"abs":return Math.abs(this.args[0].evaluate(e));case"acos":return Math.acos(this.args[0].evaluate(e));case"acosh":return Math.acosh(this.args[0].evaluate(e));case"asin":return Math.asin(this.args[0].evaluate(e));case"asinh":return Math.asinh(this.args[0].evaluate(e));case"atan":return Math.atan(this.args[0].evaluate(e));case"atan2":return Math.atan2(this.args[0].evaluate(e),this.args[1].evaluate(e));case"atanh":return Math.atanh(this.args[0].evaluate(e));case"ceil":return Math.ceil(this.args[0].evaluate(e));case"clamp":return Math.min(Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e)),this.args[2].evaluate(e));case"cos":return Math.cos(this.args[0].evaluate(e));case"degrees":return this.args[0].evaluate(e)*180/Math.PI;case"distance":return Math.sqrt(Math.pow(this.args[0].evaluate(e)-this.args[1].evaluate(e),2));case"dot":case"exp":return Math.exp(this.args[0].evaluate(e));case"exp2":return Math.pow(2,this.args[0].evaluate(e));case"floor":return Math.floor(this.args[0].evaluate(e));case"fma":return this.args[0].evaluate(e)*this.args[1].evaluate(e)+this.args[2].evaluate(e);case"fract":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"inverseSqrt":return 1/Math.sqrt(this.args[0].evaluate(e));case"log":return Math.log(this.args[0].evaluate(e));case"log2":return Math.log2(this.args[0].evaluate(e));case"max":return Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e));case"min":return Math.min(this.args[0].evaluate(e),this.args[1].evaluate(e));case"mix":return this.args[0].evaluate(e)*(1-this.args[2].evaluate(e))+this.args[1].evaluate(e)*this.args[2].evaluate(e);case"modf":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"pow":return Math.pow(this.args[0].evaluate(e),this.args[1].evaluate(e));case"radians":return this.args[0].evaluate(e)*Math.PI/180;case"round":return Math.round(this.args[0].evaluate(e));case"sign":return Math.sign(this.args[0].evaluate(e));case"sin":return Math.sin(this.args[0].evaluate(e));case"sinh":return Math.sinh(this.args[0].evaluate(e));case"saturate":return Math.min(Math.max(this.args[0].evaluate(e),0),1);case"smoothstep":return this.args[0].evaluate(e)*this.args[0].evaluate(e)*(3-2*this.args[0].evaluate(e));case"sqrt":return Math.sqrt(this.args[0].evaluate(e));case"step":return this.args[0].evaluate(e)<this.args[1].evaluate(e)?0:1;case"tan":return Math.tan(this.args[0].evaluate(e));case"tanh":return Math.tanh(this.args[0].evaluate(e));case"trunc":return Math.trunc(this.args[0].evaluate(e));default:throw new Error("Non const function: "+this.name)}}}class o9 extends ol{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}}class jP extends ol{constructor(e,i){super(),this.name=e,this.initializer=i}get astNodeType(){return"constExpr"}evaluate(e){var i,s;if(this.initializer instanceof Xm){const c=(i=this.postfix)===null||i===void 0?void 0:i.evaluateString(e),h=(s=this.initializer.type)===null||s===void 0?void 0:s.name,p=e.structs.get(h),v=p==null?void 0:p.getMemberIndex(c);if(v!=-1)return this.initializer.args[v].evaluate(e);console.log(v)}return this.initializer.evaluate(e)}}class $P extends ol{constructor(e){super(),this.value=e}get astNodeType(){return"literalExpr"}evaluate(){return this.value}}class a9 extends ol{constructor(e,i){super(),this.type=e,this.value=i}get astNodeType(){return"bitcastExpr"}}class l9 extends ol{constructor(e,i){super(),this.type=e,this.args=i}get astNodeType(){return"typecastExpr"}evaluate(e){return this.args[0].evaluate(e)}}class WP extends ol{constructor(e){super(),this.contents=e}get astNodeType(){return"groupExpr"}evaluate(e){return this.contents[0].evaluate(e)}}class RD extends ol{constructor(){super()}}class c9 extends RD{constructor(e,i){super(),this.operator=e,this.right=i}get astNodeType(){return"unaryOp"}evaluate(e){switch(this.operator){case"+":return this.right.evaluate(e);case"-":return-this.right.evaluate(e);case"!":return this.right.evaluate(e)?0:1;case"~":return~this.right.evaluate(e);default:throw new Error("Unknown unary operator: "+this.operator)}}}class Ga extends RD{constructor(e,i,s){super(),this.operator=e,this.left=i,this.right=s}get astNodeType(){return"binaryOp"}evaluate(e){switch(this.operator){case"+":return this.left.evaluate(e)+this.right.evaluate(e);case"-":return this.left.evaluate(e)-this.right.evaluate(e);case"*":return this.left.evaluate(e)*this.right.evaluate(e);case"/":return this.left.evaluate(e)/this.right.evaluate(e);case"%":return this.left.evaluate(e)%this.right.evaluate(e);case"==":return this.left.evaluate(e)==this.right.evaluate(e)?1:0;case"!=":return this.left.evaluate(e)!=this.right.evaluate(e)?1:0;case"<":return this.left.evaluate(e)<this.right.evaluate(e)?1:0;case">":return this.left.evaluate(e)>this.right.evaluate(e)?1:0;case"<=":return this.left.evaluate(e)<=this.right.evaluate(e)?1:0;case">=":return this.left.evaluate(e)>=this.right.evaluate(e)?1:0;case"&&":return this.left.evaluate(e)&&this.right.evaluate(e)?1:0;case"||":return this.left.evaluate(e)||this.right.evaluate(e)?1:0;default:throw new Error(`Unknown operator ${this.operator}`)}}}class OD extends Ih{constructor(){super()}}class u9 extends OD{constructor(e,i){super(),this.selector=e,this.body=i}get astNodeType(){return"case"}}class h9 extends OD{constructor(e){super(),this.body=e}get astNodeType(){return"default"}}class d9 extends Ih{constructor(e,i,s){super(),this.name=e,this.type=i,this.attributes=s}get astNodeType(){return"argument"}}class f9 extends Ih{constructor(e,i){super(),this.condition=e,this.body=i}get astNodeType(){return"elseif"}}class p9 extends Ih{constructor(e,i,s){super(),this.name=e,this.type=i,this.attributes=s}get astNodeType(){return"member"}}let HP=class extends Ih{constructor(e,i){super(),this.name=e,this.value=i}get astNodeType(){return"attribute"}};var Nt,$e;(function(t){t[t.token=0]="token",t[t.keyword=1]="keyword",t[t.reserved=2]="reserved"})($e||($e={}));class We{constructor(e,i,s){this.name=e,this.type=i,this.rule=s}toString(){return this.name}}class Ae{}Nt=Ae;Ae.none=new We("",$e.reserved,"");Ae.eof=new We("EOF",$e.token,"");Ae.reserved={asm:new We("asm",$e.reserved,"asm"),bf16:new We("bf16",$e.reserved,"bf16"),do:new We("do",$e.reserved,"do"),enum:new We("enum",$e.reserved,"enum"),f16:new We("f16",$e.reserved,"f16"),f64:new We("f64",$e.reserved,"f64"),handle:new We("handle",$e.reserved,"handle"),i8:new We("i8",$e.reserved,"i8"),i16:new We("i16",$e.reserved,"i16"),i64:new We("i64",$e.reserved,"i64"),mat:new We("mat",$e.reserved,"mat"),premerge:new We("premerge",$e.reserved,"premerge"),regardless:new We("regardless",$e.reserved,"regardless"),typedef:new We("typedef",$e.reserved,"typedef"),u8:new We("u8",$e.reserved,"u8"),u16:new We("u16",$e.reserved,"u16"),u64:new We("u64",$e.reserved,"u64"),unless:new We("unless",$e.reserved,"unless"),using:new We("using",$e.reserved,"using"),vec:new We("vec",$e.reserved,"vec"),void:new We("void",$e.reserved,"void")};Ae.keywords={array:new We("array",$e.keyword,"array"),atomic:new We("atomic",$e.keyword,"atomic"),bool:new We("bool",$e.keyword,"bool"),f32:new We("f32",$e.keyword,"f32"),i32:new We("i32",$e.keyword,"i32"),mat2x2:new We("mat2x2",$e.keyword,"mat2x2"),mat2x3:new We("mat2x3",$e.keyword,"mat2x3"),mat2x4:new We("mat2x4",$e.keyword,"mat2x4"),mat3x2:new We("mat3x2",$e.keyword,"mat3x2"),mat3x3:new We("mat3x3",$e.keyword,"mat3x3"),mat3x4:new We("mat3x4",$e.keyword,"mat3x4"),mat4x2:new We("mat4x2",$e.keyword,"mat4x2"),mat4x3:new We("mat4x3",$e.keyword,"mat4x3"),mat4x4:new We("mat4x4",$e.keyword,"mat4x4"),ptr:new We("ptr",$e.keyword,"ptr"),sampler:new We("sampler",$e.keyword,"sampler"),sampler_comparison:new We("sampler_comparison",$e.keyword,"sampler_comparison"),struct:new We("struct",$e.keyword,"struct"),texture_1d:new We("texture_1d",$e.keyword,"texture_1d"),texture_2d:new We("texture_2d",$e.keyword,"texture_2d"),texture_2d_array:new We("texture_2d_array",$e.keyword,"texture_2d_array"),texture_3d:new We("texture_3d",$e.keyword,"texture_3d"),texture_cube:new We("texture_cube",$e.keyword,"texture_cube"),texture_cube_array:new We("texture_cube_array",$e.keyword,"texture_cube_array"),texture_multisampled_2d:new We("texture_multisampled_2d",$e.keyword,"texture_multisampled_2d"),texture_storage_1d:new We("texture_storage_1d",$e.keyword,"texture_storage_1d"),texture_storage_2d:new We("texture_storage_2d",$e.keyword,"texture_storage_2d"),texture_storage_2d_array:new We("texture_storage_2d_array",$e.keyword,"texture_storage_2d_array"),texture_storage_3d:new We("texture_storage_3d",$e.keyword,"texture_storage_3d"),texture_depth_2d:new We("texture_depth_2d",$e.keyword,"texture_depth_2d"),texture_depth_2d_array:new We("texture_depth_2d_array",$e.keyword,"texture_depth_2d_array"),texture_depth_cube:new We("texture_depth_cube",$e.keyword,"texture_depth_cube"),texture_depth_cube_array:new We("texture_depth_cube_array",$e.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new We("texture_depth_multisampled_2d",$e.keyword,"texture_depth_multisampled_2d"),texture_external:new We("texture_external",$e.keyword,"texture_external"),u32:new We("u32",$e.keyword,"u32"),vec2:new We("vec2",$e.keyword,"vec2"),vec3:new We("vec3",$e.keyword,"vec3"),vec4:new We("vec4",$e.keyword,"vec4"),bitcast:new We("bitcast",$e.keyword,"bitcast"),block:new We("block",$e.keyword,"block"),break:new We("break",$e.keyword,"break"),case:new We("case",$e.keyword,"case"),continue:new We("continue",$e.keyword,"continue"),continuing:new We("continuing",$e.keyword,"continuing"),default:new We("default",$e.keyword,"default"),discard:new We("discard",$e.keyword,"discard"),else:new We("else",$e.keyword,"else"),enable:new We("enable",$e.keyword,"enable"),fallthrough:new We("fallthrough",$e.keyword,"fallthrough"),false:new We("false",$e.keyword,"false"),fn:new We("fn",$e.keyword,"fn"),for:new We("for",$e.keyword,"for"),function:new We("function",$e.keyword,"function"),if:new We("if",$e.keyword,"if"),let:new We("let",$e.keyword,"let"),const:new We("const",$e.keyword,"const"),loop:new We("loop",$e.keyword,"loop"),while:new We("while",$e.keyword,"while"),private:new We("private",$e.keyword,"private"),read:new We("read",$e.keyword,"read"),read_write:new We("read_write",$e.keyword,"read_write"),return:new We("return",$e.keyword,"return"),storage:new We("storage",$e.keyword,"storage"),switch:new We("switch",$e.keyword,"switch"),true:new We("true",$e.keyword,"true"),alias:new We("alias",$e.keyword,"alias"),type:new We("type",$e.keyword,"type"),uniform:new We("uniform",$e.keyword,"uniform"),var:new We("var",$e.keyword,"var"),override:new We("override",$e.keyword,"override"),workgroup:new We("workgroup",$e.keyword,"workgroup"),write:new We("write",$e.keyword,"write"),r8unorm:new We("r8unorm",$e.keyword,"r8unorm"),r8snorm:new We("r8snorm",$e.keyword,"r8snorm"),r8uint:new We("r8uint",$e.keyword,"r8uint"),r8sint:new We("r8sint",$e.keyword,"r8sint"),r16uint:new We("r16uint",$e.keyword,"r16uint"),r16sint:new We("r16sint",$e.keyword,"r16sint"),r16float:new We("r16float",$e.keyword,"r16float"),rg8unorm:new We("rg8unorm",$e.keyword,"rg8unorm"),rg8snorm:new We("rg8snorm",$e.keyword,"rg8snorm"),rg8uint:new We("rg8uint",$e.keyword,"rg8uint"),rg8sint:new We("rg8sint",$e.keyword,"rg8sint"),r32uint:new We("r32uint",$e.keyword,"r32uint"),r32sint:new We("r32sint",$e.keyword,"r32sint"),r32float:new We("r32float",$e.keyword,"r32float"),rg16uint:new We("rg16uint",$e.keyword,"rg16uint"),rg16sint:new We("rg16sint",$e.keyword,"rg16sint"),rg16float:new We("rg16float",$e.keyword,"rg16float"),rgba8unorm:new We("rgba8unorm",$e.keyword,"rgba8unorm"),rgba8unorm_srgb:new We("rgba8unorm_srgb",$e.keyword,"rgba8unorm_srgb"),rgba8snorm:new We("rgba8snorm",$e.keyword,"rgba8snorm"),rgba8uint:new We("rgba8uint",$e.keyword,"rgba8uint"),rgba8sint:new We("rgba8sint",$e.keyword,"rgba8sint"),bgra8unorm:new We("bgra8unorm",$e.keyword,"bgra8unorm"),bgra8unorm_srgb:new We("bgra8unorm_srgb",$e.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new We("rgb10a2unorm",$e.keyword,"rgb10a2unorm"),rg11b10float:new We("rg11b10float",$e.keyword,"rg11b10float"),rg32uint:new We("rg32uint",$e.keyword,"rg32uint"),rg32sint:new We("rg32sint",$e.keyword,"rg32sint"),rg32float:new We("rg32float",$e.keyword,"rg32float"),rgba16uint:new We("rgba16uint",$e.keyword,"rgba16uint"),rgba16sint:new We("rgba16sint",$e.keyword,"rgba16sint"),rgba16float:new We("rgba16float",$e.keyword,"rgba16float"),rgba32uint:new We("rgba32uint",$e.keyword,"rgba32uint"),rgba32sint:new We("rgba32sint",$e.keyword,"rgba32sint"),rgba32float:new We("rgba32float",$e.keyword,"rgba32float"),static_assert:new We("static_assert",$e.keyword,"static_assert")};Ae.tokens={decimal_float_literal:new We("decimal_float_literal",$e.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?f?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+f?)|([0-9]+f)/),hex_float_literal:new We("hex_float_literal",$e.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+f?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+f?))/),int_literal:new We("int_literal",$e.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new We("uint_literal",$e.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new We("ident",$e.token,/[a-zA-Z][0-9a-zA-Z_]*/),and:new We("and",$e.token,"&"),and_and:new We("and_and",$e.token,"&&"),arrow:new We("arrow ",$e.token,"->"),attr:new We("attr",$e.token,"@"),attr_left:new We("attr_left",$e.token,"[["),attr_right:new We("attr_right",$e.token,"]]"),forward_slash:new We("forward_slash",$e.token,"/"),bang:new We("bang",$e.token,"!"),bracket_left:new We("bracket_left",$e.token,"["),bracket_right:new We("bracket_right",$e.token,"]"),brace_left:new We("brace_left",$e.token,"{"),brace_right:new We("brace_right",$e.token,"}"),colon:new We("colon",$e.token,":"),comma:new We("comma",$e.token,","),equal:new We("equal",$e.token,"="),equal_equal:new We("equal_equal",$e.token,"=="),not_equal:new We("not_equal",$e.token,"!="),greater_than:new We("greater_than",$e.token,">"),greater_than_equal:new We("greater_than_equal",$e.token,">="),shift_right:new We("shift_right",$e.token,">>"),less_than:new We("less_than",$e.token,"<"),less_than_equal:new We("less_than_equal",$e.token,"<="),shift_left:new We("shift_left",$e.token,"<<"),modulo:new We("modulo",$e.token,"%"),minus:new We("minus",$e.token,"-"),minus_minus:new We("minus_minus",$e.token,"--"),period:new We("period",$e.token,"."),plus:new We("plus",$e.token,"+"),plus_plus:new We("plus_plus",$e.token,"++"),or:new We("or",$e.token,"|"),or_or:new We("or_or",$e.token,"||"),paren_left:new We("paren_left",$e.token,"("),paren_right:new We("paren_right",$e.token,")"),semicolon:new We("semicolon",$e.token,";"),star:new We("star",$e.token,"*"),tilde:new We("tilde",$e.token,"~"),underscore:new We("underscore",$e.token,"_"),xor:new We("xor",$e.token,"^"),plus_equal:new We("plus_equal",$e.token,"+="),minus_equal:new We("minus_equal",$e.token,"-="),times_equal:new We("times_equal",$e.token,"*="),division_equal:new We("division_equal",$e.token,"/="),modulo_equal:new We("modulo_equal",$e.token,"%="),and_equal:new We("and_equal",$e.token,"&="),or_equal:new We("or_equal",$e.token,"|="),xor_equal:new We("xor_equal",$e.token,"^="),shift_right_equal:new We("shift_right_equal",$e.token,">>="),shift_left_equal:new We("shift_left_equal",$e.token,"<<=")};Ae.storage_class=[Nt.keywords.function,Nt.keywords.private,Nt.keywords.workgroup,Nt.keywords.uniform,Nt.keywords.storage];Ae.access_mode=[Nt.keywords.read,Nt.keywords.write,Nt.keywords.read_write];Ae.sampler_type=[Nt.keywords.sampler,Nt.keywords.sampler_comparison];Ae.sampled_texture_type=[Nt.keywords.texture_1d,Nt.keywords.texture_2d,Nt.keywords.texture_2d_array,Nt.keywords.texture_3d,Nt.keywords.texture_cube,Nt.keywords.texture_cube_array];Ae.multisampled_texture_type=[Nt.keywords.texture_multisampled_2d];Ae.storage_texture_type=[Nt.keywords.texture_storage_1d,Nt.keywords.texture_storage_2d,Nt.keywords.texture_storage_2d_array,Nt.keywords.texture_storage_3d];Ae.depth_texture_type=[Nt.keywords.texture_depth_2d,Nt.keywords.texture_depth_2d_array,Nt.keywords.texture_depth_cube,Nt.keywords.texture_depth_cube_array,Nt.keywords.texture_depth_multisampled_2d];Ae.texture_external_type=[Nt.keywords.texture_external];Ae.any_texture_type=[...Nt.sampled_texture_type,...Nt.multisampled_texture_type,...Nt.storage_texture_type,...Nt.depth_texture_type,...Nt.texture_external_type];Ae.texel_format=[Nt.keywords.r8unorm,Nt.keywords.r8snorm,Nt.keywords.r8uint,Nt.keywords.r8sint,Nt.keywords.r16uint,Nt.keywords.r16sint,Nt.keywords.r16float,Nt.keywords.rg8unorm,Nt.keywords.rg8snorm,Nt.keywords.rg8uint,Nt.keywords.rg8sint,Nt.keywords.r32uint,Nt.keywords.r32sint,Nt.keywords.r32float,Nt.keywords.rg16uint,Nt.keywords.rg16sint,Nt.keywords.rg16float,Nt.keywords.rgba8unorm,Nt.keywords.rgba8unorm_srgb,Nt.keywords.rgba8snorm,Nt.keywords.rgba8uint,Nt.keywords.rgba8sint,Nt.keywords.bgra8unorm,Nt.keywords.bgra8unorm_srgb,Nt.keywords.rgb10a2unorm,Nt.keywords.rg11b10float,Nt.keywords.rg32uint,Nt.keywords.rg32sint,Nt.keywords.rg32float,Nt.keywords.rgba16uint,Nt.keywords.rgba16sint,Nt.keywords.rgba16float,Nt.keywords.rgba32uint,Nt.keywords.rgba32sint,Nt.keywords.rgba32float];Ae.const_literal=[Nt.tokens.int_literal,Nt.tokens.uint_literal,Nt.tokens.decimal_float_literal,Nt.tokens.hex_float_literal,Nt.keywords.true,Nt.keywords.false];Ae.literal_or_ident=[Nt.tokens.ident,Nt.tokens.int_literal,Nt.tokens.uint_literal,Nt.tokens.decimal_float_literal,Nt.tokens.hex_float_literal];Ae.element_count_expression=[Nt.tokens.int_literal,Nt.tokens.uint_literal,Nt.tokens.ident];Ae.template_types=[Nt.keywords.vec2,Nt.keywords.vec3,Nt.keywords.vec4,Nt.keywords.mat2x2,Nt.keywords.mat2x3,Nt.keywords.mat2x4,Nt.keywords.mat3x2,Nt.keywords.mat3x3,Nt.keywords.mat3x4,Nt.keywords.mat4x2,Nt.keywords.mat4x3,Nt.keywords.mat4x4,Nt.keywords.atomic,Nt.keywords.bitcast,...Nt.any_texture_type];Ae.attribute_name=[Nt.tokens.ident,Nt.keywords.block];Ae.assignment_operators=[Nt.tokens.equal,Nt.tokens.plus_equal,Nt.tokens.minus_equal,Nt.tokens.times_equal,Nt.tokens.division_equal,Nt.tokens.modulo_equal,Nt.tokens.and_equal,Nt.tokens.or_equal,Nt.tokens.xor_equal,Nt.tokens.shift_right_equal,Nt.tokens.shift_left_equal];Ae.increment_operators=[Nt.tokens.plus_plus,Nt.tokens.minus_minus];class qP{constructor(e,i,s){this.type=e,this.lexeme=i,this.line=s}toString(){return this.lexeme}isTemplateType(){return Ae.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==Ae.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class m9{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new qP(Ae.eof,"",this._line)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}else if(this._peekAhead()=="*"){this._advance();let s=1;for(;s>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),s--,s==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),s++)}return!0}}let i=Ae.none;for(;;){let s=this._findType(e);const c=this._peekAhead();if(e==">"&&(c==">"||c=="=")){let h=!1,p=this._tokens.length-1;for(let v=0;v<5&&p>=0;++v,--p)if(this._tokens[p].type===Ae.tokens.less_than){p>0&&this._tokens[p-1].isArrayOrTemplateType()&&(h=!0);break}if(h)return this._addToken(s),!0}if(s===Ae.none){let h=e,p=0;const v=2;for(let l=0;l<v;++l)if(h+=this._peekAhead(l),s=this._findType(h),s!==Ae.none){p=l;break}if(s===Ae.none)return i===Ae.none?!1:(this._current--,this._addToken(i),!0);e=h,this._current+=p+1}if(i=s,this._isAtEnd())break;e+=this._advance()}return i===Ae.none?!1:(this._addToken(i),!0)}_findType(e){for(const i in Ae.keywords){const s=Ae.keywords[i];if(this._match(e,s.rule))return s}for(const i in Ae.tokens){const s=Ae.tokens[i];if(this._match(e,s.rule))return s}return Ae.none}_match(e,i){if(typeof i=="string"){if(i==e)return!0}else{const s=i.exec(e);if(s&&s.index==0&&s[0]==e)return!0}return!1}_isAtEnd(){return this._current>=this._source.length}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let i=this._source[this._current];return e=e||0,e++,this._current+=e,i}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const i=this._source.substring(this._start,this._current);this._tokens.push(new qP(e,i,this._line))}}class _9{constructor(){this._tokens=[],this._current=0,this._context=new j7}parse(e){this._initialize(e);let i=[];for(;!this._isAtEnd();){const s=this._global_decl_or_directive();if(!s)break;i.push(s)}return i}_initialize(e){if(e)if(typeof e=="string"){const i=new m9(e);this._tokens=i.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_error(e,i){return console.error(e,i),{token:e,message:i,toString:function(){return`${i}`}}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==Ae.eof}_match(e){if(e instanceof We)return this._check(e)?(this._advance(),!0):!1;for(let i=0,s=e.length;i<s;++i){const c=e[i];if(this._check(c))return this._advance(),!0}return!1}_consume(e,i){if(this._check(e))return this._advance();throw this._error(this._peek(),i)}_check(e){if(this._isAtEnd())return!1;const i=this._peek();if(e instanceof Array){let s=i.type;return e.indexOf(s)!=-1}return i.type==e}_advance(){return this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(Ae.tokens.semicolon)&&!this._isAtEnd(););if(this._match(Ae.keywords.alias)){const i=this._type_alias();return this._consume(Ae.tokens.semicolon,"Expected ';'"),i}if(this._match(Ae.keywords.enable)){const i=this._enable_directive();return this._consume(Ae.tokens.semicolon,"Expected ';'"),i}const e=this._attribute();if(this._check(Ae.keywords.var)){const i=this._global_variable_decl();return i!=null&&(i.attributes=e),this._consume(Ae.tokens.semicolon,"Expected ';'."),i}if(this._check(Ae.keywords.override)){const i=this._override_variable_decl();return i!=null&&(i.attributes=e),this._consume(Ae.tokens.semicolon,"Expected ';'."),i}if(this._check(Ae.keywords.let)){const i=this._global_let_decl();return i!=null&&(i.attributes=e),this._consume(Ae.tokens.semicolon,"Expected ';'."),i}if(this._check(Ae.keywords.const)){const i=this._global_const_decl();return i!=null&&(i.attributes=e),this._consume(Ae.tokens.semicolon,"Expected ';'."),i}if(this._check(Ae.keywords.struct)){const i=this._struct_decl();return i!=null&&(i.attributes=e),i}if(this._check(Ae.keywords.fn)){const i=this._function_decl();return i!=null&&(i.attributes=e),i}return null}_function_decl(){if(!this._match(Ae.keywords.fn))return null;const e=this._consume(Ae.tokens.ident,"Expected function name.").toString();this._consume(Ae.tokens.paren_left,"Expected '(' for function arguments.");const i=[];if(!this._check(Ae.tokens.paren_right))do{if(this._check(Ae.tokens.paren_right))break;const h=this._attribute(),p=this._consume(Ae.tokens.ident,"Expected argument name.").toString();this._consume(Ae.tokens.colon,"Expected ':' for argument type.");const v=this._attribute(),l=this._type_decl();l!=null&&(l.attributes=v,i.push(new d9(p,l,h)))}while(this._match(Ae.tokens.comma));this._consume(Ae.tokens.paren_right,"Expected ')' after function arguments.");let s=null;if(this._match(Ae.tokens.arrow)){const h=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=h)}const c=this._compound_statement();return new AD(e,i,s,c)}_compound_statement(){const e=[];for(this._consume(Ae.tokens.brace_left,"Expected '{' for block.");!this._check(Ae.tokens.brace_right);){const i=this._statement();i!==null&&e.push(i)}return this._consume(Ae.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(Ae.tokens.semicolon)&&!this._isAtEnd(););if(this._check(Ae.keywords.if))return this._if_statement();if(this._check(Ae.keywords.switch))return this._switch_statement();if(this._check(Ae.keywords.loop))return this._loop_statement();if(this._check(Ae.keywords.for))return this._for_statement();if(this._check(Ae.keywords.while))return this._while_statement();if(this._check(Ae.keywords.continuing))return this._continuing_statement();if(this._check(Ae.keywords.static_assert))return this._static_assert_statement();if(this._check(Ae.tokens.brace_left))return this._compound_statement();let e=null;return this._check(Ae.keywords.return)?e=this._return_statement():this._check([Ae.keywords.var,Ae.keywords.let,Ae.keywords.const])?e=this._variable_statement():this._match(Ae.keywords.discard)?e=new t9:this._match(Ae.keywords.break)?e=new i9:this._match(Ae.keywords.continue)?e=new r9:e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement(),e!=null&&this._consume(Ae.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(Ae.keywords.static_assert))return null;let e=this._optional_paren_expression();return new $7(e)}_while_statement(){if(!this._match(Ae.keywords.while))return null;let e=this._optional_paren_expression();const i=this._compound_statement();return new W7(e,i)}_continuing_statement(){if(!this._match(Ae.keywords.continuing))return null;const e=this._compound_statement();return new H7(e)}_for_statement(){if(!this._match(Ae.keywords.for))return null;this._consume(Ae.tokens.paren_left,"Expected '('.");const e=this._check(Ae.tokens.semicolon)?null:this._for_init();this._consume(Ae.tokens.semicolon,"Expected ';'.");const i=this._check(Ae.tokens.semicolon)?null:this._short_circuit_or_expression();this._consume(Ae.tokens.semicolon,"Expected ';'.");const s=this._check(Ae.tokens.paren_right)?null:this._for_increment();this._consume(Ae.tokens.paren_right,"Expected ')'.");const c=this._compound_statement();return new q7(e,i,s,c)}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(Ae.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let i=null;return this._match(Ae.tokens.equal)&&(i=this._short_circuit_or_expression()),new Xd(e.name,e.type,e.storage,e.access,i)}if(this._match(Ae.keywords.let)){const e=this._consume(Ae.tokens.ident,"Expected name for let.").toString();let i=null;if(this._match(Ae.tokens.colon)){const c=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=c)}this._consume(Ae.tokens.equal,"Expected '=' for let.");const s=this._short_circuit_or_expression();return new zP(e,i,null,null,s)}if(this._match(Ae.keywords.const)){const e=this._consume(Ae.tokens.ident,"Expected name for const.").toString();let i=null;if(this._match(Ae.tokens.colon)){const c=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=c)}this._consume(Ae.tokens.equal,"Expected '=' for const.");const s=this._short_circuit_or_expression();return new UP(e,i,null,null,s)}return null}_increment_decrement_statement(){const e=this._current,i=this._unary_expression();if(i==null)return null;if(!this._check(Ae.increment_operators))return this._current=e,null;const s=this._consume(Ae.increment_operators,"Expected increment operator");return new G7(s.type===Ae.tokens.plus_plus?vf.increment:vf.decrement,i)}_assignment_statement(){let e=null;if(this._check(Ae.tokens.brace_right))return null;let i=this._match(Ae.tokens.underscore);if(i||(e=this._unary_expression()),!i&&e==null)return null;const s=this._consume(Ae.assignment_operators,"Expected assignment operator."),c=this._short_circuit_or_expression();return new X7(A_.parse(s.lexeme),e,c)}_func_call_statement(){if(!this._check(Ae.tokens.ident))return null;const e=this._current,i=this._consume(Ae.tokens.ident,"Expected function name."),s=this._argument_expression_list();return s===null?(this._current=e,null):new Z7(i.lexeme,s)}_loop_statement(){if(!this._match(Ae.keywords.loop))return null;this._consume(Ae.tokens.brace_left,"Expected '{' for loop.");const e=[];let i=this._statement();for(;i!==null;){if(Array.isArray(i))for(let c of i)e.push(c);else e.push(i);i=this._statement()}let s=null;return this._match(Ae.keywords.continuing)&&(s=this._compound_statement()),this._consume(Ae.tokens.brace_right,"Expected '}' for loop."),new Y7(e,s)}_switch_statement(){if(!this._match(Ae.keywords.switch))return null;const e=this._optional_paren_expression();this._consume(Ae.tokens.brace_left,"Expected '{' for switch.");const i=this._switch_body();if(i==null||i.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(Ae.tokens.brace_right,"Expected '}' for switch."),new K7(e,i)}_switch_body(){const e=[];if(this._match(Ae.keywords.case)){const i=this._case_selectors();this._match(Ae.tokens.colon),this._consume(Ae.tokens.brace_left,"Exected '{' for switch case.");const s=this._case_body();this._consume(Ae.tokens.brace_right,"Exected '}' for switch case."),e.push(new u9(i,s))}if(this._match(Ae.keywords.default)){this._match(Ae.tokens.colon),this._consume(Ae.tokens.brace_left,"Exected '{' for switch default.");const i=this._case_body();this._consume(Ae.tokens.brace_right,"Exected '}' for switch default."),e.push(new h9(i))}if(this._check([Ae.keywords.default,Ae.keywords.case])){const i=this._switch_body();e.push(i[0])}return e}_case_selectors(){var e,i,s,c;const h=[(i=(e=this._shift_expression())===null||e===void 0?void 0:e.evaluate(this._context).toString())!==null&&i!==void 0?i:""];for(;this._match(Ae.tokens.comma);)h.push((c=(s=this._shift_expression())===null||s===void 0?void 0:s.evaluate(this._context).toString())!==null&&c!==void 0?c:"");return h}_case_body(){if(this._match(Ae.keywords.fallthrough))return this._consume(Ae.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const i=this._case_body();return i.length==0?e:[...e,i[0]]}_if_statement(){if(!this._match(Ae.keywords.if))return null;const e=this._optional_paren_expression(),i=this._compound_statement();let s=[];this._match_elseif()&&(s=this._elseif_statement(s));let c=null;return this._match(Ae.keywords.else)&&(c=this._compound_statement()),new J7(e,i,s,c)}_match_elseif(){return this._tokens[this._current].type===Ae.keywords.else&&this._tokens[this._current+1].type===Ae.keywords.if?(this._advance(),this._advance(),!0):!1}_elseif_statement(e=[]){const i=this._optional_paren_expression(),s=this._compound_statement();return e.push(new f9(i,s)),this._match_elseif()&&this._elseif_statement(e),e}_return_statement(){if(!this._match(Ae.keywords.return))return null;const e=this._short_circuit_or_expression();return new Q7(e)}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(Ae.tokens.or_or);)e=new Ga(this._previous().toString(),e,this._short_circuit_and_expr());return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(Ae.tokens.and_and);)e=new Ga(this._previous().toString(),e,this._inclusive_or_expression());return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(Ae.tokens.or);)e=new Ga(this._previous().toString(),e,this._exclusive_or_expression());return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(Ae.tokens.xor);)e=new Ga(this._previous().toString(),e,this._and_expression());return e}_and_expression(){let e=this._equality_expression();for(;this._match(Ae.tokens.and);)e=new Ga(this._previous().toString(),e,this._equality_expression());return e}_equality_expression(){const e=this._relational_expression();return this._match([Ae.tokens.equal_equal,Ae.tokens.not_equal])?new Ga(this._previous().toString(),e,this._relational_expression()):e}_relational_expression(){let e=this._shift_expression();for(;this._match([Ae.tokens.less_than,Ae.tokens.greater_than,Ae.tokens.less_than_equal,Ae.tokens.greater_than_equal]);)e=new Ga(this._previous().toString(),e,this._shift_expression());return e}_shift_expression(){let e=this._additive_expression();for(;this._match([Ae.tokens.shift_left,Ae.tokens.shift_right]);)e=new Ga(this._previous().toString(),e,this._additive_expression());return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([Ae.tokens.plus,Ae.tokens.minus]);)e=new Ga(this._previous().toString(),e,this._multiplicative_expression());return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([Ae.tokens.star,Ae.tokens.forward_slash,Ae.tokens.modulo]);)e=new Ga(this._previous().toString(),e,this._unary_expression());return e}_unary_expression(){return this._match([Ae.tokens.minus,Ae.tokens.bang,Ae.tokens.tilde,Ae.tokens.star,Ae.tokens.and])?new c9(this._previous().toString(),this._unary_expression()):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),i=this._postfix_expression();return i&&(e.postfix=i),e}_postfix_expression(){if(this._match(Ae.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(Ae.tokens.bracket_right,"Expected ']'.");const i=this._postfix_expression();return i&&(e.postfix=i),e}if(this._match(Ae.tokens.period)){const e=this._consume(Ae.tokens.ident,"Expected member name."),i=this._postfix_expression(),s=new VP(e.lexeme);return i&&(s.postfix=i),s}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_primary_expression(){if(this._match(Ae.tokens.ident)){const s=this._previous().toString();if(this._check(Ae.tokens.paren_left)){const c=this._argument_expression_list(),h=this._getStruct(s);return h!=null?new Xm(h,c):new s9(s,c)}if(this._context.constants.has(s)){const c=this._context.constants.get(s);return new jP(s,c.value)}return new o9(s)}if(this._match(Ae.const_literal))return new $P(parseFloat(this._previous().toString()));if(this._check(Ae.tokens.paren_left))return this._paren_expression();if(this._match(Ae.keywords.bitcast)){this._consume(Ae.tokens.less_than,"Expected '<'.");const s=this._type_decl();this._consume(Ae.tokens.greater_than,"Expected '>'.");const c=this._paren_expression();return new a9(s,c)}const e=this._type_decl(),i=this._argument_expression_list();return new l9(e,i)}_argument_expression_list(){if(!this._match(Ae.tokens.paren_left))return null;const e=[];do{if(this._check(Ae.tokens.paren_right))break;const i=this._short_circuit_or_expression();e.push(i)}while(this._match(Ae.tokens.comma));return this._consume(Ae.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(Ae.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(Ae.tokens.paren_right),new WP([e])}_paren_expression(){this._consume(Ae.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(Ae.tokens.paren_right,"Expected ')'."),new WP([e])}_struct_decl(){if(!this._match(Ae.keywords.struct))return null;const e=this._consume(Ae.tokens.ident,"Expected name for struct.").toString();this._consume(Ae.tokens.brace_left,"Expected '{' for struct body.");const i=[];for(;!this._check(Ae.tokens.brace_right);){const c=this._attribute(),h=this._consume(Ae.tokens.ident,"Expected variable name.").toString();this._consume(Ae.tokens.colon,"Expected ':' for struct member type.");const p=this._attribute(),v=this._type_decl();v!=null&&(v.attributes=p),this._check(Ae.tokens.brace_right)?this._match(Ae.tokens.comma):this._consume(Ae.tokens.comma,"Expected ',' for struct member."),i.push(new p9(h,v,c))}this._consume(Ae.tokens.brace_right,"Expected '}' after struct body.");const s=new Yu(e,i);return this._context.structs.set(e,s),s}_global_variable_decl(){const e=this._variable_decl();return e&&this._match(Ae.tokens.equal)&&(e.value=this._const_expression()),e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(Ae.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){if(!this._match(Ae.keywords.const))return null;const e=this._consume(Ae.tokens.ident,"Expected variable name");let i=null;if(this._match(Ae.tokens.colon)){const h=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=h)}let s=null;if(this._match(Ae.tokens.equal)){const h=this._short_circuit_or_expression();if(h instanceof Xm)s=h;else if(h instanceof jP&&h.initializer instanceof Xm)s=h.initializer;else try{const p=h.evaluate(this._context);s=new $P(p)}catch{s=h}}const c=new UP(e.toString(),i,"","",s);return this._context.constants.set(c.name,c),c}_global_let_decl(){if(!this._match(Ae.keywords.let))return null;const e=this._consume(Ae.tokens.ident,"Expected variable name");let i=null;if(this._match(Ae.tokens.colon)){const c=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=c)}let s=null;return this._match(Ae.tokens.equal)&&(s=this._const_expression()),new zP(e.toString(),i,"","",s)}_const_expression(){if(this._match(Ae.const_literal))return new VP(this._previous().toString());const e=this._type_decl();this._consume(Ae.tokens.paren_left,"Expected '('.");let i=[];for(;!this._check(Ae.tokens.paren_right)&&(i.push(this._const_expression()),!!this._check(Ae.tokens.comma));)this._advance();return this._consume(Ae.tokens.paren_right,"Expected ')'."),new Xm(e,i)}_variable_decl(){if(!this._match(Ae.keywords.var))return null;let e="",i="";this._match(Ae.tokens.less_than)&&(e=this._consume(Ae.storage_class,"Expected storage_class.").toString(),this._match(Ae.tokens.comma)&&(i=this._consume(Ae.access_mode,"Expected access_mode.").toString()),this._consume(Ae.tokens.greater_than,"Expected '>'."));const s=this._consume(Ae.tokens.ident,"Expected variable name");let c=null;if(this._match(Ae.tokens.colon)){const h=this._attribute();c=this._type_decl(),c!=null&&(c.attributes=h)}return new Xd(s.toString(),c,e,i,null)}_override_decl(){if(!this._match(Ae.keywords.override))return null;const e=this._consume(Ae.tokens.ident,"Expected variable name");let i=null;if(this._match(Ae.tokens.colon)){const s=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=s)}return new MD(e.toString(),i,null)}_enable_directive(){const e=this._consume(Ae.tokens.ident,"identity expected.");return new e9(e.toString())}_type_alias(){const e=this._consume(Ae.tokens.ident,"identity expected.");this._consume(Ae.tokens.equal,"Expected '=' for type alias.");let i=this._type_decl();if(i===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(i.name)&&(i=this._context.aliases.get(i.name).type);const s=new CD(e.toString(),i);return this._context.aliases.set(s.name,s),s}_type_decl(){if(this._check([Ae.tokens.ident,...Ae.texel_format,Ae.keywords.bool,Ae.keywords.f32,Ae.keywords.i32,Ae.keywords.u32])){const s=this._advance(),c=s.toString();return this._context.structs.has(c)?this._context.structs.get(c):this._context.aliases.has(c)?this._context.aliases.get(c).type:new Rh(s.toString())}let e=this._texture_sampler_types();if(e)return e;if(this._check(Ae.template_types)){let s=this._advance().toString(),c=null,h=null;return this._match(Ae.tokens.less_than)&&(c=this._type_decl(),h=null,this._match(Ae.tokens.comma)&&(h=this._consume(Ae.access_mode,"Expected access_mode for pointer").toString()),this._consume(Ae.tokens.greater_than,"Expected '>' for type.")),new PD(s,c,h)}if(this._match(Ae.keywords.ptr)){let s=this._previous().toString();this._consume(Ae.tokens.less_than,"Expected '<' for pointer.");const c=this._consume(Ae.storage_class,"Expected storage_class for pointer");this._consume(Ae.tokens.comma,"Expected ',' for pointer.");const h=this._type_decl();let p=null;return this._match(Ae.tokens.comma)&&(p=this._consume(Ae.access_mode,"Expected access_mode for pointer").toString()),this._consume(Ae.tokens.greater_than,"Expected '>' for pointer."),new n9(s,c.toString(),h,p)}const i=this._attribute();if(this._match(Ae.keywords.array)){let s=null,c=-1;const h=this._previous();if(this._match(Ae.tokens.less_than)){s=this._type_decl(),this._context.aliases.has(s.name)&&(s=this._context.aliases.get(s.name).type);let p="";this._match(Ae.tokens.comma)&&(p=this._shift_expression().evaluate(this._context).toString()),this._consume(Ae.tokens.greater_than,"Expected '>' for array."),c=p?parseInt(p):0}return new ID(h.toString(),i,s,c)}return null}_texture_sampler_types(){if(this._match(Ae.sampler_type))return new Gm(this._previous().toString(),null,null);if(this._match(Ae.depth_texture_type))return new Gm(this._previous().toString(),null,null);if(this._match(Ae.sampled_texture_type)||this._match(Ae.multisampled_texture_type)){const e=this._previous();this._consume(Ae.tokens.less_than,"Expected '<' for sampler type.");const i=this._type_decl();return this._consume(Ae.tokens.greater_than,"Expected '>' for sampler type."),new Gm(e.toString(),i,null)}if(this._match(Ae.storage_texture_type)){const e=this._previous();this._consume(Ae.tokens.less_than,"Expected '<' for sampler type.");const i=this._consume(Ae.texel_format,"Invalid texel format.").toString();this._consume(Ae.tokens.comma,"Expected ',' after texel format.");const s=this._consume(Ae.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(Ae.tokens.greater_than,"Expected '>' for sampler type."),new Gm(e.toString(),i,s)}return null}_attribute(){let e=[];for(;this._match(Ae.tokens.attr);){const i=this._consume(Ae.attribute_name,"Expected attribute name"),s=new HP(i.toString(),null);if(this._match(Ae.tokens.paren_left)){if(s.value=this._consume(Ae.literal_or_ident,"Expected attribute value").toString(),this._check(Ae.tokens.comma)){this._advance();do{const c=this._consume(Ae.literal_or_ident,"Expected attribute value").toString();s.value instanceof Array||(s.value=[s.value]),s.value.push(c)}while(this._match(Ae.tokens.comma))}this._consume(Ae.tokens.paren_right,"Expected ')'")}e.push(s)}for(;this._match(Ae.tokens.attr_left);){if(!this._check(Ae.tokens.attr_right))do{const i=this._consume(Ae.attribute_name,"Expected attribute name"),s=new HP(i.toString(),null);if(this._match(Ae.tokens.paren_left)){if(s.value=[this._consume(Ae.literal_or_ident,"Expected attribute value").toString()],this._check(Ae.tokens.comma)){this._advance();do{const c=this._consume(Ae.literal_or_ident,"Expected attribute value").toString();s.value.push(c)}while(this._match(Ae.tokens.comma))}this._consume(Ae.tokens.paren_right,"Expected ')'")}e.push(s)}while(this._match(Ae.tokens.comma));this._consume(Ae.tokens.attr_right,"Expected ']]' after attribute declarations")}return e.length==0?null:e}}class sf{constructor(e,i){this.name=e,this.attributes=i,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class GP{constructor(e,i,s){this.name=e,this.type=i,this.attributes=s,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Zy extends sf{constructor(e,i){super(e,i),this.members=[],this.align=0}get isStruct(){return!0}}class Pb extends sf{constructor(e,i){super(e,i),this.count=0,this.stride=0}get isArray(){return!0}}class XP extends sf{constructor(e,i,s,c){super(e,s),this.format=i,this.access=c}get isTemplate(){return!0}}var Mc;(function(t){t[t.Uniform=0]="Uniform",t[t.Storage=1]="Storage",t[t.Texture=2]="Texture",t[t.Sampler=3]="Sampler",t[t.StorageTexture=4]="StorageTexture"})(Mc||(Mc={}));class Yy{constructor(e,i,s,c,h,p,v){this.name=e,this.type=i,this.group=s,this.binding=c,this.attributes=h,this.resourceType=p,this.access=v}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class g9{constructor(e,i){this.name=e,this.type=i}}class Ky{constructor(e,i){this.align=e,this.size=i}}class y9{constructor(e,i,s,c){this.name=e,this.type=i,this.locationType=s,this.location=c,this.interpolation=null}}class ZP{constructor(e,i,s,c){this.name=e,this.type=i,this.locationType=s,this.location=c}}class v9{constructor(e,i=null){this.stage=null,this.inputs=[],this.outputs=[],this.name=e,this.stage=i}}class x9{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class b9{constructor(e,i,s,c){this.name=e,this.type=i,this.attributes=s,this.id=c}}class kl{constructor(e){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new x9,this._types=new Map,e&&this.update(e)}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}update(e){const s=new _9().parse(e);for(const c of s){if(c instanceof Yu){const h=this._getTypeInfo(c,null);h instanceof Zy&&this.structs.push(h);continue}if(c instanceof CD){this.aliases.push(this._getAliasInfo(c));continue}if(c instanceof MD){const h=c,p=this._getAttributeNum(h.attributes,"id",0),v=h.type!=null?this._getTypeInfo(h.type,h.attributes):null;this.overrides.push(new b9(h.name,v,h.attributes,p));continue}if(this._isUniformVar(c)){const h=c,p=this._getAttributeNum(h.attributes,"group",0),v=this._getAttributeNum(h.attributes,"binding",0),l=this._getTypeInfo(h.type,h.attributes),A=new Yy(h.name,l,p,v,h.attributes,Mc.Uniform,h.access);this.uniforms.push(A);continue}if(this._isStorageVar(c)){const h=c,p=this._getAttributeNum(h.attributes,"group",0),v=this._getAttributeNum(h.attributes,"binding",0),l=this._getTypeInfo(h.type,h.attributes),A=this._isStorageTexture(l),P=new Yy(h.name,l,p,v,h.attributes,A?Mc.StorageTexture:Mc.Storage,h.access);this.storage.push(P);continue}if(this._isTextureVar(c)){const h=c,p=this._getAttributeNum(h.attributes,"group",0),v=this._getAttributeNum(h.attributes,"binding",0),l=this._getTypeInfo(h.type,h.attributes),A=this._isStorageTexture(l),P=new Yy(h.name,l,p,v,h.attributes,A?Mc.StorageTexture:Mc.Texture,h.access);A?this.storage.push(P):this.textures.push(P);continue}if(this._isSamplerVar(c)){const h=c,p=this._getAttributeNum(h.attributes,"group",0),v=this._getAttributeNum(h.attributes,"binding",0),l=this._getTypeInfo(h.type,h.attributes),A=new Yy(h.name,l,p,v,h.attributes,Mc.Sampler,h.access);this.samplers.push(A);continue}if(c instanceof AD){const h=this._getAttribute(c,"vertex"),p=this._getAttribute(c,"fragment"),v=this._getAttribute(c,"compute"),l=h||p||v;if(l){const A=new v9(c.name,l.name);A.inputs=this._getInputs(c.args),A.outputs=this._getOutputs(c.returnType),this.entry[l.name].push(A)}continue}}}getBindGroups(){const e=[];function i(s,c){s>=e.length&&(e.length=s+1),e[s]===void 0&&(e[s]=[]),c>=e[s].length&&(e[s].length=c+1)}for(const s of this.uniforms){i(s.group,s.binding);const c=e[s.group];c[s.binding]=s}for(const s of this.storage){i(s.group,s.binding);const c=e[s.group];c[s.binding]=s}for(const s of this.textures){i(s.group,s.binding);const c=e[s.group];c[s.binding]=s}for(const s of this.samplers){i(s.group,s.binding);const c=e[s.group];c[s.binding]=s}return e}_getOutputs(e,i=void 0){if(i===void 0&&(i=[]),e instanceof Yu)this._getStructOutputs(e,i);else{const s=this._getOutputInfo(e);s!==null&&i.push(s)}return i}_getStructOutputs(e,i){for(const s of e.members)if(s.type instanceof Yu)this._getStructOutputs(s.type,i);else{const c=this._getAttribute(s,"location")||this._getAttribute(s,"builtin");if(c!==null){const h=this._getTypeInfo(s.type,s.type.attributes),p=this._parseInt(c.value),v=new ZP(s.name,h,c.name,p);i.push(v)}}}_getOutputInfo(e){const i=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(i!==null){const s=this._getTypeInfo(e,e.attributes),c=this._parseInt(i.value);return new ZP("",s,i.name,c)}return null}_getInputs(e,i=void 0){i===void 0&&(i=[]);for(const s of e)if(s.type instanceof Yu)this._getStructInputs(s.type,i);else{const c=this._getInputInfo(s);c!==null&&i.push(c)}return i}_getStructInputs(e,i){for(const s of e.members)if(s.type instanceof Yu)this._getStructInputs(s.type,i);else{const c=this._getInputInfo(s);c!==null&&i.push(c)}}_getInputInfo(e){const i=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(i!==null){const s=this._getAttribute(e,"interpolation"),c=this._getTypeInfo(e.type,e.attributes),h=this._parseInt(i.value),p=new y9(e.name,c,i.name,h);return s!==null&&(p.interpolation=this._parseString(s.value)),p}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const i=parseInt(e);return isNaN(i)?e:i}_getAlias(e){for(const i of this.aliases)if(i.name==e)return i.type;return null}_getAliasInfo(e){return new g9(e.name,this._getTypeInfo(e.type,null))}_getTypeInfo(e,i){if(this._types.has(e))return this._types.get(e);if(e instanceof ID){const c=e,h=this._getTypeInfo(c.format,c.attributes),p=new Pb(c.name,i);return p.format=h,p.count=c.count,this._types.set(e,p),this._updateTypeInfo(p),p}if(e instanceof Yu){const c=e,h=new Zy(c.name,i);for(const p of c.members){const v=this._getTypeInfo(p.type,p.attributes);h.members.push(new GP(p.name,v,p.attributes))}return this._types.set(e,h),this._updateTypeInfo(h),h}if(e instanceof Gm){const c=e,h=c.format instanceof Rh,p=c.format?h?this._getTypeInfo(c.format,null):new sf(c.format,null):null,v=new XP(c.name,p,i,c.access);return this._types.set(e,v),this._updateTypeInfo(v),v}if(e instanceof PD){const c=e,h=c.format?this._getTypeInfo(c.format,null):null,p=new XP(c.name,h,i,c.access);return this._types.set(e,p),this._updateTypeInfo(p),p}const s=new sf(e.name,i);return this._types.set(e,s),this._updateTypeInfo(s),s}_updateTypeInfo(e){var i,s;const c=this._getTypeSize(e);if(e.size=(i=c==null?void 0:c.size)!==null&&i!==void 0?i:0,e instanceof Pb){const h=this._getTypeSize(e.format);e.stride=(s=h==null?void 0:h.size)!==null&&s!==void 0?s:0,this._updateTypeInfo(e.format)}e instanceof Zy&&this._updateStructInfo(e)}_updateStructInfo(e){var i;let s=0,c=0,h=0,p=0;for(let v=0,l=e.members.length;v<l;++v){const A=e.members[v],P=this._getTypeSize(A);if(!P)continue;(i=this._getAlias(A.type.name))!==null&&i!==void 0||A.type;const O=P.align,L=P.size;s=this._roundUp(O,s+c),c=L,h=s,p=Math.max(p,O),A.offset=s,A.size=L,this._updateTypeInfo(A.type)}e.size=this._roundUp(p,h+c),e.align=p}_getTypeSize(e){var i;if(e==null)return null;const s=this._getAttributeNum(e.attributes,"size",0),c=this._getAttributeNum(e.attributes,"align",0);if(e instanceof GP&&(e=e.type),e instanceof sf){const h=this._getAlias(e.name);h!==null&&(e=h)}{const h=kl._typeInfo[e.name];if(h!==void 0){const p=e.format==="f16"?2:1;return new Ky(Math.max(c,h.align/p),Math.max(s,h.size/p))}}{const h=kl._typeInfo[e.name.substring(0,e.name.length-1)];if(h){const p=e.name[e.name.length-1]==="h"?2:1;return new Ky(Math.max(c,h.align/p),Math.max(s,h.size/p))}}if(e instanceof Pb){let h=e,p=8,v=8;const l=this._getTypeSize(h.format);l!==null&&(v=l.size,p=l.align);const A=h.count,P=this._getAttributeNum((i=e==null?void 0:e.attributes)!==null&&i!==void 0?i:null,"stride",this._roundUp(p,v));return v=A*P,s&&(v=s),new Ky(Math.max(c,p),Math.max(s,v))}if(e instanceof Zy){let h=0,p=0,v=0,l=0,A=0;for(const P of e.members){const O=this._getTypeSize(P.type);O!==null&&(h=Math.max(O.align,h),v=this._roundUp(O.align,v+l),l=O.size,A=v)}return p=this._roundUp(h,A+l),new Ky(Math.max(c,h),Math.max(s,p))}return null}_isUniformVar(e){return e instanceof Xd&&e.storage=="uniform"}_isStorageVar(e){return e instanceof Xd&&e.storage=="storage"}_isTextureVar(e){return e instanceof Xd&&e.type!==null&&kl._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof Xd&&e.type!==null&&kl._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,i){const s=e;if(!s||!s.attributes)return null;const c=s.attributes;for(let h of c)if(h.name==i)return h;return null}_getAttributeNum(e,i,s){if(e===null)return s;for(let c of e)if(c.name==i){let h=c!==null&&c.value!==null?c.value:s;return h instanceof Array&&(h=h[0]),typeof h=="number"?h:typeof h=="string"?parseInt(h):s}return s}_roundUp(e,i){return Math.ceil(i/e)*e}}kl._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}};kl._textureTypes=Ae.any_texture_type.map(t=>t.name);kl._samplerTypes=Ae.sampler_type.map(t=>t.name);function w9(t){const e={attributes:[],bindings:[]};let i;try{i=T9(t)}catch(h){return Jt.error(h.message)(),e}for(const h of i.uniforms){const p=[];for(const v of h.type.members)p.push({name:v.name,type:YP(v.type)});e.bindings.push({type:"uniform",name:h.name,location:h.binding,group:h.group,members:p})}const s=i.entry.vertex[0],c=(s==null?void 0:s.inputs.length)||0;for(let h=0;h<c;h++){const p=s.inputs[h];if(p.locationType==="location"){const v=YP(p.type);e.attributes.push({name:p.name,location:p.location,type:v})}}return e}function YP(t){return t.format?`${t.name}<${t.format.name}>`:t.name}function T9(t){try{return new kl(t)}catch(e){if(e instanceof Error)throw e;let i="WGSL parse error";throw typeof e=="object"&&(e!=null&&e.message)&&(i+=`: ${e.message} `),typeof e=="object"&&(e!=null&&e.token)&&(i+=e.token.line||""),new Error(i,{cause:e})}}const E9=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;
const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;
const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;
const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;
float sin_taylor_fp32(float a) {
float r, s, t, x;
if (a == 0.0) {
return 0.0;
}
x = -a * a;
s = a;
r = a;
r = r * x;
t = r * INVERSE_FACTORIAL_3;
s = s + t;
r = r * x;
t = r * INVERSE_FACTORIAL_5;
s = s + t;
r = r * x;
t = r * INVERSE_FACTORIAL_7;
s = s + t;
r = r * x;
t = r * INVERSE_FACTORIAL_9;
s = s + t;
return s;
}
void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
if (a == 0.0) {
sin_t = 0.0;
cos_t = 1.0;
}
sin_t = sin_taylor_fp32(a);
cos_t = sqrt(1.0 - sin_t * sin_t);
}
float tan_taylor_fp32(float a) {
float sin_a;
float cos_a;
if (a == 0.0) {
return 0.0;
}
float z = floor(a / TWO_PI);
float r = a - TWO_PI * z;
float t;
float q = floor(r / PI_2 + 0.5);
int j = int(q);
if (j < -2 || j > 2) {
return 1.0 / 0.0;
}
t = r - PI_2 * q;
q = floor(t / PI_16 + 0.5);
int k = int(q);
int abs_k = int(abs(float(k)));
if (abs_k > 4) {
return 1.0 / 0.0;
} else {
t = t - PI_16 * q;
}
float u = 0.0;
float v = 0.0;
float sin_t, cos_t;
float s, c;
sincos_taylor_fp32(t, sin_t, cos_t);
if (k == 0) {
s = sin_t;
c = cos_t;
} else {
if (abs(float(abs_k) - 1.0) < 0.5) {
u = COS_TABLE_0;
v = SIN_TABLE_0;
} else if (abs(float(abs_k) - 2.0) < 0.5) {
u = COS_TABLE_1;
v = SIN_TABLE_1;
} else if (abs(float(abs_k) - 3.0) < 0.5) {
u = COS_TABLE_2;
v = SIN_TABLE_2;
} else if (abs(float(abs_k) - 4.0) < 0.5) {
u = COS_TABLE_3;
v = SIN_TABLE_3;
}
if (k > 0) {
s = u * sin_t + v * cos_t;
c = u * cos_t - v * sin_t;
} else {
s = u * sin_t - v * cos_t;
c = u * cos_t + v * sin_t;
}
}
if (j == 0) {
sin_a = s;
cos_a = c;
} else if (j == 1) {
sin_a = c;
cos_a = -s;
} else if (j == -1) {
sin_a = -c;
cos_a = s;
} else {
sin_a = -s;
cos_a = -c;
}
return sin_a / cos_a;
}
#endif
float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
return tan_taylor_fp32(a);
#else
return tan(a);
#endif
}
`,S9={name:"fp32",vs:E9},A9=new Float32Array([0,1,1,1]),M9=`uniform pickingUniforms {
float isActive;
float isAttribute;
float isHighlightActive;
float useFloatColors;
vec3 highlightedObjectColor;
vec4 highlightColor;
} picking;
out vec4 picking_vRGBcolor_Avalid;
vec3 picking_normalizeColor(vec3 color) {
return picking.useFloatColors > 0.5 ? color : color / 255.0;
}
vec4 picking_normalizeColor(vec4 color) {
return picking.useFloatColors > 0.5 ? color : color / 255.0;
}
bool picking_isColorZero(vec3 color) {
return dot(color, vec3(1.0)) < 0.00001;
}
bool picking_isColorValid(vec3 color) {
return dot(color, vec3(1.0)) > 0.00001;
}
bool isVertexHighlighted(vec3 vertexColor) {
vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
return
bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}
void picking_setPickingColor(vec3 pickingColor) {
pickingColor = picking_normalizeColor(pickingColor);
if (bool(picking.isActive)) {
picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));
if (!bool(picking.isAttribute)) {
picking_vRGBcolor_Avalid.rgb = pickingColor;
}
} else {
picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
}
}
void picking_setPickingAttribute(float value) {
if (bool(picking.isAttribute)) {
picking_vRGBcolor_Avalid.r = value;
}
}
void picking_setPickingAttribute(vec2 value) {
if (bool(picking.isAttribute)) {
picking_vRGBcolor_Avalid.rg = value;
}
}
void picking_setPickingAttribute(vec3 value) {
if (bool(picking.isAttribute)) {
picking_vRGBcolor_Avalid.rgb = value;
}
}
`,C9=`uniform pickingUniforms {
float isActive;
float isAttribute;
float isHighlightActive;
float useFloatColors;
vec3 highlightedObjectColor;
vec4 highlightColor;
} picking;
in vec4 picking_vRGBcolor_Avalid;
vec4 picking_filterHighlightColor(vec4 color) {
if (picking.isActive > 0.5) {
return color;
}
bool selected = bool(picking_vRGBcolor_Avalid.a);
if (selected) {
float highLightAlpha = picking.highlightColor.a;
float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
float highLightRatio = highLightAlpha / blendedAlpha;
vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
return vec4(blendedRGB, blendedAlpha);
} else {
return color;
}
}
vec4 picking_filterPickingColor(vec4 color) {
if (bool(picking.isActive)) {
if (picking_vRGBcolor_Avalid.a == 0.0) {
discard;
}
return picking_vRGBcolor_Avalid;
}
return color;
}
vec4 picking_filterColor(vec4 color) {
vec4 highlightColor = picking_filterHighlightColor(color);
return picking_filterPickingColor(highlightColor);
}
`,KP={name:"picking",vs:M9,fs:C9,uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:new Float32Array([0,0,0]),highlightColor:A9},getUniforms:P9};function P9(t={},e){const i={};if(t.highlightedObjectColor!==void 0)if(t.highlightedObjectColor===null)i.isHighlightActive=!1;else{i.isHighlightActive=!0;const s=t.highlightedObjectColor.slice(0,3);i.highlightedObjectColor=s}if(t.highlightColor){const s=Array.from(t.highlightColor,c=>c/255);Number.isFinite(s[3])||(s[3]=1),i.highlightColor=s}return t.isActive!==void 0&&(i.isActive=!!t.isActive,i.isAttribute=!!t.isAttribute),t.useFloatColors!==void 0&&(i.useFloatColors=!!t.useFloatColors),i}const I9={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1};globalThis.mathgl=globalThis.mathgl||{config:{...I9}};const ao=globalThis.mathgl.config;function R9(t,{precision:e=ao.precision}={}){return t=O9(t),`${parseFloat(t.toPrecision(e))}`}function Th(t){return Array.isArray(t)||ArrayBuffer.isView(t)&&!(t instanceof DataView)}function Os(t,e,i){return D9(t,s=>Math.max(e,Math.min(i,s)))}function dh(t,e,i){return Th(t)?t.map((s,c)=>dh(s,e[c],i)):i*e+(1-i)*t}function Ll(t,e,i){const s=ao.EPSILON;i&&(ao.EPSILON=i);try{if(t===e)return!0;if(Th(t)&&Th(e)){if(t.length!==e.length)return!1;for(let c=0;c<t.length;++c)if(!Ll(t[c],e[c]))return!1;return!0}return t&&t.equals?t.equals(e):e&&e.equals?e.equals(t):typeof t=="number"&&typeof e=="number"?Math.abs(t-e)<=ao.EPSILON*Math.max(1,Math.abs(t),Math.abs(e)):!1}finally{ao.EPSILON=s}}function O9(t){return Math.round(t/ao.EPSILON)*ao.EPSILON}function k9(t){return t.clone?t.clone():new Array(t.length)}function D9(t,e,i){if(Th(t)){const s=t;i=i||k9(s);for(let c=0;c<i.length&&c<s.length;++c){const h=typeof t=="number"?t:t[c];i[c]=e(h,c,i)}return i}return e(t)}class xE extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,i=0){for(let s=0;s<this.ELEMENTS;++s)this[s]=e[s+i];return this.check()}toArray(e=[],i=0){for(let s=0;s<this.ELEMENTS;++s)e[i+s]=this[s];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:Th(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(ao)}formatString(e){let i="";for(let s=0;s<this.ELEMENTS;++s)i+=(s>0?", ":"")+R9(this[s],e);return`${e.printTypes?this.constructor.name:""}[${i}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let i=0;i<this.ELEMENTS;++i)if(!Ll(this[i],e[i]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let i=0;i<this.ELEMENTS;++i)if(this[i]!==e[i])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,i,s){if(s===void 0)return this.lerp(this,e,i);for(let c=0;c<this.ELEMENTS;++c){const h=e[c],p=typeof i=="number"?i:i[c];this[c]=h+s*(p-h)}return this.check()}min(e){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(e[i],this[i]);return this.check()}max(e){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.max(e[i],this[i]);return this.check()}clamp(e,i){for(let s=0;s<this.ELEMENTS;++s)this[s]=Math.min(Math.max(this[s],e[s]),i[s]);return this.check()}add(...e){for(const i of e)for(let s=0;s<this.ELEMENTS;++s)this[s]+=i[s];return this.check()}subtract(...e){for(const i of e)for(let s=0;s<this.ELEMENTS;++s)this[s]-=i[s];return this.check()}scale(e){if(typeof e=="number")for(let i=0;i<this.ELEMENTS;++i)this[i]*=e;else for(let i=0;i<this.ELEMENTS&&i<e.length;++i)this[i]*=e[i];return this.check()}multiplyByScalar(e){for(let i=0;i<this.ELEMENTS;++i)this[i]*=e;return this.check()}check(){if(ao.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let i=0;i<this.ELEMENTS;++i)e=e&&Number.isFinite(this[i]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let i=0;i<this.ELEMENTS;++i)this[i]=e;return this.check()}addScalar(e){for(let i=0;i<this.ELEMENTS;++i)this[i]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let i=0;i<this.ELEMENTS;++i)this[i]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,i){for(let s=0;s<this.ELEMENTS;++s)this[s]=Math.min(Math.max(this[s],e),i);return this.check()}get elements(){return this}}function L9(t,e){if(t.length!==e)return!1;for(let i=0;i<t.length;++i)if(!Number.isFinite(t[i]))return!1;return!0}function kn(t){if(!Number.isFinite(t))throw new Error(`Invalid number ${JSON.stringify(t)}`);return t}function n_(t,e,i=""){if(ao.debug&&!L9(t,e))throw new Error(`math.gl: ${i} some fields set to invalid numbers'`);return t}function M_(t,e){if(!t)throw new Error(`math.gl assertion ${e}`)}class kD extends xE{get x(){return this[0]}set x(e){this[0]=kn(e)}get y(){return this[1]}set y(e){this[1]=kn(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let i=0;i<this.ELEMENTS;++i)e+=this[i]*this[i];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let i=0;for(let s=0;s<this.ELEMENTS;++s){const c=this[s]-e[s];i+=c*c}return kn(i)}dot(e){let i=0;for(let s=0;s<this.ELEMENTS;++s)i+=this[s]*e[s];return kn(i)}normalize(){const e=this.magnitude();if(e!==0)for(let i=0;i<this.ELEMENTS;++i)this[i]/=e;return this.check()}multiply(...e){for(const i of e)for(let s=0;s<this.ELEMENTS;++s)this[s]*=i[s];return this.check()}divide(...e){for(const i of e)for(let s=0;s<this.ELEMENTS;++s)this[s]/=i[s];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return M_(e>=0&&e<this.ELEMENTS,"index is out of range"),kn(this[e])}setComponent(e,i){return M_(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=i,this.check()}addVectors(e,i){return this.copy(e).add(i)}subVectors(e,i){return this.copy(e).subtract(i)}multiplyVectors(e,i){return this.copy(e).multiply(i)}addScaledVector(e,i){return this.add(new this.constructor(e).multiplyScalar(i))}}const s_=1e-6;let wa=typeof Float32Array<"u"?Float32Array:Array;function N9(){const t=new wa(2);return wa!=Float32Array&&(t[0]=0,t[1]=0),t}function av(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t}function DD(t,e){return t[0]=-e[0],t[1]=-e[1],t}function LD(t,e,i,s){const c=e[0],h=e[1];return t[0]=c+s*(i[0]-c),t[1]=h+s*(i[1]-h),t}function F9(t,e,i){const s=e[0],c=e[1];return t[0]=i[0]*s+i[3]*c+i[6],t[1]=i[1]*s+i[4]*c+i[7],t}function B9(t,e,i){const s=e[0],c=e[1];return t[0]=i[0]*s+i[4]*c+i[12],t[1]=i[1]*s+i[5]*c+i[13],t}(function(){const t=N9();return function(e,i,s,c,h,p){let v,l;for(i||(i=2),s||(s=0),c?l=Math.min(c*i+s,e.length):l=e.length,v=s;v<l;v+=i)t[0]=e[v],t[1]=e[v+1],h(t,t,p),e[v]=t[0],e[v+1]=t[1];return e}})();function z9(t,e,i){const s=e[0],c=e[1],h=i[3]*s+i[7]*c||1;return t[0]=(i[0]*s+i[4]*c)/h,t[1]=(i[1]*s+i[5]*c)/h,t}function ND(t,e,i){const s=e[0],c=e[1],h=e[2],p=i[3]*s+i[7]*c+i[11]*h||1;return t[0]=(i[0]*s+i[4]*c+i[8]*h)/p,t[1]=(i[1]*s+i[5]*c+i[9]*h)/p,t[2]=(i[2]*s+i[6]*c+i[10]*h)/p,t}function U9(t,e,i){const s=e[0],c=e[1];return t[0]=i[0]*s+i[2]*c,t[1]=i[1]*s+i[3]*c,t[2]=e[2],t}function V9(t,e,i){const s=e[0],c=e[1];return t[0]=i[0]*s+i[2]*c,t[1]=i[1]*s+i[3]*c,t[2]=e[2],t[3]=e[3],t}function FD(t,e,i){const s=e[0],c=e[1],h=e[2];return t[0]=i[0]*s+i[3]*c+i[6]*h,t[1]=i[1]*s+i[4]*c+i[7]*h,t[2]=i[2]*s+i[5]*c+i[8]*h,t[3]=e[3],t}function BD(){const t=new wa(3);return wa!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function j9(t){const e=t[0],i=t[1],s=t[2];return Math.sqrt(e*e+i*i+s*s)}function JP(t,e,i){const s=new wa(3);return s[0]=t,s[1]=e,s[2]=i,s}function $9(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function W9(t){const e=t[0],i=t[1],s=t[2];return e*e+i*i+s*s}function H9(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function q9(t,e){const i=e[0],s=e[1],c=e[2];let h=i*i+s*s+c*c;return h>0&&(h=1/Math.sqrt(h)),t[0]=e[0]*h,t[1]=e[1]*h,t[2]=e[2]*h,t}function zD(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function C0(t,e,i){const s=e[0],c=e[1],h=e[2],p=i[0],v=i[1],l=i[2];return t[0]=c*l-h*v,t[1]=h*p-s*l,t[2]=s*v-c*p,t}function G9(t,e,i,s){const c=e[0],h=e[1],p=e[2];return t[0]=c+s*(i[0]-c),t[1]=h+s*(i[1]-h),t[2]=p+s*(i[2]-p),t}function bE(t,e,i){const s=e[0],c=e[1],h=e[2];let p=i[3]*s+i[7]*c+i[11]*h+i[15];return p=p||1,t[0]=(i[0]*s+i[4]*c+i[8]*h+i[12])/p,t[1]=(i[1]*s+i[5]*c+i[9]*h+i[13])/p,t[2]=(i[2]*s+i[6]*c+i[10]*h+i[14])/p,t}function UD(t,e,i){const s=e[0],c=e[1],h=e[2];return t[0]=s*i[0]+c*i[3]+h*i[6],t[1]=s*i[1]+c*i[4]+h*i[7],t[2]=s*i[2]+c*i[5]+h*i[8],t}function VD(t,e,i){const s=i[0],c=i[1],h=i[2],p=i[3],v=e[0],l=e[1],A=e[2];let P=c*A-h*l,O=h*v-s*A,L=s*l-c*v,U=c*L-h*O,H=h*P-s*L,Y=s*O-c*P;const J=p*2;return P*=J,O*=J,L*=J,U*=2,H*=2,Y*=2,t[0]=v+P+U,t[1]=l+O+H,t[2]=A+L+Y,t}function X9(t,e,i,s){const c=[],h=[];return c[0]=e[0]-i[0],c[1]=e[1]-i[1],c[2]=e[2]-i[2],h[0]=c[0],h[1]=c[1]*Math.cos(s)-c[2]*Math.sin(s),h[2]=c[1]*Math.sin(s)+c[2]*Math.cos(s),t[0]=h[0]+i[0],t[1]=h[1]+i[1],t[2]=h[2]+i[2],t}function Z9(t,e,i,s){const c=[],h=[];return c[0]=e[0]-i[0],c[1]=e[1]-i[1],c[2]=e[2]-i[2],h[0]=c[2]*Math.sin(s)+c[0]*Math.cos(s),h[1]=c[1],h[2]=c[2]*Math.cos(s)-c[0]*Math.sin(s),t[0]=h[0]+i[0],t[1]=h[1]+i[1],t[2]=h[2]+i[2],t}function Y9(t,e,i,s){const c=[],h=[];return c[0]=e[0]-i[0],c[1]=e[1]-i[1],c[2]=e[2]-i[2],h[0]=c[0]*Math.cos(s)-c[1]*Math.sin(s),h[1]=c[0]*Math.sin(s)+c[1]*Math.cos(s),h[2]=c[2],t[0]=h[0]+i[0],t[1]=h[1]+i[1],t[2]=h[2]+i[2],t}function K9(t,e){const i=t[0],s=t[1],c=t[2],h=e[0],p=e[1],v=e[2],l=Math.sqrt((i*i+s*s+c*c)*(h*h+p*p+v*v)),A=l&&zD(t,e)/l;return Math.acos(Math.min(Math.max(A,-1),1))}const jD=$9,$D=j9,Ib=W9;(function(){const t=BD();return function(e,i,s,c,h,p){let v,l;for(i||(i=3),s||(s=0),c?l=Math.min(c*i+s,e.length):l=e.length,v=s;v<l;v+=i)t[0]=e[v],t[1]=e[v+1],t[2]=e[v+2],h(t,t,p),e[v]=t[0],e[v+1]=t[1],e[v+2]=t[2];return e}})();const Rb=[0,0,0];let Jy;class yi extends kD{static get ZERO(){return Jy||(Jy=new yi(0,0,0),Object.freeze(Jy)),Jy}constructor(e=0,i=0,s=0){super(-0,-0,-0),arguments.length===1&&Th(e)?this.copy(e):(ao.debug&&(kn(e),kn(i),kn(s)),this[0]=e,this[1]=i,this[2]=s)}set(e,i,s){return this[0]=e,this[1]=i,this[2]=s,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return ao.debug&&(kn(e.x),kn(e.y),kn(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=kn(e)}angle(e){return K9(this,e)}cross(e){return C0(this,this,e),this.check()}rotateX({radians:e,origin:i=Rb}){return X9(this,this,i,e),this.check()}rotateY({radians:e,origin:i=Rb}){return Z9(this,this,i,e),this.check()}rotateZ({radians:e,origin:i=Rb}){return Y9(this,this,i,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return bE(this,this,e),this.check()}transformAsVector(e){return ND(this,this,e),this.check()}transformByMatrix3(e){return UD(this,this,e),this.check()}transformByMatrix2(e){return U9(this,this,e),this.check()}transformByQuaternion(e){return VD(this,this,e),this.check()}}let Qy;class wE extends kD{static get ZERO(){return Qy||(Qy=new wE(0,0,0,0),Object.freeze(Qy)),Qy}constructor(e=0,i=0,s=0,c=0){super(-0,-0,-0,-0),Th(e)&&arguments.length===1?this.copy(e):(ao.debug&&(kn(e),kn(i),kn(s),kn(c)),this[0]=e,this[1]=i,this[2]=s,this[3]=c)}set(e,i,s,c){return this[0]=e,this[1]=i,this[2]=s,this[3]=c,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}fromObject(e){return ao.debug&&(kn(e.x),kn(e.y),kn(e.z),kn(e.w)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e.w=this[3],e}get ELEMENTS(){return 4}get z(){return this[2]}set z(e){this[2]=kn(e)}get w(){return this[3]}set w(e){this[3]=kn(e)}transform(e){return bE(this,this,e),this.check()}transformByMatrix3(e){return FD(this,this,e),this.check()}transformByMatrix2(e){return V9(this,this,e),this.check()}transformByQuaternion(e){return VD(this,this,e),this.check()}applyMatrix4(e){return e.transform(this,this),this}}class WD extends xE{toString(){let e="[";if(ao.printRowMajor){e+="row-major:";for(let i=0;i<this.RANK;++i)for(let s=0;s<this.RANK;++s)e+=` ${this[s*this.RANK+i]}`}else{e+="column-major:";for(let i=0;i<this.ELEMENTS;++i)e+=` ${this[i]}`}return e+="]",e}getElementIndex(e,i){return i*this.RANK+e}getElement(e,i){return this[i*this.RANK+e]}setElement(e,i,s){return this[i*this.RANK+e]=kn(s),this}getColumn(e,i=new Array(this.RANK).fill(-0)){const s=e*this.RANK;for(let c=0;c<this.RANK;++c)i[c]=this[s+c];return i}setColumn(e,i){const s=e*this.RANK;for(let c=0;c<this.RANK;++c)this[s+c]=i[c];return this}}function J9(){const t=new wa(9);return wa!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function Q9(t,e){if(t===e){const i=e[1],s=e[2],c=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=s,t[7]=c}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function e2(t,e){const i=e[0],s=e[1],c=e[2],h=e[3],p=e[4],v=e[5],l=e[6],A=e[7],P=e[8],O=P*p-v*A,L=-P*h+v*l,U=A*h-p*l;let H=i*O+s*L+c*U;return H?(H=1/H,t[0]=O*H,t[1]=(-P*s+c*A)*H,t[2]=(v*s-c*p)*H,t[3]=L*H,t[4]=(P*i-c*l)*H,t[5]=(-v*i+c*h)*H,t[6]=U*H,t[7]=(-A*i+s*l)*H,t[8]=(p*i-s*h)*H,t):null}function t2(t){const e=t[0],i=t[1],s=t[2],c=t[3],h=t[4],p=t[5],v=t[6],l=t[7],A=t[8];return e*(A*h-p*l)+i*(-A*c+p*v)+s*(l*c-h*v)}function QP(t,e,i){const s=e[0],c=e[1],h=e[2],p=e[3],v=e[4],l=e[5],A=e[6],P=e[7],O=e[8],L=i[0],U=i[1],H=i[2],Y=i[3],J=i[4],oe=i[5],me=i[6],pe=i[7],be=i[8];return t[0]=L*s+U*p+H*A,t[1]=L*c+U*v+H*P,t[2]=L*h+U*l+H*O,t[3]=Y*s+J*p+oe*A,t[4]=Y*c+J*v+oe*P,t[5]=Y*h+J*l+oe*O,t[6]=me*s+pe*p+be*A,t[7]=me*c+pe*v+be*P,t[8]=me*h+pe*l+be*O,t}function i2(t,e,i){const s=e[0],c=e[1],h=e[2],p=e[3],v=e[4],l=e[5],A=e[6],P=e[7],O=e[8],L=i[0],U=i[1];return t[0]=s,t[1]=c,t[2]=h,t[3]=p,t[4]=v,t[5]=l,t[6]=L*s+U*p+A,t[7]=L*c+U*v+P,t[8]=L*h+U*l+O,t}function r2(t,e,i){const s=e[0],c=e[1],h=e[2],p=e[3],v=e[4],l=e[5],A=e[6],P=e[7],O=e[8],L=Math.sin(i),U=Math.cos(i);return t[0]=U*s+L*p,t[1]=U*c+L*v,t[2]=U*h+L*l,t[3]=U*p-L*s,t[4]=U*v-L*c,t[5]=U*l-L*h,t[6]=A,t[7]=P,t[8]=O,t}function eI(t,e,i){const s=i[0],c=i[1];return t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=c*e[3],t[4]=c*e[4],t[5]=c*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function n2(t,e){const i=e[0],s=e[1],c=e[2],h=e[3],p=i+i,v=s+s,l=c+c,A=i*p,P=s*p,O=s*v,L=c*p,U=c*v,H=c*l,Y=h*p,J=h*v,oe=h*l;return t[0]=1-O-H,t[3]=P-oe,t[6]=L+J,t[1]=P+oe,t[4]=1-A-H,t[7]=U-Y,t[2]=L-J,t[5]=U+Y,t[8]=1-A-O,t}var sT;(function(t){t[t.COL0ROW0=0]="COL0ROW0",t[t.COL0ROW1=1]="COL0ROW1",t[t.COL0ROW2=2]="COL0ROW2",t[t.COL1ROW0=3]="COL1ROW0",t[t.COL1ROW1=4]="COL1ROW1",t[t.COL1ROW2=5]="COL1ROW2",t[t.COL2ROW0=6]="COL2ROW0",t[t.COL2ROW1=7]="COL2ROW1",t[t.COL2ROW2=8]="COL2ROW2"})(sT||(sT={}));const s2=Object.freeze([1,0,0,0,1,0,0,0,1]);class Us extends WD{static get IDENTITY(){return a2()}static get ZERO(){return o2()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return sT}constructor(e,...i){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):i.length>0?this.copy([e,...i]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(s2)}fromObject(e){return this.check()}fromQuaternion(e){return n2(this,e),this.check()}set(e,i,s,c,h,p,v,l,A){return this[0]=e,this[1]=i,this[2]=s,this[3]=c,this[4]=h,this[5]=p,this[6]=v,this[7]=l,this[8]=A,this.check()}setRowMajor(e,i,s,c,h,p,v,l,A){return this[0]=e,this[1]=c,this[2]=v,this[3]=i,this[4]=h,this[5]=l,this[6]=s,this[7]=p,this[8]=A,this.check()}determinant(){return t2(this)}transpose(){return Q9(this,this),this.check()}invert(){return e2(this,this),this.check()}multiplyLeft(e){return QP(this,e,this),this.check()}multiplyRight(e){return QP(this,this,e),this.check()}rotate(e){return r2(this,this,e),this.check()}scale(e){return Array.isArray(e)?eI(this,this,e):eI(this,this,[e,e]),this.check()}translate(e){return i2(this,this,e),this.check()}transform(e,i){let s;switch(e.length){case 2:s=F9(i||[-0,-0],e,this);break;case 3:s=UD(i||[-0,-0,-0],e,this);break;case 4:s=FD(i||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return n_(s,e.length),s}transformVector(e,i){return this.transform(e,i)}transformVector2(e,i){return this.transform(e,i)}transformVector3(e,i){return this.transform(e,i)}}let e0,t0=null;function o2(){return e0||(e0=new Us([0,0,0,0,0,0,0,0,0]),Object.freeze(e0)),e0}function a2(){return t0||(t0=new Us,Object.freeze(t0)),t0}function l2(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function c2(t,e){if(t===e){const i=e[1],s=e[2],c=e[3],h=e[6],p=e[7],v=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=i,t[6]=e[9],t[7]=e[13],t[8]=s,t[9]=h,t[11]=e[14],t[12]=c,t[13]=p,t[14]=v}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function oT(t,e){const i=e[0],s=e[1],c=e[2],h=e[3],p=e[4],v=e[5],l=e[6],A=e[7],P=e[8],O=e[9],L=e[10],U=e[11],H=e[12],Y=e[13],J=e[14],oe=e[15],me=i*v-s*p,pe=i*l-c*p,be=i*A-h*p,Oe=s*l-c*v,je=s*A-h*v,st=c*A-h*l,ut=P*Y-O*H,xe=P*J-L*H,it=P*oe-U*H,Be=O*J-L*Y,Qe=O*oe-U*Y,Ct=L*oe-U*J;let Kt=me*Ct-pe*Qe+be*Be+Oe*it-je*xe+st*ut;return Kt?(Kt=1/Kt,t[0]=(v*Ct-l*Qe+A*Be)*Kt,t[1]=(c*Qe-s*Ct-h*Be)*Kt,t[2]=(Y*st-J*je+oe*Oe)*Kt,t[3]=(L*je-O*st-U*Oe)*Kt,t[4]=(l*it-p*Ct-A*xe)*Kt,t[5]=(i*Ct-c*it+h*xe)*Kt,t[6]=(J*be-H*st-oe*pe)*Kt,t[7]=(P*st-L*be+U*pe)*Kt,t[8]=(p*Qe-v*it+A*ut)*Kt,t[9]=(s*it-i*Qe-h*ut)*Kt,t[10]=(H*je-Y*be+oe*me)*Kt,t[11]=(O*be-P*je-U*me)*Kt,t[12]=(v*xe-p*Be-l*ut)*Kt,t[13]=(i*Be-s*xe+c*ut)*Kt,t[14]=(Y*pe-H*Oe-J*me)*Kt,t[15]=(P*Oe-O*pe+L*me)*Kt,t):null}function u2(t){const e=t[0],i=t[1],s=t[2],c=t[3],h=t[4],p=t[5],v=t[6],l=t[7],A=t[8],P=t[9],O=t[10],L=t[11],U=t[12],H=t[13],Y=t[14],J=t[15],oe=e*p-i*h,me=e*v-s*h,pe=i*v-s*p,be=A*H-P*U,Oe=A*Y-O*U,je=P*Y-O*H,st=e*je-i*Oe+s*be,ut=h*je-p*Oe+v*be,xe=A*pe-P*me+O*oe,it=U*pe-H*me+Y*oe;return l*st-c*ut+J*xe-L*it}function fh(t,e,i){const s=e[0],c=e[1],h=e[2],p=e[3],v=e[4],l=e[5],A=e[6],P=e[7],O=e[8],L=e[9],U=e[10],H=e[11],Y=e[12],J=e[13],oe=e[14],me=e[15];let pe=i[0],be=i[1],Oe=i[2],je=i[3];return t[0]=pe*s+be*v+Oe*O+je*Y,t[1]=pe*c+be*l+Oe*L+je*J,t[2]=pe*h+be*A+Oe*U+je*oe,t[3]=pe*p+be*P+Oe*H+je*me,pe=i[4],be=i[5],Oe=i[6],je=i[7],t[4]=pe*s+be*v+Oe*O+je*Y,t[5]=pe*c+be*l+Oe*L+je*J,t[6]=pe*h+be*A+Oe*U+je*oe,t[7]=pe*p+be*P+Oe*H+je*me,pe=i[8],be=i[9],Oe=i[10],je=i[11],t[8]=pe*s+be*v+Oe*O+je*Y,t[9]=pe*c+be*l+Oe*L+je*J,t[10]=pe*h+be*A+Oe*U+je*oe,t[11]=pe*p+be*P+Oe*H+je*me,pe=i[12],be=i[13],Oe=i[14],je=i[15],t[12]=pe*s+be*v+Oe*O+je*Y,t[13]=pe*c+be*l+Oe*L+je*J,t[14]=pe*h+be*A+Oe*U+je*oe,t[15]=pe*p+be*P+Oe*H+je*me,t}function lv(t,e,i){const s=i[0],c=i[1],h=i[2];let p,v,l,A,P,O,L,U,H,Y,J,oe;return e===t?(t[12]=e[0]*s+e[4]*c+e[8]*h+e[12],t[13]=e[1]*s+e[5]*c+e[9]*h+e[13],t[14]=e[2]*s+e[6]*c+e[10]*h+e[14],t[15]=e[3]*s+e[7]*c+e[11]*h+e[15]):(p=e[0],v=e[1],l=e[2],A=e[3],P=e[4],O=e[5],L=e[6],U=e[7],H=e[8],Y=e[9],J=e[10],oe=e[11],t[0]=p,t[1]=v,t[2]=l,t[3]=A,t[4]=P,t[5]=O,t[6]=L,t[7]=U,t[8]=H,t[9]=Y,t[10]=J,t[11]=oe,t[12]=p*s+P*c+H*h+e[12],t[13]=v*s+O*c+Y*h+e[13],t[14]=l*s+L*c+J*h+e[14],t[15]=A*s+U*c+oe*h+e[15]),t}function TE(t,e,i){const s=i[0],c=i[1],h=i[2];return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*c,t[5]=e[5]*c,t[6]=e[6]*c,t[7]=e[7]*c,t[8]=e[8]*h,t[9]=e[9]*h,t[10]=e[10]*h,t[11]=e[11]*h,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function h2(t,e,i,s){let c=s[0],h=s[1],p=s[2],v=Math.sqrt(c*c+h*h+p*p),l,A,P,O,L,U,H,Y,J,oe,me,pe,be,Oe,je,st,ut,xe,it,Be,Qe,Ct,Kt,Ie;return v<s_?null:(v=1/v,c*=v,h*=v,p*=v,A=Math.sin(i),l=Math.cos(i),P=1-l,O=e[0],L=e[1],U=e[2],H=e[3],Y=e[4],J=e[5],oe=e[6],me=e[7],pe=e[8],be=e[9],Oe=e[10],je=e[11],st=c*c*P+l,ut=h*c*P+p*A,xe=p*c*P-h*A,it=c*h*P-p*A,Be=h*h*P+l,Qe=p*h*P+c*A,Ct=c*p*P+h*A,Kt=h*p*P-c*A,Ie=p*p*P+l,t[0]=O*st+Y*ut+pe*xe,t[1]=L*st+J*ut+be*xe,t[2]=U*st+oe*ut+Oe*xe,t[3]=H*st+me*ut+je*xe,t[4]=O*it+Y*Be+pe*Qe,t[5]=L*it+J*Be+be*Qe,t[6]=U*it+oe*Be+Oe*Qe,t[7]=H*it+me*Be+je*Qe,t[8]=O*Ct+Y*Kt+pe*Ie,t[9]=L*Ct+J*Kt+be*Ie,t[10]=U*Ct+oe*Kt+Oe*Ie,t[11]=H*Ct+me*Kt+je*Ie,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function HD(t,e,i){const s=Math.sin(i),c=Math.cos(i),h=e[4],p=e[5],v=e[6],l=e[7],A=e[8],P=e[9],O=e[10],L=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=h*c+A*s,t[5]=p*c+P*s,t[6]=v*c+O*s,t[7]=l*c+L*s,t[8]=A*c-h*s,t[9]=P*c-p*s,t[10]=O*c-v*s,t[11]=L*c-l*s,t}function d2(t,e,i){const s=Math.sin(i),c=Math.cos(i),h=e[0],p=e[1],v=e[2],l=e[3],A=e[8],P=e[9],O=e[10],L=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=h*c-A*s,t[1]=p*c-P*s,t[2]=v*c-O*s,t[3]=l*c-L*s,t[8]=h*s+A*c,t[9]=p*s+P*c,t[10]=v*s+O*c,t[11]=l*s+L*c,t}function qD(t,e,i){const s=Math.sin(i),c=Math.cos(i),h=e[0],p=e[1],v=e[2],l=e[3],A=e[4],P=e[5],O=e[6],L=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=h*c+A*s,t[1]=p*c+P*s,t[2]=v*c+O*s,t[3]=l*c+L*s,t[4]=A*c-h*s,t[5]=P*c-p*s,t[6]=O*c-v*s,t[7]=L*c-l*s,t}function f2(t,e){const i=e[0],s=e[1],c=e[2],h=e[4],p=e[5],v=e[6],l=e[8],A=e[9],P=e[10];return t[0]=Math.sqrt(i*i+s*s+c*c),t[1]=Math.sqrt(h*h+p*p+v*v),t[2]=Math.sqrt(l*l+A*A+P*P),t}function p2(t,e){const i=e[0],s=e[1],c=e[2],h=e[3],p=i+i,v=s+s,l=c+c,A=i*p,P=s*p,O=s*v,L=c*p,U=c*v,H=c*l,Y=h*p,J=h*v,oe=h*l;return t[0]=1-O-H,t[1]=P+oe,t[2]=L-J,t[3]=0,t[4]=P-oe,t[5]=1-A-H,t[6]=U+Y,t[7]=0,t[8]=L+J,t[9]=U-Y,t[10]=1-A-O,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function m2(t,e,i,s,c,h,p){const v=1/(i-e),l=1/(c-s),A=1/(h-p);return t[0]=h*2*v,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=h*2*l,t[6]=0,t[7]=0,t[8]=(i+e)*v,t[9]=(c+s)*l,t[10]=(p+h)*A,t[11]=-1,t[12]=0,t[13]=0,t[14]=p*h*2*A,t[15]=0,t}function _2(t,e,i,s,c){const h=1/Math.tan(e/2);if(t[0]=h/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,c!=null&&c!==1/0){const p=1/(s-c);t[10]=(c+s)*p,t[14]=2*c*s*p}else t[10]=-1,t[14]=-2*s;return t}const g2=_2;function y2(t,e,i,s,c,h,p){const v=1/(e-i),l=1/(s-c),A=1/(h-p);return t[0]=-2*v,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*A,t[11]=0,t[12]=(e+i)*v,t[13]=(c+s)*l,t[14]=(p+h)*A,t[15]=1,t}const v2=y2;function x2(t,e,i,s){let c,h,p,v,l,A,P,O,L,U;const H=e[0],Y=e[1],J=e[2],oe=s[0],me=s[1],pe=s[2],be=i[0],Oe=i[1],je=i[2];return Math.abs(H-be)<s_&&Math.abs(Y-Oe)<s_&&Math.abs(J-je)<s_?l2(t):(O=H-be,L=Y-Oe,U=J-je,c=1/Math.sqrt(O*O+L*L+U*U),O*=c,L*=c,U*=c,h=me*U-pe*L,p=pe*O-oe*U,v=oe*L-me*O,c=Math.sqrt(h*h+p*p+v*v),c?(c=1/c,h*=c,p*=c,v*=c):(h=0,p=0,v=0),l=L*v-U*p,A=U*h-O*v,P=O*p-L*h,c=Math.sqrt(l*l+A*A+P*P),c?(c=1/c,l*=c,A*=c,P*=c):(l=0,A=0,P=0),t[0]=h,t[1]=l,t[2]=O,t[3]=0,t[4]=p,t[5]=A,t[6]=L,t[7]=0,t[8]=v,t[9]=P,t[10]=U,t[11]=0,t[12]=-(h*H+p*Y+v*J),t[13]=-(l*H+A*Y+P*J),t[14]=-(O*H+L*Y+U*J),t[15]=1,t)}function b2(){const t=new wa(4);return wa!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function w2(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t}function EE(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t}function T2(t){const e=t[0],i=t[1],s=t[2],c=t[3];return Math.sqrt(e*e+i*i+s*s+c*c)}function E2(t){const e=t[0],i=t[1],s=t[2],c=t[3];return e*e+i*i+s*s+c*c}function S2(t,e){const i=e[0],s=e[1],c=e[2],h=e[3];let p=i*i+s*s+c*c+h*h;return p>0&&(p=1/Math.sqrt(p)),t[0]=i*p,t[1]=s*p,t[2]=c*p,t[3]=h*p,t}function A2(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function M2(t,e,i,s){const c=e[0],h=e[1],p=e[2],v=e[3];return t[0]=c+s*(i[0]-c),t[1]=h+s*(i[1]-h),t[2]=p+s*(i[2]-p),t[3]=v+s*(i[3]-v),t}function Pf(t,e,i){const s=e[0],c=e[1],h=e[2],p=e[3];return t[0]=i[0]*s+i[4]*c+i[8]*h+i[12]*p,t[1]=i[1]*s+i[5]*c+i[9]*h+i[13]*p,t[2]=i[2]*s+i[6]*c+i[10]*h+i[14]*p,t[3]=i[3]*s+i[7]*c+i[11]*h+i[15]*p,t}function C2(t,e,i){const s=e[0],c=e[1],h=e[2],p=i[0],v=i[1],l=i[2],A=i[3],P=A*s+v*h-l*c,O=A*c+l*s-p*h,L=A*h+p*c-v*s,U=-p*s-v*c-l*h;return t[0]=P*A+U*-p+O*-l-L*-v,t[1]=O*A+U*-v+L*-p-P*-l,t[2]=L*A+U*-l+P*-v-O*-p,t[3]=e[3],t}(function(){const t=b2();return function(e,i,s,c,h,p){let v,l;for(i||(i=4),s||(s=0),c?l=Math.min(c*i+s,e.length):l=e.length,v=s;v<l;v+=i)t[0]=e[v],t[1]=e[v+1],t[2]=e[v+2],t[3]=e[v+3],h(t,t,p),e[v]=t[0],e[v+1]=t[1],e[v+2]=t[2],e[v+3]=t[3];return e}})();var aT;(function(t){t[t.COL0ROW0=0]="COL0ROW0",t[t.COL0ROW1=1]="COL0ROW1",t[t.COL0ROW2=2]="COL0ROW2",t[t.COL0ROW3=3]="COL0ROW3",t[t.COL1ROW0=4]="COL1ROW0",t[t.COL1ROW1=5]="COL1ROW1",t[t.COL1ROW2=6]="COL1ROW2",t[t.COL1ROW3=7]="COL1ROW3",t[t.COL2ROW0=8]="COL2ROW0",t[t.COL2ROW1=9]="COL2ROW1",t[t.COL2ROW2=10]="COL2ROW2",t[t.COL2ROW3=11]="COL2ROW3",t[t.COL3ROW0=12]="COL3ROW0",t[t.COL3ROW1=13]="COL3ROW1",t[t.COL3ROW2=14]="COL3ROW2",t[t.COL3ROW3=15]="COL3ROW3"})(aT||(aT={}));const P2=45*Math.PI/180,I2=1,Ob=.1,kb=500,R2=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class Vs extends WD{static get IDENTITY(){return k2()}static get ZERO(){return O2()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return aT}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,i,s,c,h,p,v,l,A,P,O,L,U,H,Y,J){return this[0]=e,this[1]=i,this[2]=s,this[3]=c,this[4]=h,this[5]=p,this[6]=v,this[7]=l,this[8]=A,this[9]=P,this[10]=O,this[11]=L,this[12]=U,this[13]=H,this[14]=Y,this[15]=J,this.check()}setRowMajor(e,i,s,c,h,p,v,l,A,P,O,L,U,H,Y,J){return this[0]=e,this[1]=h,this[2]=A,this[3]=U,this[4]=i,this[5]=p,this[6]=P,this[7]=H,this[8]=s,this[9]=v,this[10]=O,this[11]=Y,this[12]=c,this[13]=l,this[14]=L,this[15]=J,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(R2)}fromObject(e){return this.check()}fromQuaternion(e){return p2(this,e),this.check()}frustum(e){const{left:i,right:s,bottom:c,top:h,near:p=Ob,far:v=kb}=e;return v===1/0?D2(this,i,s,c,h,p):m2(this,i,s,c,h,p,v),this.check()}lookAt(e){const{eye:i,center:s=[0,0,0],up:c=[0,1,0]}=e;return x2(this,i,s,c),this.check()}ortho(e){const{left:i,right:s,bottom:c,top:h,near:p=Ob,far:v=kb}=e;return v2(this,i,s,c,h,p,v),this.check()}orthographic(e){const{fovy:i=P2,aspect:s=I2,focalDistance:c=1,near:h=Ob,far:p=kb}=e;tI(i);const v=i/2,l=c*Math.tan(v),A=l*s;return this.ortho({left:-A,right:A,bottom:-l,top:l,near:h,far:p})}perspective(e){const{fovy:i=45*Math.PI/180,aspect:s=1,near:c=.1,far:h=500}=e;return tI(i),g2(this,i,s,c,h),this.check()}determinant(){return u2(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,i){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],i=i||[-0,-0,-0];const s=this.getScale(i),c=1/s[0],h=1/s[1],p=1/s[2];return e[0]=this[0]*c,e[1]=this[1]*h,e[2]=this[2]*p,e[3]=0,e[4]=this[4]*c,e[5]=this[5]*h,e[6]=this[6]*p,e[7]=0,e[8]=this[8]*c,e[9]=this[9]*h,e[10]=this[10]*p,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,i){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],i=i||[-0,-0,-0];const s=this.getScale(i),c=1/s[0],h=1/s[1],p=1/s[2];return e[0]=this[0]*c,e[1]=this[1]*h,e[2]=this[2]*p,e[3]=this[4]*c,e[4]=this[5]*h,e[5]=this[6]*p,e[6]=this[8]*c,e[7]=this[9]*h,e[8]=this[10]*p,e}transpose(){return c2(this,this),this.check()}invert(){return oT(this,this),this.check()}multiplyLeft(e){return fh(this,e,this),this.check()}multiplyRight(e){return fh(this,this,e),this.check()}rotateX(e){return HD(this,this,e),this.check()}rotateY(e){return d2(this,this,e),this.check()}rotateZ(e){return qD(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,i){return h2(this,this,e,i),this.check()}scale(e){return TE(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return lv(this,this,e),this.check()}transform(e,i){return e.length===4?(i=Pf(i||[-0,-0,-0,-0],e,this),n_(i,4),i):this.transformAsPoint(e,i)}transformAsPoint(e,i){const{length:s}=e;let c;switch(s){case 2:c=B9(i||[-0,-0],e,this);break;case 3:c=bE(i||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return n_(c,e.length),c}transformAsVector(e,i){let s;switch(e.length){case 2:s=z9(i||[-0,-0],e,this);break;case 3:s=ND(i||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return n_(s,e.length),s}transformPoint(e,i){return this.transformAsPoint(e,i)}transformVector(e,i){return this.transformAsPoint(e,i)}transformDirection(e,i){return this.transformAsVector(e,i)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,i,s){return this.identity().translate([e,i,s])}}let i0,r0;function O2(){return i0||(i0=new Vs([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(i0)),i0}function k2(){return r0||(r0=new Vs,Object.freeze(r0)),r0}function tI(t){if(t>Math.PI*2)throw Error("expected radians")}function D2(t,e,i,s,c,h){const p=2*h/(i-e),v=2*h/(c-s),l=(i+e)/(i-e),A=(c+s)/(c-s),P=-1,O=-1,L=-2*h;return t[0]=p,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=v,t[6]=0,t[7]=0,t[8]=l,t[9]=A,t[10]=P,t[11]=O,t[12]=0,t[13]=0,t[14]=L,t[15]=0,t}function iI(){const t=new wa(4);return wa!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function L2(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function GD(t,e,i){i=i*.5;const s=Math.sin(i);return t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=Math.cos(i),t}function rI(t,e,i){const s=e[0],c=e[1],h=e[2],p=e[3],v=i[0],l=i[1],A=i[2],P=i[3];return t[0]=s*P+p*v+c*A-h*l,t[1]=c*P+p*l+h*v-s*A,t[2]=h*P+p*A+s*l-c*v,t[3]=p*P-s*v-c*l-h*A,t}function N2(t,e,i){i*=.5;const s=e[0],c=e[1],h=e[2],p=e[3],v=Math.sin(i),l=Math.cos(i);return t[0]=s*l+p*v,t[1]=c*l+h*v,t[2]=h*l-c*v,t[3]=p*l-s*v,t}function F2(t,e,i){i*=.5;const s=e[0],c=e[1],h=e[2],p=e[3],v=Math.sin(i),l=Math.cos(i);return t[0]=s*l-h*v,t[1]=c*l+p*v,t[2]=h*l+s*v,t[3]=p*l-c*v,t}function B2(t,e,i){i*=.5;const s=e[0],c=e[1],h=e[2],p=e[3],v=Math.sin(i),l=Math.cos(i);return t[0]=s*l+c*v,t[1]=c*l-s*v,t[2]=h*l+p*v,t[3]=p*l-h*v,t}function z2(t,e){const i=e[0],s=e[1],c=e[2];return t[0]=i,t[1]=s,t[2]=c,t[3]=Math.sqrt(Math.abs(1-i*i-s*s-c*c)),t}function P0(t,e,i,s){const c=e[0],h=e[1],p=e[2],v=e[3];let l=i[0],A=i[1],P=i[2],O=i[3],L,U,H,Y,J;return L=c*l+h*A+p*P+v*O,L<0&&(L=-L,l=-l,A=-A,P=-P,O=-O),1-L>s_?(U=Math.acos(L),J=Math.sin(U),H=Math.sin((1-s)*U)/J,Y=Math.sin(s*U)/J):(H=1-s,Y=s),t[0]=H*c+Y*l,t[1]=H*h+Y*A,t[2]=H*p+Y*P,t[3]=H*v+Y*O,t}function U2(t,e){const i=e[0],s=e[1],c=e[2],h=e[3],p=i*i+s*s+c*c+h*h,v=p?1/p:0;return t[0]=-i*v,t[1]=-s*v,t[2]=-c*v,t[3]=h*v,t}function V2(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t}function XD(t,e){const i=e[0]+e[4]+e[8];let s;if(i>0)s=Math.sqrt(i+1),t[3]=.5*s,s=.5/s,t[0]=(e[5]-e[7])*s,t[1]=(e[6]-e[2])*s,t[2]=(e[1]-e[3])*s;else{let c=0;e[4]>e[0]&&(c=1),e[8]>e[c*3+c]&&(c=2);const h=(c+1)%3,p=(c+2)%3;s=Math.sqrt(e[c*3+c]-e[h*3+h]-e[p*3+p]+1),t[c]=.5*s,s=.5/s,t[3]=(e[h*3+p]-e[p*3+h])*s,t[h]=(e[h*3+c]+e[c*3+h])*s,t[p]=(e[p*3+c]+e[c*3+p])*s}return t}const j2=w2,$2=EE,W2=A2,H2=M2,q2=T2,G2=E2,ZD=S2,X2=function(){const t=BD(),e=JP(1,0,0),i=JP(0,1,0);return function(s,c,h){const p=zD(c,h);return p<-.999999?(C0(t,e,c),$D(t)<1e-6&&C0(t,i,c),q9(t,t),GD(s,t,Math.PI),s):p>.999999?(s[0]=0,s[1]=0,s[2]=0,s[3]=1,s):(C0(t,c,h),s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=1+p,ZD(s,s))}}();(function(){const t=iI(),e=iI();return function(i,s,c,h,p,v){return P0(t,s,p,v),P0(e,c,h,v),P0(i,t,e,2*v*(1-v)),i}})();(function(){const t=J9();return function(e,i,s,c){return t[0]=s[0],t[3]=s[1],t[6]=s[2],t[1]=c[0],t[4]=c[1],t[7]=c[2],t[2]=-i[0],t[5]=-i[1],t[8]=-i[2],ZD(e,XD(e,t))}})();const Z2=[0,0,0,1];class nI extends xE{constructor(e=0,i=0,s=0,c=1){super(-0,-0,-0,-0),Array.isArray(e)&&arguments.length===1?this.copy(e):this.set(e,i,s,c)}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}set(e,i,s,c){return this[0]=e,this[1]=i,this[2]=s,this[3]=c,this.check()}fromObject(e){return this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this.check()}fromMatrix3(e){return XD(this,e),this.check()}fromAxisRotation(e,i){return GD(this,e,i),this.check()}identity(){return L2(this),this.check()}setAxisAngle(e,i){return this.fromAxisRotation(e,i)}get ELEMENTS(){return 4}get x(){return this[0]}set x(e){this[0]=kn(e)}get y(){return this[1]}set y(e){this[1]=kn(e)}get z(){return this[2]}set z(e){this[2]=kn(e)}get w(){return this[3]}set w(e){this[3]=kn(e)}len(){return q2(this)}lengthSquared(){return G2(this)}dot(e){return W2(this,e)}rotationTo(e,i){return X2(this,e,i),this.check()}add(e){return j2(this,this,e),this.check()}calculateW(){return z2(this,this),this.check()}conjugate(){return V2(this,this),this.check()}invert(){return U2(this,this),this.check()}lerp(e,i,s){return s===void 0?this.lerp(this,e,i):(H2(this,e,i,s),this.check())}multiplyRight(e){return rI(this,this,e),this.check()}multiplyLeft(e){return rI(this,e,this),this.check()}normalize(){const e=this.len(),i=e>0?1/e:0;return this[0]=this[0]*i,this[1]=this[1]*i,this[2]=this[2]*i,this[3]=this[3]*i,e===0&&(this[3]=1),this.check()}rotateX(e){return N2(this,this,e),this.check()}rotateY(e){return F2(this,this,e),this.check()}rotateZ(e){return B2(this,this,e),this.check()}scale(e){return $2(this,this,e),this.check()}slerp(e,i,s){let c,h,p;switch(arguments.length){case 1:({start:c=Z2,target:h,ratio:p}=e);break;case 2:c=this,h=e,p=i;break;default:c=e,h=i,p=s}return P0(this,c,h,p),this.check()}transformVector4(e,i=new wE){return C2(i,e,this),n_(i,4)}lengthSq(){return this.lengthSquared()}setFromAxisAngle(e,i){return this.setAxisAngle(e,i)}premultiply(e){return this.multiplyLeft(e)}multiply(e){return this.multiplyRight(e)}}const Y2=1e-15,K2=1e-20,sI=`#if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
vec3 color;
};
struct PointLight {
vec3 color;
vec3 position;
vec3 attenuation;
};
struct DirectionalLight {
vec3 color;
vec3 direction;
};
uniform AmbientLight lighting_uAmbientLight;
uniform PointLight lighting_uPointLight[MAX_LIGHTS];
uniform DirectionalLight lighting_uDirectionalLight[MAX_LIGHTS];
uniform int lighting_uPointLightCount;
uniform int lighting_uDirectionalLightCount;
uniform bool lighting_uEnabled;
float getPointLightAttenuation(PointLight pointLight, float distance) {
return pointLight.attenuation.x
+ pointLight.attenuation.y * distance
+ pointLight.attenuation.z * distance * distance;
}
#endif
`,J2={lightSources:{}};function Db(t={}){const{color:e=[0,0,0],intensity:i=1}=t;return e.map(s=>s*i/255)}function Q2({ambientLight:t,pointLights:e=[],directionalLights:i=[]}){const s={};return t?s["lighting_uAmbientLight.color"]=Db(t):s["lighting_uAmbientLight.color"]=[0,0,0],e.forEach((c,h)=>{s[`lighting_uPointLight[${h}].color`]=Db(c),s[`lighting_uPointLight[${h}].position`]=c.position,s[`lighting_uPointLight[${h}].attenuation`]=c.attenuation||[1,0,0]}),s.lighting_uPointLightCount=e.length,i.forEach((c,h)=>{s[`lighting_uDirectionalLight[${h}].color`]=Db(c),s[`lighting_uDirectionalLight[${h}].direction`]=c.direction}),s.lighting_uDirectionalLightCount=i.length,s}function YD(t=J2){var e,i;if("lightSources"in t){const{ambientLight:s,pointLights:c,directionalLights:h}=t.lightSources||{};return s||c&&c.length>0||h&&h.length>0?Object.assign({},Q2({ambientLight:s,pointLights:c,directionalLights:h}),{lighting_uEnabled:!0}):{lighting_uEnabled:!1}}if("lights"in t){const s={pointLights:[],directionalLights:[]};for(const c of t.lights||[])switch(c.type){case"ambient":s.ambientLight=c;break;case"directional":(e=s.directionalLights)==null||e.push(c);break;case"point":(i=s.pointLights)==null||i.push(c);break}return YD({lightSources:s})}return{}}const e$={name:"lights",vs:sI,fs:sI,getUniforms:YD,defines:{MAX_LIGHTS:3}},t$=`uniform float lighting_uAmbient;
uniform float lighting_uDiffuse;
uniform float lighting_uShininess;
uniform vec3  lighting_uSpecularColor;
vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
vec3 halfway_direction = normalize(light_direction + view_direction);
float lambertian = dot(light_direction, normal_worldspace);
float specular = 0.0;
if (lambertian > 0.0) {
float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
specular = pow(specular_angle, lighting_uShininess);
}
lambertian = max(lambertian, 0.0);
return (lambertian * lighting_uDiffuse * surfaceColor + specular * lighting_uSpecularColor) * color;
}
vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
vec3 lightColor = surfaceColor;
if (lighting_uEnabled) {
vec3 view_direction = normalize(cameraPosition - position_worldspace);
lightColor = lighting_uAmbient * surfaceColor * lighting_uAmbientLight.color;
for (int i = 0; i < MAX_LIGHTS; i++) {
if (i >= lighting_uPointLightCount) {
break;
}
PointLight pointLight = lighting_uPointLight[i];
vec3 light_position_worldspace = pointLight.position;
vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
}
for (int i = 0; i < MAX_LIGHTS; i++) {
if (i >= lighting_uDirectionalLightCount) {
break;
}
DirectionalLight directionalLight = lighting_uDirectionalLight[i];
lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
}
}
return lightColor;
}
vec3 lighting_getSpecularLightColor(vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
vec3 lightColor = vec3(0, 0, 0);
vec3 surfaceColor = vec3(0, 0, 0);
if (lighting_uEnabled) {
vec3 view_direction = normalize(cameraPosition - position_worldspace);
for (int i = 0; i < MAX_LIGHTS; i++) {
if (i >= lighting_uPointLightCount) {
break;
}
PointLight pointLight = lighting_uPointLight[i];
vec3 light_position_worldspace = pointLight.position;
vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
}
for (int i = 0; i < MAX_LIGHTS; i++) {
if (i >= lighting_uDirectionalLightCount) {
break;
}
DirectionalLight directionalLight = lighting_uDirectionalLight[i];
lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
}
}
return lightColor;
}
`,i$={};function r$(t){const{ambient:e=.35,diffuse:i=.6,shininess:s=32,specularColor:c=[30,30,30]}=t;return{lighting_uAmbient:e,lighting_uDiffuse:i,lighting_uShininess:s,lighting_uSpecularColor:c.map(h=>h/255)}}function n$(t=i$){if(!("material"in t))return{};const{material:e}=t;return e?r$(e):{lighting_uEnabled:!1}}const s$={name:"gouraud-lighting",dependencies:[e$],vs:t$,defines:{LIGHTING_VERTEX:1},getUniforms:n$},KD="#define SMOOTH_EDGE_RADIUS 0.5",o$=`
${KD}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,a$=`
${KD}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,l$={name:"geometry",vs:o$,fs:a$},qr={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(qr,"IDENTITY",{get:()=>(jr.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const ya={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},Eh={common:0,meters:1,pixels:2},lT={click:{handler:"onClick"},panstart:{handler:"onDragStart"},panmove:{handler:"onDrag"},panend:{handler:"onDragEnd"}},c$=Object.keys(qr).map(t=>`const int COORDINATE_SYSTEM_${t} = ${qr[t]};`).join(""),u$=Object.keys(ya).map(t=>`const int PROJECTION_MODE_${t} = ${ya[t]};`).join(""),h$=Object.keys(Eh).map(t=>`const int UNIT_${t.toUpperCase()} = ${Eh[t]};`).join(""),d$=`${c$}
${u$}
${h$}
uniform int project_uCoordinateSystem;
uniform int project_uProjectionMode;
uniform float project_uScale;
uniform bool project_uWrapLongitude;
uniform vec3 project_uCommonUnitsPerMeter;
uniform vec3 project_uCommonUnitsPerWorldUnit;
uniform vec3 project_uCommonUnitsPerWorldUnit2;
uniform vec4 project_uCenter;
uniform mat4 project_uModelMatrix;
uniform mat4 project_uViewProjectionMatrix;
uniform vec2 project_uViewportSize;
uniform float project_uDevicePixelRatio;
uniform float project_uFocalDistance;
uniform vec3 project_uCameraPosition;
uniform vec3 project_uCoordinateOrigin;
uniform vec3 project_uCommonOrigin;
uniform bool project_uPseudoMeters;
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size_at_latitude(float lat) {
float y = clamp(lat, -89.9, 89.9);
return 1.0 / cos(radians(y));
}
float project_size() {
if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR &&
project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
project_uPseudoMeters == false) {
if (geometry.position.w == 0.0) {
return project_size_at_latitude(geometry.worldPosition.y);
}
float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
float y2 = y * y;
float y4 = y2 * y2;
float y6 = y4 * y2;
return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
}
return 1.0;
}
float project_size_at_latitude(float meters, float lat) {
return meters * project_uCommonUnitsPerMeter.z * project_size_at_latitude(lat);
}
float project_size(float meters) {
return meters * project_uCommonUnitsPerMeter.z * project_size();
}
vec2 project_size(vec2 meters) {
return meters * project_uCommonUnitsPerMeter.xy * project_size();
}
vec3 project_size(vec3 meters) {
return meters * project_uCommonUnitsPerMeter * project_size();
}
vec4 project_size(vec4 meters) {
return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
vec3 uz = normalize(up);
vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
vec3 uy = cross(uz, ux);
return mat3(ux, uy, uz);
}
bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
transform = project_get_orientation_matrix(commonPosition);
return true;
}
return false;
}
vec3 project_normal(vec3 vector) {
vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);
vec3 n = normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);
mat3 rotation;
if (project_needs_rotation(geometry.position.xyz, rotation)) {
n = rotation * n;
}
return n;
}
vec4 project_offset_(vec4 offset) {
float dy = offset.y;
vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;
return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
float x = lnglat.x;
if (project_uWrapLongitude) {
x = mod(x + 180., 360.0) - 180.;
}
float y = clamp(lnglat.y, -89.9, 89.9);
return vec2(
radians(x) + PI,
PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
) * WORLD_SCALE;
}
vec3 project_globe_(vec3 lnglatz) {
float lambda = radians(lnglatz.x);
float phi = radians(lnglatz.y);
float cosPhi = cos(phi);
float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
return vec3(
sin(lambda) * cosPhi,
-cos(lambda) * cosPhi,
sin(phi)
) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
vec4 position_world = project_uModelMatrix * position;
if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {
if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_mercator_(position_world.xy),
project_size_at_latitude(position_world.z, position_world.y),
position_world.w
);
}
if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
position_world.xyz += project_uCoordinateOrigin;
}
}
if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_globe_(position_world.xyz),
position_world.w
);
}
}
if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {
return vec4(
project_mercator_(position_world.xy) - project_uCommonOrigin.xy,
project_size(position_world.z),
position_world.w
);
}
}
}
if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||
(project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
(project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
position_world.xyz -= project_uCoordinateOrigin;
}
return project_offset_(position_world) + project_offset_(project_uModelMatrix * vec4(position64Low, 0.0));
}
vec4 project_position(vec4 position) {
return project_position(position, ZERO_64_LOW);
}
vec3 project_position(vec3 position, vec3 position64Low) {
vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
return projected_position.xyz;
}
vec3 project_position(vec3 position) {
vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
return projected_position.xyz;
}
vec2 project_position(vec2 position) {
vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
return projected_position.xy;
}
vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;
return offset * project_uFocalDistance;
}
float project_size_to_pixel(float meters) {
return project_size(meters) * project_uScale;
}
float project_size_to_pixel(float size, int unit) {
if (unit == UNIT_METERS) return project_size_to_pixel(size);
if (unit == UNIT_COMMON) return size * project_uScale;
return size;
}
float project_pixel_size(float pixels) {
return pixels / project_uScale;
}
vec2 project_pixel_size(vec2 pixels) {
return pixels / project_uScale;
}
`;function f$(t,e){if(t===e)return!0;if(Array.isArray(t)){const i=t.length;if(!e||e.length!==i)return!1;for(let s=0;s<i;s++)if(t[s]!==e[s])return!1;return!0}return!1}function V_(t){let e={},i;return s=>{for(const c in s)if(!f$(s[c],e[c])){i=t(s),e=s;break}return i}}const oI=[0,0,0,0],p$=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],JD=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],m$=[0,0,0],QD=[0,0,0],_$=V_(v$);function eL(t,e,i=QD){i.length<3&&(i=[i[0],i[1],0]);let s=i,c,h=!0;switch(e===qr.LNGLAT_OFFSETS||e===qr.METER_OFFSETS?c=i:c=t.isGeospatial?[Math.fround(t.longitude),Math.fround(t.latitude),0]:null,t.projectionMode){case ya.WEB_MERCATOR:(e===qr.LNGLAT||e===qr.CARTESIAN)&&(c=[0,0,0],h=!1);break;case ya.WEB_MERCATOR_AUTO_OFFSET:e===qr.LNGLAT?s=c:e===qr.CARTESIAN&&(s=[Math.fround(t.center[0]),Math.fround(t.center[1]),0],c=t.unprojectPosition(s),s[0]-=i[0],s[1]-=i[1],s[2]-=i[2]);break;case ya.IDENTITY:s=t.position.map(Math.fround),s[2]=s[2]||0;break;case ya.GLOBE:h=!1,c=null;break;default:h=!1}return{geospatialOrigin:c,shaderCoordinateOrigin:s,offsetMode:h}}function g$(t,e,i){const{viewMatrixUncentered:s,projectionMatrix:c}=t;let{viewMatrix:h,viewProjectionMatrix:p}=t,v=oI,l=oI,A=t.cameraPosition;const{geospatialOrigin:P,shaderCoordinateOrigin:O,offsetMode:L}=eL(t,e,i);return L&&(l=t.projectPosition(P||O),A=[A[0]-l[0],A[1]-l[1],A[2]-l[2]],l[3]=1,v=Pf([],l,p),h=s||h,p=fh([],c,h),p=fh([],p,p$)),{viewMatrix:h,viewProjectionMatrix:p,projectionCenter:v,originCommon:l,cameraPosCommon:A,shaderCoordinateOrigin:O,geospatialOrigin:P}}function y$({viewport:t,devicePixelRatio:e=1,modelMatrix:i=null,coordinateSystem:s=qr.DEFAULT,coordinateOrigin:c=QD,autoWrapLongitude:h=!1}){s===qr.DEFAULT&&(s=t.isGeospatial?qr.LNGLAT:qr.CARTESIAN);const p=_$({viewport:t,devicePixelRatio:e,coordinateSystem:s,coordinateOrigin:c});return p.project_uWrapLongitude=h,p.project_uModelMatrix=i||JD,p}function v$({viewport:t,devicePixelRatio:e,coordinateSystem:i,coordinateOrigin:s}){const{projectionCenter:c,viewProjectionMatrix:h,originCommon:p,cameraPosCommon:v,shaderCoordinateOrigin:l,geospatialOrigin:A}=g$(t,i,s),P=t.getDistanceScales(),O=[t.width*e,t.height*e],L=Pf([],[0,0,-t.focalDistance,1],t.projectionMatrix)[3]||1,U={project_uCoordinateSystem:i,project_uProjectionMode:t.projectionMode,project_uCoordinateOrigin:l,project_uCommonOrigin:p.slice(0,3),project_uCenter:c,project_uPseudoMeters:!!t._pseudoMeters,project_uViewportSize:O,project_uDevicePixelRatio:e,project_uFocalDistance:L,project_uCommonUnitsPerMeter:P.unitsPerMeter,project_uCommonUnitsPerWorldUnit:P.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:m$,project_uScale:t.scale,project_uWrapLongitude:!1,project_uViewProjectionMatrix:h,project_uModelMatrix:JD,project_uCameraPosition:v};if(A){const H=t.getDistanceScales(A);switch(i){case qr.METER_OFFSETS:U.project_uCommonUnitsPerWorldUnit=H.unitsPerMeter,U.project_uCommonUnitsPerWorldUnit2=H.unitsPerMeter2;break;case qr.LNGLAT:case qr.LNGLAT_OFFSETS:t._pseudoMeters||(U.project_uCommonUnitsPerMeter=H.unitsPerMeter),U.project_uCommonUnitsPerWorldUnit=H.unitsPerDegree,U.project_uCommonUnitsPerWorldUnit2=H.unitsPerDegree2;break;case qr.CARTESIAN:U.project_uCommonUnitsPerWorldUnit=[1,1,H.unitsPerMeter[2]],U.project_uCommonUnitsPerWorldUnit2=[0,0,H.unitsPerMeter2[2]];break}}return U}const x$={};function b$(t=x$){return"viewport"in t?y$(t):{}}const SE={name:"project",dependencies:[S9,l$],vs:d$,getUniforms:b$},w$=`
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,If={name:"project32",dependencies:[SE],vs:w$};function T$(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function of(t,e){const i=Pf([],e,t);return EE(i,i,1/i[3]),i}function aI(t,e){const i=t%e;return i<0?e+i:i}function cT(t,e,i){return t<e?e:t>i?i:t}function E$(t){return Math.log(t)*Math.LOG2E}const AE=Math.log2||E$;function Nl(t,e){if(!t)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}const va=Math.PI,tL=va/4,Zo=va/180,uT=180/va,xf=512,cv=4003e4,n0=85.051129,S$=1.5;function A$(t){return AE(t)}function $c(t){const[e,i]=t;Nl(Number.isFinite(e)),Nl(Number.isFinite(i)&&i>=-90&&i<=90,"invalid latitude");const s=e*Zo,c=i*Zo,h=xf*(s+va)/(2*va),p=xf*(va+Math.log(Math.tan(tL+c*.5)))/(2*va);return[h,p]}function bf(t){const[e,i]=t,s=e/xf*(2*va)-va,c=2*(Math.atan(Math.exp(i/xf*(2*va)-va))-tL);return[s*uT,c*uT]}function M$(t){const{latitude:e}=t;Nl(Number.isFinite(e));const i=Math.cos(e*Zo);return A$(cv*i)-9}function Lb(t){const e=Math.cos(t*Zo);return xf/cv/e}function hT(t){const{latitude:e,longitude:i,highPrecision:s=!1}=t;Nl(Number.isFinite(e)&&Number.isFinite(i));const c=xf,h=Math.cos(e*Zo),p=c/360,v=p/h,l=c/cv/h,A={unitsPerMeter:[l,l,l],metersPerUnit:[1/l,1/l,1/l],unitsPerDegree:[p,v,l],degreesPerUnit:[1/p,1/v,1/l]};if(s){const P=Zo*Math.tan(e*Zo)/h,O=p*P/2,L=c/cv*P,U=L/v*l;A.unitsPerDegree2=[0,O,L],A.unitsPerMeter2=[U,0,U]}return A}function iL(t,e){const[i,s,c]=t,[h,p,v]=e,{unitsPerMeter:l,unitsPerMeter2:A}=hT({longitude:i,latitude:s,highPrecision:!0}),P=$c(t);P[0]+=h*(l[0]+A[0]*p),P[1]+=p*(l[1]+A[1]*p);const O=bf(P),L=(c||0)+(v||0);return Number.isFinite(c)||Number.isFinite(v)?[O[0],O[1],L]:O}function C$(t){const{height:e,pitch:i,bearing:s,altitude:c,scale:h,center:p}=t,v=T$();lv(v,v,[0,0,-c]),HD(v,v,-i*Zo),qD(v,v,s*Zo);const l=h/e;return TE(v,v,[l,l,l]),p&&lv(v,v,H9([],p)),v}function P$(t){const{width:e,height:i,altitude:s,pitch:c=0,offset:h,center:p,scale:v,nearZMultiplier:l=1,farZMultiplier:A=1}=t;let{fovy:P=uv(S$)}=t;s!==void 0&&(P=uv(s));const O=P*Zo,L=c*Zo,U=rL(P);let H=U;p&&(H+=p[2]*v/Math.cos(L)/i);const Y=O*(.5+(h?h[1]:0)/i),J=Math.sin(Y)*H/Math.sin(cT(Math.PI/2-L-Y,.01,Math.PI-.01)),oe=Math.sin(L)*J+H,me=H*10,pe=Math.min(oe*A,me);return{fov:O,aspect:e/i,focalDistance:U,near:l,far:pe}}function uv(t){return 2*Math.atan(.5/t)*uT}function rL(t){return .5/Math.tan(.5*t*Zo)}function nL(t,e){const[i,s,c=0]=t;return Nl(Number.isFinite(i)&&Number.isFinite(s)&&Number.isFinite(c)),of(e,[i,s,c,1])}function c1(t,e,i=0){const[s,c,h]=t;if(Nl(Number.isFinite(s)&&Number.isFinite(c),"invalid pixel coordinate"),Number.isFinite(h))return of(e,[s,c,h,1]);const p=of(e,[s,c,0,1]),v=of(e,[s,c,1,1]),l=p[2],A=v[2],P=l===A?0:((i||0)-l)/(A-l);return LD([],p,v,P)}function I$(t){const{width:e,height:i,bounds:s,minExtent:c=0,maxZoom:h=24,offset:p=[0,0]}=t,[[v,l],[A,P]]=s,O=R$(t.padding),L=$c([v,cT(P,-n0,n0)]),U=$c([A,cT(l,-n0,n0)]),H=[Math.max(Math.abs(U[0]-L[0]),c),Math.max(Math.abs(U[1]-L[1]),c)],Y=[e-O.left-O.right-Math.abs(p[0])*2,i-O.top-O.bottom-Math.abs(p[1])*2];Nl(Y[0]>0&&Y[1]>0);const J=Y[0]/H[0],oe=Y[1]/H[1],me=(O.right-O.left)/2/J,pe=(O.top-O.bottom)/2/oe,be=[(U[0]+L[0])/2+me,(U[1]+L[1])/2+pe],Oe=bf(be),je=Math.min(h,AE(Math.abs(Math.min(J,oe))));return Nl(Number.isFinite(je)),{longitude:Oe[0],latitude:Oe[1],zoom:je}}function R$(t=0){return typeof t=="number"?{top:t,bottom:t,left:t,right:t}:(Nl(Number.isFinite(t.top)&&Number.isFinite(t.bottom)&&Number.isFinite(t.left)&&Number.isFinite(t.right)),t)}const lI=Math.PI/180;function O$(t,e=0){const{width:i,height:s,unproject:c}=t,h={targetZ:e},p=c([0,s],h),v=c([i,s],h);let l,A;const P=t.fovy?.5*t.fovy*lI:Math.atan(.5/t.altitude),O=(90-t.pitch)*lI;return P>O-.01?(l=cI(t,0,e),A=cI(t,i,e)):(l=c([0,0],h),A=c([i,0],h)),[p,v,A,l]}function cI(t,e,i){const{pixelUnprojectionMatrix:s}=t,c=of(s,[e,0,1,1]),h=of(s,[e,t.height,1,1]),v=(i*t.distanceScales.unitsPerMeter[2]-c[2])/(h[2]-c[2]),l=LD([],c,h,v),A=bf(l);return A.push(i),A}const uI=512;function k$(t){const{width:e,height:i,pitch:s=0}=t;let{longitude:c,latitude:h,zoom:p,bearing:v=0}=t;(c<-180||c>180)&&(c=aI(c+180,360)-180),(v<-180||v>180)&&(v=aI(v+180,360)-180);const l=AE(i/uI);if(p<=l)p=l,h=0;else{const A=i/2/Math.pow(2,p),P=bf([0,A])[1];if(h<P)h=P;else{const O=bf([0,uI-A])[1];h>O&&(h=O)}}return{width:e,height:i,longitude:c,latitude:h,zoom:p,pitch:s,bearing:v}}const D$=`
const int max_lights = 2;
uniform mat4 shadow_uViewProjectionMatrices[max_lights];
uniform vec4 shadow_uProjectCenters[max_lights];
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform int shadow_uLightId;
uniform float shadow_uLightCount;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  if (shadow_uDrawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[shadow_uLightId], shadow_uProjectCenters[shadow_uLightId]);
  }
  if (shadow_uUseShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow_uLightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[i], shadow_uProjectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,L$=`
const int max_lights = 2;
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;
uniform vec4 shadow_uColor;
uniform float shadow_uLightCount;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow_uDrawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow_uUseShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow_uLightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow_uColor.a / shadow_uLightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow_uColor.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,N$=V_(V$),F$=V_(j$),B$=[0,0,0,1],z$=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function U$(t,e){const[i,s,c]=t,h=c1([i,s,c],e);return Number.isFinite(c)?h:[h[0],h[1],0]}function V$({viewport:t,center:e}){return new Vs(t.viewProjectionMatrix).invert().transform(e)}function j$({viewport:t,shadowMatrices:e}){const i=[],s=t.pixelUnprojectionMatrix,c=t.isGeospatial?void 0:1,h=[[0,0,c],[t.width,0,c],[0,t.height,c],[t.width,t.height,c],[0,0,-1],[t.width,0,-1],[0,t.height,-1],[t.width,t.height,-1]].map(p=>U$(p,s));for(const p of e){const v=p.clone().translate(new yi(t.center).negate()),l=h.map(P=>v.transform(P)),A=new Vs().ortho({left:Math.min(...l.map(P=>P[0])),right:Math.max(...l.map(P=>P[0])),bottom:Math.min(...l.map(P=>P[1])),top:Math.max(...l.map(P=>P[1])),near:Math.min(...l.map(P=>-P[2])),far:Math.max(...l.map(P=>-P[2]))});i.push(A.multiplyRight(p))}return i}function $$(t,e){const{shadowEnabled:i=!0}=t;if(!i||!t.shadowMatrices||!t.shadowMatrices.length)return{shadow_uDrawShadowMap:!1,shadow_uUseShadowMap:!1,shadow_uShadowMap0:t.dummyShadowMap,shadow_uShadowMap1:t.dummyShadowMap};const s={shadow_uDrawShadowMap:!!t.drawToShadowMap,shadow_uUseShadowMap:t.shadowMaps?t.shadowMaps.length>0:!1,shadow_uColor:t.shadowColor||B$,shadow_uLightId:t.shadowLightId||0,shadow_uLightCount:t.shadowMatrices.length},c=N$({viewport:t.viewport,center:e.project_uCenter}),h=[],p=F$({shadowMatrices:t.shadowMatrices,viewport:t.viewport}).slice();for(let v=0;v<t.shadowMatrices.length;v++){const l=p[v],A=l.clone().translate(new yi(t.viewport.center).negate());e.project_uCoordinateSystem===qr.LNGLAT&&e.project_uProjectionMode===ya.WEB_MERCATOR?(p[v]=A,h[v]=c):(p[v]=l.clone().multiplyRight(z$),h[v]=A.transform(c))}for(let v=0;v<p.length;v++)s[`shadow_uViewProjectionMatrices[${v}]`]=p[v],s[`shadow_uProjectCenters[${v}]`]=h[v];for(let v=0;v<2;v++)s[`shadow_uShadowMap${v}`]=t.shadowMaps&&t.shadowMaps[v]||t.dummyShadowMap;return s}const hI={name:"shadow",dependencies:[SE],vs:D$,fs:L$,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:(t={},e={})=>"viewport"in t&&(t.drawToShadowMap||t.shadowMaps&&t.shadowMaps.length>0)?$$(t,e):{}},Rf={...KP,defaultUniforms:{...KP.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},W$=[SE],H$=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"];function q$(){const t=ev.getDefaultShaderAssembler();for(const e of W$)t.addDefaultModule(e);for(const e of H$)t.addShaderHook(e);return t}const G$=[255,255,255],X$=1;let Z$=0;class Y${constructor(e={}){this.type="ambient";const{color:i=G$}=e,{intensity:s=X$}=e;this.id=e.id||`ambient-${Z$++}`,this.color=i,this.intensity=s}}const K$=[255,255,255],J$=1,Q$=[0,0,-1];let eW=0;class dI{constructor(e={}){this.type="directional";const{color:i=K$}=e,{intensity:s=J$}=e,{direction:c=Q$}=e,{_shadow:h=!1}=e;this.id=e.id||`directional-${eW++}`,this.color=i,this.intensity=s,this.type="directional",this.direction=new yi(c).normalize().toArray(),this.shadow=h}getProjectedLight(e){return this}}class tW{constructor(e,i={id:"pass"}){const{id:s}=i;this.id=s,this.device=e,this.props={...i}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class ME extends tW{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){const[i,s]=this.device.canvasContext.getDrawingBufferSize(),c=e.clearCanvas??!0,h=e.clearColor??(c?[0,0,0,0]:!1),p=c?1:!1,v=e.colorMask??15,l={viewport:[0,0,i,s]};e.colorMask&&(l.colorMask=v),e.scissorRect&&(l.scissorRect=e.scissorRect);const A=this.device.beginRenderPass({framebuffer:e.target,parameters:l,clearColor:h,clearDepth:p});try{return this._drawLayers(A,e)}finally{A.end()}}_drawLayers(e,i){const{target:s,moduleParameters:c,viewports:h,views:p,onViewportActive:v,clearStack:l=!0}=i;i.pass=i.pass||"unknown",l&&(this._lastRenderIndex=-1);const A=[];for(const P of h){const O=p&&p[P.id];v==null||v(P);const L=this._getDrawLayerParams(P,i),U=P.subViewports||[P];for(const H of U){const Y=this._drawLayersInViewport(e,{target:s,moduleParameters:c,viewport:H,view:O,pass:i.pass,layers:i.layers},L);A.push(Y)}}return A}_getDrawLayerParams(e,{layers:i,pass:s,isPicking:c=!1,layerFilter:h,cullRect:p,effects:v,moduleParameters:l},A=!1){var H;const P=[],O=sL(this._lastRenderIndex+1),L={layer:i[0],viewport:e,isPicking:c,renderPass:s,cullRect:p},U={};for(let Y=0;Y<i.length;Y++){const J=i[Y],oe=this._shouldDrawLayer(J,L,h,U),me={shouldDrawLayer:oe};oe&&!A&&(me.layerRenderIndex=O(J,oe),me.moduleParameters=this._getModuleParameters(J,v,s,l),me.layerParameters={...(H=J.context.deck)==null?void 0:H.props.parameters,...this.getLayerParameters(J,Y,e)}),P[Y]=me}return P}_drawLayersInViewport(e,{layers:i,moduleParameters:s,pass:c,target:h,viewport:p,view:v},l){const A=iW(this.device,{moduleParameters:s,target:h,viewport:p});if(v&&v.props.clear){const O=v.props.clear===!0?{color:!0,depth:!0}:v.props.clear;this.device.withParametersWebGL({scissorTest:!0,scissor:A},()=>this.device.clearWebGL(O))}const P={totalCount:i.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:A});for(let O=0;O<i.length;O++){const L=i[O],{shouldDrawLayer:U,layerRenderIndex:H,moduleParameters:Y,layerParameters:J}=l[O];if(U&&L.props.pickable&&P.pickableCount++,L.isComposite)P.compositeCount++;else if(U){P.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,H),Y.viewport=p,L.context.renderPass=e;try{L._drawLayer({renderPass:e,moduleParameters:Y,uniforms:{layerIndex:H},parameters:J})}catch(oe){L.raiseError(oe,`drawing ${L} to ${c}`)}}}return P}shouldDrawLayer(e){return!0}getModuleParameters(e,i){return null}getLayerParameters(e,i,s){return e.props.parameters}_shouldDrawLayer(e,i,s,c){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;i.layer=e;let p=e.parent;for(;p;){if(!p.props.visible||!p.filterSubLayer(i))return!1;i.layer=p,p=p.parent}if(s){const v=i.layer.id;if(v in c||(c[v]=s(i)),!c[v])return!1}return e.activateViewport(i.viewport),!0}_getModuleParameters(e,i,s,c){var v,l;const h=this.device.canvasContext.cssToDeviceRatio(),p=Object.assign(Object.create(((v=e.internalState)==null?void 0:v.propsInTransition)||e.props),{autoWrapLongitude:e.wrapLongitude,viewport:e.context.viewport,mousePosition:e.context.mousePosition,picking:{isActive:0},devicePixelRatio:h});if(i)for(const A of i)Object.assign(p,(l=A.getModuleParameters)==null?void 0:l.call(A,e));return Object.assign(p,this.getModuleParameters(e,i),c)}}function sL(t=0,e={}){const i={},s=(c,h)=>{const p=c.props._offset,v=c.id,l=c.parent&&c.parent.id;let A;if(l&&!(l in e)&&s(c.parent,!1),l in i){const P=i[l]=i[l]||sL(e[l],e);A=P(c,h),i[v]=P}else Number.isFinite(p)?(A=p+(e[l]||0),i[v]=null):A=t;return h&&A>=t&&(t=A+1),e[v]=A,A};return s}function iW(t,{moduleParameters:e,target:i,viewport:s}){const c=e&&e.devicePixelRatio||t.canvasContext.cssToDeviceRatio(),[,h]=t.canvasContext.getDrawingBufferSize(),p=i?i.height:h,v=s;return[v.x*c,p-(v.y+v.height)*c,v.width*c,v.height*c]}class rW extends ME{constructor(e,i){super(e,i),this.shadowMap=e.createTexture({width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"}}),this.depthBuffer=e.createTexture({format:"depth16unorm",width:1,height:1,mipmaps:!1,dataFormat:6402,type:5125}),this.fbo=e.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[this.shadowMap],depthStencilAttachment:this.depthBuffer})}render(e){const i=this.fbo,s=this.device.canvasContext.cssToDeviceRatio(),c=e.viewports[0],h=c.width*s,p=c.height*s,v=[1,1,1,1];(h!==i.width||p!==i.height)&&i.resize({width:h,height:p}),super.render({...e,clearColor:v,target:i,pass:"shadow"})}getLayerParameters(e,i,s){return{...e.props.parameters,blend:!1,depthRange:[0,1],depthTest:!0}}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getModuleParameters(){return{drawToShadowMap:!0}}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null),this.shadowMap&&(this.shadowMap.destroy(),this.shadowMap=null),this.depthBuffer&&(this.depthBuffer.destroy(),this.depthBuffer=null)}}const nW={color:[255,255,255],intensity:1},fI=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],sW=[0,0,0,200/255];class oL{constructor(e={}){this.id="lighting-effect",this.shadowColor=sW,this.shadow=!1,this.ambientLight=null,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.shadowMaps=[],this.dummyShadowMap=null,this.setProps(e)}setup(e){this.context=e;const{device:i,deck:s}=e;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(i),s._addDefaultShaderModule(hI),this.dummyShadowMap=i.createTexture({width:1,height:1}))}setProps(e){this.ambientLight=null,this.directionalLights=[],this.pointLights=[];for(const i in e){const s=e[i];switch(s.type){case"ambient":this.ambientLight=s;break;case"directional":this.directionalLights.push(s);break;case"point":this.pointLights.push(s);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(i=>i.shadow),this.context&&this.setup(this.context),this.props=e}preRender({layers:e,layerFilter:i,viewports:s,onViewportActive:c,views:h}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let p=0;p<this.shadowPasses.length;p++)this.shadowPasses[p].render({layers:e,layerFilter:i,viewports:s,onViewportActive:c,views:h,moduleParameters:{shadowLightId:p,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}})}}getModuleParameters(e){const i=this.shadow?{shadowMaps:this.shadowMaps,dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{};return i.lightSources={ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(s=>s.getProjectedLight({layer:e})),pointLights:this.pointLights.map(s=>s.getProjectedLight({layer:e}))},i}cleanup(e){for(const i of this.shadowPasses)i.delete();this.shadowPasses.length=0,this.shadowMaps.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,e.deck._removeDefaultShaderModule(hI))}_calculateMatrices(){const e=[];for(const i of this.directionalLights){const s=new Vs().lookAt({eye:new yi(i.direction).negate()});e.push(s)}return e}_createShadowPasses(e){for(let i=0;i<this.directionalLights.length;i++){const s=new rW(e);this.shadowPasses[i]=s,this.shadowMaps[i]=s.shadowMap}}_applyDefaultLights(){const{ambientLight:e,pointLights:i,directionalLights:s}=this;!e&&i.length===0&&s.length===0&&(this.ambientLight=new Y$(nW),this.directionalLights.push(new dI(fI[0]),new dI(fI[1])))}}class oW{constructor(e={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,i,{size:s=1,type:c,padding:h=0,copy:p=!1,initialize:v=!1,maxCount:l}){const A=c||e&&e.constructor||Float32Array,P=i*s+h;if(ArrayBuffer.isView(e)){if(P<=e.length)return e;if(P*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new A(e.buffer,0,P)}let O=1/0;l&&(O=l*s+h);const L=this._allocate(A,P,v,O);return e&&p?L.set(e):v||L.fill(0,0,4),this._release(e),L}release(e){this._release(e)}_allocate(e,i,s,c){let h=Math.max(Math.ceil(i*this.opts.overAlloc),1);h>c&&(h=c);const p=this._pool,v=e.BYTES_PER_ELEMENT*h,l=p.findIndex(A=>A.byteLength>=v);if(l>=0){const A=new e(p.splice(l,1)[0],0,h);return s&&A.fill(0),A}return new e(h)}_release(e){if(!ArrayBuffer.isView(e))return;const i=this._pool,{buffer:s}=e,{byteLength:c}=s,h=i.findIndex(p=>p.byteLength>=c);h<0?i.push(s):(h>0||i.length<this.opts.poolSize)&&i.splice(h,0,s),i.length>this.opts.poolSize&&i.shift()}}const wf=new oW;function Zm(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function aW(t,e){const i=t%e;return i<0?e+i:i}function lW(t){return[t[12],t[13],t[14]]}function cW(t){return{left:Nd(t[3]+t[0],t[7]+t[4],t[11]+t[8],t[15]+t[12]),right:Nd(t[3]-t[0],t[7]-t[4],t[11]-t[8],t[15]-t[12]),bottom:Nd(t[3]+t[1],t[7]+t[5],t[11]+t[9],t[15]+t[13]),top:Nd(t[3]-t[1],t[7]-t[5],t[11]-t[9],t[15]-t[13]),near:Nd(t[3]+t[2],t[7]+t[6],t[11]+t[10],t[15]+t[14]),far:Nd(t[3]-t[2],t[7]-t[6],t[11]-t[10],t[15]-t[14])}}const pI=new yi;function Nd(t,e,i,s){pI.set(t,e,i);const c=pI.len();return{distance:s/c,normal:new yi(-t/c,-e/c,-i/c)}}function uW(t){return t-Math.fround(t)}let km;function Nb(t,e){const{size:i=1,startIndex:s=0}=e,c=e.endIndex!==void 0?e.endIndex:t.length,h=(c-s)/i;km=wf.allocate(km,h,{type:Float32Array,size:i*2});let p=s,v=0;for(;p<c;){for(let l=0;l<i;l++){const A=t[p++];km[v+l]=A,km[v+l+i]=uW(A)}v+=i*2}return km.subarray(0,h*i*2)}function hW(t){let e=null,i=!1;for(const s of t)s&&(e?(i||(e=[[e[0][0],e[0][1]],[e[1][0],e[1][1]]],i=!0),e[0][0]=Math.min(e[0][0],s[0][0]),e[0][1]=Math.min(e[0][1],s[0][1]),e[1][0]=Math.max(e[1][0],s[1][0]),e[1][1]=Math.max(e[1][1],s[1][1])):e=s);return e}const dW=Math.PI/180,fW=Zm(),mI=[0,0,0],pW={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function mW({width:t,height:e,orthographic:i,fovyRadians:s,focalDistance:c,padding:h,near:p,far:v}){const l=t/e,A=i?new Vs().orthographic({fovy:s,aspect:l,focalDistance:c,near:p,far:v}):new Vs().perspective({fovy:s,aspect:l,near:p,far:v});if(h){const{left:P=0,right:O=0,top:L=0,bottom:U=0}=h,H=Os((P+t-O)/2,0,t)-t/2,Y=Os((L+e-U)/2,0,e)-e/2;A[8]-=H*2/t,A[9]+=Y*2/e}return A}const Fv=class Fv{constructor(e={}){this._frustumPlanes={},this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||pW,this.focalDistance=e.focalDistance||1,this.position=e.position||mI,this.modelMatrix=e.modelMatrix||null;const{longitude:i,latitude:s}=e;this.isGeospatial=Number.isFinite(s)&&Number.isFinite(i),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?ya.WEB_MERCATOR:ya.WEB_MERCATOR_AUTO_OFFSET:ya.IDENTITY}equals(e){return e instanceof Fv?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&Ll(e.projectionMatrix,this.projectionMatrix)&&Ll(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:i=!0}={}){const s=this.projectPosition(e),c=nL(s,this.pixelProjectionMatrix),[h,p]=c,v=i?p:this.height-p;return e.length===2?[h,v]:[h,v,c[2]]}unproject(e,{topLeft:i=!0,targetZ:s}={}){const[c,h,p]=e,v=i?h:this.height-h,l=s&&s*this.distanceScales.unitsPerMeter[2],A=c1([c,v,p],this.pixelUnprojectionMatrix,l),[P,O,L]=this.unprojectPosition(A);return Number.isFinite(p)?[P,O,L]:Number.isFinite(s)?[P,O,s]:[P,O]}projectPosition(e){const[i,s]=this.projectFlat(e),c=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[i,s,c]}unprojectPosition(e){const[i,s]=this.unprojectFlat(e),c=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[i,s,c]}projectFlat(e){if(this.isGeospatial){const i=$c(e);return i[1]=Os(i[1],-318,830),i}return e}unprojectFlat(e){return this.isGeospatial?bf(e):e}getBounds(e={}){const i={targetZ:e.z||0},s=this.unproject([0,0],i),c=this.unproject([this.width,0],i),h=this.unproject([0,this.height],i),p=this.unproject([this.width,this.height],i);return[Math.min(s[0],c[0],h[0],p[0]),Math.min(s[1],c[1],h[1],p[1]),Math.max(s[0],c[0],h[0],p[0]),Math.max(s[1],c[1],h[1],p[1])]}getDistanceScales(e){return e?hT({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:i,width:s=1,height:c=1}){return e<this.x+this.width&&this.x<e+s&&i<this.y+this.height&&this.y<i+c}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,cW(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,i){return null}_initProps(e){const i=e.longitude,s=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=M$({latitude:s})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||hT({latitude:s,longitude:i}));const c=Math.pow(2,this.zoom);this.scale=c;const{position:h,modelMatrix:p}=e;let v=mI;if(h&&(v=p?new Vs(p).transformAsVector(h,[]):h),this.isGeospatial){const l=this.projectPosition([i,s,0]);this.center=new yi(v).scale(this.distanceScales.unitsPerMeter).add(l)}else this.center=this.projectPosition(v)}_initMatrices(e){const{viewMatrix:i=fW,projectionMatrix:s=null,orthographic:c=!1,fovyRadians:h,fovy:p=75,near:v=.1,far:l=1e3,padding:A=null,focalDistance:P=1}=e;this.viewMatrixUncentered=i,this.viewMatrix=new Vs().multiplyRight(i).translate(new yi(this.center).negate()),this.projectionMatrix=s||mW({width:this.width,height:this.height,orthographic:c,fovyRadians:h||p*dW,focalDistance:P,padding:A,near:v,far:l});const O=Zm();fh(O,O,this.projectionMatrix),fh(O,O,this.viewMatrix),this.viewProjectionMatrix=O,this.viewMatrixInverse=oT([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=lW(this.viewMatrixInverse);const L=Zm(),U=Zm();TE(L,L,[this.width/2,-this.height/2,1]),lv(L,L,[1,-1,0]),fh(U,L,this.viewProjectionMatrix),this.pixelProjectionMatrix=U,this.pixelUnprojectionMatrix=oT(Zm(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||jr.warn("Pixel project matrix not invertible")()}};Fv.displayName="Viewport";let Tf=Fv;const p_=class p_ extends Tf{constructor(e={}){const{latitude:i=0,longitude:s=0,zoom:c=0,pitch:h=0,bearing:p=0,nearZMultiplier:v=.1,farZMultiplier:l=1.01,nearZ:A,farZ:P,orthographic:O=!1,projectionMatrix:L,repeat:U=!1,worldOffset:H=0,position:Y,padding:J,legacyMeterSizes:oe=!1}=e;let{width:me,height:pe,altitude:be=1.5}=e;const Oe=Math.pow(2,c);me=me||1,pe=pe||1;let je,st=null;if(L)be=L[5]/2,je=uv(be);else{e.fovy?(je=e.fovy,be=rL(je)):je=uv(be);let xe;if(J){const{top:it=0,bottom:Be=0}=J;xe=[0,Os((it+pe-Be)/2,0,pe)-pe/2]}st=P$({width:me,height:pe,scale:Oe,center:Y&&[0,0,Y[2]*Lb(i)],offset:xe,pitch:h,fovy:je,nearZMultiplier:v,farZMultiplier:l}),Number.isFinite(A)&&(st.near=A),Number.isFinite(P)&&(st.far=P)}let ut=C$({height:pe,pitch:h,bearing:p,scale:Oe,altitude:be});H&&(ut=new Vs().translate([512*H,0,0]).multiplyLeft(ut)),super({...e,width:me,height:pe,viewMatrix:ut,longitude:s,latitude:i,zoom:c,...st,fovy:je,focalDistance:be}),this.latitude=i,this.longitude=s,this.zoom=c,this.pitch=h,this.bearing=p,this.altitude=be,this.fovy=je,this.orthographic=O,this._subViewports=U?[]:null,this._pseudoMeters=oe,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const e=this.getBounds(),i=Math.floor((e[0]+180)/360),s=Math.ceil((e[2]-180)/360);for(let c=i;c<=s;c++){const h=c?new p_({...this,worldOffset:c}):this;this._subViewports.push(h)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);const[i,s]=this.projectFlat(e),c=(e[2]||0)*Lb(e[1]);return[i,s,c]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);const[i,s]=this.unprojectFlat(e),c=(e[2]||0)/Lb(s);return[i,s,c]}addMetersToLngLat(e,i){return iL(e,i)}panByPosition(e,i){const s=c1(i,this.pixelUnprojectionMatrix),c=this.projectFlat(e),h=av([],c,DD([],s)),p=av([],this.center,h),[v,l]=this.unprojectFlat(p);return{longitude:v,latitude:l}}getBounds(e={}){const i=O$(this,e.z||0);return[Math.min(i[0][0],i[1][0],i[2][0],i[3][0]),Math.min(i[0][1],i[1][1],i[2][1],i[3][1]),Math.max(i[0][0],i[1][0],i[2][0],i[3][0]),Math.max(i[0][1],i[1][1],i[2][1],i[3][1])]}fitBounds(e,i={}){const{width:s,height:c}=this,{longitude:h,latitude:p,zoom:v}=I$({width:s,height:c,bounds:e,...i});return new p_({width:s,height:c,longitude:h,latitude:p,zoom:v})}};p_.displayName="WebMercatorViewport";let Ef=p_;const _I=[0,0,0];function Fb(t,e,i=!1){const s=e.projectPosition(t);if(i&&e instanceof Ef){const[c,h,p=0]=t,v=e.getDistanceScales([c,h]);s[2]=p*v.unitsPerMeter[2]}return s}function _W(t){const{viewport:e,modelMatrix:i,coordinateOrigin:s}=t;let{coordinateSystem:c,fromCoordinateSystem:h,fromCoordinateOrigin:p}=t;return c===qr.DEFAULT&&(c=e.isGeospatial?qr.LNGLAT:qr.CARTESIAN),h===void 0&&(h=c),p===void 0&&(p=s),{viewport:e,coordinateSystem:c,coordinateOrigin:s,modelMatrix:i,fromCoordinateSystem:h,fromCoordinateOrigin:p}}function aL(t,{viewport:e,modelMatrix:i,coordinateSystem:s,coordinateOrigin:c,offsetMode:h}){let[p,v,l=0]=t;switch(i&&([p,v,l]=Pf([],[p,v,l,1],i)),s){case qr.LNGLAT:return Fb([p,v,l],e,h);case qr.LNGLAT_OFFSETS:return Fb([p+c[0],v+c[1],l+(c[2]||0)],e,h);case qr.METER_OFFSETS:return Fb(iL(c,[p,v,l]),e,h);case qr.CARTESIAN:default:return e.isGeospatial?[p+c[0],v+c[1],l+c[2]]:e.projectPosition([p,v,l])}}function gW(t,e){const{viewport:i,coordinateSystem:s,coordinateOrigin:c,modelMatrix:h,fromCoordinateSystem:p,fromCoordinateOrigin:v}=_W(e),{autoOffset:l=!0}=e,{geospatialOrigin:A=_I,shaderCoordinateOrigin:P=_I,offsetMode:O=!1}=l?eL(i,s,c):{},L=aL(t,{viewport:i,modelMatrix:h,coordinateSystem:p,coordinateOrigin:v,offsetMode:O});if(O){const U=i.projectPosition(A||P);jD(L,L,U)}return L}let yW=1,vW=1;class lL{constructor(){fe(this,"time",0);fe(this,"channels",new Map);fe(this,"animations",new Map);fe(this,"playing",!1);fe(this,"lastEngineTime",-1)}addChannel(e){const{delay:i=0,duration:s=Number.POSITIVE_INFINITY,rate:c=1,repeat:h=1}=e,p=yW++,v={time:0,delay:i,duration:s,rate:c,repeat:h};return this._setChannelTime(v,this.time),this.channels.set(p,v),p}removeChannel(e){this.channels.delete(e);for(const[i,s]of this.animations)s.channel===e&&this.detachAnimation(i)}isFinished(e){const i=this.channels.get(e);return i===void 0?!1:this.time>=i.delay+i.duration*i.repeat}getTime(e){if(e===void 0)return this.time;const i=this.channels.get(e);return i===void 0?-1:i.time}setTime(e){this.time=Math.max(0,e);const i=this.channels.values();for(const c of i)this._setChannelTime(c,this.time);const s=this.animations.values();for(const c of s){const{animation:h,channel:p}=c;h.setTime(this.getTime(p))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,i){const s=vW++;return this.animations.set(s,{animation:e,channel:i}),e.setTime(this.getTime(i)),s}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,i){const s=i-e.delay,c=e.duration*e.repeat;s>=c?e.time=e.duration*e.rate:(e.time=Math.max(0,s)%e.duration,e.time*=e.rate)}}let xW=0;const bW={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:t=>console.error(t),stats:hh.stats.get(`animation-loop-${xW++}`),useDevicePixels:!0,autoResizeViewport:!1,autoResizeDrawingBuffer:!1};class wW{constructor(e){fe(this,"device",null);fe(this,"canvas",null);fe(this,"props");fe(this,"animationProps",null);fe(this,"timeline",null);fe(this,"stats");fe(this,"cpuTime");fe(this,"gpuTime");fe(this,"frameRate");fe(this,"display");fe(this,"needsRedraw","initialized");fe(this,"_initialized",!1);fe(this,"_running",!1);fe(this,"_animationFrameId",null);fe(this,"_nextFramePromise",null);fe(this,"_resolveNextFrame",null);fe(this,"_cpuStartTime",0);if(this.props={...bW,...e},e=this.props,!e.device)throw new Error("No device provided");const{useDevicePixels:i=!0}=this.props;this.stats=e.stats||new B_({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:e.autoResizeViewport,autoResizeDrawingBuffer:e.autoResizeDrawingBuffer,useDevicePixels:i}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}setNeedsRedraw(e){return this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.props.autoResizeViewport=e.autoResizeViewport||!1),"autoResizeDrawingBuffer"in e&&(this.props.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer||!1),"useDevicePixels"in e&&(this.props.useDevicePixels=e.useDevicePixels||!1),this}async start(){if(this._running)return this;this._running=!0;try{let e;return this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),this._running?(e!==!1&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(e){const i=e instanceof Error?e:new Error("Unknown error");throw this.props.onError(i),i}}stop(){return this._running&&(this.animationProps&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){var e;return(e=this.device)!=null&&e.isLost?this:(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers(),this)}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_setDisplay(e){this.display&&(this.display.destroy(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_requestAnimationFrame(){this._running&&(this._animationFrameId=U7(this._animationFrame.bind(this)))}_cancelAnimationFrame(){this._animationFrameId!==null&&(V7(this._animationFrameId),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(e){if(this.display){this.display._renderFrame(e);return}this.props.onRender(this._getAnimationProps()),this.device.submit()}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_initializeAnimationProps(){var e,i;if(!this.device)throw new Error("loop");this.animationProps={animationLoop:this,device:this.device,canvas:(i=(e=this.device)==null?void 0:e.canvasContext)==null?void 0:i.canvas,timeline:this.timeline,useDevicePixels:this.props.useDevicePixels,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;const{width:e,height:i,aspect:s}=this._getSizeAndAspect();(e!==this.animationProps.width||i!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),s!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=i,this.animationProps.aspect=s,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){var e;if(this.device=await this.props.device,!this.device)throw new Error("No device provided");this.canvas=((e=this.device.canvasContext)==null?void 0:e.canvas)||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){const e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";const i=document.createElement("div");i.style.position="absolute",i.style.left="10px",i.style.bottom="10px",i.style.width="300px",i.style.background="white",this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas),e.appendChild(i);const s=this.props.onAddHTML(i);s&&(i.innerHTML=s)}}_getSizeAndAspect(){var h,p,v,l;if(!this.device)return{width:1,height:1,aspect:1};const[e,i]=((p=(h=this.device)==null?void 0:h.canvasContext)==null?void 0:p.getPixelSize())||[1,1];let s=1;const c=(l=(v=this.device)==null?void 0:v.canvasContext)==null?void 0:l.canvas;return c&&c.clientHeight?s=c.clientWidth/c.clientHeight:e>0&&i>0&&(s=e/i),{width:e,height:i,aspect:s}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){var e,i;this.props.autoResizeDrawingBuffer&&((i=(e=this.device)==null?void 0:e.canvasContext)==null||i.resize({useDevicePixels:this.props.useDevicePixels}))}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(e){e instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[e.offsetX,e.offsetY])}_onMouseleave(e){this._getAnimationProps()._mousePosition=null}}class gI{constructor(e){fe(this,"id");fe(this,"userData",{});fe(this,"topology");fe(this,"bufferLayout",[]);fe(this,"vertexCount");fe(this,"indices");fe(this,"attributes");this.id=e.id||Ph("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&Bn(this.indices.usage===Yn.INDEX)}destroy(){var e;(e=this.indices)==null||e.destroy();for(const i of Object.values(this.attributes))i.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices}_calculateVertexCount(e){return e.byteLength/12}}function TW(t,e){if(e instanceof gI)return e;const i=EW(t,e),{attributes:s,bufferLayout:c}=SW(t,e);return new gI({topology:e.topology||"triangle-list",bufferLayout:c,vertexCount:e.vertexCount,indices:i,attributes:s})}function EW(t,e){if(!e.indices)return;const i=e.indices.value;return t.createBuffer({usage:Yn.INDEX,data:i})}function SW(t,e){const i=[],s={};for(const[h,p]of Object.entries(e.attributes)){let v=h;switch(h){case"POSITION":v="positions";break;case"NORMAL":v="normals";break;case"TEXCOORD_0":v="texCoords";break;case"COLOR_0":v="colors";break}s[v]=t.createBuffer({data:p.value,id:`${h}-buffer`});const{value:l,size:A,normalized:P}=p;i.push({name:v,format:L7(l,A,P)})}const c=e._calculateVertexCount(e.attributes,e.indices);return{attributes:s,bufferLayout:i,vertexCount:c}}class AW{constructor(e){fe(this,"modules");fe(this,"moduleUniforms");fe(this,"moduleBindings");fe(this,"moduleUniformsChanged");const i=a1(Object.values(e));Jt.log(1,"Creating ShaderInputs with modules",i.map(s=>s.name))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={};for(const[s,c]of Object.entries(e)){const h=s;this.moduleUniforms[h]=c.defaultUniforms||{},this.moduleBindings[h]={}}}destroy(){}setProps(e){var i;for(const s of Object.keys(e)){const c=s,h=e[c],p=this.modules[c];if(!p){Jt.warn(`Module ${s} not found`)();continue}const v=this.moduleUniforms[c],l=((i=p.getUniforms)==null?void 0:i.call(p,h,this.moduleUniforms[c]))||h;this.moduleUniforms[c]={...v,...l}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindings(){const e={};for(const i of Object.values(this.moduleBindings))Object.assign(e,i);return e}getDebugTable(){var i;const e={};for(const[s,c]of Object.entries(this.moduleUniforms))for(const[h,p]of Object.entries(c))e[`${s}.${h}`]={type:(i=this.modules[s].uniformTypes)==null?void 0:i[h],value:String(p)};return e}}const Bv=class Bv{constructor(e){fe(this,"device");fe(this,"_hashCounter",0);fe(this,"_hashes",{});fe(this,"_renderPipelineCache",{});fe(this,"_computePipelineCache",{});this.device=e}static getDefaultPipelineFactory(e){return e._lumaData.defaultPipelineFactory=e._lumaData.defaultPipelineFactory||new Bv(e),e._lumaData.defaultPipelineFactory}createRenderPipeline(e){const i={...yf.defaultProps,...e},s=this._hashRenderPipeline(i);if(!this._renderPipelineCache[s]){const c=this.device.createRenderPipeline({...i,id:i.id?`${i.id}-cached`:void 0});c.hash=s,this._renderPipelineCache[s]={pipeline:c,useCount:0}}return this._renderPipelineCache[s].useCount++,this._renderPipelineCache[s].pipeline}createComputePipeline(e){const i={...ov.defaultProps,...e},s=this._hashComputePipeline(i);if(!this._computePipelineCache[s]){const c=this.device.createComputePipeline({...i,id:i.id?`${i.id}-cached`:void 0});c.hash=s,this._computePipelineCache[s]={pipeline:c,useCount:0}}return this._computePipelineCache[s].useCount++,this._computePipelineCache[s].pipeline}release(e){const i=e.hash,s=e instanceof ov?this._computePipelineCache:this._renderPipelineCache;s[i].useCount--,s[i].useCount===0&&(s[i].pipeline.destroy(),delete s[i])}_hashComputePipeline(e){return`${this._getHash(e.shader.source)}`}_hashRenderPipeline(e){const i=this._getHash(e.vs.source),s=e.fs?this._getHash(e.fs.source):0,c="-",h=this._getHash(JSON.stringify(e.bufferLayout));switch(this.device.type){case"webgl":return`${i}/${s}V${c}BL${h}`;default:const p=this._getHash(JSON.stringify(e.parameters));return`${i}/${s}V${c}T${e.topology}P${p}BL${h}`}}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}};fe(Bv,"defaultProps",{...yf.defaultProps});let dT=Bv;const zv=class zv{constructor(e){fe(this,"device");fe(this,"_cache",{});this.device=e}static getDefaultShaderFactory(e){var i;return(i=e._lumaData).defaultShaderFactory||(i.defaultShaderFactory=new zv(e)),e._lumaData.defaultShaderFactory}createShader(e){const i=this._hashShader(e);let s=this._cache[i];if(!s){const c=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[i]=s={shader:c,useCount:0}}return s.useCount++,s.shader}release(e){const i=this._hashShader(e),s=this._cache[i];s&&(s.useCount--,s.useCount===0&&(delete this._cache[i],s.shader.destroy()))}_hashShader(e){return`${e.stage}:${e.source}`}};fe(zv,"defaultProps",{...rv.defaultProps});let fT=zv;function MW(t,e){var c;const i={},s="Values";if(t.attributes.length===0&&!((c=t.varyings)!=null&&c.length))return{"No attributes or varyings":{[s]:"N/A"}};for(const h of t.attributes)if(h){const p=`${h.location} ${h.name}: ${h.type}`;i[`in ${p}`]={[s]:h.stepMode||"vertex"}}for(const h of t.varyings||[]){const p=`${h.location} ${h.name}`;i[`out ${p}`]={[s]:JSON.stringify(h.accessor)}}return i}let Rs=null,Bb=null;function CW(t,{id:e,minimap:i,opaque:s,top:c="0",left:h="0",rgbaScale:p=1}){Rs||(Rs=document.createElement("canvas"),Rs.id=e,Rs.title=e,Rs.style.zIndex="100",Rs.style.position="absolute",Rs.style.top=c,Rs.style.left=h,Rs.style.border="blue 1px solid",Rs.style.transform="scaleY(-1)",document.body.appendChild(Rs),Bb=Rs.getContext("2d")),(Rs.width!==t.width||Rs.height!==t.height)&&(Rs.width=t.width/2,Rs.height=t.height/2,Rs.style.width="400px",Rs.style.height="400px");const v=t.device.readPixelsToArrayWebGL(t),l=Bb.createImageData(t.width,t.height),A=0;for(let P=0;P<v.length;P+=4)l.data[A+P+0]=v[P+0]*p,l.data[A+P+1]=v[P+1]*p,l.data[A+P+2]=v[P+2]*p,l.data[A+P+3]=s?255:v[P+3]*p;Bb.putImageData(l,0,0)}const Fd=2,PW=1e4,Uv=class Uv{constructor(e,i){fe(this,"device");fe(this,"id");fe(this,"source");fe(this,"vs");fe(this,"fs");fe(this,"pipelineFactory");fe(this,"shaderFactory");fe(this,"userData",{});fe(this,"parameters");fe(this,"topology");fe(this,"bufferLayout");fe(this,"isInstanced");fe(this,"instanceCount",0);fe(this,"vertexCount");fe(this,"indexBuffer",null);fe(this,"bufferAttributes",{});fe(this,"constantAttributes",{});fe(this,"bindings",{});fe(this,"uniforms",{});fe(this,"vertexArray");fe(this,"transformFeedback",null);fe(this,"pipeline");fe(this,"shaderInputs");fe(this,"_uniformStore");fe(this,"_attributeInfos",{});fe(this,"_gpuGeometry",null);fe(this,"_getModuleUniforms");fe(this,"props");fe(this,"_pipelineNeedsUpdate","newly created");fe(this,"_needsRedraw","initializing");fe(this,"_destroyed",!1);fe(this,"_lastDrawTimestamp",-1);fe(this,"_lastLogTime",0);fe(this,"_logOpen",!1);fe(this,"_drawCount",0);var v,l,A,P;this.props={...Uv.defaultProps,...i},i=this.props,this.id=i.id||Ph("model"),this.device=e,Object.assign(this.userData,i.userData);const s=Object.fromEntries(((v=this.props.modules)==null?void 0:v.map(O=>[O.name,O]))||[]);this.setShaderInputs(i.shaderInputs||new AW(s));const c=IW(e),h=(((l=this.props.modules)==null?void 0:l.length)>0?this.props.modules:(A=this.shaderInputs)==null?void 0:A.getModules())||[];if(this.device.type==="webgpu"&&this.props.source){(P=this.props).shaderLayout||(P.shaderLayout=w9(this.props.source));const{source:O,getUniforms:L}=this.props.shaderAssembler.assembleShader({platformInfo:c,...this.props,modules:h});this.source=O,this._getModuleUniforms=L}else{const{vs:O,fs:L,getUniforms:U}=this.props.shaderAssembler.assembleShaderPair({platformInfo:c,...this.props,modules:h});this.vs=O,this.fs=L,this._getModuleUniforms=U}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,i.geometry&&this.setGeometry(i.geometry),this.pipelineFactory=i.pipelineFactory||dT.getDefaultPipelineFactory(this.device),this.shaderFactory=i.shaderFactory||fT.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=e.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in i&&(this.isInstanced=i.isInstanced),i.instanceCount&&this.setInstanceCount(i.instanceCount),i.vertexCount&&this.setVertexCount(i.vertexCount),i.indexBuffer&&this.setIndexBuffer(i.indexBuffer),i.attributes&&this.setAttributes(i.attributes),i.constantAttributes&&this.setConstantAttributes(i.constantAttributes),i.bindings&&this.setBindings(i.bindings),i.uniforms&&this.setUniforms(i.uniforms),i.moduleSettings&&this.updateModuleSettings(i.moduleSettings),i.transformFeedback&&(this.transformFeedback=i.transformFeedback),Object.seal(this)}destroy(){var e;this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),(e=this._gpuGeometry)==null||e.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");const e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||(this._needsRedraw=e)}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){this.predraw();let i;try{this._logDrawCallStart(),this.pipeline=this._updatePipeline(),this.pipeline.setBindings(this.bindings,{disableWarnings:this.props.disableWarnings}),tv(this.uniforms)||this.pipeline.setUniformsWebGL(this.uniforms);const{indexBuffer:s}=this.vertexArray,c=s?s.byteLength/(s.indexType==="uint32"?4:2):void 0;i=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:c,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{this._logDrawCallEnd()}return this._logFramebuffer(e),i?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",i}setGeometry(e){var s;(s=this._gpuGeometry)==null||s.destroy();const i=e&&TW(this.device,e);i&&(this.setTopology(i.topology||"triangle-list"),this.bufferLayout=yI(i.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(i)),this._gpuGeometry=i}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){this.bufferLayout=this._gpuGeometry?yI(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){nT(e,this.parameters,2)||(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,this.isInstanced===void 0&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){this.shaderInputs=e,this._uniformStore=new D7(this.shaderInputs.modules);for(const i of Object.keys(this.shaderInputs.modules)){const s=this._uniformStore.getManagedUniformBuffer(this.device,i);this.bindings[`${i}Uniforms`]=s}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,i){e.indices&&Jt.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)();for(const[s,c]of Object.entries(e)){const h=this.bufferLayout.find(l=>vI(l).includes(s));if(!h){Jt.warn(`Model(${this.id}): Missing layout for buffer "${s}".`)();continue}const p=vI(h);let v=!1;for(const l of p){const A=this._attributeInfos[l];A&&(this.vertexArray.setBuffer(A.location,c),v=!0)}!v&&!((i==null?void 0:i.disableWarnings)??this.props.disableWarnings)&&Jt.warn(`Model(${this.id}): Ignoring buffer "${c.id}" for unknown attribute "${s}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,i){for(const[s,c]of Object.entries(e)){const h=this._attributeInfos[s];h?this.vertexArray.setConstantWebGL(h.location,c):((i==null?void 0:i.disableWarnings)??this.props.disableWarnings)||Jt.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${s}"`)()}this.setNeedsRedraw("constants")}setUniforms(e){tv(e)||(this.pipeline.setUniformsWebGL(e),Object.assign(this.uniforms,e)),this.setNeedsRedraw("uniforms")}updateModuleSettings(e){const{bindings:i,uniforms:s}=ED(this._getModuleUniforms(e));Object.assign(this.bindings,i),Object.assign(this.uniforms,s),this.setNeedsRedraw("moduleSettings")}_getBindingsUpdateTimestamp(){let e=0;for(const i of Object.values(this.bindings))i instanceof iv?e=Math.max(e,i.texture.updateTimestamp):i instanceof Yn||i instanceof Xo?e=Math.max(e,i.updateTimestamp):i instanceof nv||(e=Math.max(e,i.buffer.updateTimestamp));return e}_setGeometryAttributes(e){const i={...e.attributes};for(const[s]of Object.entries(i))!this.pipeline.shaderLayout.attributes.find(c=>c.name===s)&&s!=="positions"&&delete i[s];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(i,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||(this._pipelineNeedsUpdate=e),this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,i=null;this.pipeline&&(Jt.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,i=this.pipeline.fs),this._pipelineNeedsUpdate=!1;const s=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debug:this.props.debugShaders});let c=null;this.source?c=s:this.fs&&(c=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debug:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,vs:s,fs:c}),this._attributeInfos=xD(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),i&&this.shaderFactory.release(i)}return this.pipeline}_logDrawCallStart(){const e=Jt.level>3?0:PW;Jt.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,Jt.group(Fd,`>>> DRAWING MODEL ${this.id}`,{collapsed:Jt.level<=2})())}_logDrawCallEnd(){if(this._logOpen){const e=MW(this.pipeline.shaderLayout,this.id);Jt.table(Fd,e)();const i=this.shaderInputs.getDebugTable();for(const[c,h]of Object.entries(this.uniforms))i[c]={value:h};Jt.table(Fd,i)();const s=this._getAttributeDebugTable();Jt.table(Fd,this._attributeInfos)(),Jt.table(Fd,s)(),Jt.groupEnd(Fd)(),this._logOpen=!1}}_logFramebuffer(e){const i=Jt.get("framebuffer");if(this._drawCount++,!i||this._drawCount++>3&&this._drawCount%60)return;const s=e.props.framebuffer;s&&CW(s,{id:s.id,minimap:!0})}_getAttributeDebugTable(){const e={};for(const[i,s]of Object.entries(this._attributeInfos))e[s.location]={name:i,type:s.shaderType,values:this._getBufferOrConstantValues(this.vertexArray.attributes[s.location],s.bufferDataType)};if(this.vertexArray.indexBuffer){const{indexBuffer:i}=this.vertexArray,s=i.indexType==="uint32"?new Uint32Array(i.debugData):new Uint16Array(i.debugData);e.indices={name:"indices",type:i.indexType,values:s.toString()}}return e}_getBufferOrConstantValues(e,i){const s=TD(i);return(e instanceof Yn?new s(e.debugData):e).toString()}};fe(Uv,"defaultProps",{...yf.defaultProps,source:null,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],moduleSettings:void 0,geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:ev.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0});let Yo=Uv;function yI(t,e){const i=[...t];for(const s of e){const c=i.findIndex(h=>h.name===s.name);c<0?i.push(s):i[c]=s}return i}function IW(t){return{type:t.type,shaderLanguage:t.info.shadingLanguage,shaderLanguageVersion:t.info.shadingLanguageVersion,gpu:t.info.gpu,features:t.features}}function vI(t){var e;return t.attributes?(e=t.attributes)==null?void 0:e.map(i=>i.attribute):[t.name]}class u1{constructor(e,i=Yo.defaultProps){fe(this,"device");fe(this,"model");fe(this,"transformFeedback");Bn(u1.isSupported(e),"BufferTransform not yet implemented on WebGPU"),this.device=e,this.model=new Yo(this.device,{id:i.id||"buffer-transform-model",fs:i.fs||Nj(),topology:i.topology||"point-list",...i}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:i.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}static isSupported(e){var i;return((i=e==null?void 0:e.info)==null?void 0:i.type)==="webgl"}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(e){const i=this.device.beginRenderPass(e);this.model.draw(i),i.end()}update(...e){console.warn("TextureTransform#update() not implemented")}getBuffer(e){return this.transformFeedback.getBuffer(e)}readAsync(e){const i=this.getBuffer(e);if(i instanceof Yn)return i.readAsync();const{buffer:s,byteOffset:c=0,byteLength:h=s.byteLength}=i;return s.readAsync(c,h)}}class Sf{constructor(e){fe(this,"id");fe(this,"topology");fe(this,"vertexCount");fe(this,"indices");fe(this,"attributes");fe(this,"userData",{});const{attributes:i={},indices:s=null,vertexCount:c=null}=e;this.id=e.id||Ph("geometry"),this.topology=e.topology,s&&(this.indices=ArrayBuffer.isView(s)?{value:s,size:1}:s),this.attributes={};for(const[h,p]of Object.entries(i)){const v=ArrayBuffer.isView(p)?{value:p}:p;Bn(ArrayBuffer.isView(v.value),`${this._print(h)}: must be typed array or object with value as typed array`),(h==="POSITION"||h==="positions")&&!v.size&&(v.size=3),h==="indices"?(Bn(!this.indices),this.indices=v):this.attributes[h]=v}this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=c||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,i){return this}_calculateVertexCount(e,i){if(i)return i.value.length;let s=1/0;for(const c of Object.values(e)){const{value:h,size:p,constant:v}=c;!v&&h&&p>=1&&(s=Math.min(s,h.length/p))}return Bn(Number.isFinite(s)),s}}const RW={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant-alpha",blendAlphaDstFactor:"zero"};class cL extends ME{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:i,views:s,viewports:c,onViewportActive:h,pickingFBO:p,deviceRect:{x:v,y:l,width:A,height:P},cullRect:O,effects:L,pass:U="picking",pickZ:H,moduleParameters:Y}){this.pickZ=H;const J=this._resetColorEncoder(H),oe=[v,l,A,P],me=super.render({target:p,layers:e,layerFilter:i,views:s,viewports:c,onViewportActive:h,cullRect:O,effects:L==null?void 0:L.filter(be=>be.useInPicking),pass:U,isPicking:!0,moduleParameters:Y,clearColor:[0,0,0,0],colorMask:15,scissorRect:oe});return this._colorEncoderState=null,{decodePickingColor:J&&kW.bind(null,J),stats:me}}shouldDrawLayer(e){const{pickable:i,operation:s}=e.props;return i&&s.includes("draw")||s.includes("terrain")||s.includes("mask")}getModuleParameters(){return{picking:{isActive:1,isAttribute:this.pickZ},lightSources:{}}}getLayerParameters(e,i,s){const c={depthMask:!0,depthTest:!0,depthRange:[0,1],...e.props.parameters},{pickable:h,operation:p}=e.props;return!this._colorEncoderState||p.includes("terrain")?c.blend=!1:h&&p.includes("draw")&&(Object.assign(c,RW),c.blend=!0,c.blendColor=OW(this._colorEncoderState,e,s)),c}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function OW(t,e,i){const{byLayer:s,byAlpha:c}=t;let h,p=s.get(e);return p?(p.viewports.push(i),h=p.a):(h=s.size+1,h<=255?(p={a:h,layer:e,viewports:[i]},s.set(e,p),c[h]=p):(jr.warn("Too many pickable layers, only picking the first 255")(),h=0)),[0,0,0,h/255]}function kW(t,e){const i=t.byAlpha[e[3]];return i&&{pickedLayer:i.layer,pickedViewports:i.viewports,pickedObjectIndex:i.layer.decodePickingColor(e)}}const Wd={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},hv=Symbol.for("component"),Bc=Symbol.for("propTypes"),zb=Symbol.for("deprecatedProps"),af=Symbol.for("asyncPropDefaults"),Sh=Symbol.for("asyncPropOriginal"),Dc=Symbol.for("asyncPropResolved");function h1(t,e=()=>!0){return Array.isArray(t)?uL(t,e,[]):e(t)?[t]:[]}function uL(t,e,i){let s=-1;for(;++s<t.length;){const c=t[s];Array.isArray(c)?uL(c,e,i):e(c)&&i.push(c)}return i}function DW({target:t,source:e,start:i=0,count:s=1}){const c=e.length,h=s*c;let p=0;for(let v=i;p<c;p++)t[v++]=e[p];for(;p<h;)p<h-p?(t.copyWithin(i+p,i,i+p),p*=2):(t.copyWithin(i+p,i,i+h-p),p=h);return t}class LW{constructor(e,i,s){this._loadCount=0,this._subscribers=new Set,this.id=e,this.context=s,this.setData(i)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,i){if(e===this._data&&!i)return;this._data=e;const s=++this._loadCount;let c=e;typeof e=="string"&&(c=ch(e)),c instanceof Promise?(this.isLoaded=!1,this._loader=c.then(h=>{this._loadCount===s&&(this.isLoaded=!0,this._error=void 0,this._content=h)}).catch(h=>{this._loadCount===s&&(this.isLoaded=!0,this._error=h||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(const h of this._subscribers)h.onChange(this.getData())}}class NW{constructor(e){var i;this.protocol=e.protocol||"resource://",this._context={device:e.device,gl:(i=e.device)==null?void 0:i.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:i,forceUpdate:s=!1,persistent:c=!0}){let h=this._resources[e];h?h.setData(i,s):(h=new LW(e,i,this._context),this._resources[e]=h),h.persistent=c}remove(e){const i=this._resources[e];i&&(i.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){const i=this._consumers[e];if(i){for(const s in i){const c=i[s],h=this._resources[c.resourceId];h&&h.unsubscribe(c)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:i,consumerId:s,requestId:c="default"}){const{_resources:h,protocol:p}=this;e.startsWith(p)&&(e=e.replace(p,""),h[e]||this.add({resourceId:e,data:null,persistent:!1}));const v=h[e];if(this._track(s,c,v,i),v)return v.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const e in this._resources)this._resources[e].delete()}_track(e,i,s,c){const h=this._consumers,p=h[e]=h[e]||{};let v=p[i];const l=v&&v.resourceId&&this._resources[v.resourceId];l&&(l.unsubscribe(v),this.prune()),s&&(v?(v.onChange=c,v.resourceId=s.id):v={onChange:c,resourceId:s.id},p[i]=v,s.subscribe(v))}_prune(){this._pruneRequest=null;for(const e of Object.keys(this._resources)){const i=this._resources[e];!i.persistent&&!i.inUse()&&(i.delete(),delete this._resources[e])}}}const FW="layerManager.setLayers",BW="layerManager.activateViewport";class zW{constructor(e,i){this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=v=>{Ks(BW,this,v),v&&(this.context.viewport=v)};const{deck:s,stats:c,viewport:h,timeline:p}=i||{};this.layers=[],this.resourceManager=new NW({device:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:e,gl:e==null?void 0:e.gl,deck:s,shaderAssembler:q$(),defaultShaderModules:[],renderPass:void 0,stats:c||new B_({id:"deck.gl"}),viewport:h||new Tf({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:p||new lL,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let i=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(const s of this.layers){const c=s.getNeedsRedraw(e);i=i||c}return i}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(i=>e.find(s=>i.id.indexOf(s)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,i){Ks(FW,this,i,e),this._lastRenderedLayers=e;const s=h1(e,Boolean);for(const c of s)c.context=this.context;this._updateLayers(this.layers,s)}updateLayers(){const e=this.needsUpdate();e&&(this.setNeedsRedraw(`updating layers: ${e}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}addDefaultShaderModule(e){const{defaultShaderModules:i}=this.context;i.find(s=>s.name===e.name)||(i.push(e),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(e){const{defaultShaderModules:i}=this.context,s=i.findIndex(c=>c.name===e.name);s>=0&&(i.splice(s,1),this._defaultShaderModulesChanged=!0)}_handleError(e,i,s){s.raiseError(i,`${e} of ${s}`)}_updateLayers(e,i){const s={};for(const p of e)s[p.id]?jr.warn(`Multiple old layers with same id ${p.id}`)():s[p.id]=p;if(this._defaultShaderModulesChanged){for(const p of e)p.setNeedsUpdate(),p.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}const c=[];this._updateSublayersRecursively(i,s,c),this._finalizeOldLayers(s);let h=!1;for(const p of c)if(p.hasUniformTransition()){h=`Uniform transition in ${p}`;break}this._needsUpdate=h,this.layers=c}_updateSublayersRecursively(e,i,s){for(const c of e){c.context=this.context;const h=i[c.id];h===null&&jr.warn(`Multiple new layers with same id ${c.id}`)(),i[c.id]=null;let p=null;try{this._debug&&h!==c&&c.validateProps(),h?(this._transferLayerState(h,c),this._updateLayer(c)):this._initializeLayer(c),s.push(c),p=c.isComposite?c.getSubLayers():null}catch(v){this._handleError("matching",v,c)}p&&this._updateSublayersRecursively(p,i,s)}}_finalizeOldLayers(e){for(const i in e){const s=e[i];s&&this._finalizeLayer(s)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=Wd.INITIALIZED}catch(i){this._handleError("initialization",i,e)}}_transferLayerState(e,i){i._transferState(e),i.lifecycle=Wd.MATCHED,i!==e&&(e.lifecycle=Wd.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(i){this._handleError("update",i,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||`finalized ${e}`,e.lifecycle=Wd.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=Wd.FINALIZED}catch(i){this._handleError("finalization",i,e)}}}function xa(t,e,i){if(t===e)return!0;if(!i||!t||!e)return!1;if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(!xa(t[s],e[s],i-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof t=="object"&&typeof e=="object"){const s=Object.keys(t),c=Object.keys(e);if(s.length!==c.length)return!1;for(const h of s)if(!e.hasOwnProperty(h)||!xa(t[h],e[h],i-1))return!1;return!0}return!1}class UW{constructor(e){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(const e in this.controllers){const i=this.controllers[e];i&&i.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){const i=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),i}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(const e in this.controllers){const i=this.controllers[e];i&&i.updateTransition()}}getViewports(e){return e?this._viewports.filter(i=>i.containsPixel(e)):this._viewports}getViews(){const e={};return this.views.forEach(i=>{e[i.id]=i}),e}getView(e){return this.views.find(i=>i.id===e)}getViewState(e){const i=typeof e=="string"?this.getView(e):e,s=i&&this.viewState[i.getViewStateId()]||this.viewState;return i?i.filterViewState(s):s}getViewport(e){return this._viewportMap[e]}unproject(e,i){const s=this.getViewports(),c={x:e[0],y:e[1]};for(let h=s.length-1;h>=0;--h){const p=s[h];if(p.containsPixel(c)){const v=e.slice();return v[0]-=p.x,v[1]-=p.y,p.unproject(v,i)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,i){(e!==this.width||i!==this.height)&&(this.width=e,this.height=i,this.setNeedsUpdate("Size changed"))}_setViews(e){e=h1(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!xa(e,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):jr.warn("missing `viewState` or `initialViewState`")()}_createController(e,i){const s=i.type;return new s({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:h=>{var p;return(p=this.getView(e.id))==null?void 0:p.makeViewport({viewState:h,width:this.width,height:this.height})}})}_updateController(e,i,s,c){const h=e.controller;if(h&&s){const p={...i,...h,id:e.id,x:s.x,y:s.y,width:s.width,height:s.height};return(!c||c.constructor!==h.type)&&(c=this._createController(e,p)),c&&c.setProps(p),c}return null}_rebuildViewports(){const{views:e}=this,i=this.controllers;this._viewports=[],this.controllers={};let s=!1;for(let c=e.length;c--;){const h=e[c],p=this.getViewState(h),v=h.makeViewport({viewState:p,width:this.width,height:this.height});let l=i[h.id];const A=!!h.controller;A&&!l&&(s=!0),(s||!A)&&l&&(l.finalize(),l=null),this.controllers[h.id]=this._updateController(h,p,v,l),v&&this._viewports.unshift(v)}for(const c in i){const h=i[c];h&&!this.controllers[c]&&h.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,i){return e.length!==i.length?!0:e.some((s,c)=>!e[c].equals(i[c]))}}const VW=/([0-9]+\.?[0-9]*)(%|px)/;function xc(t){switch(typeof t){case"number":return{position:t,relative:!1};case"string":const e=VW.exec(t);if(e&&e.length>=3){const i=e[2]==="%",s=parseFloat(e[1]);return{position:i?s/100:s,relative:i}}default:throw new Error(`Could not parse position string ${t}`)}}function bc(t,e){return t.relative?Math.round(t.position*e):t.position}class hL{constructor(e){const{id:i,x:s=0,y:c=0,width:h="100%",height:p="100%",padding:v=null}=e;this.id=i||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=xc(s),this._y=xc(c),this._width=xc(h),this._height=xc(p),this._padding=v&&{left:xc(v.left||0),right:xc(v.right||0),top:xc(v.top||0),bottom:xc(v.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.ViewportType===e.ViewportType&&xa(this.props,e.props,2)}makeViewport({width:e,height:i,viewState:s}){s=this.filterViewState(s);const c=this.getDimensions({width:e,height:i});return!c.height||!c.width?null:new this.ViewportType({...s,...this.props,...c})}getViewStateId(){const{viewState:e}=this.props;return typeof e=="string"?e:(e==null?void 0:e.id)||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const i={...e};for(const s in this.props.viewState)s!=="id"&&(i[s]=this.props.viewState[s]);return i}return e}getDimensions({width:e,height:i}){const s={x:bc(this._x,e),y:bc(this._y,i),width:bc(this._width,e),height:bc(this._height,i)};return this._padding&&(s.padding={left:bc(this._padding.left,e),top:bc(this._padding.top,i),right:bc(this._padding.right,e),bottom:bc(this._padding.bottom,i)}),s}get controller(){const e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}}class d1{constructor(e){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=e}get inProgress(){return this._inProgress}start(e){var i,s;this.cancel(),this.settings=e,this._inProgress=!0,(s=(i=this.settings).onStart)==null||s.call(i,this)}end(){var e,i;this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,(i=(e=this.settings).onEnd)==null||i.call(e,this))}cancel(){var e,i;this._inProgress&&((i=(e=this.settings).onInterrupt)==null||i.call(e,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){var e,i;if(!this._inProgress)return!1;if(this._handle===null){const{_timeline:s,settings:c}=this;this._handle=s.addChannel({delay:s.getTime(),duration:c.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),(i=(e=this.settings).onUpdate)==null||i.call(e,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const xI=()=>{},pT={BREAK:1,SNAP_TO_END:2,IGNORE:3},jW=t=>t,$W=pT.BREAK;class WW{constructor(e){this._onTransitionUpdate=i=>{const{time:s,settings:{interpolator:c,startProps:h,endProps:p,duration:v,easing:l}}=i,A=l(s/v),P=c.interpolateProps(h,p,A);this.propsInTransition=this.getControllerState({...this.props,...P}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new d1(e.timeline),this.onViewStateChange=e.onViewStateChange||xI,this.onStateChange=e.onStateChange||xI}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let i=!1;const s=this.props;if(this.props=e,!s||this._shouldIgnoreViewportChange(s,e))return!1;if(this._isTransitionEnabled(e)){let c=s;if(this.transition.inProgress){const{interruption:h,endProps:p}=this.transition.settings;c={...s,...h===pT.SNAP_TO_END?p:this.propsInTransition||s}}this._triggerTransition(c,e),i=!0}else this.transition.cancel();return i}updateTransition(){this.transition.update()}_isTransitionEnabled(e){const{transitionDuration:i,transitionInterpolator:s}=e;return(i>0||i==="auto")&&!!s}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,i){return this.transition.inProgress?this.transition.settings.interruption===pT.IGNORE||this._isUpdateDueToCurrentTransition(i):this._isTransitionEnabled(i)?i.transitionInterpolator.arePropsEqual(e,i):!0}_triggerTransition(e,i){const s=this.getControllerState(e),c=this.getControllerState(i).shortestPathFrom(s),h=i.transitionInterpolator,p=h.getDuration?h.getDuration(e,i):i.transitionDuration;if(p===0)return;const v=h.initializeProps(e,c);this.propsInTransition={};const l={duration:p,easing:i.transitionEasing||jW,interpolator:h,interruption:i.transitionInterruption||$W,startProps:v.start,endProps:v.end,onStart:i.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(i.onTransitionInterrupt),onEnd:this._onTransitionEnd(i.onTransitionEnd)};this.transition.start(l),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return i=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e==null||e(i)}}}function zs(t,e){if(!t)throw new Error(e||"deck.gl: assertion failed.")}class HW{constructor(e){const{compare:i,extract:s,required:c}=e;this._propsToCompare=i,this._propsToExtract=s||i,this._requiredProps=c}arePropsEqual(e,i){for(const s of this._propsToCompare)if(!(s in e)||!(s in i)||!Ll(e[s],i[s]))return!1;return!0}initializeProps(e,i){const s={},c={};for(const h of this._propsToExtract)(h in e||h in i)&&(s[h]=e[h],c[h]=i[h]);return this._checkRequiredProps(s),this._checkRequiredProps(c),{start:s,end:c}}getDuration(e,i){return i.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach(i=>{const s=e[i];zs(Number.isFinite(s)||Array.isArray(s),`${i} is required for transition`)})}}const qW=["longitude","latitude","zoom","bearing","pitch"],GW=["longitude","latitude","zoom"];class C_ extends HW{constructor(e={}){const i=Array.isArray(e)?e:e.transitionProps,s=Array.isArray(e)?{}:e;s.transitionProps=Array.isArray(i)?{compare:i,required:i}:i||{compare:qW,required:GW},super(s.transitionProps),this.opts=s}initializeProps(e,i){const s=super.initializeProps(e,i),{makeViewport:c,around:h}=this.opts;if(c&&h){const p=c(e),v=c(i),l=p.unproject(h);s.start.around=h,Object.assign(s.end,{around:v.project(l),aroundPosition:l,width:i.width,height:i.height})}return s}interpolateProps(e,i,s){const c={};for(const h of this._propsToExtract)c[h]=dh(e[h]||0,i[h]||0,s);if(i.aroundPosition&&this.opts.makeViewport){const h=this.opts.makeViewport({...i,...c});Object.assign(c,h.panByPosition(i.aroundPosition,dh(e.around,i.around,s)))}return c}}const wc={transitionDuration:0},XW=300,s0=t=>1-(1-t)*(1-t),Bd={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],TRIPLE_PAN:["tripanstart","tripanmove","tripanend"],DOUBLE_TAP:["doubletap"],KEYBOARD:["keydown"]},qu={};class dL{constructor(e){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new WW({...e,getControllerState:i=>new this.ControllerState(i),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){var e;for(const i in this._events)this._events[i]&&((e=this.eventManager)==null||e.off(i,this.handleEvent));this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;const i=this._eventStartBlocked;switch(e.type){case"panstart":return i?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return i?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"tripanstart":return i?!1:this._onTriplePanStart(e);case"tripanmove":return this._onTriplePan(e);case"tripanend":return this._onTriplePanEnd(e);case"doubletap":return this._onDoubleTap(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){const{x:i,y:s}=this.props,{offsetCenter:c}=e;return[c.x-i,c.y-s]}isPointInBounds(e,i){const{width:s,height:c}=this.props;if(i&&i.handled)return!1;const h=e[0]>=0&&e[0]<=s&&e[1]>=0&&e[1]<=c;return h&&i&&i.stopPropagation(),h}isFunctionKeyPressed(e){const{srcEvent:i}=e;return!!(i.metaKey||i.altKey||i.ctrlKey||i.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){const i=setTimeout(()=>{this._eventStartBlocked===i&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=i}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);const{inertia:i}=e;this.inertia=Number.isFinite(i)?i:i===!0?XW:0;const{scrollZoom:s=!0,dragPan:c=!0,dragRotate:h=!0,doubleClickZoom:p=!0,touchZoom:v=!0,touchRotate:l=!1,keyboard:A=!0}=e,P=!!this.onViewStateChange;this.toggleEvents(Bd.WHEEL,P&&s),this.toggleEvents(Bd.PAN,P),this.toggleEvents(Bd.PINCH,P&&(v||l)),this.toggleEvents(Bd.TRIPLE_PAN,P&&l),this.toggleEvents(Bd.DOUBLE_TAP,P&&p),this.toggleEvents(Bd.KEYBOARD,P&&A),this.scrollZoom=s,this.dragPan=c,this.dragRotate=h,this.doubleClickZoom=p,this.touchZoom=v,this.touchRotate=l,this.keyboard=A}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,i){this.eventManager&&e.forEach(s=>{this._events[s]!==i&&(this._events[s]=i,i?this.eventManager.on(s,this.handleEvent):this.eventManager.off(s,this.handleEvent))})}updateViewport(e,i=null,s={}){const c={...e.getViewportProps(),...i},h=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(s),h){const p=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:c,interactionState:this._interactionState,oldViewState:p,viewId:this.props.id})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){const i=this.getCenter(e);if(!this.isPointInBounds(i,e))return!1;let s=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(s=!s);const c=this.controllerState[s?"panStart":"rotateStart"]({pos:i});return this._panMove=s,this.updateViewport(c,wc,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;const i=this.getCenter(e),s=this.controllerState.pan({pos:i});return this.updateViewport(s,wc,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){const{inertia:i}=this;if(this.dragPan&&i&&e.velocity){const s=this.getCenter(e),c=[s[0]+e.velocityX*i/2,s[1]+e.velocityY*i/2],h=this.controllerState.pan({pos:c}).panEnd();this.updateViewport(h,{...this._getTransitionProps(),transitionDuration:i,transitionEasing:s0},{isDragging:!1,isPanning:!0})}else{const s=this.controllerState.panEnd();this.updateViewport(s,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;const i=this.getCenter(e),s=this.controllerState.rotate({pos:i});return this.updateViewport(s,wc,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){const{inertia:i}=this;if(this.dragRotate&&i&&e.velocity){const s=this.getCenter(e),c=[s[0]+e.velocityX*i/2,s[1]+e.velocityY*i/2],h=this.controllerState.rotate({pos:c}).rotateEnd();this.updateViewport(h,{...this._getTransitionProps(),transitionDuration:i,transitionEasing:s0},{isDragging:!1,isRotating:!0})}else{const s=this.controllerState.rotateEnd();this.updateViewport(s,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;const i=this.getCenter(e);if(!this.isPointInBounds(i,e))return!1;e.srcEvent.preventDefault();const{speed:s=.01,smooth:c=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:h}=e;let p=2/(1+Math.exp(-Math.abs(h*s)));h<0&&p!==0&&(p=1/p);const v=this.controllerState.zoom({pos:i,scale:p});return this.updateViewport(v,{...this._getTransitionProps({around:i}),transitionDuration:c?250:1},{isZooming:!0,isPanning:!0}),!0}_onTriplePanStart(e){const i=this.getCenter(e);if(!this.isPointInBounds(i,e))return!1;const s=this.controllerState.rotateStart({pos:i});return this.updateViewport(s,wc,{isDragging:!0}),!0}_onTriplePan(e){if(!this.touchRotate||!this.isDragging())return!1;const i=this.getCenter(e);i[0]-=e.deltaX;const s=this.controllerState.rotate({pos:i});return this.updateViewport(s,wc,{isDragging:!0,isRotating:!0}),!0}_onTriplePanEnd(e){if(!this.isDragging())return!1;const{inertia:i}=this;if(this.touchRotate&&i&&e.velocityY){const s=this.getCenter(e),c=[s[0],s[1]+=e.velocityY*i/2],h=this.controllerState.rotate({pos:c});this.updateViewport(h,{...this._getTransitionProps(),transitionDuration:i,transitionEasing:s0},{isDragging:!1,isRotating:!0}),this.blockEvents(i)}else{const s=this.controllerState.rotateEnd();this.updateViewport(s,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){const i=this.getCenter(e);if(!this.isPointInBounds(i,e))return!1;const s=this.controllerState.zoomStart({pos:i}).rotateStart({pos:i});return qu._startPinchRotation=e.rotation,qu._lastPinchEvent=e,this.updateViewport(s,wc,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let i=this.controllerState;if(this.touchZoom){const{scale:s}=e,c=this.getCenter(e);i=i.zoom({pos:c,scale:s})}if(this.touchRotate){const{rotation:s}=e;i=i.rotate({deltaAngleX:qu._startPinchRotation-s})}return this.updateViewport(i,wc,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),qu._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;const{inertia:i}=this,{_lastPinchEvent:s}=qu;if(this.touchZoom&&i&&s&&e.scale!==s.scale){const c=this.getCenter(e);let h=this.controllerState.rotateEnd();const p=Math.log2(e.scale),v=(p-Math.log2(s.scale))/(e.deltaTime-s.deltaTime),l=Math.pow(2,p+v*i/2);h=h.zoom({pos:c,scale:l}).zoomEnd(),this.updateViewport(h,{...this._getTransitionProps({around:c}),transitionDuration:i,transitionEasing:s0},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(i)}else{const c=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(c,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return qu._startPinchRotation=null,qu._lastPinchEvent=null,!0}_onDoubleTap(e){if(!this.doubleClickZoom)return!1;const i=this.getCenter(e);if(!this.isPointInBounds(i,e))return!1;const s=this.isFunctionKeyPressed(e),c=this.controllerState.zoom({pos:i,scale:s?.5:2});return this.updateViewport(c,this._getTransitionProps({around:i}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;const i=this.isFunctionKeyPressed(e),{zoomSpeed:s,moveSpeed:c,rotateSpeedX:h,rotateSpeedY:p}=this.keyboard===!0?{}:this.keyboard,{controllerState:v}=this;let l;const A={};switch(e.srcEvent.code){case"Minus":l=i?v.zoomOut(s).zoomOut(s):v.zoomOut(s),A.isZooming=!0;break;case"Equal":l=i?v.zoomIn(s).zoomIn(s):v.zoomIn(s),A.isZooming=!0;break;case"ArrowLeft":i?(l=v.rotateLeft(h),A.isRotating=!0):(l=v.moveLeft(c),A.isPanning=!0);break;case"ArrowRight":i?(l=v.rotateRight(h),A.isRotating=!0):(l=v.moveRight(c),A.isPanning=!0);break;case"ArrowUp":i?(l=v.rotateUp(p),A.isRotating=!0):(l=v.moveUp(c),A.isPanning=!0);break;case"ArrowDown":i?(l=v.rotateDown(p),A.isRotating=!0):(l=v.moveDown(c),A.isPanning=!0);break;default:return!1}return this.updateViewport(l,this._getTransitionProps(),A),!0}_getTransitionProps(e){const{transition:i}=this;return!i||!i.transitionInterpolator?wc:e?{...i,transitionInterpolator:new C_({...e,...i.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:i}}class fL{constructor(e,i){this._viewportProps=this.applyConstraints(e),this._state=i}getViewportProps(){return this._viewportProps}getState(){return this._state}}const bI=5,ZW=1.2;class YW extends fL{constructor(e){const{width:i,height:s,latitude:c,longitude:h,zoom:p,bearing:v=0,pitch:l=0,altitude:A=1.5,position:P=[0,0,0],maxZoom:O=20,minZoom:L=0,maxPitch:U=60,minPitch:H=0,startPanLngLat:Y,startZoomLngLat:J,startRotatePos:oe,startBearing:me,startPitch:pe,startZoom:be,normalize:Oe=!0}=e;zs(Number.isFinite(h)),zs(Number.isFinite(c)),zs(Number.isFinite(p)),super({width:i,height:s,latitude:c,longitude:h,zoom:p,bearing:v,pitch:l,altitude:A,maxZoom:O,minZoom:L,maxPitch:U,minPitch:H,normalize:Oe,position:P},{startPanLngLat:Y,startZoomLngLat:J,startRotatePos:oe,startBearing:me,startPitch:pe,startZoom:be}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:i}){const s=this.getState().startPanLngLat||this._unproject(i);if(!s)return this;const h=this.makeViewport(this.getViewportProps()).panByPosition(s,e);return this._getUpdatedState(h)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:i=0,deltaAngleY:s=0}){const{startRotatePos:c,startBearing:h,startPitch:p}=this.getState();if(!c||h===void 0||p===void 0)return this;let v;return e?v=this._getNewRotation(e,c,p,h):v={bearing:h+i,pitch:p+s},this._getUpdatedState(v)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:i,scale:s}){let{startZoom:c,startZoomLngLat:h}=this.getState();if(h||(c=this.getViewportProps().zoom,h=this._unproject(i)||this._unproject(e)),!h)return this;const{maxZoom:p,minZoom:v}=this.getViewportProps();let l=c+Math.log2(s);l=Os(l,v,p);const A=this.makeViewport({...this.getViewportProps(),zoom:l});return this._getUpdatedState({zoom:l,...A.panByPosition(h,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){const i=e.getViewportProps(),s={...this.getViewportProps()},{bearing:c,longitude:h}=s;return Math.abs(c-i.bearing)>180&&(s.bearing=c<0?c+360:c-360),Math.abs(h-i.longitude)>180&&(s.longitude=h<0?h+360:h-360),s}applyConstraints(e){const{maxZoom:i,minZoom:s,zoom:c}=e;e.zoom=Os(c,s,i);const{maxPitch:h,minPitch:p,pitch:v}=e;e.pitch=Os(v,p,h);const{normalize:l=!0}=e;return l&&Object.assign(e,k$(e)),e}_zoomFromCenter(e){const{width:i,height:s}=this.getViewportProps();return this.zoom({pos:[i/2,s/2],scale:e})}_panFromCenter(e){const{width:i,height:s}=this.getViewportProps();return this.pan({startPos:[i/2,s/2],pos:[i/2+e[0],s/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){const i=this.makeViewport(this.getViewportProps());return e&&i.unproject(e)}_getNewRotation(e,i,s,c){const h=e[0]-i[0],p=e[1]-i[1],v=e[1],l=i[1],{width:A,height:P}=this.getViewportProps(),O=h/A;let L=0;p>0?Math.abs(P-l)>bI&&(L=p/(l-P)*ZW):p<0&&l>bI&&(L=1-v/l),L=Os(L,-1,1);const{minPitch:U,maxPitch:H}=this.getViewportProps(),Y=c+180*O;let J=s;return L>0?J=s+L*(H-s):L<0&&(J=s-L*(U-s)),{pitch:J,bearing:Y}}}class KW extends dL{constructor(){super(...arguments),this.ControllerState=YW,this.transition={transitionDuration:300,transitionInterpolator:new C_({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(e){e.position=e.position||[0,0,0];const i=this.props;super.setProps(e),(!i||i.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}const JE=class JE extends hL{constructor(e={}){super(e)}get ViewportType(){return Ef}get ControllerType(){return KW}};JE.displayName="MapView";let mT=JE;const JW=new oL;function QW(t,e){const i=t.order??1/0,s=e.order??1/0;return i-s}class eH{constructor(e){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=e,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){const i=this._defaultEffects;if(!i.find(s=>s.id===e.id)){const s=i.findIndex(c=>QW(c,e)>0);s<0?i.push(e):i.splice(s,0,e),e.setup(this._context),this._setEffects(this.effects)}}setProps(e){"effects"in e&&(xa(e.effects,this.effects,1)||this._setEffects(e.effects))}needsRedraw(e={clearRedrawFlags:!1}){const i=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),i}getEffects(){return this._resolvedEffects}_setEffects(e){const i={};for(const c of this.effects)i[c.id]=c;const s=[];for(const c of e){const h=i[c.id];let p=c;h&&h!==c?h.setProps?(h.setProps(c.props),p=h):h.cleanup(this._context):h||c.setup(this._context),s.push(p),delete i[c.id]}for(const c in i)i[c].cleanup(this._context);this.effects=s,this._resolvedEffects=s.concat(this._defaultEffects),e.some(c=>c instanceof oL)||this._resolvedEffects.push(JW),this._needsRedraw="effects changed"}finalize(){for(const e of this._resolvedEffects)e.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class tH extends ME{shouldDrawLayer(e){const{operation:i}=e.props;return i.includes("draw")||i.includes("terrain")}}const iH="deckRenderer.renderLayers";class rH{constructor(e){this.device=e,this.gl=e.gl,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new tH(e),this.pickLayersPass=new cL(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;const i=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,s={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e};s.effects&&this._preRender(s.effects,s);const c=this.lastPostProcessEffect?this.renderBuffers[0]:s.target;this.lastPostProcessEffect&&(s.clearColor=[0,0,0,0],s.clearCanvas=!0);const h=i.render({...s,target:c});s.effects&&this._postRender(s.effects,s),this.renderCount++,Ks(iH,this,h,e)}needsRedraw(e={clearRedrawFlags:!1}){const i=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),i}finalize(){const{renderBuffers:e}=this;for(const i of e)i.delete();e.length=0}_preRender(e,i){this.lastPostProcessEffect=null,i.preRenderStats=i.preRenderStats||{};for(const s of e)i.preRenderStats[s.id]=s.preRender(i),s.postRender&&(this.lastPostProcessEffect=s.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:e}=this,i=this.device.canvasContext.getDrawingBufferSize();e.length===0&&[0,1].map(s=>{const c=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"}});e.push(this.device.createFramebuffer({id:`deck-renderbuffer-${s}`,colorAttachments:[c]}))});for(const s of e)s.resize(i)}_postRender(e,i){const{renderBuffers:s}=this,c={...i,inputBuffer:s[0],swapBuffer:s[1]};for(const h of e)if(h.postRender){c.target=h.id===this.lastPostProcessEffect?i.target:void 0;const p=h.postRender(c);c.inputBuffer=p,c.swapBuffer=p===s[0]?s[1]:s[0]}}}const nH={pickedColor:null,pickedObjectIndex:-1};function sH({pickedColors:t,decodePickingColor:e,deviceX:i,deviceY:s,deviceRadius:c,deviceRect:h}){const{x:p,y:v,width:l,height:A}=h;let P=c*c,O=-1,L=0;for(let U=0;U<A;U++){const H=U+v-s,Y=H*H;if(Y>P)L+=4*l;else for(let J=0;J<l;J++){if(t[L+3]-1>=0){const me=J+p-i,pe=me*me+Y;pe<=P&&(P=pe,O=L)}L+=4}}if(O>=0){const U=t.slice(O,O+4),H=e(U);if(H){const Y=Math.floor(O/4/l),J=O/4-Y*l;return{...H,pickedColor:U,pickedX:p+J,pickedY:v+Y}}jr.error("Picked non-existent layer. Is picking buffer corrupt?")()}return nH}function oH({pickedColors:t,decodePickingColor:e}){const i=new Map;if(t){for(let s=0;s<t.length;s+=4)if(t[s+3]-1>=0){const h=t.slice(s,s+4),p=h.join(",");if(!i.has(p)){const v=e(h);v?i.set(p,{...v,color:h}):jr.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(i.values())}function pL({pickInfo:t,viewports:e,pixelRatio:i,x:s,y:c,z:h}){let p=e[0];e.length>1&&(p=lH((t==null?void 0:t.pickedViewports)||e,{x:s,y:c}));let v;if(p){const l=[s-p.x,c-p.y];h!==void 0&&(l[2]=h),v=p.unproject(l)}return{color:null,layer:null,viewport:p,index:-1,picked:!1,x:s,y:c,pixel:[s,c],coordinate:v,devicePixel:t&&"pickedX"in t?[t.pickedX,t.pickedY]:void 0,pixelRatio:i}}function aH(t){const{pickInfo:e,lastPickedInfo:i,mode:s,layers:c}=t,{pickedColor:h,pickedLayer:p,pickedObjectIndex:v}=e,l=p?[p]:[];if(s==="hover"){const O=i.index,L=i.layerId,U=p?p.props.id:null;if(U!==L||v!==O){if(U!==L){const H=c.find(Y=>Y.props.id===L);H&&l.unshift(H)}i.layerId=U,i.index=v,i.info=null}}const A=pL(t),P=new Map;return P.set(null,A),l.forEach(O=>{let L={...A};O===p&&(L.color=h,L.index=v,L.picked=!0),L=mL({layer:O,info:L,mode:s});const U=L.layer;O===p&&s==="hover"&&(i.info=L),P.set(U.id,L),s==="hover"&&U.updateAutoHighlight(L)}),P}function mL({layer:t,info:e,mode:i}){for(;t&&e;){const s=e.layer||null;e.sourceLayer=s,e.layer=t,e=t.getPickingInfo({info:e,mode:i,sourceLayer:s}),t=t.parent}return e}function lH(t,e){for(let i=t.length-1;i>=0;i--){const s=t[i];if(s.containsPixel(e))return s}return t[0]}class cH{constructor(e){this._pickable=!0,this.device=e,this.pickLayersPass=new cL(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:i,layers:s,viewports:c},h=this.lastPickedInfo.info){const p=h&&h.layer&&h.layer.id,v=h&&h.viewport&&h.viewport.id,l=p?s.find(L=>L.id===p):null,A=v&&c.find(L=>L.id===v)||c[0],P=A&&A.unproject([e-A.x,i-A.y]);return{...h,...{x:e,y:i,viewport:A,coordinate:P,layer:l}}}_resizeBuffer(){var i,s;if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){const c=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=c}const e=this.device.gl;(i=this.pickingFBO)==null||i.resize({width:e.canvas.width,height:e.canvas.height}),(s=this.depthFBO)==null||s.resize({width:e.canvas.width,height:e.canvas.height})}_getPickable(e){if(this._pickable===!1)return null;const i=e.filter(s=>this.pickLayersPass.shouldDrawLayer(s)&&!s.isComposite);return i.length?i:null}_pickClosestObject({layers:e,views:i,viewports:s,x:c,y:h,radius:p=0,depth:v=1,mode:l="query",unproject3D:A,onViewportActive:P,effects:O}){const L=this.device.canvasContext.cssToDeviceRatio(),U=this._getPickable(e);if(!U||s.length===0)return{result:[],emptyInfo:pL({viewports:s,x:c,y:h,pixelRatio:L})};this._resizeBuffer();const H=this.device.canvasContext.cssToDevicePixels([c,h],!0),Y=[H.x+Math.floor(H.width/2),H.y+Math.floor(H.height/2)],J=Math.round(p*L),{width:oe,height:me}=this.pickingFBO,pe=this._getPickingRect({deviceX:Y[0],deviceY:Y[1],deviceRadius:J,deviceWidth:oe,deviceHeight:me}),be={x:c-p,y:h-p,width:p*2+1,height:p*2+1};let Oe;const je=[],st=new Set;for(let ut=0;ut<v;ut++){let xe;if(pe){const Be=this._drawAndSample({layers:U,views:i,viewports:s,onViewportActive:P,deviceRect:pe,cullRect:be,effects:O,pass:`picking:${l}`});xe=sH({...Be,deviceX:Y[0],deviceY:Y[1],deviceRadius:J,deviceRect:pe})}else xe={pickedColor:null,pickedObjectIndex:-1};let it;if(xe.pickedLayer&&A&&this.depthFBO){const{pickedColors:Be}=this._drawAndSample({layers:[xe.pickedLayer],views:i,viewports:s,onViewportActive:P,deviceRect:{x:xe.pickedX,y:xe.pickedY,width:1,height:1},cullRect:be,effects:O,pass:`picking:${l}:z`},!0);Be[3]&&(it=Be[0])}xe.pickedLayer&&ut+1<v&&(st.add(xe.pickedLayer),xe.pickedLayer.disablePickingIndex(xe.pickedObjectIndex)),Oe=aH({pickInfo:xe,lastPickedInfo:this.lastPickedInfo,mode:l,layers:U,viewports:s,x:c,y:h,z:it,pixelRatio:L});for(const Be of Oe.values())Be.layer&&je.push(Be);if(!xe.pickedColor)break}for(const ut of st)ut.restorePickingColors();return{result:je,emptyInfo:Oe.get(null)}}_pickVisibleObjects({layers:e,views:i,viewports:s,x:c,y:h,width:p=1,height:v=1,mode:l="query",maxObjects:A=null,onViewportActive:P,effects:O}){const L=this._getPickable(e);if(!L||s.length===0)return[];this._resizeBuffer();const U=this.device.canvasContext.cssToDeviceRatio(),H=this.device.canvasContext.cssToDevicePixels([c,h],!0),Y=H.x,J=H.y+H.height,oe=this.device.canvasContext.cssToDevicePixels([c+p,h+v],!0),me=oe.x+oe.width,pe=oe.y,be={x:Y,y:pe,width:me-Y,height:J-pe},Oe=this._drawAndSample({layers:L,views:i,viewports:s,onViewportActive:P,deviceRect:be,cullRect:{x:c,y:h,width:p,height:v},effects:O,pass:`picking:${l}`}),je=oH(Oe),st=new Map,ut=[],xe=Number.isFinite(A);for(let it=0;it<je.length&&!(xe&&ut.length>=A);it++){const Be=je[it];let Qe={color:Be.pickedColor,layer:null,index:Be.pickedObjectIndex,picked:!0,x:c,y:h,pixelRatio:U};Qe=mL({layer:Be.pickedLayer,info:Qe,mode:l});const Ct=Qe.layer.id;st.has(Ct)||st.set(Ct,new Set);const Kt=st.get(Ct),Ie=Qe.object??Qe.index;Kt.has(Ie)||(Kt.add(Ie),ut.push(Qe))}return ut}_drawAndSample({layers:e,views:i,viewports:s,onViewportActive:c,deviceRect:h,cullRect:p,effects:v,pass:l},A=!1){const P=A?this.depthFBO:this.pickingFBO,O={layers:e,layerFilter:this.layerFilter,views:i,viewports:s,onViewportActive:c,pickingFBO:P,deviceRect:h,cullRect:p,effects:v,pass:l,pickZ:A,preRenderStats:{}};for(const me of v)me.useInPicking&&(O.preRenderStats[me.id]=me.preRender(O));const{decodePickingColor:L}=this.pickLayersPass.render(O),{x:U,y:H,width:Y,height:J}=h,oe=new(A?Float32Array:Uint8Array)(Y*J*4);return this.device.readPixelsToArrayWebGL(P,{sourceX:U,sourceY:H,sourceWidth:Y,sourceHeight:J,target:oe}),{pickedColors:oe,decodePickingColor:L}}_getPickingRect({deviceX:e,deviceY:i,deviceRadius:s,deviceWidth:c,deviceHeight:h}){const p=Math.max(0,e-s),v=Math.max(0,i-s),l=Math.min(c,e+s+1)-p,A=Math.min(h,i+s+1)-v;return l<=0||A<=0?null:{x:p,y:v,width:l,height:A}}}const uH={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},hH="top-left",wI="__root";class dH{constructor({deck:e,parentElement:i}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=e,this.parentElement=i}getWidgets(){return this.resolvedWidgets}setProps(e){e.widgets&&!xa(e.widgets,this.widgets,1)&&this._setWidgets(e.widgets)}finalize(){for(const e of this.getWidgets())this._remove(e);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(const e in this.containers)this.containers[e].remove()}addDefault(e){this.defaultWidgets.find(i=>i.id===e.id)||(this._add(e),this.defaultWidgets.push(e),this._setWidgets(this.widgets))}_setWidgets(e){const i={};for(const s of this.resolvedWidgets)i[s.id]=s;this.resolvedWidgets.length=0;for(const s of this.defaultWidgets)i[s.id]=null,this.resolvedWidgets.push(s);for(let s of e){const c=i[s.id];c?c.viewId!==s.viewId||c.placement!==s.placement?(this._remove(c),this._add(s)):s!==c&&(c.setProps(s.props),s=c):this._add(s),i[s.id]=null,this.resolvedWidgets.push(s)}for(const s in i){const c=i[s];c&&this._remove(c)}this.widgets=e}_add(e){const{viewId:i=null,placement:s=hH}=e,c=e.onAdd({deck:this.deck,viewId:i});c&&this._getContainer(i,s).append(c),e._element=c}_remove(e){e.onRemove(),e._element&&e._element.remove(),e._element=void 0}_getContainer(e,i){var p;const s=e||wI;let c=this.containers[s];c||(c=document.createElement("div"),c.style.pointerEvents="none",c.style.position="absolute",c.style.overflow="hidden",(p=this.parentElement)==null||p.append(c),this.containers[s]=c);let h=c.querySelector(`.${i}`);return h||(h=document.createElement("div"),h.className=i,h.style.position="absolute",Object.assign(h.style,uH[i]),c.append(h)),h}_updateContainers(){const e=this.deck.width,i=this.deck.height;for(const s in this.containers){const c=this.lastViewports[s]||null,h=s===wI||c,p=this.containers[s];h?(p.style.display="block",p.style.left=`${c?c.x:0}px`,p.style.top=`${c?c.y:0}px`,p.style.width=`${c?c.width:e}px`,p.style.height=`${c?c.height:i}px`):p.style.display="none"}}onRedraw({viewports:e,layers:i}){var h,p;const s=e.reduce((v,l)=>(v[l.id]=l,v),{}),{lastViewports:c}=this;for(const v of this.getWidgets()){const{viewId:l}=v;if(l){const A=s[l];A&&(v.onViewportChange&&!A.equals(c[l])&&v.onViewportChange(A),(h=v.onRedraw)==null||h.call(v,{viewports:[A],layers:i}))}else{if(v.onViewportChange)for(const A of e)A.equals(c[A.id])||v.onViewportChange(A);(p=v.onRedraw)==null||p.call(v,{viewports:e,layers:i})}}this.lastViewports=s,this._updateContainers()}onHover(e,i){var s,c;for(const h of this.getWidgets()){const{viewId:p}=h;(!p||p===((s=e.viewport)==null?void 0:s.id))&&((c=h.onHover)==null||c.call(h,e,i))}}onEvent(e,i){var c,h;const s=lT[i.type];if(s)for(const p of this.getWidgets()){const{viewId:v}=p;(!v||v===((c=e.viewport)==null?void 0:c.id))&&((h=p[s.handler])==null||h.call(p,e,i))}}}const fH={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class pH{constructor(){this.id="default-tooltip",this.placement="fill",this.props={},this.isVisible=!1}onAdd({deck:e}){const i=document.createElement("div");return i.className="deck-tooltip",Object.assign(i.style,fH),this.deck=e,this.element=i,i}onRemove(){this.deck=void 0,this.element=void 0}setProps(){}onViewportChange(e){var i;this.isVisible&&e.id===((i=this.lastViewport)==null?void 0:i.id)&&e!==this.lastViewport&&this.setTooltip(null)}onHover(e){const{deck:i}=this,s=i&&i.props.getTooltip;if(!s)return;const c=s(e);this.lastViewport=e.viewport,this.setTooltip(c,e.x,e.y)}setTooltip(e,i,s){const c=this.element;if(c){if(typeof e=="string")c.innerText=e;else if(e)e.text&&(c.innerText=e.text),e.html&&(c.innerHTML=e.html),e.className&&(c.className=e.className);else{this.isVisible=!1,c.style.display="none";return}this.isVisible=!0,c.style.display="block",c.style.transform=`translate(${i}px, ${s}px)`,e&&typeof e=="object"&&"style"in e&&Object.assign(c.style,e.style)}}}var Zd;(function(t){t[t.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",t[t.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",t[t.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",t[t.POINTS=0]="POINTS",t[t.LINES=1]="LINES",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN",t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_COLOR=768]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",t[t.SRC_ALPHA=770]="SRC_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA=772]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",t[t.DST_COLOR=774]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=32769]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",t[t.FUNC_ADD=32774]="FUNC_ADD",t[t.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",t[t.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",t[t.BLEND_EQUATION=32777]="BLEND_EQUATION",t[t.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",t[t.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",t[t.BLEND_DST_RGB=32968]="BLEND_DST_RGB",t[t.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",t[t.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",t[t.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",t[t.BLEND_COLOR=32773]="BLEND_COLOR",t[t.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",t[t.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",t[t.LINE_WIDTH=2849]="LINE_WIDTH",t[t.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",t[t.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",t[t.CULL_FACE_MODE=2885]="CULL_FACE_MODE",t[t.FRONT_FACE=2886]="FRONT_FACE",t[t.DEPTH_RANGE=2928]="DEPTH_RANGE",t[t.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",t[t.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",t[t.DEPTH_FUNC=2932]="DEPTH_FUNC",t[t.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",t[t.STENCIL_FUNC=2962]="STENCIL_FUNC",t[t.STENCIL_FAIL=2964]="STENCIL_FAIL",t[t.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",t[t.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",t[t.STENCIL_REF=2967]="STENCIL_REF",t[t.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",t[t.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",t[t.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",t[t.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",t[t.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",t[t.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",t[t.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",t[t.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",t[t.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",t[t.VIEWPORT=2978]="VIEWPORT",t[t.SCISSOR_BOX=3088]="SCISSOR_BOX",t[t.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",t[t.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",t[t.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",t[t.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",t[t.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",t[t.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",t[t.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",t[t.RED_BITS=3410]="RED_BITS",t[t.GREEN_BITS=3411]="GREEN_BITS",t[t.BLUE_BITS=3412]="BLUE_BITS",t[t.ALPHA_BITS=3413]="ALPHA_BITS",t[t.DEPTH_BITS=3414]="DEPTH_BITS",t[t.STENCIL_BITS=3415]="STENCIL_BITS",t[t.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",t[t.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",t[t.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",t[t.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",t[t.SAMPLES=32937]="SAMPLES",t[t.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",t[t.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",t[t.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",t[t.VENDOR=7936]="VENDOR",t[t.RENDERER=7937]="RENDERER",t[t.VERSION=7938]="VERSION",t[t.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",t[t.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",t[t.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",t[t.STATIC_DRAW=35044]="STATIC_DRAW",t[t.STREAM_DRAW=35040]="STREAM_DRAW",t[t.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",t[t.BUFFER_SIZE=34660]="BUFFER_SIZE",t[t.BUFFER_USAGE=34661]="BUFFER_USAGE",t[t.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",t[t.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",t[t.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",t[t.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",t[t.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",t[t.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",t[t.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",t[t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",t[t.CULL_FACE=2884]="CULL_FACE",t[t.FRONT=1028]="FRONT",t[t.BACK=1029]="BACK",t[t.FRONT_AND_BACK=1032]="FRONT_AND_BACK",t[t.BLEND=3042]="BLEND",t[t.DEPTH_TEST=2929]="DEPTH_TEST",t[t.DITHER=3024]="DITHER",t[t.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",t[t.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",t[t.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",t[t.SCISSOR_TEST=3089]="SCISSOR_TEST",t[t.STENCIL_TEST=2960]="STENCIL_TEST",t[t.NO_ERROR=0]="NO_ERROR",t[t.INVALID_ENUM=1280]="INVALID_ENUM",t[t.INVALID_VALUE=1281]="INVALID_VALUE",t[t.INVALID_OPERATION=1282]="INVALID_OPERATION",t[t.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",t[t.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",t[t.CW=2304]="CW",t[t.CCW=2305]="CCW",t[t.DONT_CARE=4352]="DONT_CARE",t[t.FASTEST=4353]="FASTEST",t[t.NICEST=4354]="NICEST",t[t.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.INT=5124]="INT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT",t[t.DOUBLE=5130]="DOUBLE",t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.ALPHA=6406]="ALPHA",t[t.RGB=6407]="RGB",t[t.RGBA=6408]="RGBA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",t[t.VERTEX_SHADER=35633]="VERTEX_SHADER",t[t.COMPILE_STATUS=35713]="COMPILE_STATUS",t[t.DELETE_STATUS=35712]="DELETE_STATUS",t[t.LINK_STATUS=35714]="LINK_STATUS",t[t.VALIDATE_STATUS=35715]="VALIDATE_STATUS",t[t.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",t[t.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",t[t.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",t[t.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",t[t.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",t[t.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",t[t.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",t[t.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",t[t.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",t[t.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",t[t.SHADER_TYPE=35663]="SHADER_TYPE",t[t.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",t[t.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",t[t.NEVER=512]="NEVER",t[t.LESS=513]="LESS",t[t.EQUAL=514]="EQUAL",t[t.LEQUAL=515]="LEQUAL",t[t.GREATER=516]="GREATER",t[t.NOTEQUAL=517]="NOTEQUAL",t[t.GEQUAL=518]="GEQUAL",t[t.ALWAYS=519]="ALWAYS",t[t.KEEP=7680]="KEEP",t[t.REPLACE=7681]="REPLACE",t[t.INCR=7682]="INCR",t[t.DECR=7683]="DECR",t[t.INVERT=5386]="INVERT",t[t.INCR_WRAP=34055]="INCR_WRAP",t[t.DECR_WRAP=34056]="DECR_WRAP",t[t.NEAREST=9728]="NEAREST",t[t.LINEAR=9729]="LINEAR",t[t.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",t[t.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",t[t.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",t[t.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",t[t.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",t[t.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",t[t.TEXTURE_2D=3553]="TEXTURE_2D",t[t.TEXTURE=5890]="TEXTURE",t[t.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",t[t.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",t[t.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",t[t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",t[t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",t[t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",t[t.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",t[t.TEXTURE0=33984]="TEXTURE0",t[t.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",t[t.REPEAT=10497]="REPEAT",t[t.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",t[t.TEXTURE_WIDTH=4096]="TEXTURE_WIDTH",t[t.TEXTURE_HEIGHT=4097]="TEXTURE_HEIGHT",t[t.FLOAT_VEC2=35664]="FLOAT_VEC2",t[t.FLOAT_VEC3=35665]="FLOAT_VEC3",t[t.FLOAT_VEC4=35666]="FLOAT_VEC4",t[t.INT_VEC2=35667]="INT_VEC2",t[t.INT_VEC3=35668]="INT_VEC3",t[t.INT_VEC4=35669]="INT_VEC4",t[t.BOOL=35670]="BOOL",t[t.BOOL_VEC2=35671]="BOOL_VEC2",t[t.BOOL_VEC3=35672]="BOOL_VEC3",t[t.BOOL_VEC4=35673]="BOOL_VEC4",t[t.FLOAT_MAT2=35674]="FLOAT_MAT2",t[t.FLOAT_MAT3=35675]="FLOAT_MAT3",t[t.FLOAT_MAT4=35676]="FLOAT_MAT4",t[t.SAMPLER_2D=35678]="SAMPLER_2D",t[t.SAMPLER_CUBE=35680]="SAMPLER_CUBE",t[t.LOW_FLOAT=36336]="LOW_FLOAT",t[t.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",t[t.HIGH_FLOAT=36338]="HIGH_FLOAT",t[t.LOW_INT=36339]="LOW_INT",t[t.MEDIUM_INT=36340]="MEDIUM_INT",t[t.HIGH_INT=36341]="HIGH_INT",t[t.FRAMEBUFFER=36160]="FRAMEBUFFER",t[t.RENDERBUFFER=36161]="RENDERBUFFER",t[t.RGBA4=32854]="RGBA4",t[t.RGB5_A1=32855]="RGB5_A1",t[t.RGB565=36194]="RGB565",t[t.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",t[t.STENCIL_INDEX=6401]="STENCIL_INDEX",t[t.STENCIL_INDEX8=36168]="STENCIL_INDEX8",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL",t[t.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",t[t.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",t[t.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",t[t.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",t[t.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",t[t.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",t[t.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",t[t.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",t[t.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",t[t.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",t[t.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",t[t.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",t[t.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",t[t.NONE=0]="NONE",t[t.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",t[t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",t[t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",t[t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",t[t.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",t[t.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",t[t.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",t[t.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",t[t.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",t[t.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",t[t.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",t[t.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",t[t.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",t[t.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",t[t.READ_BUFFER=3074]="READ_BUFFER",t[t.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",t[t.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",t[t.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",t[t.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",t[t.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",t[t.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",t[t.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",t[t.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",t[t.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",t[t.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",t[t.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",t[t.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",t[t.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",t[t.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",t[t.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",t[t.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",t[t.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",t[t.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",t[t.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",t[t.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",t[t.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",t[t.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",t[t.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",t[t.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",t[t.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",t[t.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",t[t.RED=6403]="RED",t[t.RGB8=32849]="RGB8",t[t.RGBA8=32856]="RGBA8",t[t.RGB10_A2=32857]="RGB10_A2",t[t.TEXTURE_3D=32879]="TEXTURE_3D",t[t.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",t[t.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",t[t.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",t[t.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",t[t.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",t[t.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",t[t.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",t[t.SRGB=35904]="SRGB",t[t.SRGB8=35905]="SRGB8",t[t.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",t[t.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",t[t.RGBA32F=34836]="RGBA32F",t[t.RGB32F=34837]="RGB32F",t[t.RGBA16F=34842]="RGBA16F",t[t.RGB16F=34843]="RGB16F",t[t.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",t[t.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",t[t.R11F_G11F_B10F=35898]="R11F_G11F_B10F",t[t.RGB9_E5=35901]="RGB9_E5",t[t.RGBA32UI=36208]="RGBA32UI",t[t.RGB32UI=36209]="RGB32UI",t[t.RGBA16UI=36214]="RGBA16UI",t[t.RGB16UI=36215]="RGB16UI",t[t.RGBA8UI=36220]="RGBA8UI",t[t.RGB8UI=36221]="RGB8UI",t[t.RGBA32I=36226]="RGBA32I",t[t.RGB32I=36227]="RGB32I",t[t.RGBA16I=36232]="RGBA16I",t[t.RGB16I=36233]="RGB16I",t[t.RGBA8I=36238]="RGBA8I",t[t.RGB8I=36239]="RGB8I",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER",t[t.R8=33321]="R8",t[t.RG8=33323]="RG8",t[t.R16F=33325]="R16F",t[t.R32F=33326]="R32F",t[t.RG16F=33327]="RG16F",t[t.RG32F=33328]="RG32F",t[t.R8I=33329]="R8I",t[t.R8UI=33330]="R8UI",t[t.R16I=33331]="R16I",t[t.R16UI=33332]="R16UI",t[t.R32I=33333]="R32I",t[t.R32UI=33334]="R32UI",t[t.RG8I=33335]="RG8I",t[t.RG8UI=33336]="RG8UI",t[t.RG16I=33337]="RG16I",t[t.RG16UI=33338]="RG16UI",t[t.RG32I=33339]="RG32I",t[t.RG32UI=33340]="RG32UI",t[t.R8_SNORM=36756]="R8_SNORM",t[t.RG8_SNORM=36757]="RG8_SNORM",t[t.RGB8_SNORM=36758]="RGB8_SNORM",t[t.RGBA8_SNORM=36759]="RGBA8_SNORM",t[t.RGB10_A2UI=36975]="RGB10_A2UI",t[t.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",t[t.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.HALF_FLOAT=5131]="HALF_FLOAT",t[t.RG=33319]="RG",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",t[t.CURRENT_QUERY=34917]="CURRENT_QUERY",t[t.QUERY_RESULT=34918]="QUERY_RESULT",t[t.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",t[t.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",t[t.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",t[t.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",t[t.DRAW_BUFFER0=34853]="DRAW_BUFFER0",t[t.DRAW_BUFFER1=34854]="DRAW_BUFFER1",t[t.DRAW_BUFFER2=34855]="DRAW_BUFFER2",t[t.DRAW_BUFFER3=34856]="DRAW_BUFFER3",t[t.DRAW_BUFFER4=34857]="DRAW_BUFFER4",t[t.DRAW_BUFFER5=34858]="DRAW_BUFFER5",t[t.DRAW_BUFFER6=34859]="DRAW_BUFFER6",t[t.DRAW_BUFFER7=34860]="DRAW_BUFFER7",t[t.DRAW_BUFFER8=34861]="DRAW_BUFFER8",t[t.DRAW_BUFFER9=34862]="DRAW_BUFFER9",t[t.DRAW_BUFFER10=34863]="DRAW_BUFFER10",t[t.DRAW_BUFFER11=34864]="DRAW_BUFFER11",t[t.DRAW_BUFFER12=34865]="DRAW_BUFFER12",t[t.DRAW_BUFFER13=34866]="DRAW_BUFFER13",t[t.DRAW_BUFFER14=34867]="DRAW_BUFFER14",t[t.DRAW_BUFFER15=34868]="DRAW_BUFFER15",t[t.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",t[t.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",t[t.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",t[t.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",t[t.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",t[t.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",t[t.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",t[t.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",t[t.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",t[t.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",t[t.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",t[t.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",t[t.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",t[t.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",t[t.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",t[t.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",t[t.SAMPLER_3D=35679]="SAMPLER_3D",t[t.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",t[t.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",t[t.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",t[t.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",t[t.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",t[t.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",t[t.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",t[t.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",t[t.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",t[t.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",t[t.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",t[t.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",t[t.MAX_SAMPLES=36183]="MAX_SAMPLES",t[t.SAMPLER_BINDING=35097]="SAMPLER_BINDING",t[t.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",t[t.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",t[t.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",t[t.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",t[t.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",t[t.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",t[t.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",t[t.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",t[t.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",t[t.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",t[t.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",t[t.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",t[t.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",t[t.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",t[t.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",t[t.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",t[t.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",t[t.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",t[t.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",t[t.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",t[t.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",t[t.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",t[t.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",t[t.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",t[t.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",t[t.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",t[t.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",t[t.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",t[t.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",t[t.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",t[t.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",t[t.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",t[t.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",t[t.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",t[t.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",t[t.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",t[t.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",t[t.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",t[t.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",t[t.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",t[t.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",t[t.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",t[t.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",t[t.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",t[t.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",t[t.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",t[t.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",t[t.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",t[t.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",t[t.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",t[t.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",t[t.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",t[t.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",t[t.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",t[t.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",t[t.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",t[t.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",t[t.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",t[t.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",t[t.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",t[t.UNIFORM_TYPE=35383]="UNIFORM_TYPE",t[t.UNIFORM_SIZE=35384]="UNIFORM_SIZE",t[t.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",t[t.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",t[t.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",t[t.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",t[t.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",t[t.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",t[t.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",t[t.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",t[t.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",t[t.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",t[t.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",t[t.OBJECT_TYPE=37138]="OBJECT_TYPE",t[t.SYNC_CONDITION=37139]="SYNC_CONDITION",t[t.SYNC_STATUS=37140]="SYNC_STATUS",t[t.SYNC_FLAGS=37141]="SYNC_FLAGS",t[t.SYNC_FENCE=37142]="SYNC_FENCE",t[t.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",t[t.UNSIGNALED=37144]="UNSIGNALED",t[t.SIGNALED=37145]="SIGNALED",t[t.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",t[t.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",t[t.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",t[t.WAIT_FAILED=37149]="WAIT_FAILED",t[t.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",t[t.COLOR=6144]="COLOR",t[t.DEPTH=6145]="DEPTH",t[t.STENCIL=6146]="STENCIL",t[t.MIN=32775]="MIN",t[t.MAX=32776]="MAX",t[t.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",t[t.STREAM_READ=35041]="STREAM_READ",t[t.STREAM_COPY=35042]="STREAM_COPY",t[t.STATIC_READ=35045]="STATIC_READ",t[t.STATIC_COPY=35046]="STATIC_COPY",t[t.DYNAMIC_READ=35049]="DYNAMIC_READ",t[t.DYNAMIC_COPY=35050]="DYNAMIC_COPY",t[t.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",t[t.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",t[t.INVALID_INDEX=4294967295]="INVALID_INDEX",t[t.TIMEOUT_IGNORED=-1]="TIMEOUT_IGNORED",t[t.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",t[t.UNMASKED_VENDOR_WEBGL=37445]="UNMASKED_VENDOR_WEBGL",t[t.UNMASKED_RENDERER_WEBGL=37446]="UNMASKED_RENDERER_WEBGL",t[t.MAX_TEXTURE_MAX_ANISOTROPY_EXT=34047]="MAX_TEXTURE_MAX_ANISOTROPY_EXT",t[t.TEXTURE_MAX_ANISOTROPY_EXT=34046]="TEXTURE_MAX_ANISOTROPY_EXT",t[t.R16_EXT=33322]="R16_EXT",t[t.RG16_EXT=33324]="RG16_EXT",t[t.RGB16_EXT=32852]="RGB16_EXT",t[t.RGBA16_EXT=32859]="RGBA16_EXT",t[t.R16_SNORM_EXT=36760]="R16_SNORM_EXT",t[t.RG16_SNORM_EXT=36761]="RG16_SNORM_EXT",t[t.RGB16_SNORM_EXT=36762]="RGB16_SNORM_EXT",t[t.RGBA16_SNORM_EXT=36763]="RGBA16_SNORM_EXT",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RED_RGTC1_EXT=36283]="COMPRESSED_RED_RGTC1_EXT",t[t.COMPRESSED_SIGNED_RED_RGTC1_EXT=36284]="COMPRESSED_SIGNED_RED_RGTC1_EXT",t[t.COMPRESSED_RED_GREEN_RGTC2_EXT=36285]="COMPRESSED_RED_GREEN_RGTC2_EXT",t[t.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT=36286]="COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT",t[t.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",t[t.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=36493]="COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT",t[t.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT=36494]="COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT",t[t.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37493]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ETC2=37494]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37495]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37496]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37497]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_RGB_ATC_WEBGL=35986]="COMPRESSED_RGB_ATC_WEBGL",t[t.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",t[t.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR",t[t.QUERY_COUNTER_BITS_EXT=34916]="QUERY_COUNTER_BITS_EXT",t[t.CURRENT_QUERY_EXT=34917]="CURRENT_QUERY_EXT",t[t.QUERY_RESULT_EXT=34918]="QUERY_RESULT_EXT",t[t.QUERY_RESULT_AVAILABLE_EXT=34919]="QUERY_RESULT_AVAILABLE_EXT",t[t.TIME_ELAPSED_EXT=35007]="TIME_ELAPSED_EXT",t[t.TIMESTAMP_EXT=36392]="TIMESTAMP_EXT",t[t.GPU_DISJOINT_EXT=36795]="GPU_DISJOINT_EXT",t[t.COMPLETION_STATUS_KHR=37297]="COMPLETION_STATUS_KHR",t[t.DEPTH_CLAMP_EXT=34383]="DEPTH_CLAMP_EXT",t[t.FIRST_VERTEX_CONVENTION_WEBGL=36429]="FIRST_VERTEX_CONVENTION_WEBGL",t[t.LAST_VERTEX_CONVENTION_WEBGL=36430]="LAST_VERTEX_CONVENTION_WEBGL",t[t.PROVOKING_VERTEX_WEBL=36431]="PROVOKING_VERTEX_WEBL",t[t.POLYGON_MODE_WEBGL=2880]="POLYGON_MODE_WEBGL",t[t.POLYGON_OFFSET_LINE_WEBGL=10754]="POLYGON_OFFSET_LINE_WEBGL",t[t.LINE_WEBGL=6913]="LINE_WEBGL",t[t.FILL_WEBGL=6914]="FILL_WEBGL",t[t.MAX_CLIP_DISTANCES_WEBGL=3378]="MAX_CLIP_DISTANCES_WEBGL",t[t.MAX_CULL_DISTANCES_WEBGL=33529]="MAX_CULL_DISTANCES_WEBGL",t[t.MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL=33530]="MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL",t[t.CLIP_DISTANCE0_WEBGL=12288]="CLIP_DISTANCE0_WEBGL",t[t.CLIP_DISTANCE1_WEBGL=12289]="CLIP_DISTANCE1_WEBGL",t[t.CLIP_DISTANCE2_WEBGL=12290]="CLIP_DISTANCE2_WEBGL",t[t.CLIP_DISTANCE3_WEBGL=12291]="CLIP_DISTANCE3_WEBGL",t[t.CLIP_DISTANCE4_WEBGL=12292]="CLIP_DISTANCE4_WEBGL",t[t.CLIP_DISTANCE5_WEBGL=12293]="CLIP_DISTANCE5_WEBGL",t[t.CLIP_DISTANCE6_WEBGL=12294]="CLIP_DISTANCE6_WEBGL",t[t.CLIP_DISTANCE7_WEBGL=12295]="CLIP_DISTANCE7_WEBGL",t[t.POLYGON_OFFSET_CLAMP_EXT=36379]="POLYGON_OFFSET_CLAMP_EXT",t[t.LOWER_LEFT_EXT=36001]="LOWER_LEFT_EXT",t[t.UPPER_LEFT_EXT=36002]="UPPER_LEFT_EXT",t[t.NEGATIVE_ONE_TO_ONE_EXT=37726]="NEGATIVE_ONE_TO_ONE_EXT",t[t.ZERO_TO_ONE_EXT=37727]="ZERO_TO_ONE_EXT",t[t.CLIP_ORIGIN_EXT=37724]="CLIP_ORIGIN_EXT",t[t.CLIP_DEPTH_MODE_EXT=37725]="CLIP_DEPTH_MODE_EXT",t[t.SRC1_COLOR_WEBGL=35065]="SRC1_COLOR_WEBGL",t[t.SRC1_ALPHA_WEBGL=34185]="SRC1_ALPHA_WEBGL",t[t.ONE_MINUS_SRC1_COLOR_WEBGL=35066]="ONE_MINUS_SRC1_COLOR_WEBGL",t[t.ONE_MINUS_SRC1_ALPHA_WEBGL=35067]="ONE_MINUS_SRC1_ALPHA_WEBGL",t[t.MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL=35068]="MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL",t[t.MIRROR_CLAMP_TO_EDGE_EXT=34627]="MIRROR_CLAMP_TO_EDGE_EXT"})(Zd||(Zd={}));const CE={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,35725:null,36006:null,36007:null,34229:null,34964:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32926:!1,32928:!1,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],36389:null,36662:null,36663:null,35053:null,35055:null,35723:4352,36010:null,35977:!1,3333:4,3317:4,37440:!1,37441:!1,37443:37444,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},bs=(t,e,i)=>e?t.enable(i):t.disable(i),TI=(t,e,i)=>t.hint(i,e),ko=(t,e,i)=>t.pixelStorei(i,e),EI=(t,e,i)=>{const s=i===36006?36009:36008;return t.bindFramebuffer(s,e)},Dm=(t,e,i)=>{const c={34964:34962,36662:36662,36663:36663,35053:35051,35055:35052}[i];t.bindBuffer(c,e)};function Ub(t){return Array.isArray(t)||ArrayBuffer.isView(t)&&!(t instanceof DataView)}const mH={3042:bs,32773:(t,e)=>t.blendColor(...e),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(t,e)=>t.clearColor(...e),3107:(t,e)=>t.colorMask(...e),2884:bs,2885:(t,e)=>t.cullFace(e),2929:bs,2931:(t,e)=>t.clearDepth(e),2932:(t,e)=>t.depthFunc(e),2928:(t,e)=>t.depthRange(...e),2930:(t,e)=>t.depthMask(e),3024:bs,35723:TI,35725:(t,e)=>t.useProgram(e),36007:(t,e)=>t.bindRenderbuffer(36161,e),36389:(t,e)=>{var i;return(i=t.bindTransformFeedback)==null?void 0:i.call(t,36386,e)},34229:(t,e)=>t.bindVertexArray(e),36006:EI,36010:EI,34964:Dm,36662:Dm,36663:Dm,35053:Dm,35055:Dm,2886:(t,e)=>t.frontFace(e),33170:TI,2849:(t,e)=>t.lineWidth(e),32823:bs,32824:"polygonOffset",10752:"polygonOffset",35977:bs,32926:bs,32928:bs,32938:"sampleCoverage",32939:"sampleCoverage",3089:bs,3088:(t,e)=>t.scissor(...e),2960:bs,2961:(t,e)=>t.clearStencil(e),2968:(t,e)=>t.stencilMaskSeparate(1028,e),36005:(t,e)=>t.stencilMaskSeparate(1029,e),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(t,e)=>t.viewport(...e),34383:bs,10754:bs,12288:bs,12289:bs,12290:bs,12291:bs,12292:bs,12293:bs,12294:bs,12295:bs,3333:ko,3317:ko,37440:ko,37441:ko,37443:ko,3330:ko,3332:ko,3331:ko,3314:ko,32878:ko,3316:ko,3315:ko,32877:ko,framebuffer:(t,e)=>{const i=e&&"handle"in e?e.handle:e;return t.bindFramebuffer(36160,i)},blend:(t,e)=>e?t.enable(3042):t.disable(3042),blendColor:(t,e)=>t.blendColor(...e),blendEquation:(t,e)=>{const i=typeof e=="number"?[e,e]:e;t.blendEquationSeparate(...i)},blendFunc:(t,e)=>{const i=(e==null?void 0:e.length)===2?[...e,...e]:e;t.blendFuncSeparate(...i)},clearColor:(t,e)=>t.clearColor(...e),clearDepth:(t,e)=>t.clearDepth(e),clearStencil:(t,e)=>t.clearStencil(e),colorMask:(t,e)=>t.colorMask(...e),cull:(t,e)=>e?t.enable(2884):t.disable(2884),cullFace:(t,e)=>t.cullFace(e),depthTest:(t,e)=>e?t.enable(2929):t.disable(2929),depthFunc:(t,e)=>t.depthFunc(e),depthMask:(t,e)=>t.depthMask(e),depthRange:(t,e)=>t.depthRange(...e),dither:(t,e)=>e?t.enable(3024):t.disable(3024),derivativeHint:(t,e)=>{t.hint(35723,e)},frontFace:(t,e)=>t.frontFace(e),mipmapHint:(t,e)=>t.hint(33170,e),lineWidth:(t,e)=>t.lineWidth(e),polygonOffsetFill:(t,e)=>e?t.enable(32823):t.disable(32823),polygonOffset:(t,e)=>t.polygonOffset(...e),sampleCoverage:(t,e)=>t.sampleCoverage(...e),scissorTest:(t,e)=>e?t.enable(3089):t.disable(3089),scissor:(t,e)=>t.scissor(...e),stencilTest:(t,e)=>e?t.enable(2960):t.disable(2960),stencilMask:(t,e)=>{e=Ub(e)?e:[e,e];const[i,s]=e;t.stencilMaskSeparate(1028,i),t.stencilMaskSeparate(1029,s)},stencilFunc:(t,e)=>{e=Ub(e)&&e.length===3?[...e,...e]:e;const[i,s,c,h,p,v]=e;t.stencilFuncSeparate(1028,i,s,c),t.stencilFuncSeparate(1029,h,p,v)},stencilOp:(t,e)=>{e=Ub(e)&&e.length===3?[...e,...e]:e;const[i,s,c,h,p,v]=e;t.stencilOpSeparate(1028,i,s,c),t.stencilOpSeparate(1029,h,p,v)},viewport:(t,e)=>t.viewport(...e)};function cs(t,e,i){return e[t]!==void 0?e[t]:i[t]}const _H={blendEquation:(t,e,i)=>t.blendEquationSeparate(cs(32777,e,i),cs(34877,e,i)),blendFunc:(t,e,i)=>t.blendFuncSeparate(cs(32969,e,i),cs(32968,e,i),cs(32971,e,i),cs(32970,e,i)),polygonOffset:(t,e,i)=>t.polygonOffset(cs(32824,e,i),cs(10752,e,i)),sampleCoverage:(t,e,i)=>t.sampleCoverage(cs(32938,e,i),cs(32939,e,i)),stencilFuncFront:(t,e,i)=>t.stencilFuncSeparate(1028,cs(2962,e,i),cs(2967,e,i),cs(2963,e,i)),stencilFuncBack:(t,e,i)=>t.stencilFuncSeparate(1029,cs(34816,e,i),cs(36003,e,i),cs(36004,e,i)),stencilOpFront:(t,e,i)=>t.stencilOpSeparate(1028,cs(2964,e,i),cs(2965,e,i),cs(2966,e,i)),stencilOpBack:(t,e,i)=>t.stencilOpSeparate(1029,cs(34817,e,i),cs(34818,e,i),cs(34819,e,i))},SI={enable:(t,e)=>t({[e]:!0}),disable:(t,e)=>t({[e]:!1}),pixelStorei:(t,e,i)=>t({[e]:i}),hint:(t,e,i)=>t({[e]:i}),useProgram:(t,e)=>t({35725:e}),bindRenderbuffer:(t,e,i)=>t({36007:i}),bindTransformFeedback:(t,e,i)=>t({36389:i}),bindVertexArray:(t,e)=>t({34229:e}),bindFramebuffer:(t,e,i)=>{switch(e){case 36160:return t({36006:i,36010:i});case 36009:return t({36006:i});case 36008:return t({36010:i});default:return null}},bindBuffer:(t,e,i)=>{const s={34962:[34964],36662:[36662],36663:[36663],35051:[35053],35052:[35055]}[e];return s?t({[s]:i}):{valueChanged:!0}},blendColor:(t,e,i,s,c)=>t({32773:new Float32Array([e,i,s,c])}),blendEquation:(t,e)=>t({32777:e,34877:e}),blendEquationSeparate:(t,e,i)=>t({32777:e,34877:i}),blendFunc:(t,e,i)=>t({32969:e,32968:i,32971:e,32970:i}),blendFuncSeparate:(t,e,i,s,c)=>t({32969:e,32968:i,32971:s,32970:c}),clearColor:(t,e,i,s,c)=>t({3106:new Float32Array([e,i,s,c])}),clearDepth:(t,e)=>t({2931:e}),clearStencil:(t,e)=>t({2961:e}),colorMask:(t,e,i,s,c)=>t({3107:[e,i,s,c]}),cullFace:(t,e)=>t({2885:e}),depthFunc:(t,e)=>t({2932:e}),depthRange:(t,e,i)=>t({2928:new Float32Array([e,i])}),depthMask:(t,e)=>t({2930:e}),frontFace:(t,e)=>t({2886:e}),lineWidth:(t,e)=>t({2849:e}),polygonOffset:(t,e,i)=>t({32824:e,10752:i}),sampleCoverage:(t,e,i)=>t({32938:e,32939:i}),scissor:(t,e,i,s,c)=>t({3088:new Int32Array([e,i,s,c])}),stencilMask:(t,e)=>t({2968:e,36005:e}),stencilMaskSeparate:(t,e,i)=>t({[e===1028?2968:36005]:i}),stencilFunc:(t,e,i,s)=>t({2962:e,2967:i,2963:s,34816:e,36003:i,36004:s}),stencilFuncSeparate:(t,e,i,s,c)=>t({[e===1028?2962:34816]:i,[e===1028?2967:36003]:s,[e===1028?2963:36004]:c}),stencilOp:(t,e,i,s)=>t({2964:e,2965:i,2966:s,34817:e,34818:i,34819:s}),stencilOpSeparate:(t,e,i,s,c)=>t({[e===1028?2964:34817]:i,[e===1028?2965:34818]:s,[e===1028?2966:34819]:c}),viewport:(t,e,i,s,c)=>t({2978:[e,i,s,c]})},Xa=(t,e)=>t.isEnabled(e),AI={3042:Xa,2884:Xa,2929:Xa,3024:Xa,32823:Xa,32926:Xa,32928:Xa,3089:Xa,2960:Xa,35977:Xa},gH=new Set([34016,36388,36387,35983,35368,34965,35739,35738,3074,34853,34854,34855,34856,34857,34858,34859,34860,34861,34862,34863,34864,34865,34866,34867,34868,35097,32873,35869,32874,34068]);function Of(t,e){if(vH(e))return;const i={};for(const c in e){const h=Number(c),p=mH[c];p&&(typeof p=="string"?i[p]=!0:p(t,e[c],h))}const s=t.state&&t.state.cache;if(s)for(const c in i){const h=_H[c];h(t,e,s)}}function _L(t,e=CE){if(typeof e=="number"){const c=e,h=AI[c];return h?h(t,c):t.getParameter(c)}const i=Array.isArray(e)?e:Object.keys(e),s={};for(const c of i){const h=AI[c];s[c]=h?h(t,Number(c)):t.getParameter(Number(c))}return s}function yH(t){Of(t,CE)}function vH(t){for(const e in t)return!1;return!0}function xH(t,e){if(t===e)return!0;const i=Array.isArray(t)||ArrayBuffer.isView(t),s=Array.isArray(e)||ArrayBuffer.isView(e);if(i&&s&&t.length===e.length){for(let c=0;c<t.length;++c)if(t[c]!==e[c])return!1;return!0}return!1}class bH{constructor(e,{copyState:i=!1,log:s=()=>{}}={}){fe(this,"gl");fe(this,"program",null);fe(this,"stateStack",[]);fe(this,"enable",!0);fe(this,"cache");fe(this,"log");this.gl=e,this.cache=i?_L(e):Object.assign({},CE),this.log=s,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(e={}){this.stateStack.push({})}pop(){Bn(this.stateStack.length>0);const e=this.stateStack[this.stateStack.length-1];Of(this.gl,e),this.stateStack.pop()}_updateCache(e){let i=!1,s;const c=this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null;for(const h in e){Bn(h!==void 0);const p=e[h],v=this.cache[h];xH(p,v)||(i=!0,s=v,c&&!(h in c)&&(c[h]=v),this.cache[h]=p)}return{valueChanged:i,oldValue:s}}}function Ah(t){return t.state}function gL(t,e){const{enable:i=!0,copyState:s}=e;if(Bn(s!==void 0),!t.state){t.state=new bH(t,{copyState:s}),TH(t);for(const h in SI){const p=SI[h];wH(t,h,p)}MI(t,"getParameter"),MI(t,"isEnabled")}const c=Ah(t);return c.enable=i,t}function f1(t){let e=Ah(t);e||(gL(t,{copyState:!1}),e=Ah(t)),e.push()}function P_(t){const e=Ah(t);Bn(e),e.pop()}function MI(t,e){const i=t[e].bind(t);t[e]=function(c){if(c===void 0||gH.has(c))return i(c);const h=Ah(t);return c in h.cache||(h.cache[c]=i(c)),h.enable?h.cache[c]:i(c)},Object.defineProperty(t[e],"name",{value:`${e}-from-cache`,configurable:!1})}function wH(t,e,i){if(!t[e])return;const s=t[e].bind(t);t[e]=function(...h){const p=Ah(t),{valueChanged:v,oldValue:l}=i(p._updateCache,...h);return v&&s(...h),l},Object.defineProperty(t[e],"name",{value:`${e}-to-cache`,configurable:!1})}function TH(t){const e=t.useProgram.bind(t);t.useProgram=function(s){const c=Ah(t);c.program!==s&&(e(s),c.program=s)}}const EH={powerPreference:"high-performance",onContextLost:()=>console.error("WebGL context lost"),onContextRestored:()=>console.info("WebGL context restored")};function SH(t,e){e={...EH,...e};let i=null;const s=h=>i=h.statusMessage||i;t.addEventListener("webglcontextcreationerror",s,!1);let c=null;if(c||(c=t.getContext("webgl2",e)),t.removeEventListener("webglcontextcreationerror",s,!1),!c)throw new Error(`Failed to create WebGL context: ${i||"Unknown error"}`);if(e.onContextLost){const{onContextLost:h}=e;t.addEventListener("webglcontextlost",p=>h(p),!1)}if(e.onContextRestored){const{onContextRestored:h}=e;t.addEventListener("webglcontextrestored",p=>h(p),!1)}return c}function Wc(t,e,i){return i[e]===void 0&&(i[e]=t.getExtension(e)||null),i[e]}function AH(t,e){const i=t.getParameter(7936),s=t.getParameter(7937);Wc(t,"WEBGL_debug_renderer_info",e);const c=e.WEBGL_debug_renderer_info,h=t.getParameter(c?c.UNMASKED_VENDOR_WEBGL:7936),p=t.getParameter(c?c.UNMASKED_RENDERER_WEBGL:7937),v=h||i,l=p||s,A=t.getParameter(7938),P=yL(v,l),O=MH(v,l),L=CH(v,l);return{type:"webgl",gpu:P,gpuType:L,gpuBackend:O,vendor:v,renderer:l,version:A,shadingLanguage:"glsl",shadingLanguageVersion:300}}function yL(t,e){return/NVIDIA/i.exec(t)||/NVIDIA/i.exec(e)?"nvidia":/INTEL/i.exec(t)||/INTEL/i.exec(e)?"intel":/Apple/i.exec(t)||/Apple/i.exec(e)?"apple":/AMD/i.exec(t)||/AMD/i.exec(e)||/ATI/i.exec(t)||/ATI/i.exec(e)?"amd":/SwiftShader/i.exec(t)||/SwiftShader/i.exec(e)?"software":"unknown"}function MH(t,e){return/Metal/i.exec(t)||/Metal/i.exec(e)?"metal":/ANGLE/i.exec(t)||/ANGLE/i.exec(e)?"opengl":"unknown"}function CH(t,e){if(/SwiftShader/i.exec(t)||/SwiftShader/i.exec(e))return"cpu";switch(yL(t,e)){case"intel":return"integrated";case"software":return"cpu";case"unknown":return"unknown";default:return"discrete"}}function vL(t){switch(t){case"uint8":return 5121;case"sint8":return 5120;case"unorm8":return 5121;case"snorm8":return 5120;case"uint16":return 5123;case"sint16":return 5122;case"unorm16":return 5123;case"snorm16":return 5122;case"uint32":return 5125;case"sint32":return 5124;case"float16":return 5131;case"float32":return 5126}throw new Error(String(t))}const Zs="texture-compression-bc",En="texture-compression-astc",Za="texture-compression-etc2",PH="texture-compression-etc1-webgl",o0="texture-compression-pvrtc-webgl",Vb="texture-compression-atc-webgl",Lm="float32-renderable-webgl",jb="float16-renderable-webgl",IH="rgb9e5ufloat_renderable-webgl",$b="snorm8-renderable-webgl",Nm="norm16-renderable-webgl",Wb="snorm16-renderable-webgl",a0="float32-filterable",CI="float16-filterable-webgl",Ym="WEBGL_compressed_texture_s3tc",Km="WEBGL_compressed_texture_s3tc_srgb",Yd="EXT_texture_compression_rgtc",Kd="EXT_texture_compression_bptc",RH="WEBGL_compressed_texture_etc",OH="WEBGL_compressed_texture_astc",kH="WEBGL_compressed_texture_etc1",DH="WEBGL_compressed_texture_pvrtc",LH="WEBGL_compressed_texture_atc",PI="EXT_texture_norm16",II="EXT_render_snorm",NH="EXT_color_buffer_float",PE={"float32-renderable-webgl":["EXT_color_buffer_float"],"float16-renderable-webgl":["EXT_color_buffer_half_float"],"rgb9e5ufloat_renderable-webgl":["WEBGL_render_shared_exponent"],"snorm8-renderable-webgl":[II],"norm16-renderable-webgl":[PI],"snorm16-renderable-webgl":[PI,II],"float32-filterable":["OES_texture_float_linear"],"float16-filterable-webgl":["OES_texture_half_float_linear"],"texture-filterable-anisotropic-webgl":["EXT_texture_filter_anisotropic"],"texture-blend-float-webgl":["EXT_float_blend"],"texture-compression-bc":[Ym,Km,Yd,Kd],"texture-compression-bc5-webgl":[Yd],"texture-compression-bc7-webgl":[Kd],"texture-compression-etc2":[RH],"texture-compression-astc":[OH],"texture-compression-etc1-webgl":[kH],"texture-compression-pvrtc-webgl":[DH],"texture-compression-atc-webgl":[LH]};function FH(t){return t in PE}function BH(t,e,i){return(PE[e]||[]).every(c=>Wc(t,c,i))}const p1={"rgb8unorm-unsized":{gl:6407,b:4,c:2,bpp:4,dataFormat:6407,types:[5121,33635]},"rgba8unorm-unsized":{gl:6408,b:4,c:2,bpp:4,dataFormat:6408,types:[5121,32819,32820]},r8unorm:{gl:33321,b:1,c:1,rb:!0},r8snorm:{gl:36756,b:1,c:1,render:$b},r8uint:{gl:33330,b:1,c:1,rb:!0},r8sint:{gl:33329,b:1,c:1,rb:!0},rg8unorm:{gl:33323,b:2,c:2,rb:!0},rg8snorm:{gl:36757,b:2,c:2,render:$b},rg8uint:{gl:33336,b:2,c:2,rb:!0},rg8sint:{gl:33335,b:2,c:2,rb:!0},r16uint:{gl:33332,b:2,c:1,rb:!0},r16sint:{gl:33331,b:2,c:1,rb:!0},r16float:{gl:33325,b:2,c:1,render:jb,filter:"float16-filterable-webgl",rb:!0},"r16unorm-webgl":{gl:33322,b:2,c:1,f:Nm,rb:!0},"r16snorm-webgl":{gl:36760,b:2,c:1,f:Wb},"rgba4unorm-webgl":{gl:32854,b:2,c:4,wgpu:!1,rb:!0},"rgb565unorm-webgl":{gl:36194,b:2,c:4,wgpu:!1,rb:!0},"rgb5a1unorm-webgl":{gl:32855,b:2,c:4,wgpu:!1,rb:!0},"rgb8unorm-webgl":{gl:32849,b:3,c:3,wgpu:!1},"rgb8snorm-webgl":{gl:36758,b:3,c:3,wgpu:!1},rgba8unorm:{gl:32856,b:4,c:2,bpp:4},"rgba8unorm-srgb":{gl:35907,b:4,c:4,bpp:4},rgba8snorm:{gl:36759,b:4,c:4,render:$b},rgba8uint:{gl:36220,b:4,c:4,bpp:4},rgba8sint:{gl:36238,b:4,c:4,bpp:4},bgra8unorm:{b:4,c:4},"bgra8unorm-srgb":{b:4,c:4},rg16uint:{gl:33338,b:4,c:1,bpp:4},rg16sint:{gl:33337,b:4,c:2,bpp:4},rg16float:{gl:33327,bpp:4,b:4,c:2,render:jb,filter:CI,rb:!0},"rg16unorm-webgl":{gl:33324,b:2,c:2,render:Nm},"rg16snorm-webgl":{gl:36761,b:2,c:2,render:Wb},r32uint:{gl:33334,b:4,c:1,bpp:4,rb:!0},r32sint:{gl:33333,b:4,c:1,bpp:4,rb:!0},r32float:{gl:33326,bpp:4,b:4,c:1,render:Lm,filter:a0},rgb9e5ufloat:{gl:35901,b:4,c:3,p:1,render:IH},rg11b10ufloat:{gl:35898,b:4,c:3,p:1,render:Lm,rb:!0},rgb10a2unorm:{gl:32857,b:4,c:4,p:1,rb:!0},"rgb10a2uint-webgl":{b:4,c:4,gl:36975,p:1,wgpu:!1,bpp:4,rb:!0},"rgb16unorm-webgl":{gl:32852,b:2,c:3,f:Nm},"rgb16snorm-webgl":{gl:36762,b:2,c:3,f:Nm},rg32uint:{gl:33340,b:8,c:2,rb:!0},rg32sint:{gl:33339,b:8,c:2,rb:!0},rg32float:{gl:33328,b:8,c:2,render:Lm,filter:a0,rb:!0},rgba16uint:{gl:36214,b:8,c:4,rb:!0},rgba16sint:{gl:36232,b:8,c:4,rb:!0},rgba16float:{gl:34842,b:8,c:4,render:jb,filter:CI},"rgba16unorm-webgl":{gl:32859,b:2,c:4,render:Nm,rb:!0},"rgba16snorm-webgl":{gl:36763,b:2,c:4,render:Wb},"rgb32float-webgl":{gl:34837,render:Lm,filter:a0,gl2ext:NH,dataFormat:6407,types:[5126]},rgba32uint:{gl:36208,b:16,c:4,rb:!0},rgba32sint:{gl:36226,b:16,c:4,rb:!0},rgba32float:{gl:34836,b:16,c:4,render:Lm,filter:a0,rb:!0},stencil8:{gl:36168,b:1,c:1,attachment:36128,rb:!0},depth16unorm:{gl:33189,b:2,c:1,attachment:36096,dataFormat:6402,types:[5123],rb:!0},depth24plus:{gl:33190,b:3,c:1,attachment:36096,dataFormat:6402,types:[5125]},depth32float:{gl:36012,b:4,c:1,attachment:36096,dataFormat:6402,types:[5126],rb:!0},"depth24plus-stencil8":{gl:35056,b:4,c:2,p:1,attachment:33306,rb:!0,depthTexture:!0,dataFormat:34041,types:[34042]},"depth24unorm-stencil8":{gl:35056,b:4,c:2,p:1,attachment:33306,dataFormat:34041,types:[34042],rb:!0},"depth32float-stencil8":{gl:36013,b:5,c:2,p:1,attachment:33306,dataFormat:34041,types:[36269],rb:!0},"bc1-rgb-unorm-webgl":{gl:33776,x:Ym,f:Zs},"bc1-rgb-unorm-srgb-webgl":{gl:35916,x:Km,f:Zs},"bc1-rgba-unorm":{gl:33777,x:Ym,f:Zs},"bc1-rgba-unorm-srgb":{gl:35916,x:Km,f:Zs},"bc2-rgba-unorm":{gl:33778,x:Ym,f:Zs},"bc2-rgba-unorm-srgb":{gl:35918,x:Km,f:Zs},"bc3-rgba-unorm":{gl:33779,x:Ym,f:Zs},"bc3-rgba-unorm-srgb":{gl:35919,x:Km,f:Zs},"bc4-r-unorm":{gl:36283,x:Yd,f:Zs},"bc4-r-snorm":{gl:36284,x:Yd,f:Zs},"bc5-rg-unorm":{gl:36285,x:Yd,f:Zs},"bc5-rg-snorm":{gl:36286,x:Yd,f:Zs},"bc6h-rgb-ufloat":{gl:36495,x:Kd,f:Zs},"bc6h-rgb-float":{gl:36494,x:Kd,f:Zs},"bc7-rgba-unorm":{gl:36492,x:Kd,f:Zs},"bc7-rgba-unorm-srgb":{gl:36493,x:Kd,f:Zs},"etc2-rgb8unorm":{gl:37492,f:Za},"etc2-rgb8unorm-srgb":{gl:37494,f:Za},"etc2-rgb8a1unorm":{gl:37496,f:Za},"etc2-rgb8a1unorm-srgb":{gl:37497,f:Za},"etc2-rgba8unorm":{gl:37493,f:Za},"etc2-rgba8unorm-srgb":{gl:37495,f:Za},"eac-r11unorm":{gl:37488,f:Za},"eac-r11snorm":{gl:37489,f:Za},"eac-rg11unorm":{gl:37490,f:Za},"eac-rg11snorm":{gl:37491,f:Za},"astc-4x4-unorm":{gl:37808,f:En},"astc-4x4-unorm-srgb":{gl:37840,f:En},"astc-5x4-unorm":{gl:37809,f:En},"astc-5x4-unorm-srgb":{gl:37841,f:En},"astc-5x5-unorm":{gl:37810,f:En},"astc-5x5-unorm-srgb":{gl:37842,f:En},"astc-6x5-unorm":{gl:37811,f:En},"astc-6x5-unorm-srgb":{gl:37843,f:En},"astc-6x6-unorm":{gl:37812,f:En},"astc-6x6-unorm-srgb":{gl:37844,f:En},"astc-8x5-unorm":{gl:37813,f:En},"astc-8x5-unorm-srgb":{gl:37845,f:En},"astc-8x6-unorm":{gl:37814,f:En},"astc-8x6-unorm-srgb":{gl:37846,f:En},"astc-8x8-unorm":{gl:37815,f:En},"astc-8x8-unorm-srgb":{gl:37847,f:En},"astc-10x5-unorm":{gl:37819,f:En},"astc-10x5-unorm-srgb":{gl:37851,f:En},"astc-10x6-unorm":{gl:37817,f:En},"astc-10x6-unorm-srgb":{gl:37849,f:En},"astc-10x8-unorm":{gl:37818,f:En},"astc-10x8-unorm-srgb":{gl:37850,f:En},"astc-10x10-unorm":{gl:37819,f:En},"astc-10x10-unorm-srgb":{gl:37851,f:En},"astc-12x10-unorm":{gl:37820,f:En},"astc-12x10-unorm-srgb":{gl:37852,f:En},"astc-12x12-unorm":{gl:37821,f:En},"astc-12x12-unorm-srgb":{gl:37853,f:En},"pvrtc-rgb4unorm-webgl":{gl:35840,f:o0},"pvrtc-rgba4unorm-webgl":{gl:35842,f:o0},"pvrtc-rbg2unorm-webgl":{gl:35841,f:o0},"pvrtc-rgba2unorm-webgl":{gl:35843,f:o0},"etc1-rbg-unorm-webgl":{gl:36196,f:PH},"atc-rgb-unorm-webgl":{gl:35986,f:Vb},"atc-rgba-unorm-webgl":{gl:35986,f:Vb},"atc-rgbai-unorm-webgl":{gl:34798,f:Vb}},zH={6403:1,36244:1,33319:2,33320:2,6407:3,36248:3,6408:4,36249:4,6402:1,34041:1,6406:1,6409:1,6410:2},UH={5126:4,5125:4,5124:4,5123:2,5122:2,5131:2,5120:1,5121:1};function IE(t,e,i){const s=p1[e];if(!s||s.gl===void 0)return!1;const c=s.x||s.gl2ext;return c?!!Wc(t,c,i):!0}function xL(t){const e=p1[t],i=e==null?void 0:e.gl;if(i===void 0)throw new Error(`Unsupported texture format ${t}`);return i}function VH(t,e,i){if(!IE(t,e,i)||e.startsWith("depth")||e.startsWith("stencil"))return!1;try{if(_D(e).signed)return!1}catch{return!1}return e.endsWith("32float")?!!Wc(t,"OES_texture_float_linear, extensions",i):e.endsWith("16float")?!!Wc(t,"OES_texture_half_float_linear, extensions",i):!0}function jH(t,e,i){return!(!IE(t,e,i)||typeof e=="number")}function dv(t){var c;const e=p1[t],i=xL(t),s=_D(t);return{format:i,dataFormat:(e==null?void 0:e.dataFormat)||WH(s.format,s.integer,s.normalized,i),type:s.dataType?vL(s.dataType):((c=e==null?void 0:e.types)==null?void 0:c[0])||5121,compressed:s.compressed}}function $H(t){const e=p1[t];if(!(e!=null&&e.attachment))throw new Error(`${t} is not a depth stencil format`);return e.attachment}function RI(t){const e=dv(t),i=zH[e.dataFormat]||4,s=UH[e.type]||1;return i*s}function WH(t,e,i,s){if(s===6408||s===6407)return s;switch(t){case"r":return e&&!i?36244:6403;case"rg":return e&&!i?33320:33319;case"rgb":return e&&!i?36248:6407;case"rgba":return e&&!i?36249:6408;default:return 6408}}const OI={"depth-clip-control":"EXT_depth_clamp","timer-query-webgl":"EXT_disjoint_timer_query_webgl2","compilation-status-async-webgl":"KHR_parallel_shader_compile","polygon-mode-webgl":"WEBGL_polygon_mode","provoking-vertex-webgl":"WEBGL_provoking_vertex","shader-clip-cull-distance-webgl":"WEBGL_clip_cull_distance","shader-noperspective-interpolation-webgl":"NV_shader_noperspective_interpolation","shader-conservative-depth-webgl":"EXT_conservative_depth"};class HH extends Jj{constructor(i,s,c){super([],c);fe(this,"gl");fe(this,"extensions");fe(this,"testedFeatures",new Set);this.gl=i,this.extensions=s,Wc(i,"EXT_color_buffer_float",s)}*[Symbol.iterator](){const i=this.getFeatures();for(const s of i)this.has(s)&&(yield s);return[]}has(i){return this.disabledFeatures[i]?!1:(this.testedFeatures.has(i)||(this.testedFeatures.add(i),FH(i)&&BH(this.gl,i,this.extensions)&&this.features.add(i),this.getWebGLFeature(i)&&this.features.add(i)),this.features.has(i))}initializeFeatures(){const i=this.getFeatures().filter(s=>s!=="polygon-mode-webgl");for(const s of i)this.has(s)}getFeatures(){return[...Object.keys(OI),...Object.keys(PE)]}getWebGLFeature(i){const s=OI[i];return typeof s=="string"?!!Wc(this.gl,s,this.extensions):!!s}}class qH extends Kj{constructor(i){super();fe(this,"gl");fe(this,"limits",{});this.gl=i}get maxTextureDimension1D(){return 0}get maxTextureDimension2D(){return this.getParameter(3379)}get maxTextureDimension3D(){return this.getParameter(32883)}get maxTextureArrayLayers(){return this.getParameter(35071)}get maxBindGroups(){return 0}get maxDynamicUniformBuffersPerPipelineLayout(){return 0}get maxDynamicStorageBuffersPerPipelineLayout(){return 0}get maxSampledTexturesPerShaderStage(){return this.getParameter(35660)}get maxSamplersPerShaderStage(){return this.getParameter(35661)}get maxStorageBuffersPerShaderStage(){return 0}get maxStorageTexturesPerShaderStage(){return 0}get maxUniformBuffersPerShaderStage(){return this.getParameter(35375)}get maxUniformBufferBindingSize(){return this.getParameter(35376)}get maxStorageBufferBindingSize(){return 0}get minUniformBufferOffsetAlignment(){return this.getParameter(35380)}get minStorageBufferOffsetAlignment(){return 0}get maxVertexBuffers(){return 16}get maxVertexAttributes(){return this.getParameter(34921)}get maxVertexBufferArrayStride(){return 2048}get maxInterStageShaderComponents(){return this.getParameter(35659)}get maxComputeWorkgroupStorageSize(){return 0}get maxComputeInvocationsPerWorkgroup(){return 0}get maxComputeWorkgroupSizeX(){return 0}get maxComputeWorkgroupSizeY(){return 0}get maxComputeWorkgroupSizeZ(){return 0}get maxComputeWorkgroupsPerDimension(){return 0}getParameter(i){return this.limits[i]===void 0&&(this.limits[i]=this.gl.getParameter(i)),this.limits[i]}}function Lc(t,e,i){if(GH(e))return i(t);const{nocatch:s=!0}=e;f1(t),Of(t,e);let c;if(s)c=i(t),P_(t);else try{c=i(t)}finally{P_(t)}return c}function GH(t){for(const e in t)return!1;return!0}function XH(t,e,i,s){if(tv(e))return s(t);const c=t;f1(c.gl);try{return ZH(t,e),Of(c.gl,i),s(t)}finally{P_(c.gl)}}function ZH(t,e){const i=t,{gl:s}=i;if(e.cullMode)switch(e.cullMode){case"none":s.disable(2884);break;case"front":s.enable(2884),s.cullFace(1028);break;case"back":s.enable(2884),s.cullFace(1029);break}if(e.frontFace&&s.frontFace(ph("frontFace",e.frontFace,{ccw:2305,cw:2304})),e.unclippedDepth&&t.features.has("depth-clip-control")&&s.enable(34383),e.depthBias!==void 0&&(s.enable(32823),s.polygonOffset(e.depthBias,e.depthBiasSlopeScale||0)),e.provokingVertex&&t.features.has("provoking-vertex-webgl")){const h=i.getExtension("WEBGL_provoking_vertex").WEBGL_provoking_vertex,p=ph("provokingVertex",e.provokingVertex,{first:36429,last:36430});h==null||h.provokingVertexWEBGL(p)}if((e.polygonMode||e.polygonOffsetLine)&&t.features.has("polygon-mode-webgl")){if(e.polygonMode){const h=i.getExtension("WEBGL_polygon_mode").WEBGL_polygon_mode,p=ph("polygonMode",e.polygonMode,{fill:6914,line:6913});h==null||h.polygonModeWEBGL(1028,p),h==null||h.polygonModeWEBGL(1029,p)}e.polygonOffsetLine&&s.enable(10754)}if(t.features.has("shader-clip-cull-distance-webgl")&&(e.clipDistance0&&s.enable(12288),e.clipDistance1&&s.enable(12289),e.clipDistance2&&s.enable(12290),e.clipDistance3&&s.enable(12291),e.clipDistance4&&s.enable(12292),e.clipDistance5&&s.enable(12293),e.clipDistance6&&s.enable(12294),e.clipDistance7&&s.enable(12295)),e.depthWriteEnabled!==void 0&&s.depthMask(KH("depthWriteEnabled",e.depthWriteEnabled)),e.depthCompare&&(e.depthCompare!=="always"?s.enable(2929):s.disable(2929),s.depthFunc(_T("depthCompare",e.depthCompare))),e.stencilWriteMask){const c=e.stencilWriteMask;s.stencilMaskSeparate(1028,c),s.stencilMaskSeparate(1029,c)}if(e.stencilReadMask&&Jt.warn("stencilReadMask not supported under WebGL"),e.stencilCompare){const c=e.stencilReadMask||4294967295,h=_T("depthCompare",e.stencilCompare);e.stencilCompare!=="always"?s.enable(2960):s.disable(2960),s.stencilFuncSeparate(1028,h,0,c),s.stencilFuncSeparate(1029,h,0,c)}if(e.stencilPassOperation&&e.stencilFailOperation&&e.stencilDepthFailOperation){const c=Hb("stencilPassOperation",e.stencilPassOperation),h=Hb("stencilFailOperation",e.stencilFailOperation),p=Hb("stencilDepthFailOperation",e.stencilDepthFailOperation);s.stencilOpSeparate(1028,h,p,c),s.stencilOpSeparate(1029,h,p,c)}if(e.blendColorOperation||e.blendAlphaOperation){s.enable(3042);const c=kI("blendColorOperation",e.blendColorOperation||"add"),h=kI("blendAlphaOperation",e.blendAlphaOperation||"add");s.blendEquationSeparate(c,h);const p=l0("blendColorSrcFactor",e.blendColorSrcFactor||"one"),v=l0("blendColorDstFactor",e.blendColorDstFactor||"zero"),l=l0("blendAlphaSrcFactor",e.blendAlphaSrcFactor||"one"),A=l0("blendAlphaDstFactor",e.blendAlphaDstFactor||"zero");s.blendFuncSeparate(p,v,l,A)}}function _T(t,e){return ph(t,e,{never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519})}function Hb(t,e){return ph(t,e,{keep:7680,zero:0,replace:7681,invert:5386,"increment-clamp":7682,"decrement-clamp":7683,"increment-wrap":34055,"decrement-wrap":34056})}function kI(t,e){return ph(t,e,{add:32774,subtract:32778,"reverse-subtract":32779,min:32775,max:32776})}function l0(t,e){return ph(t,e,{one:1,zero:0,"src-color":768,"one-minus-src-color":769,"dst-color":774,"one-minus-dst-color":775,"src-alpha":770,"one-minus-src-alpha":771,"dst-alpha":772,"one-minus-dst-alpha":773,"src-alpha-saturated":776,"constant-color":32769,"one-minus-constant-color":32770,"constant-alpha":32771,"one-minus-constant-alpha":32772})}function YH(t,e){return`Illegal parameter ${e} for ${t}`}function ph(t,e,i){if(!(e in i))throw new Error(YH(t,e));return i[e]}function KH(t,e){return e}function bL(t){const e={};return t.addressModeU&&(e[10242]=qb(t.addressModeU)),t.addressModeV&&(e[10243]=qb(t.addressModeV)),t.addressModeW&&(e[32882]=qb(t.addressModeW)),t.magFilter&&(e[10240]=wL(t.magFilter)),(t.minFilter||t.mipmapFilter)&&(e[10241]=JH(t.minFilter||"linear",t.mipmapFilter)),t.lodMinClamp!==void 0&&(e[33082]=t.lodMinClamp),t.lodMaxClamp!==void 0&&(e[33083]=t.lodMaxClamp),t.type==="comparison-sampler"&&(e[34892]=34894),t.compare&&(e[34893]=_T("compare",t.compare)),t.maxAnisotropy&&(e[34046]=t.maxAnisotropy),e}function qb(t){switch(t){case"clamp-to-edge":return 33071;case"repeat":return 10497;case"mirror-repeat":return 33648}}function wL(t){switch(t){case"nearest":return 9728;case"linear":return 9729}}function JH(t,e){if(!e)return wL(t);switch(t){case"nearest":return e==="nearest"?9984:9986;case"linear":return e==="nearest"?9985:9987}}class zc extends Yn{constructor(i,s={}){super(i,s);fe(this,"device");fe(this,"gl");fe(this,"handle");fe(this,"glTarget");fe(this,"glUsage");fe(this,"glIndexType",5123);fe(this,"byteLength");fe(this,"bytesUsed");this.device=i,this.gl=this.device.gl;const c=typeof s=="object"?s.handle:void 0;this.handle=c||this.gl.createBuffer(),i.setSpectorMetadata(this.handle,{...this.props,data:typeof this.props.data}),this.glTarget=QH(this.props.usage),this.glUsage=eq(this.props.usage),this.glIndexType=this.props.indexType==="uint32"?5125:5123,s.data?this._initWithData(s.data,s.byteOffset,s.byteLength):this._initWithByteLength(s.byteLength||0)}_initWithData(i,s=0,c=i.byteLength+s){const h=this.glTarget;this.gl.bindBuffer(h,this.handle),this.gl.bufferData(h,c,this.glUsage),this.gl.bufferSubData(h,s,i),this.gl.bindBuffer(h,null),this.bytesUsed=c,this.byteLength=c,this._setDebugData(i,s,c),this.trackAllocatedMemory(c)}_initWithByteLength(i){Bn(i>=0);let s=i;i===0&&(s=new Float32Array(0));const c=this.glTarget;return this.gl.bindBuffer(c,this.handle),this.gl.bufferData(c,s,this.glUsage),this.gl.bindBuffer(c,null),this.bytesUsed=i,this.byteLength=i,this._setDebugData(null,0,i),this.trackAllocatedMemory(i),this}destroy(){!this.destroyed&&this.handle&&(this.removeStats(),this.trackDeallocatedMemory(),this.gl.deleteBuffer(this.handle),this.destroyed=!0,this.handle=null)}write(i,s=0){this.gl.bindBuffer(36663,this.handle),this.gl.bufferSubData(36663,s,i),this.gl.bindBuffer(36663,null),this._setDebugData(i,s,i.byteLength)}async readAsync(i=0,s){return this.readSyncWebGL(i,s)}readSyncWebGL(i=0,s){s=s??this.byteLength-i;const c=new Uint8Array(s),h=0;return this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,i,c,h,s),this.gl.bindBuffer(36662,null),this._setDebugData(c,i,s),c}}function QH(t){return t&Yn.INDEX?34963:t&Yn.VERTEX?34962:t&Yn.UNIFORM?35345:34962}function eq(t){return t&Yn.INDEX||t&Yn.VERTEX?35044:t&Yn.UNIFORM?35048:35044}class gT extends nv{constructor(i,s){super(i,s);fe(this,"device");fe(this,"handle");fe(this,"parameters");this.device=i,this.parameters=bL(s),this.handle=this.handle||this.device.gl.createSampler(),this._setSamplerParameters(this.parameters)}destroy(){this.handle&&(this.device.gl.deleteSampler(this.handle),this.handle=void 0)}toString(){return`Sampler(${this.id},${JSON.stringify(this.props)})`}_setSamplerParameters(i){for(const[s,c]of Object.entries(i)){const h=Number(s);switch(h){case 33082:case 33083:this.device.gl.samplerParameterf(this.handle,h,c);break;default:this.device.gl.samplerParameteri(this.handle,h,c);break}}}}class Jd extends iv{constructor(i,s){super(i,{...Xo.defaultProps,...s});fe(this,"device");fe(this,"gl");fe(this,"handle");fe(this,"texture");this.device=i,this.gl=this.device.gl,this.handle=null,this.texture=s.texture}}const tq={parameters:{},pixelStore:{},pixels:null,border:0,dataFormat:void 0,textureUnit:void 0,target:void 0},m_=class m_ extends Xo{constructor(i,s){var c;super(i,{...tq,format:"rgba8unorm",...s});fe(this,"MAX_ATTRIBUTES");fe(this,"device");fe(this,"gl");fe(this,"handle");fe(this,"sampler");fe(this,"view");fe(this,"glFormat");fe(this,"type");fe(this,"dataFormat");fe(this,"mipmaps");fe(this,"target");fe(this,"textureUnit");fe(this,"loaded",!1);fe(this,"_video");this.device=i,this.gl=this.device.gl,this.handle=this.props.handle||this.gl.createTexture(),this.device.setSpectorMetadata(this.handle,{...this.props,data:typeof this.props.data}),this.glFormat=6408,this.target=iq(this.props),this.loaded=!1,typeof((c=this.props)==null?void 0:c.data)=="string"&&Object.assign(this.props,{data:z7(this.props.data)}),this.initialize(this.props),Object.seal(this)}destroy(){this.handle&&(this.gl.deleteTexture(this.handle),this.removeStats(),this.trackDeallocatedMemory("Texture"),this.destroyed=!0)}toString(){return`Texture(${this.id},${this.width}x${this.height})`}createView(i){return new Jd(this.device,{...i,texture:this})}initialize(i={}){if(this.props.dimension==="cube")return this.initializeCube(i);let s=i.data;if(s instanceof Promise)return s.then(oe=>this.initialize(Object.assign({},i,{pixels:oe,data:oe}))),this;const c=typeof HTMLVideoElement<"u"&&s instanceof HTMLVideoElement;if(c&&s.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,s.addEventListener("loadeddata",()=>this.initialize(i)),this;const{parameters:h={}}=i,{pixels:p=null,pixelStore:v={},textureUnit:l=void 0,mipmaps:A=!0}=i;s||(s=p);let{width:P,height:O,dataFormat:L,type:U,compressed:H=!1}=i;const{depth:Y=0}=i,J=xL(i.format);return{width:P,height:O,compressed:H,dataFormat:L,type:U}=this._deduceParameters({format:i.format,type:U,dataFormat:L,compressed:H,data:s,width:P,height:O}),this.width=P,this.height=O,this.glFormat=J,this.type=U,this.dataFormat=L,this.textureUnit=l,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),this.mipmaps=A,this.setImageData({data:s,width:P,height:O,depth:Y,format:J,type:U,dataFormat:L,parameters:v,compressed:H}),this.setSampler(i.sampler),this._setSamplerParameters(h),this.view=this.createView({...this.props,mipLevelCount:1,arrayLayerCount:1}),A&&this.device.isTextureFormatFilterable(i.format)&&this.generateMipmap(),c&&(this._video={video:s,parameters:h,lastTime:s.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?s.currentTime:-1}),this}initializeCube(i){const{mipmaps:s=!0,parameters:c={}}=i;return this.setCubeMapImageData(i).then(()=>{this.loaded=!0,s&&this.generateMipmap(i),this.setSampler(i.sampler),this._setSamplerParameters(c)}),this}setSampler(i={}){let s;i instanceof gT?(this.sampler=i,s=i.props):(this.sampler=new gT(this.device,i),s=i);const c=bL(s);return this._setSamplerParameters(c),this}resize(i){const{height:s,width:c,mipmaps:h=!1}=i;return c!==this.width||s!==this.height?this.initialize({width:c,height:s,format:this.format,type:this.type,dataFormat:this.dataFormat,mipmaps:h}):this}update(){if(this._video){const{video:i,parameters:s,lastTime:c}=this._video;if(c===i.currentTime||i.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:i,parameters:s}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=i.currentTime}}generateMipmap(i={}){return this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),Lc(this.gl,i,()=>{this.gl.generateMipmap(this.target)}),this.gl.bindTexture(this.target,null),this}setImageData(i){if(this.props.dimension==="3d"||this.props.dimension==="2d-array")return this.setImageData3D(i);this.trackDeallocatedMemory("Texture");const{target:s=this.target,pixels:c=null,level:h=0,glFormat:p=this.glFormat,offset:v=0,parameters:l={}}=i;let{data:A=null,type:P=this.type,width:O=this.width,height:L=this.height,dataFormat:U=this.dataFormat,compressed:H=!1}=i;A||(A=c),{type:P,dataFormat:U,compressed:H,width:O,height:L}=this._deduceParameters({format:this.props.format,type:P,dataFormat:U,compressed:H,data:A,width:O,height:L});const{gl:Y}=this;Y.bindTexture(this.target,this.handle);let J=null;if({data:A,dataType:J}=this._getDataType({data:A,compressed:H}),Lc(this.gl,l,()=>{switch(J){case"null":Y.texImage2D(s,h,p,O,L,0,U,P,A);break;case"typed-array":Y.texImage2D(s,h,p,O,L,0,U,P,A,v);break;case"buffer":this.device.gl.bindBuffer(35052,A.handle||A),this.device.gl.texImage2D(s,h,p,O,L,0,U,P,v),this.device.gl.bindBuffer(35052,null);break;case"browser-object":Y.texImage2D(s,h,p,O,L,0,U,P,A);break;case"compressed":for(const[oe,me]of A.entries())Y.compressedTexImage2D(s,oe,me.format,me.width,me.height,0,me.data);break;default:Bn(!1,"Unknown image data type")}}),A&&A.byteLength)this.trackAllocatedMemory(A.byteLength,"Texture");else{const oe=RI(this.props.format);this.trackAllocatedMemory(this.width*this.height*oe,"Texture")}return this.loaded=!0,this}setSubImageData({target:i=this.target,pixels:s=null,data:c=null,x:h=0,y:p=0,width:v=this.width,height:l=this.height,level:A=0,glFormat:P=this.glFormat,type:O=this.type,dataFormat:L=this.dataFormat,compressed:U=!1,offset:H=0,parameters:Y={}}){if({type:O,dataFormat:L,compressed:U,width:v,height:l}=this._deduceParameters({format:this.props.format,type:O,dataFormat:L,compressed:U,data:c,width:v,height:l}),Bn(this.depth===1,"texSubImage not supported for 3D textures"),c||(c=s),c&&c.data){const J=c;c=J.data,v=J.shape[0],l=J.shape[1]}c instanceof zc&&(c=c.handle),this.gl.bindTexture(this.target,this.handle),Lc(this.gl,Y,()=>{U?this.gl.compressedTexSubImage2D(i,A,h,p,v,l,P,c):c===null?this.gl.texSubImage2D(i,A,h,p,v,l,L,O,null):ArrayBuffer.isView(c)?this.gl.texSubImage2D(i,A,h,p,v,l,L,O,c,H):typeof WebGLBuffer<"u"&&c instanceof WebGLBuffer?(this.device.gl.bindBuffer(35052,c),this.device.gl.texSubImage2D(i,A,h,p,v,l,L,O,H),this.device.gl.bindBuffer(35052,null)):this.device.gl.texSubImage2D(i,A,h,p,v,l,L,O,c)}),this.gl.bindTexture(this.target,null)}copyFramebuffer(i={}){return Jt.error("Texture.copyFramebuffer({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(i=this.textureUnit){const{gl:s}=this;return i!==void 0&&(this.textureUnit=i,s.activeTexture(33984+i)),s.bindTexture(this.target,this.handle),i}unbind(i=this.textureUnit){const{gl:s}=this;return i!==void 0&&(this.textureUnit=i,s.activeTexture(33984+i)),s.bindTexture(this.target,null),i}_getDataType({data:i,compressed:s=!1}){return s?{data:i,dataType:"compressed"}:i===null?{data:i,dataType:"null"}:ArrayBuffer.isView(i)?{data:i,dataType:"typed-array"}:i instanceof zc?{data:i.handle,dataType:"buffer"}:typeof WebGLBuffer<"u"&&i instanceof WebGLBuffer?{data:i,dataType:"buffer"}:{data:i,dataType:"browser-object"}}_deduceParameters(i){const{format:s,data:c}=i;let{width:h,height:p,dataFormat:v,type:l,compressed:A}=i;const P=dv(s);return v=v||P.dataFormat,l=l||P.type,A=A||P.compressed,{width:h,height:p}=this._deduceImageSize(c,h,p),{dataFormat:v,type:l,compressed:A,width:h,height:p,format:s,data:c}}_deduceImageSize(i,s,c){let h;return typeof ImageData<"u"&&i instanceof ImageData?h={width:i.width,height:i.height}:typeof HTMLImageElement<"u"&&i instanceof HTMLImageElement?h={width:i.naturalWidth,height:i.naturalHeight}:typeof HTMLCanvasElement<"u"&&i instanceof HTMLCanvasElement?h={width:i.width,height:i.height}:typeof ImageBitmap<"u"&&i instanceof ImageBitmap?h={width:i.width,height:i.height}:typeof HTMLVideoElement<"u"&&i instanceof HTMLVideoElement?h={width:i.videoWidth,height:i.videoHeight}:i?h={width:s,height:c}:h={width:s>=0?s:1,height:c>=0?c:1},Bn(h,"Could not deduced texture size"),Bn(s===void 0||h.width===s,"Deduced texture width does not match supplied width"),Bn(c===void 0||h.height===c,"Deduced texture height does not match supplied height"),h}async setCubeMapImageData(i){const{gl:s}=this,{width:c,height:h,pixels:p,data:v,format:l=6408,type:A=5121}=i,P=p||v,O=await Promise.all(m_.FACES.map(L=>{const U=P[L];return Promise.all(Array.isArray(U)?U:[U])}));this.bind(),m_.FACES.forEach((L,U)=>{O[U].length>1&&this.props.mipmaps!==!1&&Jt.warn(`${this.id} has mipmap and multiple LODs.`)(),O[U].forEach((H,Y)=>{c&&h?s.texImage2D(L,Y,l,c,h,0,l,A,H):s.texImage2D(L,Y,l,l,A,H)})}),this.unbind()}setImageDataForFace(i){const{face:s,width:c,height:h,pixels:p,data:v,format:l=6408,type:A=5121}=i,{gl:P}=this,O=p||v;return this.bind(),O instanceof Promise?O.then(L=>this.setImageDataForFace(Object.assign({},i,{face:s,data:L,pixels:L}))):this.width||this.height?P.texImage2D(s,0,l,c,h,0,l,A,O):P.texImage2D(s,0,l,l,A,O),this}setImageData3D(i){const{level:s=0,dataFormat:c,format:h,type:p,width:v,height:l,depth:A=1,offset:P=0,data:O,parameters:L={}}=i;this.trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle);const U=dv(h);if(Lc(this.gl,L,()=>{ArrayBuffer.isView(O)&&this.gl.texImage3D(this.target,s,U.format,v,l,A,0,U.dataFormat,U.type,O),O instanceof zc&&(this.gl.bindBuffer(35052,O.handle),this.gl.texImage3D(this.target,s,c,v,l,A,0,h,p,P))}),O&&O.byteLength)this.trackAllocatedMemory(O.byteLength,"Texture");else{const H=RI(this.props.format);this.trackAllocatedMemory(this.width*this.height*this.depth*H,"Texture")}return this.loaded=!0,this}_setSamplerParameters(i){if(!tv(i)){rq(i),this.gl.bindTexture(this.target,this.handle);for(const[s,c]of Object.entries(i)){const h=Number(s),p=c;switch(h){case 33082:case 33083:this.gl.texParameterf(this.target,h,p);break;default:this.gl.texParameteri(this.target,h,p);break}}this.gl.bindTexture(this.target,null)}}};fe(m_,"FACES",[34069,34070,34071,34072,34073,34074]);let il=m_;function iq(t){switch(t.dimension){case"2d":return 3553;case"cube":return 34067;case"2d-array":return 35866;case"3d":return 32879;case"1d":case"cube-array":default:throw new Error(t.dimension)}}function rq(t){Jt.log(1,"texture sampler parameters",t)()}class o_ extends sv{constructor(i,s){super(i,s);fe(this,"device");fe(this,"gl");fe(this,"handle");const c=s.handle===null;if(this.device=i,this.gl=i.gl,this.handle=this.props.handle||c?this.props.handle:this.gl.createFramebuffer(),!c){i.setSpectorMetadata(this.handle,{id:this.props.id,props:this.props}),this.autoCreateAttachmentTextures();const h=this.gl.bindFramebuffer(36160,this.handle);for(let p=0;p<this.colorAttachments.length;++p){const v=this.colorAttachments[p],l=36064+p;v&&this._attachOne(l,v)}if(this.depthStencilAttachment&&this._attachOne($H(this.depthStencilAttachment.props.format),this.depthStencilAttachment),s.check!==!1){const p=this.gl.checkFramebufferStatus(36160);if(p!==36053)throw new Error(`Framebuffer ${sq(p)}`)}this.gl.bindFramebuffer(36160,h)}}get texture(){return this.colorAttachments[0]}destroy(){super.destroy(),!this.destroyed&&this.handle!==null&&this.gl.deleteFramebuffer(this.handle)}createDepthStencilTexture(i){return new il(this.device,{id:`${this.id}-depth-stencil`,format:i,width:this.width,height:this.height,mipmaps:!1})}resizeAttachments(i,s){if(this.handle===null)return this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;i===void 0&&(i=this.gl.drawingBufferWidth),s===void 0&&(s=this.gl.drawingBufferHeight);for(const c of this.colorAttachments)c.texture.resize({width:i,height:s});return this.depthStencilAttachment&&this.depthStencilAttachment.texture.resize({width:i,height:s}),this}_attachOne(i,s){if(Array.isArray(s)){const[c,h=0,p=0]=s;return this._attachTexture(i,c,h,p),c}if(s instanceof il)return this._attachTexture(i,s,0,0),s;if(s instanceof Jd){const c=s;return this._attachTexture(i,c.texture,c.props.baseMipLevel,c.props.baseArrayLayer),s.texture}throw new Error("attach")}_attachTexture(i,s,c,h){const{gl:p}=this.device;switch(p.bindTexture(s.target,s.handle),s.target){case 35866:case 32879:p.framebufferTextureLayer(36160,i,s.target,h,c);break;case 34067:const v=nq(c);p.framebufferTexture2D(36160,i,v,s.handle,h);break;case 3553:p.framebufferTexture2D(36160,i,3553,s.handle,h);break;default:Bn(!1,"Illegal texture type")}p.bindTexture(s.target,null)}}function nq(t){return t<34069?t+34069:t}function sq(t){switch(t){case 36053:return"success";case 36054:return"Mismatched attachments";case 36055:return"No attachments";case 36057:return"Height/width mismatch";case 36061:return"Unsupported or split attachments";case 36182:return"Samples mismatch";default:return`${t}`}}class oq extends vE{constructor(i,s){super(s);fe(this,"device");fe(this,"presentationSize");fe(this,"_framebuffer",null);this.device=i,this.presentationSize=[-1,-1],this._setAutoCreatedCanvasId(`${this.device.id}-canvas`),this.update()}getCurrentFramebuffer(){return this.update(),this._framebuffer=this._framebuffer||new o_(this.device,{handle:null}),this._framebuffer}update(){const i=this.getPixelSize();(i[0]!==this.presentationSize[0]||i[1]!==this.presentationSize[1])&&(this.presentationSize=i,this.resize())}resize(i){if(this.device.gl&&this.canvas){const s=this.getDevicePixelRatio(i==null?void 0:i.useDevicePixels);this.setDevicePixelRatio(s,i);return}}commit(){}}const aq={spector:Jt.get("spector")||Jt.get("inspect")},lq="https://spectorcdn.babylonjs.com/spector.bundle.js",cq=1;let Sn=null,DI=!1;async function uq(t){if(!globalThis.SPECTOR)try{await SD(lq)}catch(e){Jt.warn(String(e))}}function hq(t){if(t={...aq,...t},!(t!=null&&t.spector)||(!Sn&&globalThis.SPECTOR&&(Jt.probe(cq,"SPECTOR found and initialized")(),Sn=new globalThis.SPECTOR.Spector,globalThis.luma&&(globalThis.luma.spector=Sn)),!Sn))return null;if(DI||(DI=!0,Sn.spyCanvases(),Sn==null||Sn.onCaptureStarted.add(e=>Jt.info("Spector capture started:",e)()),Sn==null||Sn.onCapture.add(e=>{Jt.info("Spector capture complete:",e)(),Sn==null||Sn.getResultUI(),Sn==null||Sn.resultView.display(),Sn==null||Sn.resultView.addCapture(e)})),t!=null&&t.canvas){if(typeof t.spector=="string"&&t.spector!==t.canvas.id)return Sn;Sn==null||Sn.startCapture(t==null?void 0:t.canvas,500),new Promise(e=>setTimeout(e,2e3)).then(e=>{Jt.info("Spector capture stopped after 2 seconds")(),Sn==null||Sn.stopCapture()})}return Sn}const dq="https://unpkg.com/webgl-debug@2.0.1/index.js";function TL(t){return t.luma=t.luma||{},t.luma}async function fq(){Kc()&&!globalThis.WebGLDebugUtils&&(globalThis.global=globalThis.global||globalThis,globalThis.global.module={},await SD(dq))}function pq(t,e={}){return t?e.debug?_q(t,e):mq(t):null}function mq(t){const e=TL(t);return e.realContext?e.realContext:t}function _q(t,e){if(!globalThis.WebGLDebugUtils)return Jt.warn("webgl-debug not loaded")(),t;const i=TL(t);if(i.debugContext)return i.debugContext;globalThis.WebGLDebugUtils.init({...Zd,...t});const s=globalThis.WebGLDebugUtils.makeDebugContext(t,gq.bind(null,e),yq.bind(null,e));for(const p in Zd)!(p in s)&&typeof Zd[p]=="number"&&(s[p]=Zd[p]);class c{}Object.setPrototypeOf(s,Object.getPrototypeOf(t)),Object.setPrototypeOf(c,s);const h=Object.create(c);return i.realContext=t,i.debugContext=h,h.debug=!0,h}function Gb(t,e){e=Array.from(e).map(s=>s===void 0?"undefined":s);let i=globalThis.WebGLDebugUtils.glFunctionArgsToString(t,e);return i=`${i.slice(0,100)}${i.length>100?"...":""}`,`gl.${t}(${i})`}function gq(t,e,i,s){s=Array.from(s).map(v=>v===void 0?"undefined":v);const c=globalThis.WebGLDebugUtils.glEnumToString(e),h=globalThis.WebGLDebugUtils.glFunctionArgsToString(i,s),p=`${c} in gl.${i}(${h})`;Jt.error(p)();debugger;if(t.throwOnError)throw new Error(p)}function yq(t,e,i){let s="";if(Jt.level>=1&&(s=Gb(e,i),Jt.log(1,s)()),t.break&&t.break.length>0&&(s=s||Gb(e,i),t.break.every(h=>s.indexOf(h)!==-1)))debugger;for(const c of i)if(c===void 0){if(s=s||Gb(e,i),t.throwOnError)throw new Error(`Undefined argument: ${s}`);Jt.error(`Undefined argument: ${s}`)();debugger}}function vq(t){const e=t.split(/\r?\n/),i=[];for(const s of e){if(s.length<=1)continue;const c=s.split(":");if(c.length===2){const[O,L]=c;i.push({message:L.trim(),type:LI(O),lineNum:0,linePos:0});continue}const[h,p,v,...l]=c;let A=parseInt(v,10);isNaN(A)&&(A=0);let P=parseInt(p,10);isNaN(P)&&(P=0),i.push({message:l.join(":").trim(),type:LI(h),lineNum:A,linePos:P})}return i}function LI(t){const e=["warning","error","info"],i=t.toLowerCase();return e.includes(i)?i:"info"}class xq extends rv{constructor(i,s){super(i,s);fe(this,"device");fe(this,"handle");switch(this.device=i,this.props.stage){case"vertex":this.handle=this.props.handle||this.device.gl.createShader(35633);break;case"fragment":this.handle=this.props.handle||this.device.gl.createShader(35632);break;default:throw new Error(this.props.stage)}this._compile(this.source)}destroy(){this.handle&&(this.removeStats(),this.device.gl.deleteShader(this.handle),this.destroyed=!0)}async getCompilationInfo(){return await this._waitForCompilationComplete(),this.getCompilationInfoSync()}getCompilationInfoSync(){const i=this.device.gl.getShaderInfoLog(this.handle);return vq(i)}getTranslatedSource(){const s=this.device.getExtension("WEBGL_debug_shaders").WEBGL_debug_shaders;return s==null?void 0:s.getTranslatedShaderSource(this.handle)}async _compile(i){i=(h=>h.startsWith("#version ")?h:`#version 100
${h}`)(i);const{gl:c}=this.device;if(c.shaderSource(this.handle,i),c.compileShader(this.handle),Jt.level===0){this.compilationStatus="pending";return}if(!this.device.features.has("compilation-status-async-webgl")){if(this._getCompilationStatus(),this.debugShader(),this.compilationStatus==="error")throw new Error(`GLSL compilation errors in ${this.props.stage} shader ${this.props.id}`);return}Jt.once(1,"Shader compilation is asynchronous")(),await this._waitForCompilationComplete(),Jt.info(2,`Shader ${this.id} - async compilation complete: ${this.compilationStatus}`)(),this._getCompilationStatus(),this.debugShader()}async _waitForCompilationComplete(){const i=async h=>await new Promise(p=>setTimeout(p,h));if(!this.device.features.has("compilation-status-async-webgl")){await i(10);return}const{gl:c}=this.device;for(;;){if(c.getShaderParameter(this.handle,37297))return;await i(10)}}_getCompilationStatus(){this.compilationStatus=this.device.gl.getShaderParameter(this.handle,35713)?"success":"error"}}const bq=256,wq=1024,Tq=16384,Xb=6144,Eq=[1,2,4,8];class Sq extends Jw{constructor(i,s){super(i,s);fe(this,"device");fe(this,"glParameters");this.device=i,f1(this.device.gl),this.setParameters(this.props.parameters),this.clear()}end(){P_(this.device.gl)}pushDebugGroup(i){}popDebugGroup(){}insertDebugMarker(i){}setParameters(i={}){const s={...this.glParameters};this.props.framebuffer&&(s.framebuffer=this.props.framebuffer),this.props.depthReadOnly&&(s.depthMask=!this.props.depthReadOnly),s.stencilMask=this.props.stencilReadOnly?0:1,s[35977]=this.props.discard,i.viewport&&(i.viewport.length>=6?(s.viewport=i.viewport.slice(0,4),s.depthRange=[i.viewport[4],i.viewport[5]]):s.viewport=i.viewport),i.scissorRect&&(s.scissorTest=!0,s.scissor=i.scissorRect),i.blendConstant&&(s.blendColor=i.blendConstant),i.stencilReference&&(console.warn("RenderPassParameters.stencilReference not yet implemented in WebGL"),i[2967]=i.stencilReference),i.colorMask&&(s.colorMask=Eq.map(c=>!!(c&i.colorMask))),this.glParameters=s,Of(this.device.gl,s)}beginOcclusionQuery(i){const s=this.props.occlusionQuerySet;s==null||s.beginOcclusionQuery()}endOcclusionQuery(){const i=this.props.occlusionQuerySet;i==null||i.endOcclusionQuery()}clear(){const i={...this.glParameters};let s=0;this.props.clearColor!==!1&&(s|=Tq,i.clearColor=this.props.clearColor),this.props.clearDepth!==!1&&(s|=bq,i.clearDepth=this.props.clearDepth),this.props.clearStencil!==!1&&(s|=wq,i.clearStencil=this.props.clearStencil),s!==0&&Lc(this.device.gl,i,()=>{this.device.gl.clear(s)})}clearColorBuffer(i=0,s=[0,0,0,0]){Lc(this.device.gl,{framebuffer:this.props.framebuffer},()=>{switch(s.constructor){case Int32Array:this.device.gl.clearBufferiv(Xb,i,s);break;case Uint32Array:this.device.gl.clearBufferuiv(Xb,i,s);break;case Float32Array:default:this.device.gl.clearBufferfv(Xb,i,s);break}})}}const Aq="Failed to deduce GL constant from typed array";function Mq(t){switch(ArrayBuffer.isView(t)?t.constructor:t){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(Aq)}}function yT(t,e){const{clamped:i=!0}=e||{};switch(t){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return i?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}const Cq={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},Pq={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}};class a_{constructor(...e){fe(this,"offset");fe(this,"stride");fe(this,"type");fe(this,"size");fe(this,"divisor");fe(this,"normalized");fe(this,"integer");fe(this,"buffer");fe(this,"index");e.forEach(i=>this._assign(i)),Object.freeze(this)}static getBytesPerElement(e){return yT(e.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(e){return Bn(e.size),yT(e.type||5126).BYTES_PER_ELEMENT*e.size}static resolve(...e){return new a_(Cq,...e)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return a_.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return a_.getBytesPerVertex(this)}_assign(e={}){return e=F7("Accessor",e,Pq),e.type!==void 0&&(this.type=e.type,(e.type===5124||e.type===5125)&&(this.integer=!0)),e.size!==void 0&&(this.size=e.size),e.offset!==void 0&&(this.offset=e.offset),e.stride!==void 0&&(this.stride=e.stride),e.normalize!==void 0&&(this.normalized=e.normalize),e.normalized!==void 0&&(this.normalized=e.normalized),e.integer!==void 0&&(this.integer=e.integer),e.divisor!==void 0&&(this.divisor=e.divisor),e.buffer!==void 0&&(this.buffer=e.buffer),e.index!==void 0&&(typeof e.index=="boolean"?this.index=e.index?1:0:this.index=e.index),e.instanced!==void 0&&(this.divisor=e.instanced?1:0),e.isInstanced!==void 0&&(this.divisor=e.isInstanced?1:0),this.offset===void 0&&delete this.offset,this.stride===void 0&&delete this.stride,this.type===void 0&&delete this.type,this.size===void 0&&delete this.size,this.divisor===void 0&&delete this.divisor,this.normalized===void 0&&delete this.normalized,this.integer===void 0&&delete this.integer,this.buffer===void 0&&delete this.buffer,this.index===void 0&&delete this.index,this}}function Iq(t){return Rq.includes(t)}const Rq=[35678,35680,35679,35682,36289,36292,36293,36298,36299,36300,36303,36306,36307,36308,36311],EL={5126:[5126,1,"float","f32","float32"],35664:[5126,2,"vec2","vec2<f32>","float32x2"],35665:[5126,3,"vec3","vec3<f32>","float32x3"],35666:[5126,4,"vec4","vec4<f32>","float32x4"],5124:[5124,1,"int","i32","sint32"],35667:[5124,2,"ivec2","vec2<i32>","sint32x2"],35668:[5124,3,"ivec3","vec3<i32>","sint32x3"],35669:[5124,4,"ivec4","vec4<i32>","sint32x4"],5125:[5125,1,"uint","u32","uint32"],36294:[5125,2,"uvec2","vec2<u32>","uint32x2"],36295:[5125,3,"uvec3","vec3<u32>","uint32x3"],36296:[5125,4,"uvec4","vec4<u32>","uint32x4"],35670:[5126,1,"bool","f32","float32"],35671:[5126,2,"bvec2","vec2<f32>","float32x2"],35672:[5126,3,"bvec3","vec3<f32>","float32x3"],35673:[5126,4,"bvec4","vec4<f32>","float32x4"],35674:[5126,8,"mat2","mat2x2<f32>"],35685:[5126,8,"mat2x3","mat2x3<f32>"],35686:[5126,8,"mat2x4","mat2x4<f32>"],35687:[5126,12,"mat3x2","mat3x2<f32>"],35675:[5126,12,"mat3","mat3x3<f32>"],35688:[5126,12,"mat3x4","mat3x4<f32>"],35689:[5126,16,"mat4x2","mat4x2<f32>"],35690:[5126,16,"mat4x3","mat4x3<f32>"],35676:[5126,16,"mat4","mat4x4<f32>"]};function SL(t){const e=EL[t];if(!e)throw new Error("uniform");const[i,s,,c]=e;return{format:c,components:s,glType:i}}function Oq(t){const e=EL[t];if(!e)throw new Error("attribute");const[,i,,s,c]=e;return{attributeType:s,vertexFormat:c,components:i}}function kq(t,e){const i={attributes:[],bindings:[]};i.attributes=Dq(t,e);const s=Fq(t,e);for(const v of s){const l=v.uniforms.map(A=>({name:A.name,format:A.format,byteOffset:A.byteOffset,byteStride:A.byteStride,arrayLength:A.arrayLength}));i.bindings.push({type:"uniform",name:v.name,location:v.location,visibility:(v.vertex?1:0)&(v.fragment?2:0),minBindingSize:v.byteLength,uniforms:l})}const c=Nq(t,e);let h=0;for(const v of c)if(Iq(v.type)){const{viewDimension:l,sampleType:A}=zq(v.type);i.bindings.push({type:"texture",name:v.name,location:h,viewDimension:l,sampleType:A}),v.textureUnit=h,h+=1}c.length&&(i.uniforms=c);const p=Lq(t,e);return p!=null&&p.length&&(i.varyings=p),i}function Dq(t,e){const i=[],s=t.getProgramParameter(e,35721);for(let c=0;c<s;c++){const h=t.getActiveAttrib(e,c);if(!h)throw new Error("activeInfo");const{name:p,type:v}=h,l=t.getAttribLocation(e,p);if(l>=0){const{attributeType:A}=Oq(v),P=/instance/i.test(p)?"instance":"vertex";i.push({name:p,location:l,stepMode:P,type:A})}}return i.sort((c,h)=>c.location-h.location),i}function Lq(t,e){const i=[],s=t.getProgramParameter(e,35971);for(let c=0;c<s;c++){const h=t.getTransformFeedbackVarying(e,c);if(!h)throw new Error("activeInfo");const{name:p,type:v,size:l}=h,{glType:A,components:P}=SL(v),O=new a_({type:A,size:l*P}),L={location:c,name:p,accessor:O};i.push(L)}return i.sort((c,h)=>c.location-h.location),i}function Nq(t,e){const i=[],s=t.getProgramParameter(e,35718);for(let c=0;c<s;c++){const h=t.getActiveUniform(e,c);if(!h)throw new Error("activeInfo");const{name:p,size:v,type:l}=h,{name:A,isArray:P}=Uq(p);let O=t.getUniformLocation(e,A);const L={location:O,name:A,size:v,type:l,isArray:P};if(i.push(L),L.size>1)for(let U=0;U<L.size;U++){const H=`${A}[${U}]`;O=t.getUniformLocation(e,H);const Y={...L,name:H,location:O};i.push(Y)}}return i}function Fq(t,e){const i=(h,p)=>t.getActiveUniformBlockParameter(e,h,p),s=[],c=t.getProgramParameter(e,35382);for(let h=0;h<c;h++){const p={name:t.getActiveUniformBlockName(e,h)||"",location:i(h,35391),byteLength:i(h,35392),vertex:i(h,35396),fragment:i(h,35398),uniformCount:i(h,35394),uniforms:[]},v=i(h,35395)||[],l=t.getActiveUniforms(e,v,35383),A=t.getActiveUniforms(e,v,35384),P=t.getActiveUniforms(e,v,35387),O=t.getActiveUniforms(e,v,35388);for(let L=0;L<p.uniformCount;++L){const U=t.getActiveUniform(e,v[L]);if(!U)throw new Error("activeInfo");p.uniforms.push({name:U.name,format:SL(l[L]).format,type:l[L],arrayLength:A[L],byteOffset:P[L],byteStride:O[L]})}s.push(p)}return s.sort((h,p)=>h.location-p.location),s}const Bq={35678:["2d","float"],35680:["cube","float"],35679:["3d","float"],35682:["3d","depth"],36289:["2d-array","float"],36292:["2d-array","depth"],36293:["cube","float"],36298:["2d","sint"],36299:["3d","sint"],36300:["cube","sint"],36303:["2d-array","uint"],36306:["2d","uint"],36307:["3d","uint"],36308:["cube","uint"],36311:["2d-array","uint"]};function zq(t){const e=Bq[t];if(!e)throw new Error("sampler");const[i,s]=e;return{viewDimension:i,sampleType:s}}function Uq(t){if(t[t.length-1]!=="]")return{name:t,length:1,isArray:!1};const i=/([^[]*)(\[[0-9]+\])?/.exec(t);if(!i||i.length<2)throw new Error(`Failed to parse GLSL uniform name ${t}`);return{name:i[1],length:i[2]?1:0,isArray:!!i[2]}}function Vq(t,e,i,s){const c=t;let h=s;h===!0&&(h=1),h===!1&&(h=0);const p=typeof h=="number"?[h]:h;switch(i){case 35678:case 35680:case 35679:case 35682:case 36289:case 36292:case 36293:case 36298:case 36299:case 36300:case 36303:case 36306:case 36307:case 36308:case 36311:if(typeof s!="number")throw new Error("samplers must be set to integers");return t.uniform1i(e,s);case 5126:return t.uniform1fv(e,p);case 35664:return t.uniform2fv(e,p);case 35665:return t.uniform3fv(e,p);case 35666:return t.uniform4fv(e,p);case 5124:return t.uniform1iv(e,p);case 35667:return t.uniform2iv(e,p);case 35668:return t.uniform3iv(e,p);case 35669:return t.uniform4iv(e,p);case 35670:return t.uniform1iv(e,p);case 35671:return t.uniform2iv(e,p);case 35672:return t.uniform3iv(e,p);case 35673:return t.uniform4iv(e,p);case 5125:return c.uniform1uiv(e,p,1);case 36294:return c.uniform2uiv(e,p,2);case 36295:return c.uniform3uiv(e,p,3);case 36296:return c.uniform4uiv(e,p,4);case 35674:return t.uniformMatrix2fv(e,!1,p);case 35675:return t.uniformMatrix3fv(e,!1,p);case 35676:return t.uniformMatrix4fv(e,!1,p);case 35685:return c.uniformMatrix2x3fv(e,!1,p);case 35686:return c.uniformMatrix2x4fv(e,!1,p);case 35687:return c.uniformMatrix3x2fv(e,!1,p);case 35688:return c.uniformMatrix3x4fv(e,!1,p);case 35689:return c.uniformMatrix4x2fv(e,!1,p);case 35690:return c.uniformMatrix4x3fv(e,!1,p)}throw new Error("Illegal uniform")}function jq(t){switch(t){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 3;case"line-loop-webgl":return 2;case"triangle-list":return 4;case"triangle-strip":return 5;case"triangle-fan-webgl":return 6;default:throw new Error(t)}}function $q(t){switch(t){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 1;case"line-loop-webgl":return 1;case"triangle-list":return 4;case"triangle-strip":return 4;case"triangle-fan-webgl":return 4;default:throw new Error(t)}}const NI=4;class Wq extends yf{constructor(i,s){super(i,s);fe(this,"device");fe(this,"handle");fe(this,"vs");fe(this,"fs");fe(this,"introspectedLayout");fe(this,"uniforms",{});fe(this,"bindings",{});fe(this,"varyings",null);fe(this,"_uniformCount",0);fe(this,"_uniformSetters",{});this.device=i,this.handle=this.props.handle||this.device.gl.createProgram(),this.device.setSpectorMetadata(this.handle,{id:this.props.id}),this.vs=s.vs,this.fs=s.fs;const{varyings:c,bufferMode:h=35981}=s;switch(c&&c.length>0&&(this.varyings=c,this.device.gl.transformFeedbackVaryings(this.handle,c,h)),this._linkShaders(),Jt.time(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.introspectedLayout=kq(this.device.gl,this.handle),Jt.timeEnd(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.shaderLayout=E7(this.introspectedLayout,s.shaderLayout),this.props.topology){case"triangle-fan-webgl":case"line-loop-webgl":Jt.warn(`Primitive topology ${this.props.topology} is deprecated and will be removed in v9.1`);break}}destroy(){this.handle&&(this.device.gl.deleteProgram(this.handle),this.destroyed=!0)}setBindings(i,s){for(const[c,h]of Object.entries(i)){const p=this.shaderLayout.bindings.find(v=>v.name===c)||this.shaderLayout.bindings.find(v=>v.name===`${c}Uniforms`);if(!p){const v=this.shaderLayout.bindings.map(l=>`"${l.name}"`).join(", ");s!=null&&s.disableWarnings||Jt.warn(`Unknown binding "${c}" in render pipeline "${this.id}", expected one of ${v}`)();continue}switch(h||Jt.warn(`Unsetting binding "${c}" in render pipeline "${this.id}"`)(),p.type){case"uniform":if(!(h instanceof zc)&&!(h.buffer instanceof zc))throw new Error("buffer value");break;case"texture":if(!(h instanceof Jd||h instanceof il||h instanceof o_))throw new Error("texture value");break;case"sampler":Jt.warn(`Ignoring sampler ${c}`)();break;default:throw new Error(p.type)}this.bindings[c]=h}}draw(i){var J;const{renderPass:s,parameters:c=this.props.parameters,topology:h=this.props.topology,vertexArray:p,vertexCount:v,instanceCount:l,isInstanced:A=!1,firstVertex:P=0,transformFeedback:O}=i,L=jq(h),U=!!p.indexBuffer,H=(J=p.indexBuffer)==null?void 0:J.glIndexType;if(this.linkStatus!=="success")return Jt.info(2,`RenderPipeline:${this.id}.draw() aborted - waiting for shader linking`)(),!1;if(!this._areTexturesRenderable()||v===0)return Jt.info(2,`RenderPipeline:${this.id}.draw() aborted - textures not yet loaded`)(),!1;if(v===0)return Jt.info(2,`RenderPipeline:${this.id}.draw() aborted - no vertices to draw`)(),!0;this.device.gl.useProgram(this.handle),p.bindBeforeRender(s),O&&O.begin(this.props.topology),this._applyBindings(),this._applyUniforms();const Y=s;return XH(this.device,c,Y.glParameters,()=>{U&&A?this.device.gl.drawElementsInstanced(L,v||0,H,P,l||0):U?this.device.gl.drawElements(L,v||0,H,P):A?this.device.gl.drawArraysInstanced(L,P,v||0,l||0):this.device.gl.drawArrays(L,P,v||0),O&&O.end()}),p.unbindAfterRender(s),!0}setUniformsWebGL(i){const{bindings:s}=ED(i);Object.keys(s).forEach(c=>{Jt.warn(`Unsupported value "${JSON.stringify(s[c])}" used in setUniforms() for key ${c}. Use setBindings() instead?`)()}),Object.assign(this.uniforms,i)}async _linkShaders(){const{gl:i}=this.device;if(i.attachShader(this.handle,this.vs.handle),i.attachShader(this.handle,this.fs.handle),Jt.time(NI,`linkProgram for ${this.id}`)(),i.linkProgram(this.handle),Jt.timeEnd(NI,`linkProgram for ${this.id}`)(),Jt.level,!this.device.features.has("compilation-status-async-webgl")){const c=this._getLinkStatus();this._reportLinkStatus(c);return}Jt.once(1,"RenderPipeline linking is asynchronous")(),await this._waitForLinkComplete(),Jt.info(2,`RenderPipeline ${this.id} - async linking complete: ${this.linkStatus}`)();const s=this._getLinkStatus();this._reportLinkStatus(s)}_reportLinkStatus(i){var s;switch(i){case"success":return;default:throw this.vs.compilationStatus==="error"?(this.vs.debugShader(),new Error(`Error during compilation of shader ${this.vs.id}`)):((s=this.fs)==null?void 0:s.compilationStatus)==="error"?(this.fs.debugShader(),new Error(`Error during compilation of shader ${this.fs.id}`)):new Error(`Error during ${i}: ${this.device.gl.getProgramInfoLog(this.handle)}`)}}_getLinkStatus(){const{gl:i}=this.device;return i.getProgramParameter(this.handle,35714)?(i.validateProgram(this.handle),i.getProgramParameter(this.handle,35715)?(this.linkStatus="success","success"):(this.linkStatus="error","validation")):(this.linkStatus="error","linking")}async _waitForLinkComplete(){const i=async h=>await new Promise(p=>setTimeout(p,h));if(!this.device.features.has("compilation-status-async-webgl")){await i(10);return}const{gl:c}=this.device;for(;;){if(c.getProgramParameter(this.handle,37297))return;await i(10)}}_areTexturesRenderable(){let i=!0;for(const[,s]of Object.entries(this.bindings))s instanceof il&&(s.update(),i=i&&s.loaded);return i}_applyBindings(){if(this.linkStatus!=="success")return;const{gl:i}=this.device;i.useProgram(this.handle);let s=0,c=0;for(const h of this.shaderLayout.bindings){const p=this.bindings[h.name]||this.bindings[h.name.replace(/Uniforms$/,"")];if(!p)throw new Error(`No value for binding ${h.name} in ${this.id}`);switch(h.type){case"uniform":const{name:v}=h,l=i.getUniformBlockIndex(this.handle,v);if(l===4294967295)throw new Error(`Invalid uniform block name ${v}`);i.uniformBlockBinding(this.handle,c,l),p instanceof zc?i.bindBufferBase(35345,c,p.handle):i.bindBufferRange(35345,c,p.buffer.handle,p.offset||0,p.size||p.buffer.byteLength-p.offset),c+=1;break;case"texture":if(!(p instanceof Jd||p instanceof il||p instanceof o_))throw new Error("texture");let A;if(p instanceof Jd)A=p.texture;else if(p instanceof il)A=p;else if(p instanceof o_&&p.colorAttachments[0]instanceof Jd)Jt.warn("Passing framebuffer in texture binding may be deprecated. Use fbo.colorAttachments[0] instead")(),A=p.colorAttachments[0].texture;else throw new Error("No texture");i.activeTexture(33984+s),i.bindTexture(A.target,A.handle),s+=1;break;case"sampler":break;case"storage":case"read-only-storage":throw new Error(`binding type '${h.type}' not supported in WebGL`)}}}_applyUniforms(){for(const i of this.shaderLayout.uniforms||[]){const{name:s,location:c,type:h,textureUnit:p}=i,v=this.uniforms[s]??p;v!==void 0&&Vq(this.device.gl,c,h,v)}}}class Hq extends eT{constructor(i){super(i,{});fe(this,"device");fe(this,"commands",[]);this.device=i}submitCommands(i=this.commands){for(const s of i)switch(s.name){case"copy-buffer-to-buffer":qq(this.device,s.options);break;case"copy-buffer-to-texture":Gq(this.device,s.options);break;case"copy-texture-to-buffer":Xq(this.device,s.options);break;case"copy-texture-to-texture":Zq(this.device,s.options);break}}}function qq(t,e){const i=e.source,s=e.destination;t.gl.bindBuffer(36662,i.handle),t.gl.bindBuffer(36663,s.handle),t.gl.copyBufferSubData(36662,36663,e.sourceOffset??0,e.destinationOffset??0,e.size),t.gl.bindBuffer(36662,null),t.gl.bindBuffer(36663,null)}function Gq(t,e){throw new Error("Not implemented")}function Xq(t,e){const{source:i,mipLevel:s=0,aspect:c="all",width:h=e.source.width,height:p=e.source.height,depthOrArrayLayers:v=0,origin:l=[0,0],destination:A,byteOffset:P=0,bytesPerRow:O,rowsPerImage:L}=e;if(c!=="all")throw new Error("not supported");if(s!==0||v!==0||O||L)throw new Error("not implemented");const{framebuffer:U,destroyFramebuffer:H}=AL(i);let Y;try{const J=A,oe=h||U.width,me=p||U.height,pe=dv(U.texture.props.format),be=pe.dataFormat,Oe=pe.type;t.gl.bindBuffer(35051,J.handle),Y=t.gl.bindFramebuffer(36160,U.handle),t.gl.readPixels(l[0],l[1],oe,me,be,Oe,P)}finally{t.gl.bindBuffer(35051,null),Y!==void 0&&t.gl.bindFramebuffer(36160,Y),H&&U.destroy()}}function Zq(t,e){const{source:i,destinationMipLevel:s=0,origin:c=[0,0],destinationOrigin:h=[0,0],destination:p}=e;let{width:v=e.destination.width,height:l=e.destination.height}=e;const{framebuffer:A,destroyFramebuffer:P}=AL(i),[O,L]=c,[U,H,Y]=h,J=t.gl.bindFramebuffer(36160,A.handle);let oe=null,me;if(p instanceof il)oe=p,v=Number.isFinite(v)?v:oe.width,l=Number.isFinite(l)?l:oe.height,oe.bind(0),me=oe.target;else throw new Error("invalid destination");switch(me){case 3553:case 34067:t.gl.copyTexSubImage2D(me,s,U,H,O,L,v,l);break;case 35866:case 32879:t.gl.copyTexSubImage3D(me,s,U,H,Y,O,L,v,l);break}oe&&oe.unbind(),t.gl.bindFramebuffer(36160,J),P&&A.destroy()}function AL(t){if(t instanceof Xo){const{width:e,height:i,id:s}=t;return{framebuffer:t.device.createFramebuffer({id:`framebuffer-for-${s}`,width:e,height:i,colorAttachments:[t]}),destroyFramebuffer:!0}}return{framebuffer:t,destroyFramebuffer:!1}}class Yq extends Qw{constructor(i,s){super(i,s);fe(this,"device");fe(this,"commandBuffer");this.device=i,this.commandBuffer=new Hq(i)}destroy(){}finish(){this.commandBuffer.submitCommands()}copyBufferToBuffer(i){this.commandBuffer.commands.push({name:"copy-buffer-to-buffer",options:i})}copyBufferToTexture(i){this.commandBuffer.commands.push({name:"copy-buffer-to-texture",options:i})}copyTextureToBuffer(i){this.commandBuffer.commands.push({name:"copy-texture-to-buffer",options:i})}copyTextureToTexture(i){this.commandBuffer.commands.push({name:"copy-texture-to-texture",options:i})}pushDebugGroup(i){}popDebugGroup(){}insertDebugMarker(i){}resolveQuerySet(i,s,c){}}class RE extends tT{constructor(i,s){super(i,s);fe(this,"device");fe(this,"handle");fe(this,"buffer",null);fe(this,"bufferValue",null);this.device=i,this.handle=this.device.gl.createVertexArray()}get[Symbol.toStringTag](){return"VertexArray"}static isConstantAttributeZeroSupported(i){return FU()==="Chrome"}destroy(){var i;super.destroy(),this.buffer&&((i=this.buffer)==null||i.destroy()),this.handle&&(this.device.gl.deleteVertexArray(this.handle),this.handle=void 0)}setIndexBuffer(i){const s=i;if(s&&s.glTarget!==34963)throw new Error("Use .setBuffer()");this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34963,s?s.handle:null),this.indexBuffer=s,this.device.gl.bindVertexArray(null)}setBuffer(i,s){const c=s;if(c.glTarget===34963)throw new Error("Use .setIndexBuffer()");const{size:h,type:p,stride:v,offset:l,normalized:A,integer:P,divisor:O}=this._getAccessor(i);this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34962,c.handle),P?this.device.gl.vertexAttribIPointer(i,h,p,v,l):this.device.gl.vertexAttribPointer(i,h,p,A,v,l),this.device.gl.enableVertexAttribArray(i),this.device.gl.vertexAttribDivisor(i,O||0),this.attributes[i]=c,this.device.gl.bindVertexArray(null)}setConstantWebGL(i,s){this._enable(i,!1),this.attributes[i]=s}bindBeforeRender(){this.device.gl.bindVertexArray(this.handle),this._applyConstantAttributes()}unbindAfterRender(){this.device.gl.bindVertexArray(null)}_applyConstantAttributes(){for(let i=0;i<this.maxVertexAttributes;++i){const s=this.attributes[i];ArrayBuffer.isView(s)&&this.device.setConstantAttributeWebGL(i,s)}}_getAccessor(i){const s=this.attributeInfos[i];if(!s)throw new Error(`Unknown attribute location ${i}`);const c=vL(s.bufferDataType);return{size:s.bufferComponents,type:c,stride:s.byteStride,offset:s.byteOffset,normalized:s.normalized,integer:s.integer,divisor:s.stepMode==="instance"?1:0}}_enable(i,s=!0){const h=RE.isConstantAttributeZeroSupported(this.device)||i!==0;(s||h)&&(i=Number(i),this.device.gl.bindVertexArray(this.handle),s?this.device.gl.enableVertexAttribArray(i):this.device.gl.disableVertexAttribArray(i),this.device.gl.bindVertexArray(null))}getConstantBuffer(i,s){const c=Kq(s),h=c.byteLength*i,p=c.length*i;if(this.buffer&&h!==this.buffer.byteLength)throw new Error(`Buffer size is immutable, byte length ${h} !== ${this.buffer.byteLength}.`);let v=!this.buffer;if(this.buffer=this.buffer||this.device.createBuffer({byteLength:h}),v=v||!Jq(c,this.bufferValue),v){const l=C7(s.constructor,p);P7({target:l,source:c,start:0,count:p}),this.buffer.write(l),this.bufferValue=s}return this.buffer}}function Kq(t){return Array.isArray(t)?new Float32Array(t):t}function Jq(t,e){if(!t||!e||t.length!==e.length||t.constructor!==e.constructor)return!1;for(let i=0;i<t.length;++i)if(t[i]!==e[i])return!1;return!0}class Qq extends iT{constructor(i,s){super(i,s);fe(this,"device");fe(this,"gl");fe(this,"handle");fe(this,"layout");fe(this,"buffers",{});fe(this,"unusedBuffers",{});fe(this,"bindOnUse",!0);fe(this,"_bound",!1);this.device=i,this.gl=i.gl,this.handle=this.props.handle||this.gl.createTransformFeedback(),this.layout=this.props.layout,s.buffers&&this.setBuffers(s.buffers),Object.seal(this)}destroy(){this.gl.deleteTransformFeedback(this.handle),super.destroy()}begin(i="point-list"){this.gl.bindTransformFeedback(36386,this.handle),this.bindOnUse&&this._bindBuffers(),this.gl.beginTransformFeedback($q(i))}end(){this.gl.endTransformFeedback(),this.bindOnUse||this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null)}setBuffers(i){this.buffers={},this.unusedBuffers={},this.bind(()=>{for(const s in i)this.setBuffer(s,i[s])})}setBuffer(i,s){const c=this._getVaryingIndex(i),{buffer:h,byteLength:p,byteOffset:v}=this._getBufferRange(s);if(c<0){this.unusedBuffers[i]=h,Jt.warn(`${this.id} unusedBuffers varying buffer ${i}`)();return}this.buffers[c]={buffer:h,byteLength:p,byteOffset:v},this.bindOnUse||this._bindBuffer(c,h,v,p)}getBuffer(i){if(FI(i))return this.buffers[i]||null;const s=this._getVaryingIndex(i);return s>=0?this.buffers[s]:null}bind(i=this.handle){if(typeof i!="function")return this.gl.bindTransformFeedback(36386,i),this;let s;return this._bound?s=i():(this.gl.bindTransformFeedback(36386,this.handle),this._bound=!0,s=i(),this._bound=!1,this.gl.bindTransformFeedback(36386,null)),s}unbind(){this.bind(null)}_getBufferRange(i){if(i instanceof zc)return{buffer:i,byteOffset:0,byteLength:i.byteLength};const{buffer:s,byteOffset:c=0,byteLength:h=i.buffer.byteLength}=i;return{buffer:s,byteOffset:c,byteLength:h}}_getVaryingIndex(i){if(FI(i))return Number(i);for(const s of this.layout.varyings)if(i===s.name)return s.location;return-1}_bindBuffers(){for(const i in this.buffers){const{buffer:s,byteLength:c,byteOffset:h}=this._getBufferRange(this.buffers[i]);this._bindBuffer(Number(i),s,h,c)}}_unbindBuffers(){for(const i in this.buffers)this.gl.bindBufferBase(35982,Number(i),null)}_bindBuffer(i,s,c=0,h){const p=s&&s.handle;!p||h===void 0?this.gl.bindBufferBase(35982,i,p):this.gl.bindBufferRange(35982,i,p,c,h)}}function FI(t){return typeof t=="number"?Number.isInteger(t):/^\d+$/.test(t)}class eG extends rT{constructor(i,s){super(i,s);fe(this,"device");fe(this,"handle");fe(this,"target",null);fe(this,"_queryPending",!1);fe(this,"_pollingPromise",null);if(this.device=i,s.count>1)throw new Error("WebGL QuerySet can only have one value");this.handle=this.device.gl.createQuery(),Object.seal(this)}get[Symbol.toStringTag](){return"Query"}destroy(){this.device.gl.deleteQuery(this.handle)}beginTimestampQuery(){return this._begin(35007)}endTimestampQuery(){this._end()}beginOcclusionQuery(i){return this._begin(i!=null&&i.conservative?36202:35887)}endOcclusionQuery(){this._end()}beginTransformFeedbackQuery(){return this._begin(35976)}endTransformFeedbackQuery(){this._end()}async resolveQuery(){return[await this.pollQuery()]}_begin(i){this._queryPending||(this.target=i,this.device.gl.beginQuery(this.target,this.handle))}_end(){this._queryPending||this.target&&(this.device.gl.endQuery(this.target),this.target=null,this._queryPending=!0)}isResultAvailable(){if(!this._queryPending)return!1;const i=this.device.gl.getQueryParameter(this.handle,34919);return i&&(this._queryPending=!1),i}isTimerDisjoint(){return this.device.gl.getParameter(36795)}getResult(){return this.device.gl.getQueryParameter(this.handle,34918)}getTimerMilliseconds(){return this.getResult()/1e6}pollQuery(i=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let s=0;return this._pollingPromise=new Promise((c,h)=>{const p=()=>{this.isResultAvailable()?(c(this.getResult()),this._pollingPromise=null):s++>i?(h("Timed out"),this._pollingPromise=null):requestAnimationFrame(p)};requestAnimationFrame(p)}),this._pollingPromise}}function ML(t){switch(t){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return Bn(!1),0}}function tG(t){switch(t){case 5121:return 1;case 33635:case 32819:case 32820:return 2;case 5126:return 4;default:return Bn(!1),0}}function iG(t,e){var J,oe;const{sourceX:i=0,sourceY:s=0,sourceFormat:c=6408,sourceAttachment:h=36064}=e||{};let{target:p=null,sourceWidth:v,sourceHeight:l,sourceType:A}=e||{};const{framebuffer:P,deleteFramebuffer:O}=CL(t);Bn(P);const{gl:L,handle:U}=P;v=v||P.width,l=l||P.height;const H=h-36064;A=A||((oe=(J=P.colorAttachments[H])==null?void 0:J.texture)==null?void 0:oe.type)||5121,p=sG(p,A,c,v,l),A=A||Mq(p);const Y=L.bindFramebuffer(36160,U);return L.readPixels(i,s,v,l,c,A,p),L.bindFramebuffer(36160,Y||null),O&&P.destroy(),p}function rG(t,e){const{target:i,sourceX:s=0,sourceY:c=0,sourceFormat:h=6408,targetByteOffset:p=0}=e||{};let{sourceWidth:v,sourceHeight:l,sourceType:A}=e||{};const{framebuffer:P,deleteFramebuffer:O}=CL(t);Bn(P),v=v||P.width,l=l||P.height;const L=P;A=A||5121;let U=i;if(!U){const Y=ML(h),J=tG(A),oe=p+v*l*Y*J;U=L.device.createBuffer({byteLength:oe})}const H=t.device.createCommandEncoder();return H.copyTextureToBuffer({source:t,width:v,height:l,origin:[s,c],destination:U,byteOffset:p}),H.destroy(),O&&P.destroy(),U}function CL(t){return t instanceof sv?{framebuffer:t,deleteFramebuffer:!1}:{framebuffer:nG(t),deleteFramebuffer:!0}}function nG(t,e){const{device:i,width:s,height:c,id:h}=t;return i.createFramebuffer({...e,id:`framebuffer-for-${h}`,width:s,height:c,colorAttachments:[t]})}function sG(t,e,i,s,c){if(t)return t;e=e||5121;const h=yT(e,{clamped:!1}),p=ML(i);return new h(s*c*p)}const oG=256,aG=1024,lG=16384,cG="clear: bad arguments";function uG(t,e){const{framebuffer:i=null,color:s=null,depth:c=null,stencil:h=null}=e||{},p={};i&&(p.framebuffer=i);let v=0;s&&(v|=lG,s!==!0&&(p.clearColor=s)),c&&(v|=oG,c!==!0&&(p.clearDepth=c)),h&&(v|=aG,c!==!0&&(p.clearStencil=c)),Bn(v!==0,cG);const l=t.gl;Lc(l,p,()=>{l.clear(v)})}const Fm=1,th=class th extends uh{constructor(i){var l,A;super({...i,id:i.id||Ph("webgl-device")});fe(this,"type","webgl");fe(this,"handle");fe(this,"features");fe(this,"limits");fe(this,"info");fe(this,"canvasContext");fe(this,"lost");fe(this,"_resolveContextLost");fe(this,"renderPass",null);fe(this,"gl");fe(this,"debug",!1);fe(this,"_canvasSizeInfo",{clientWidth:0,clientHeight:0,devicePixelRatio:1});fe(this,"_extensions",{});fe(this,"_polyfilled",!1);fe(this,"spectorJS");fe(this,"_constants");const s=(l=i.gl)==null?void 0:l.device;if(s)throw new Error(`WebGL context already attached to device ${s.id}`);const c=((A=i.gl)==null?void 0:A.canvas)||i.canvas;this.canvasContext=new oq(this,{...i,canvas:c}),this.lost=new Promise(P=>{this._resolveContextLost=P});let h=i.gl||null;if(h||(h=SH(this.canvasContext.canvas,{...i,onContextLost:P=>{var O;return(O=this._resolveContextLost)==null?void 0:O.call(this,{reason:"destroyed",message:"Entered sleep mode, or too many apps or browser tabs are using the GPU."})}})),!h)throw new Error("WebGL context creation failed");this.handle=h,this.gl=h,this.gl.device=this,this.gl._version=2,this.info=AH(this.gl,this._extensions),this.limits=new qH(this.gl),this.features=new HH(this.gl,this._extensions,this.props.disabledFeatures),this.props.initalizeFeatures&&this.features.initializeFeatures(),this.canvasContext.resize();const{enable:p=!0,copyState:v=!1}=i;gL(this.gl,{enable:p,copyState:v,log:(...P)=>Jt.log(1,...P)()}),i.debug&&(this.gl=pq(this.gl,{...i,throwOnError:!0}),this.debug=!0,Jt.level=Math.max(Jt.level,1),Jt.warn("WebGL debug mode activated. Performance reduced.")()),i.spector&&(this.spectorJS=hq({...this.props,canvas:this.handle.canvas}))}static isSupported(){return typeof WebGL2RenderingContext<"u"}static attach(i){if(i instanceof th)return i;if((i==null?void 0:i.device)instanceof uh)return i.device;if(!hG(i))throw new Error("Invalid WebGL2RenderingContext");return new th({gl:i})}static async create(i={}){var v;Jt.groupCollapsed(Fm,"WebGLDevice created")();const s=[];i.debug&&s.push(fq()),i.spector&&s.push(uq()),typeof i.canvas=="string"&&s.push(vE.pageLoaded);const c=await Promise.allSettled(s);for(const l of c)l.status==="rejected"&&Jt.error(`Failed to initialize debug libraries ${l.reason}`)();if(Jt.probe(Fm+1,"DOM is loaded")(),(v=i.gl)!=null&&v.device)return Jt.warn("reattaching existing device")(),th.attach(i.gl);const h=new th(i),p=`Created ${h.type}${h.debug?" debug":""} context: ${h.info.vendor}, ${h.info.renderer} for canvas: ${h.canvasContext.id}`;return Jt.probe(Fm,p)(),Jt.table(Fm,h.info)(),Jt.groupEnd(Fm)(),h}destroy(){}get isLost(){return this.gl.isContextLost()}getSize(){return[this.gl.drawingBufferWidth,this.gl.drawingBufferHeight]}isTextureFormatSupported(i){return IE(this.gl,i,this._extensions)}isTextureFormatFilterable(i){return VH(this.gl,i,this._extensions)}isTextureFormatRenderable(i){return jH(this.gl,i,this._extensions)}createCanvasContext(i){throw new Error("WebGL only supports a single canvas")}createBuffer(i){const s=this._getBufferProps(i);return new zc(this,s)}_createTexture(i){return new il(this,i)}createExternalTexture(i){throw new Error("createExternalTexture() not implemented")}createSampler(i){return new gT(this,i)}createShader(i){return new xq(this,i)}createFramebuffer(i){return new o_(this,i)}createVertexArray(i){return new RE(this,i)}createTransformFeedback(i){return new Qq(this,i)}createQuerySet(i){return new eG(this,i)}createRenderPipeline(i){return new Wq(this,i)}beginRenderPass(i){return new Sq(this,i)}createComputePipeline(i){throw new Error("ComputePipeline not supported in WebGL")}beginComputePass(i){throw new Error("ComputePass not supported in WebGL")}createCommandEncoder(i){return new Yq(this,i)}submit(){var i;(i=this.renderPass)==null||i.end(),this.renderPass=null}readPixelsToArrayWebGL(i,s){return iG(i,s)}readPixelsToBufferWebGL(i,s){return rG(i,s)}setParametersWebGL(i){Of(this.gl,i)}getParametersWebGL(i){return _L(this.gl,i)}withParametersWebGL(i,s){return Lc(this.gl,i,s)}clearWebGL(i){uG(this,i)}resetWebGL(){Jt.warn("WebGLDevice.resetWebGL is deprecated, use only for debugging")(),yH(this.gl)}loseDevice(){var h;let i=!1;const c=this.getExtension("WEBGL_lose_context").WEBGL_lose_context;return c&&(i=!0,c.loseContext()),(h=this._resolveContextLost)==null||h.call(this,{reason:"destroyed",message:"Application triggered context loss"}),i}pushState(){f1(this.gl)}popState(){P_(this.gl)}setSpectorMetadata(i,s){i.__SPECTOR_Metadata=s}getGLKey(i,s){s=s||this.gl2||this.gl;const c=Number(i);for(const h in s)if(s[h]===c)return`GL.${h}`;return String(i)}setConstantAttributeWebGL(i,s){const c=this.limits.maxVertexAttributes;this._constants=this._constants||new Array(c).fill(null);const h=this._constants[i];switch(h&&mG(h,s)&&Jt.info(1,`setConstantAttributeWebGL(${i}) could have been skipped, value unchanged`)(),this._constants[i]=s,s.constructor){case Float32Array:dG(this,i,s);break;case Int32Array:fG(this,i,s);break;case Uint32Array:pG(this,i,s);break;default:Bn(!1)}}getExtension(i){return Wc(this.gl,i,this._extensions),this._extensions}};fe(th,"type","webgl");let l_=th;function hG(t){return typeof WebGL2RenderingContext<"u"&&t instanceof WebGL2RenderingContext?!0:!!(t&&Number.isFinite(t._version))}function dG(t,e,i){switch(i.length){case 1:t.gl.vertexAttrib1fv(e,i);break;case 2:t.gl.vertexAttrib2fv(e,i);break;case 3:t.gl.vertexAttrib3fv(e,i);break;case 4:t.gl.vertexAttrib4fv(e,i);break;default:Bn(!1)}}function fG(t,e,i){t.gl.vertexAttribI4iv(e,i)}function pG(t,e,i){t.gl.vertexAttribI4uiv(e,i)}function mG(t,e){if(!t||!e||t.length!==e.length||t.constructor!==e.constructor)return!1;for(let i=0;i<t.length;++i)if(t[i]!==e[i])return!1;return!0}var PL={exports:{}};/*! Hammer.JS - v2.0.7 - 2016-04-22
 * http://hammerjs.github.io/
 *
 * Copyright (c) 2016 Jorik Tangelder;
 * Licensed under the MIT license */(function(t){(function(e,i,s,c){var h=["","webkit","Moz","MS","ms","o"],p=i.createElement("div"),v="function",l=Math.round,A=Math.abs,P=Date.now;function O(ue,ge,_e){return setTimeout(pe(ue,_e),ge)}function L(ue,ge,_e){return Array.isArray(ue)?(U(ue,_e[ge],_e),!0):!1}function U(ue,ge,_e){var ze;if(ue)if(ue.forEach)ue.forEach(ge,_e);else if(ue.length!==c)for(ze=0;ze<ue.length;)ge.call(_e,ue[ze],ze,ue),ze++;else for(ze in ue)ue.hasOwnProperty(ze)&&ge.call(_e,ue[ze],ze,ue)}function H(ue,ge,_e){var ze="DEPRECATED METHOD: "+ge+`
`+_e+` AT 
`;return function(){var ft=new Error("get-stack-trace"),ni=ft&&ft.stack?ft.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",fr=e.console&&(e.console.warn||e.console.log);return fr&&fr.call(e.console,ze,ni),ue.apply(this,arguments)}}var Y;typeof Object.assign!="function"?Y=function(ge){if(ge===c||ge===null)throw new TypeError("Cannot convert undefined or null to object");for(var _e=Object(ge),ze=1;ze<arguments.length;ze++){var ft=arguments[ze];if(ft!==c&&ft!==null)for(var ni in ft)ft.hasOwnProperty(ni)&&(_e[ni]=ft[ni])}return _e}:Y=Object.assign;var J=H(function(ge,_e,ze){for(var ft=Object.keys(_e),ni=0;ni<ft.length;)(!ze||ze&&ge[ft[ni]]===c)&&(ge[ft[ni]]=_e[ft[ni]]),ni++;return ge},"extend","Use `assign`."),oe=H(function(ge,_e){return J(ge,_e,!0)},"merge","Use `assign`.");function me(ue,ge,_e){var ze=ge.prototype,ft;ft=ue.prototype=Object.create(ze),ft.constructor=ue,ft._super=ze,_e&&Y(ft,_e)}function pe(ue,ge){return function(){return ue.apply(ge,arguments)}}function be(ue,ge){return typeof ue==v?ue.apply(ge&&ge[0]||c,ge):ue}function Oe(ue,ge){return ue===c?ge:ue}function je(ue,ge,_e){U(it(ge),function(ze){ue.addEventListener(ze,_e,!1)})}function st(ue,ge,_e){U(it(ge),function(ze){ue.removeEventListener(ze,_e,!1)})}function ut(ue,ge){for(;ue;){if(ue==ge)return!0;ue=ue.parentNode}return!1}function xe(ue,ge){return ue.indexOf(ge)>-1}function it(ue){return ue.trim().split(/\s+/g)}function Be(ue,ge,_e){if(ue.indexOf&&!_e)return ue.indexOf(ge);for(var ze=0;ze<ue.length;){if(_e&&ue[ze][_e]==ge||!_e&&ue[ze]===ge)return ze;ze++}return-1}function Qe(ue){return Array.prototype.slice.call(ue,0)}function Ct(ue,ge,_e){for(var ze=[],ft=[],ni=0;ni<ue.length;){var fr=ge?ue[ni][ge]:ue[ni];Be(ft,fr)<0&&ze.push(ue[ni]),ft[ni]=fr,ni++}return _e&&(ge?ze=ze.sort(function(Wn,Hn){return Wn[ge]>Hn[ge]}):ze=ze.sort()),ze}function Kt(ue,ge){for(var _e,ze,ft=ge[0].toUpperCase()+ge.slice(1),ni=0;ni<h.length;){if(_e=h[ni],ze=_e?_e+ft:ge,ze in ue)return ze;ni++}return c}var Ie=1;function fi(){return Ie++}function Yi(ue){var ge=ue.ownerDocument||ue;return ge.defaultView||ge.parentWindow||e}var ri=/mobile|tablet|ip(ad|hone|od)|android/i,vr="ontouchstart"in e,Gr=Kt(e,"PointerEvent")!==c,Tr=vr&&ri.test(navigator.userAgent),Ar="touch",kr="pen",$r="mouse",Vn="kinect",Pn=25,Si=1,Ir=2,Er=4,Ki=8,In=1,gn=2,Kn=4,mr=8,cn=16,Dr=gn|Kn,yn=mr|cn,Rn=Dr|yn,ir=["x","y"],Ni=["clientX","clientY"];function _r(ue,ge){var _e=this;this.manager=ue,this.callback=ge,this.element=ue.element,this.target=ue.options.inputTarget,this.domHandler=function(ze){be(ue.options.enable,[ue])&&_e.handler(ze)},this.init()}_r.prototype={handler:function(){},init:function(){this.evEl&&je(this.element,this.evEl,this.domHandler),this.evTarget&&je(this.target,this.evTarget,this.domHandler),this.evWin&&je(Yi(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&st(this.element,this.evEl,this.domHandler),this.evTarget&&st(this.target,this.evTarget,this.domHandler),this.evWin&&st(Yi(this.element),this.evWin,this.domHandler)}};function Ur(ue){var ge,_e=ue.options.inputClass;return _e?ge=_e:Gr?ge=zi:Tr?ge=Yr:vr?ge=yt:ge=pi,new ge(ue,Cr)}function Cr(ue,ge,_e){var ze=_e.pointers.length,ft=_e.changedPointers.length,ni=ge&Si&&ze-ft===0,fr=ge&(Er|Ki)&&ze-ft===0;_e.isFirst=!!ni,_e.isFinal=!!fr,ni&&(ue.session={}),_e.eventType=ge,Oi(ue,_e),ue.emit("hammer.input",_e),ue.recognize(_e),ue.session.prevInput=_e}function Oi(ue,ge){var _e=ue.session,ze=ge.pointers,ft=ze.length;_e.firstInput||(_e.firstInput=ie(ge)),ft>1&&!_e.firstMultiple?_e.firstMultiple=ie(ge):ft===1&&(_e.firstMultiple=!1);var ni=_e.firstInput,fr=_e.firstMultiple,_i=fr?fr.center:ni.center,Wn=ge.center=he(ze);ge.timeStamp=P(),ge.deltaTime=ge.timeStamp-ni.timeStamp,ge.angle=lt(_i,Wn),ge.distance=Je(_i,Wn),Nr(_e,ge),ge.offsetDirection=Xe(ge.deltaX,ge.deltaY);var Hn=Te(ge.deltaTime,ge.deltaX,ge.deltaY);ge.overallVelocityX=Hn.x,ge.overallVelocityY=Hn.y,ge.overallVelocity=A(Hn.x)>A(Hn.y)?Hn.x:Hn.y,ge.scale=fr?Se(fr.pointers,ze):1,ge.rotation=fr?It(fr.pointers,ze):0,ge.maxPointers=_e.prevInput?ge.pointers.length>_e.prevInput.maxPointers?ge.pointers.length:_e.prevInput.maxPointers:ge.pointers.length,Ke(_e,ge);var Cs=ue.element;ut(ge.srcEvent.target,Cs)&&(Cs=ge.srcEvent.target),ge.target=Cs}function Nr(ue,ge){var _e=ge.center,ze=ue.offsetDelta||{},ft=ue.prevDelta||{},ni=ue.prevInput||{};(ge.eventType===Si||ni.eventType===Er)&&(ft=ue.prevDelta={x:ni.deltaX||0,y:ni.deltaY||0},ze=ue.offsetDelta={x:_e.x,y:_e.y}),ge.deltaX=ft.x+(_e.x-ze.x),ge.deltaY=ft.y+(_e.y-ze.y)}function Ke(ue,ge){var _e=ue.lastInterval||ge,ze=ge.timeStamp-_e.timeStamp,ft,ni,fr,_i;if(ge.eventType!=Ki&&(ze>Pn||_e.velocity===c)){var Wn=ge.deltaX-_e.deltaX,Hn=ge.deltaY-_e.deltaY,Cs=Te(ze,Wn,Hn);ni=Cs.x,fr=Cs.y,ft=A(Cs.x)>A(Cs.y)?Cs.x:Cs.y,_i=Xe(Wn,Hn),ue.lastInterval=ge}else ft=_e.velocity,ni=_e.velocityX,fr=_e.velocityY,_i=_e.direction;ge.velocity=ft,ge.velocityX=ni,ge.velocityY=fr,ge.direction=_i}function ie(ue){for(var ge=[],_e=0;_e<ue.pointers.length;)ge[_e]={clientX:l(ue.pointers[_e].clientX),clientY:l(ue.pointers[_e].clientY)},_e++;return{timeStamp:P(),pointers:ge,center:he(ge),deltaX:ue.deltaX,deltaY:ue.deltaY}}function he(ue){var ge=ue.length;if(ge===1)return{x:l(ue[0].clientX),y:l(ue[0].clientY)};for(var _e=0,ze=0,ft=0;ft<ge;)_e+=ue[ft].clientX,ze+=ue[ft].clientY,ft++;return{x:l(_e/ge),y:l(ze/ge)}}function Te(ue,ge,_e){return{x:ge/ue||0,y:_e/ue||0}}function Xe(ue,ge){return ue===ge?In:A(ue)>=A(ge)?ue<0?gn:Kn:ge<0?mr:cn}function Je(ue,ge,_e){_e||(_e=ir);var ze=ge[_e[0]]-ue[_e[0]],ft=ge[_e[1]]-ue[_e[1]];return Math.sqrt(ze*ze+ft*ft)}function lt(ue,ge,_e){_e||(_e=ir);var ze=ge[_e[0]]-ue[_e[0]],ft=ge[_e[1]]-ue[_e[1]];return Math.atan2(ft,ze)*180/Math.PI}function It(ue,ge){return lt(ge[1],ge[0],Ni)+lt(ue[1],ue[0],Ni)}function Se(ue,ge){return Je(ge[0],ge[1],Ni)/Je(ue[0],ue[1],Ni)}var ot={mousedown:Si,mousemove:Ir,mouseup:Er},xt="mousedown",$t="mousemove mouseup";function pi(){this.evEl=xt,this.evWin=$t,this.pressed=!1,_r.apply(this,arguments)}me(pi,_r,{handler:function(ge){var _e=ot[ge.type];_e&Si&&ge.button===0&&(this.pressed=!0),_e&Ir&&ge.which!==1&&(_e=Er),this.pressed&&(_e&Er&&(this.pressed=!1),this.callback(this.manager,_e,{pointers:[ge],changedPointers:[ge],pointerType:$r,srcEvent:ge}))}});var Wi={pointerdown:Si,pointermove:Ir,pointerup:Er,pointercancel:Ki,pointerout:Ki},xr={2:Ar,3:kr,4:$r,5:Vn},Hi="pointerdown",Ci="pointermove pointerup pointercancel";e.MSPointerEvent&&!e.PointerEvent&&(Hi="MSPointerDown",Ci="MSPointerMove MSPointerUp MSPointerCancel");function zi(){this.evEl=Hi,this.evWin=Ci,_r.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}me(zi,_r,{handler:function(ge){var _e=this.store,ze=!1,ft=ge.type.toLowerCase().replace("ms",""),ni=Wi[ft],fr=xr[ge.pointerType]||ge.pointerType,_i=fr==Ar,Wn=Be(_e,ge.pointerId,"pointerId");ni&Si&&(ge.button===0||_i)?Wn<0&&(_e.push(ge),Wn=_e.length-1):ni&(Er|Ki)&&(ze=!0),!(Wn<0)&&(_e[Wn]=ge,this.callback(this.manager,ni,{pointers:_e,changedPointers:[ge],pointerType:fr,srcEvent:ge}),ze&&_e.splice(Wn,1))}});var er={touchstart:Si,touchmove:Ir,touchend:Er,touchcancel:Ki},Rr="touchstart",nn="touchstart touchmove touchend touchcancel";function br(){this.evTarget=Rr,this.evWin=nn,this.started=!1,_r.apply(this,arguments)}me(br,_r,{handler:function(ge){var _e=er[ge.type];if(_e===Si&&(this.started=!0),!!this.started){var ze=Ln.call(this,ge,_e);_e&(Er|Ki)&&ze[0].length-ze[1].length===0&&(this.started=!1),this.callback(this.manager,_e,{pointers:ze[0],changedPointers:ze[1],pointerType:Ar,srcEvent:ge})}}});function Ln(ue,ge){var _e=Qe(ue.touches),ze=Qe(ue.changedTouches);return ge&(Er|Ki)&&(_e=Ct(_e.concat(ze),"identifier",!0)),[_e,ze]}var rs={touchstart:Si,touchmove:Ir,touchend:Er,touchcancel:Ki},ns="touchstart touchmove touchend touchcancel";function Yr(){this.evTarget=ns,this.targetIds={},_r.apply(this,arguments)}me(Yr,_r,{handler:function(ge){var _e=rs[ge.type],ze=un.call(this,ge,_e);ze&&this.callback(this.manager,_e,{pointers:ze[0],changedPointers:ze[1],pointerType:Ar,srcEvent:ge})}});function un(ue,ge){var _e=Qe(ue.touches),ze=this.targetIds;if(ge&(Si|Ir)&&_e.length===1)return ze[_e[0].identifier]=!0,[_e,_e];var ft,ni,fr=Qe(ue.changedTouches),_i=[],Wn=this.target;if(ni=_e.filter(function(Hn){return ut(Hn.target,Wn)}),ge===Si)for(ft=0;ft<ni.length;)ze[ni[ft].identifier]=!0,ft++;for(ft=0;ft<fr.length;)ze[fr[ft].identifier]&&_i.push(fr[ft]),ge&(Er|Ki)&&delete ze[fr[ft].identifier],ft++;if(_i.length)return[Ct(ni.concat(_i),"identifier",!0),_i]}var et=2500,nt=25;function yt(){_r.apply(this,arguments);var ue=pe(this.handler,this);this.touch=new Yr(this.manager,ue),this.mouse=new pi(this.manager,ue),this.primaryTouch=null,this.lastTouches=[]}me(yt,_r,{handler:function(ge,_e,ze){var ft=ze.pointerType==Ar,ni=ze.pointerType==$r;if(!(ni&&ze.sourceCapabilities&&ze.sourceCapabilities.firesTouchEvents)){if(ft)St.call(this,_e,ze);else if(ni&&Dt.call(this,ze))return;this.callback(ge,_e,ze)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});function St(ue,ge){ue&Si?(this.primaryTouch=ge.changedPointers[0].identifier,wt.call(this,ge)):ue&(Er|Ki)&&wt.call(this,ge)}function wt(ue){var ge=ue.changedPointers[0];if(ge.identifier===this.primaryTouch){var _e={x:ge.clientX,y:ge.clientY};this.lastTouches.push(_e);var ze=this.lastTouches,ft=function(){var ni=ze.indexOf(_e);ni>-1&&ze.splice(ni,1)};setTimeout(ft,et)}}function Dt(ue){for(var ge=ue.srcEvent.clientX,_e=ue.srcEvent.clientY,ze=0;ze<this.lastTouches.length;ze++){var ft=this.lastTouches[ze],ni=Math.abs(ge-ft.x),fr=Math.abs(_e-ft.y);if(ni<=nt&&fr<=nt)return!0}return!1}var kt=Kt(p.style,"touchAction"),vt=kt!==c,Ft="compute",At="auto",ui="manipulation",bi="none",Gt="pan-x",hr="pan-y",Lr=jn();function Pr(ue,ge){this.manager=ue,this.set(ge)}Pr.prototype={set:function(ue){ue==Ft&&(ue=this.compute()),vt&&this.manager.element.style&&Lr[ue]&&(this.manager.element.style[kt]=ue),this.actions=ue.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var ue=[];return U(this.manager.recognizers,function(ge){be(ge.options.enable,[ge])&&(ue=ue.concat(ge.getTouchAction()))}),bn(ue.join(" "))},preventDefaults:function(ue){var ge=ue.srcEvent,_e=ue.offsetDirection;if(this.manager.session.prevented){ge.preventDefault();return}var ze=this.actions,ft=xe(ze,bi)&&!Lr[bi],ni=xe(ze,hr)&&!Lr[hr],fr=xe(ze,Gt)&&!Lr[Gt];if(ft){var _i=ue.pointers.length===1,Wn=ue.distance<2,Hn=ue.deltaTime<250;if(_i&&Wn&&Hn)return}if(!(fr&&ni)&&(ft||ni&&_e&Dr||fr&&_e&yn))return this.preventSrc(ge)},preventSrc:function(ue){this.manager.session.prevented=!0,ue.preventDefault()}};function bn(ue){if(xe(ue,bi))return bi;var ge=xe(ue,Gt),_e=xe(ue,hr);return ge&&_e?bi:ge||_e?ge?Gt:hr:xe(ue,ui)?ui:At}function jn(){if(!vt)return!1;var ue={},ge=e.CSS&&e.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(_e){ue[_e]=ge?e.CSS.supports("touch-action",_e):!0}),ue}var qi=1,hn=2,ss=4,sn=8,ws=sn,As=16,hs=32;function ks(ue){this.options=Y({},this.defaults,ue||{}),this.id=fi(),this.manager=null,this.options.enable=Oe(this.options.enable,!0),this.state=qi,this.simultaneous={},this.requireFail=[]}ks.prototype={defaults:{},set:function(ue){return Y(this.options,ue),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(ue){if(L(ue,"recognizeWith",this))return this;var ge=this.simultaneous;return ue=eo(ue,this),ge[ue.id]||(ge[ue.id]=ue,ue.recognizeWith(this)),this},dropRecognizeWith:function(ue){return L(ue,"dropRecognizeWith",this)?this:(ue=eo(ue,this),delete this.simultaneous[ue.id],this)},requireFailure:function(ue){if(L(ue,"requireFailure",this))return this;var ge=this.requireFail;return ue=eo(ue,this),Be(ge,ue)===-1&&(ge.push(ue),ue.requireFailure(this)),this},dropRequireFailure:function(ue){if(L(ue,"dropRequireFailure",this))return this;ue=eo(ue,this);var ge=Be(this.requireFail,ue);return ge>-1&&this.requireFail.splice(ge,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(ue){return!!this.simultaneous[ue.id]},emit:function(ue){var ge=this,_e=this.state;function ze(ft){ge.manager.emit(ft,ue)}_e<sn&&ze(ge.options.event+lo(_e)),ze(ge.options.event),ue.additionalEvent&&ze(ue.additionalEvent),_e>=sn&&ze(ge.options.event+lo(_e))},tryEmit:function(ue){if(this.canEmit())return this.emit(ue);this.state=hs},canEmit:function(){for(var ue=0;ue<this.requireFail.length;){if(!(this.requireFail[ue].state&(hs|qi)))return!1;ue++}return!0},recognize:function(ue){var ge=Y({},ue);if(!be(this.options.enable,[this,ge])){this.reset(),this.state=hs;return}this.state&(ws|As|hs)&&(this.state=qi),this.state=this.process(ge),this.state&(hn|ss|sn|As)&&this.tryEmit(ge)},process:function(ue){},getTouchAction:function(){},reset:function(){}};function lo(ue){return ue&As?"cancel":ue&sn?"end":ue&ss?"move":ue&hn?"start":""}function Ta(ue){return ue==cn?"down":ue==mr?"up":ue==gn?"left":ue==Kn?"right":""}function eo(ue,ge){var _e=ge.manager;return _e?_e.get(ue):ue}function Ms(){ks.apply(this,arguments)}me(Ms,ks,{defaults:{pointers:1},attrTest:function(ue){var ge=this.options.pointers;return ge===0||ue.pointers.length===ge},process:function(ue){var ge=this.state,_e=ue.eventType,ze=ge&(hn|ss),ft=this.attrTest(ue);return ze&&(_e&Ki||!ft)?ge|As:ze||ft?_e&Er?ge|sn:ge&hn?ge|ss:hn:hs}});function xo(){Ms.apply(this,arguments),this.pX=null,this.pY=null}me(xo,Ms,{defaults:{event:"pan",threshold:10,pointers:1,direction:Rn},getTouchAction:function(){var ue=this.options.direction,ge=[];return ue&Dr&&ge.push(hr),ue&yn&&ge.push(Gt),ge},directionTest:function(ue){var ge=this.options,_e=!0,ze=ue.distance,ft=ue.direction,ni=ue.deltaX,fr=ue.deltaY;return ft&ge.direction||(ge.direction&Dr?(ft=ni===0?In:ni<0?gn:Kn,_e=ni!=this.pX,ze=Math.abs(ue.deltaX)):(ft=fr===0?In:fr<0?mr:cn,_e=fr!=this.pY,ze=Math.abs(ue.deltaY))),ue.direction=ft,_e&&ze>ge.threshold&&ft&ge.direction},attrTest:function(ue){return Ms.prototype.attrTest.call(this,ue)&&(this.state&hn||!(this.state&hn)&&this.directionTest(ue))},emit:function(ue){this.pX=ue.deltaX,this.pY=ue.deltaY;var ge=Ta(ue.direction);ge&&(ue.additionalEvent=this.options.event+ge),this._super.emit.call(this,ue)}});function Rt(){Ms.apply(this,arguments)}me(Rt,Ms,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[bi]},attrTest:function(ue){return this._super.attrTest.call(this,ue)&&(Math.abs(ue.scale-1)>this.options.threshold||this.state&hn)},emit:function(ue){if(ue.scale!==1){var ge=ue.scale<1?"in":"out";ue.additionalEvent=this.options.event+ge}this._super.emit.call(this,ue)}});function mi(){ks.apply(this,arguments),this._timer=null,this._input=null}me(mi,ks,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[At]},process:function(ue){var ge=this.options,_e=ue.pointers.length===ge.pointers,ze=ue.distance<ge.threshold,ft=ue.deltaTime>ge.time;if(this._input=ue,!ze||!_e||ue.eventType&(Er|Ki)&&!ft)this.reset();else if(ue.eventType&Si)this.reset(),this._timer=O(function(){this.state=ws,this.tryEmit()},ge.time,this);else if(ue.eventType&Er)return ws;return hs},reset:function(){clearTimeout(this._timer)},emit:function(ue){this.state===ws&&(ue&&ue.eventType&Er?this.manager.emit(this.options.event+"up",ue):(this._input.timeStamp=P(),this.manager.emit(this.options.event,this._input)))}});function rr(){Ms.apply(this,arguments)}me(rr,Ms,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[bi]},attrTest:function(ue){return this._super.attrTest.call(this,ue)&&(Math.abs(ue.rotation)>this.options.threshold||this.state&hn)}});function zt(){Ms.apply(this,arguments)}me(zt,Ms,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:Dr|yn,pointers:1},getTouchAction:function(){return xo.prototype.getTouchAction.call(this)},attrTest:function(ue){var ge=this.options.direction,_e;return ge&(Dr|yn)?_e=ue.overallVelocity:ge&Dr?_e=ue.overallVelocityX:ge&yn&&(_e=ue.overallVelocityY),this._super.attrTest.call(this,ue)&&ge&ue.offsetDirection&&ue.distance>this.options.threshold&&ue.maxPointers==this.options.pointers&&A(_e)>this.options.velocity&&ue.eventType&Er},emit:function(ue){var ge=Ta(ue.offsetDirection);ge&&this.manager.emit(this.options.event+ge,ue),this.manager.emit(this.options.event,ue)}});function Qt(){ks.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}me(Qt,ks,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[ui]},process:function(ue){var ge=this.options,_e=ue.pointers.length===ge.pointers,ze=ue.distance<ge.threshold,ft=ue.deltaTime<ge.time;if(this.reset(),ue.eventType&Si&&this.count===0)return this.failTimeout();if(ze&&ft&&_e){if(ue.eventType!=Er)return this.failTimeout();var ni=this.pTime?ue.timeStamp-this.pTime<ge.interval:!0,fr=!this.pCenter||Je(this.pCenter,ue.center)<ge.posThreshold;this.pTime=ue.timeStamp,this.pCenter=ue.center,!fr||!ni?this.count=1:this.count+=1,this._input=ue;var _i=this.count%ge.taps;if(_i===0)return this.hasRequireFailures()?(this._timer=O(function(){this.state=ws,this.tryEmit()},ge.interval,this),hn):ws}return hs},failTimeout:function(){return this._timer=O(function(){this.state=hs},this.options.interval,this),hs},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==ws&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}});function Ut(ue,ge){return ge=ge||{},ge.recognizers=Oe(ge.recognizers,Ut.defaults.preset),new Sr(ue,ge)}Ut.VERSION="2.0.7",Ut.defaults={domEvents:!1,touchAction:Ft,enable:!0,inputTarget:null,inputClass:null,preset:[[rr,{enable:!1}],[Rt,{enable:!1},["rotate"]],[zt,{direction:Dr}],[xo,{direction:Dr},["swipe"]],[Qt],[Qt,{event:"doubletap",taps:2},["tap"]],[mi]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};var Pi=1,dr=2;function Sr(ue,ge){this.options=Y({},Ut.defaults,ge||{}),this.options.inputTarget=this.options.inputTarget||ue,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=ue,this.input=Ur(this),this.touchAction=new Pr(this,this.options.touchAction),Qr(this,!0),U(this.options.recognizers,function(_e){var ze=this.add(new _e[0](_e[1]));_e[2]&&ze.recognizeWith(_e[2]),_e[3]&&ze.requireFailure(_e[3])},this)}Sr.prototype={set:function(ue){return Y(this.options,ue),ue.touchAction&&this.touchAction.update(),ue.inputTarget&&(this.input.destroy(),this.input.target=ue.inputTarget,this.input.init()),this},stop:function(ue){this.session.stopped=ue?dr:Pi},recognize:function(ue){var ge=this.session;if(!ge.stopped){this.touchAction.preventDefaults(ue);var _e,ze=this.recognizers,ft=ge.curRecognizer;(!ft||ft&&ft.state&ws)&&(ft=ge.curRecognizer=null);for(var ni=0;ni<ze.length;)_e=ze[ni],ge.stopped!==dr&&(!ft||_e==ft||_e.canRecognizeWith(ft))?_e.recognize(ue):_e.reset(),!ft&&_e.state&(hn|ss|sn)&&(ft=ge.curRecognizer=_e),ni++}},get:function(ue){if(ue instanceof ks)return ue;for(var ge=this.recognizers,_e=0;_e<ge.length;_e++)if(ge[_e].options.event==ue)return ge[_e];return null},add:function(ue){if(L(ue,"add",this))return this;var ge=this.get(ue.options.event);return ge&&this.remove(ge),this.recognizers.push(ue),ue.manager=this,this.touchAction.update(),ue},remove:function(ue){if(L(ue,"remove",this))return this;if(ue=this.get(ue),ue){var ge=this.recognizers,_e=Be(ge,ue);_e!==-1&&(ge.splice(_e,1),this.touchAction.update())}return this},on:function(ue,ge){if(ue!==c&&ge!==c){var _e=this.handlers;return U(it(ue),function(ze){_e[ze]=_e[ze]||[],_e[ze].push(ge)}),this}},off:function(ue,ge){if(ue!==c){var _e=this.handlers;return U(it(ue),function(ze){ge?_e[ze]&&_e[ze].splice(Be(_e[ze],ge),1):delete _e[ze]}),this}},emit:function(ue,ge){this.options.domEvents&&on(ue,ge);var _e=this.handlers[ue]&&this.handlers[ue].slice();if(!(!_e||!_e.length)){ge.type=ue,ge.preventDefault=function(){ge.srcEvent.preventDefault()};for(var ze=0;ze<_e.length;)_e[ze](ge),ze++}},destroy:function(){this.element&&Qr(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}};function Qr(ue,ge){var _e=ue.element;if(_e.style){var ze;U(ue.options.cssProps,function(ft,ni){ze=Kt(_e.style,ni),ge?(ue.oldCssProps[ze]=_e.style[ze],_e.style[ze]=ft):_e.style[ze]=ue.oldCssProps[ze]||""}),ge||(ue.oldCssProps={})}}function on(ue,ge){var _e=i.createEvent("Event");_e.initEvent(ue,!0,!0),_e.gesture=ge,ge.target.dispatchEvent(_e)}Y(Ut,{INPUT_START:Si,INPUT_MOVE:Ir,INPUT_END:Er,INPUT_CANCEL:Ki,STATE_POSSIBLE:qi,STATE_BEGAN:hn,STATE_CHANGED:ss,STATE_ENDED:sn,STATE_RECOGNIZED:ws,STATE_CANCELLED:As,STATE_FAILED:hs,DIRECTION_NONE:In,DIRECTION_LEFT:gn,DIRECTION_RIGHT:Kn,DIRECTION_UP:mr,DIRECTION_DOWN:cn,DIRECTION_HORIZONTAL:Dr,DIRECTION_VERTICAL:yn,DIRECTION_ALL:Rn,Manager:Sr,Input:_r,TouchAction:Pr,TouchInput:Yr,MouseInput:pi,PointerEventInput:zi,TouchMouseInput:yt,SingleTouchInput:br,Recognizer:ks,AttrRecognizer:Ms,Tap:Qt,Pan:xo,Swipe:zt,Pinch:Rt,Rotate:rr,Press:mi,on:je,off:st,each:U,merge:oe,extend:J,assign:Y,inherit:me,bindFn:pe,prefixed:Kt});var $n=typeof e<"u"?e:typeof self<"u"?self:{};$n.Hammer=Ut,typeof c=="function"&&c.amd?c(function(){return Ut}):t.exports?t.exports=Ut:e[s]=Ut})(window,document,"Hammer")})(PL);var j_=PL.exports;const _G=i1(j_),Ya=e5({__proto__:null,default:_G},[j_]),IL=1,RL=2,vT=4,gG={mousedown:IL,mousemove:RL,mouseup:vT};function yG(t,e){for(let i=0;i<t.length;i++)if(e(t[i]))return!0;return!1}function vG(t){const e=t.prototype.handler;t.prototype.handler=function(s){const c=this.store;s.button>0&&s.type==="pointerdown"&&(yG(c,h=>h.pointerId===s.pointerId)||c.push(s)),e.call(this,s)}}function xG(t){t.prototype.handler=function(i){let s=gG[i.type];s&IL&&i.button>=0&&(this.pressed=!0),s&RL&&i.which===0&&(s=vT),this.pressed&&(s&vT&&(this.pressed=!1),this.callback(this.manager,s,{pointers:[i],changedPointers:[i],pointerType:"mouse",srcEvent:i}))}}vG(j_.PointerEventInput);xG(j_.MouseInput);const bG=j_.Manager;class m1{constructor(e,i,s){this.element=e,this.callback=i,this.options={enable:!0,...s}}}const wG=Ya?[[Ya.Pan,{event:"tripan",pointers:3,threshold:0,enable:!1}],[Ya.Rotate,{enable:!1}],[Ya.Pinch,{enable:!1}],[Ya.Swipe,{enable:!1}],[Ya.Pan,{threshold:0,enable:!1}],[Ya.Press,{enable:!1}],[Ya.Tap,{event:"doubletap",taps:2,enable:!1}],[Ya.Tap,{event:"anytap",enable:!1}],[Ya.Tap,{enable:!1}]]:null,BI={tripan:["rotate","pinch","pan"],rotate:["pinch"],pinch:["pan"],pan:["press","doubletap","anytap","tap"],doubletap:["anytap"],anytap:["tap"]},TG={doubletap:["tap"]},EG={pointerdown:"pointerdown",pointermove:"pointermove",pointerup:"pointerup",touchstart:"pointerdown",touchmove:"pointermove",touchend:"pointerup",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup"},OE={KEY_EVENTS:["keydown","keyup"],MOUSE_EVENTS:["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"],WHEEL_EVENTS:["wheel","mousewheel"]},SG={tap:"tap",anytap:"anytap",doubletap:"doubletap",press:"press",pinch:"pinch",pinchin:"pinch",pinchout:"pinch",pinchstart:"pinch",pinchmove:"pinch",pinchend:"pinch",pinchcancel:"pinch",rotate:"rotate",rotatestart:"rotate",rotatemove:"rotate",rotateend:"rotate",rotatecancel:"rotate",tripan:"tripan",tripanstart:"tripan",tripanmove:"tripan",tripanup:"tripan",tripandown:"tripan",tripanleft:"tripan",tripanright:"tripan",tripanend:"tripan",tripancancel:"tripan",pan:"pan",panstart:"pan",panmove:"pan",panup:"pan",pandown:"pan",panleft:"pan",panright:"pan",panend:"pan",pancancel:"pan",swipe:"swipe",swipeleft:"swipe",swiperight:"swipe",swipeup:"swipe",swipedown:"swipe"},zI={click:"tap",anyclick:"anytap",dblclick:"doubletap",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup",mouseover:"pointerover",mouseout:"pointerout",mouseleave:"pointerleave"},AG=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",Qd=typeof window<"u"?window:global;let xT=!1;try{const t={get passive(){return xT=!0,!0}};Qd.addEventListener("test",null,t),Qd.removeEventListener("test",null)}catch{xT=!1}const MG=AG.indexOf("firefox")!==-1,{WHEEL_EVENTS:CG}=OE,UI="wheel",VI=4.000244140625,PG=40,IG=.25;class RG extends m1{constructor(e,i,s){super(e,i,s),this.handleEvent=c=>{if(!this.options.enable)return;let h=c.deltaY;Qd.WheelEvent&&(MG&&c.deltaMode===Qd.WheelEvent.DOM_DELTA_PIXEL&&(h/=Qd.devicePixelRatio),c.deltaMode===Qd.WheelEvent.DOM_DELTA_LINE&&(h*=PG)),h!==0&&h%VI===0&&(h=Math.floor(h/VI)),c.shiftKey&&h&&(h=h*IG),this.callback({type:UI,center:{x:c.clientX,y:c.clientY},delta:-h,srcEvent:c,pointerType:"mouse",target:c.target})},this.events=(this.options.events||[]).concat(CG),this.events.forEach(c=>e.addEventListener(c,this.handleEvent,xT?{passive:!1}:!1))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,i){e===UI&&(this.options.enable=i)}}const{MOUSE_EVENTS:OG}=OE,jI="pointermove",$I="pointerover",WI="pointerout",HI="pointerenter",qI="pointerleave";class kG extends m1{constructor(e,i,s){super(e,i,s),this.handleEvent=h=>{this.handleOverEvent(h),this.handleOutEvent(h),this.handleEnterEvent(h),this.handleLeaveEvent(h),this.handleMoveEvent(h)},this.pressed=!1;const{enable:c}=this.options;this.enableMoveEvent=c,this.enableLeaveEvent=c,this.enableEnterEvent=c,this.enableOutEvent=c,this.enableOverEvent=c,this.events=(this.options.events||[]).concat(OG),this.events.forEach(h=>e.addEventListener(h,this.handleEvent))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,i){e===jI&&(this.enableMoveEvent=i),e===$I&&(this.enableOverEvent=i),e===WI&&(this.enableOutEvent=i),e===HI&&(this.enableEnterEvent=i),e===qI&&(this.enableLeaveEvent=i)}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit($I,e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit(WI,e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit(HI,e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit(qI,e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.which===0&&(this.pressed=!1),this.pressed||this._emit(jI,e);break;case"mouseup":this.pressed=!1;break}}_emit(e,i){this.callback({type:e,center:{x:i.clientX,y:i.clientY},srcEvent:i,pointerType:"mouse",target:i.target})}}const{KEY_EVENTS:DG}=OE,GI="keydown",XI="keyup";class LG extends m1{constructor(e,i,s){super(e,i,s),this.handleEvent=c=>{const h=c.target||c.srcElement;h.tagName==="INPUT"&&h.type==="text"||h.tagName==="TEXTAREA"||(this.enableDownEvent&&c.type==="keydown"&&this.callback({type:GI,srcEvent:c,key:c.key,target:c.target}),this.enableUpEvent&&c.type==="keyup"&&this.callback({type:XI,srcEvent:c,key:c.key,target:c.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,this.events=(this.options.events||[]).concat(DG),e.tabIndex=this.options.tabIndex||0,e.style.outline="none",this.events.forEach(c=>e.addEventListener(c,this.handleEvent))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,i){e===GI&&(this.enableDownEvent=i),e===XI&&(this.enableUpEvent=i)}}const ZI="contextmenu";class NG extends m1{constructor(e,i,s){super(e,i,s),this.handleEvent=c=>{this.options.enable&&this.callback({type:ZI,center:{x:c.clientX,y:c.clientY},srcEvent:c,pointerType:"mouse",target:c.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,i){e===ZI&&(this.options.enable=i)}}const bT=1,fv=2,wT=4,FG={pointerdown:bT,pointermove:fv,pointerup:wT,mousedown:bT,mousemove:fv,mouseup:wT},BG=1,zG=2,UG=3,VG=0,jG=1,$G=2,WG=1,HG=2,qG=4;function GG(t){const e=FG[t.srcEvent.type];if(!e)return null;const{buttons:i,button:s,which:c}=t.srcEvent;let h=!1,p=!1,v=!1;return e===wT||e===fv&&!Number.isFinite(i)?(h=c===BG,p=c===zG,v=c===UG):e===fv?(h=!!(i&WG),p=!!(i&qG),v=!!(i&HG)):e===bT&&(h=s===VG,p=s===jG,v=s===$G),{leftButton:h,middleButton:p,rightButton:v}}function XG(t,e){const i=t.center;if(!i)return null;const s=e.getBoundingClientRect(),c=s.width/e.offsetWidth||1,h=s.height/e.offsetHeight||1,p={x:(i.x-s.left-e.clientLeft)/c,y:(i.y-s.top-e.clientTop)/h};return{center:i,offsetCenter:p}}const Zb={srcElement:"root",priority:0};class ZG{constructor(e){this.handleEvent=i=>{if(this.isEmpty())return;const s=this._normalizeEvent(i);let c=i.srcEvent.target;for(;c&&c!==s.rootElement;){if(this._emit(s,c),s.handled)return;c=c.parentNode}this._emit(s,"root")},this.eventManager=e,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,i,s,c=!1,h=!1){const{handlers:p,handlersByElement:v}=this;let l=Zb;typeof s=="string"||s&&s.addEventListener?l={...Zb,srcElement:s}:s&&(l={...Zb,...s});let A=v.get(l.srcElement);A||(A=[],v.set(l.srcElement,A));const P={type:e,handler:i,srcElement:l.srcElement,priority:l.priority};c&&(P.once=!0),h&&(P.passive=!0),p.push(P),this._active=this._active||!P.passive;let O=A.length-1;for(;O>=0&&!(A[O].priority>=P.priority);)O--;A.splice(O+1,0,P)}remove(e,i){const{handlers:s,handlersByElement:c}=this;for(let h=s.length-1;h>=0;h--){const p=s[h];if(p.type===e&&p.handler===i){s.splice(h,1);const v=c.get(p.srcElement);v.splice(v.indexOf(p),1),v.length===0&&c.delete(p.srcElement)}}this._active=s.some(h=>!h.passive)}_emit(e,i){const s=this.handlersByElement.get(i);if(s){let c=!1;const h=()=>{e.handled=!0},p=()=>{e.handled=!0,c=!0},v=[];for(let l=0;l<s.length;l++){const{type:A,handler:P,once:O}=s[l];if(P({...e,type:A,stopPropagation:h,stopImmediatePropagation:p}),O&&v.push(s[l]),c)break}for(let l=0;l<v.length;l++){const{type:A,handler:P}=v[l];this.remove(A,P)}}}_normalizeEvent(e){const i=this.eventManager.getElement();return{...e,...GG(e),...XG(e,i),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:i}}}const YG={events:null,recognizers:null,recognizerOptions:{},Manager:bG,touchAction:"none",tabIndex:0};class KG{constructor(e=null,i){this._onBasicInput=c=>{const{srcEvent:h}=c,p=EG[h.type];p&&this.manager.emit(p,c)},this._onOtherEvent=c=>{this.manager.emit(c.type,c)},this.options={...YG,...i},this.events=new Map,this.setElement(e);const{events:s}=this.options;s&&this.on(s)}getElement(){return this.element}setElement(e){if(this.element&&this.destroy(),this.element=e,!e)return;const{options:i}=this,s=i.Manager;this.manager=new s(e,{touchAction:i.touchAction,recognizers:i.recognizers||wG}).on("hammer.input",this._onBasicInput),i.recognizers||Object.keys(BI).forEach(c=>{const h=this.manager.get(c);h&&BI[c].forEach(p=>{h.recognizeWith(p)})});for(const c in i.recognizerOptions){const h=this.manager.get(c);if(h){const p=i.recognizerOptions[c];delete p.enable,h.set(p)}}this.wheelInput=new RG(e,this._onOtherEvent,{enable:!1}),this.moveInput=new kG(e,this._onOtherEvent,{enable:!1}),this.keyInput=new LG(e,this._onOtherEvent,{enable:!1,tabIndex:i.tabIndex}),this.contextmenuInput=new NG(e,this._onOtherEvent,{enable:!1});for(const[c,h]of this.events)h.isEmpty()||(this._toggleRecognizer(h.recognizerName,!0),this.manager.on(c,h.handleEvent))}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy(),this.wheelInput=null,this.moveInput=null,this.keyInput=null,this.contextmenuInput=null,this.manager=null,this.element=null)}on(e,i,s){this._addEventHandler(e,i,s,!1)}once(e,i,s){this._addEventHandler(e,i,s,!0)}watch(e,i,s){this._addEventHandler(e,i,s,!1,!0)}off(e,i){this._removeEventHandler(e,i)}_toggleRecognizer(e,i){const{manager:s}=this;if(!s)return;const c=s.get(e);if(c&&c.options.enable!==i){c.set({enable:i});const h=TG[e];h&&!this.options.recognizers&&h.forEach(p=>{const v=s.get(p);i?(v.requireFailure(e),c.dropRequireFailure(p)):v.dropRequireFailure(e)})}this.wheelInput.enableEventType(e,i),this.moveInput.enableEventType(e,i),this.keyInput.enableEventType(e,i),this.contextmenuInput.enableEventType(e,i)}_addEventHandler(e,i,s,c,h){if(typeof e!="string"){s=i;for(const P in e)this._addEventHandler(P,e[P],s,c,h);return}const{manager:p,events:v}=this,l=zI[e]||e;let A=v.get(l);A||(A=new ZG(this),v.set(l,A),A.recognizerName=SG[l]||l,p&&p.on(l,A.handleEvent)),A.add(e,i,s,c,h),A.isEmpty()||this._toggleRecognizer(A.recognizerName,!0)}_removeEventHandler(e,i){if(typeof e!="string"){for(const p in e)this._removeEventHandler(p,e[p]);return}const{events:s}=this,c=zI[e]||e,h=s.get(c);if(h&&(h.remove(e,i),h.isEmpty())){const{recognizerName:p}=h;let v=!1;for(const l of s.values())if(l.recognizerName===p&&!l.isEmpty()){v=!0;break}v||this._toggleRecognizer(p,!1)}}}function Tc(){}const JG=({isDragging:t})=>t?"grabbing":"grab",YI={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{type:"webgl"},gl:null,glOptions:{},canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:Tc,onWebGLInitialized:Tc,onResize:Tc,onViewStateChange:Tc,onInteractionStateChange:Tc,onBeforeRender:Tc,onAfterRender:Tc,onLoad:Tc,onError:t=>jr.error(t.message,t.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:JG,getTooltip:null,debug:!1,drawPickingColors:!1},Vv=class Vv{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new B_({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=s=>{const{_pickRequest:c}=this;if(s.type==="pointerleave")c.x=-1,c.y=-1,c.radius=0;else{if(s.leftButton||s.rightButton)return;{const h=s.offsetCenter;if(!h)return;c.x=h.x,c.y=h.y,c.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:c.x,y:c.y}),c.event=s},this._onEvent=s=>{const c=lT[s.type],h=s.offsetCenter;if(!c||!h||!this.layerManager)return;const p=this.layerManager.getLayers(),v=this.deckPicker.getLastPickedObject({x:h.x,y:h.y,layers:p,viewports:this.getViewports(h)},this._lastPointerDownInfo),{layer:l}=v,A=l&&(l[c.handler]||l.props[c.handler]),P=this.props[c.handler];let O=!1;A&&(O=A.call(l,v,s)),O||(P==null||P(v,s),this.widgetManager.onEvent(v,s))},this._onPointerDown=s=>{const c=s.offsetCenter,h=this._pick("pickObject","pickObject Time",{x:c.x,y:c.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=h.result[0]||h.emptyInfo},this.props={...YI,...e},e=this.props,e.viewState&&e.initialViewState&&jr.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device?this.device=e.device:e.gl&&(e.gl instanceof WebGLRenderingContext&&jr.error("WebGL1 context not supported.")(),this.device=l_.attach(e.gl));let i=this.device;i||(hh.registerDevices([l_]),i=hh.createDevice({...e.deviceProps,canvas:this._createCanvas(e)})),this.animationLoop=this._createAnimationLoop(i,e),this.setProps(e),e._typedArrayManagerProps&&wf.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){var e,i,s,c,h,p,v,l,A,P;(e=this.animationLoop)==null||e.stop(),(i=this.animationLoop)==null||i.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,(s=this.layerManager)==null||s.finalize(),this.layerManager=null,(c=this.viewManager)==null||c.finalize(),this.viewManager=null,(h=this.effectManager)==null||h.finalize(),this.effectManager=null,(p=this.deckRenderer)==null||p.finalize(),this.deckRenderer=null,(v=this.deckPicker)==null||v.finalize(),this.deckPicker=null,(l=this.eventManager)==null||l.destroy(),this.eventManager=null,(A=this.widgetManager)==null||A.finalize(),this.widgetManager=null,!this.props.canvas&&!this.props.device&&!this.props.gl&&this.canvas&&((P=this.canvas.parentElement)==null||P.removeChild(this.canvas),this.canvas=null)}setProps(e){var s;this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&jr.removed("onLayerHover","onHover")(),"onLayerClick"in e&&jr.removed("onLayerClick","onClick")(),e.initialViewState&&!xa(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);const i=Object.create(this.props);Object.assign(i,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),(s=this.animationLoop)==null||s.setProps(i),this.layerManager&&(this.viewManager.setProps(i),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(i),this.effectManager.setProps(i),this.deckRenderer.setProps(i),this.deckPicker.setProps(i),this.widgetManager.setProps(i)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let i=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);const s=this.viewManager.needsRedraw(e),c=this.layerManager.needsRedraw(e),h=this.effectManager.needsRedraw(e),p=this.deckRenderer.needsRedraw(e);return i=i||s||c||h||p,i}redraw(e){if(!this.layerManager)return;let i=this.needsRedraw({clearRedrawFlags:!0});i=e||i,i&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(i):this._drawLayers(i))}get isInitialized(){return this.viewManager!==null}getViews(){return zs(this.viewManager),this.viewManager.views}getViewports(e){return zs(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){const i=this._pick("pickObject","pickObject Time",e).result;return i.length?i[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,i=!1){for(const s in e)this.layerManager.resourceManager.add({resourceId:s,data:e[s],forceUpdate:i})}_removeResources(e){for(const i of e)this.layerManager.resourceManager.remove(i)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){var i;(i=this.layerManager)==null||i.removeDefaultShaderModule(e)}_pick(e,i,s){zs(this.deckPicker);const{stats:c}=this;c.get("Pick Count").incrementCount(),c.get(i).timeStart();const h=this.deckPicker[e]({layers:this.layerManager.getLayers(s),views:this.viewManager.getViews(),viewports:this.getViewports(s),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...s});return c.get(i).timeEnd(),h}_createCanvas(e){let i=e.canvas;return typeof i=="string"&&(i=document.getElementById(i),zs(i)),i||(i=document.createElement("canvas"),i.id=e.id||"deckgl-overlay",(e.parent||document.body).appendChild(i)),Object.assign(i.style,e.style),i}_setCanvasSize(e){var c;if(!this.canvas)return;const{width:i,height:s}=e;if(i||i===0){const h=Number.isFinite(i)?`${i}px`:i;this.canvas.style.width=h}if(s||s===0){const h=Number.isFinite(s)?`${s}px`:s;this.canvas.style.position=((c=e.style)==null?void 0:c.position)||"absolute",this.canvas.style.height=h}}_updateCanvasSize(){var c,h;const{canvas:e}=this;if(!e)return;const i=e.clientWidth??e.width,s=e.clientHeight??e.height;(i!==this.width||s!==this.height)&&(this.width=i,this.height=s,(c=this.viewManager)==null||c.setProps({width:i,height:s}),(h=this.layerManager)==null||h.activateViewport(this.getViewports()[0]),this.props.onResize({width:i,height:s}))}_createAnimationLoop(e,i){const{gl:s,onError:c,useDevicePixels:h}=i;return new wW({device:e,useDevicePixels:h,autoResizeDrawingBuffer:!s,autoResizeViewport:!1,onInitialize:p=>this._setDevice(p.device),onRender:this._onRenderFrame.bind(this),onError:c})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){const{views:e}=this.props,i=Array.isArray(e)?e:e?[e]:[new mT({id:"default-view"})];return i.length&&this.props.controller&&(i[0].props.controller=this.props.controller),i}_onContextLost(){const{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){var i,s,c;const{_pickRequest:e}=this;if(e.event){const{result:h,emptyInfo:p}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=h.length>0;let v=p,l=!1;for(const A of h)v=A,l=((i=A.layer)==null?void 0:i.onHover(A,e.event))||l;l||((c=(s=this.props).onHover)==null||c.call(s,v,e.event),this.widgetManager.onHover(v,e.event)),e.event=null}}_updateCursor(){const e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){var c,h;if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=(c=this.device.canvasContext)==null?void 0:c.canvas),this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),this.device instanceof l_&&this.props.onWebGLInitialized(this.device.gl);const i=new lL;i.play(),this.animationLoop.attachTimeline(i),this.eventManager=new KG(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizerOptions:this.props.eventRecognizerOptions,events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const p in lT)this.eventManager.on(p,this._onEvent);this.viewManager=new UW({timeline:i,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const s=this.viewManager.getViewports()[0];this.layerManager=new zW(this.device,{deck:this,stats:this.stats,viewport:s,timeline:i}),this.effectManager=new eH({deck:this,device:this.device}),this.deckRenderer=new rH(this.device),this.deckPicker=new cH(this.device),this.widgetManager=new dH({deck:this,parentElement:(h=this.canvas)==null?void 0:h.parentElement}),this.widgetManager.addDefault(new pH),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,i){var p;const{device:s,gl:c}=this.layerManager.context;this.props.onBeforeRender({device:s,gl:c});const h={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...i};(p=this.deckRenderer)==null||p.renderLayers(h),h.pass==="screen"&&this.widgetManager.onRedraw({viewports:h.viewports,layers:h.layers}),this.props.onAfterRender({device:s,gl:c})}_onRenderFrame(){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),jr.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){const i=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:i},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){const{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();const i=this.animationLoop.stats;e.get("GPU Time").addTime(i.get("GPU Time").lastTiming),e.get("CPU Time").addTime(i.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:e,stats:i}=this;e.fps=i.get("frameRate").getHz(),e.setPropsTime=i.get("setProps Time").time,e.updateAttributesTime=i.get("Update Attributes").time,e.framesRedrawn=i.get("Redraw Count").count,e.pickTime=i.get("pickObject Time").time+i.get("pickMultipleObjects Time").time+i.get("pickObjects Time").time,e.pickCount=i.get("Pick Count").count,e.gpuTime=i.get("GPU Time").time,e.cpuTime=i.get("CPU Time").time,e.gpuTimePerFrame=i.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=i.get("CPU Time").getAverageTime();const s=hh.stats.get("Memory Usage");e.bufferMemory=s.get("Buffer Memory").count,e.textureMemory=s.get("Texture Memory").count,e.renderbufferMemory=s.get("Renderbuffer Memory").count,e.gpuMemory=s.get("GPU Memory").count}};Vv.defaultProps=YI,Vv.VERSION=uj;let TT=Vv;function QG(t){switch(t){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return TD(t)}}const eX=wD;function c0(t,e){return{attribute:t,format:e.size>1?`${e.type}x${e.size}`:e.type,byteOffset:e.offset||0}}function sh(t){return t.stride||t.size*t.bytesPerElement}function tX(t,e){return t.type===e.type&&t.size===e.size&&sh(t)===sh(e)&&(t.offset||0)===(e.offset||0)}function ET(t,e){e.offset&&jr.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const i=sh(t),s=e.vertexOffset!==void 0?e.vertexOffset:t.vertexOffset||0,c=e.elementOffset||0,h=s*i+c*t.bytesPerElement+(t.offset||0);return{...e,offset:h,stride:i}}function iX(t,e){const i=ET(t,e);return{high:i,low:{...i,offset:i.offset+t.size*4}}}class rX{constructor(e,i,s){this._buffer=null,this.device=e,this.id=i.id||"",this.size=i.size||1;const c=i.logicalType||i.type,h=c==="float64";let{defaultValue:p}=i;p=Number.isFinite(p)?[p]:p||new Array(this.size).fill(0);let v;h?v="float32":!c&&i.isIndexed?v="uint32":v=c||"float32";let l=QG(c||v);this.doublePrecision=h,h&&i.fp64===!1&&(l=Float32Array),this.value=null,this.settings={...i,defaultType:l,defaultValue:p,logicalType:c,type:v,normalized:v.includes("norm"),size:this.size,bytesPerElement:l.BYTES_PER_ELEMENT},this.state={...s,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){const e=this.getAccessor();return e.vertexOffset?e.vertexOffset*sh(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),wf.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(e=this.id,i=null){const s={};if(this.state.constant){const c=this.value;if(i){const h=ET(this.getAccessor(),i),p=h.offset/c.BYTES_PER_ELEMENT,v=h.size||this.size;s[e]=c.subarray(p,p+v)}else s[e]=c}else s[e]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?s[`${e}64Low`]=s[e]:s[`${e}64Low`]=new Float32Array(this.size)),s}getBufferLayout(e=this.id,i=null){const s=this.getAccessor(),c=[],h={name:this.id,byteStride:sh(s),attributes:c};if(this.doublePrecision){const p=iX(s,i||{});c.push(c0(e,{...s,...p.high}),c0(`${e}64Low`,{...s,...p.low}))}else if(i){const p=ET(s,i);c.push(c0(e,{...s,...p}))}else c.push(c0(e,s));return h}setAccessor(e){this.state.bufferAccessor=e}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){const i=Array.from(this.value);e=[i,i]}else{const{value:i,numInstances:s,size:c}=this,h=s*c;if(i&&h&&i.length>=h){const p=new Array(c).fill(1/0),v=new Array(c).fill(-1/0);for(let l=0;l<h;)for(let A=0;A<c;A++){const P=i[l++];P<p[A]&&(p[A]=P),P>v[A]&&(v[A]=P)}e=[p,v]}}return this.state.bounds=e,e}setData(e){const{state:i}=this;let s;ArrayBuffer.isView(e)?s={value:e}:e instanceof Yn?s={buffer:e}:s=e;const c={...this.settings,...s};if(ArrayBuffer.isView(s.value)){if(!s.type)if(this.doublePrecision&&s.value instanceof Float64Array)c.type="float32";else{const p=eX(s.value);c.type=c.normalized?p.replace("int","norm"):p}c.bytesPerElement=s.value.BYTES_PER_ELEMENT,c.stride=sh(c)}if(i.bounds=null,s.constant){let h=s.value;if(h=this._normalizeValue(h,[],0),this.settings.normalized&&(h=this.normalizeConstant(h)),!(!i.constant||!this._areValuesEqual(h,this.value)))return!1;i.externalBuffer=null,i.constant=!0,this.value=ArrayBuffer.isView(h)?h:new Float32Array(h)}else if(s.buffer){const h=s.buffer;i.externalBuffer=h,i.constant=!1,this.value=s.value||null}else if(s.value){this._checkExternalBuffer(s);let h=s.value;i.externalBuffer=null,i.constant=!1,this.value=h;let{buffer:p}=this;const v=sh(c),l=(c.vertexOffset||0)*v;if(this.doublePrecision&&h instanceof Float64Array&&(h=Nb(h,c)),this.settings.isIndexed){const P=this.settings.defaultType;h.constructor!==P&&(h=new P(h))}const A=h.byteLength+l+v*2;(!p||p.byteLength<A)&&(p=this._createBuffer(A)),p.write(h,l)}return this.setAccessor(c),!0}updateSubBuffer(e={}){this.state.bounds=null;const i=this.value,{startOffset:s=0,endOffset:c}=e;this.buffer.write(this.doublePrecision&&i instanceof Float64Array?Nb(i,{size:this.size,startIndex:s,endIndex:c}):i.subarray(s,c),s*i.BYTES_PER_ELEMENT+this.byteOffset)}allocate(e,i=!1){const{state:s}=this,c=s.allocatedValue,h=wf.allocate(c,e+1,{size:this.size,type:this.settings.defaultType,copy:i});this.value=h;const{byteOffset:p}=this;let{buffer:v}=this;return(!v||v.byteLength<h.byteLength+p)&&(v=this._createBuffer(h.byteLength+p),i&&c&&v.write(c instanceof Float64Array?Nb(c,this):c,p)),s.allocatedValue=h,s.constant=!1,s.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(e){const{value:i}=e;if(!ArrayBuffer.isView(i))throw new Error(`Attribute ${this.id} value is not TypedArray`);const s=this.settings.defaultType;let c=!1;if(this.doublePrecision&&(c=i.BYTES_PER_ELEMENT<4),c)throw new Error(`Attribute ${this.id} does not support ${i.constructor.name}`);!(i instanceof s)&&this.settings.normalized&&!("normalized"in e)&&jr.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(e){switch(this.settings.type){case"snorm8":return new Float32Array(e).map(i=>(i+128)/255*2-1);case"snorm16":return new Float32Array(e).map(i=>(i+32768)/65535*2-1);case"unorm8":return new Float32Array(e).map(i=>i/255);case"unorm16":return new Float32Array(e).map(i=>i/65535);default:return e}}_normalizeValue(e,i,s){const{defaultValue:c,size:h}=this.settings;if(Number.isFinite(e))return i[s]=e,i;if(!e){let p=h;for(;--p>=0;)i[s+p]=c[p];return i}switch(h){case 4:i[s+3]=Number.isFinite(e[3])?e[3]:c[3];case 3:i[s+2]=Number.isFinite(e[2])?e[2]:c[2];case 2:i[s+1]=Number.isFinite(e[1])?e[1]:c[1];case 1:i[s+0]=Number.isFinite(e[0])?e[0]:c[0];break;default:let p=h;for(;--p>=0;)i[s+p]=Number.isFinite(e[p])?e[p]:c[p]}return i}_areValuesEqual(e,i){if(!e||!i)return!1;const{size:s}=this;for(let c=0;c<s;c++)if(e[c]!==i[c])return!1;return!0}_createBuffer(e){var c;this._buffer&&this._buffer.destroy();const{isIndexed:i,type:s}=this.settings;return this._buffer=this.device.createBuffer({...(c=this._buffer)==null?void 0:c.props,id:this.id,usage:i?Yn.INDEX:Yn.VERTEX,indexType:i?s:void 0,byteLength:e}),this._buffer}}const KI=[],JI=[];function _1(t,e=0,i=1/0){let s=KI;const c={index:-1,data:t,target:[]};return t?typeof t[Symbol.iterator]=="function"?s=t:t.length>0&&(JI.length=t.length,s=JI):s=KI,(e>0||Number.isFinite(i))&&(s=(Array.isArray(s)?s:Array.from(s)).slice(e,i),c.index=e-1),{iterable:s,objectInfo:c}}function OL(t){return t&&t[Symbol.asyncIterator]}function kL(t,e){const{size:i,stride:s,offset:c,startIndices:h,nested:p}=e,v=t.BYTES_PER_ELEMENT,l=s?s/v:i,A=c?c/v:0,P=Math.floor((t.length-A)/l);return(O,{index:L,target:U})=>{if(!h){const oe=L*l+A;for(let me=0;me<i;me++)U[me]=t[oe+me];return U}const H=h[L],Y=h[L+1]||P;let J;if(p){J=new Array(Y-H);for(let oe=H;oe<Y;oe++){const me=oe*l+A;U=new Array(i);for(let pe=0;pe<i;pe++)U[pe]=t[me+pe];J[oe-H]=U}}else if(l===i)J=t.subarray(H*i+A,Y*i+A);else{J=new t.constructor((Y-H)*i);let oe=0;for(let me=H;me<Y;me++){const pe=me*l+A;for(let be=0;be<i;be++)J[oe++]=t[pe+be]}}return J}}const nX=[],I0=[[0,1/0]];function sX(t,e){if(t===I0||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return t;const i=[],s=t.length;let c=0;for(let h=0;h<s;h++){const p=t[h];p[1]<e[0]?(i.push(p),c=h+1):p[0]>e[1]?i.push(p):e=[Math.min(p[0],e[0]),Math.max(p[1],e[1])]}return i.splice(c,0,e),i}const oX={interpolation:{duration:0,easing:t=>t},spring:{stiffness:.05,damping:.5}};function DL(t,e){if(!t)return null;Number.isFinite(t)&&(t={type:"interpolation",duration:t});const i=t.type||"interpolation";return{...oX[i],...e,...t,type:i}}class LL extends rX{constructor(e,i){super(e,i,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:I0}),this.constant=!1,this.settings.update=i.update||(i.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){const i=this.state.needsRedraw;return this.state.needsRedraw=i&&!e,i}layoutChanged(){return this.state.layoutChanged}setAccessor(e){var i;(i=this.state).layoutChanged||(i.layoutChanged=!tX(e,this.getAccessor())),super.setAccessor(e)}getUpdateTriggers(){const{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;const{accessor:i}=this.settings,s=this.settings.transition,c=Array.isArray(i)?e[i.find(h=>e[h])]:e[i];return DL(c,s)}setNeedsUpdate(e=this.id,i){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),i){const{startRow:s=0,endRow:c=1/0}=i;this.state.updateRanges=sX(this.state.updateRanges,[s,c])}else this.state.updateRanges=I0}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=nX}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){const{state:i,settings:s}=this;return s.noAlloc?!1:s.update?(super.allocate(e,i.updateRanges!==I0),!0):!1}updateBuffer({numInstances:e,data:i,props:s,context:c}){if(!this.needsUpdate())return!1;const{state:{updateRanges:h},settings:{update:p,noAlloc:v}}=this;let l=!0;if(p){for(const[A,P]of h)p.call(c,this,{data:i,startRow:A,endRow:P,props:s,numInstances:e});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[A,P]of h){const O=Number.isFinite(A)?this.getVertexOffset(A):0,L=Number.isFinite(P)?this.getVertexOffset(P):v||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:O,endOffset:L})}this._checkAttributeArray()}else l=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),l}setConstantValue(e){return e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){const{state:i}=this;return e?(this.clearNeedsUpdate(),i.lastExternalBuffer===e||(i.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(i.lastExternalBuffer=null,!1)}setBinaryValue(e,i=null){const{state:s,settings:c}=this;if(!e)return s.binaryValue=null,s.binaryAccessor=null,!1;if(c.noAlloc)return!1;if(s.binaryValue===e)return this.clearNeedsUpdate(),!0;if(s.binaryValue=e,this.setNeedsRedraw(),c.transform||i!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});const p=e;zs(ArrayBuffer.isView(p.value),`invalid ${c.accessor}`);const v=!!p.size&&p.size!==this.size;return s.binaryAccessor=kL(p.value,{size:p.size||this.size,stride:p.stride,offset:p.offset,startIndices:i,nested:v}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){const{startIndices:i}=this;return(i?e<i.length?i[e]:this.numInstances:e)*this.size}getValue(){const e=this.settings.shaderAttributes,i=super.getValue();if(!e)return i;for(const s in e)Object.assign(i,super.getValue(s,e[s]));return i}getBufferLayout(){this.state.layoutChanged=!1;const e=this.settings.shaderAttributes,i=super.getBufferLayout();if(!e)return i;for(const s in e){const c=super.getBufferLayout(s,e[s]);i.attributes.push(...c.attributes)}return i}_autoUpdater(e,{data:i,startRow:s,endRow:c,props:h,numInstances:p}){if(e.constant)return;const{settings:v,state:l,value:A,size:P,startIndices:O}=e,{accessor:L,transform:U}=v,H=l.binaryAccessor||(typeof L=="function"?L:h[L]);zs(typeof H=="function",`accessor "${L}" is not a function`);let Y=e.getVertexOffset(s);const{iterable:J,objectInfo:oe}=_1(i,s,c);for(const me of J){oe.index++;let pe=H(me,oe);if(U&&(pe=U.call(this,pe)),O){const be=(oe.index<O.length-1?O[oe.index+1]:p)-O[oe.index];if(pe&&Array.isArray(pe[0])){let Oe=Y;for(const je of pe)e._normalizeValue(je,A,Oe),Oe+=P}else pe&&pe.length>P?A.set(pe,Y):(e._normalizeValue(pe,oe.target,0),DW({target:A,source:oe.target,start:Y,count:be}));Y+=be*P}else e._normalizeValue(pe,A,Y),Y+=P}}_validateAttributeUpdaters(){const{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){const{value:e}=this,i=Math.min(4,this.size);if(e&&e.length>=i){let s=!0;switch(i){case 4:s=s&&Number.isFinite(e[3]);case 3:s=s&&Number.isFinite(e[2]);case 2:s=s&&Number.isFinite(e[1]);case 1:s=s&&Number.isFinite(e[0]);break;default:s=!1}if(!s)throw new Error(`Illegal attribute generated for ${this.id}`)}}}function Yb(t){const{source:e,target:i,start:s=0,size:c,getData:h}=t,p=t.end||i.length,v=e.length,l=p-s;if(v>l){i.set(e.subarray(0,l),s);return}if(i.set(e,s),!h)return;let A=v;for(;A<l;){const P=h(A,e);for(let O=0;O<c;O++)i[s+A]=P[O]||0,A++}}function aX({source:t,target:e,size:i,getData:s,sourceStartIndices:c,targetStartIndices:h}){if(!c||!h)return Yb({source:t,target:e,size:i,getData:s}),e;let p=0,v=0;const l=s&&((P,O)=>s(P+v,O)),A=Math.min(c.length,h.length);for(let P=1;P<A;P++){const O=c[P]*i,L=h[P]*i;Yb({source:t.subarray(p,O),target:e,start:v,end:L,size:i,getData:l}),p=O,v=L}return v<e.length&&Yb({source:[],target:e,start:v,size:i,getData:l}),e}function lX(t){const{device:e,settings:i,value:s}=t,c=new LL(e,i);return c.setData({value:s instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:i.normalized}),c}function NL(t){switch(t){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`No defined attribute type for size "${t}"`)}}function FL(t){switch(t){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw new Error("invalid type size")}}function BL(t){t.push(t.shift())}function cX(t,e){const{doublePrecision:i,settings:s,value:c,size:h}=t,p=i&&c instanceof Float64Array?2:1;let v=0;const{shaderAttributes:l}=t.settings;if(l)for(const A of Object.values(l))v=Math.max(v,A.vertexOffset??0);return(s.noAlloc?c.length:(e+v)*h)*p}function zL({device:t,source:e,target:i}){return(!i||i.byteLength<e.byteLength)&&(i==null||i.destroy(),i=t.createBuffer({byteLength:e.byteLength,usage:e.usage})),i}function UL({device:t,buffer:e,attribute:i,fromLength:s,toLength:c,fromStartIndices:h,getData:p=v=>v}){const v=i.doublePrecision&&i.value instanceof Float64Array?2:1,l=i.size*v,A=i.byteOffset,P=i.settings.bytesPerElement<4?A/i.settings.bytesPerElement*4:A,O=i.startIndices,L=h&&O,U=i.isConstant;if(!L&&e&&s>=c)return e;const H=i.value instanceof Float64Array?Float32Array:i.value.constructor,Y=U?i.value:new H(i.getBuffer().readSyncWebGL(A,c*H.BYTES_PER_ELEMENT).buffer);if(i.settings.normalized&&!U){const pe=p;p=(be,Oe)=>i.normalizeConstant(pe(be,Oe))}const J=U?(pe,be)=>p(Y,be):(pe,be)=>p(Y.subarray(pe+A,pe+A+l),be),oe=e?new Float32Array(e.readSyncWebGL(P,s*4).buffer):new Float32Array(0),me=new Float32Array(c);return aX({source:oe,target:me,sourceStartIndices:h,targetStartIndices:O,size:l,getData:J}),(!e||e.byteLength<me.byteLength+P)&&(e==null||e.destroy(),e=t.createBuffer({byteLength:me.byteLength+P,usage:35050})),e.write(me,P),e}class VL{constructor({device:e,attribute:i,timeline:s}){this.buffers=[],this.currentLength=0,this.device=e,this.transition=new d1(s),this.attribute=i,this.attributeInTransition=lX(i),this.currentStartIndices=i.startIndices}get inProgress(){return this.transition.inProgress}start(e,i,s=1/0){this.settings=e,this.currentStartIndices=this.attribute.startIndices,this.currentLength=cX(this.attribute,i),this.transition.start({...e,duration:s})}update(){const e=this.transition.update();return e&&this.onUpdate(),e}setBuffer(e){this.attributeInTransition.setData({buffer:e,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){this.cancel();for(const e of this.buffers)e.destroy();this.buffers.length=0}}class uX extends VL{constructor({device:e,attribute:i,timeline:s}){super({device:e,attribute:i,timeline:s}),this.type="interpolation",this.transform=dX(e,i)}start(e,i){const s=this.currentLength,c=this.currentStartIndices;if(super.start(e,i,e.duration),e.duration<=0){this.transition.cancel();return}const{buffers:h,attribute:p}=this;BL(h),h[0]=UL({device:this.device,buffer:h[0],attribute:p,fromLength:s,toLength:this.currentLength,fromStartIndices:c,getData:e.enter}),h[1]=zL({device:this.device,source:h[0],target:h[1]}),this.setBuffer(h[1]);const{transform:v}=this,l=v.model;l.setVertexCount(Math.floor(this.currentLength/p.size)),p.isConstant?(l.setAttributes({aFrom:h[0]}),l.setConstantAttributes({aTo:p.value})):l.setAttributes({aFrom:h[0],aTo:p.getBuffer()}),v.transformFeedback.setBuffers({vCurrent:h[1]})}onUpdate(){const{duration:e,easing:i}=this.settings,{time:s}=this.transition;let c=s/e;i&&(c=i(c));const{model:h}=this.transform;h.setUniforms({time:c}),h.device.gl.bindBuffer(34962,null),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}}const hX=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, time);
  gl_Position = vec4(0.0);
}
`;function dX(t,e){const i=NL(e.size);return new u1(t,{vs:hX,bufferLayout:[{name:"aFrom",format:FL(e.size)},{name:"aTo",format:e.getBufferLayout().attributes[0].format}],defines:{ATTRIBUTE_TYPE:i},varyings:["vCurrent"]})}class fX extends VL{constructor({device:e,attribute:i,timeline:s}){super({device:e,attribute:i,timeline:s}),this.type="spring",this.texture=gX(e),this.framebuffer=yX(e,this.texture),this.transform=_X(e,i)}start(e,i){const s=this.currentLength,c=this.currentStartIndices;super.start(e,i);const{buffers:h,attribute:p}=this;for(let l=0;l<2;l++)h[l]=UL({device:this.device,buffer:h[l],attribute:p,fromLength:s,toLength:this.currentLength,fromStartIndices:c,getData:e.enter});h[2]=zL({device:this.device,source:h[0],target:h[2]}),this.setBuffer(h[1]);const{model:v}=this.transform;v.setVertexCount(Math.floor(this.currentLength/p.size)),p.isConstant?v.setConstantAttributes({aTo:p.value}):v.setAttributes({aTo:p.getBuffer()})}onUpdate(){const{buffers:e,transform:i,framebuffer:s,transition:c}=this,h=this.settings;i.model.setAttributes({aPrev:e[0],aCur:e[1]}),i.transformFeedback.setBuffers({vNext:e[2]}),i.model.setUniforms({stiffness:h.stiffness,damping:h.damping}),i.run({framebuffer:s,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),BL(e),this.setBuffer(e[1]),this.device.readPixelsToArrayWebGL(s)[0]>0||c.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}const pX=`#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

uniform float stiffness;
uniform float damping;
in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE spring = delta * stiffness;
  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;
  return spring + damper + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,mX=`#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`;function _X(t,e){const i=NL(e.size),s=FL(e.size);return new u1(t,{vs:pX,fs:mX,bufferLayout:[{name:"aPrev",format:s},{name:"aCur",format:s},{name:"aTo",format:e.getBufferLayout().attributes[0].format}],varyings:["vNext"],defines:{ATTRIBUTE_TYPE:i},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}function gX(t){return t.createTexture({data:new Uint8Array(4),format:"rgba8unorm",mipmaps:!1,width:1,height:1})}function yX(t,e){return t.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[e]})}const vX={interpolation:uX,spring:fX};class xX{constructor(e,{id:i,timeline:s}){if(!e)throw new Error("AttributeTransitionManager is constructed without device");this.id=i,this.device=e,this.timeline=s,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(const e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:i,numInstances:s}){this.numInstances=s||1;for(const c in e){const h=e[c],p=h.getTransitionSetting(i);p&&this._updateAttribute(c,h,p)}for(const c in this.transitions){const h=e[c];(!h||!h.getTransitionSetting(i))&&this._removeTransition(c)}}hasAttribute(e){const i=this.transitions[e];return i&&i.inProgress}getAttributes(){const e={};for(const i in this.transitions){const s=this.transitions[i];s.inProgress&&(e[i]=s.attributeInTransition)}return e}run(){if(this.numInstances===0)return!1;for(const i in this.transitions)this.transitions[i].update()&&(this.needsRedraw=!0);const e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].delete(),delete this.transitions[e]}_updateAttribute(e,i,s){const c=this.transitions[e];let h=!c||c.type!==s.type;if(h){c&&this._removeTransition(e);const p=vX[s.type];p?this.transitions[e]=new p({attribute:i,timeline:this.timeline,device:this.device}):(jr.error(`unsupported transition type '${s.type}'`)(),h=!1)}(h||i.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(s,this.numInstances))}}const QI="attributeManager.invalidate",bX="attributeManager.updateStart",wX="attributeManager.updateEnd",TX="attribute.updateStart",EX="attribute.allocate",SX="attribute.updateEnd";class AX{constructor(e,{id:i="attribute-manager",stats:s,timeline:c}={}){this.mergeBoundsMemoized=V_(hW),this.id=i,this.device=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=s,this.attributeTransitionManager=new xX(e,{id:`${i}-transitions`,timeline:c}),Object.seal(this)}finalize(){for(const e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){const i=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,i&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{instanced:1})}remove(e){for(const i of e)this.attributes[i]!==void 0&&(this.attributes[i].delete(),delete this.attributes[i])}invalidate(e,i){const s=this._invalidateTrigger(e,i);Ks(QI,this,e,s)}invalidateAll(e){for(const i in this.attributes)this.attributes[i].setNeedsUpdate(i,e);Ks(QI,this,"all")}update({data:e,numInstances:i,startIndices:s=null,transitions:c,props:h={},buffers:p={},context:v={}}){let l=!1;Ks(bX,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const A in this.attributes){const P=this.attributes[A],O=P.settings.accessor;P.startIndices=s,P.numInstances=i,h[A]&&jr.removed(`props.${A}`,`data.attributes.${A}`)(),P.setExternalBuffer(p[A])||P.setBinaryValue(typeof O=="string"?p[O]:void 0,e.startIndices)||typeof O=="string"&&!p[O]&&P.setConstantValue(h[O])||P.needsUpdate()&&(l=!0,this._updateAttribute({attribute:P,numInstances:i,data:e,props:h,context:v})),this.needsRedraw=this.needsRedraw||P.needsRedraw()}l&&Ks(wX,this,i),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:i,transitions:c})}updateTransition(){const{attributeTransitionManager:e}=this,i=e.run();return this.needsRedraw=this.needsRedraw||i,i}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(e){const i=e.map(s=>{var c;return(c=this.attributes[s])==null?void 0:c.getBounds()});return this.mergeBoundsMemoized(i)}getChangedAttributes(e={clearChangedFlags:!1}){const{attributes:i,attributeTransitionManager:s}=this,c={...s.getAttributes()};for(const h in i){const p=i[h];p.needsRedraw(e)&&!s.hasAttribute(h)&&(c[h]=p)}return c}getBufferLayouts(e,i={}){e||(e=this.getAttributes());const s=[];for(const c in e)i[c]||s.push(e[c].getBufferLayout());return s}_add(e,i={}){for(const s in e){const c=e[s];this.attributes[s]=this._createAttribute(s,c,i)}this._mapUpdateTriggersToAttributes()}_createAttribute(e,i,s){const c={...i,id:e,size:i.isIndexed&&1||i.size||1,divisor:s.instanced?1:i.divisor||0};return new LL(this.device,c)}_mapUpdateTriggersToAttributes(){const e={};for(const i in this.attributes)this.attributes[i].getUpdateTriggers().forEach(c=>{e[c]||(e[c]=[]),e[c].push(i)});this.updateTriggers=e}_invalidateTrigger(e,i){const{attributes:s,updateTriggers:c}=this,h=c[e];return h&&h.forEach(p=>{const v=s[p];v&&v.setNeedsUpdate(v.id,i)}),h}_updateAttribute(e){const{attribute:i,numInstances:s}=e;if(Ks(TX,i),i.constant){i.setConstantValue(i.value);return}i.allocate(s)&&Ks(EX,i,s),i.updateBuffer(e)&&(this.needsRedraw=!0,Ks(SX,i,s))}}class MX extends d1{get value(){return this._value}_onUpdate(){const{time:e,settings:{fromValue:i,toValue:s,duration:c,easing:h}}=this,p=h(e/c);this._value=dh(i,s,p)}}const eR=1e-5;function tR(t,e,i,s,c){const h=e-t,v=(i-e)*c,l=-h*s;return v+l+h+e}function CX(t,e,i,s,c){if(Array.isArray(i)){const h=[];for(let p=0;p<i.length;p++)h[p]=tR(t[p],e[p],i[p],s,c);return h}return tR(t,e,i,s,c)}function iR(t,e){if(Array.isArray(t)){let i=0;for(let s=0;s<t.length;s++){const c=t[s]-e[s];i+=c*c}return Math.sqrt(i)}return Math.abs(t-e)}class PX extends d1{get value(){return this._currValue}_onUpdate(){const{fromValue:e,toValue:i,damping:s,stiffness:c}=this.settings,{_prevValue:h=e,_currValue:p=e}=this;let v=CX(h,p,i,s,c);const l=iR(v,i),A=iR(v,p);l<eR&&A<eR&&(v=i,this.end()),this._prevValue=p,this._currValue=v}}const IX={interpolation:MX,spring:PX};class RX{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,i,s,c){const{transitions:h}=this;if(h.has(e)){const l=h.get(e),{value:A=l.settings.fromValue}=l;i=A,this.remove(e)}if(c=DL(c),!c)return;const p=IX[c.type];if(!p){jr.error(`unsupported transition type '${c.type}'`)();return}const v=new p(this.timeline);v.start({...c,fromValue:i,toValue:s}),h.set(e,v)}remove(e){const{transitions:i}=this;i.has(e)&&(i.get(e).cancel(),i.delete(e))}update(){const e={};for(const[i,s]of this.transitions)s.update(),e[i]=s.value,s.inProgress||this.remove(i);return e}clear(){for(const e of this.transitions.keys())this.remove(e)}}function OX(t){const e=t[Bc];for(const i in e){const s=e[i],{validate:c}=s;if(c&&!c(t[i],s))throw new Error(`Invalid prop ${i}: ${t[i]}`)}}function kX(t,e){const i=jL({newProps:t,oldProps:e,propTypes:t[Bc],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),s=LX(t,e);let c=!1;return s||(c=NX(t,e)),{dataChanged:s,propsChanged:i,updateTriggersChanged:c,extensionsChanged:FX(t,e),transitionsChanged:DX(t,e)}}function DX(t,e){if(!t.transitions)return!1;const i={},s=t[Bc];let c=!1;for(const h in t.transitions){const p=s[h],v=p&&p.type;(v==="number"||v==="color"||v==="array")&&ST(t[h],e[h],p)&&(i[h]=!0,c=!0)}return c?i:!1}function jL({newProps:t,oldProps:e,ignoreProps:i={},propTypes:s={},triggerName:c="props"}){if(e===t)return!1;if(typeof t!="object"||t===null)return`${c} changed shallowly`;if(typeof e!="object"||e===null)return`${c} changed shallowly`;for(const h of Object.keys(t))if(!(h in i)){if(!(h in e))return`${c}.${h} added`;const p=ST(t[h],e[h],s[h]);if(p)return`${c}.${h} ${p}`}for(const h of Object.keys(e))if(!(h in i)){if(!(h in t))return`${c}.${h} dropped`;if(!Object.hasOwnProperty.call(t,h)){const p=ST(t[h],e[h],s[h]);if(p)return`${c}.${h} ${p}`}}return!1}function ST(t,e,i){let s=i&&i.equal;return s&&!s(t,e,i)||!s&&(s=t&&e&&t.equals,s&&!s.call(t,e))?"changed deeply":!s&&e!==t?"changed shallowly":null}function LX(t,e){if(e===null)return"oldProps is null, initial diff";let i=!1;const{dataComparator:s,_dataDiff:c}=t;return s?s(t.data,e.data)||(i="Data comparator detected a change"):t.data!==e.data&&(i="A new data container was supplied"),i&&c&&(i=c(t.data,e.data)||i),i}function NX(t,e){if(e===null)return{all:!0};if("all"in t.updateTriggers&&rR(t,e,"all"))return{all:!0};const i={};let s=!1;for(const c in t.updateTriggers)c!=="all"&&rR(t,e,c)&&(i[c]=!0,s=!0);return s?i:!1}function FX(t,e){if(e===null)return!0;const i=e.extensions,{extensions:s}=t;if(s===i)return!1;if(!i||!s||s.length!==i.length)return!0;for(let c=0;c<s.length;c++)if(!s[c].equals(i[c]))return!0;return!1}function rR(t,e,i){let s=t.updateTriggers[i];s=s??{};let c=e.updateTriggers[i];return c=c??{},jL({oldProps:c,newProps:s,triggerName:i})}const BX="count(): argument not an object",zX="count(): argument not a container";function UX(t){if(!jX(t))throw new Error(BX);if(typeof t.count=="function")return t.count();if(Number.isFinite(t.size))return t.size;if(Number.isFinite(t.length))return t.length;if(VX(t))return Object.keys(t).length;throw new Error(zX)}function VX(t){return t!==null&&typeof t=="object"&&t.constructor===Object}function jX(t){return t!==null&&typeof t=="object"}function nR(t,e){if(!e)return t;const i={...t,...e};if("defines"in e&&(i.defines={...t.defines,...e.defines}),"modules"in e&&(i.modules=(t.modules||[]).concat(e.modules),e.modules.some(s=>s.name==="project64"))){const s=i.modules.findIndex(c=>c.name==="project32");s>=0&&i.modules.splice(s,1)}if("inject"in e)if(!t.inject)i.inject=e.inject;else{const s={...t.inject};for(const c in e.inject)s[c]=(s[c]||"")+e.inject[c];i.inject=s}return i}const $X={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},AT={};function WX(t,e,i,s){if(i instanceof Xo)return i;i.constructor&&i.constructor.name!=="Object"&&(i={data:i});let c=null;i.compressed&&(c={minFilter:"linear",mipmapFilter:i.data.length>1?"nearest":"linear"});const h=e.createTexture({...i,sampler:{...$X,...c,...s}});return AT[h.id]=t,h}function HX(t,e){!e||!(e instanceof Xo)||AT[e.id]===t&&(e.delete(),delete AT[e.id])}const qX={boolean:{validate(t,e){return!0},equal(t,e,i){return!!t==!!e}},number:{validate(t,e){return Number.isFinite(t)&&(!("max"in e)||t<=e.max)&&(!("min"in e)||t>=e.min)}},color:{validate(t,e){return e.optional&&!t||MT(t)&&(t.length===3||t.length===4)},equal(t,e,i){return xa(t,e,1)}},accessor:{validate(t,e){const i=pv(t);return i==="function"||i===pv(e.value)},equal(t,e,i){return typeof e=="function"?!0:xa(t,e,1)}},array:{validate(t,e){return e.optional&&!t||MT(t)},equal(t,e,i){const{compare:s}=i,c=Number.isInteger(s)?s:s?1:0;return s?xa(t,e,c):t===e}},object:{equal(t,e,i){if(i.ignore)return!0;const{compare:s}=i,c=Number.isInteger(s)?s:s?1:0;return s?xa(t,e,c):t===e}},function:{validate(t,e){return e.optional&&!t||typeof t=="function"},equal(t,e,i){return!i.compare&&i.ignore!==!1||t===e}},data:{transform:(t,e,i)=>{if(!t)return t;const{dataTransform:s}=i.props;return s?s(t):typeof t.shape=="string"&&t.shape.endsWith("-table")&&Array.isArray(t.data)?t.data:t}},image:{transform:(t,e,i)=>{const s=i.context;return!s||!s.device?null:WX(i.id,s.device,t,{...e.parameters,...i.props.textureParameters})},release:(t,e,i)=>{HX(i.id,t)}}};function GX(t){const e={},i={},s={};for(const[c,h]of Object.entries(t)){const p=h==null?void 0:h.deprecatedFor;if(p)s[c]=Array.isArray(p)?p:[p];else{const v=XX(c,h);e[c]=v,i[c]=v.value}}return{propTypes:e,defaultProps:i,deprecatedProps:s}}function XX(t,e){switch(pv(e)){case"object":return Bm(t,e);case"array":return Bm(t,{type:"array",value:e,compare:!1});case"boolean":return Bm(t,{type:"boolean",value:e});case"number":return Bm(t,{type:"number",value:e});case"function":return Bm(t,{type:"function",value:e,compare:!0});default:return{name:t,type:"unknown",value:e}}}function Bm(t,e){return"type"in e?{name:t,...qX[e.type],...e}:"value"in e?{name:t,type:pv(e.value),...e}:{name:t,type:"object",value:e}}function MT(t){return Array.isArray(t)||ArrayBuffer.isView(t)}function pv(t){return MT(t)?"array":t===null?"null":typeof t}function ZX(t,e){let i;for(let h=e.length-1;h>=0;h--){const p=e[h];"extensions"in p&&(i=p.extensions)}const s=CT(t.constructor,i),c=Object.create(s);c[hv]=t,c[Sh]={},c[Dc]={};for(let h=0;h<e.length;++h){const p=e[h];for(const v in p)c[v]=p[v]}return Object.freeze(c),c}const YX="_mergedDefaultProps";function CT(t,e){let i=YX;if(e)for(const c of e){const h=c.constructor;h&&(i+=`:${h.extensionName||h.name}`)}const s=$L(t,i);return s||(t[i]=KX(t,e||[]))}function KX(t,e){if(!t.prototype)return null;const s=Object.getPrototypeOf(t),c=CT(s),h=$L(t,"defaultProps")||{},p=GX(h),v=Object.assign(Object.create(null),c,p.defaultProps),l=Object.assign(Object.create(null),c==null?void 0:c[Bc],p.propTypes),A=Object.assign(Object.create(null),c==null?void 0:c[zb],p.deprecatedProps);for(const P of e){const O=CT(P.constructor);O&&(Object.assign(v,O),Object.assign(l,O[Bc]),Object.assign(A,O[zb]))}return JX(v,t),eZ(v,l),QX(v,A),v[Bc]=l,v[zb]=A,e.length===0&&!kE(t,"_propTypes")&&(t._propTypes=l),v}function JX(t,e){const i=iZ(e);Object.defineProperties(t,{id:{writable:!0,value:i}})}function QX(t,e){for(const i in e)Object.defineProperty(t,i,{enumerable:!1,set(s){const c=`${this.id}: ${i}`;for(const h of e[i])kE(this,h)||(this[h]=s);jr.deprecated(c,e[i].join("/"))()}})}function eZ(t,e){const i={},s={};for(const c in e){const h=e[c],{name:p,value:v}=h;h.async&&(i[p]=v,s[p]=tZ(p))}t[af]=i,t[Sh]={},Object.defineProperties(t,s)}function tZ(t){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||OL(e)?this[Sh][t]=e:this[Dc][t]=e},get(){if(this[Dc]){if(t in this[Dc])return this[Dc][t]||this[af][t];if(t in this[Sh]){const e=this[hv]&&this[hv].internalState;if(e&&e.hasAsyncProp(t))return e.getAsyncProp(t)||this[af][t]}}return this[af][t]}}}function kE(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function $L(t,e){return kE(t,e)&&t[e]}function iZ(t){const e=t.componentName;return e||jr.warn(`${t.name}.componentName not specified`)(),e||t.name}let rZ=0;const jv=class jv{constructor(...e){this.props=ZX(this,e),this.id=this.props.id,this.count=rZ++}clone(e){const{props:i}=this,s={};for(const c in i[af])c in i[Dc]?s[c]=i[Dc][c]:c in i[Sh]&&(s[c]=i[Sh][c]);return new this.constructor({...i,...s,...e})}};jv.componentName="Component",jv.defaultProps={};let PT=jv;const nZ=Object.freeze({});class sZ{constructor(e){this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const e in this.asyncProps){const i=this.asyncProps[e];i&&i.type&&i.type.release&&i.type.release(i.resolvedValue,i.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||nZ}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){const i=this.asyncProps[e];return i&&i.resolvedValue}isAsyncPropLoading(e){if(e){const i=this.asyncProps[e];return!!(i&&i.pendingLoadCount>0&&i.pendingLoadCount!==i.resolvedLoadCount)}for(const i in this.asyncProps)if(this.isAsyncPropLoading(i))return!0;return!1}reloadAsyncProp(e,i){this._watchPromise(e,Promise.resolve(i))}setAsyncProps(e){this.component=e[hv]||this.component;const i=e[Dc]||{},s=e[Sh]||e,c=e[af]||{};for(const h in i){const p=i[h];this._createAsyncPropData(h,c[h]),this._updateAsyncProp(h,p),i[h]=this.getAsyncProp(h)}for(const h in s){const p=s[h];this._createAsyncPropData(h,c[h]),this._updateAsyncProp(h,p)}}_fetch(e,i){return null}_onResolve(e,i){}_onError(e,i){}_updateAsyncProp(e,i){if(this._didAsyncInputValueChange(e,i)){if(typeof i=="string"&&(i=this._fetch(e,i)),i instanceof Promise){this._watchPromise(e,i);return}if(OL(i)){this._resolveAsyncIterable(e,i);return}this._setPropValue(e,i)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,i){const s=this.asyncProps[e];return i===s.resolvedValue||i===s.lastValue?!1:(s.lastValue=i,!0)}_setPropValue(e,i){this._freezeAsyncOldProps();const s=this.asyncProps[e];s&&(i=this._postProcessValue(s,i),s.resolvedValue=i,s.pendingLoadCount++,s.resolvedLoadCount=s.pendingLoadCount)}_setAsyncPropValue(e,i,s){const c=this.asyncProps[e];c&&s>=c.resolvedLoadCount&&i!==void 0&&(this._freezeAsyncOldProps(),c.resolvedValue=i,c.resolvedLoadCount=s,this.onAsyncPropUpdated(e,i))}_watchPromise(e,i){const s=this.asyncProps[e];if(s){s.pendingLoadCount++;const c=s.pendingLoadCount;i.then(h=>{this.component&&(h=this._postProcessValue(s,h),this._setAsyncPropValue(e,h,c),this._onResolve(e,h))}).catch(h=>{this._onError(e,h)})}}async _resolveAsyncIterable(e,i){if(e!=="data"){this._setPropValue(e,i);return}const s=this.asyncProps[e];if(!s)return;s.pendingLoadCount++;const c=s.pendingLoadCount;let h=[],p=0;for await(const v of i){if(!this.component)return;const{dataTransform:l}=this.component.props;l?h=l(v,h):h=h.concat(v),Object.defineProperty(h,"__diff",{enumerable:!1,value:[{startRow:p,endRow:h.length}]}),p=h.length,this._setAsyncPropValue(e,h,c)}this._onResolve(e,h)}_postProcessValue(e,i){const s=e.type;return s&&this.component&&(s.release&&s.release(e.resolvedValue,s,this.component),s.transform)?s.transform(i,s,this.component):i}_createAsyncPropData(e,i){if(!this.asyncProps[e]){const c=this.component&&this.component.props[Bc];this.asyncProps[e]={type:c&&c[e],lastValue:null,resolvedValue:i,pendingLoadCount:0,resolvedLoadCount:0}}}}class oZ extends sZ{constructor({attributeManager:e,layer:i}){super(i),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,i){const s=this.layer,c=s==null?void 0:s.props.fetch;return c?c(i,{propName:e,layer:s}):super._fetch(e,i)}_onResolve(e,i){const s=this.layer;if(s){const c=s.props.onDataLoad;e==="data"&&c&&c(i,{propName:e,layer:s})}}_onError(e,i){const s=this.layer;s&&s.raiseError(i,`loading ${e} of ${this.layer}`)}}const aZ="layer.changeFlag",lZ="layer.initialize",cZ="layer.update",uZ="layer.finalize",hZ="layer.matched",sR=2**24-1,dZ=Object.freeze([]),fZ=V_(({oldViewport:t,viewport:e})=>t.equals(e));let Ka=new Uint8ClampedArray(0);const pZ={data:{type:"data",value:dZ,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:t=>t&&t.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(t,{propName:e,layer:i,loaders:s,loadOptions:c,signal:h})=>{const{resourceManager:p}=i.context;c=c||i.getLoadOptions(),s=s||i.props.loaders,h&&(c={...c,fetch:{...c==null?void 0:c.fetch,signal:h}});let v=p.contains(t);return!v&&!c&&(p.add({resourceId:t,data:ch(t,s),persistent:!1}),v=!0),v?p.subscribe({resourceId:t,onChange:l=>{var A;return(A=i.internalState)==null?void 0:A.reloadAsyncProp(e,l)},consumerId:i.id,requestId:e}):ch(t,s,c)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:qr.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:t})=>[0,-t*100]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}},$v=class $v extends PT{constructor(){super(...arguments),this.internalState=null,this.lifecycle=Wd.NO_STATE,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){return`${this.constructor.layerName||this.constructor.name}({id: '${this.props.id}'})`}project(e){zs(this.internalState);const i=this.internalState.viewport||this.context.viewport,s=aL(e,{viewport:i,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[c,h,p]=nL(s,i.pixelProjectionMatrix);return e.length===2?[c,h]:[c,h,p]}unproject(e){return zs(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,i){zs(this.internalState);const s=this.internalState.viewport||this.context.viewport;return gW(e,{viewport:s,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...i})}get isComposite(){return!1}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){const e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setModuleParameters(e){for(const i of this.getModels())i.updateModuleSettings(e)}setShaderModuleProps(...e){for(const i of this.getModels())i.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:e}=this.props;return e===qr.DEFAULT||e===qr.LNGLAT||e===qr.CARTESIAN}onHover(e,i){return this.props.onHover&&this.props.onHover(e,i)||!1}onClick(e,i){return this.props.onClick&&this.props.onClick(e,i)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,i=[]){return i[0]=e+1&255,i[1]=e+1>>8&255,i[2]=e+1>>8>>8&255,i}decodePickingColor(e){zs(e instanceof Uint8Array);const[i,s,c]=e;return i+s*256+c*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:UX(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["positions","instancePositions"])}getShaders(e){e=nR(e,{disableWarnings:!0,modules:this.context.defaultShaderModules});for(const i of this.props.extensions)e=nR(e,i.getShaders.call(this,i));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){const i=this.getAttributeManager(),{dataChanged:s}=e.changeFlags;if(s&&i)if(Array.isArray(s))for(const c of s)i.invalidateAll(c);else i.invalidateAll();if(i){const{props:c}=e,h=this.internalState.hasPickingBuffer,p=Number.isInteger(c.highlightedObjectIndex)||c.pickable||c.extensions.some(v=>v.getNeedsPickingBuffer.call(this,v));if(h!==p){this.internalState.hasPickingBuffer=p;const{pickingColors:v,instancePickingColors:l}=i.attributes,A=v||l;A&&(p&&A.constant&&(A.constant=!1,i.invalidate(A.id)),!A.value&&!p&&(A.constant=!0,A.value=[0,0,0]))}}}finalizeState(e){for(const s of this.getModels())s.destroy();const i=this.getAttributeManager();i&&i.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(const i of this.getModels())i.draw(e)}getPickingInfo({info:e,mode:i,sourceLayer:s}){const{index:c}=e;return c>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[c]),e}raiseError(e,i){var s,c,h,p;i&&(e=new Error(`${i}: ${e.message}`,{cause:e})),(c=(s=this.props).onError)!=null&&c.call(s,e)||(p=(h=this.context)==null?void 0:h.onError)==null||p.call(h,e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){var e;return((e=this.internalState)==null?void 0:e.uniformTransitions.active)||!1}activateViewport(e){if(!this.internalState)return;const i=this.internalState.viewport;this.internalState.viewport=e,(!i||!fZ({oldViewport:i,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){const i=this.getAttributeManager();i&&(e==="all"?i.invalidateAll():i.invalidate(e))}updateAttributes(e){let i=!1;for(const s in e)e[s].layoutChanged()&&(i=!0);for(const s of this.getModels())this._setModelAttributes(s,e,i)}_updateAttributes(){const e=this.getAttributeManager();if(!e)return;const i=this.props,s=this.getNumInstances(),c=this.getStartIndices();e.update({data:i.data,numInstances:s,startIndices:c,props:i,transitions:i.transitions,buffers:i.data.attributes,context:this});const h=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(h)}_updateAttributeTransition(){const e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){const{uniformTransitions:e}=this.internalState;if(e.active){const i=e.update(),s=Object.create(this.props);for(const c in i)Object.defineProperty(s,c,{value:i[c]});return s}return this.props}calculateInstancePickingColors(e,{numInstances:i}){if(e.constant)return;const s=Math.floor(Ka.length/4);if(this.internalState.usesPickingColorCache=!0,s<i){i>sR&&jr.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),Ka=wf.allocate(Ka,i,{size:4,copy:!0,maxCount:Math.max(i,sR)});const c=Math.floor(Ka.length/4),h=[];for(let p=s;p<c;p++)this.encodePickingColor(p,h),Ka[p*4+0]=h[0],Ka[p*4+1]=h[1],Ka[p*4+2]=h[2]}e.value=Ka.subarray(0,i*4)}_setModelAttributes(e,i,s=!1){var v;if(!Object.keys(i).length)return;if(s){const l=this.getAttributeManager();e.setBufferLayout(l.getBufferLayouts()),i=l.getAttributes()}const c=((v=e.userData)==null?void 0:v.excludeAttributes)||{},h={},p={};for(const l in i){if(c[l])continue;const A=i[l].getValue();for(const P in A){const O=A[P];O instanceof Yn?i[l].settings.isIndexed?e.setIndexBuffer(O):h[P]=O:O&&(p[P]=O)}}e.setAttributes(h),e.setConstantAttributes(p)}disablePickingIndex(e){const i=this.props.data;if(!("attributes"in i)){this._disablePickingIndex(e);return}const{pickingColors:s,instancePickingColors:c}=this.getAttributeManager().attributes,h=s||c,p=h&&i.attributes&&i.attributes[h.id];if(p&&p.value){const v=p.value,l=this.encodePickingColor(e);for(let A=0;A<i.length;A++){const P=h.getVertexOffset(A);v[P]===l[0]&&v[P+1]===l[1]&&v[P+2]===l[2]&&this._disablePickingIndex(A)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){const{pickingColors:i,instancePickingColors:s}=this.getAttributeManager().attributes,c=i||s;if(!c)return;const h=c.getVertexOffset(e),p=c.getVertexOffset(e+1);c.buffer.write(new Uint8Array(p-h),h)}restorePickingColors(){const{pickingColors:e,instancePickingColors:i}=this.getAttributeManager().attributes,s=e||i;s&&(this.internalState.usesPickingColorCache&&s.value.buffer!==Ka.buffer&&(s.value=Ka.subarray(0,s.value.length)),s.updateSubBuffer({startOffset:0}))}_initialize(){zs(!this.internalState),zs(Number.isFinite(this.props.coordinateSystem)),Ks(lZ,this);const e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new oZ({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(jr.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new RX(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const i of this.props.extensions)i.initializeState.call(this,this.context,i);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){Ks(hZ,this,this===e);const{state:i,internalState:s}=e;this!==e&&(this.internalState=s,this.state=i,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const e=this.needsUpdate();if(Ks(cZ,this,e),!e)return;const i=this.props,s=this.context,c=this.internalState,h=s.viewport,p=this._updateUniformTransition();c.propsInTransition=p,s.viewport=c.viewport||h,this.props=p;try{const v=this._getUpdateParams(),l=this.getModels();if(s.device)this.updateState(v);else try{this.updateState(v)}catch{}for(const P of this.props.extensions)P.updateState.call(this,v,P);const A=this.getModels()[0]!==l[0];this._postUpdate(v,A)}finally{s.viewport=h,this.props=i,this._clearChangeFlags(),c.needsUpdate=!1,c.resetOldProps()}}_finalize(){Ks(uZ,this),this.finalizeState(this.context);for(const e of this.props.extensions)e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,moduleParameters:i=null,uniforms:s={},parameters:c={}}){this._updateAttributeTransition();const h=this.props,p=this.context;this.props=this.internalState.propsInTransition||h;const v=this.props.opacity;s.opacity=Math.pow(v,1/2.2);try{if(i){const{isActive:P,isAttribute:O}=i.picking;this.setModuleParameters(i),this.setShaderModuleProps({picking:{isActive:P,isAttribute:O}})}const{getPolygonOffset:l}=this.props,A=l&&l(s)||[0,0];p.device.setParametersWebGL({polygonOffset:A});for(const P of this.getModels())P.setParameters(c);p.device.withParametersWebGL(c,()=>{const P={renderPass:e,moduleParameters:i,uniforms:s,parameters:c,context:p};for(const O of this.props.extensions)O.draw.call(this,P,O);this.draw(P)})}finally{this.props=h}}getChangeFlags(){var e;return(e=this.internalState)==null?void 0:e.changeFlags}setChangeFlags(e){if(!this.internalState)return;const{changeFlags:i}=this.internalState;for(const c in e)if(e[c]){let h=!1;switch(c){case"dataChanged":const p=e[c],v=i[c];p&&Array.isArray(v)&&(i.dataChanged=Array.isArray(p)?v.concat(p):p,h=!0);default:i[c]||(i[c]=e[c],h=!0)}h&&Ks(aZ,this,c,e)}const s=!!(i.dataChanged||i.updateTriggersChanged||i.propsChanged||i.extensionsChanged);i.propsOrDataChanged=s,i.somethingChanged=s||i.viewportChanged||i.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,i){var c;const s=kX(e,i);if(s.updateTriggersChanged)for(const h in s.updateTriggersChanged)s.updateTriggersChanged[h]&&this.invalidateAttribute(h);if(s.transitionsChanged)for(const h in s.transitionsChanged)this.internalState.uniformTransitions.add(h,i[h],e[h],(c=e.transitions)==null?void 0:c[h]);return this.setChangeFlags(s)}validateProps(){OX(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){const i={highlightedObjectColor:e.picked?e.color:null},{highlightColor:s}=this.props;e.picked&&typeof s=="function"&&(i.highlightColor=s(e)),this.setShaderModuleProps({picking:i}),this.setNeedsRedraw()}_getAttributeManager(){const e=this.context;return new AX(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,i){const{props:s,oldProps:c}=e;this.setNeedsRedraw(),this._updateAttributes();const h=this.state.model;h!=null&&h.isInstanced&&h.setInstanceCount(this.getNumInstances());const{autoHighlight:p,highlightedObjectIndex:v,highlightColor:l}=s;if(i||c.autoHighlight!==p||c.highlightedObjectIndex!==v||c.highlightColor!==l){const A={};p||(A.highlightedObjectColor=null),Array.isArray(l)&&(A.highlightColor=l),(i||v!==c.highlightedObjectIndex)&&(A.highlightedObjectColor=Number.isFinite(v)&&v>=0?this.encodePickingColor(v):null),this.setShaderModuleProps({picking:A})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let i=!1;i=i||this.internalState.needsRedraw&&this.id;const s=this.getAttributeManager(),c=s?s.getNeedsRedraw(e):!1;if(i=i||c,i)for(const h of this.props.extensions)h.onNeedsRedraw.call(this,h);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,i}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}};$v.defaultProps=pZ,$v.layerName="Layer";let Fl=$v;const mZ="compositeLayer.renderLayers",QE=class QE extends Fl{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){const{object:i}=e;return i&&i.__source&&i.__source.parent&&i.__source.parent.id===this.id&&(e.object=i.__source.object,e.index=i.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,i){return i&&i.length}getSubLayerClass(e,i){const{_subLayerProps:s}=this.props;return s&&s[e]&&s[e].type||i}getSubLayerRow(e,i,s){return e.__source={parent:this,object:i,index:s},e}getSubLayerAccessor(e){if(typeof e=="function"){const i={index:-1,data:this.props.data,target:[]};return(s,c)=>s&&s.__source?(i.index=s.__source.index,e(s.__source.object,i)):e(s,c)}return e}getSubLayerProps(e={}){var st;const{opacity:i,pickable:s,visible:c,parameters:h,getPolygonOffset:p,highlightedObjectIndex:v,autoHighlight:l,highlightColor:A,coordinateSystem:P,coordinateOrigin:O,wrapLongitude:L,positionFormat:U,modelMatrix:H,extensions:Y,fetch:J,operation:oe,_subLayerProps:me}=this.props,pe={id:"",updateTriggers:{},opacity:i,pickable:s,visible:c,parameters:h,getPolygonOffset:p,highlightedObjectIndex:v,autoHighlight:l,highlightColor:A,coordinateSystem:P,coordinateOrigin:O,wrapLongitude:L,positionFormat:U,modelMatrix:H,extensions:Y,fetch:J,operation:oe},be=me&&e.id&&me[e.id],Oe=be&&be.updateTriggers,je=e.id||"sublayer";if(be){const ut=this.props[Bc],xe=e.type?e.type._propTypes:{};for(const it in be){const Be=xe[it]||ut[it];Be&&Be.type==="accessor"&&(be[it]=this.getSubLayerAccessor(be[it]))}}Object.assign(pe,e,be),pe.id=`${this.props.id}-${je}`,pe.updateTriggers={all:(st=this.props.updateTriggers)==null?void 0:st.all,...e.updateTriggers,...Oe};for(const ut of Y){const xe=ut.getSubLayerProps.call(this,ut);xe&&Object.assign(pe,xe,{updateTriggers:Object.assign(pe.updateTriggers,xe.updateTriggers)})}return pe}_updateAutoHighlight(e){for(const i of this.getSubLayers())i.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,i){let s=this.internalState.subLayers;const c=!s||this.needsUpdate();if(c){const h=this.renderLayers();s=h1(h,Boolean),this.internalState.subLayers=s}Ks(mZ,this,c,s);for(const h of s)h.parent=this}};QE.layerName="CompositeLayer";let I_=QE;const u0=Math.PI/180,oR=180/Math.PI,R0=6370972,ef=256;function _Z(){const t=ef/R0,e=Math.PI/180*ef;return{unitsPerMeter:[t,t,t],unitsPerMeter2:[0,0,0],metersPerUnit:[1/t,1/t,1/t],unitsPerDegree:[e,e,t],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/e,1/e,1/t]}}class gZ extends Tf{constructor(e={}){const{latitude:i=0,longitude:s=0,zoom:c=0,nearZMultiplier:h=.1,farZMultiplier:p=2,resolution:v=10}=e;let{height:l,altitude:A=1.5}=e;l=l||1,A=Math.max(.75,A);const P=new Vs().lookAt({eye:[0,-A,0],up:[0,0,1]}),O=Math.pow(2,c);P.rotateX(i*u0),P.rotateZ(-s*u0),P.scale(O/l);const L=Math.atan(.5/A),U=ef*2*O/l;super({...e,height:l,viewMatrix:P,longitude:s,latitude:i,zoom:c,distanceScales:_Z(),fovyRadians:L*2,focalDistance:A,near:h,far:Math.min(2,1/U+1)*A*p}),this.latitude=i,this.longitude=s,this.resolution=v}get projectionMode(){return ya.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(e={}){const i={targetZ:e.z||0},s=this.unproject([0,this.height/2],i),c=this.unproject([this.width/2,0],i),h=this.unproject([this.width,this.height/2],i),p=this.unproject([this.width/2,this.height],i);return h[0]<this.longitude&&(h[0]+=360),s[0]>this.longitude&&(s[0]-=360),[Math.min(s[0],h[0],c[0],p[0]),Math.min(s[1],h[1],c[1],p[1]),Math.max(s[0],h[0],c[0],p[0]),Math.max(s[1],h[1],c[1],p[1])]}unproject(e,{topLeft:i=!0,targetZ:s}={}){const[c,h,p]=e,v=i?h:this.height-h,{pixelUnprojectionMatrix:l}=this;let A;if(Number.isFinite(p))A=Kb(l,[c,v,p,1]);else{const U=Kb(l,[c,v,-1,1]),H=Kb(l,[c,v,1,1]),Y=((s||0)/R0+1)*ef,J=Ib(jD([],U,H)),oe=Ib(U),me=Ib(H),be=4*((4*oe*me-(J-oe-me)**2)/16)/J,Oe=Math.sqrt(oe-be),je=Math.sqrt(Math.max(0,Y*Y-be)),st=(Oe-je)/Math.sqrt(J);A=G9([],U,H,st)}const[P,O,L]=this.unprojectPosition(A);return Number.isFinite(p)?[P,O,L]:Number.isFinite(s)?[P,O,s]:[P,O]}projectPosition(e){const[i,s,c=0]=e,h=i*u0,p=s*u0,v=Math.cos(p),l=(c/R0+1)*ef;return[Math.sin(h)*v*l,-Math.cos(h)*v*l,Math.sin(p)*l]}unprojectPosition(e){const[i,s,c]=e,h=$D(e),p=Math.asin(c/h),l=Math.atan2(i,-s)*oR,A=p*oR,P=(h/ef-1)*R0;return[l,A,P]}projectFlat(e){return e}unprojectFlat(e){return e}panByPosition(e,i){const s=this.unproject(i);return{longitude:e[0]-s[0]+this.longitude,latitude:e[1]-s[1]+this.latitude}}}function Kb(t,e){const i=Pf([],e,t);return EE(i,i,1/i[3]),i}const yZ=new Vs().lookAt({eye:[0,0,1]});function vZ({width:t,height:e,near:i,far:s,padding:c}){let h=-t/2,p=t/2,v=-e/2,l=e/2;if(c){const{left:A=0,right:P=0,top:O=0,bottom:L=0}=c,U=Os((A+t-P)/2,0,t)-t/2,H=Os((O+e-L)/2,0,e)-e/2;h-=U,p-=U,v+=H,l+=H}return new Vs().ortho({left:h,right:p,bottom:v,top:l,near:i,far:s})}class WL extends Tf{constructor(e){const{width:i,height:s,near:c=.1,far:h=1e3,zoom:p=0,target:v=[0,0,0],padding:l=null,flipY:A=!0}=e,P=Array.isArray(p)?p[0]:p,O=Array.isArray(p)?p[1]:p,L=Math.min(P,O),U=Math.pow(2,L);let H;if(P!==O){const Y=Math.pow(2,P),J=Math.pow(2,O);H={unitsPerMeter:[Y/U,J/U,1],metersPerUnit:[U/Y,U/J,1]}}super({...e,longitude:void 0,position:v,viewMatrix:yZ.clone().scale([U,U*(A?-1:1),U]),projectionMatrix:vZ({width:i||1,height:s||1,padding:l,near:c,far:h}),zoom:L,distanceScales:H})}projectFlat([e,i]){const{unitsPerMeter:s}=this.distanceScales;return[e*s[0],i*s[1]]}unprojectFlat([e,i]){const{metersPerUnit:s}=this.distanceScales;return[e*s[0],i*s[1]]}panByPosition(e,i){const s=c1(i,this.pixelUnprojectionMatrix),c=this.projectFlat(e),h=av([],c,DD([],s)),p=av([],this.center,h);return{target:this.unprojectFlat(p)}}}class xZ extends fL{constructor(e){const{width:i,height:s,rotationX:c=0,rotationOrbit:h=0,target:p=[0,0,0],zoom:v=0,minRotationX:l=-90,maxRotationX:A=90,minZoom:P=-1/0,maxZoom:O=1/0,startPanPosition:L,startRotatePos:U,startRotationX:H,startRotationOrbit:Y,startZoomPosition:J,startZoom:oe}=e;super({width:i,height:s,rotationX:c,rotationOrbit:h,target:p,zoom:v,minRotationX:l,maxRotationX:A,minZoom:P,maxZoom:O},{startPanPosition:L,startRotatePos:U,startRotationX:H,startRotationOrbit:Y,startZoomPosition:J,startZoom:oe}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanPosition:this._unproject(e)})}pan({pos:e,startPosition:i}){const s=this.getState().startPanPosition||i;if(!s)return this;const h=this.makeViewport(this.getViewportProps()).panByPosition(s,e);return this._getUpdatedState(h)}panEnd(){return this._getUpdatedState({startPanPosition:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startRotationX:this.getViewportProps().rotationX,startRotationOrbit:this.getViewportProps().rotationOrbit})}rotate({pos:e,deltaAngleX:i=0,deltaAngleY:s=0}){const{startRotatePos:c,startRotationX:h,startRotationOrbit:p}=this.getState(),{width:v,height:l}=this.getViewportProps();if(!c||h===void 0||p===void 0)return this;let A;if(e){let P=(e[0]-c[0])/v;const O=(e[1]-c[1])/l;(h<-90||h>90)&&(P*=-1),A={rotationX:h+O*180,rotationOrbit:p+P*180}}else A={rotationX:h+s,rotationOrbit:p+i};return this._getUpdatedState(A)}rotateEnd(){return this._getUpdatedState({startRotationX:null,startRotationOrbit:null})}shortestPathFrom(e){const i=e.getViewportProps(),s={...this.getViewportProps()},{rotationOrbit:c}=s;return Math.abs(c-i.rotationOrbit)>180&&(s.rotationOrbit=c<0?c+360:c-360),s}zoomStart({pos:e}){return this._getUpdatedState({startZoomPosition:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:i,scale:s}){let{startZoom:c,startZoomPosition:h}=this.getState();if(h||(c=this.getViewportProps().zoom,h=this._unproject(i)||this._unproject(e)),!h)return this;const p=this._calculateNewZoom({scale:s,startZoom:c}),v=this.makeViewport({...this.getViewportProps(),zoom:p});return this._getUpdatedState({zoom:p,...v.panByPosition(h,e)})}zoomEnd(){return this._getUpdatedState({startZoomPosition:null,startZoom:null})}zoomIn(e=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:e})})}zoomOut(e=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:1/e})})}moveLeft(e=50){return this._panFromCenter([-e,0])}moveRight(e=50){return this._panFromCenter([e,0])}moveUp(e=50){return this._panFromCenter([0,-e])}moveDown(e=50){return this._panFromCenter([0,e])}rotateLeft(e=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit-e})}rotateRight(e=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit+e})}rotateUp(e=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX-e})}rotateDown(e=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX+e})}_unproject(e){const i=this.makeViewport(this.getViewportProps());return e&&i.unproject(e)}_calculateNewZoom({scale:e,startZoom:i}){const{maxZoom:s,minZoom:c}=this.getViewportProps();i===void 0&&(i=this.getViewportProps().zoom);const h=i+Math.log2(e);return Os(h,c,s)}_panFromCenter(e){const{width:i,height:s,target:c}=this.getViewportProps();return this.pan({startPosition:c,pos:[i/2+e[0],s/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}applyConstraints(e){const{maxZoom:i,minZoom:s,zoom:c,maxRotationX:h,minRotationX:p,rotationOrbit:v}=e;return e.zoom=Array.isArray(c)?[Os(c[0],s,i),Os(c[1],s,i)]:Os(c,s,i),e.rotationX=Os(e.rotationX,p,h),(v<-180||v>180)&&(e.rotationOrbit=aW(v+180,360)-180),e}}class bZ extends xZ{constructor(e){super(e),this.zoomAxis=e.zoomAxis||"all"}_calculateNewZoom({scale:e,startZoom:i}){const{maxZoom:s,minZoom:c}=this.getViewportProps();i===void 0&&(i=this.getViewportProps().zoom);let h=Math.log2(e);if(Array.isArray(i)){let[p,v]=i;switch(this.zoomAxis){case"X":p=Os(p+h,c,s);break;case"Y":v=Os(v+h,c,s);break;default:let l=Math.min(p+h,v+h);l<c&&(h+=c-l),l=Math.max(p+h,v+h),l>s&&(h+=s-l),p+=h,v+=h}return[p,v]}return Os(i+h,c,s)}}class wZ extends dL{constructor(){super(...arguments),this.ControllerState=bZ,this.transition={transitionDuration:300,transitionInterpolator:new C_(["target","zoom"])},this.dragMode="pan"}_onPanRotate(){return!1}}const eS=class eS extends hL{constructor(e={}){super(e)}get ViewportType(){return WL}get ControllerType(){return wZ}};eS.displayName="OrthographicView";let Cc=eS;class HL{constructor(e){this.indexStarts=[0],this.vertexStarts=[0],this.vertexCount=0,this.instanceCount=0;const{attributes:i={}}=e;this.typedArrayManager=wf,this.attributes={},this._attributeDefs=i,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);const{data:i,buffers:s={},getGeometry:c,geometryBuffer:h,positionFormat:p,dataChanged:v,normalize:l=!0}=this.opts;if(this.data=i,this.getGeometry=c,this.positionSize=h&&h.size||(p==="XY"?2:3),this.buffers=s,this.normalize=l,h&&(zs(i.startIndices),this.getGeometry=this.getGeometryFromBuffer(h),l||(s.vertexPositions=h)),this.geometryBuffer=s.vertexPositions,Array.isArray(v))for(const A of v)this._rebuildGeometry(A);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:i}){this._rebuildGeometry({startRow:e,endRow:i})}getGeometryFromBuffer(e){const i=e.value||e;return ArrayBuffer.isView(i)?kL(i,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,i){const{attributes:s,buffers:c,_attributeDefs:h,typedArrayManager:p}=this;for(const v in h)if(v in c)p.release(s[v]),s[v]=null;else{const l=h[v];l.copy=i,s[v]=p.allocate(s[v],e,l)}}_forEachGeometry(e,i,s){const{data:c,getGeometry:h}=this,{iterable:p,objectInfo:v}=_1(c,i,s);for(const l of p){v.index++;const A=h?h(l,v):null;e(A,v.index)}}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:i,vertexStarts:s,instanceCount:c}=this;const{data:h,geometryBuffer:p}=this,{startRow:v=0,endRow:l=1/0}=e||{},A={};if(e||(i=[0],s=[0]),this.normalize||!p)this._forEachGeometry((O,L)=>{const U=O&&this.normalizeGeometry(O);A[L]=U,s[L+1]=s[L]+(U?this.getGeometrySize(U):0)},v,l),c=s[s.length-1];else if(s=h.startIndices,c=s[h.length]||0,ArrayBuffer.isView(p))c=c||p.length/this.positionSize;else if(p instanceof Yn){const O=this.positionSize*4;c=c||p.byteLength/O}else if(p.buffer){const O=p.stride||this.positionSize*4;c=c||p.buffer.byteLength/O}else if(p.value){const O=p.value,L=p.stride/O.BYTES_PER_ELEMENT||this.positionSize;c=c||O.length/L}this._allocate(c,!!e),this.indexStarts=i,this.vertexStarts=s,this.instanceCount=c;const P={};this._forEachGeometry((O,L)=>{const U=A[L]||O;P.vertexStart=s[L],P.indexStart=i[L];const H=L<s.length-1?s[L+1]:c;P.geometrySize=H-s[L],P.geometryIndex=L,this.updateGeometryAttributes(U,P)},v,l),this.vertexCount=i[i.length-1]}}const TZ=new Uint32Array([0,2,1,0,3,2]),EZ=new Float32Array([0,1,0,0,1,0,1,1]);function SZ(t,e){if(!e)return AZ(t);const i=Math.max(Math.abs(t[0][0]-t[3][0]),Math.abs(t[1][0]-t[2][0])),s=Math.max(Math.abs(t[1][1]-t[0][1]),Math.abs(t[2][1]-t[3][1])),c=Math.ceil(i/e)+1,h=Math.ceil(s/e)+1,p=(c-1)*(h-1)*6,v=new Uint32Array(p),l=new Float32Array(c*h*2),A=new Float64Array(c*h*3);let P=0,O=0;for(let L=0;L<c;L++){const U=L/(c-1);for(let H=0;H<h;H++){const Y=H/(h-1),J=MZ(t,U,Y);A[P*3+0]=J[0],A[P*3+1]=J[1],A[P*3+2]=J[2]||0,l[P*2+0]=U,l[P*2+1]=1-Y,L>0&&H>0&&(v[O++]=P-h,v[O++]=P-h-1,v[O++]=P-1,v[O++]=P-h,v[O++]=P-1,v[O++]=P),P++}}return{vertexCount:p,positions:A,indices:v,texCoords:l}}function AZ(t){const e=new Float64Array(12);for(let i=0;i<t.length;i++)e[i*3+0]=t[i][0],e[i*3+1]=t[i][1],e[i*3+2]=t[i][2]||0;return{vertexCount:6,positions:e,indices:TZ,texCoords:EZ}}function MZ(t,e,i){return dh(dh(t[0],t[1],i),dh(t[3],t[2],i),e)}const CZ=`#version 300 es
#define SHADER_NAME bitmap-layer-vertex-shader

in vec2 texCoords;
in vec3 positions;
in vec3 positions64Low;

out vec2 vTexCoord;
out vec2 vTexPos;

uniform float coordinateConversion;

const vec3 pickingColor = vec3(1.0, 0.0, 0.0);

void main(void) {
  geometry.worldPosition = positions;
  geometry.uv = texCoords;
  geometry.pickingColor = pickingColor;

  gl_Position = project_position_to_clipspace(positions, positions64Low, vec3(0.0), geometry.position);
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  vTexCoord = texCoords;

  if (coordinateConversion < -0.5) {
    vTexPos = geometry.position.xy + project_uCommonOrigin.xy;
  } else if (coordinateConversion > 0.5) {
    vTexPos = geometry.worldPosition.xy;
  }

  vec4 color = vec4(0.0);
  DECKGL_FILTER_COLOR(color, geometry);
}
`,PZ=`
vec3 packUVsIntoRGB(vec2 uv) {
  // Extract the top 8 bits. We want values to be truncated down so we can add a fraction
  vec2 uv8bit = floor(uv * 256.);

  // Calculate the normalized remainders of u and v parts that do not fit into 8 bits
  // Scale and clamp to 0-1 range
  vec2 uvFraction = fract(uv * 256.);
  vec2 uvFraction4bit = floor(uvFraction * 16.);

  // Remainder can be encoded in blue channel, encode as 4 bits for pixel coordinates
  float fractions = uvFraction4bit.x + uvFraction4bit.y * 16.;

  return vec3(uv8bit, fractions) / 255.;
}
`,IZ=`#version 300 es
#define SHADER_NAME bitmap-layer-fragment-shader

#ifdef GL_ES
precision highp float;
#endif

uniform sampler2D bitmapTexture;

in vec2 vTexCoord;
in vec2 vTexPos;

out vec4 fragColor;

uniform float desaturate;
uniform vec4 transparentColor;
uniform vec3 tintColor;
uniform float opacity;

uniform float coordinateConversion;
uniform vec4 bounds;

/* projection utils */
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / PI / 2.0;

// from degrees to Web Mercator
vec2 lnglat_to_mercator(vec2 lnglat) {
  float x = lnglat.x;
  float y = clamp(lnglat.y, -89.9, 89.9);
  return vec2(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// from Web Mercator to degrees
vec2 mercator_to_lnglat(vec2 xy) {
  xy /= WORLD_SCALE;
  return degrees(vec2(
    xy.x - PI,
    atan(exp(xy.y - PI)) * 2.0 - PI * 0.5
  ));
}
/* End projection utils */

// apply desaturation
vec3 color_desaturate(vec3 color) {
  float luminance = (color.r + color.g + color.b) * 0.333333333;
  return mix(color, vec3(luminance), desaturate);
}

// apply tint
vec3 color_tint(vec3 color) {
  return color * tintColor;
}

// blend with background color
vec4 apply_opacity(vec3 color, float alpha) {
  if (transparentColor.a == 0.0) {
    return vec4(color, alpha);
  }
  float blendedAlpha = alpha + transparentColor.a * (1.0 - alpha);
  float highLightRatio = alpha / blendedAlpha;
  vec3 blendedRGB = mix(transparentColor.rgb, color, highLightRatio);
  return vec4(blendedRGB, blendedAlpha);
}

vec2 getUV(vec2 pos) {
  return vec2(
    (pos.x - bounds[0]) / (bounds[2] - bounds[0]),
    (pos.y - bounds[3]) / (bounds[1] - bounds[3])
  );
}

${PZ}

void main(void) {
  vec2 uv = vTexCoord;
  if (coordinateConversion < -0.5) {
    vec2 lnglat = mercator_to_lnglat(vTexPos);
    uv = getUV(lnglat);
  } else if (coordinateConversion > 0.5) {
    vec2 commonPos = lnglat_to_mercator(vTexPos);
    uv = getUV(commonPos);
  }
  vec4 bitmapColor = texture(bitmapTexture, uv);

  fragColor = apply_opacity(color_tint(color_desaturate(bitmapColor.rgb)), bitmapColor.a * opacity);

  geometry.uv = uv;
  DECKGL_FILTER_COLOR(fragColor, geometry);

  if (bool(picking.isActive) && !bool(picking.isAttribute)) {
    // Since instance information is not used, we can use picking color for pixel index
    fragColor.rgb = packUVsIntoRGB(uv);
  }
}
`,RZ={image:{type:"image",value:null,async:!0},bounds:{type:"array",value:[1,0,0,1],compare:!0},_imageCoordinateSystem:qr.DEFAULT,desaturate:{type:"number",min:0,max:1,value:0},transparentColor:{type:"color",value:[0,0,0,0]},tintColor:{type:"color",value:[255,255,255]},textureParameters:{type:"object",ignore:!0,value:null}},Wv=class Wv extends Fl{getShaders(){return super.getShaders({vs:CZ,fs:IZ,modules:[If,Rf]})}initializeState(){const e=this.getAttributeManager();e.remove(["instancePickingColors"]);const i=!0;e.add({indices:{size:1,isIndexed:!0,update:s=>s.value=this.state.mesh.indices,noAlloc:i},positions:{size:3,type:"float64",fp64:this.use64bitPositions(),update:s=>s.value=this.state.mesh.positions,noAlloc:i},texCoords:{size:2,update:s=>s.value=this.state.mesh.texCoords,noAlloc:i}})}updateState({props:e,oldProps:i,changeFlags:s}){var h;const c=this.getAttributeManager();if(s.extensionsChanged&&((h=this.state.model)==null||h.destroy(),this.state.model=this._getModel(),c.invalidateAll()),e.bounds!==i.bounds){const p=this.state.mesh,v=this._createMesh();this.state.model.setVertexCount(v.vertexCount);for(const l in v)p&&p[l]!==v[l]&&c.invalidate(l);this.setState({mesh:v,...this._getCoordinateUniforms()})}else e._imageCoordinateSystem!==i._imageCoordinateSystem&&this.setState(this._getCoordinateUniforms())}getPickingInfo(e){const{image:i}=this.props,s=e.info;if(!s.color||!i)return s.bitmap=null,s;const{width:c,height:h}=i;s.index=0;const p=OZ(s.color);return s.bitmap={size:{width:c,height:h},uv:p,pixel:[Math.floor(p[0]*c),Math.floor(p[1]*h)]},s}disablePickingIndex(){this.setState({disablePicking:!0})}restorePickingColors(){this.setState({disablePicking:!1})}_updateAutoHighlight(e){super._updateAutoHighlight({...e,color:this.encodePickingColor(0)})}_createMesh(){const{bounds:e}=this.props;let i=e;return aR(e)&&(i=[[e[0],e[1]],[e[0],e[3]],[e[2],e[3]],[e[2],e[1]]]),SZ(i,this.context.viewport.resolution)}_getModel(){return new Yo(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),topology:"triangle-list",isInstanced:!1})}draw(e){const{uniforms:i,moduleParameters:s}=e,{model:c,coordinateConversion:h,bounds:p,disablePicking:v}=this.state,{image:l,desaturate:A,transparentColor:P,tintColor:O}=this.props;s.picking.isActive&&v||l&&c&&(c.setUniforms(i),c.setBindings({bitmapTexture:l}),c.setUniforms({desaturate:A,transparentColor:P.map(L=>L/255),tintColor:O.slice(0,3).map(L=>L/255),coordinateConversion:h,bounds:p}),c.draw(this.context.renderPass))}_getCoordinateUniforms(){const{LNGLAT:e,CARTESIAN:i,DEFAULT:s}=qr;let{_imageCoordinateSystem:c}=this.props;if(c!==s){const{bounds:h}=this.props;if(!aR(h))throw new Error("_imageCoordinateSystem only supports rectangular bounds");const p=this.context.viewport.resolution?e:i;if(c=c===e?e:i,c===e&&p===i)return{coordinateConversion:-1,bounds:h};if(c===i&&p===e){const v=$c([h[0],h[1]]),l=$c([h[2],h[3]]);return{coordinateConversion:1,bounds:[v[0],v[1],l[0],l[1]]}}}return{coordinateConversion:0,bounds:[0,0,0,0]}}};Wv.layerName="BitmapLayer",Wv.defaultProps=RZ;let IT=Wv;function OZ(t){const[e,i,s]=t,c=(s&240)/256,h=(s&15)/16;return[(e+h)/256,(i+c)/256]}function aR(t){return Number.isFinite(t[0])}const kZ=`#version 300 es
#define SHADER_NAME icon-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceSizes;
in float instanceAngles;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec4 instanceIconFrames;
in float instanceColorModes;
in vec2 instanceOffsets;
in vec2 instancePixelOffset;
uniform float sizeScale;
uniform vec2 iconsTextureDim;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform bool billboard;
uniform int sizeUnits;
out float vColorMode;
out vec4 vColor;
out vec2 vTextureCoords;
out vec2 uv;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = angle * PI / 180.0;
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vec2 iconSize = instanceIconFrames.zw;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * sizeScale, sizeUnits),
sizeMinPixels, sizeMaxPixels
);
float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;
vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
pixelOffset += instancePixelOffset;
pixelOffset.y *= -1.0;
if (billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vTextureCoords = mix(
instanceIconFrames.xy,
instanceIconFrames.xy + iconSize,
(positions.xy + 1.0) / 2.0
) / iconsTextureDim;
vColor = instanceColors;
DECKGL_FILTER_COLOR(vColor, geometry);
vColorMode = instanceColorModes;
}
`,DZ=`#version 300 es
#define SHADER_NAME icon-layer-fragment-shader
precision highp float;
uniform float opacity;
uniform sampler2D iconsTexture;
uniform float alphaCutoff;
in float vColorMode;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
vec4 texColor = texture(iconsTexture, vTextureCoords);
vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
float a = texColor.a * opacity * vColor.a;
if (a < alphaCutoff) {
discard;
}
fragColor = vec4(color, a);
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,LZ=1024,NZ=4,lR=()=>{},cR={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},FZ={x:0,y:0,width:0,height:0};function BZ(t){return Math.pow(2,Math.ceil(Math.log2(t)))}function zZ(t,e,i,s){const c=Math.min(i/e.width,s/e.height),h=Math.floor(e.width*c),p=Math.floor(e.height*c);return c===1?{data:e,width:h,height:p}:(t.canvas.height=p,t.canvas.width=h,t.clearRect(0,0,h,p),t.drawImage(e,0,0,e.width,e.height,0,0,h,p),{data:t.canvas,width:h,height:p})}function R_(t){return t&&(t.id||t.url)}function UZ(t,e,i,s){const{width:c,height:h,device:p}=t,v=p.createTexture({format:"rgba8unorm",width:e,height:i,sampler:s}),l=p.createCommandEncoder();return l.copyTextureToTexture({source:t,destination:v,width:c,height:h}),l.finish(),t.destroy(),v}function uR(t,e,i){for(let s=0;s<e.length;s++){const{icon:c,xOffset:h}=e[s],p=R_(c);t[p]={...c,x:h,y:i}}}function VZ({icons:t,buffer:e,mapping:i={},xOffset:s=0,yOffset:c=0,rowHeight:h=0,canvasWidth:p}){let v=[];for(let l=0;l<t.length;l++){const A=t[l],P=R_(A);if(!i[P]){const{height:O,width:L}=A;s+L+e>p&&(uR(i,v,c),s=0,c=h+c+e,h=0,v=[]),v.push({icon:A,xOffset:s}),s=s+L+e,h=Math.max(h,O)}}return v.length>0&&uR(i,v,c),{mapping:i,rowHeight:h,xOffset:s,yOffset:c,canvasWidth:p,canvasHeight:BZ(h+c+e)}}function jZ(t,e,i){if(!t||!e)return null;i=i||{};const s={},{iterable:c,objectInfo:h}=_1(t);for(const p of c){h.index++;const v=e(p,h),l=R_(v);if(!v)throw new Error("Icon is missing.");if(!v.url)throw new Error("Icon url is missing.");!s[l]&&(!i[l]||v.url!==i[l].url)&&(s[l]={...v,source:p,sourceIndex:h.index})}return s}class $Z{constructor(e,{onUpdate:i=lR,onError:s=lR}){this._loadOptions=null,this._texture=null,this._externalTexture=null,this._mapping={},this._textureParameters=null,this._pendingCount=0,this._autoPacking=!1,this._xOffset=0,this._yOffset=0,this._rowHeight=0,this._buffer=NZ,this._canvasWidth=LZ,this._canvasHeight=0,this._canvas=null,this.device=e,this.onUpdate=i,this.onError=s}finalize(){var e;(e=this._texture)==null||e.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){const i=this._autoPacking?R_(e):e;return this._mapping[i]||FZ}setProps({loadOptions:e,autoPacking:i,iconAtlas:s,iconMapping:c,textureParameters:h}){var p;e&&(this._loadOptions=e),i!==void 0&&(this._autoPacking=i),c&&(this._mapping=c),s&&((p=this._texture)==null||p.delete(),this._texture=null,this._externalTexture=s),h&&(this._textureParameters=h)}get isLoaded(){return this._pendingCount===0}packIcons(e,i){if(!this._autoPacking||typeof document>"u")return;const s=Object.values(jZ(e,i,this._mapping)||{});if(s.length>0){const{mapping:c,xOffset:h,yOffset:p,rowHeight:v,canvasHeight:l}=VZ({icons:s,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=v,this._mapping=c,this._xOffset=h,this._yOffset=p,this._canvasHeight=l,this._texture||(this._texture=this.device.createTexture({format:"rgba8unorm",width:this._canvasWidth,height:this._canvasHeight,sampler:this._textureParameters||cR})),this._texture.height!==this._canvasHeight&&(this._texture=UZ(this._texture,this._canvasWidth,this._canvasHeight,this._textureParameters||cR)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(s)}}_loadIcons(e){const i=this._canvas.getContext("2d",{willReadFrequently:!0});for(const s of e)this._pendingCount++,ch(s.url,this._loadOptions).then(c=>{const h=R_(s),p=this._mapping[h],{x:v,y:l,width:A,height:P}=p,{data:O,width:L,height:U}=zZ(i,c,A,P);this._texture.setSubImageData({data:O,x:v+(A-L)/2,y:l+(P-U)/2,width:L,height:U}),p.width=L,p.height=U,this._texture.generateMipmap(),this.onUpdate()}).catch(c=>{this.onError({url:s.url,source:s.source,sourceIndex:s.sourceIndex,loadOptions:this._loadOptions,error:c})}).finally(()=>{this._pendingCount--})}}const qL=[0,0,0,255],WZ={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:t=>t.position},getIcon:{type:"accessor",value:t=>t.icon},getColor:{type:"accessor",value:qL},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,optional:!0},textureParameters:{type:"object",ignore:!0,value:null}},Hv=class Hv extends Fl{getShaders(){return super.getShaders({vs:kZ,fs:DZ,modules:[If,Rf]})}initializeState(){this.state={iconManager:new $Z(this.context.device,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:"uint8",accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getColor",defaultValue:qL},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){var U;super.updateState(e);const{props:i,oldProps:s,changeFlags:c}=e,h=this.getAttributeManager(),{iconAtlas:p,iconMapping:v,data:l,getIcon:A,textureParameters:P}=i,{iconManager:O}=this.state;if(typeof p=="string")return;const L=p||this.internalState.isAsyncPropLoading("iconAtlas");O.setProps({loadOptions:i.loadOptions,autoPacking:!L,iconAtlas:p,iconMapping:L?v:null,textureParameters:P}),L?s.iconMapping!==i.iconMapping&&h.invalidate("getIcon"):(c.dataChanged||c.updateTriggersChanged&&(c.updateTriggersChanged.all||c.updateTriggersChanged.getIcon))&&O.packIcons(l,A),c.extensionsChanged&&((U=this.state.model)==null||U.destroy(),this.state.model=this._getModel(),h.invalidateAll())}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){const{sizeScale:i,sizeMinPixels:s,sizeMaxPixels:c,sizeUnits:h,billboard:p,alphaCutoff:v}=this.props,{iconManager:l}=this.state,A=l.getTexture();if(A){const P=this.state.model;P.setBindings({iconsTexture:A}),P.setUniforms(e),P.setUniforms({iconsTextureDim:[A.width,A.height],sizeUnits:Eh[h],sizeScale:i,sizeMinPixels:s,sizeMaxPixels:c,billboard:p,alphaCutoff:v}),P.draw(this.context.renderPass)}}_getModel(){const e=[-1,-1,1,-1,-1,1,1,1];return new Yo(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Sf({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array(e)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){var s;const i=(s=this.getCurrentLayer())==null?void 0:s.props.onIconError;i?i(e):jr.error(e.error.message)()}getInstanceOffset(e){const{width:i,height:s,anchorX:c=i/2,anchorY:h=s/2}=this.state.iconManager.getIconMapping(e);return[i/2-c,s/2-h]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){const{x:i,y:s,width:c,height:h}=this.state.iconManager.getIconMapping(e);return[i,s,c,h]}};Hv.defaultProps=WZ,Hv.layerName="IconLayer";let Af=Hv;const HZ=`#version 300 es
#define SHADER_NAME scatterplot-layer-vertex-shader
in vec3 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceRadius;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
uniform float opacity;
uniform float radiusScale;
uniform float radiusMinPixels;
uniform float radiusMaxPixels;
uniform float lineWidthScale;
uniform float lineWidthMinPixels;
uniform float lineWidthMaxPixels;
uniform float stroked;
uniform bool filled;
uniform bool antialiasing;
uniform bool billboard;
uniform int radiusUnits;
uniform int lineWidthUnits;
out vec4 vFillColor;
out vec4 vLineColor;
out vec2 unitPosition;
out float innerUnitRadius;
out float outerRadiusPixels;
void main(void) {
geometry.worldPosition = instancePositions;
outerRadiusPixels = clamp(
project_size_to_pixel(radiusScale * instanceRadius, radiusUnits),
radiusMinPixels, radiusMaxPixels
);
float lineWidthPixels = clamp(
project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),
lineWidthMinPixels, lineWidthMaxPixels
);
outerRadiusPixels += stroked * lineWidthPixels / 2.0;
float edgePadding = antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;
unitPosition = edgePadding * positions.xy;
geometry.uv = unitPosition;
geometry.pickingColor = instancePickingColors;
innerUnitRadius = 1.0 - stroked * lineWidthPixels / outerRadiusPixels;
if (billboard) {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = edgePadding * positions * outerRadiusPixels;
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,qZ=`#version 300 es
#define SHADER_NAME scatterplot-layer-fragment-shader
precision highp float;
uniform bool filled;
uniform float stroked;
uniform bool antialiasing;
in vec4 vFillColor;
in vec4 vLineColor;
in vec2 unitPosition;
in float innerUnitRadius;
in float outerRadiusPixels;
out vec4 fragColor;
void main(void) {
geometry.uv = unitPosition;
float distToCenter = length(unitPosition) * outerRadiusPixels;
float inCircle = antialiasing ?
smoothedge(distToCenter, outerRadiusPixels) :
step(distToCenter, outerRadiusPixels);
if (inCircle == 0.0) {
discard;
}
if (stroked > 0.5) {
float isLine = antialiasing ?
smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :
step(innerUnitRadius * outerRadiusPixels, distToCenter);
if (filled) {
fragColor = mix(vFillColor, vLineColor, isLine);
} else {
if (isLine == 0.0) {
discard;
}
fragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);
}
} else if (!filled) {
discard;
} else {
fragColor = vFillColor;
}
fragColor.a *= inCircle;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,hR=[0,0,0,255],GZ={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:t=>t.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:hR},getLineColor:{type:"accessor",value:hR},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}},qv=class qv extends Fl{getShaders(){return super.getShaders({vs:HZ,fs:qZ,modules:[If,Rf]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){var i;super.updateState(e),e.changeFlags.extensionsChanged&&((i=this.state.model)==null||i.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{radiusUnits:i,radiusScale:s,radiusMinPixels:c,radiusMaxPixels:h,stroked:p,filled:v,billboard:l,antialiasing:A,lineWidthUnits:P,lineWidthScale:O,lineWidthMinPixels:L,lineWidthMaxPixels:U}=this.props,H=this.state.model;H.setUniforms(e),H.setUniforms({stroked:p?1:0,filled:v,billboard:l,antialiasing:A,radiusUnits:Eh[i],radiusScale:s,radiusMinPixels:c,radiusMaxPixels:h,lineWidthUnits:Eh[P],lineWidthScale:O,lineWidthMinPixels:L,lineWidthMaxPixels:U}),H.draw(this.context.renderPass)}_getModel(){const e=[-1,-1,0,1,-1,0,-1,1,0,1,1,0];return new Yo(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Sf({topology:"triangle-strip",attributes:{positions:{size:3,value:new Float32Array(e)}}}),isInstanced:!0})}};qv.defaultProps=GZ,qv.layerName="ScatterplotLayer";let RT=qv;const GL={CLOCKWISE:1,COUNTER_CLOCKWISE:-1};function XL(t,e,i={}){return XZ(t,i)!==e?(YZ(t,i),!0):!1}function XZ(t,e={}){return Math.sign(ZZ(t,e))}const dR={x:0,y:1,z:2};function ZZ(t,e={}){const{start:i=0,end:s=t.length,plane:c="xy"}=e,h=e.size||2;let p=0;const v=dR[c[0]],l=dR[c[1]];for(let A=i,P=s-h;A<s;A+=h)p+=(t[A+v]-t[P+v])*(t[A+l]+t[P+l]),P=A;return p/2}function YZ(t,e){const{start:i=0,end:s=t.length,size:c=2}=e,h=(s-i)/c,p=Math.floor(h/2);for(let v=0;v<p;++v){const l=i+v*c,A=i+(h-1-v)*c;for(let P=0;P<c;++P){const O=t[l+P];t[l+P]=t[A+P],t[A+P]=O}}}function ba(t,e){const i=e.length,s=t.length;if(s>0){let c=!0;for(let h=0;h<i;h++)if(t[s-i+h]!==e[h]){c=!1;break}if(c)return!1}for(let c=0;c<i;c++)t[s+c]=e[c];return!0}function OT(t,e){const i=e.length;for(let s=0;s<i;s++)t[s]=e[s]}function O_(t,e,i,s,c=[]){const h=s+e*i;for(let p=0;p<i;p++)c[p]=t[h+p];return c}function kT(t,e,i,s,c=[]){let h,p;if(i&8)h=(s[3]-t[1])/(e[1]-t[1]),p=3;else if(i&4)h=(s[1]-t[1])/(e[1]-t[1]),p=1;else if(i&2)h=(s[2]-t[0])/(e[0]-t[0]),p=2;else if(i&1)h=(s[0]-t[0])/(e[0]-t[0]),p=0;else return null;for(let v=0;v<t.length;v++)c[v]=(p&1)===v?s[p]:h*(e[v]-t[v])+t[v];return c}function O0(t,e){let i=0;return t[0]<e[0]?i|=1:t[0]>e[2]&&(i|=2),t[1]<e[1]?i|=4:t[1]>e[3]&&(i|=8),i}function ZL(t,e){const{size:i=2,broken:s=!1,gridResolution:c=10,gridOffset:h=[0,0],startIndex:p=0,endIndex:v=t.length}=e||{},l=(v-p)/i;let A=[];const P=[A],O=O_(t,0,i,p);let L,U;const H=KL(O,c,h,[]),Y=[];ba(A,O);for(let J=1;J<l;J++){for(L=O_(t,J,i,p,L),U=O0(L,H);U;){kT(O,L,U,H,Y);const oe=O0(Y,H);oe&&(kT(O,Y,oe,H,Y),U=oe),ba(A,Y),OT(O,Y),JZ(H,c,U),s&&A.length>i&&(A=[],P.push(A),ba(A,O)),U=O0(L,H)}ba(A,L),OT(O,L)}return s?P:P[0]}const fR=0,KZ=1;function YL(t,e=null,i){if(!t.length)return[];const{size:s=2,gridResolution:c=10,gridOffset:h=[0,0],edgeTypes:p=!1}=i||{},v=[],l=[{pos:t,types:p?new Array(t.length/s).fill(KZ):null,holes:e||[]}],A=[[],[]];let P=[];for(;l.length;){const{pos:O,types:L,holes:U}=l.shift();QZ(O,s,U[0]||O.length,A),P=KL(A[0],c,h,P);const H=O0(A[1],P);if(H){let Y=pR(O,L,s,0,U[0]||O.length,P,H);const J={pos:Y[0].pos,types:Y[0].types,holes:[]},oe={pos:Y[1].pos,types:Y[1].types,holes:[]};l.push(J,oe);for(let me=0;me<U.length;me++)Y=pR(O,L,s,U[me],U[me+1]||O.length,P,H),Y[0]&&(J.holes.push(J.pos.length),J.pos=h0(J.pos,Y[0].pos),p&&(J.types=h0(J.types,Y[0].types))),Y[1]&&(oe.holes.push(oe.pos.length),oe.pos=h0(oe.pos,Y[1].pos),p&&(oe.types=h0(oe.types,Y[1].types)))}else{const Y={positions:O};p&&(Y.edgeTypes=L),U.length&&(Y.holeIndices=U),v.push(Y)}}return v}function pR(t,e,i,s,c,h,p){const v=(c-s)/i,l=[],A=[],P=[],O=[],L=[];let U,H,Y;const J=O_(t,v-1,i,s);let oe=Math.sign(p&8?J[1]-h[3]:J[0]-h[2]),me=e&&e[v-1],pe=0,be=0;for(let Oe=0;Oe<v;Oe++)U=O_(t,Oe,i,s,U),H=Math.sign(p&8?U[1]-h[3]:U[0]-h[2]),Y=e&&e[s/i+Oe],H&&oe&&oe!==H&&(kT(J,U,p,h,L),ba(l,L)&&P.push(me),ba(A,L)&&O.push(me)),H<=0?(ba(l,U)&&P.push(Y),pe-=H):P.length&&(P[P.length-1]=fR),H>=0?(ba(A,U)&&O.push(Y),be+=H):O.length&&(O[O.length-1]=fR),OT(J,U),oe=H,me=Y;return[pe?{pos:l,types:e&&P}:null,be?{pos:A,types:e&&O}:null]}function KL(t,e,i,s){const c=Math.floor((t[0]-i[0])/e)*e+i[0],h=Math.floor((t[1]-i[1])/e)*e+i[1];return s[0]=c,s[1]=h,s[2]=c+e,s[3]=h+e,s}function JZ(t,e,i){i&8?(t[1]+=e,t[3]+=e):i&4?(t[1]-=e,t[3]-=e):i&2?(t[0]+=e,t[2]+=e):i&1&&(t[0]-=e,t[2]-=e)}function QZ(t,e,i,s){let c=1/0,h=-1/0,p=1/0,v=-1/0;for(let l=0;l<i;l+=e){const A=t[l],P=t[l+1];c=A<c?A:c,h=A>h?A:h,p=P<p?P:p,v=P>v?P:v}return s[0][0]=c,s[0][1]=p,s[1][0]=h,s[1][1]=v,s}function h0(t,e){for(let i=0;i<e.length;i++)t.push(e[i]);return t}const eY=85.051129;function tY(t,e){const{size:i=2,startIndex:s=0,endIndex:c=t.length,normalize:h=!0}=e||{},p=t.slice(s,c);JL(p,i,0,c-s);const v=ZL(p,{size:i,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(h)for(const l of v)QL(l,i);return v}function iY(t,e=null,i){const{size:s=2,normalize:c=!0,edgeTypes:h=!1}=i||{};e=e||[];const p=[],v=[];let l=0,A=0;for(let O=0;O<=e.length;O++){const L=e[O]||t.length,U=A,H=rY(t,s,l,L);for(let Y=H;Y<L;Y++)p[A++]=t[Y];for(let Y=l;Y<H;Y++)p[A++]=t[Y];JL(p,s,U,A),nY(p,s,U,A,i==null?void 0:i.maxLatitude),l=L,v[O]=A}v.pop();const P=YL(p,v,{size:s,gridResolution:360,gridOffset:[-180,-180],edgeTypes:h});if(c)for(const O of P)QL(O.positions,s);return P}function rY(t,e,i,s){let c=-1,h=-1;for(let p=i+1;p<s;p+=e){const v=Math.abs(t[p]);v>c&&(c=v,h=p-1)}return h}function nY(t,e,i,s,c=eY){const h=t[i],p=t[s-e];if(Math.abs(h-p)>180){const v=O_(t,0,e,i);v[0]+=Math.round((p-h)/360)*360,ba(t,v),v[1]=Math.sign(v[1])*c,ba(t,v),v[0]=h,ba(t,v)}}function JL(t,e,i,s){let c=t[0],h;for(let p=i;p<s;p+=e){h=t[p];const v=h-c;(v>180||v<-180)&&(h-=Math.round(v/360)*360),t[p]=c=h}}function QL(t,e){let i;const s=t.length/e;for(let h=0;h<s&&(i=t[h*e],(i+180)%360===0);h++);const c=-Math.round(i/360)*360;if(c!==0)for(let h=0;h<s;h++)t[h*e]+=c}function sY(t,e,i,s){let c;if(Array.isArray(t[0])){const h=t.length*e;c=new Array(h);for(let p=0;p<t.length;p++)for(let v=0;v<e;v++)c[p*e+v]=t[p][v]||0}else c=t;return i?ZL(c,{size:e,gridResolution:i}):s?tY(c,{size:e}):c}const oY=1,aY=2,Jb=4;class lY extends HL{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(e){return this.attributes[e]}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):null}normalizeGeometry(e){return this.normalize?sY(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}getGeometrySize(e){if(mR(e)){let s=0;for(const c of e)s+=this.getGeometrySize(c);return s}const i=this.getPathLength(e);return i<2?0:this.isClosed(e)?i<3?0:i+2:i}updateGeometryAttributes(e,i){if(i.geometrySize!==0)if(e&&mR(e))for(const s of e){const c=this.getGeometrySize(s);i.geometrySize=c,this.updateGeometryAttributes(s,i),i.vertexStart+=c}else this._updateSegmentTypes(e,i),this._updatePositions(e,i)}_updateSegmentTypes(e,i){const s=this.attributes.segmentTypes,c=e?this.isClosed(e):!1,{vertexStart:h,geometrySize:p}=i;s.fill(0,h,h+p),c?(s[h]=Jb,s[h+p-2]=Jb):(s[h]+=oY,s[h+p-2]+=aY),s[h+p-1]=Jb}_updatePositions(e,i){const{positions:s}=this.attributes;if(!s||!e)return;const{vertexStart:c,geometrySize:h}=i,p=new Array(3);for(let v=c,l=0;l<h;v++,l++)this.getPointOnPath(e,l,p),s[v*3]=p[0],s[v*3+1]=p[1],s[v*3+2]=p[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,i,s=[]){const{positionSize:c}=this;i*c>=e.length&&(i+=1-e.length/c);const h=i*c;return s[0]=e[h],s[1]=e[h+1],s[2]=c===3&&e[h+2]||0,s}isClosed(e){if(!this.normalize)return!!this.opts.loop;const{positionSize:i}=this,s=e.length-i;return e[0]===e[s]&&e[1]===e[s+1]&&(i===2||e[2]===e[s+2])}}function mR(t){return Array.isArray(t[0])}const cY=`#version 300 es
#define SHADER_NAME path-layer-vertex-shader
in vec2 positions;
in float instanceTypes;
in vec3 instanceStartPositions;
in vec3 instanceEndPositions;
in vec3 instanceLeftPositions;
in vec3 instanceRightPositions;
in vec3 instanceLeftPositions64Low;
in vec3 instanceStartPositions64Low;
in vec3 instanceEndPositions64Low;
in vec3 instanceRightPositions64Low;
in float instanceStrokeWidths;
in vec4 instanceColors;
in vec3 instancePickingColors;
uniform float widthScale;
uniform float widthMinPixels;
uniform float widthMaxPixels;
uniform float jointType;
uniform float capType;
uniform float miterLimit;
uniform bool billboard;
uniform int widthUnits;
uniform float opacity;
out vec4 vColor;
out vec2 vCornerOffset;
out float vMiterLength;
out vec2 vPathPosition;
out float vPathLength;
out float vJointType;
const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);
float flipIfTrue(bool flag) {
return -(float(flag) * 2. - 1.);
}
vec3 getLineJoinOffset(
vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
vec2 width
) {
bool isEnd = positions.x > 0.0;
float sideOfPath = positions.y;
float isJoint = float(sideOfPath == 0.0);
vec3 deltaA3 = (currPoint - prevPoint);
vec3 deltaB3 = (nextPoint - currPoint);
mat3 rotationMatrix;
bool needsRotation = !billboard && project_needs_rotation(currPoint, rotationMatrix);
if (needsRotation) {
deltaA3 = deltaA3 * rotationMatrix;
deltaB3 = deltaB3 * rotationMatrix;
}
vec2 deltaA = deltaA3.xy / width;
vec2 deltaB = deltaB3.xy / width;
float lenA = length(deltaA);
float lenB = length(deltaB);
vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);
vec2 perpA = vec2(-dirA.y, dirA.x);
vec2 perpB = vec2(-dirB.y, dirB.x);
vec2 tangent = dirA + dirB;
tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
vec2 miterVec = vec2(-tangent.y, tangent.x);
vec2 dir = isEnd ? dirA : dirB;
vec2 perp = isEnd ? perpA : perpB;
float L = isEnd ? lenA : lenB;
float sinHalfA = abs(dot(miterVec, perp));
float cosHalfA = abs(dot(dirA, miterVec));
float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);
float cornerPosition = sideOfPath * turnDirection;
float miterSize = 1.0 / max(sinHalfA, EPSILON);
miterSize = mix(
min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
miterSize,
step(0.0, cornerPosition)
);
vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
* (sideOfPath + isJoint * turnDirection);
bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
bool isCap = isStartCap || isEndCap;
if (isCap) {
offsetVec = mix(perp * sideOfPath, dir * capType * 4.0 * flipIfTrue(isStartCap), isJoint);
vJointType = capType;
} else {
vJointType = jointType;
}
vPathLength = L;
vCornerOffset = offsetVec;
vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
vMiterLength = isCap ? isJoint : vMiterLength;
vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
vPathPosition = vec2(
dot(offsetFromStartOfPath, perp),
dot(offsetFromStartOfPath, dir)
);
geometry.uv = vPathPosition;
float isValid = step(instanceTypes, 3.5);
vec3 offset = vec3(offsetVec * width * isValid, 0.0);
if (needsRotation) {
offset = rotationMatrix * offset;
}
return offset;
}
void clipLine(inout vec4 position, vec4 refPosition) {
if (position.w < EPSILON) {
float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
position = refPosition + (position - refPosition) * r;
}
}
void main() {
geometry.pickingColor = instancePickingColors;
vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);
float isEnd = positions.x;
vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);
vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);
vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);
geometry.worldPosition = currPosition;
vec2 widthPixels = vec2(clamp(
project_size_to_pixel(instanceStrokeWidths * widthScale, widthUnits),
widthMinPixels, widthMaxPixels) / 2.0);
vec3 width;
if (billboard) {
vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);
clipLine(prevPositionScreen, currPositionScreen);
clipLine(nextPositionScreen, currPositionScreen);
clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));
width = vec3(widthPixels, 0.0);
DECKGL_FILTER_SIZE(width, geometry);
vec3 offset = getLineJoinOffset(
prevPositionScreen.xyz / prevPositionScreen.w,
currPositionScreen.xyz / currPositionScreen.w,
nextPositionScreen.xyz / nextPositionScreen.w,
project_pixel_size_to_clipspace(width.xy)
);
DECKGL_FILTER_GL_POSITION(currPositionScreen, geometry);
gl_Position = vec4(currPositionScreen.xyz + offset * currPositionScreen.w, currPositionScreen.w);
} else {
prevPosition = project_position(prevPosition, prevPosition64Low);
currPosition = project_position(currPosition, currPosition64Low);
nextPosition = project_position(nextPosition, nextPosition64Low);
width = vec3(project_pixel_size(widthPixels), 0.0);
DECKGL_FILTER_SIZE(width, geometry);
vec3 offset = getLineJoinOffset(prevPosition, currPosition, nextPosition, width.xy);
geometry.position = vec4(currPosition + offset, 1.0);
gl_Position = project_common_position_to_clipspace(geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,uY=`#version 300 es
#define SHADER_NAME path-layer-fragment-shader
precision highp float;
uniform float miterLimit;
in vec4 vColor;
in vec2 vCornerOffset;
in float vMiterLength;
in vec2 vPathPosition;
in float vPathLength;
in float vJointType;
out vec4 fragColor;
void main(void) {
geometry.uv = vPathPosition;
if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
discard;
}
if (vJointType < 0.5 && vMiterLength > miterLimit + 1.0) {
discard;
}
}
fragColor = vColor;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,eN=[0,0,0,255],hY={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:t=>t.path},getColor:{type:"accessor",value:eN},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},Qb={enter:(t,e)=>e.length?e.subarray(e.length-t.length):t},Gv=class Gv extends Fl{getShaders(){return super.getShaders({vs:cY,fs:uY,modules:[If,Rf]})}get wrapLongitude(){return!1}getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["vertexPositions"])}initializeState(){this.getAttributeManager().addInstanced({vertexPositions:{size:3,vertexOffset:1,type:"float64",fp64:this.use64bitPositions(),transition:Qb,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:"uint8",update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:Qb,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",accessor:"getColor",transition:Qb,defaultValue:eN},instancePickingColors:{size:4,type:"uint8",accessor:(s,{index:c,target:h})=>this.encodePickingColor(s&&s.__source?s.__source.index:c,h)}}),this.setState({pathTesselator:new lY({fp64:this.use64bitPositions()})})}updateState(e){var p;super.updateState(e);const{props:i,changeFlags:s}=e,c=this.getAttributeManager();if(s.dataChanged||s.updateTriggersChanged&&(s.updateTriggersChanged.all||s.updateTriggersChanged.getPath)){const{pathTesselator:v}=this.state,l=i.data.attributes||{};v.updateGeometry({data:i.data,geometryBuffer:l.getPath,buffers:l,normalize:!i._pathType,loop:i._pathType==="loop",getGeometry:i.getPath,positionFormat:i.positionFormat,wrapLongitude:i.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:s.dataChanged}),this.setState({numInstances:v.instanceCount,startIndices:v.vertexStarts}),s.dataChanged||c.invalidateAll()}s.extensionsChanged&&((p=this.state.model)==null||p.destroy(),this.state.model=this._getModel(),c.invalidateAll())}getPickingInfo(e){const i=super.getPickingInfo(e),{index:s}=i,c=this.props.data;return c[0]&&c[0].__source&&(i.object=c.find(h=>h.__source.index===s)),i}disablePickingIndex(e){const i=this.props.data;if(i[0]&&i[0].__source)for(let s=0;s<i.length;s++)i[s].__source.index===e&&this._disablePickingIndex(s);else super.disablePickingIndex(e)}draw({uniforms:e}){const{jointRounded:i,capRounded:s,billboard:c,miterLimit:h,widthUnits:p,widthScale:v,widthMinPixels:l,widthMaxPixels:A}=this.props,P=this.state.model;P.setUniforms(e),P.setUniforms({jointType:Number(i),capType:Number(s),billboard:c,widthUnits:Eh[p],widthScale:v,miterLimit:h,widthMinPixels:l,widthMaxPixels:A}),P.draw(this.context.renderPass)}_getModel(){const e=[0,1,2,1,4,2,1,3,4,3,5,4],i=[0,0,0,-1,0,1,1,-1,1,1,1,0];return new Yo(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Sf({topology:"triangle-list",attributes:{indices:new Uint16Array(e),positions:{value:new Float32Array(i),size:2}}}),isInstanced:!0})}calculatePositions(e){const{pathTesselator:i}=this.state;e.startIndices=i.vertexStarts,e.value=i.get("positions")}calculateSegmentTypes(e){const{pathTesselator:i}=this.state;e.startIndices=i.vertexStarts,e.value=i.get("segmentTypes")}};Gv.defaultProps=hY,Gv.layerName="PathLayer";let DT=Gv;const d0=GL.CLOCKWISE,_R=GL.COUNTER_CLOCKWISE,Nc={isClosed:!0};function dY(t){if(t=t&&t.positions||t,!Array.isArray(t)&&!ArrayBuffer.isView(t))throw new Error("invalid polygon")}function Jm(t){return"positions"in t?t.positions:t}function k0(t){return"holeIndices"in t?t.holeIndices:null}function fY(t){return Array.isArray(t[0])}function pY(t){return t.length>=1&&t[0].length>=2&&Number.isFinite(t[0][0])}function mY(t){const e=t[0],i=t[t.length-1];return e[0]===i[0]&&e[1]===i[1]&&e[2]===i[2]}function _Y(t,e,i,s){for(let c=0;c<e;c++)if(t[i+c]!==t[s-e+c])return!1;return!0}function gR(t,e,i,s,c){let h=e;const p=i.length;for(let v=0;v<p;v++)for(let l=0;l<s;l++)t[h++]=i[v][l]||0;if(!mY(i))for(let v=0;v<s;v++)t[h++]=i[0][v]||0;return Nc.start=e,Nc.end=h,Nc.size=s,XL(t,c,Nc),h}function yR(t,e,i,s,c=0,h,p){h=h||i.length;const v=h-c;if(v<=0)return e;let l=e;for(let A=0;A<v;A++)t[l++]=i[c+A];if(!_Y(i,s,c,h))for(let A=0;A<s;A++)t[l++]=i[c+A];return Nc.start=e,Nc.end=l,Nc.size=s,XL(t,p,Nc),l}function gY(t,e){dY(t);const i=[],s=[];if("positions"in t){const{positions:c,holeIndices:h}=t;if(h){let p=0;for(let v=0;v<=h.length;v++)p=yR(i,p,c,e,h[v-1],h[v],v===0?d0:_R),s.push(p);return s.pop(),{positions:i,holeIndices:s}}t=c}if(!fY(t))return yR(i,0,t,e,0,i.length,d0),i;if(!pY(t)){let c=0;for(const[h,p]of t.entries())c=gR(i,c,p,e,h===0?d0:_R),s.push(c);return s.pop(),{positions:i,holeIndices:s}}return gR(i,0,t,e,d0),i}function ew(t,e,i){const s=t.length/3;let c=0;for(let h=0;h<s;h++){const p=(h+1)%s;c+=t[h*3+e]*t[p*3+i],c-=t[p*3+e]*t[h*3+i]}return Math.abs(c/2)}function vR(t,e,i,s){const c=t.length/3;for(let h=0;h<c;h++){const p=h*3,v=t[p+0],l=t[p+1],A=t[p+2];t[p+e]=v,t[p+i]=l,t[p+s]=A}}function yY(t,e,i,s){let c=k0(t);c&&(c=c.map(v=>v/e));let h=Jm(t);const p=s&&e===3;if(i){const v=h.length;h=h.slice();const l=[];for(let A=0;A<v;A+=e){l[0]=h[A],l[1]=h[A+1],p&&(l[2]=h[A+2]);const P=i(l);h[A]=P[0],h[A+1]=P[1],p&&(h[A+2]=P[2])}}if(p){const v=ew(h,0,1),l=ew(h,0,2),A=ew(h,1,2);if(!v&&!l&&!A)return[];v>l&&v>A||(l>A?(i||(h=h.slice()),vR(h,0,2,1)):(i||(h=h.slice()),vR(h,2,0,1)))}return kU(h,c,e)}class vY extends HL{constructor(e){const{fp64:i,IndexType:s=Uint32Array}=e;super({...e,attributes:{positions:{size:3,type:i?Float64Array:Float32Array},vertexValid:{type:Uint16Array,size:1},indices:{type:s,size:1}}})}get(e){const{attributes:i}=this;return e==="indices"?i.indices&&i.indices.subarray(0,this.vertexCount):i[e]}updateGeometry(e){super.updateGeometry(e);const i=this.buffers.indices;if(i)this.vertexCount=(i.value||i).length;else if(this.data&&!this.getGeometry)throw new Error("missing indices buffer")}normalizeGeometry(e){if(this.normalize){const i=gY(e,this.positionSize);return this.opts.resolution?YL(Jm(i),k0(i),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?iY(Jm(i),k0(i),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):i}return e}getGeometrySize(e){if(xR(e)){let i=0;for(const s of e)i+=this.getGeometrySize(s);return i}return Jm(e).length/this.positionSize}getGeometryFromBuffer(e){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(e):null}updateGeometryAttributes(e,i){if(e&&xR(e))for(const s of e){const c=this.getGeometrySize(s);i.geometrySize=c,this.updateGeometryAttributes(s,i),i.vertexStart+=c,i.indexStart=this.indexStarts[i.geometryIndex+1]}else{const s=e;this._updateIndices(s,i),this._updatePositions(s,i),this._updateVertexValid(s,i)}}_updateIndices(e,{geometryIndex:i,vertexStart:s,indexStart:c}){const{attributes:h,indexStarts:p,typedArrayManager:v}=this;let l=h.indices;if(!l||!e)return;let A=c;const P=yY(e,this.positionSize,this.opts.preproject,this.opts.full3d);l=v.allocate(l,c+P.length,{copy:!0});for(let O=0;O<P.length;O++)l[A++]=P[O]+s;p[i+1]=c+P.length,h.indices=l}_updatePositions(e,{vertexStart:i,geometrySize:s}){const{attributes:{positions:c},positionSize:h}=this;if(!c||!e)return;const p=Jm(e);for(let v=i,l=0;l<s;v++,l++){const A=p[l*h],P=p[l*h+1],O=h>2?p[l*h+2]:0;c[v*3]=A,c[v*3+1]=P,c[v*3+2]=O}}_updateVertexValid(e,{vertexStart:i,geometrySize:s}){const{positionSize:c}=this,h=this.attributes.vertexValid,p=e&&k0(e);if(e&&e.edgeTypes?h.set(e.edgeTypes,i):h.fill(1,i,i+s),p)for(let v=0;v<p.length;v++)h[i+p[v]/c-1]=0;h[i+s-1]=0}}function xR(t){return Array.isArray(t)&&t.length>0&&!Number.isFinite(t[0])}const tN=`uniform bool extruded;
uniform bool isWireframe;
uniform float elevationScale;
uniform float opacity;
out vec4 vColor;
struct PolygonProps {
vec4 fillColors;
vec4 lineColors;
vec3 positions;
vec3 positions64Low;
vec3 pickingColors;
vec3 normal;
float elevations;
};
vec3 project_offset_normal(vec3 vector) {
if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {
return normalize(vector * project_uCommonUnitsPerWorldUnit);
}
return project_normal(vector);
}
void calculatePosition(PolygonProps props) {
vec3 pos = props.positions;
vec3 pos64Low = props.positions64Low;
vec3 normal = props.normal;
vec4 colors = isWireframe ? props.lineColors : props.fillColors;
geometry.worldPosition = props.positions;
geometry.pickingColor = props.pickingColors;
if (extruded) {
pos.z += props.elevations * elevationScale;
}
gl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
if (extruded) {
#ifdef IS_SIDE_VERTEX
normal = project_offset_normal(normal);
#else
normal = project_normal(normal);
#endif
geometry.normal = normal;
vec3 lightColor = lighting_getLightColor(colors.rgb, project_uCameraPosition, geometry.position.xyz, geometry.normal);
vColor = vec4(lightColor, colors.a * opacity);
} else {
vColor = vec4(colors.rgb, colors.a * opacity);
}
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,xY=`#version 300 es
#define SHADER_NAME solid-polygon-layer-vertex-shader
in vec3 vertexPositions;
in vec3 vertexPositions64Low;
in float elevations;
in vec4 fillColors;
in vec4 lineColors;
in vec3 pickingColors;
${tN}
void main(void) {
PolygonProps props;
props.positions = vertexPositions;
props.positions64Low = vertexPositions64Low;
props.elevations = elevations;
props.fillColors = fillColors;
props.lineColors = lineColors;
props.pickingColors = pickingColors;
props.normal = vec3(0.0, 0.0, 1.0);
calculatePosition(props);
}
`,bY=`#version 300 es
#define SHADER_NAME solid-polygon-layer-vertex-shader-side
#define IS_SIDE_VERTEX
in vec2 positions;
in vec3 instancePositions;
in vec3 instanceNextPositions;
in vec3 instancePositions64Low;
in vec3 instanceNextPositions64Low;
in float instanceElevations;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
in float instanceVertexValid;
${tN}
void main(void) {
if(instanceVertexValid < 0.5){
gl_Position = vec4(0.);
return;
}
PolygonProps props;
vec3 pos;
vec3 pos64Low;
vec3 nextPos;
vec3 nextPos64Low;
#if RING_WINDING_ORDER_CW == 1
pos = instancePositions;
pos64Low = instancePositions64Low;
nextPos = instanceNextPositions;
nextPos64Low = instanceNextPositions64Low;
#else
pos = instanceNextPositions;
pos64Low = instanceNextPositions64Low;
nextPos = instancePositions;
nextPos64Low = instancePositions64Low;
#endif
props.positions = mix(pos, nextPos, positions.x);
props.positions64Low = mix(pos64Low, nextPos64Low, positions.x);
props.normal = vec3(
pos.y - nextPos.y + (pos64Low.y - nextPos64Low.y),
nextPos.x - pos.x + (nextPos64Low.x - pos64Low.x),
0.0);
props.elevations = instanceElevations * positions.y;
props.fillColors = instanceFillColors;
props.lineColors = instanceLineColors;
props.pickingColors = instancePickingColors;
calculatePosition(props);
}
`,wY=`#version 300 es
#define SHADER_NAME solid-polygon-layer-fragment-shader
precision highp float;
in vec4 vColor;
out vec4 fragColor;
void main(void) {
fragColor = vColor;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,mv=[0,0,0,255],TY={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",_full3d:!1,elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:t=>t.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:mv},getLineColor:{type:"accessor",value:mv},material:!0},f0={enter:(t,e)=>e.length?e.subarray(e.length-t.length):t},Xv=class Xv extends Fl{getShaders(e){return super.getShaders({vs:e==="top"?xY:bY,fs:wY,defines:{RING_WINDING_ORDER_CW:!this.props._normalize&&this.props._windingOrder==="CCW"?0:1},modules:[If,s$,Rf]})}get wrapLongitude(){return!1}getBounds(){var e;return(e=this.getAttributeManager())==null?void 0:e.getBounds(["vertexPositions"])}initializeState(){const{viewport:e}=this.context;let{coordinateSystem:i}=this.props;const{_full3d:s}=this.props;e.isGeospatial&&i===qr.DEFAULT&&(i=qr.LNGLAT);let c;i===qr.LNGLAT&&(s?c=e.projectPosition.bind(e):c=e.projectFlat.bind(e)),this.setState({numInstances:0,polygonTesselator:new vY({preproject:c,fp64:this.use64bitPositions(),IndexType:Uint32Array})});const h=this.getAttributeManager(),p=!0;h.remove(["instancePickingColors"]),h.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:p},vertexPositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:f0,accessor:"getPolygon",update:this.calculatePositions,noAlloc:p,shaderAttributes:{instancePositions:{vertexOffset:0,divisor:1},instanceNextPositions:{vertexOffset:1,divisor:1}}},instanceVertexValid:{size:1,type:"uint16",divisor:1,update:this.calculateVertexValid,noAlloc:p},elevations:{size:1,transition:f0,accessor:"getElevation",shaderAttributes:{instanceElevations:{divisor:1}}},fillColors:{size:this.props.colorFormat.length,type:"unorm8",transition:f0,accessor:"getFillColor",defaultValue:mv,shaderAttributes:{instanceFillColors:{divisor:1}}},lineColors:{size:this.props.colorFormat.length,type:"unorm8",transition:f0,accessor:"getLineColor",defaultValue:mv,shaderAttributes:{instanceLineColors:{divisor:1}}},pickingColors:{size:4,type:"uint8",accessor:(v,{index:l,target:A})=>this.encodePickingColor(v&&v.__source?v.__source.index:l,A),shaderAttributes:{instancePickingColors:{divisor:1}}}})}getPickingInfo(e){const i=super.getPickingInfo(e),{index:s}=i,c=this.props.data;return c[0]&&c[0].__source&&(i.object=c.find(h=>h.__source.index===s)),i}disablePickingIndex(e){const i=this.props.data;if(i[0]&&i[0].__source)for(let s=0;s<i.length;s++)i[s].__source.index===e&&this._disablePickingIndex(s);else super.disablePickingIndex(e)}draw({uniforms:e}){const{extruded:i,filled:s,wireframe:c,elevationScale:h}=this.props,{topModel:p,sideModel:v,wireframeModel:l,polygonTesselator:A}=this.state,P={...e,extruded:!!i,elevationScale:h};l&&c&&(l.setInstanceCount(A.instanceCount-1),l.setUniforms(P),l.draw(this.context.renderPass)),v&&s&&(v.setInstanceCount(A.instanceCount-1),v.setUniforms(P),v.draw(this.context.renderPass)),p&&s&&(p.setVertexCount(A.vertexCount),p.setUniforms(P),p.draw(this.context.renderPass))}updateState(e){var v;super.updateState(e),this.updateGeometry(e);const{props:i,oldProps:s,changeFlags:c}=e,h=this.getAttributeManager();(c.extensionsChanged||i.filled!==s.filled||i.extruded!==s.extruded)&&((v=this.state.models)==null||v.forEach(l=>l.destroy()),this.setState(this._getModels()),h.invalidateAll())}updateGeometry({props:e,oldProps:i,changeFlags:s}){if(s.dataChanged||s.updateTriggersChanged&&(s.updateTriggersChanged.all||s.updateTriggersChanged.getPolygon)){const{polygonTesselator:h}=this.state,p=e.data.attributes||{};h.updateGeometry({data:e.data,normalize:e._normalize,geometryBuffer:p.getPolygon,buffers:p,getGeometry:e.getPolygon,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:s.dataChanged,full3d:e._full3d}),this.setState({numInstances:h.instanceCount,startIndices:h.vertexStarts}),s.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(){const{id:e,filled:i,extruded:s}=this.props;let c,h,p;const v=this.getAttributeManager().getBufferLayouts();if(i){const l=this.getShaders("top");l.defines.NON_INSTANCED_MODEL=1,c=new Yo(this.context.device,{...l,id:`${e}-top`,topology:"triangle-list",uniforms:{isWireframe:!1},bufferLayout:v,isIndexed:!0,userData:{excludeAttributes:{instanceVertexValid:!0}}})}return s&&(h=new Yo(this.context.device,{...this.getShaders("side"),id:`${e}-side`,bufferLayout:v,uniforms:{isWireframe:!1},geometry:new Sf({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,1,1,0,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}}),p=new Yo(this.context.device,{...this.getShaders("side"),id:`${e}-wireframe`,bufferLayout:v,uniforms:{isWireframe:!0},geometry:new Sf({topology:"line-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}})),{models:[h,p,c].filter(Boolean),topModel:c,sideModel:h,wireframeModel:p}}calculateIndices(e){const{polygonTesselator:i}=this.state;e.startIndices=i.indexStarts,e.value=i.get("indices")}calculatePositions(e){const{polygonTesselator:i}=this.state;e.startIndices=i.vertexStarts,e.value=i.get("positions")}calculateVertexValid(e){e.value=this.state.polygonTesselator.get("vertexValid")}};Xv.defaultProps=TY,Xv.layerName="SolidPolygonLayer";let LT=Xv;function EY({data:t,getIndex:e,dataRange:i,replace:s}){const{startRow:c=0,endRow:h=1/0}=i,p=t.length;let v=p,l=p;for(let L=0;L<p;L++){const U=e(t[L]);if(v>L&&U>=c&&(v=L),U>=h){l=L;break}}let A=v;const O=l-v!==s.length?t.slice(l):void 0;for(let L=0;L<s.length;L++)t[A++]=s[L];if(O){for(let L=0;L<O.length;L++)t[A++]=O[L];t.length=A}return{startRow:v,endRow:v+s.length}}function SY(t,e){if(!t)return null;const i="startIndices"in t?t.startIndices[e]:e,s=t.featureIds.value[i];return i!==-1?AY(t,s,i):null}function AY(t,e,i){const s={properties:{...t.properties[e]}};for(const c in t.numericProps)s.properties[c]=t.numericProps[c].value[i];return s}function MY(t,e){const i={points:null,lines:null,polygons:null};for(const s in i){const c=t[s].globalFeatureIds.value;i[s]=new Uint8ClampedArray(c.length*3);const h=[];for(let p=0;p<c.length;p++)e(c[p],h),i[s][p*3+0]=h[0],i[s][p*3+1]=h[1],i[s][p*3+2]=h[2]}return i}const CY=`#version 300 es
#define SHADER_NAME multi-icon-layer-fragment-shader
precision highp float;
uniform float opacity;
uniform sampler2D iconsTexture;
uniform float gamma;
uniform bool sdf;
uniform float alphaCutoff;
uniform float sdfBuffer;
uniform float outlineBuffer;
uniform vec4 outlineColor;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
if (!bool(picking.isActive)) {
float alpha = texture(iconsTexture, vTextureCoords).a;
vec4 color = vColor;
if (sdf) {
float distance = alpha;
alpha = smoothstep(sdfBuffer - gamma, sdfBuffer + gamma, distance);
if (outlineBuffer > 0.0) {
float inFill = alpha;
float inBorder = smoothstep(outlineBuffer - gamma, outlineBuffer + gamma, distance);
color = mix(outlineColor, vColor, inFill);
alpha = inBorder;
}
}
float a = alpha * color.a;
if (a < alphaCutoff) {
discard;
}
fragColor = vec4(color.rgb, a * opacity);
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,tw=192/256,bR=[],PY={getIconOffsets:{type:"accessor",value:t=>t.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}},Zv=class Zv extends Af{getShaders(){return{...super.getShaders(),fs:CY}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:"uint8",size:3,accessor:(i,{index:s,target:c})=>this.encodePickingColor(s,c)}})}updateState(e){super.updateState(e);const{props:i,oldProps:s}=e;let{outlineColor:c}=i;c!==s.outlineColor&&(c=c.map(h=>h/255),c[3]=Number.isFinite(c[3])?c[3]:1,this.setState({outlineColor:c})),!i.sdf&&i.outlineWidth&&jr.warn(`${this.id}: fontSettings.sdf is required to render outline`)()}draw(e){const{sdf:i,smoothing:s,outlineWidth:c}=this.props,{outlineColor:h}=this.state,p=c?Math.max(s,tw*(1-c)):-1;if(e.uniforms={...e.uniforms,sdfBuffer:tw,outlineBuffer:p,gamma:s,sdf:!!i,outlineColor:h},super.draw(e),i&&c){const{iconManager:v}=this.state,l=v.getTexture(),A=this.state.model;l&&(A.setUniforms({outlineBuffer:tw}),A.draw(this.context.renderPass))}}getInstanceOffset(e){return e?Array.from(e).flatMap(i=>super.getInstanceOffset(i)):bR}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap(i=>super.getInstanceIconFrame(i)):bR}};Zv.defaultProps=PY,Zv.layerName="MultiIconLayer";let NT=Zv;const c_=1e20;class IY{constructor({fontSize:e=24,buffer:i=3,radius:s=8,cutoff:c=.25,fontFamily:h="sans-serif",fontWeight:p="normal",fontStyle:v="normal"}={}){this.buffer=i,this.cutoff=c,this.radius=s;const l=this.size=e+i*4,A=this._createCanvas(l),P=this.ctx=A.getContext("2d",{willReadFrequently:!0});P.font=`${v} ${p} ${e}px ${h}`,P.textBaseline="alphabetic",P.textAlign="left",P.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l)}_createCanvas(e){const i=document.createElement("canvas");return i.width=i.height=e,i}draw(e){const{width:i,actualBoundingBoxAscent:s,actualBoundingBoxDescent:c,actualBoundingBoxLeft:h,actualBoundingBoxRight:p}=this.ctx.measureText(e),v=Math.ceil(s),l=0,A=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(p-h))),P=Math.min(this.size-this.buffer,v+Math.ceil(c)),O=A+2*this.buffer,L=P+2*this.buffer,U=Math.max(O*L,0),H=new Uint8ClampedArray(U),Y={data:H,width:O,height:L,glyphWidth:A,glyphHeight:P,glyphTop:v,glyphLeft:l,glyphAdvance:i};if(A===0||P===0)return Y;const{ctx:J,buffer:oe,gridInner:me,gridOuter:pe}=this;J.clearRect(oe,oe,A,P),J.fillText(e,oe,oe+v);const be=J.getImageData(oe,oe,A,P);pe.fill(c_,0,U),me.fill(0,0,U);for(let Oe=0;Oe<P;Oe++)for(let je=0;je<A;je++){const st=be.data[4*(Oe*A+je)+3]/255;if(st===0)continue;const ut=(Oe+oe)*O+je+oe;if(st===1)pe[ut]=0,me[ut]=c_;else{const xe=.5-st;pe[ut]=xe>0?xe*xe:0,me[ut]=xe<0?xe*xe:0}}wR(pe,0,0,O,L,O,this.f,this.v,this.z),wR(me,oe,oe,A,P,O,this.f,this.v,this.z);for(let Oe=0;Oe<U;Oe++){const je=Math.sqrt(pe[Oe])-Math.sqrt(me[Oe]);H[Oe]=Math.round(255-255*(je/this.radius+this.cutoff))}return Y}}function wR(t,e,i,s,c,h,p,v,l){for(let A=e;A<e+s;A++)TR(t,i*h+A,h,c,p,v,l);for(let A=i;A<i+c;A++)TR(t,A*h+e,1,s,p,v,l)}function TR(t,e,i,s,c,h,p){h[0]=0,p[0]=-c_,p[1]=c_,c[0]=t[e];for(let v=1,l=0,A=0;v<s;v++){c[v]=t[e+v*i];const P=v*v;do{const O=h[l];A=(c[v]-c[O]+P-O*O)/(v-O)/2}while(A<=p[l]&&--l>-1);l++,h[l]=v,p[l]=A,p[l+1]=c_}for(let v=0,l=0;v<s;v++){for(;p[l+1]<v;)l++;const A=h[l],P=v-A;t[e+v*i]=c[A]+P*P}}const RY=32,OY=[];function kY(t){return Math.pow(2,Math.ceil(Math.log2(t)))}function DY({characterSet:t,getFontWidth:e,fontHeight:i,buffer:s,maxCanvasWidth:c,mapping:h={},xOffset:p=0,yOffset:v=0}){let l=0,A=p;const P=i+s*2;for(const O of t)if(!h[O]){const L=e(O);A+L+s*2>c&&(A=0,l++),h[O]={x:A+s,y:v+l*P+s,width:L,height:P,layoutWidth:L,layoutHeight:i},A+=L+s*2}return{mapping:h,xOffset:A,yOffset:v+l*P,canvasHeight:kY(v+(l+1)*P)}}function iN(t,e,i,s){var h;let c=0;for(let p=e;p<i;p++){const v=t[p];c+=((h=s[v])==null?void 0:h.layoutWidth)||0}return c}function rN(t,e,i,s,c,h){let p=e,v=0;for(let l=e;l<i;l++){const A=iN(t,l,l+1,c);v+A>s&&(p<l&&h.push(l),p=l,v=0),v+=A}return v}function LY(t,e,i,s,c,h){let p=e,v=e,l=e,A=0;for(let P=e;P<i;P++)if((t[P]===" "||t[P+1]===" "||P+1===i)&&(l=P+1),l>v){let O=iN(t,v,l,c);A+O>s&&(p<v&&(h.push(v),p=v,A=0),O>s&&(O=rN(t,v,l,s,c,h),p=h[h.length-1])),v=l,A+=O}return A}function NY(t,e,i,s,c=0,h){h===void 0&&(h=t.length);const p=[];return e==="break-all"?rN(t,c,h,i,s,p):LY(t,c,h,i,s,p),p}function FY(t,e,i,s,c,h){let p=0,v=0;for(let l=e;l<i;l++){const A=t[l],P=s[A];P?(v||(v=P.layoutHeight),c[l]=p+P.layoutWidth/2,p+=P.layoutWidth):(jr.warn(`Missing character: ${A} (${A.codePointAt(0)})`)(),c[l]=p,p+=RY)}h[0]=p,h[1]=v}function BY(t,e,i,s,c){var J;const h=Array.from(t),p=h.length,v=new Array(p),l=new Array(p),A=new Array(p),P=(i==="break-word"||i==="break-all")&&isFinite(s)&&s>0,O=[0,0],L=[0,0];let U=0,H=0,Y=0;for(let oe=0;oe<=p;oe++){const me=h[oe];if((me===`
`||oe===p)&&(Y=oe),Y>H){const pe=P?NY(h,i,s,c,H,Y):OY;for(let be=0;be<=pe.length;be++){const Oe=be===0?H:pe[be-1],je=be<pe.length?pe[be]:Y;FY(h,Oe,je,c,v,L);for(let st=Oe;st<je;st++){const ut=h[st],xe=((J=c[ut])==null?void 0:J.layoutOffsetY)||0;l[st]=U+L[1]/2+xe,A[st]=L[0]}U=U+L[1]*e,O[0]=Math.max(O[0],L[0])}H=Y}me===`
`&&(v[H]=0,l[H]=0,A[H]=0,H++)}return O[1]=U,{x:v,y:l,rowWidth:A,size:O}}function zY({value:t,length:e,stride:i,offset:s,startIndices:c,characterSet:h}){const p=t.BYTES_PER_ELEMENT,v=i?i/p:1,l=s?s/p:0,A=c[e]||Math.ceil((t.length-l)/v),P=h&&new Set,O=new Array(e);let L=t;if(v>1||l>0){const U=t.constructor;L=new U(A);for(let H=0;H<A;H++)L[H]=t[H*v+l]}for(let U=0;U<e;U++){const H=c[U],Y=c[U+1]||A,J=L.subarray(H,Y);O[U]=String.fromCodePoint.apply(null,J),P&&J.forEach(P.add,P)}if(P)for(const U of P)h.add(String.fromCodePoint(U));return{texts:O,characterCount:A}}class nN{constructor(e=5){this._cache={},this._order=[],this.limit=e}get(e){const i=this._cache[e];return i&&(this._deleteOrder(e),this._appendOrder(e)),i}set(e,i){this._cache[e]?(this.delete(e),this._cache[e]=i,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=i,this._appendOrder(e))}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){const i=this._order.indexOf(e);i>=0&&this._order.splice(i,1)}_appendOrder(e){this._order.push(e)}}function UY(){const t=[];for(let e=32;e<128;e++)t.push(String.fromCharCode(e));return t}const lf={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:UY(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},ER=1024,SR=.9,AR=1.2,sN=3;let _v=new nN(sN);function VY(t,e){let i;typeof e=="string"?i=new Set(Array.from(e)):i=new Set(e);const s=_v.get(t);if(!s)return i;for(const c in s.mapping)i.has(c)&&i.delete(c);return i}function jY(t,e){for(let i=0;i<t.length;i++)e.data[4*i+3]=t[i]}function MR(t,e,i,s){t.font=`${s} ${i}px ${e}`,t.fillStyle="#000",t.textBaseline="alphabetic",t.textAlign="left"}function $Y(t){jr.assert(Number.isFinite(t)&&t>=sN,"Invalid cache limit"),_v=new nN(t)}class WY{constructor(){this.props={...lf}}get atlas(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){const{fontSize:e,buffer:i}=this.props;return(e*AR+i*2)/e}setProps(e={}){Object.assign(this.props,e),this._key=this._getKey();const i=VY(this._key,this.props.characterSet),s=_v.get(this._key);if(s&&i.size===0){this._atlas!==s&&(this._atlas=s);return}const c=this._generateFontAtlas(i,s);this._atlas=c,_v.set(this._key,c)}_generateFontAtlas(e,i){const{fontFamily:s,fontWeight:c,fontSize:h,buffer:p,sdf:v,radius:l,cutoff:A}=this.props;let P=i&&i.data;P||(P=document.createElement("canvas"),P.width=ER);const O=P.getContext("2d",{willReadFrequently:!0});MR(O,s,h,c);const{mapping:L,canvasHeight:U,xOffset:H,yOffset:Y}=DY({getFontWidth:J=>O.measureText(J).width,fontHeight:h*AR,buffer:p,characterSet:e,maxCanvasWidth:ER,...i&&{mapping:i.mapping,xOffset:i.xOffset,yOffset:i.yOffset}});if(P.height!==U){const J=O.getImageData(0,0,P.width,P.height);P.height=U,O.putImageData(J,0,0)}if(MR(O,s,h,c),v){const J=new IY({fontSize:h,buffer:p,radius:l,cutoff:A,fontFamily:s,fontWeight:`${c}`});for(const oe of e){const{data:me,width:pe,height:be,glyphTop:Oe}=J.draw(oe);L[oe].width=pe,L[oe].layoutOffsetY=h*SR-Oe;const je=O.createImageData(pe,be);jY(me,je),O.putImageData(je,L[oe].x,L[oe].y)}}else for(const J of e)O.fillText(J,L[J].x,L[J].y+p+h*SR);return{xOffset:H,yOffset:Y,mapping:L,data:P,width:P.width,height:P.height}}_getKey(){const{fontFamily:e,fontWeight:i,fontSize:s,buffer:c,sdf:h,radius:p,cutoff:v}=this.props;return h?`${e} ${i} ${s} ${c} ${p} ${v}`:`${e} ${i} ${s} ${c}`}}const HY=`#version 300 es
#define SHADER_NAME text-background-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec4 instanceRects;
in float instanceSizes;
in float instanceAngles;
in vec2 instancePixelOffsets;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
uniform bool billboard;
uniform float opacity;
uniform float sizeScale;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform vec4 padding;
uniform int sizeUnits;
out vec4 vFillColor;
out vec4 vLineColor;
out float vLineWidth;
out vec2 uv;
out vec2 dimensions;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = radians(angle);
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vLineWidth = instanceLineWidths;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * sizeScale, sizeUnits),
sizeMinPixels, sizeMaxPixels
);
dimensions = instanceRects.zw * sizePixels + padding.xy + padding.zw;
vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-padding.xy, padding.zw, positions);
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
pixelOffset += instancePixelOffsets;
pixelOffset.y *= -1.0;
if (billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,qY=`#version 300 es
#define SHADER_NAME text-background-layer-fragment-shader
precision highp float;
uniform bool stroked;
in vec4 vFillColor;
in vec4 vLineColor;
in float vLineWidth;
in vec2 uv;
in vec2 dimensions;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
vec2 pixelPosition = uv * dimensions;
if (stroked) {
float distToEdge = min(
min(pixelPosition.x, dimensions.x - pixelPosition.x),
min(pixelPosition.y, dimensions.y - pixelPosition.y)
);
float isBorder = smoothedge(distToEdge, vLineWidth);
fragColor = mix(vFillColor, vLineColor, isBorder);
} else {
fragColor = vFillColor;
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,GY={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:t=>t.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}},Yv=class Yv extends Fl{getShaders(){return super.getShaders({vs:HY,fs:qY,modules:[If,Rf]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){var s;super.updateState(e);const{changeFlags:i}=e;i.extensionsChanged&&((s=this.state.model)==null||s.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{billboard:i,sizeScale:s,sizeUnits:c,sizeMinPixels:h,sizeMaxPixels:p,getLineWidth:v}=this.props;let{padding:l}=this.props;l.length<4&&(l=[l[0],l[1],l[0],l[1]]);const A=this.state.model;A.setUniforms(e),A.setUniforms({billboard:i,stroked:!!v,padding:l,sizeUnits:Eh[c],sizeScale:s,sizeMinPixels:h,sizeMaxPixels:p}),A.draw(this.context.renderPass)}_getModel(){const e=[0,0,1,0,1,1,0,1];return new Yo(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Sf({topology:"triangle-fan-webgl",vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(e)}}}),isInstanced:!0})}};Yv.defaultProps=GY,Yv.layerName="TextBackgroundLayer";let FT=Yv;const CR={start:1,middle:0,end:-1},PR={top:1,center:0,bottom:-1},iw=[0,0,0,255],XY=1,ZY={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:iw},getBorderWidth:{type:"accessor",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:lf.characterSet},fontFamily:lf.fontFamily,fontWeight:lf.fontWeight,lineHeight:XY,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:iw},fontSettings:{type:"object",value:{},compare:1},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:t=>t.text},getPosition:{type:"accessor",value:t=>t.position},getColor:{type:"accessor",value:iw},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}},Kv=class Kv extends I_{constructor(){super(...arguments),this.getBoundingRect=(e,i)=>{let{size:[s,c]}=this.transformParagraph(e,i);const{fontSize:h}=this.state.fontAtlasManager.props;s/=h,c/=h;const{getTextAnchor:p,getAlignmentBaseline:v}=this.props,l=CR[typeof p=="function"?p(e,i):p],A=PR[typeof v=="function"?v(e,i):v];return[(l-1)*s/2,(A-1)*c/2,s,c]},this.getIconOffsets=(e,i)=>{const{getTextAnchor:s,getAlignmentBaseline:c}=this.props,{x:h,y:p,rowWidth:v,size:[l,A]}=this.transformParagraph(e,i),P=CR[typeof s=="function"?s(e,i):s],O=PR[typeof c=="function"?c(e,i):c],L=h.length,U=new Array(L*2);let H=0;for(let Y=0;Y<L;Y++){const J=(1-P)*(l-v[Y])/2;U[H++]=(P-1)*l/2+J+h[Y],U[H++]=(O-1)*A/2+p[Y]}return U}}initializeState(){this.state={styleVersion:0,fontAtlasManager:new WY},this.props.maxWidth>0&&jr.warn("v8.9 breaking change: TextLayer maxWidth is now relative to text size")()}updateState(e){const{props:i,oldProps:s,changeFlags:c}=e;(c.dataChanged||c.updateTriggersChanged&&(c.updateTriggersChanged.all||c.updateTriggersChanged.getText))&&this._updateText(),(this._updateFontAtlas()||i.lineHeight!==s.lineHeight||i.wordBreak!==s.wordBreak||i.maxWidth!==s.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){const{fontSettings:e,fontFamily:i,fontWeight:s}=this.props,{fontAtlasManager:c,characterSet:h}=this.state,p={...e,characterSet:h,fontFamily:i,fontWeight:s};if(!c.mapping)return c.setProps(p),!0;for(const v in p)if(p[v]!==c.props[v])return c.setProps(p),!0;return!1}_updateText(){var l;const{data:e,characterSet:i}=this.props,s=(l=e.attributes)==null?void 0:l.getText;let{getText:c}=this.props,h=e.startIndices,p;const v=i==="auto"&&new Set;if(s&&h){const{texts:A,characterCount:P}=zY({...ArrayBuffer.isView(s)?{value:s}:s,length:e.length,startIndices:h,characterSet:v});p=P,c=(O,{index:L})=>A[L]}else{const{iterable:A,objectInfo:P}=_1(e);h=[0],p=0;for(const O of A){P.index++;const L=Array.from(c(O,P)||"");v&&L.forEach(v.add,v),p+=L.length,h.push(p)}}this.setState({getText:c,startIndices:h,numInstances:p,characterSet:v||i})}transformParagraph(e,i){const{fontAtlasManager:s}=this.state,c=s.mapping,h=this.state.getText,{wordBreak:p,lineHeight:v,maxWidth:l}=this.props,A=h(e,i)||"";return BY(A,v,p,l*s.props.fontSize,c)}renderLayers(){const{startIndices:e,numInstances:i,getText:s,fontAtlasManager:{scale:c,atlas:h,mapping:p},styleVersion:v}=this.state,{data:l,_dataDiff:A,getPosition:P,getColor:O,getSize:L,getAngle:U,getPixelOffset:H,getBackgroundColor:Y,getBorderColor:J,getBorderWidth:oe,backgroundPadding:me,background:pe,billboard:be,fontSettings:Oe,outlineWidth:je,outlineColor:st,sizeScale:ut,sizeUnits:xe,sizeMinPixels:it,sizeMaxPixels:Be,transitions:Qe,updateTriggers:Ct}=this.props,Kt=this.getSubLayerClass("characters",NT),Ie=this.getSubLayerClass("background",FT);return[pe&&new Ie({getFillColor:Y,getLineColor:J,getLineWidth:oe,padding:me,getPosition:P,getSize:L,getAngle:U,getPixelOffset:H,billboard:be,sizeScale:ut,sizeUnits:xe,sizeMinPixels:it,sizeMaxPixels:Be,transitions:Qe&&{getPosition:Qe.getPosition,getAngle:Qe.getAngle,getSize:Qe.getSize,getFillColor:Qe.getBackgroundColor,getLineColor:Qe.getBorderColor,getLineWidth:Qe.getBorderWidth,getPixelOffset:Qe.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:Ct.getPosition,getAngle:Ct.getAngle,getSize:Ct.getSize,getFillColor:Ct.getBackgroundColor,getLineColor:Ct.getBorderColor,getLineWidth:Ct.getBorderWidth,getPixelOffset:Ct.getPixelOffset,getBoundingRect:{getText:Ct.getText,getTextAnchor:Ct.getTextAnchor,getAlignmentBaseline:Ct.getAlignmentBaseline,styleVersion:v}}}),{data:l.attributes&&l.attributes.background?{length:l.length,attributes:l.attributes.background}:l,_dataDiff:A,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new Kt({sdf:Oe.sdf,smoothing:Number.isFinite(Oe.smoothing)?Oe.smoothing:lf.smoothing,outlineWidth:je/(Oe.radius||lf.radius),outlineColor:st,iconAtlas:h,iconMapping:p,getPosition:P,getColor:O,getSize:L,getAngle:U,getPixelOffset:H,billboard:be,sizeScale:ut*c,sizeUnits:xe,sizeMinPixels:it*c,sizeMaxPixels:Be*c,transitions:Qe&&{getPosition:Qe.getPosition,getAngle:Qe.getAngle,getColor:Qe.getColor,getSize:Qe.getSize,getPixelOffset:Qe.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{all:Ct.getText,getPosition:Ct.getPosition,getAngle:Ct.getAngle,getColor:Ct.getColor,getSize:Ct.getSize,getPixelOffset:Ct.getPixelOffset,getIconOffsets:{getTextAnchor:Ct.getTextAnchor,getAlignmentBaseline:Ct.getAlignmentBaseline,styleVersion:v}}}),{data:l,_dataDiff:A,startIndices:e,numInstances:i,getIconOffsets:this.getIconOffsets,getIcon:s})]}static set fontAtlasCacheLimit(e){$Y(e)}};Kv.defaultProps=ZY,Kv.layerName="TextLayer";let gv=Kv;const D0={circle:{type:RT,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:Af,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:gv,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},L0={type:DT,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},BT={type:LT,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",_full3d:"_full3d",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function zm({type:t,props:e}){const i={};for(const s in e)i[s]=t.defaultProps[e[s]];return i}function rw(t,e){const{transitions:i,updateTriggers:s}=t.props,c={updateTriggers:{},transitions:i&&{getPosition:i.geometry}};for(const h in e){const p=e[h];let v=t.props[h];h.startsWith("get")&&(v=t.getSubLayerAccessor(v),c.updateTriggers[p]=s[h],i&&(c.transitions[p]=i[h])),c[p]=v}return c}function YY(t){if(Array.isArray(t))return t;switch(jr.assert(t.type,"GeoJSON does not have type"),t.type){case"Feature":return[t];case"FeatureCollection":return jr.assert(Array.isArray(t.features),"GeoJSON does not have features array"),t.features;default:return[{geometry:t}]}}function IR(t,e,i={}){const s={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:c=0,endRow:h=t.length}=i;for(let p=c;p<h;p++){const v=t[p],{geometry:l}=v;if(l)if(l.type==="GeometryCollection"){jr.assert(Array.isArray(l.geometries),"GeoJSON does not have geometries array");const{geometries:A}=l;for(let P=0;P<A.length;P++){const O=A[P];RR(O,s,e,v,p)}}else RR(l,s,e,v,p)}return s}function RR(t,e,i,s,c){const{type:h,coordinates:p}=t,{pointFeatures:v,lineFeatures:l,polygonFeatures:A,polygonOutlineFeatures:P}=e;if(!JY(h,p)){jr.warn(`${h} coordinates are malformed`)();return}switch(h){case"Point":v.push(i({geometry:t},s,c));break;case"MultiPoint":p.forEach(O=>{v.push(i({geometry:{type:"Point",coordinates:O}},s,c))});break;case"LineString":l.push(i({geometry:t},s,c));break;case"MultiLineString":p.forEach(O=>{l.push(i({geometry:{type:"LineString",coordinates:O}},s,c))});break;case"Polygon":A.push(i({geometry:t},s,c)),p.forEach(O=>{P.push(i({geometry:{type:"LineString",coordinates:O}},s,c))});break;case"MultiPolygon":p.forEach(O=>{A.push(i({geometry:{type:"Polygon",coordinates:O}},s,c)),O.forEach(L=>{P.push(i({geometry:{type:"LineString",coordinates:L}},s,c))})});break}}const KY={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function JY(t,e){let i=KY[t];for(jr.assert(i,`Unknown GeoJSON type ${t}`);e&&--i>0;)e=e[0];return e&&Number.isFinite(e[0])}function oN(){return{points:{},lines:{},polygons:{},polygonsOutline:{}}}function p0(t){return t.geometry.coordinates}function QY(t,e){const i=oN(),{pointFeatures:s,lineFeatures:c,polygonFeatures:h,polygonOutlineFeatures:p}=t;return i.points.data=s,i.points._dataDiff=e.pointFeatures&&(()=>e.pointFeatures),i.points.getPosition=p0,i.lines.data=c,i.lines._dataDiff=e.lineFeatures&&(()=>e.lineFeatures),i.lines.getPath=p0,i.polygons.data=h,i.polygons._dataDiff=e.polygonFeatures&&(()=>e.polygonFeatures),i.polygons.getPolygon=p0,i.polygonsOutline.data=p,i.polygonsOutline._dataDiff=e.polygonOutlineFeatures&&(()=>e.polygonOutlineFeatures),i.polygonsOutline.getPath=p0,i}function eK(t,e){const i=oN(),{points:s,lines:c,polygons:h}=t,p=MY(t,e);return i.points.data={length:s.positions.value.length/s.positions.size,attributes:{...s.attributes,getPosition:s.positions,instancePickingColors:{size:3,value:p.points}},properties:s.properties,numericProps:s.numericProps,featureIds:s.featureIds},i.lines.data={length:c.pathIndices.value.length-1,startIndices:c.pathIndices.value,attributes:{...c.attributes,getPath:c.positions,instancePickingColors:{size:3,value:p.lines}},properties:c.properties,numericProps:c.numericProps,featureIds:c.featureIds},i.lines._pathType="open",i.polygons.data={length:h.polygonIndices.value.length-1,startIndices:h.polygonIndices.value,attributes:{...h.attributes,getPolygon:h.positions,pickingColors:{size:3,value:p.polygons}},properties:h.properties,numericProps:h.numericProps,featureIds:h.featureIds},i.polygons._normalize=!1,h.triangles&&(i.polygons.data.attributes.indices=h.triangles.value),i.polygonsOutline.data={length:h.primitivePolygonIndices.value.length-1,startIndices:h.primitivePolygonIndices.value,attributes:{...h.attributes,getPath:h.positions,instancePickingColors:{size:3,value:p.polygons}},properties:h.properties,numericProps:h.numericProps,featureIds:h.featureIds},i.polygonsOutline._pathType="open",i}const tK=["points","linestrings","polygons"],iK={...zm(D0.circle),...zm(D0.icon),...zm(D0.text),...zm(L0),...zm(BT),stroked:!0,filled:!0,extruded:!1,wireframe:!1,_full3d:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:t=>t.properties.icon},getText:{type:"accessor",value:t=>t.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}},Jv=class Jv extends I_{initializeState(){this.state={layerProps:{},features:{},featuresDiff:{}}}updateState({props:e,changeFlags:i}){if(!i.dataChanged)return;const{data:s}=this.props,c=s&&"points"in s&&"polygons"in s&&"lines"in s;this.setState({binary:c}),c?this._updateStateBinary({props:e,changeFlags:i}):this._updateStateJSON({props:e,changeFlags:i})}_updateStateBinary({props:e,changeFlags:i}){const s=eK(e.data,this.encodePickingColor);this.setState({layerProps:s})}_updateStateJSON({props:e,changeFlags:i}){const s=YY(e.data),c=this.getSubLayerRow.bind(this);let h={};const p={};if(Array.isArray(i.dataChanged)){const l=this.state.features;for(const A in l)h[A]=l[A].slice(),p[A]=[];for(const A of i.dataChanged){const P=IR(s,c,A);for(const O in l)p[O].push(EY({data:h[O],getIndex:L=>L.__source.index,dataRange:A,replace:P[O]}))}}else h=IR(s,c);const v=QY(h,p);this.setState({features:h,featuresDiff:p,layerProps:v})}getPickingInfo(e){const i=super.getPickingInfo(e),{index:s,sourceLayer:c}=i;return i.featureType=tK.find(h=>c.id.startsWith(`${this.id}-${h}-`)),s>=0&&c.id.startsWith(`${this.id}-points-text`)&&this.state.binary&&(i.index=this.props.data.points.globalFeatureIds.value[s]),i}_updateAutoHighlight(e){const i=`${this.id}-points-`,s=e.featureType==="points";for(const c of this.getSubLayers())c.id.startsWith(i)===s&&c.updateAutoHighlight(e)}_renderPolygonLayer(){var p;const{extruded:e,wireframe:i}=this.props,{layerProps:s}=this.state,c="polygons-fill",h=this.shouldRenderSubLayer(c,(p=s.polygons)==null?void 0:p.data)&&this.getSubLayerClass(c,BT.type);if(h){const v=rw(this,BT.props),l=e&&i;return l||delete v.getLineColor,v.updateTriggers.lineColors=l,new h(v,this.getSubLayerProps({id:c,updateTriggers:v.updateTriggers}),s.polygons)}return null}_renderLineLayers(){var l,A;const{extruded:e,stroked:i}=this.props,{layerProps:s}=this.state,c="polygons-stroke",h="linestrings",p=!e&&i&&this.shouldRenderSubLayer(c,(l=s.polygonsOutline)==null?void 0:l.data)&&this.getSubLayerClass(c,L0.type),v=this.shouldRenderSubLayer(h,(A=s.lines)==null?void 0:A.data)&&this.getSubLayerClass(h,L0.type);if(p||v){const P=rw(this,L0.props);return[p&&new p(P,this.getSubLayerProps({id:c,updateTriggers:P.updateTriggers}),s.polygonsOutline),v&&new v(P,this.getSubLayerProps({id:h,updateTriggers:P.updateTriggers}),s.lines)]}return null}_renderPointLayers(){var v;const{pointType:e}=this.props,{layerProps:i,binary:s}=this.state;let{highlightedObjectIndex:c}=this.props;!s&&Number.isFinite(c)&&(c=i.points.data.findIndex(l=>l.__source.index===c));const h=new Set(e.split("+")),p=[];for(const l of h){const A=`points-${l}`,P=D0[l],O=P&&this.shouldRenderSubLayer(A,(v=i.points)==null?void 0:v.data)&&this.getSubLayerClass(A,P.type);if(O){const L=rw(this,P.props);let U=i.points;if(l==="text"&&s){const{instancePickingColors:H,...Y}=U.data.attributes;U={...U,data:{...U.data,attributes:Y}}}p.push(new O(L,this.getSubLayerProps({id:A,updateTriggers:L.updateTriggers,highlightedObjectIndex:c}),U))}}return p}renderLayers(){const{extruded:e}=this.props,i=this._renderPolygonLayer(),s=this._renderLineLayers(),c=this._renderPointLayers();return[!e&&i,s,c,e&&i]}getSubLayerAccessor(e){const{binary:i}=this.state;return!i||typeof e!="function"?super.getSubLayerAccessor(e):(s,c)=>{const{data:h,index:p}=c,v=SY(h,p);return e(v,c)}}};Jv.layerName="GeoJsonLayer",Jv.defaultProps=iK;let zT=Jv;class rK{constructor(e){this.index=e,this.isVisible=!1,this.isSelected=!1,this.parent=null,this.children=[],this.content=null,this._loader=void 0,this._abortController=null,this._loaderId=0,this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1}get bbox(){return this._bbox}set bbox(e){this._bbox||(this._bbox=e,"west"in e?this.boundingBox=[[e.west,e.south],[e.east,e.north]]:this.boundingBox=[[e.left,e.top],[e.right,e.bottom]])}get data(){return this.isLoading&&this._loader?this._loader.then(()=>this.data):this.content}get isLoaded(){return this._isLoaded&&!this._needsReload}get isLoading(){return!!this._loader&&!this._isCancelled}get needsReload(){return this._needsReload||this._isCancelled}get byteLength(){const e=this.content?this.content.byteLength:0;return Number.isFinite(e)||console.error("byteLength not defined in tile data"),e}async _loadData({getData:e,requestScheduler:i,onLoad:s,onError:c}){const{index:h,id:p,bbox:v,userData:l,zoom:A}=this,P=this._loaderId;this._abortController=new AbortController;const{signal:O}=this._abortController,L=await i.scheduleRequest(this,Y=>Y.isSelected?1:-1);if(!L){this._isCancelled=!0;return}if(this._isCancelled){L.done();return}let U=null,H;try{U=await e({index:h,id:p,bbox:v,userData:l,zoom:A,signal:O})}catch(Y){H=Y||!0}finally{L.done()}if(P===this._loaderId){if(this._loader=void 0,this.content=U,this._isCancelled&&!U){this._isLoaded=!1;return}this._isLoaded=!0,this._isCancelled=!1,H?c(H,this):s(this)}}loadData(e){return this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1,this._loaderId++,this._loader=this._loadData(e),this._loader}setNeedsReload(){this.isLoading&&(this.abort(),this._loader=void 0),this._needsReload=!0}abort(){var e;this.isLoaded||(this._isCancelled=!0,(e=this._abortController)==null||e.abort())}}const Js={OUTSIDE:-1,INTERSECTING:0,INSIDE:1},OR=new yi,nK=new yi;class DE{constructor(e=[0,0,0],i=[0,0,0],s){s=s||OR.copy(e).add(i).scale(.5),this.center=new yi(s),this.halfDiagonal=new yi(i).subtract(this.center),this.minimum=new yi(e),this.maximum=new yi(i)}clone(){return new DE(this.minimum,this.maximum,this.center)}equals(e){return this===e||!!e&&this.minimum.equals(e.minimum)&&this.maximum.equals(e.maximum)}transform(e){return this.center.transformAsPoint(e),this.halfDiagonal.transform(e),this.minimum.transform(e),this.maximum.transform(e),this}intersectPlane(e){const{halfDiagonal:i}=this,s=nK.from(e.normal),c=i.x*Math.abs(s.x)+i.y*Math.abs(s.y)+i.z*Math.abs(s.z),h=this.center.dot(s)+e.distance;return h-c>0?Js.INSIDE:h+c<0?Js.OUTSIDE:Js.INTERSECTING}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){const i=OR.from(e).subtract(this.center),{halfDiagonal:s}=this;let c=0,h;return h=Math.abs(i.x)-s.x,h>0&&(c+=h*h),h=Math.abs(i.y)-s.y,h>0&&(c+=h*h),h=Math.abs(i.z)-s.z,h>0&&(c+=h*h),c}}const Um=new yi,kR=new yi;class LE{constructor(e=[0,0,0],i=0){this.radius=-0,this.center=new yi,this.fromCenterRadius(e,i)}fromCenterRadius(e,i){return this.center.from(e),this.radius=i,this}fromCornerPoints(e,i){return i=Um.from(i),this.center=new yi().from(e).add(i).scale(.5),this.radius=this.center.distance(i),this}equals(e){return this===e||!!e&&this.center.equals(e.center)&&this.radius===e.radius}clone(){return new LE(this.center,this.radius)}union(e){const i=this.center,s=this.radius,c=e.center,h=e.radius,p=Um.copy(c).subtract(i),v=p.magnitude();if(s>=v+h)return this.clone();if(h>=v+s)return e.clone();const l=(s+v+h)*.5;return kR.copy(p).scale((-s+l)/v).add(i),this.center.copy(kR),this.radius=l,this}expand(e){const s=Um.from(e).subtract(this.center).magnitude();return s>this.radius&&(this.radius=s),this}transform(e){this.center.transform(e);const i=f2(Um,e);return this.radius=Math.max(i[0],Math.max(i[1],i[2]))*this.radius,this}distanceSquaredTo(e){const i=this.distanceTo(e);return i*i}distanceTo(e){const s=Um.from(e).subtract(this.center);return Math.max(0,s.len()-this.radius)}intersectPlane(e){const i=this.center,s=this.radius,h=e.normal.dot(i)+e.distance;return h<-s?Js.OUTSIDE:h<s?Js.INTERSECTING:Js.INSIDE}}const sK=new yi,oK=new yi,m0=new yi,_0=new yi,g0=new yi,aK=new yi,lK=new yi,Il={COLUMN0ROW0:0,COLUMN0ROW1:1,COLUMN0ROW2:2,COLUMN1ROW0:3,COLUMN1ROW1:4,COLUMN1ROW2:5,COLUMN2ROW0:6,COLUMN2ROW1:7,COLUMN2ROW2:8};class NE{constructor(e=[0,0,0],i=[0,0,0,0,0,0,0,0,0]){this.center=new yi().from(e),this.halfAxes=new Us(i)}get halfSize(){const e=this.halfAxes.getColumn(0),i=this.halfAxes.getColumn(1),s=this.halfAxes.getColumn(2);return[new yi(e).len(),new yi(i).len(),new yi(s).len()]}get quaternion(){const e=this.halfAxes.getColumn(0),i=this.halfAxes.getColumn(1),s=this.halfAxes.getColumn(2),c=new yi(e).normalize(),h=new yi(i).normalize(),p=new yi(s).normalize();return new nI().fromMatrix3(new Us([...c,...h,...p]))}fromCenterHalfSizeQuaternion(e,i,s){const c=new nI(s),h=new Us().fromQuaternion(c);return h[0]=h[0]*i[0],h[1]=h[1]*i[0],h[2]=h[2]*i[0],h[3]=h[3]*i[1],h[4]=h[4]*i[1],h[5]=h[5]*i[1],h[6]=h[6]*i[2],h[7]=h[7]*i[2],h[8]=h[8]*i[2],this.center=new yi().from(e),this.halfAxes=h,this}clone(){return new NE(this.center,this.halfAxes)}equals(e){return this===e||!!e&&this.center.equals(e.center)&&this.halfAxes.equals(e.halfAxes)}getBoundingSphere(e=new LE){const i=this.halfAxes,s=i.getColumn(0,m0),c=i.getColumn(1,_0),h=i.getColumn(2,g0),p=sK.copy(s).add(c).add(h);return e.center.copy(this.center),e.radius=p.magnitude(),e}intersectPlane(e){const i=this.center,s=e.normal,c=this.halfAxes,h=s.x,p=s.y,v=s.z,l=Math.abs(h*c[Il.COLUMN0ROW0]+p*c[Il.COLUMN0ROW1]+v*c[Il.COLUMN0ROW2])+Math.abs(h*c[Il.COLUMN1ROW0]+p*c[Il.COLUMN1ROW1]+v*c[Il.COLUMN1ROW2])+Math.abs(h*c[Il.COLUMN2ROW0]+p*c[Il.COLUMN2ROW1]+v*c[Il.COLUMN2ROW2]),A=s.dot(i)+e.distance;return A<=-l?Js.OUTSIDE:A>=l?Js.INSIDE:Js.INTERSECTING}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){const i=oK.from(e).subtract(this.center),s=this.halfAxes,c=s.getColumn(0,m0),h=s.getColumn(1,_0),p=s.getColumn(2,g0),v=c.magnitude(),l=h.magnitude(),A=p.magnitude();c.normalize(),h.normalize(),p.normalize();let P=0,O;return O=Math.abs(i.dot(c))-v,O>0&&(P+=O*O),O=Math.abs(i.dot(h))-l,O>0&&(P+=O*O),O=Math.abs(i.dot(p))-A,O>0&&(P+=O*O),P}computePlaneDistances(e,i,s=[-0,-0]){let c=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY;const p=this.center,v=this.halfAxes,l=v.getColumn(0,m0),A=v.getColumn(1,_0),P=v.getColumn(2,g0),O=aK.copy(l).add(A).add(P).add(p),L=lK.copy(O).subtract(e);let U=i.dot(L);return c=Math.min(U,c),h=Math.max(U,h),O.copy(p).add(l).add(A).subtract(P),L.copy(O).subtract(e),U=i.dot(L),c=Math.min(U,c),h=Math.max(U,h),O.copy(p).add(l).subtract(A).add(P),L.copy(O).subtract(e),U=i.dot(L),c=Math.min(U,c),h=Math.max(U,h),O.copy(p).add(l).subtract(A).subtract(P),L.copy(O).subtract(e),U=i.dot(L),c=Math.min(U,c),h=Math.max(U,h),p.copy(O).subtract(l).add(A).add(P),L.copy(O).subtract(e),U=i.dot(L),c=Math.min(U,c),h=Math.max(U,h),p.copy(O).subtract(l).add(A).subtract(P),L.copy(O).subtract(e),U=i.dot(L),c=Math.min(U,c),h=Math.max(U,h),p.copy(O).subtract(l).subtract(A).add(P),L.copy(O).subtract(e),U=i.dot(L),c=Math.min(U,c),h=Math.max(U,h),p.copy(O).subtract(l).subtract(A).subtract(P),L.copy(O).subtract(e),U=i.dot(L),c=Math.min(U,c),h=Math.max(U,h),s[0]=c,s[1]=h,s}transform(e){this.center.transformAsPoint(e);const i=this.halfAxes.getColumn(0,m0);i.transformAsPoint(e);const s=this.halfAxes.getColumn(1,_0);s.transformAsPoint(e);const c=this.halfAxes.getColumn(2,g0);return c.transformAsPoint(e),this.halfAxes=new Us([...i,...s,...c]),this}getTransform(){throw new Error("not implemented")}}const DR=new yi,LR=new yi;class k_{constructor(e=[0,0,1],i=0){this.normal=new yi,this.distance=-0,this.fromNormalDistance(e,i)}fromNormalDistance(e,i){return M_(Number.isFinite(i)),this.normal.from(e).normalize(),this.distance=i,this}fromPointNormal(e,i){e=DR.from(e),this.normal.from(i).normalize();const s=-this.normal.dot(e);return this.distance=s,this}fromCoefficients(e,i,s,c){return this.normal.set(e,i,s),M_(Ll(this.normal.len(),1)),this.distance=c,this}clone(){return new k_(this.normal,this.distance)}equals(e){return Ll(this.distance,e.distance)&&Ll(this.normal,e.normal)}getPointDistance(e){return this.normal.dot(e)+this.distance}transform(e){const i=LR.copy(this.normal).transformAsVector(e).normalize(),s=this.normal.scale(-this.distance).transform(e);return this.fromPointNormal(s,i)}projectPointOntoPlane(e,i=[0,0,0]){const s=DR.from(e),c=this.getPointDistance(s),h=LR.copy(this.normal).scale(c);return s.subtract(h).to(i)}}const NR=[new yi([1,0,0]),new yi([0,1,0]),new yi([0,0,1])],FR=new yi,cK=new yi;class Dl{constructor(e=[]){this.planes=e}fromBoundingSphere(e){this.planes.length=2*NR.length;const i=e.center,s=e.radius;let c=0;for(const h of NR){let p=this.planes[c],v=this.planes[c+1];p||(p=this.planes[c]=new k_),v||(v=this.planes[c+1]=new k_);const l=FR.copy(h).scale(-s).add(i);p.fromPointNormal(l,h);const A=FR.copy(h).scale(s).add(i),P=cK.copy(h).negate();v.fromPointNormal(A,P),c+=2}return this}computeVisibility(e){let i=Js.INSIDE;for(const s of this.planes)switch(e.intersectPlane(s)){case Js.OUTSIDE:return Js.OUTSIDE;case Js.INTERSECTING:i=Js.INTERSECTING;break}return i}computeVisibilityWithPlaneMask(e,i){if(M_(Number.isFinite(i),"parentPlaneMask is required."),i===Dl.MASK_OUTSIDE||i===Dl.MASK_INSIDE)return i;let s=Dl.MASK_INSIDE;const c=this.planes;for(let h=0;h<this.planes.length;++h){const p=h<31?1<<h:0;if(h<31&&!(i&p))continue;const v=c[h],l=e.intersectPlane(v);if(l===Js.OUTSIDE)return Dl.MASK_OUTSIDE;l===Js.INTERSECTING&&(s|=p)}return s}}Dl.MASK_OUTSIDE=4294967295;Dl.MASK_INSIDE=0;Dl.MASK_INDETERMINATE=2147483647;new yi;new yi;new yi;new yi;new yi;new yi;new yi;new yi;new yi;new yi;new yi;new yi;new yi;new yi;new yi;new yi;new yi;const Ja=new Us,uK=new Us,hK=new Us,y0=new Us,BR=new Us;function dK(t,e={}){const i=K2,s=10;let c=0,h=0;const p=uK,v=hK;p.identity(),v.copy(t);const l=i*fK(v);for(;h<s&&pK(v)>l;)mK(v,y0),BR.copy(y0).transpose(),v.multiplyRight(y0),v.multiplyLeft(BR),p.multiplyRight(y0),++c>2&&(++h,c=0);return e.unitary=p.toTarget(e.unitary),e.diagonal=v.toTarget(e.diagonal),e}function fK(t){let e=0;for(let i=0;i<9;++i){const s=t[i];e+=s*s}return Math.sqrt(e)}const UT=[1,0,0],VT=[2,2,1];function pK(t){let e=0;for(let i=0;i<3;++i){const s=t[Ja.getElementIndex(VT[i],UT[i])];e+=2*s*s}return Math.sqrt(e)}function mK(t,e){const i=Y2;let s=0,c=1;for(let A=0;A<3;++A){const P=Math.abs(t[Ja.getElementIndex(VT[A],UT[A])]);P>s&&(c=A,s=P)}const h=UT[c],p=VT[c];let v=1,l=0;if(Math.abs(t[Ja.getElementIndex(p,h)])>i){const A=t[Ja.getElementIndex(p,p)],P=t[Ja.getElementIndex(h,h)],O=t[Ja.getElementIndex(p,h)],L=(A-P)/2/O;let U;L<0?U=-1/(-L+Math.sqrt(1+L*L)):U=1/(L+Math.sqrt(1+L*L)),v=1/Math.sqrt(1+U*U),l=U*v}return Us.IDENTITY.to(e),e[Ja.getElementIndex(h,h)]=e[Ja.getElementIndex(p,p)]=v,e[Ja.getElementIndex(p,h)]=l,e[Ja.getElementIndex(h,p)]=-l,e}const Ec=new yi,_K=new yi,gK=new yi,yK=new yi,vK=new yi,xK=new Us,bK={diagonal:new Us,unitary:new Us};function wK(t,e=new NE){if(!t||t.length===0)return e.halfAxes=new Us([0,0,0,0,0,0,0,0,0]),e.center=new yi,e;const i=t.length,s=new yi(0,0,0);for(const xe of t)s.add(xe);const c=1/i;s.multiplyByScalar(c);let h=0,p=0,v=0,l=0,A=0,P=0;for(const xe of t){const it=Ec.copy(xe).subtract(s);h+=it.x*it.x,p+=it.x*it.y,v+=it.x*it.z,l+=it.y*it.y,A+=it.y*it.z,P+=it.z*it.z}h*=c,p*=c,v*=c,l*=c,A*=c,P*=c;const O=xK;O[0]=h,O[1]=p,O[2]=v,O[3]=p,O[4]=l,O[5]=A,O[6]=v,O[7]=A,O[8]=P;const{unitary:L}=dK(O,bK),U=e.halfAxes.copy(L);let H=U.getColumn(0,gK),Y=U.getColumn(1,yK),J=U.getColumn(2,vK),oe=-Number.MAX_VALUE,me=-Number.MAX_VALUE,pe=-Number.MAX_VALUE,be=Number.MAX_VALUE,Oe=Number.MAX_VALUE,je=Number.MAX_VALUE;for(const xe of t)Ec.copy(xe),oe=Math.max(Ec.dot(H),oe),me=Math.max(Ec.dot(Y),me),pe=Math.max(Ec.dot(J),pe),be=Math.min(Ec.dot(H),be),Oe=Math.min(Ec.dot(Y),Oe),je=Math.min(Ec.dot(J),je);H=H.multiplyByScalar(.5*(be+oe)),Y=Y.multiplyByScalar(.5*(Oe+me)),J=J.multiplyByScalar(.5*(je+pe)),e.center.copy(H).add(Y).add(J);const st=_K.set(oe-be,me-Oe,pe-je).multiplyByScalar(.5),ut=new Us([st[0],0,0,0,st[1],0,0,0,st[2]]);return e.halfAxes.multiplyRight(ut),e}const tf=512,zR=3,aN=[[.5,.5],[0,0],[0,1],[1,0],[1,1]],lN=aN.concat([[0,.5],[.5,0],[1,.5],[.5,1]]),TK=lN.concat([[.25,.5],[.75,.5]]);class rf{constructor(e,i,s){this.x=e,this.y=i,this.z=s}get children(){if(!this._children){const e=this.x*2,i=this.y*2,s=this.z+1;this._children=[new rf(e,i,s),new rf(e,i+1,s),new rf(e+1,i,s),new rf(e+1,i+1,s)]}return this._children}update(e){const{viewport:i,cullingVolume:s,elevationBounds:c,minZ:h,maxZ:p,bounds:v,offset:l,project:A}=e,P=this.getBoundingVolume(c,l,A);if(v&&!this.insideBounds(v)||s.computeVisibility(P)<0)return!1;if(!this.childVisible){let{z:L}=this;if(L<p&&L>=h){const U=P.distanceTo(i.cameraPosition)*i.scale/i.height;L+=Math.floor(Math.log2(U))}if(L>=p)return this.selected=!0,!0}this.selected=!1,this.childVisible=!0;for(const L of this.children)L.update(e);return!0}getSelected(e=[]){if(this.selected&&e.push(this),this._children)for(const i of this._children)i.getSelected(e);return e}insideBounds([e,i,s,c]){const h=Math.pow(2,this.z),p=tf/h;return this.x*p<s&&this.y*p<c&&(this.x+1)*p>e&&(this.y+1)*p>i}getBoundingVolume(e,i,s){if(s){const l=this.z<1?TK:this.z<2?lN:aN,A=[];for(const P of l){const O=$T(this.x+P[0],this.y+P[1],this.z);O[2]=e[0],A.push(s(O)),e[0]!==e[1]&&(O[2]=e[1],A.push(s(O)))}return wK(A)}const c=Math.pow(2,this.z),h=tf/c,p=this.x*h+i*tf,v=tf-(this.y+1)*h;return new DE([p,v,e[0]],[p+h,v+h,e[1]])}}function EK(t,e,i,s){const c=t instanceof gZ&&t.resolution?t.projectPosition:null,h=Object.values(t.getFrustumPlanes()).map(({normal:U,distance:H})=>new k_(U.clone().negate(),H)),p=new Dl(h),v=t.distanceScales.unitsPerMeter[2],l=i&&i[0]*v||0,A=i&&i[1]*v||0,P=t instanceof Ef&&t.pitch<=60?e:0;if(s){const[U,H,Y,J]=s,oe=$c([U,J]),me=$c([Y,H]);s=[oe[0],tf-oe[1],me[0],tf-me[1]]}const O=new rf(0,0,0),L={viewport:t,project:c,cullingVolume:p,elevationBounds:[l,A],minZ:P,maxZ:e,bounds:s,offset:0};if(O.update(L),t instanceof Ef&&t.subViewports&&t.subViewports.length>1){for(L.offset=-1;O.update(L)&&!(--L.offset<-zR););for(L.offset=1;O.update(L)&&!(++L.offset>zR););}return O.getSelected()}const Bl=512,SK=[-1/0,-1/0,1/0,1/0],AK={type:"object",value:null,validate:(t,e)=>e.optional&&t===null||typeof t=="string"||Array.isArray(t)&&t.every(i=>typeof i=="string"),equal:(t,e)=>{if(t===e)return!0;if(!Array.isArray(t)||!Array.isArray(e))return!1;const i=t.length;if(i!==e.length)return!1;for(let s=0;s<i;s++)if(t[s]!==e[s])return!1;return!0}};function cN(t,e){const i=[e.transformAsPoint([t[0],t[1]]),e.transformAsPoint([t[2],t[1]]),e.transformAsPoint([t[0],t[3]]),e.transformAsPoint([t[2],t[3]])];return[Math.min(...i.map(c=>c[0])),Math.min(...i.map(c=>c[1])),Math.max(...i.map(c=>c[0])),Math.max(...i.map(c=>c[1]))]}function MK(t){return Math.abs(t.split("").reduce((e,i)=>(e<<5)-e+i.charCodeAt(0)|0,0))}function CK(t,e){if(!t||!t.length)return null;const{index:i,id:s}=e;if(Array.isArray(t)){const h=MK(s)%t.length;t=t[h]}let c=t;for(const h of Object.keys(i)){const p=new RegExp(`{${h}}`,"g");c=c.replace(p,String(i[h]))}return Number.isInteger(i.y)&&Number.isInteger(i.z)&&(c=c.replace(/\{-y\}/g,String(Math.pow(2,i.z)-i.y-1))),c}function PK(t,e,i){let s;if(e&&e.length===2){const[c,h]=e,p=t.getBounds({z:c}),v=t.getBounds({z:h});s=[Math.min(p[0],v[0]),Math.min(p[1],v[1]),Math.max(p[2],v[2]),Math.max(p[3],v[3])]}else s=t.getBounds();return t.isGeospatial?[Math.max(s[0],i[0]),Math.max(s[1],i[1]),Math.min(s[2],i[2]),Math.min(s[3],i[3])]:[Math.max(Math.min(s[0],i[2]),i[0]),Math.max(Math.min(s[1],i[3]),i[1]),Math.min(Math.max(s[2],i[0]),i[2]),Math.min(Math.max(s[3],i[1]),i[3])]}function IK({viewport:t,z:e,cullRect:i}){return(t.subViewports||[t]).map(c=>jT(c,e||0,i))}function jT(t,e,i){if(!Array.isArray(e)){const h=i.x-t.x,p=i.y-t.y,{width:v,height:l}=i,A={targetZ:e},P=t.unproject([h,p],A),O=t.unproject([h+v,p],A),L=t.unproject([h,p+l],A),U=t.unproject([h+v,p+l],A);return[Math.min(P[0],O[0],L[0],U[0]),Math.min(P[1],O[1],L[1],U[1]),Math.max(P[0],O[0],L[0],U[0]),Math.max(P[1],O[1],L[1],U[1])]}const s=jT(t,e[0],i),c=jT(t,e[1],i);return[Math.min(s[0],c[0]),Math.min(s[1],c[1]),Math.max(s[2],c[2]),Math.max(s[3],c[3])]}function RK(t,e,i){return i?cN(t,i).map(c=>c*e/Bl):t.map(s=>s*e/Bl)}function FE(t,e){return Math.pow(2,t)*Bl/e}function $T(t,e,i){const s=FE(i,Bl),c=t/s*360-180,h=Math.PI-2*Math.PI*e/s,p=180/Math.PI*Math.atan(.5*(Math.exp(h)-Math.exp(-h)));return[c,p]}function UR(t,e,i,s){const c=FE(i,s);return[t/c*Bl,e/c*Bl]}function OK(t,e,i,s,c=Bl){if(t.isGeospatial){const[A,P]=$T(e,i,s),[O,L]=$T(e+1,i+1,s);return{west:A,north:P,east:O,south:L}}const[h,p]=UR(e,i,s,c),[v,l]=UR(e+1,i+1,s,c);return{left:h,top:p,right:v,bottom:l}}function kK(t,e,i,s,c){const h=PK(t,null,s),p=FE(e,i),[v,l,A,P]=RK(h,p,c),O=[];for(let L=Math.floor(v);L<A;L++)for(let U=Math.floor(l);U<P;U++)O.push({x:L,y:U,z:e});return O}function DK({viewport:t,maxZoom:e,minZoom:i,zRange:s,extent:c,tileSize:h=Bl,modelMatrix:p,modelMatrixInverse:v,zoomOffset:l=0}){let A=t.isGeospatial?Math.round(t.zoom+Math.log2(Bl/h))+l:Math.ceil(t.zoom)+l;if(typeof i=="number"&&Number.isFinite(i)&&A<i){if(!c)return[];A=i}typeof e=="number"&&Number.isFinite(e)&&A>e&&(A=e);let P=c;return p&&v&&c&&!t.isGeospatial&&(P=cN(c,p)),t.isGeospatial?EK(t,A,s,c):kK(t,A,h,P||SK,v)}function LK(t){let e={},i;return s=>{for(const c in s)if(!NK(s[c],e[c])){i=t(s),e=s;break}return i}}function NK(t,e){if(t===e)return!0;if(Array.isArray(t)){const i=t.length;if(!e||e.length!==i)return!1;for(let s=0;s<i;s++)if(t[s]!==e[s])return!1;return!0}return!1}const VR=1,g1=2,FK="never",BK="no-overlap",BE="best-available",zK=5,UK={[BE]:$K,[BK]:WK,[FK]:()=>{}},VK={extent:null,tileSize:512,maxZoom:null,minZoom:null,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:"best-available",zRange:null,maxRequests:6,debounceTime:0,zoomOffset:0,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{}};class jK{constructor(e){this._getCullBounds=LK(IK),this.opts={...VK,...e},this.setOptions(this.opts),this.onTileLoad=i=>{var s,c;(c=(s=this.opts).onTileLoad)==null||c.call(s,i),this.opts.maxCacheByteSize&&(this._cacheByteSize+=i.byteLength,this._resizeCache())},this._requestScheduler=new b8({throttleRequests:this.opts.maxRequests>0||this.opts.debounceTime>0,maxRequests:this.opts.maxRequests,debounceTime:this.opts.debounceTime}),this._cache=new Map,this._tiles=[],this._dirty=!1,this._cacheByteSize=0,this._viewport=null,this._zRange=null,this._selectedTiles=null,this._frameNumber=0,this._modelMatrix=new Vs,this._modelMatrixInverse=new Vs}get tiles(){return this._tiles}get selectedTiles(){return this._selectedTiles}get isLoaded(){return this._selectedTiles!==null&&this._selectedTiles.every(e=>e.isLoaded)}get needsReload(){return this._selectedTiles!==null&&this._selectedTiles.some(e=>e.needsReload)}setOptions(e){Object.assign(this.opts,e),Number.isFinite(e.maxZoom)&&(this._maxZoom=Math.floor(e.maxZoom)),Number.isFinite(e.minZoom)&&(this._minZoom=Math.ceil(e.minZoom))}finalize(){for(const e of this._cache.values())e.isLoading&&e.abort();this._cache.clear(),this._tiles=[],this._selectedTiles=null}reloadAll(){for(const e of this._cache.keys()){const i=this._cache.get(e);!this._selectedTiles||!this._selectedTiles.includes(i)?this._cache.delete(e):i.setNeedsReload()}}update(e,{zRange:i,modelMatrix:s}={zRange:null,modelMatrix:null}){const c=s?new Vs(s):new Vs,h=!c.equals(this._modelMatrix);if(!this._viewport||!e.equals(this._viewport)||!Ll(this._zRange,i)||h){h&&(this._modelMatrixInverse=c.clone().invert(),this._modelMatrix=c),this._viewport=e,this._zRange=i;const v=this.getTileIndices({viewport:e,maxZoom:this._maxZoom,minZoom:this._minZoom,zRange:i,modelMatrix:this._modelMatrix,modelMatrixInverse:this._modelMatrixInverse});this._selectedTiles=v.map(l=>this._getTile(l,!0)),this._dirty&&this._rebuildTree()}else this.needsReload&&(this._selectedTiles=this._selectedTiles.map(v=>this._getTile(v.index,!0)));const p=this.updateTileStates();return this._pruneRequests(),this._dirty&&this._resizeCache(),p&&this._frameNumber++,this._frameNumber}isTileVisible(e,i){if(!e.isVisible)return!1;if(i&&this._viewport){const s=this._getCullBounds({viewport:this._viewport,z:this._zRange,cullRect:i}),{bbox:c}=e;for(const[h,p,v,l]of s){let A;if("west"in c)A=c.west<v&&c.east>h&&c.south<l&&c.north>p;else{const P=Math.min(c.top,c.bottom),O=Math.max(c.top,c.bottom);A=c.left<v&&c.right>h&&P<l&&O>p}if(A)return!0}return!1}return!0}getTileIndices({viewport:e,maxZoom:i,minZoom:s,zRange:c,modelMatrix:h,modelMatrixInverse:p}){const{tileSize:v,extent:l,zoomOffset:A}=this.opts;return DK({viewport:e,maxZoom:i,minZoom:s,zRange:c,tileSize:v,extent:l,modelMatrix:h,modelMatrixInverse:p,zoomOffset:A})}getTileId(e){return`${e.x}-${e.y}-${e.z}`}getTileZoom(e){return e.z}getTileMetadata(e){const{tileSize:i}=this.opts;return{bbox:OK(this._viewport,e.x,e.y,e.z,i)}}getParentIndex(e){const i=Math.floor(e.x/2),s=Math.floor(e.y/2),c=e.z-1;return{x:i,y:s,z:c}}updateTileStates(){const e=this.opts.refinementStrategy||BE,i=new Array(this._cache.size);let s=0;for(const c of this._cache.values())i[s++]=c.isVisible,c.isSelected=!1,c.isVisible=!1;for(const c of this._selectedTiles)c.isSelected=!0,c.isVisible=!0;(typeof e=="function"?e:UK[e])(Array.from(this._cache.values())),s=0;for(const c of this._cache.values())if(i[s++]!==c.isVisible)return!0;return!1}_pruneRequests(){const{maxRequests:e=0}=this.opts,i=[];let s=0;for(const c of this._cache.values())c.isLoading&&(s++,!c.isSelected&&!c.isVisible&&i.push(c));for(;e>0&&s>e&&i.length>0;)i.shift().abort(),s--}_rebuildTree(){const{_cache:e}=this;for(const i of e.values())i.parent=null,i.children&&(i.children.length=0);for(const i of e.values()){const s=this._getNearestAncestor(i);i.parent=s,s!=null&&s.children&&s.children.push(i)}}_resizeCache(){var p,v;const{_cache:e,opts:i}=this,s=i.maxCacheSize||(i.maxCacheByteSize?1/0:zK*this.selectedTiles.length),c=i.maxCacheByteSize||1/0;if(e.size>s||this._cacheByteSize>c){for(const[l,A]of e)if(!A.isVisible&&!A.isSelected&&(this._cacheByteSize-=i.maxCacheByteSize?A.byteLength:0,e.delete(l),(v=(p=this.opts).onTileUnload)==null||v.call(p,A)),e.size<=s&&this._cacheByteSize<=c)break;this._rebuildTree(),this._dirty=!0}this._dirty&&(this._tiles=Array.from(this._cache.values()).sort((l,A)=>l.zoom-A.zoom),this._dirty=!1)}_getTile(e,i){const s=this.getTileId(e);let c=this._cache.get(s),h=!1;return!c&&i?(c=new rK(e),Object.assign(c,this.getTileMetadata(c.index)),Object.assign(c,{id:s,zoom:this.getTileZoom(c.index)}),h=!0,this._cache.set(s,c),this._dirty=!0):c&&c.needsReload&&(h=!0),c&&h&&c.loadData({getData:this.opts.getTileData,requestScheduler:this._requestScheduler,onLoad:this.onTileLoad,onError:this.opts.onTileError}),c}_getNearestAncestor(e){const{_minZoom:i=0}=this;let s=e.index;for(;this.getTileZoom(s)>i;){s=this.getParentIndex(s);const c=this._getTile(s);if(c)return c}return null}}function $K(t){for(const e of t)e.state=0;for(const e of t)e.isSelected&&!uN(e)&&zE(e);for(const e of t)e.isVisible=!!(e.state&g1)}function WK(t){for(const i of t)i.state=0;for(const i of t)i.isSelected&&uN(i);const e=Array.from(t).sort((i,s)=>i.zoom-s.zoom);for(const i of e)if(i.isVisible=!!(i.state&g1),i.children&&(i.isVisible||i.state&VR))for(const s of i.children)s.state=VR;else i.isSelected&&zE(i)}function uN(t){let e=t;for(;e;){if(e.isLoaded||e.content)return e.state|=g1,!0;e=e.parent}return!1}function zE(t){for(const e of t.children)e.isLoaded||e.content?e.state|=g1:zE(e)}const HK={TilesetClass:jK,data:{type:"data",value:[]},dataComparator:AK.equal,renderSubLayers:{type:"function",value:t=>new zT(t)},getTileData:{type:"function",optional:!0,value:null},onViewportLoad:{type:"function",optional:!0,value:null},onTileLoad:{type:"function",value:t=>{}},onTileUnload:{type:"function",value:t=>{}},onTileError:{type:"function",value:t=>console.error(t)},extent:{type:"array",optional:!0,value:null,compare:!0},tileSize:512,maxZoom:null,minZoom:0,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:BE,zRange:null,maxRequests:6,debounceTime:0,zoomOffset:0},Qv=class Qv extends I_{initializeState(){this.state={tileset:null,isLoaded:!1}}finalizeState(){var e,i;(i=(e=this.state)==null?void 0:e.tileset)==null||i.finalize()}get isLoaded(){var e,i,s;return!!((s=(i=(e=this.state)==null?void 0:e.tileset)==null?void 0:i.selectedTiles)!=null&&s.every(c=>c.isLoaded&&c.layers&&c.layers.every(h=>h.isLoaded)))}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState({changeFlags:e}){let{tileset:i}=this.state;const s=e.propsOrDataChanged||e.updateTriggersChanged,c=e.dataChanged||e.updateTriggersChanged&&(e.updateTriggersChanged.all||e.updateTriggersChanged.getTileData);i?s&&(i.setOptions(this._getTilesetOptions()),c?i.reloadAll():i.tiles.forEach(h=>{h.layers=null})):(i=new this.props.TilesetClass(this._getTilesetOptions()),this.setState({tileset:i})),this._updateTileset()}_getTilesetOptions(){const{tileSize:e,maxCacheSize:i,maxCacheByteSize:s,refinementStrategy:c,extent:h,maxZoom:p,minZoom:v,maxRequests:l,debounceTime:A,zoomOffset:P}=this.props;return{maxCacheSize:i,maxCacheByteSize:s,maxZoom:p,minZoom:v,tileSize:e,refinementStrategy:c,extent:h,maxRequests:l,debounceTime:A,zoomOffset:P,getTileData:this.getTileData.bind(this),onTileLoad:this._onTileLoad.bind(this),onTileError:this._onTileError.bind(this),onTileUnload:this._onTileUnload.bind(this)}}_updateTileset(){const e=this.state.tileset,{zRange:i,modelMatrix:s}=this.props,c=e.update(this.context.viewport,{zRange:i,modelMatrix:s}),{isLoaded:h}=e,p=this.state.isLoaded!==h,v=this.state.frameNumber!==c;h&&(p||v)&&this._onViewportLoad(),v&&this.setState({frameNumber:c}),this.state.isLoaded=h}_onViewportLoad(){const{tileset:e}=this.state,{onViewportLoad:i}=this.props;i&&i(e.selectedTiles)}_onTileLoad(e){this.props.onTileLoad(e),e.layers=null,this.setNeedsUpdate()}_onTileError(e,i){this.props.onTileError(e),i.layers=null,this.setNeedsUpdate()}_onTileUnload(e){this.props.onTileUnload(e)}getTileData(e){const{data:i,getTileData:s,fetch:c}=this.props,{signal:h}=e;return e.url=typeof i=="string"||Array.isArray(i)?CK(i,e):null,s?s(e):c&&e.url?c(e.url,{propName:"data",layer:this,signal:h}):null}renderSubLayers(e){return this.props.renderSubLayers(e)}getSubLayerPropsByTile(e){return null}getPickingInfo(e){const i=e.sourceLayer,s=i.props.tile,c=e.info;return c.picked&&(c.tile=s),c.sourceTile=s,c.sourceTileSubLayer=i,c}_updateAutoHighlight(e){e.sourceTileSubLayer.updateAutoHighlight(e)}renderLayers(){return this.state.tileset.tiles.map(e=>{const i=this.getSubLayerPropsByTile(e);if(!(!e.isLoaded&&!e.content))if(e.layers)i&&e.layers[0]&&Object.keys(i).some(s=>e.layers[0].props[s]!==i[s])&&(e.layers=e.layers.map(s=>s.clone(i)));else{const s=this.renderSubLayers({...this.props,...this.getSubLayerProps({id:e.id,updateTriggers:this.props.updateTriggers}),data:e.content,_offset:0,tile:e});e.layers=h1(s,Boolean).map(c=>c.clone({tile:e,...i}))}return e.layers})}filterSubLayer({layer:e,cullRect:i}){const{tile:s}=e.props;return this.state.tileset.isTileVisible(s,i)}};Qv.defaultProps=HK,Qv.layerName="TileLayer";let WT=Qv;const qK="4.2.0";function GK(t){var e;globalThis.loaders||(globalThis.loaders={}),(e=globalThis.loaders).modules||(e.modules={}),Object.assign(globalThis.loaders.modules,t)}function XK(t){var i,s;return((s=(i=globalThis.loaders)==null?void 0:i.modules)==null?void 0:s[t])||null}function ZK(){var t;return(t=globalThis._loadersgl_)!=null&&t.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.2.0"),globalThis._loadersgl_.version}const YK=ZK();function KK(t,e){if(!t)throw new Error(e||"loaders.gl assertion failed.")}const $_=typeof process!="object"||String(process)!=="[object process]"||process.browser,UE=typeof importScripts=="function",jR=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);jR&&parseFloat(jR[1]);const nw={};async function yv(t,e=null,i={},s=null){return e&&(t=JK(t,e,i,s)),nw[t]=nw[t]||QK(t),await nw[t]}function JK(t,e,i={},s=null){if(!i.useLocalLibraries&&t.startsWith("http"))return t;s=s||t;const c=i.modules||{};return c[s]?c[s]:$_?i.CDN?(KK(i.CDN.startsWith("http")),`${i.CDN}/${e}@${YK}/dist/libs/${s}`):UE?`../src/libs/${s}`:`modules/${e}/src/libs/${s}`:`modules/${e}/dist/libs/${s}`}async function QK(t){if(t.endsWith("wasm"))return await tJ(t);if(!$_)try{const{requireFromFile:i}=globalThis.loaders||{};return await(i==null?void 0:i(t))}catch(i){return console.error(i),null}if(UE)return importScripts(t);const e=await iJ(t);return eJ(e,t)}function eJ(t,e){if(!$_){const{requireFromString:s}=globalThis.loaders||{};return s==null?void 0:s(t,e)}if(UE)return eval.call(globalThis,t),null;const i=document.createElement("script");i.id=e;try{i.appendChild(document.createTextNode(t))}catch{i.text=t}return document.body.appendChild(i),null}async function tJ(t){const{readFileAsArrayBuffer:e}=globalThis.loaders||{};return $_||!e||t.startsWith("http")?await(await fetch(t)).arrayBuffer():await e(t)}async function iJ(t){const{readFileAsText:e}=globalThis.loaders||{};return $_||!e||t.startsWith("http")?await(await fetch(t)).text():await e(t)}const vv={TRANSCODER:"basis_transcoder.js",TRANSCODER_WASM:"basis_transcoder.wasm",ENCODER:"basis_encoder.js",ENCODER_WASM:"basis_encoder.wasm"};let $R;async function WR(t){GK(t.modules);const e=XK("basis");return e||($R||($R=rJ(t)),await $R)}async function rJ(t){let e=null,i=null;return[e,i]=await Promise.all([await yv(vv.TRANSCODER,"textures",t),await yv(vv.TRANSCODER_WASM,"textures",t)]),e=e||globalThis.BASIS,await nJ(e,i)}function nJ(t,e){const i={};return e&&(i.wasmBinary=e),new Promise(s=>{t(i).then(c=>{const{BasisFile:h,initializeBasis:p}=c;p(),s({BasisFile:h})})})}let sw;async function HR(t){const e=t.modules||{};return e.basisEncoder?e.basisEncoder:(sw=sw||sJ(t),await sw)}async function sJ(t){let e=null,i=null;return[e,i]=await Promise.all([await yv(vv.ENCODER,"textures",t),await yv(vv.ENCODER_WASM,"textures",t)]),e=e||globalThis.BASIS,await oJ(e,i)}function oJ(t,e){const i={};return e&&(i.wasmBinary=e),new Promise(s=>{t(i).then(c=>{const{BasisFile:h,KTX2File:p,initializeBasis:v,BasisEncoder:l}=c;v(),s({BasisFile:h,KTX2File:p,BasisEncoder:l})})})}const zd={COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_R11_EAC:37488,COMPRESSED_SIGNED_R11_EAC:37489,COMPRESSED_RG11_EAC:37490,COMPRESSED_SIGNED_RG11_EAC:37491,COMPRESSED_RGB8_ETC2:37492,COMPRESSED_RGBA8_ETC2_EAC:37493,COMPRESSED_SRGB8_ETC2:37494,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:37495,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:37496,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:37497,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGB_ATC_WEBGL:35986,COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL:35987,COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL:34798,COMPRESSED_RGBA_ASTC_4X4_KHR:37808,COMPRESSED_RGBA_ASTC_5X4_KHR:37809,COMPRESSED_RGBA_ASTC_5X5_KHR:37810,COMPRESSED_RGBA_ASTC_6X5_KHR:37811,COMPRESSED_RGBA_ASTC_6X6_KHR:37812,COMPRESSED_RGBA_ASTC_8X5_KHR:37813,COMPRESSED_RGBA_ASTC_8X6_KHR:37814,COMPRESSED_RGBA_ASTC_8X8_KHR:37815,COMPRESSED_RGBA_ASTC_10X5_KHR:37816,COMPRESSED_RGBA_ASTC_10X6_KHR:37817,COMPRESSED_RGBA_ASTC_10X8_KHR:37818,COMPRESSED_RGBA_ASTC_10X10_KHR:37819,COMPRESSED_RGBA_ASTC_12X10_KHR:37820,COMPRESSED_RGBA_ASTC_12X12_KHR:37821,COMPRESSED_SRGB8_ALPHA8_ASTC_4X4_KHR:37840,COMPRESSED_SRGB8_ALPHA8_ASTC_5X4_KHR:37841,COMPRESSED_SRGB8_ALPHA8_ASTC_5X5_KHR:37842,COMPRESSED_SRGB8_ALPHA8_ASTC_6X5_KHR:37843,COMPRESSED_SRGB8_ALPHA8_ASTC_6X6_KHR:37844,COMPRESSED_SRGB8_ALPHA8_ASTC_8X5_KHR:37845,COMPRESSED_SRGB8_ALPHA8_ASTC_8X6_KHR:37846,COMPRESSED_SRGB8_ALPHA8_ASTC_8X8_KHR:37847,COMPRESSED_SRGB8_ALPHA8_ASTC_10X5_KHR:37848,COMPRESSED_SRGB8_ALPHA8_ASTC_10X6_KHR:37849,COMPRESSED_SRGB8_ALPHA8_ASTC_10X8_KHR:37850,COMPRESSED_SRGB8_ALPHA8_ASTC_10X10_KHR:37851,COMPRESSED_SRGB8_ALPHA8_ASTC_12X10_KHR:37852,COMPRESSED_SRGB8_ALPHA8_ASTC_12X12_KHR:37853,COMPRESSED_RED_RGTC1_EXT:36283,COMPRESSED_SIGNED_RED_RGTC1_EXT:36284,COMPRESSED_RED_GREEN_RGTC2_EXT:36285,COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT:36286,COMPRESSED_SRGB_S3TC_DXT1_EXT:35916,COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:35917,COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:35918,COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:35919},aJ=["","WEBKIT_","MOZ_"],qR={WEBGL_compressed_texture_s3tc:"dxt",WEBGL_compressed_texture_s3tc_srgb:"dxt-srgb",WEBGL_compressed_texture_etc1:"etc1",WEBGL_compressed_texture_etc:"etc2",WEBGL_compressed_texture_pvrtc:"pvrtc",WEBGL_compressed_texture_atc:"atc",WEBGL_compressed_texture_astc:"astc",EXT_texture_compression_rgtc:"rgtc"};let v0=null;function lJ(t){if(!v0){t=t||cJ()||void 0,v0=new Set;for(const e of aJ)for(const i in qR)if(t&&t.getExtension(`${e}${i}`)){const s=qR[i];v0.add(s)}}return v0}function cJ(){try{return document.createElement("canvas").getContext("webgl")}catch{return null}}var GR,XR,ZR,YR,KR,JR,QR,eO;(function(t){t[t.NONE=0]="NONE",t[t.BASISLZ=1]="BASISLZ",t[t.ZSTD=2]="ZSTD",t[t.ZLIB=3]="ZLIB"})(GR||(GR={})),function(t){t[t.BASICFORMAT=0]="BASICFORMAT"}(XR||(XR={})),function(t){t[t.UNSPECIFIED=0]="UNSPECIFIED",t[t.ETC1S=163]="ETC1S",t[t.UASTC=166]="UASTC"}(ZR||(ZR={})),function(t){t[t.UNSPECIFIED=0]="UNSPECIFIED",t[t.SRGB=1]="SRGB"}(YR||(YR={})),function(t){t[t.UNSPECIFIED=0]="UNSPECIFIED",t[t.LINEAR=1]="LINEAR",t[t.SRGB=2]="SRGB",t[t.ITU=3]="ITU",t[t.NTSC=4]="NTSC",t[t.SLOG=5]="SLOG",t[t.SLOG2=6]="SLOG2"}(KR||(KR={})),function(t){t[t.ALPHA_STRAIGHT=0]="ALPHA_STRAIGHT",t[t.ALPHA_PREMULTIPLIED=1]="ALPHA_PREMULTIPLIED"}(JR||(JR={})),function(t){t[t.RGB=0]="RGB",t[t.RRR=3]="RRR",t[t.GGG=4]="GGG",t[t.AAA=15]="AAA"}(QR||(QR={})),function(t){t[t.RGB=0]="RGB",t[t.RGBA=3]="RGBA",t[t.RRR=4]="RRR",t[t.RRRG=5]="RRRG"}(eO||(eO={}));const Do=[171,75,84,88,32,50,48,187,13,10,26,10];function uJ(t){const e=new Uint8Array(t);return!(e.byteLength<Do.length||e[0]!==Do[0]||e[1]!==Do[1]||e[2]!==Do[2]||e[3]!==Do[3]||e[4]!==Do[4]||e[5]!==Do[5]||e[6]!==Do[6]||e[7]!==Do[7]||e[8]!==Do[8]||e[9]!==Do[9]||e[10]!==Do[10]||e[11]!==Do[11])}const hJ={etc1:{basisFormat:0,compressed:!0,format:zd.COMPRESSED_RGB_ETC1_WEBGL},etc2:{basisFormat:1,compressed:!0},bc1:{basisFormat:2,compressed:!0,format:zd.COMPRESSED_RGB_S3TC_DXT1_EXT},bc3:{basisFormat:3,compressed:!0,format:zd.COMPRESSED_RGBA_S3TC_DXT5_EXT},bc4:{basisFormat:4,compressed:!0},bc5:{basisFormat:5,compressed:!0},"bc7-m6-opaque-only":{basisFormat:6,compressed:!0},"bc7-m5":{basisFormat:7,compressed:!0},"pvrtc1-4-rgb":{basisFormat:8,compressed:!0,format:zd.COMPRESSED_RGB_PVRTC_4BPPV1_IMG},"pvrtc1-4-rgba":{basisFormat:9,compressed:!0,format:zd.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG},"astc-4x4":{basisFormat:10,compressed:!0,format:zd.COMPRESSED_RGBA_ASTC_4X4_KHR},"atc-rgb":{basisFormat:11,compressed:!0},"atc-rgba-interpolated-alpha":{basisFormat:12,compressed:!0},rgba32:{basisFormat:13,compressed:!1},rgb565:{basisFormat:14,compressed:!1},bgr565:{basisFormat:15,compressed:!1},rgba4444:{basisFormat:16,compressed:!1}};async function dJ(t,e){if(e.basis.containerFormat==="auto"){if(uJ(t)){const s=await HR(e);return tO(s.KTX2File,t,e)}const{BasisFile:i}=await WR(e);return ow(i,t,e)}switch(e.basis.module){case"encoder":const i=await HR(e);switch(e.basis.containerFormat){case"ktx2":return tO(i.KTX2File,t,e);case"basis":default:return ow(i.BasisFile,t,e)}case"transcoder":default:const{BasisFile:s}=await WR(e);return ow(s,t,e)}}function ow(t,e,i){const s=new t(new Uint8Array(e));try{if(!s.startTranscoding())throw new Error("Failed to start basis transcoding");const c=s.getNumImages(),h=[];for(let p=0;p<c;p++){const v=s.getNumLevels(p),l=[];for(let A=0;A<v;A++)l.push(fJ(s,p,A,i));h.push(l)}return h}finally{s.close(),s.delete()}}function fJ(t,e,i,s){const c=t.getImageWidth(e,i),h=t.getImageHeight(e,i),p=t.getHasAlpha(),{compressed:v,format:l,basisFormat:A}=hN(s,p),P=t.getImageTranscodedSizeInBytes(e,i,A),O=new Uint8Array(P);if(!t.transcodeImage(O,e,i,A,0,0))throw new Error("failed to start Basis transcoding");return{width:c,height:h,data:O,compressed:v,format:l,hasAlpha:p}}function tO(t,e,i){const s=new t(new Uint8Array(e));try{if(!s.startTranscoding())throw new Error("failed to start KTX2 transcoding");const c=s.getLevels(),h=[];for(let p=0;p<c;p++){h.push(pJ(s,p,i));break}return[h]}finally{s.close(),s.delete()}}function pJ(t,e,i){const{alphaFlag:s,height:c,width:h}=t.getImageLevelInfo(e,0,0),{compressed:p,format:v,basisFormat:l}=hN(i,s),A=t.getImageTranscodedSizeInBytes(e,0,0,l),P=new Uint8Array(A);if(!t.transcodeImage(P,e,0,0,l,0,-1,-1))throw new Error("Failed to transcode KTX2 image");return{width:h,height:c,data:P,compressed:p,levelSize:A,hasAlpha:s,format:v}}function hN(t,e){let i=t&&t.basis&&t.basis.format;return i==="auto"&&(i=dN()),typeof i=="object"&&(i=e?i.alpha:i.noAlpha),i=i.toLowerCase(),hJ[i]}function dN(){const t=lJ();return t.has("astc")?"astc-4x4":t.has("dxt")?{alpha:"bc3",noAlpha:"bc1"}:t.has("pvrtc")?{alpha:"pvrtc1-4-rgba",noAlpha:"pvrtc1-4-rgb"}:t.has("etc1")?"etc1":t.has("etc2")?"etc2":"rgb565"}const mJ={dataType:null,batchType:null,name:"Basis",id:"basis",module:"textures",version:qK,worker:!0,extensions:["basis","ktx2"],mimeTypes:["application/octet-stream","image/ktx2"],tests:["sB"],binary:!0,options:{basis:{format:"auto",libraryPath:"libs/",containerFormat:"auto",module:"transcoder"}}},_J={...mJ,parse:dJ};function iO(t){return t<.5?4*t*t*t:.5*Math.pow(2*t-2,3)+1}function gJ(t){const e=t-1;return e*e*e+1}function xv(t,{delay:e=0,duration:i=400,easing:s=sk}={}){const c=+getComputedStyle(t).opacity;return{delay:e,duration:i,easing:s,css:h=>`opacity: ${h*c}`}}function sl(t,{delay:e=0,duration:i=400,easing:s=gJ,x:c=0,y:h=0,opacity:p=0}={}){const v=getComputedStyle(t),l=+v.opacity,A=v.transform==="none"?"":v.transform,P=l*(1-p),[O,L]=a3(c),[U,H]=a3(h);return{delay:e,duration:i,easing:s,css:(Y,J)=>`
			transform: ${A} translate(${(1-Y)*O}${L}, ${(1-Y)*U}${H});
			opacity: ${l-P*J}`}}function rO(t){return Object.prototype.toString.call(t)==="[object Date]"}function HT(t,e){if(t===e||t!==t)return()=>t;const i=typeof t;if(i!==typeof e||Array.isArray(t)!==Array.isArray(e))throw new Error("Cannot interpolate values of different type");if(Array.isArray(t)){const s=e.map((c,h)=>HT(t[h],c));return c=>s.map(h=>h(c))}if(i==="object"){if(!t||!e)throw new Error("Object cannot be null");if(rO(t)&&rO(e)){t=t.getTime(),e=e.getTime();const h=e-t;return p=>new Date(t+p*h)}const s=Object.keys(e),c={};return s.forEach(h=>{c[h]=HT(t[h],e[h])}),h=>{const p={};return s.forEach(v=>{p[v]=c[v](h)}),p}}if(i==="number"){const s=e-t;return c=>t+c*s}throw new Error(`Cannot interpolate ${i} values`)}function qT(t,e={}){const i=r1(t);let s,c=t;function h(p,v){if(t==null)return i.set(t=p),Promise.resolve();c=p;let l=s,A=!1,{delay:P=0,duration:O=400,easing:L=sk,interpolate:U=HT}=l3(l3({},e),v);if(O===0)return l&&(l.abort(),l=null),i.set(t=c),Promise.resolve();const H=qz()+P;let Y;return s=Gz(J=>{if(J<H)return!0;A||(Y=U(t,p),typeof O=="function"&&(O=O(t,p)),A=!0),l&&(l.abort(),l=null);const oe=J-H;return oe>O?(i.set(t=p),!1):(i.set(t=Y(L(oe/O))),!0)}),s.promise}return{set:h,update:(p,v)=>h(p(c,t),v),subscribe:i.subscribe}}function yJ(t){console.log(t);let e=t.length;for(;e!=0;){let i=Math.floor(Math.random()*e);e--,[t[e],t[i]]=[t[i],t[e]]}}function vJ(t){let e,i,s,c;return{c(){e=Vt("div"),i=Vt("canvas"),this.h()},l(h){e=jt(h,"DIV",{class:!0});var p=$i(e);i=jt(p,"CANVAS",{width:!0,height:!0,style:!0,class:!0});var v=$i(i);v.forEach(bt),p.forEach(bt),this.h()},h(){tt(i,"width",s=t[1]*2),tt(i,"height",c=t[0]*2),An(i,"width",t[1]+"px"),An(i,"height",t[0]+"px"),An(i,"opacity",Math.max(t[2],1)),tt(i,"class","svelte-oi0wyw"),tt(e,"class","canvas-container svelte-oi0wyw"),Wo(e,"introFinished",t[4])},m(h,p){Zi(h,e,p),Et(e,i),t[18](i)},p(h,p){p&2&&s!==(s=h[1]*2)&&tt(i,"width",s),p&1&&c!==(c=h[0]*2)&&tt(i,"height",c),p&2&&An(i,"width",h[1]+"px"),p&1&&An(i,"height",h[0]+"px"),p&4&&An(i,"opacity",Math.max(h[2],1)),p&16&&Wo(e,"introFinished",h[4])},d(h){h&&bt(e),t[18](null)}}}function xJ(t){let e,i=t[5]&&vJ(t);return{c(){i&&i.c(),e=df()},l(s){i&&i.l(s),e=df()},m(s,c){i&&i.m(s,c),Zi(s,e,c)},p(s,[c]){s[5]&&i.p(s,c)},i:Es,o:Es,d(s){s&&bt(e),i&&i.d(s)}}}let bJ=1e4;function wJ(t,e){return[t,e]}function TJ(t,e,i){let s,c,h,p,v,l;const A=ok();let{sizes:P}=e,{geoJSON:O}=e,{courtData:L}=e,{viewportHeight:U}=e,{viewportWidth:H}=e,Y=Uw().domain([.2,1]).range([0,1]).exponent(10).clamp(!0),J=Uw().domain([0,1]).range([3,1]).exponent(.5).clamp(!0);yJ(L);let oe=L.map(it=>it.latLong);const me={type:"Sphere"};let pe=qT(0,{duration:bJ,easing:iO});Fc(t,pe,it=>i(2,v=it));let be=qT(0,{duration:2e3,easing:iO});Fc(t,be,it=>i(17,l=it)),kk(wJ).fitWidth(H*2,me).scale(1e3);let Oe,je,st,ut;t1(()=>{i(12,st=je.getContext("2d")),pe.set(1).then(()=>{i(11,Oe=!0),console.log("here"),be.set(1).then(()=>{i(4,ut=!0),A("finished",{text:"Hello!"})}),p()})});function xe(it){vw[it?"unshift":"push"](()=>{je=it,i(3,je)})}return t.$$set=it=>{"sizes"in it&&i(8,P=it.sizes),"geoJSON"in it&&i(9,O=it.geoJSON),"courtData"in it&&i(10,L=it.courtData),"viewportHeight"in it&&i(0,U=it.viewportHeight),"viewportWidth"in it&&i(1,H=it.viewportWidth)},t.$$.update=()=>{t.$$.dirty&7&&i(16,s=j6().fitWidth(U,me).rotate([110*J(v),-40]).translate([H,U]).scale(1e3*Math.max(v*1.5,.1)).precision(0)),t.$$.dirty&512&&i(15,c=O?pU(O,O.objects.land):null),t.$$.dirty&65536&&i(14,h=I6(s).pointRadius(2)),t.$$.dirty&253191&&i(13,p=()=>{st&&(st.clearRect(0,0,H*2,U*2),Oe&&H>500?(i(12,st.fillStyle=`rgba(54,53,49,${1-l})`,st),st.beginPath(),h.context(st),h(c),st.fill(),L.forEach((it,Be)=>{let Qe=pk(s(oe[Be]),it.coordinates.map(fi=>fi*2)),Ct=v_(1.5/2,P.size*2);i(12,st.fillStyle=it.color.slice(0,7),st);let Kt=Qe(l),Ie=Ct(l);st.beginPath(),st.rect(Kt[0],Kt[1],Ie,Ie),st.fill()})):(i(12,st.fillStyle="rgba(12,12,11,1)",st),st.beginPath(),h.context(st),h(me),st.fill(),i(12,st.fillStyle="rgba(54,53,49,1)",st),st.beginPath(),h.context(st),h(c),st.fill(),i(12,st.fillStyle="#7d6a51",st),st.beginPath(),h.context(st),h({type:"MultiPoint",coordinates:oe.slice(0,Math.floor(oe.length*Y(v)))}),st.fill()))}),t.$$.dirty&24576&&p()},[U,H,v,je,ut,oe,pe,be,P,O,L,Oe,st,p,h,c,s,l,xe]}class EJ extends Xc{constructor(e){super(),Zc(this,e,TJ,xJ,zl,{sizes:8,geoJSON:9,courtData:10,viewportHeight:0,viewportWidth:1})}}let SJ=function(t,e,i){var s,c,h=Math.ceil(Math.sqrt(t*e/i));Math.floor(h*i/e)*h<t?s=i/Math.ceil(h*i/e):s=e/h;var p=Math.ceil(Math.sqrt(t*i/e));return Math.floor(p*e/i)*p<t?c=e/Math.ceil(e*p/i):c=i/p,Math.max(s,c)};function AJ(t,e,i,s){let c,h=t,p=i,v=e,l;return l=SJ(p,h,v),c=l,c=Math.round(c*100)/100,{rowSize:Math.floor(h/c),size:c}}let MJ=function(t,e,i){var s,c,h=Math.ceil(Math.sqrt(t*e/i));Math.floor(h*i/e)*h<t?s=i/Math.ceil(h*i/e):s=e/h;var p=Math.ceil(Math.sqrt(t*i/e));return Math.floor(p*e/i)*p<t?c=e/Math.ceil(e*p/i):c=i/p,Math.max(s,c)};function CJ(t,e,i,s,c){if(c)return{rowSize:1e4,size:175};let h,p=t,v=i,l=e,A;return A=MJ(v,p,l),h=A,h=Math.round(h*100)/100,{rowSize:Math.floor(p/h),size:h}}const fN='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 218 52"><path id="color-stroke" fill="#3AE660" d="M212.5 10.8a5 5 0 0 0-2.2.5h-.3a6 6 0 0 0-3.8-.3 27 27 0 0 0-4.6 1.8h-.2l-1.2.6h-.2a32.2 32.2 0 0 1-2.1 1.3l-1.3.8h-.2c-.2-.4-.6-.7-1-1a43 43 0 0 0-2.8-2c-1.5-1-2.8-1.7-4.4-1.7-1 0-2.2.3-3.6.9h-.2a5.7 5.7 0 0 0-4.5-.5l-2.2.7c-.2.6-.4 1-.8 1.5-.1.2-.3.2-.4 0l-.5-.5c-.1-.2 0-.4.2-.5l1.5-.5a5.9 5.9 0 0 0-1.4-6l-2.6-2.6a5.8 5.8 0 0 0-7.6-.5h-.4a5.8 5.8 0 0 0-6-1.6l-6 1.9a4.8 4.8 0 0 0-2.3 7.8c.3.3.4.6.6 1v.6l-.6.2-1.3.7-1.2.6-.6.4c-.2.1-.4 0-.4-.2V6.7a5.8 5.8 0 0 0-7.6-5.5l-6 1.9a4.8 4.8 0 0 0-2.3 7.8l.6 1v.6l-.6.2h-.1l-1.2.7-1.2.6-1.2.8h-.2a5.8 5.8 0 0 0-7.2-3.6l-4.3 1.3h-.2a5.8 5.8 0 0 0-5.8-1.3l-2 .6c-.1 0-.3 0-.3-.2v-2a5.9 5.9 0 0 0-3.9-5.6l-1.3-.6-1-.4a23.5 23.5 0 0 0-3.5-1.4 25 25 0 0 0-2-.6c-.4-.2-1-.2-1.4-.2-1.3 0-2.8.3-4.6 1.1a45.6 45.6 0 0 0-2.3 1l-.2-.2-1-.5a9.3 9.3 0 0 0-1.6-.8c-.3-.1-.6-.3-1-.3-.5-.2-1-.3-1.6-.3a6.3 6.3 0 0 0-3.5 1l-.8.5a14 14 0 0 0-2 1.4l-1.2.9A23.6 23.6 0 0 0 72 7.9a14.4 14.4 0 0 0-1.5 2.3c-.4.7-.6 1.5-.6 2.3 0 .1 0 .2-.1 0a6.2 6.2 0 0 0-.9-.7 5 5 0 0 0-3-1c-.5 0-1 0-1.6.2a44.8 44.8 0 0 0-5.8 2.5l-2 1.2-1 .6c-.2.1-.3.1-.4 0l-.9-.8-2.8-2a8.1 8.1 0 0 0-4.4-1.7h-.4a.3.3 0 0 1-.4-.3V6.7a5.8 5.8 0 0 0-7.5-5.6l-4.1 1.3a5 5 0 0 0-2.6.8l-.5.3c-.1 0-.2.1-.2 0a18 18 0 0 1-3.7-.7l-5.7-1.5A102.8 102.8 0 0 0 14.7.1a8.5 8.5 0 0 0-3.4.9 16.7 16.7 0 0 0-3.7 2 31.8 31.8 0 0 0-4.5 3.7l-.8.8-.1.2-.8 1L.6 10c-.4.8-.6 1.7-.6 2.6 0 1.1.3 2.3.9 3.8l1.2 2.4a5 5 0 0 0 1.5 1.7v.4L3.3 23v.1a22.3 22.3 0 0 0 0 6l.1.1v.1a17.8 17.8 0 0 0 2.2 5.8c.5.8 1 1.5 1.6 2.1v.1l.2.2a15.8 15.8 0 0 0 4.3 3.3h.3a18.3 18.3 0 0 0 18-1.2h.1l.2-.2h.5a4.9 4.9 0 0 0 4.1 2.4h7.3c.5 0 .9 0 1.3-.2h.2l1.4.2h7.3c1.2 0 2.3-.4 3.2-1.1h.4l.2.1h.3l.9.5h.1a16.4 16.4 0 0 0 5.1 1.2c.7 0 1.5-.2 2.2-.5.3 0 .6-.2.9-.4.3-.2.7-.3 1-.6h.2l.7-.6 1-.7.7-.6 1-.9c.1 0 .3 0 .3.2a5 5 0 0 0 5 4.4 5 5 0 0 0 1.6-.3c.2 0 .4.1.3.3v.1l-.3.6-.1.2v.3l-.3.4a4.9 4.9 0 0 0 4.4 7h9a4.9 4.9 0 0 0 4.4-7l-.3-.8v-.1a8 8 0 0 1-.3-.6v-.1l-.2-.4a12 12 0 0 0 2.8-1.4l1.3-.7.1-.1 1.6-1 1.8-1 2-1V37h.1c.2-.1.3 0 .4 0 .4.7.9 1.2 1.4 1.7l2.8 2c1.7 1 3 1.7 4.5 1.7 1.1 0 2.3-.4 3.7-1h.3a5.7 5.7 0 0 0 3.9.5l6-1.4h.6l.3.2h.1c1.7 1 3 1.7 4.4 1.7 1.2 0 2.3-.4 3.8-1.1h.3a5.6 5.6 0 0 0 4 .6l6-1.4h.5l.3.2h.1c1.7 1 3 1.7 4.4 1.7 1.2 0 2.3-.4 3.8-1.1h.3a5.7 5.7 0 0 0 4 .6l4-1h.3c.7.5 1.6.8 2.5.8h7.4c.4 0 .7 0 1.1-.2h.2l1.3.2h7.3c.5 0 1 0 1.4-.2h.2l1.3.2h4.2c.1 0 .3.2.2.3v.6c.1 1.7.9 3.2 2.1 4.3l2.7 2c2.1 1.6 4 2.4 6 2.4.5 0 1 0 1.6-.2l1.7-.5 1.2-.5 1.5-.8a17 17 0 0 0 2.6-1.7 16 16 0 0 0 2.6-2.1 15.2 15.2 0 0 0 4.2-5.9l.3-2.1V15.7a5 5 0 0 0-5-5ZM78 27.8l-.1.3a16.8 16.8 0 0 0-3.4 2.5c-.1.2-.4.1-.5 0a4.9 4.9 0 0 0-4.6-3.3c-.2 0-.3-.2-.2-.3l2.4-1.7a6 6 0 0 0 2.4-3.8c0-.3.2-.4.4-.3l1.3.5c.2 0 .3.1.3.3v.4c0 1.5.6 3 1.7 4.1l.3.3v1Z"/><path id="color-stroke" fill="#3AE660" d="m78.1 27.8-.1.3a16.8 16.8 0 0 0-3.4 2.5c-.1.2-.4.1-.5 0a4.9 4.9 0 0 0-4.6-3.3c-.2 0-.3-.2-.2-.3l2.4-1.7a6 6 0 0 0 2.4-3.8c0-.3.2-.4.4-.3l1.3.5c.2 0 .3.1.3.3v.4c0 1.5.6 3 1.7 4.1l.3.3v1ZM177.7 12c-.2.6-.6 1.2-1 1.8a4 4 0 0 0-1-1.2l2-.7Z"/><path id="color-stroke" fill="#3AE660" d="M177.7 12c-.2.6-.6 1.2-1 1.8a4 4 0 0 0-1-1.2l2-.7Z"/><path fill="#111" d="M168.8 13.4c.5.4 1.1.4 1.5 0l2.6-2.6c.4-.4.4-1 0-1.5l-2.6-2.6a1 1 0 0 0-1.5 0l-2.5 2.6a1 1 0 0 0 0 1.5l2.5 2.6ZM19.2 31l3.7-2c.3-.3.5-.6.5-1V14.2a1 1 0 0 0-1.5-.9l-3.7 2a1 1 0 0 0-.5 1V30a1 1 0 0 0 1.5 1Z"/><path fill="#111" d="m51.8 33.5-.2-4.6V19a1 1 0 0 0-.4-.8 36.2 36.2 0 0 0-4.3-2.7 6 6 0 0 0-2.3.7l-1.6 1c-.7.3-1.6-.2-1.6-1V6.7a1 1 0 0 0-1.4-1l-5 1.6h-.2c0-.1-.2-.1-.2 0l-.2.1-.2.1-.3.1v.2l-.7.3c-.5.2-1 .3-1.6.3-.4 0-1 0-1.8-.2l-3.5-.8L20.7 6a98 98 0 0 0-6-1.1L14 5c-.3 0-.5.2-.8.3a11.4 11.4 0 0 0-1.8 1 16.5 16.5 0 0 0-2 1.5 29.6 29.6 0 0 0-2.9 2.4l-.7.7a11 11 0 0 0-.9 1.3l-.1.4c0 .4.1 1 .5 1.9l1 2c.3.5 1 .7 1.4.4l2.6-1.4c.5-.3.7-1 .4-1.4l-2-3.7c-.5-1-.6-1.6-.3-1.6a1653.6 1653.6 0 0 1 8.1 1.8l5.7 1.4 1.8.5.7.2c.4.1.8.5.8 1V32c0 .6-.4 1-1 1h-.2l-1.2.1c-3.2 0-5.7-.8-7.5-2.6-1.7-1.7-2.6-4.3-2.6-8 0-1.4.2-2.9.5-4.5.4-1.6 1.1-3 2.2-4.5v-.1h-.2a14.5 14.5 0 0 0-2.2 1.3A21.2 21.2 0 0 0 11 17a21.4 21.4 0 0 0-2 3 14.9 14.9 0 0 0-.5 10.7 11 11 0 0 0 9.2 7.1 12.7 12.7 0 0 0 12-4.6l1-1.3a11 11 0 0 0 1.4-2.5.2.2 0 0 0-.4-.2 10.7 10.7 0 0 1-4.3 3.2c-.7.3-1.3-.2-1.3-.9V14.2c0-.6.5-1 1.1-1l1 .2c.8 0 1.8-.6 3-1.7a23 23 0 0 0 2.1-2.3c.5-.5 1.3-.5 1.6.1l.3.7c.4 1 .6 2.2.6 3.6V29a26.4 26.4 0 0 1-1 7.9h7.5a16 16 0 0 1-.8-3.4l-.2-4.5v-9.3a5.8 5.8 0 0 0 0-.6l.1-.2v-.3h.1l.2-.2h.1c.5 0 1.1.3 1.9.9l2 1.5c.3.2.4.5.4.8V29c0 1.7 0 3.2-.2 4.4a13 13 0 0 1-.8 3.4v.1h7.4a16 16 0 0 1-.7-3.4Zm17.6-1.4a9.4 9.4 0 0 1-3 1.7 16.9 16.9 0 0 1-5.2-1.6 1 1 0 0 1-.5-1v-3.4c0-.4.2-.7.4-.9l7.8-5.5c.5-.3.6-1 .3-1.3A21.3 21.3 0 0 0 67 17a5.5 5.5 0 0 0-.7-1 2.2 2.2 0 0 0-.4-.4h-.6l-.7.3a50.5 50.5 0 0 0-3.7 1.7l-1 .6-1 .6c-.4.2-.8.4-1 .7l-1 .6a15.6 15.6 0 0 0-1.2 1l-.3.5-.2.4v12c0 .3.2.6.4.8l.6.4 1 .6a36.6 36.6 0 0 1 2.1 1 10 10 0 0 0 2 .5 5.6 5.6 0 0 0 1.4.3l.4-.1.5-.3.7-.3.6-.5.8-.6.8-.6.8-.6.7-.7a12.6 12.6 0 0 0 1.2-1.1l.4-.4V32h-.2Zm-8.7-9.5v-4.5h.1V18h.1c.3 0 .8.5 1.6 1.6l2 3c.3.5.2 1.1-.2 1.5l-2 1.3a1 1 0 0 1-1.6-.8v-2Zm132.4 10.8L193 29V19a1 1 0 0 0-.4-.8 36.1 36.1 0 0 0-4.3-2.7c-.5 0-1.2.2-2.3.8l-2 1a1 1 0 0 1-1.4-.7c0-.7-.6-1.1-1.2-1l-6 2-.1.1v.1c.6.7 1.1 1.5 1.5 2.5.3 1 .5 2.1.5 3.6v5c0 1.8 0 3.3-.2 4.5-.1 1-.4 2.2-.8 3.3l.1.1h7.3c-.4-1.2-.7-2.3-.8-3.5-.2-1.2-.2-2.6-.2-4.4v-9.4a5.7 5.7 0 0 0 0-.8 1.1 1.1 0 0 1 .2-.4h.3c.5 0 1 .2 1.8.8l2 1.5c.3.2.5.5.5.8V29c0 1.7 0 3.2-.2 4.4-.2 1.2-.4 2.3-.8 3.4v.1h7.4a16 16 0 0 1-.8-3.4Zm19.4-17.8h-.1l-1.2 1a1 1 0 0 1-1.2.1 18.2 18.2 0 0 0-2.3-1.1h-.6l-.7.3a34.8 34.8 0 0 0-4 1.7 34.2 34.2 0 0 1-2 1.2c-.4.2-.8.4-1 .7a23.5 23.5 0 0 0-2.3 1.7l-.4.5-.1.3v12c0 .3.1.6.4.8a40 40 0 0 0 2.6 1.9c1 .6 1.6.9 2 .9a34.5 34.5 0 0 0 4-1.9c.6-.5 1.5 0 1.5.9v7.1l-.2.1h-.6l-.6-.3-.7-.4a15.7 15.7 0 0 1-2.7-1.8l-.9-.7-.8-.7a18.8 18.8 0 0 1-.8-.7 1 1 0 0 0-1.4.1l-2.4 2.3a1 1 0 0 0 0 1.6l2.6 2c1.2.8 2.2 1.3 3 1.3h.7l1-.4 1-.4 1-.6 1.1-.6 1.1-.8a11.4 11.4 0 0 0 2.2-1.7l1-1a7.7 7.7 0 0 0 1.3-1.8l.5-1V15.7ZM207 29.3V32a8.7 8.7 0 0 1 0 1.5v.4l-.1.2v.3h-.3c-.6 0-1.2-.2-2-.7l-2.2-1.3a1 1 0 0 1-.4-.9V19.3a5.7 5.7 0 0 0 0-.6 4.7 4.7 0 0 1 .2-.6V18h.4c.4 0 1 .3 1.9 1l2.1 1.6c.3.2.4.5.4.9v7.8ZM102.8 8.5a38.8 38.8 0 0 1-1.5-.6l-1.2-.5a19.6 19.6 0 0 0-2.1-1 15.6 15.6 0 0 0-2.8-.9A56 56 0 0 0 88.8 8c-.4.3-.8.2-1.2 0l-.2-.2a21.3 21.3 0 0 0-4.5-2.2h-.5l-.6.4a7 7 0 0 0-.7.4 9.8 9.8 0 0 0-1.7 1.1l-.9.7a18.4 18.4 0 0 0-2.3 2.2 13.3 13.3 0 0 0-1.4 1.7l-.1.2v.2c0 .5 0 1.1.4 2l1 2c.3.5 1 .7 1.5.4l2.6-1.5c.5-.2.7-.9.4-1.4a53.5 53.5 0 0 1-2.3-5.2l1.7.8 2.5 1.6c.3.2.5.5.5.9v7.4l-.4.7-1.4 1.4a1 1 0 0 0 0 1.5l1.4 1.5c.2.1.4.4.4.7v6c0 .2-.3.4-.6.4H82c-.7 0-1.7.5-3 1.5s-2.4 2.4-3.5 4.5l.1.2h.2c.5-.5.9-1 1.3-1.2.5-.4 1-.6 1.7-.6a74.7 74.7 0 0 1 3.2.3c.6.1 1 .6 1 1v.8a19.6 19.6 0 0 1-.3 3.5l-.1 1a8.8 8.8 0 0 1-.5 1.7l-.4 1-.4 1v.1h9.1v-.1a16.9 16.9 0 0 1-1.5-4.7v-1l-.2-1.2v-1.3c0-.3.3-.5.6-.5a36.4 36.4 0 0 0 2 .3c.2 0 .4 0 .7-.2a12.4 12.4 0 0 0 2.2-1 47.9 47.9 0 0 1 3-1.8 734 734 0 0 1 5.7-3c.3-.2.6-.6.6-1V9.5a1 1 0 0 0-.7-1ZM90.8 32c0 .6-.5 1-1 .9h-.2c-.5-.2-.9-.6-.9-1.1v-22a5.7 5.7 0 0 0 0-.6l.1-.1v-.4h.1l.2-.2h.2l.6.1.2.1c.5.1.8.5.8 1V32Zm6.9-2.2V33a3.7 3.7 0 0 1 0 .7l-.1.1v.3l-.1.1-.2.1H97c-.2 0-1 0-2-.3l-2.8-.6a1 1 0 0 1-.8-1v-7.2c0-.5.3-.9.8-1l4-1.2a1 1 0 0 1 1.4 1v5.8Zm0-8.6c0 .5-.3.9-.8 1l-4 1.2a1 1 0 0 1-1.4-1v-.9c0-.4.3-.8.8-1l4-1.2a1 1 0 0 1 1.4 1v1Zm0-3.7c0 .5-.3.9-.8 1l-4 1.2a1 1 0 0 1-1.4-1v-8a1 1 0 0 1 1.4-1l1.6.7 2.6 1.2c.4.1.6.5.6 1v5ZM173 33.4a28 28 0 0 1-.3-4.5V16.7a1 1 0 0 0-1.4-1l-6 2-.1.2v.1c.7.7 1.1 1.6 1.5 2.5.3 1 .5 2.1.5 3.6v4.8a27.3 27.3 0 0 1-1 7.9h7.5l-.8-3.4Zm-47.7 2-.2-.2-.3-.4-.4-.6a21.8 21.8 0 0 1-.5-1.4l-.1-1-.1-1.3V16.7a1 1 0 0 0-1.4-1l-6 2-.1.2v.1c.7.7 1.2 1.6 1.5 2.5.3 1 .5 2.1.5 3.6V32a8.7 8.7 0 0 1 0 1.4v.2l-.1.3a4.8 4.8 0 0 0 0 .3.5.5 0 0 1-.1.2h-.3c-.5 0-1-.2-1.8-.6l-2-1.4a1 1 0 0 1-.5-.8V16.8a1 1 0 0 0-1.3-1l-6 1.9c-.1 0-.2 0-.2.2l.1.1c.6.7 1.1 1.6 1.4 2.5.4 1 .5 2.1.5 3.6v10c0 .3.2.6.4.8a44 44 0 0 0 4.4 2.7 37.6 37.6 0 0 0 4.3-2c.6-.5 1.4 0 1.4.7 0 .6.6 1 1.2.9l6-1.4h.1l-.4-.4Zm19.5 0-.2-.2-.3-.4-.3-.5v-.1a15.4 15.4 0 0 1-.5-1.4 49.8 49.8 0 0 1-.3-2l-.1-1.3V6.7a1 1 0 0 0-1.4-1l-6 2c.6.8 1 1.6 1.4 2.5.3 1 .5 2.2.5 3.7v1c0 .5-.3.8-.7 1a35.9 35.9 0 0 0-4 1.7l-1 .6a23 23 0 0 0-2 1.3 25 25 0 0 0-2.3 1.7l-.4.4V34c0 .3 0 .6.3.8l2.6 1.9c1 .6 1.6.9 2 .9a6 6 0 0 0 2.3-1l2-1.2a1 1 0 0 1 1.4.8c0 .7.6 1.1 1.2 1l6.1-1.4v-.1l-.3-.3Zm-7.2-6.1V32a8.7 8.7 0 0 1 0 1.5v.4l-.1.2v.3h-.4a4 4 0 0 1-2-.7l-2.2-1.3a1 1 0 0 1-.4-.9V19.3a5.7 5.7 0 0 0 0-.6 4.7 4.7 0 0 1 .2-.6V18h.4c.4 0 1 .3 1.9 1l2.1 1.6c.3.2.4.5.4.9v7.8Zm26.6 6.1-.2-.2-.3-.4-.3-.5v-.1a15.3 15.3 0 0 1-.5-1.4 49.8 49.8 0 0 1-.3-2V6.7a1 1 0 0 0-1.4-1l-6.1 2c.6.8 1 1.6 1.4 2.5.4 1 .5 2.2.5 3.7v1c0 .5-.3.8-.7 1a36.3 36.3 0 0 0-4 1.7l-1 .6a23 23 0 0 0-2 1.3 25 25 0 0 0-2.3 1.7c-.2.2-.3.3-.3.5l-.2.3v12c0 .3.2.6.4.8l2.6 1.9c1 .6 1.7.9 2 .9a6 6 0 0 0 2.3-1l2-1.2a1 1 0 0 1 1.5.8c0 .7.5 1.1 1.1 1l6.1-1.4v-.1l-.3-.3Zm-7.2-6.1V32a8.7 8.7 0 0 1 0 1.5v.6l-.1.1a.4.4 0 0 1-.1.2h-.3c-.4 0-1-.2-2-.7l-2-1.3a1 1 0 0 1-.5-.9V19.3a5.7 5.7 0 0 0 0-.6 4.7 4.7 0 0 1 .2-.6l.1-.1h.3c.5 0 1 .3 1.9 1l2.2 1.6c.2.2.3.5.3.9v7.8Z"/></svg>',bv=r1(!1),u_=r1(!1),x0=r1(!1);function PJ(t){let e,i,s="Close",c,h,p='By <a target="_blank" href="https://pudding.cool/author/matt-daniels/" class="svelte-ctrkxl">Matthew Daniels</a>, for visual journalism publication <a href="https://pudding.cool/" class="svelte-ctrkxl">The Pudding</a>.',v,l,A="Reach out at matt@pudding.cool",P,O,L='Court Locations via <a href="https://www.openstreetmap.org/#map=4/38.01/-95.84" class="svelte-ctrkxl">Open Street Map</a>. Satellite imagery via Google. Notable prior art in satellite imagery: Joshua Begley’s <a href="https://www.studioptcd.com/reference-projects/prison-map" target="_blank" class="svelte-ctrkxl">Prison Map</a> (currently offline), <a href="https://theintercept.co/officer-involved/" target="_blank" class="svelte-ctrkxl">Officer Involved</a>, and <a href="https://projects.theintercept.com/fatal-migrations/" target="_blank" class="svelte-ctrkxl">Fatal Migrations</a>, as well as Jenny Odell’s <a href="https://www.jennyodell.com/satellite.html" target="_blank" class="svelte-ctrkxl">Satellite Collections</a>.',U,H,Y='If you like this project, consider supporting <a href="https://www.instagram.com/project_backboard/" target="_blank" class="svelte-ctrkxl">Project Backboard</a>, a non-profit that painted/renovated many of the courts seen in the satellite imagery.',J,oe;return{c(){e=Vt("div"),i=Vt("button"),i.textContent=s,c=or(),h=Vt("p"),h.innerHTML=p,v=or(),l=Vt("p"),l.textContent=A,P=or(),O=Vt("p"),O.innerHTML=L,U=or(),H=Vt("p"),H.innerHTML=Y,this.h()},l(me){e=jt(me,"DIV",{class:!0});var pe=$i(e);i=jt(pe,"BUTTON",{class:!0,"data-svelte-h":!0}),rn(i)!=="svelte-bxc8wg"&&(i.textContent=s),c=ar(pe),h=jt(pe,"P",{class:!0,"data-svelte-h":!0}),rn(h)!=="svelte-1efp8n3"&&(h.innerHTML=p),v=ar(pe),l=jt(pe,"P",{class:!0,"data-svelte-h":!0}),rn(l)!=="svelte-ks3mf2"&&(l.textContent=A),P=ar(pe),O=jt(pe,"P",{class:!0,"data-svelte-h":!0}),rn(O)!=="svelte-1x3vttr"&&(O.innerHTML=L),U=ar(pe),H=jt(pe,"P",{class:!0,"data-svelte-h":!0}),rn(H)!=="svelte-b5tmh1"&&(H.innerHTML=Y),pe.forEach(bt),this.h()},h(){tt(i,"class","close svelte-ctrkxl"),tt(h,"class","svelte-ctrkxl"),tt(l,"class","svelte-ctrkxl"),tt(O,"class","svelte-ctrkxl"),tt(H,"class","svelte-ctrkxl"),tt(e,"class","about svelte-ctrkxl")},m(me,pe){Zi(me,e,pe),Et(e,i),Et(e,c),Et(e,h),Et(e,v),Et(e,l),Et(e,P),Et(e,O),Et(e,U),Et(e,H),J||(oe=Ss(i,"click",t[0]),J=!0)},p:Es,i:Es,o:Es,d(me){me&&bt(e),J=!1,oe()}}}function IJ(t,e,i){let s;Fc(t,bv,h=>i(1,s=h));function c(){Rc(bv,s=!1,s)}return[c]}class RJ extends Xc{constructor(e){super(),Zc(this,e,IJ,PJ,zl,{})}}var pN={exports:{}};(function(t,e){var i={};(function(s,c){t.exports=c()})(oh,function(){var s,c,h;function p(l,A){if(!s)s=A;else if(!c)c=A;else{var P="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+s+")(sharedChunk); ("+c+")(sharedChunk); self.onerror = null;",O={};s(O),h=A(O),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(h.workerUrl=window.URL.createObjectURL(new Blob([P],{type:"text/javascript"})))}}p(["exports"],function(l){var A="3.3.0";let P;const O={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(P==null){const n=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{P=i.API_URL_REGEX!=null?new RegExp(i.API_URL_REGEX):n}catch{P=n}}return P},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!O.API_URL)return null;try{const n=new URL(O.API_URL);return n.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":n.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"};function L(n){return O.API_URL_REGEX.test(n)}function U(n){return n.indexOf("mapbox:")===0}function H(n){return O.API_CDN_URL_REGEX.test(n)}function Y(n){return O.API_SPRITE_REGEX.test(n)}function J(n){return O.API_STYLE_REGEX.test(n)&&!Y(n)}const oe={create:"create",load:"load",fullLoad:"fullLoad"};function me(n){const r=n.name.split("?")[0];return H(r)&&r.includes("mapbox-gl.js")?"javascript":H(r)&&r.includes("mapbox-gl.css")?"css":function(o){return O.API_FONTS_REGEX.test(o)}(r)?"fontRange":Y(r)?"sprite":J(r)?"style":function(o){return O.API_TILEJSON_REGEX.test(o)}(r)?"tilejson":"other"}function pe(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var be=Oe;function Oe(n,r,o,u){this.cx=3*n,this.bx=3*(o-n)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*r,this.by=3*(u-r)-this.cy,this.ay=1-this.cy-this.by,this.p1x=n,this.p1y=r,this.p2x=o,this.p2y=u}Oe.prototype={sampleCurveX:function(n){return((this.ax*n+this.bx)*n+this.cx)*n},sampleCurveY:function(n){return((this.ay*n+this.by)*n+this.cy)*n},sampleCurveDerivativeX:function(n){return(3*this.ax*n+2*this.bx)*n+this.cx},solveCurveX:function(n,r){if(r===void 0&&(r=1e-6),n<0)return 0;if(n>1)return 1;for(var o=n,u=0;u<8;u++){var f=this.sampleCurveX(o)-n;if(Math.abs(f)<r)return o;var m=this.sampleCurveDerivativeX(o);if(Math.abs(m)<1e-6)break;o-=f/m}var y=0,b=1;for(o=n,u=0;u<20&&(f=this.sampleCurveX(o),!(Math.abs(f-n)<r));u++)n>f?y=o:b=o,o=.5*(b-y)+y;return o},solve:function(n,r){return this.sampleCurveY(this.solveCurveX(n,r))}};var je=pe(be),st=ut;function ut(n,r){this.x=n,this.y=r}ut.prototype={clone:function(){return new ut(this.x,this.y)},add:function(n){return this.clone()._add(n)},sub:function(n){return this.clone()._sub(n)},multByPoint:function(n){return this.clone()._multByPoint(n)},divByPoint:function(n){return this.clone()._divByPoint(n)},mult:function(n){return this.clone()._mult(n)},div:function(n){return this.clone()._div(n)},rotate:function(n){return this.clone()._rotate(n)},rotateAround:function(n,r){return this.clone()._rotateAround(n,r)},matMult:function(n){return this.clone()._matMult(n)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(n){return this.x===n.x&&this.y===n.y},dist:function(n){return Math.sqrt(this.distSqr(n))},distSqr:function(n){var r=n.x-this.x,o=n.y-this.y;return r*r+o*o},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(n){return Math.atan2(this.y-n.y,this.x-n.x)},angleWith:function(n){return this.angleWithSep(n.x,n.y)},angleWithSep:function(n,r){return Math.atan2(this.x*r-this.y*n,this.x*n+this.y*r)},_matMult:function(n){var r=n[2]*this.x+n[3]*this.y;return this.x=n[0]*this.x+n[1]*this.y,this.y=r,this},_add:function(n){return this.x+=n.x,this.y+=n.y,this},_sub:function(n){return this.x-=n.x,this.y-=n.y,this},_mult:function(n){return this.x*=n,this.y*=n,this},_div:function(n){return this.x/=n,this.y/=n,this},_multByPoint:function(n){return this.x*=n.x,this.y*=n.y,this},_divByPoint:function(n){return this.x/=n.x,this.y/=n.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var n=this.y;return this.y=this.x,this.x=-n,this},_rotate:function(n){var r=Math.cos(n),o=Math.sin(n),u=o*this.x+r*this.y;return this.x=r*this.x-o*this.y,this.y=u,this},_rotateAround:function(n,r){var o=Math.cos(n),u=Math.sin(n),f=r.y+u*(this.x-r.x)+o*(this.y-r.y);return this.x=r.x+o*(this.x-r.x)-u*(this.y-r.y),this.y=f,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},ut.convert=function(n){return n instanceof ut?n:Array.isArray(n)?new ut(n[0],n[1]):n};var xe=pe(st);const it=Math.PI/180,Be=180/Math.PI;function Qe(n){return n*it}function Ct(n){return n*Be}const Kt=[[0,0],[1,0],[1,1],[0,1]];function Ie(n){if(n<=0)return 0;if(n>=1)return 1;const r=n*n,o=r*n;return 4*(n<.5?o:3*(n-r)+o-.75)}function fi(n,r,o,u){const f=new je(n,r,o,u);return function(m){return f.solve(m)}}const Yi=fi(.25,.1,.25,1);function ri(n,r,o){return Math.min(o,Math.max(r,n))}function vr(n,r,o){return(o=ri((o-n)/(r-n),0,1))*o*(3-2*o)}function Gr(n,r,o){const u=o-r,f=((n-r)%u+u)%u+r;return f===r?o:f}function Tr(n,r,o){if(!n.length)return o(null,[]);let u=n.length;const f=new Array(n.length);let m=null;n.forEach((y,b)=>{r(y,(T,E)=>{T&&(m=T),f[b]=E,--u==0&&o(m,f)})})}function Ar(n,...r){for(const o of r)for(const u in o)n[u]=o[u];return n}let kr=1;function $r(){return kr++}function Vn(){return function n(r){return r?(r^Math.random()*(16>>r/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,n)}()}function Pn(n){return n<=1?1:Math.pow(2,Math.ceil(Math.log(n)/Math.LN2))}function Si(n){return!!n&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(n)}function Ir(n,r){n.forEach(o=>{r[o]&&(r[o]=r[o].bind(r))})}function Er(n,r){return n.indexOf(r,n.length-r.length)!==-1}function Ki(n,r,o){const u={};for(const f in n)u[f]=r.call(o||this,n[f],f,n);return u}function In(n,r,o){const u={};for(const f in n)r.call(o||this,n[f],f,n)&&(u[f]=n[f]);return u}function gn(n){return Array.isArray(n)?n.map(gn):typeof n=="object"&&n?Ki(n,gn):n}const Kn={};function mr(n){Kn[n]||(typeof console<"u"&&console.warn(n),Kn[n]=!0)}function cn(n,r,o){return(o.y-n.y)*(r.x-n.x)>(r.y-n.y)*(o.x-n.x)}function Dr(n){let r=0;for(let o,u,f=0,m=n.length,y=m-1;f<m;y=f++)o=n[f],u=n[y],r+=(u.x-o.x)*(o.y+u.y);return r}function yn([n,r,o]){const u=Qe(r+90),f=Qe(o);return{x:n*Math.cos(u)*Math.sin(f),y:n*Math.sin(u)*Math.sin(f),z:n*Math.cos(f),azimuthal:r,polar:o}}function Rn(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function ir(n){const r={};if(n.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(o,u,f,m)=>{const y=f||m;return r[u]=!y||y.toLowerCase(),""}),r["max-age"]){const o=parseInt(r["max-age"],10);isNaN(o)?delete r["max-age"]:r["max-age"]=o}return r}let Ni,_r,Ur,Cr,Oi,Nr,Ke=null;function ie(n){try{const r=self[n];return r.setItem("_mapbox_test_",1),r.removeItem("_mapbox_test_"),!0}catch{return!1}}function he(n,r){return[n[4*r],n[4*r+1],n[4*r+2],n[4*r+3]]}function Te(n,r,o,u){for(;r<o;){const f=r+o>>1;n[f]<u?r=f+1:o=f}return r}function Xe(n,r,o,u){for(;r<o;){const f=r+o>>1;n[f]<=u?r=f+1:o=f}return r}function Je(){return Ni==null&&(Ni=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),Ni}const lt={now:()=>Cr!==void 0?Cr:performance.now(),setNow(n){Cr=n},restoreNow(){Cr=void 0},frame(n){const r=requestAnimationFrame(n);return{cancel:()=>cancelAnimationFrame(r)}},getImageData(n,r=0){const{width:o,height:u}=n;Oi||(Oi=document.createElement("canvas"));const f=Oi.getContext("2d",{willReadFrequently:!0});if(!f)throw new Error("failed to create canvas 2d context");return(o>Oi.width||u>Oi.height)&&(Oi.width=o,Oi.height=u),f.clearRect(-r,-r,o+2*r,u+2*r),f.drawImage(n,0,0,o,u),f.getImageData(-r,-r,o+2*r,u+2*r)},resolveURL:n=>(_r||(_r=document.createElement("a")),_r.href=n,_r.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Ur==null&&(Ur=window.matchMedia("(prefers-reduced-motion: reduce)")),Ur.matches)},hasCanvasFingerprintNoise(){if(Nr!==void 0)return Nr;if(!Je())return Nr=!1,!1;const n=new OffscreenCanvas(85,1),r=n.getContext("2d",{willReadFrequently:!0});let o=0;for(let f=0;f<n.width;++f)r.fillStyle=`rgba(${o++},${o++},${o++}, 255)`,r.fillRect(f,0,1,1);const u=r.getImageData(0,0,n.width,n.height);o=0;for(let f=0;f<u.data.length;++f)if(f%4!=3&&o++!==u.data[f])return Nr=!0,!0;return Nr=!1,!1}},It="mapbox-tiles";let Se=500,ot=50,xt,$t;function pi(){try{return caches}catch{}}function Wi(){const n=pi();n&&!xt&&(xt=n.open(It))}function xr(n){const r=n.indexOf("?");if(r<0)return n;const o=["language","worldview"],u=new URLSearchParams,f=new URLSearchParams(n.slice(r));for(const m of o){const y=f.get(m);y&&u.set(m,y)}return`${n.slice(0,r)}?${u.toString()}`}function Hi(n,r){const o=n.indexOf("?");if(o<0)return`${n}?${new URLSearchParams(r).toString()}`;const u=new URLSearchParams(n.slice(o));for(const f in r)u.set(f,r[f]);return`${n.slice(0,o)}?${u.toString()}`}let Ci=1/0;const zi={supported:!1,testSupport:function(n){!nn&&Rr&&(br?rs(n):er=n)}};let er,Rr,nn=!1,br=!1;const Ln=typeof self<"u"?self:{};function rs(n){const r=n.createTexture();n.bindTexture(n.TEXTURE_2D,r);try{if(n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,Rr),n.isContextLost())return;zi.supported=!0}catch{}n.deleteTexture(r),nn=!0}Ln.document&&(Rr=Ln.document.createElement("img"),Rr.onload=function(){er&&rs(er),er=null,br=!0},Rr.onerror=function(){nn=!0,er=null},Rr.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const ns={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(ns);class Yr extends Error{constructor(r,o,u){o===401&&L(u)&&(r+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(r),this.status=o,this.url=u}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const un=Rn()?()=>self.worker&&self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,et=function(n,r){if(!(/^file:/.test(o=n.url)||/^file:/.test(un())&&!/^\w+:/.test(o))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(u,f){const m=new AbortController,y=new Request(u.url,{method:u.method||"GET",body:u.body,credentials:u.credentials,headers:u.headers,referrer:un(),referrerPolicy:u.referrerPolicy,signal:m.signal});let b=!1,T=!1;const E=(M=y.url).indexOf("sku=")>0&&L(M);var M;u.type==="json"&&y.headers.set("Accept","application/json");const I=(F,z,V)=>{if(T)return;if(F&&F.message!=="SecurityError"&&mr(F.toString()),z&&V)return k(z);const W=Date.now();fetch(y).then(G=>{if(G.ok){const te=E?G.clone():null;return k(G,te,W)}return f(new Yr(G.statusText,G.status,u.url))}).catch(G=>{G.name!=="AbortError"&&f(new Error(`${G.message} ${u.url}`))})},k=(F,z,V)=>{(u.type==="arrayBuffer"?F.arrayBuffer():u.type==="json"?F.json():F.text()).then(W=>{T||(z&&V&&function(G,te,se){if(Wi(),!xt)return;const ne=ir(te.headers.get("Cache-Control")||"");if(ne["no-store"])return;const ye={status:te.status,statusText:te.statusText,headers:new Headers};te.headers.forEach((Pe,De)=>ye.headers.set(De,Pe)),ne["max-age"]&&ye.headers.set("Expires",new Date(se+1e3*ne["max-age"]).toUTCString());const de=ye.headers.get("Expires");if(!de||new Date(de).getTime()-se<42e4)return;let Ee=xr(G.url);if(te.status===206){const Pe=G.headers.get("Range");if(!Pe)return;ye.status=200,Ee=Hi(Ee,{range:Pe})}(function(Pe,De){if($t===void 0)try{new Response(new ReadableStream),$t=!0}catch{$t=!1}$t?De(Pe.body):Pe.blob().then(De)})(te,Pe=>{const De=new Response(Pe,ye);Wi(),xt&&xt.then(Ve=>Ve.put(Ee,De)).catch(Ve=>mr(Ve.message))})}(y,z,V),b=!0,f(null,W,F.headers.get("Cache-Control"),F.headers.get("Expires")))}).catch(W=>{T||f(new Error(W.message))})};return E?function(F,z){if(Wi(),!xt)return z(null);xt.then(V=>{let W=xr(F.url);const G=F.headers.get("Range");G&&(W=Hi(W,{range:G})),V.match(W).then(te=>{const se=function(ne){if(!ne)return!1;const ye=new Date(ne.headers.get("Expires")||0),de=ir(ne.headers.get("Cache-Control")||"");return ye>Date.now()&&!de["no-cache"]}(te);V.delete(W),se&&V.put(W,te.clone()),z(null,te,se)}).catch(z)}).catch(z)}(y,I):I(null,null),{cancel:()=>{T=!0,b||m.abort()}}}(n,r);if(Rn()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",n,r,void 0,!0)}var o;return function(u,f){const m=new XMLHttpRequest;m.open(u.method||"GET",u.url,!0),u.type==="arrayBuffer"&&(m.responseType="arraybuffer");for(const y in u.headers)m.setRequestHeader(y,u.headers[y]);return u.type==="json"&&(m.responseType="text",m.setRequestHeader("Accept","application/json")),m.withCredentials=u.credentials==="include",m.onerror=()=>{f(new Error(m.statusText))},m.onload=()=>{if((m.status>=200&&m.status<300||m.status===0)&&m.response!==null){let y=m.response;if(u.type==="json")try{y=JSON.parse(m.response)}catch(b){return f(b)}f(null,y,m.getResponseHeader("Cache-Control"),m.getResponseHeader("Expires"))}else f(new Yr(m.statusText,m.status,u.url))},m.send(u.body),{cancel:()=>m.abort()}}(n,r)},nt=function(n,r){return et(Ar(n,{type:"arrayBuffer"}),r)};function yt(n){const r=document.createElement("a");return r.href=n,r.protocol===location.protocol&&r.host===location.host}const St="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let wt,Dt;wt=[],Dt=0;const kt=function(n,r){if(zi.supported&&(n.headers||(n.headers={}),n.headers.accept="image/webp,*/*"),Dt>=O.MAX_PARALLEL_IMAGE_REQUESTS){const m={requestParameters:n,callback:r,cancelled:!1,cancel(){this.cancelled=!0}};return wt.push(m),m}Dt++;let o=!1;const u=()=>{if(!o)for(o=!0,Dt--;wt.length&&Dt<O.MAX_PARALLEL_IMAGE_REQUESTS;){const m=wt.shift(),{requestParameters:y,callback:b,cancelled:T}=m;T||(m.cancel=kt(y,b).cancel)}},f=nt(n,(m,y,b,T)=>{u(),m?r(m):y&&(self.createImageBitmap?function(E,M){const I=new Blob([new Uint8Array(E)],{type:"image/png"});createImageBitmap(I).then(k=>{M(null,k)}).catch(k=>{M(new Error(`Could not load image because of ${k.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(y,(E,M)=>r(E,M,b,T)):function(E,M){const I=new Image;I.onload=()=>{M(null,I),URL.revokeObjectURL(I.src),I.onload=null,requestAnimationFrame(()=>{I.src=St})},I.onerror=()=>M(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const k=new Blob([new Uint8Array(E)],{type:"image/png"});I.src=E.byteLength?URL.createObjectURL(k):St}(y,(E,M)=>r(E,M,b,T)))});return{cancel:()=>{f.cancel(),u()}}},vt="01",Ft="NO_ACCESS_TOKEN",At=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function ui(n){const r=n.match(At);if(!r)throw new Error("Unable to parse URL object");return{protocol:r[1],authority:r[2],path:r[3]||"/",params:r[4]?r[4].split("&"):[]}}function bi(n){const r=n.params.length?`?${n.params.join("&")}`:"";return`${n.protocol}://${n.authority}${n.path}${r}`}const Gt="mapbox.eventData";function hr(n){if(!n)return null;const r=n.split(".");if(!r||r.length!==3)return null;try{return JSON.parse(decodeURIComponent(atob(r[1]).split("").map(o=>"%"+("00"+o.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class Lr{constructor(r){this.type=r,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(r){const o=hr(O.ACCESS_TOKEN);let u="";return u=o&&o.u?btoa(encodeURIComponent(o.u).replace(/%([0-9A-F]{2})/g,(f,m)=>String.fromCharCode(+("0x"+m)))):O.ACCESS_TOKEN||"",r?`${Gt}.${r}:${u}`:`${Gt}:${u}`}fetchEventData(){const r=ie("localStorage"),o=this.getStorageKey(),u=this.getStorageKey("uuid");if(r)try{const f=localStorage.getItem(o);f&&(this.eventData=JSON.parse(f));const m=localStorage.getItem(u);m&&(this.anonId=m)}catch{mr("Unable to read from LocalStorage")}}saveEventData(){const r=ie("localStorage"),o=this.getStorageKey(),u=this.getStorageKey("uuid"),f=this.anonId;if(r&&f)try{localStorage.setItem(u,f),Object.keys(this.eventData).length>=1&&localStorage.setItem(o,JSON.stringify(this.eventData))}catch{mr("Unable to write to LocalStorage")}}processRequests(r){}postEvent(r,o,u,f){if(!O.EVENTS_URL)return;const m=ui(O.EVENTS_URL);m.params.push(`access_token=${f||O.ACCESS_TOKEN||""}`);const y={event:this.type,created:new Date(r).toISOString()},b=o?Ar(y,o):y,T={url:bi(m),headers:{"Content-Type":"text/plain"},body:JSON.stringify([b])};this.pendingRequest=function(E,M){return et(Ar(E,{method:"POST"}),M)}(T,E=>{this.pendingRequest=null,u(E),this.saveEventData(),this.processRequests(f)})}queueRequest(r,o){this.queue.push(r),this.processRequests(o)}}const Pr=new class extends Lr{constructor(n){super("appUserTurnstile"),this._customAccessToken=n}postTurnstileEvent(n,r){O.EVENTS_URL&&O.ACCESS_TOKEN&&Array.isArray(n)&&n.some(o=>U(o)||L(o))&&this.queueRequest(Date.now(),r)}processRequests(n){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const r=hr(O.ACCESS_TOKEN),o=r?r.u:O.ACCESS_TOKEN;let u=o!==this.eventData.tokenU;Si(this.anonId)||(this.anonId=Vn(),u=!0);const f=this.queue.shift();if(this.eventData.lastSuccess){const m=new Date(this.eventData.lastSuccess),y=new Date(f),b=(f-this.eventData.lastSuccess)/864e5;u=u||b>=1||b<-1||m.getDate()!==y.getDate()}else u=!0;u?this.postEvent(f,{sdkIdentifier:"mapbox-gl-js",sdkVersion:A,skuId:vt,"enabled.telemetry":!1,userId:this.anonId},m=>{m||(this.eventData.lastSuccess=f,this.eventData.tokenU=o)},n):this.processRequests()}},bn=Pr.postTurnstileEvent.bind(Pr),jn=new class extends Lr{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(n,r,o,u){this.skuToken=r,this.errorCb=u,O.EVENTS_URL&&(o||O.ACCESS_TOKEN?this.queueRequest({id:n,timestamp:Date.now()},o):this.errorCb(new Error(Ft)))}processRequests(n){if(this.pendingRequest||this.queue.length===0)return;const{id:r,timestamp:o}=this.queue.shift();r&&this.success[r]||(this.anonId||this.fetchEventData(),Si(this.anonId)||(this.anonId=Vn()),this.postEvent(o,{sdkIdentifier:"mapbox-gl-js",sdkVersion:A,skuId:vt,skuToken:this.skuToken,userId:this.anonId},u=>{u?this.errorCb(u):r&&(this.success[r]=!0)},n))}remove(){this.errorCb=null}},qi=jn.postMapLoadEvent.bind(jn),hn=new class extends Lr{constructor(){super("gljs.performance")}postPerformanceEvent(n,r){O.EVENTS_URL&&(n||O.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:r},n)}processRequests(n){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:r,performanceData:o}=this.queue.shift(),u=function(f){const m=performance.getEntriesByType("resource"),y=performance.getEntriesByType("mark"),b=function(F){const z={};if(F){for(const V in F)if(V!=="other")for(const W of F[V]){const G=`${V}ResolveRangeMin`,te=`${V}ResolveRangeMax`,se=`${V}RequestCount`,ne=`${V}RequestCachedCount`;z[G]=Math.min(z[G]||1/0,W.startTime),z[te]=Math.max(z[te]||-1/0,W.responseEnd);const ye=de=>{z[de]===void 0&&(z[de]=0),++z[de]};W.transferSize!==void 0&&W.transferSize===0&&ye(ne),ye(se)}}return z}(function(F,z){const V={};if(F)for(const W of F){const G=z(W);V[G]===void 0&&(V[G]=[]),V[G].push(W)}return V}(m,me)),T=window.devicePixelRatio,E=navigator.connection||navigator.mozConnection||navigator.webkitConnection,M=E?E.effectiveType:void 0,I={counters:[],metadata:[],attributes:[]},k=(F,z,V)=>{V!=null&&F.push({name:z,value:V.toString()})};for(const F in b)k(I.counters,F,b[F]);if(f.interactionRange[0]!==1/0&&f.interactionRange[1]!==-1/0&&(k(I.counters,"interactionRangeMin",f.interactionRange[0]),k(I.counters,"interactionRangeMax",f.interactionRange[1])),y)for(const F of Object.keys(oe)){const z=oe[F],V=y.find(W=>W.name===z);V&&k(I.counters,z,V.startTime)}return k(I.counters,"visibilityHidden",f.visibilityHidden),k(I.attributes,"style",function(F){if(F)for(const z of F){const V=z.name.split("?")[0];if(J(V)){const W=V.split("/").slice(-2);if(W.length===2)return`mapbox://styles/${W[0]}/${W[1]}`}}}(m)),k(I.attributes,"terrainEnabled",f.terrainEnabled?"true":"false"),k(I.attributes,"fogEnabled",f.fogEnabled?"true":"false"),k(I.attributes,"projection",f.projection),k(I.attributes,"zoom",f.zoom),k(I.metadata,"devicePixelRatio",T),k(I.metadata,"connectionEffectiveType",M),k(I.metadata,"navigatorUserAgent",navigator.userAgent),k(I.metadata,"screenWidth",window.screen.width),k(I.metadata,"screenHeight",window.screen.height),k(I.metadata,"windowWidth",window.innerWidth),k(I.metadata,"windowHeight",window.innerHeight),k(I.metadata,"mapWidth",f.width/T),k(I.metadata,"mapHeight",f.height/T),k(I.metadata,"webglRenderer",f.renderer),k(I.metadata,"webglVendor",f.vendor),k(I.metadata,"sdkVersion",A),k(I.metadata,"sdkIdentifier","mapbox-gl-js"),I}(o);for(const f of u.metadata);for(const f of u.counters);for(const f of u.attributes);this.postEvent(r,u,()=>{},n)}},ss=hn.postPerformanceEvent.bind(hn),sn=new class extends Lr{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(n,r,o,u){if(!O.API_URL||!O.SESSION_PATH)return;const f=ui(O.API_URL+O.SESSION_PATH);f.params.push(`sku=${r||""}`),f.params.push(`access_token=${u||O.ACCESS_TOKEN||""}`);const m={url:bi(f),headers:{"Content-Type":"text/plain"}};this.pendingRequest=function(y,b){return et(Ar(y,{method:"GET"}),b)}(m,y=>{this.pendingRequest=null,o(y),this.saveEventData(),this.processRequests(u)})}getSessionAPI(n,r,o,u){this.skuToken=r,this.errorCb=u,O.SESSION_PATH&&O.API_URL&&(o||O.ACCESS_TOKEN?this.queueRequest({id:n,timestamp:Date.now()},o):this.errorCb(new Error(Ft)))}processRequests(n){if(this.pendingRequest||this.queue.length===0)return;const{id:r,timestamp:o}=this.queue.shift();r&&this.success[r]||this.getSession(o,this.skuToken,u=>{u?this.errorCb(u):r&&(this.success[r]=!0)},n)}remove(){this.errorCb=null}},ws=sn.getSessionAPI.bind(sn),As=new Set;function hs(n,r,o){o[n]&&o[n].indexOf(r)!==-1||(o[n]=o[n]||[],o[n].push(r))}function ks(n,r,o){if(o&&o[n]){const u=o[n].indexOf(r);u!==-1&&o[n].splice(u,1)}}class lo{constructor(r,o={}){Ar(this,o),this.type=r}}class Ta extends lo{constructor(r,o={}){super("error",Ar({error:r},o))}}class eo{on(r,o){return this._listeners=this._listeners||{},hs(r,o,this._listeners),this}off(r,o){return ks(r,o,this._listeners),ks(r,o,this._oneTimeListeners),this}once(r,o){return o?(this._oneTimeListeners=this._oneTimeListeners||{},hs(r,o,this._oneTimeListeners),this):new Promise(u=>this.once(r,u))}fire(r,o){typeof r=="string"&&(r=new lo(r,o||{}));const u=r.type;if(this.listens(u)){r.target=this;const f=this._listeners&&this._listeners[u]?this._listeners[u].slice():[];for(const b of f)b.call(this,r);const m=this._oneTimeListeners&&this._oneTimeListeners[u]?this._oneTimeListeners[u].slice():[];for(const b of m)ks(u,b,this._oneTimeListeners),b.call(this,r);const y=this._eventedParent;y&&(Ar(r,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),y.fire(r))}else r instanceof Ta&&console.error(r.error);return this}listens(r){return!!(this._listeners&&this._listeners[r]&&this._listeners[r].length>0||this._oneTimeListeners&&this._oneTimeListeners[r]&&this._oneTimeListeners[r].length>0||this._eventedParent&&this._eventedParent.listens(r))}setEventedParent(r,o){return this._eventedParent=r,this._eventedParentData=o,this}}l.y=void 0;var Ms={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function xo(n){return(n=Math.round(n))<0?0:n>255?255:n}function Rt(n){return xo(n[n.length-1]==="%"?parseFloat(n)/100*255:parseInt(n))}function mi(n){return(r=n[n.length-1]==="%"?parseFloat(n)/100:parseFloat(n))<0?0:r>1?1:r;var r}function rr(n,r,o){return o<0?o+=1:o>1&&(o-=1),6*o<1?n+(r-n)*o*6:2*o<1?r:3*o<2?n+(r-n)*(2/3-o)*6:n}try{l.y={}.parseCSSColor=function(n){var r,o=n.replace(/ /g,"").toLowerCase();if(o in Ms)return Ms[o].slice();if(o[0]==="#")return o.length===4?(r=parseInt(o.substr(1),16))>=0&&r<=4095?[(3840&r)>>4|(3840&r)>>8,240&r|(240&r)>>4,15&r|(15&r)<<4,1]:null:o.length===7&&(r=parseInt(o.substr(1),16))>=0&&r<=16777215?[(16711680&r)>>16,(65280&r)>>8,255&r,1]:null;var u=o.indexOf("("),f=o.indexOf(")");if(u!==-1&&f+1===o.length){var m=o.substr(0,u),y=o.substr(u+1,f-(u+1)).split(","),b=1;switch(m){case"rgba":if(y.length!==4)return null;b=mi(y.pop());case"rgb":return y.length!==3?null:[Rt(y[0]),Rt(y[1]),Rt(y[2]),b];case"hsla":if(y.length!==4)return null;b=mi(y.pop());case"hsl":if(y.length!==3)return null;var T=(parseFloat(y[0])%360+360)%360/360,E=mi(y[1]),M=mi(y[2]),I=M<=.5?M*(E+1):M+E-M*E,k=2*M-I;return[xo(255*rr(k,I,T+1/3)),xo(255*rr(k,I,T)),xo(255*rr(k,I,T-1/3)),b];default:return null}}return null}}catch{}class zt{constructor(r,o,u,f=1){this.r=r,this.g=o,this.b=u,this.a=f}static parse(r){if(!r)return;if(r instanceof zt)return r;if(typeof r!="string")return;const o=l.y(r);return o?new zt(o[0]/255*o[3],o[1]/255*o[3],o[2]/255*o[3],o[3]):void 0}toString(){const[r,o,u,f]=this.toArray();return`rgba(${Math.round(r)},${Math.round(o)},${Math.round(u)},${f})`}toArray(){const{r,g:o,b:u,a:f}=this;return f===0?[0,0,0,0]:[255*r/f,255*o/f,255*u/f,f]}toArray01(){const{r,g:o,b:u,a:f}=this;return f===0?[0,0,0,0]:[r/f,o/f,u/f,f]}toArray01Scaled(r){const{r:o,g:u,b:f,a:m}=this;return m===0?[0,0,0]:[o/m*r,u/m*r,f/m*r]}toArray01PremultipliedAlpha(){const{r,g:o,b:u,a:f}=this;return[r,o,u,f]}toArray01Linear(){const{r,g:o,b:u,a:f}=this;return f===0?[0,0,0,0]:[Math.pow(r/f,2.2),Math.pow(o/f,2.2),Math.pow(u/f,2.2),f]}}zt.black=new zt(0,0,0,1),zt.white=new zt(1,1,1,1),zt.transparent=new zt(0,0,0,0),zt.red=new zt(1,0,0,1),zt.blue=new zt(0,0,1,1);var Qt=zt;function Ut(n,r,o){return n*(1-o)+r*o}function Pi(n,r,o){return n.map((u,f)=>Ut(u,r[f],o))}var dr=Object.freeze({__proto__:null,array:Pi,color:function(n,r,o){return new Qt(Ut(n.r,r.r,o),Ut(n.g,r.g,o),Ut(n.b,r.b,o),Ut(n.a,r.a,o))},number:Ut});function Sr(n,...r){for(const o of r)for(const u in o)n[u]=o[u];return n}class Qr extends Error{constructor(r,o){super(o),this.message=o,this.key=r}}var on=Qr;class $n{constructor(r,o=[]){this.parent=r,this.bindings={};for(const[u,f]of o)this.bindings[u]=f}concat(r){return new $n(this,r)}get(r){if(this.bindings[r])return this.bindings[r];if(this.parent)return this.parent.get(r);throw new Error(`${r} not found in scope.`)}has(r){return!!this.bindings[r]||!!this.parent&&this.parent.has(r)}}var ue=$n;const ge={kind:"null"},_e={kind:"number"},ze={kind:"string"},ft={kind:"boolean"},ni={kind:"color"},fr={kind:"object"},_i={kind:"value"},Wn={kind:"collator"},Hn={kind:"formatted"},Cs={kind:"resolvedImage"};function js(n,r){return{kind:"array",itemType:n,N:r}}function Nn(n){if(n.kind==="array"){const r=Nn(n.itemType);return typeof n.N=="number"?`array<${r}, ${n.N}>`:n.itemType.kind==="value"?"array":`array<${r}>`}return n.kind}const li=[ge,_e,ze,ft,ni,Hn,fr,js(_i),Cs];function al(n,r){if(r.kind==="error")return null;if(n.kind==="array"){if(r.kind==="array"&&(r.N===0&&r.itemType.kind==="value"||!al(n.itemType,r.itemType))&&(typeof n.N!="number"||n.N===r.N))return null}else{if(n.kind===r.kind)return null;if(n.kind==="value"){for(const o of li)if(!al(o,r))return null}}return`Expected ${Nn(n)} but found ${Nn(r)} instead.`}function vi(n,r){return r.some(o=>o.kind===n.kind)}function Ea(n,r){return r.some(o=>o==="null"?n===null:o==="array"?Array.isArray(n):o==="object"?n&&!Array.isArray(n)&&typeof n=="object":o===typeof n)}class Fi{constructor(r,o,u){this.sensitivity=r?o?"variant":"case":o?"accent":"base",this.locale=u,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(r,o){return this.collator.compare(r,o)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Ul{constructor(r,o,u,f,m){this.text=r.normalize?r.normalize():r,this.image=o,this.scale=u,this.fontStack=f,this.textColor=m}}class gs{constructor(r){this.sections=r}static fromString(r){return new gs([new Ul(r,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(r=>r.text.length!==0||r.image&&r.image.namePrimary.length!==0)}static factory(r){return r instanceof gs?r:gs.fromString(r)}toString(){return this.sections.length===0?"":this.sections.map(r=>r.text).join("")}serialize(){const r=["format"];for(const o of this.sections){if(o.image){r.push(["image",o.image.namePrimary]);continue}r.push(o.text);const u={};o.fontStack&&(u["text-font"]=["literal",o.fontStack.split(",")]),o.scale&&(u["font-scale"]=o.scale),o.textColor&&(u["text-color"]=["rgba"].concat(o.textColor.toArray())),r.push(u)}return r}}class ci{constructor(r){this.namePrimary=r.namePrimary,r.nameSecondary&&(this.nameSecondary=r.nameSecondary),this.available=r.available}toString(){return this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}static fromString(r,o){return r?new ci({namePrimary:r,nameSecondary:o,available:!1}):null}serialize(){return this.nameSecondary?["image",this.namePrimary,this.nameSecondary]:["image",this.namePrimary]}}function H_(n,r,o,u){return typeof n=="number"&&n>=0&&n<=255&&typeof r=="number"&&r>=0&&r<=255&&typeof o=="number"&&o>=0&&o<=255?u===void 0||typeof u=="number"&&u>=0&&u<=1?null:`Invalid rgba value [${[n,r,o,u].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof u=="number"?[n,r,o,u]:[n,r,o]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function ll(n){if(n===null||typeof n=="string"||typeof n=="boolean"||typeof n=="number"||n instanceof Qt||n instanceof Fi||n instanceof gs||n instanceof ci)return!0;if(Array.isArray(n)){for(const r of n)if(!ll(r))return!1;return!0}if(typeof n=="object"){for(const r in n)if(!ll(n[r]))return!1;return!0}return!1}function qn(n){if(n===null)return ge;if(typeof n=="string")return ze;if(typeof n=="boolean")return ft;if(typeof n=="number")return _e;if(n instanceof Qt)return ni;if(n instanceof Fi)return Wn;if(n instanceof gs)return Hn;if(n instanceof ci)return Cs;if(Array.isArray(n)){const r=n.length;let o;for(const u of n){const f=qn(u);if(o){if(o===f)continue;o=_i;break}o=f}return js(o||_i,r)}return fr}function co(n){const r=typeof n;return n===null?"":r==="string"||r==="number"||r==="boolean"?String(n):n instanceof Qt||n instanceof gs||n instanceof ci?n.toString():JSON.stringify(n)}class Sa{constructor(r,o){this.type=r,this.value=o}static parse(r,o){if(r.length!==2)return o.error(`'literal' expression requires exactly one argument, but found ${r.length-1} instead.`);if(!ll(r[1]))return o.error("invalid value");const u=r[1];let f=qn(u);const m=o.expectedType;return f.kind!=="array"||f.N!==0||!m||m.kind!=="array"||typeof m.N=="number"&&m.N!==0||(f=m),new Sa(f,u)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Qt?["rgba"].concat(this.value.toArray()):this.value instanceof gs?this.value.serialize():this.value}}var Jo=Sa,Gn=class{constructor(n){this.name="ExpressionEvaluationError",this.message=n}toJSON(){return this.message}};const Lf={string:ze,number:_e,boolean:ft,object:fr};class Nf{constructor(r,o){this.type=r,this.args=o}static parse(r,o){if(r.length<2)return o.error("Expected at least one argument.");let u,f=1;const m=r[0];if(m==="array"){let b,T;if(r.length>2){const E=r[1];if(typeof E!="string"||!(E in Lf)||E==="object")return o.error('The item type argument of "array" must be one of string, number, boolean',1);b=Lf[E],f++}else b=_i;if(r.length>3){if(r[2]!==null&&(typeof r[2]!="number"||r[2]<0||r[2]!==Math.floor(r[2])))return o.error('The length argument to "array" must be a positive integer literal',2);T=r[2],f++}u=js(b,T)}else u=Lf[m];const y=[];for(;f<r.length;f++){const b=o.parse(r[f],f,_i);if(!b)return null;y.push(b)}return new Nf(u,y)}evaluate(r){for(let o=0;o<this.args.length;o++){const u=this.args[o].evaluate(r);if(!al(this.type,qn(u)))return u;if(o===this.args.length-1)throw new Gn(`Expected value to be of type ${Nn(this.type)}, but found ${Nn(qn(u))} instead.`)}return null}eachChild(r){this.args.forEach(r)}outputDefined(){return this.args.every(r=>r.outputDefined())}serialize(){const r=this.type,o=[r.kind];if(r.kind==="array"){const u=r.itemType;if(u.kind==="string"||u.kind==="number"||u.kind==="boolean"){o.push(u.kind);const f=r.N;(typeof f=="number"||this.args.length>1)&&o.push(f)}}return o.concat(this.args.map(u=>u.serialize()))}}var Qo=Nf;class Vl{constructor(r){this.type=Hn,this.sections=r}static parse(r,o){if(r.length<2)return o.error("Expected at least one argument.");const u=r[1];if(!Array.isArray(u)&&typeof u=="object")return o.error("First argument must be an image or text section.");const f=[];let m=!1;for(let y=1;y<=r.length-1;++y){const b=r[y];if(m&&typeof b=="object"&&!Array.isArray(b)){m=!1;let T=null;if(b["font-scale"]&&(T=o.parse(b["font-scale"],1,_e),!T))return null;let E=null;if(b["text-font"]&&(E=o.parse(b["text-font"],1,js(ze)),!E))return null;let M=null;if(b["text-color"]&&(M=o.parse(b["text-color"],1,ni),!M))return null;const I=f[f.length-1];I.scale=T,I.font=E,I.textColor=M}else{const T=o.parse(r[y],1,_i);if(!T)return null;const E=T.type.kind;if(E!=="string"&&E!=="value"&&E!=="null"&&E!=="resolvedImage")return o.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");m=!0,f.push({content:T,scale:null,font:null,textColor:null})}}return new Vl(f)}evaluate(r){return new gs(this.sections.map(o=>{const u=o.content.evaluate(r);return qn(u)===Cs?new Ul("",u,null,null,null):new Ul(co(u),null,o.scale?o.scale.evaluate(r):null,o.font?o.font.evaluate(r).join(","):null,o.textColor?o.textColor.evaluate(r):null)}))}eachChild(r){for(const o of this.sections)r(o.content),o.scale&&r(o.scale),o.font&&r(o.font),o.textColor&&r(o.textColor)}outputDefined(){return!1}serialize(){const r=["format"];for(const o of this.sections){r.push(o.content.serialize());const u={};o.scale&&(u["font-scale"]=o.scale.serialize()),o.font&&(u["text-font"]=o.font.serialize()),o.textColor&&(u["text-color"]=o.textColor.serialize()),r.push(u)}return r}}class cl{constructor(r,o){this.type=Cs,this.inputPrimary=r,this.inputSecondary=o}static parse(r,o){if(r.length<2)return o.error("Expected two or more arguments.");const u=o.parse(r[1],1,ze);if(!u)return o.error("No image name provided.");if(r.length===2)return new cl(u);const f=o.parse(r[2],1,ze);return f?new cl(u,f):o.error("Secondary image variant is not a string.")}evaluate(r){const o=ci.fromString(this.inputPrimary.evaluate(r),this.inputSecondary?this.inputSecondary.evaluate(r):void 0);return o&&r.availableImages&&(o.available=r.availableImages.indexOf(o.namePrimary)>-1,o.nameSecondary&&o.available&&r.availableImages&&(o.available=r.availableImages.indexOf(o.nameSecondary)>-1)),o}eachChild(r){r(this.inputPrimary),this.inputSecondary&&r(this.inputSecondary)}outputDefined(){return!1}serialize(){return this.inputSecondary?["image",this.inputPrimary.serialize(),this.inputSecondary.serialize()]:["image",this.inputPrimary.serialize()]}}function jl(n){return n instanceof Number?"number":n instanceof String?"string":n instanceof Boolean?"boolean":Array.isArray(n)?"array":n===null?"null":typeof n}const bo={"to-boolean":ft,"to-color":ni,"to-number":_e,"to-string":ze};class kh{constructor(r,o){this.type=r,this.args=o}static parse(r,o){if(r.length<2)return o.error("Expected at least one argument.");const u=r[0],f=[];let m=ge;if(u==="to-array"){if(!Array.isArray(r[1]))return null;const y=r[1].length;if(o.expectedType){if(o.expectedType.kind!=="array")return o.error(`Expected ${o.expectedType.kind} but found array.`);m=js(o.expectedType.itemType,y)}else{if(!(y>0&&ll(r[1][0])))return null;m=js(qn(r[1][0]),y)}for(let b=0;b<y;b++){const T=r[1][b];let E;if(jl(T)==="array")E=o.parse(T,void 0,m.itemType);else{const M=jl(T);if(M!==m.itemType.kind)return o.error(`Expected ${m.itemType.kind} but found ${M}.`);E=o.registry.literal.parse(["literal",T===void 0?null:T],o)}if(!E)return null;f.push(E)}}else{if((u==="to-boolean"||u==="to-string")&&r.length!==2)return o.error("Expected one argument.");m=bo[u];for(let y=1;y<r.length;y++){const b=o.parse(r[y],y,_i);if(!b)return null;f.push(b)}}return new kh(m,f)}evaluate(r){if(this.type.kind==="boolean")return!!this.args[0].evaluate(r);if(this.type.kind==="color"){let o,u;for(const f of this.args){if(o=f.evaluate(r),u=null,o instanceof Qt)return o;if(typeof o=="string"){const m=r.parseColor(o);if(m)return m}else if(Array.isArray(o)&&(u=o.length<3||o.length>4?`Invalid rbga value ${JSON.stringify(o)}: expected an array containing either three or four numeric values.`:H_(o[0],o[1],o[2],o[3]),!u))return new Qt(o[0]/255,o[1]/255,o[2]/255,o[3])}throw new Gn(u||`Could not parse color from value '${typeof o=="string"?o:String(JSON.stringify(o))}'`)}if(this.type.kind==="number"){let o=null;for(const u of this.args){if(o=u.evaluate(r),o===null)return 0;const f=Number(o);if(!isNaN(f))return f}throw new Gn(`Could not convert ${JSON.stringify(o)} to number.`)}return this.type.kind==="formatted"?gs.fromString(co(this.args[0].evaluate(r))):this.type.kind==="resolvedImage"?ci.fromString(co(this.args[0].evaluate(r))):this.type.kind==="array"?this.args.map(o=>o.evaluate(r)):co(this.args[0].evaluate(r))}eachChild(r){this.args.forEach(r)}outputDefined(){return this.args.every(r=>r.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Vl([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new cl(this.args[0]).serialize();const r=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(o=>{r.push(o.serialize())}),r}}var ea=kh;const Jc=["Unknown","Point","LineString","Polygon"];var q_=class{constructor(n,r){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=n,this.options=r}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Jc[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(n){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const n=this.featureDistanceData.center,r=this.featureDistanceData.scale,{x:o,y:u}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(o*r-n[0])+this.featureDistanceData.bearing[1]*(u*r-n[1])}return 0}parseColor(n){let r=this._parseColorCache[n];return r||(r=this._parseColorCache[n]=Qt.parse(n)),r}getConfig(n){return this.options?this.options.get(n):null}};class ul{constructor(r,o,u,f,m){this.name=r,this.type=o,this._evaluate=u,this.args=f,this._overloadIndex=m}evaluate(r){if(!this._evaluate){const o=ul.definitions[this.name];this._evaluate=Array.isArray(o)?o[2]:o.overloads[this._overloadIndex][1]}return this._evaluate(r,this.args)}eachChild(r){this.args.forEach(r)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(r=>r.serialize()))}static parse(r,o){const u=r[0],f=ul.definitions[u];if(!f)return o.error(`Unknown expression "${u}". If you wanted a literal array, use ["literal", [...]].`,0);const m=Array.isArray(f)?f[0]:f.type,y=Array.isArray(f)?[[f[1],f[2]]]:f.overloads,b=[];let T=null,E=-1;for(const[M,I]of y){if(Array.isArray(M)&&M.length!==r.length-1)continue;b.push(M),E++,T=new Q_(o.registry,o.path,null,o.scope,void 0,o._scope,o.options);const k=[];let F=!1;for(let z=1;z<r.length;z++){const V=r[z],W=Array.isArray(M)?M[z-1]:M.type,G=T.parse(V,1+k.length,W);if(!G){F=!0;break}k.push(G)}if(!F)if(Array.isArray(M)&&M.length!==k.length)T.error(`Expected ${M.length} arguments, but found ${k.length} instead.`);else{for(let z=0;z<k.length;z++){const V=Array.isArray(M)?M[z]:M.type,W=k[z];T.concat(z+1).checkSubtype(V,W.type)}if(T.errors.length===0)return new ul(u,m,I,k,E)}}if(b.length===1)o.errors.push(...T.errors);else{const M=(b.length?b:y.map(([k])=>k)).map(G_).join(" | "),I=[];for(let k=1;k<r.length;k++){const F=o.parse(r[k],1+I.length);if(!F)return null;I.push(Nn(F.type))}o.error(`Expected arguments of type ${M}, but found (${I.join(", ")}) instead.`)}return null}static register(r,o){ul.definitions=o;for(const u in o)r[u]=ul}}function G_(n){return Array.isArray(n)?`(${n.map(Nn).join(", ")})`:`(${Nn(n.type)}...)`}var Ji=ul;class Qc{constructor(r,o,u){this.type=Wn,this.locale=u,this.caseSensitive=r,this.diacriticSensitive=o}static parse(r,o){if(r.length!==2)return o.error("Expected one argument.");const u=r[1];if(typeof u!="object"||Array.isArray(u))return o.error("Collator options argument must be an object.");const f=o.parse(u["case-sensitive"]!==void 0&&u["case-sensitive"],1,ft);if(!f)return null;const m=o.parse(u["diacritic-sensitive"]!==void 0&&u["diacritic-sensitive"],1,ft);if(!m)return null;let y=null;return u.locale&&(y=o.parse(u.locale,1,ze),!y)?null:new Qc(f,m,y)}evaluate(r){return new Fi(this.caseSensitive.evaluate(r),this.diacriticSensitive.evaluate(r),this.locale?this.locale.evaluate(r):null)}eachChild(r){r(this.caseSensitive),r(this.diacriticSensitive),this.locale&&r(this.locale)}outputDefined(){return!1}serialize(){const r={};return r["case-sensitive"]=this.caseSensitive.serialize(),r["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(r.locale=this.locale.serialize()),["collator",r]}}var Ff={exports:{}};Ff.exports=function(){function n(u,f,m,y,b){for(;y>m;){if(y-m>600){var T=y-m+1,E=f-m+1,M=Math.log(T),I=.5*Math.exp(2*M/3),k=.5*Math.sqrt(M*I*(T-I)/T)*(E-T/2<0?-1:1);n(u,f,Math.max(m,Math.floor(f-E*I/T+k)),Math.min(y,Math.floor(f+(T-E)*I/T+k)),b)}var F=u[f],z=m,V=y;for(r(u,m,f),b(u[y],F)>0&&r(u,m,y);z<V;){for(r(u,z,V),z++,V--;b(u[z],F)<0;)z++;for(;b(u[V],F)>0;)V--}b(u[m],F)===0?r(u,m,V):r(u,++V,y),V<=f&&(m=V+1),f<=V&&(y=V-1)}}function r(u,f,m){var y=u[f];u[f]=u[m],u[m]=y}function o(u,f){return u<f?-1:u>f?1:0}return function(u,f,m,y,b){n(u,f,m||0,y||u.length-1,b||o)}}();var T1=pe(Ff.exports);function E1(n){let r=0;for(let o,u,f=0,m=n.length,y=m-1;f<m;y=f++)o=n[f],u=n[y],r+=(u.x-o.x)*(o.y+u.y);return r}function Aa(n,r){n[0]=Math.min(n[0],r[0]),n[1]=Math.min(n[1],r[1]),n[2]=Math.max(n[2],r[0]),n[3]=Math.max(n[3],r[1])}function Ma(n,r){return!(n[0]<=r[0]||n[2]>=r[2]||n[1]<=r[1]||n[3]>=r[3])}function Dh(n,r,o){const u=n[0]-r[0],f=n[1]-r[1],m=n[0]-o[0],y=n[1]-o[1];return u*y-m*f==0&&u*m<=0&&f*y<=0}function $l(n,r,o=!1){let u=!1;for(let b=0,T=r.length;b<T;b++){const E=r[b];for(let M=0,I=E.length,k=I-1;M<I;k=M++){const F=E[k],z=E[M];if(Dh(n,F,z))return o;(m=F)[1]>(f=n)[1]!=(y=z)[1]>f[1]&&f[0]<(y[0]-m[0])*(f[1]-m[1])/(y[1]-m[1])+m[0]&&(u=!u)}}var f,m,y;return u}function Bf(n,r,o,u){const f=u[0]-o[0],m=u[1]-o[1],y=(n[0]-o[0])*m-f*(n[1]-o[1]),b=(r[0]-o[0])*m-f*(r[1]-o[1]);return y>0&&b<0||y<0&&b>0}function ta(n,r,o,u){return(f=[u[0]-o[0],u[1]-o[1]])[0]*(m=[r[0]-n[0],r[1]-n[1]])[1]-f[1]*m[0]!=0&&!(!Bf(n,r,o,u)||!Bf(o,u,n,r));var f,m}const Ca=8192;function eu(n,r){const o=(180+n[0])/360,u=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n[1]*Math.PI/360)))/360,f=Math.pow(2,r.z);return[Math.round(o*f*Ca),Math.round(u*f*Ca)]}function zf(n,r){for(let o=0;o<r.length;o++)if($l(n,r[o]))return!0;return!1}function Uf(n,r,o){for(const u of o)for(let f=0,m=u.length,y=m-1;f<m;y=f++)if(ta(n,r,u[y],u[f]))return!0;return!1}function uo(n,r){for(let o=0;o<n.length;++o)if(!$l(n[o],r))return!1;for(let o=0;o<n.length-1;++o)if(Uf(n[o],n[o+1],r))return!1;return!0}function X_(n,r){for(let o=0;o<r.length;o++)if(uo(n,r[o]))return!0;return!1}function Vf(n,r,o){const u=[];for(let f=0;f<n.length;f++){const m=[];for(let y=0;y<n[f].length;y++){const b=eu(n[f][y],o);Aa(r,b),m.push(b)}u.push(m)}return u}function jf(n,r,o){const u=[];for(let f=0;f<n.length;f++){const m=Vf(n[f],r,o);u.push(m)}return u}function $f(n,r,o,u){if(n[0]<o[0]||n[0]>o[2]){const f=.5*u;let m=n[0]-o[0]>f?-u:o[0]-n[0]>f?u:0;m===0&&(m=n[0]-o[2]>f?-u:o[2]-n[0]>f?u:0),n[0]+=m}Aa(r,n)}function Wf(n,r,o,u){const f=Math.pow(2,u.z)*Ca,m=[u.x*Ca,u.y*Ca],y=[];if(!n)return y;for(const b of n)for(const T of b){const E=[T.x+m[0],T.y+m[1]];$f(E,r,o,f),y.push(E)}return y}function Hf(n,r,o,u){const f=Math.pow(2,u.z)*Ca,m=[u.x*Ca,u.y*Ca],y=[];if(!n)return y;for(const T of n){const E=[];for(const M of T){const I=[M.x+m[0],M.y+m[1]];Aa(r,I),E.push(I)}y.push(E)}if(r[2]-r[0]<=f/2){(b=r)[0]=b[1]=1/0,b[2]=b[3]=-1/0;for(const T of y)for(const E of T)$f(E,r,o,f)}var b;return y}class Wl{constructor(r,o){this.type=ft,this.geojson=r,this.geometries=o}static parse(r,o){if(r.length!==2)return o.error(`'within' expression requires exactly one argument, but found ${r.length-1} instead.`);if(ll(r[1])){const u=r[1];if(u.type==="FeatureCollection")for(let f=0;f<u.features.length;++f){const m=u.features[f].geometry.type;if(m==="Polygon"||m==="MultiPolygon")return new Wl(u,u.features[f].geometry)}else if(u.type==="Feature"){const f=u.geometry.type;if(f==="Polygon"||f==="MultiPolygon")return new Wl(u,u.geometry)}else if(u.type==="Polygon"||u.type==="MultiPolygon")return new Wl(u,u)}return o.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(r){if(r.geometry()!=null&&r.canonicalID()!=null){if(r.geometryType()==="Point")return function(o,u){const f=[1/0,1/0,-1/0,-1/0],m=[1/0,1/0,-1/0,-1/0],y=o.canonicalID();if(!y)return!1;if(u.type==="Polygon"){const b=Vf(u.coordinates,m,y),T=Wf(o.geometry(),f,m,y);if(!Ma(f,m))return!1;for(const E of T)if(!$l(E,b))return!1}if(u.type==="MultiPolygon"){const b=jf(u.coordinates,m,y),T=Wf(o.geometry(),f,m,y);if(!Ma(f,m))return!1;for(const E of T)if(!zf(E,b))return!1}return!0}(r,this.geometries);if(r.geometryType()==="LineString")return function(o,u){const f=[1/0,1/0,-1/0,-1/0],m=[1/0,1/0,-1/0,-1/0],y=o.canonicalID();if(!y)return!1;if(u.type==="Polygon"){const b=Vf(u.coordinates,m,y),T=Hf(o.geometry(),f,m,y);if(!Ma(f,m))return!1;for(const E of T)if(!uo(E,b))return!1}if(u.type==="MultiPolygon"){const b=jf(u.coordinates,m,y),T=Hf(o.geometry(),f,m,y);if(!Ma(f,m))return!1;for(const E of T)if(!X_(E,b))return!1}return!0}(r,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var Lh=Wl,tu={exports:{}};tu.exports=function(){var n={kilometers:1,miles:.621371192237334,nauticalmiles:.5399568034557235,meters:1e3,metres:1e3,yards:1093.6132983377079,feet:3280.839895013123,inches:39370.078740157485},r=1/298.257223563,o=r*(2-r),u=Math.PI/180,f=function(E,M){if(E===void 0)throw new Error("No latitude given.");if(M&&!n[M])throw new Error("Unknown unit "+M+". Use one of: "+Object.keys(n).join(", "));var I=6378.137*u*(M?n[M]:1),k=Math.cos(E*u),F=1/(1-o*(1-k*k)),z=Math.sqrt(F);this.kx=I*z*k,this.ky=I*z*F*(1-o)},m={units:{configurable:!0}};function y(E,M){return E[0]===M[0]&&E[1]===M[1]}function b(E,M,I){var k=T(M[0]-E[0]);return[E[0]+k*I,E[1]+(M[1]-E[1])*I]}function T(E){for(;E<-180;)E+=360;for(;E>180;)E-=360;return E}return f.fromTile=function(E,M,I){var k=Math.PI*(1-2*(E+.5)/Math.pow(2,M)),F=Math.atan(.5*(Math.exp(k)-Math.exp(-k)))/u;return new f(F,I)},m.units.get=function(){return n},f.prototype.distance=function(E,M){var I=T(E[0]-M[0])*this.kx,k=(E[1]-M[1])*this.ky;return Math.sqrt(I*I+k*k)},f.prototype.bearing=function(E,M){var I=T(M[0]-E[0])*this.kx;return Math.atan2(I,(M[1]-E[1])*this.ky)/u},f.prototype.destination=function(E,M,I){var k=I*u;return this.offset(E,Math.sin(k)*M,Math.cos(k)*M)},f.prototype.offset=function(E,M,I){return[E[0]+M/this.kx,E[1]+I/this.ky]},f.prototype.lineDistance=function(E){for(var M=0,I=0;I<E.length-1;I++)M+=this.distance(E[I],E[I+1]);return M},f.prototype.area=function(E){for(var M=0,I=0;I<E.length;I++)for(var k=E[I],F=0,z=k.length,V=z-1;F<z;V=F++)M+=T(k[F][0]-k[V][0])*(k[F][1]+k[V][1])*(I?-1:1);return Math.abs(M)/2*this.kx*this.ky},f.prototype.along=function(E,M){var I=0;if(M<=0)return E[0];for(var k=0;k<E.length-1;k++){var F=E[k],z=E[k+1],V=this.distance(F,z);if((I+=V)>M)return b(F,z,(M-(I-V))/V)}return E[E.length-1]},f.prototype.pointToSegmentDistance=function(E,M,I){var k=M[0],F=M[1],z=T(I[0]-k)*this.kx,V=(I[1]-F)*this.ky,W=0;return z===0&&V===0||((W=(T(E[0]-k)*this.kx*z+(E[1]-F)*this.ky*V)/(z*z+V*V))>1?(k=I[0],F=I[1]):W>0&&(k+=z/this.kx*W,F+=V/this.ky*W)),z=T(E[0]-k)*this.kx,V=(E[1]-F)*this.ky,Math.sqrt(z*z+V*V)},f.prototype.pointOnLine=function(E,M){for(var I,k,F,z,V=1/0,W=0;W<E.length-1;W++){var G=E[W][0],te=E[W][1],se=T(E[W+1][0]-G)*this.kx,ne=(E[W+1][1]-te)*this.ky,ye=0;se===0&&ne===0||((ye=(T(M[0]-G)*this.kx*se+(M[1]-te)*this.ky*ne)/(se*se+ne*ne))>1?(G=E[W+1][0],te=E[W+1][1]):ye>0&&(G+=se/this.kx*ye,te+=ne/this.ky*ye));var de=(se=T(M[0]-G)*this.kx)*se+(ne=(M[1]-te)*this.ky)*ne;de<V&&(V=de,I=G,k=te,F=W,z=ye)}return{point:[I,k],index:F,t:Math.max(0,Math.min(1,z))}},f.prototype.lineSlice=function(E,M,I){var k=this.pointOnLine(I,E),F=this.pointOnLine(I,M);if(k.index>F.index||k.index===F.index&&k.t>F.t){var z=k;k=F,F=z}var V=[k.point],W=k.index+1,G=F.index;!y(I[W],V[0])&&W<=G&&V.push(I[W]);for(var te=W+1;te<=G;te++)V.push(I[te]);return y(I[G],F.point)||V.push(F.point),V},f.prototype.lineSliceAlong=function(E,M,I){for(var k=0,F=[],z=0;z<I.length-1;z++){var V=I[z],W=I[z+1],G=this.distance(V,W);if((k+=G)>E&&F.length===0&&F.push(b(V,W,(E-(k-G))/G)),k>=M)return F.push(b(V,W,(M-(k-G))/G)),F;k>E&&F.push(W)}return F},f.prototype.bufferPoint=function(E,M){var I=M/this.ky,k=M/this.kx;return[E[0]-k,E[1]-I,E[0]+k,E[1]+I]},f.prototype.bufferBBox=function(E,M){var I=M/this.ky,k=M/this.kx;return[E[0]-k,E[1]-I,E[2]+k,E[3]+I]},f.prototype.insideBBox=function(E,M){return T(E[0]-M[0])>=0&&T(E[0]-M[2])<=0&&E[1]>=M[1]&&E[1]<=M[3]},Object.defineProperties(f,m),f}();var Pa=pe(tu.exports),qf={exports:{}};qf.exports=function(){var n=function(o,u){if(o===void 0&&(o=[]),u===void 0&&(u=r),this.data=o,this.length=this.data.length,this.compare=u,this.length>0)for(var f=(this.length>>1)-1;f>=0;f--)this._down(f)};function r(o,u){return o<u?-1:o>u?1:0}return n.prototype.push=function(o){this.data.push(o),this.length++,this._up(this.length-1)},n.prototype.pop=function(){if(this.length!==0){var o=this.data[0],u=this.data.pop();return this.length--,this.length>0&&(this.data[0]=u,this._down(0)),o}},n.prototype.peek=function(){return this.data[0]},n.prototype._up=function(o){for(var u=this.data,f=this.compare,m=u[o];o>0;){var y=o-1>>1,b=u[y];if(f(m,b)>=0)break;u[o]=b,o=y}u[o]=m},n.prototype._down=function(o){for(var u=this.data,f=this.compare,m=this.length>>1,y=u[o];o<m;){var b=1+(o<<1),T=u[b],E=b+1;if(E<this.length&&f(u[E],T)<0&&(b=E,T=u[E]),f(T,y)>=0)break;u[o]=T,o=b}u[o]=y},n}();var ho=pe(qf.exports),Bt=8192;function Nh(n,r){return r.dist-n.dist}const Gf=100,iu=50;function Xf(n){const r=[1/0,1/0,-1/0,-1/0];if(r.length!==n.length)return!1;for(let o=0;o<r.length;o++)if(r[o]!==n[o])return!1;return!0}function Ia(n){return n[1]-n[0]+1}function wo(n,r){const o=n[1]>=n[0]&&n[1]<r;return o||console.warn("Distance Expression: Index is out of range"),o}function Zf(n,r){if(n[0]>n[1])return[null,null];const o=Ia(n);if(r){if(o===2)return[n,null];const u=Math.floor(o/2);return[[n[0],n[0]+u],[n[0]+u,n[1]]]}{if(o===1)return[n,null];const u=Math.floor(o/2)-1;return[[n[0],n[0]+u],[n[0]+u+1,n[1]]]}}function hl(n,r){const o=[1/0,1/0,-1/0,-1/0];if(!wo(r,n.length))return o;for(let u=r[0];u<=r[1];++u)Aa(o,n[u]);return o}function Fh(n){const r=[1/0,1/0,-1/0,-1/0];for(let o=0;o<n.length;++o)for(let u=0;u<n[o].length;++u)Aa(r,n[o][u]);return r}function dl(n,r,o){if(Xf(n)||Xf(r))return NaN;let u=0,f=0;return n[2]<r[0]&&(u=r[0]-n[2]),n[0]>r[2]&&(u=n[0]-r[2]),n[1]>r[3]&&(f=n[1]-r[3]),n[3]<r[1]&&(f=r[1]-n[3]),o.distance([0,0],[u,f])}function Yf(n){return 360*n-180}function S1(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function Hl(n,r){const o=Math.pow(2,r.z),u=(n.y/Bt+r.y)/o;return[Yf((n.x/Bt+r.x)/o),S1(u)]}function A1(n,r){const o=[];for(let u=0;u<n.length;++u)o.push(Hl(n[u],r));return o}function Z_(n,r,o){const u=o.pointOnLine(r,n).point;return o.distance(n,u)}function Y_(n,r,o,u,f){const m=o.slice(u[0],u[1]+1);let y=1/0;for(let b=r[0];b<=r[1];++b)if((y=Math.min(y,Z_(n[b],m,f)))===0)return 0;return y}function Kf(n,r,o,u,f){const m=Math.min(f.pointToSegmentDistance(n,o,u),f.pointToSegmentDistance(r,o,u)),y=Math.min(f.pointToSegmentDistance(o,n,r),f.pointToSegmentDistance(u,n,r));return Math.min(m,y)}function M1(n,r,o,u,f){if(!wo(r,n.length)||!wo(u,o.length))return NaN;let m=1/0;for(let y=r[0];y<r[1];++y)for(let b=u[0];b<u[1];++b){if(ta(n[y],n[y+1],o[b],o[b+1]))return 0;m=Math.min(m,Kf(n[y],n[y+1],o[b],o[b+1],f))}return m}function C1(n,r,o,u,f){if(!wo(r,n.length)||!wo(u,o.length))return NaN;let m=1/0;for(let y=r[0];y<=r[1];++y)for(let b=u[0];b<=u[1];++b)if((m=Math.min(m,f.distance(n[y],o[b])))===0)return m;return m}function P1(n,r,o){if($l(n,r,!0))return 0;let u=1/0;for(const f of r){const m=f.length;if(m<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(f[0]!==f[m-1]&&(u=Math.min(u,o.pointToSegmentDistance(n,f[m-1],f[0])))===0||(u=Math.min(u,Z_(n,f,o)))===0)return u}return u}function K_(n,r,o,u){if(!wo(r,n.length))return NaN;for(let m=r[0];m<=r[1];++m)if($l(n[m],o,!0))return 0;let f=1/0;for(let m=r[0];m<r[1];++m)for(const y of o)for(let b=0,T=y.length,E=T-1;b<T;E=b++){if(ta(n[m],n[m+1],y[E],y[b]))return 0;f=Math.min(f,Kf(n[m],n[m+1],y[E],y[b],u))}return f}function ru(n,r){for(const o of n)for(let u=0;u<=o.length-1;++u)if($l(o[u],r,!0))return!0;return!1}function I1(n,r,o,u=1/0){const f=Fh(n),m=Fh(r);if(u!==1/0&&dl(f,m,o)>=u)return u;if(Ma(f,m)){if(ru(n,r))return 0}else if(ru(r,n))return 0;let y=u;for(const b of n)for(let T=0,E=b.length,M=E-1;T<E;M=T++)for(const I of r)for(let k=0,F=I.length,z=F-1;k<F;z=k++){if(ta(b[M],b[T],I[z],I[k]))return 0;y=Math.min(y,Kf(b[M],b[T],I[z],I[k],o))}return y}function Bh(n,r,o,u,f,m,y){if(m===null||y===null)return;const b=dl(hl(u,m),hl(f,y),o);b<r&&n.push({dist:b,range1:m,range2:y})}function Jf(n,r,o,u,f=1/0){let m=Math.min(u.distance(n[0],o[0][0]),f);if(m===0)return m;const y=new ho([{dist:0,range1:[0,n.length-1],range2:[0,0]}],Nh),b=r?iu:Gf,T=Fh(o);for(;y.length;){const E=y.pop();if(E.dist>=m)continue;const M=E.range1;if(Ia(M)<=b){if(!wo(M,n.length))return NaN;if(r){const I=K_(n,M,o,u);if((m=Math.min(m,I))===0)return m}else for(let I=M[0];I<=M[1];++I){const k=P1(n[I],o,u);if((m=Math.min(m,k))===0)return m}}else{const I=Zf(M,r);if(I[0]!==null){const k=dl(hl(n,I[0]),T,u);k<m&&y.push({dist:k,range1:I[0],range2:[0,0]})}if(I[1]!==null){const k=dl(hl(n,I[1]),T,u);k<m&&y.push({dist:k,range1:I[1],range2:[0,0]})}}}return m}function J_(n,r,o,u,f,m=1/0){let y=Math.min(m,f.distance(n[0],o[0]));if(y===0)return y;const b=new ho([{dist:0,range1:[0,n.length-1],range2:[0,o.length-1]}],Nh),T=r?iu:Gf,E=u?iu:Gf;for(;b.length;){const M=b.pop();if(M.dist>=y)continue;const I=M.range1,k=M.range2;if(Ia(I)<=T&&Ia(k)<=E){if(!wo(I,n.length)||!wo(k,o.length))return NaN;if(r&&u?y=Math.min(y,M1(n,I,o,k,f)):r||u?r&&!u?y=Math.min(y,Y_(o,k,n,I,f)):!r&&u&&(y=Math.min(y,Y_(n,I,o,k,f))):y=Math.min(y,C1(n,I,o,k,f)),y===0)return y}else{const F=Zf(I,r),z=Zf(k,u);Bh(b,y,f,n,o,F[0],z[0]),Bh(b,y,f,n,o,F[0],z[1]),Bh(b,y,f,n,o,F[1],z[0]),Bh(b,y,f,n,o,F[1],z[1])}}return y}function Qf(n,r,o,u,f=1/0){let m=f;const y=hl(n,[0,n.length-1]);for(const b of o)if(!(m!==1/0&&dl(y,hl(b,[0,b.length-1]),u)>=m)&&(m=Math.min(m,J_(n,r,b,!0,u,m)),m===0))return m;return m}function zh(n,r,o,u,f=1/0){let m=f;const y=hl(n,[0,n.length-1]);for(const b of o){if(m!==1/0&&dl(y,Fh(b),u)>=m)continue;const T=Jf(n,r,b,u,m);if(isNaN(T))return T;if((m=Math.min(m,T))===0)return m}return m}function ep(n){return n==="Point"||n==="MultiPoint"||n==="LineString"||n==="MultiLineString"||n==="Polygon"||n==="MultiPolygon"}class fl{constructor(r,o){this.type=_e,this.geojson=r,this.geometries=o}static parse(r,o){if(r.length!==2)return o.error(`'distance' expression requires either one argument, but found ' ${r.length-1} instead.`);if(ll(r[1])){const u=r[1];if(u.type==="FeatureCollection"){for(let f=0;f<u.features.length;++f)if(ep(u.features[f].geometry.type))return new fl(u,u.features[f].geometry)}else if(u.type==="Feature"){if(ep(u.geometry.type))return new fl(u,u.geometry)}else if(ep(u.type))return new fl(u,u)}return o.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(r){const o=r.geometry(),u=r.canonicalID();if(o!=null&&u!=null){if(r.geometryType()==="Point")return function(f,m,y){const b=[];for(const E of f)for(const M of E)b.push(Hl(M,m));const T=new Pa(b[0][1],"meters");return y.type==="Point"||y.type==="MultiPoint"||y.type==="LineString"?J_(b,!1,y.type==="Point"?[y.coordinates]:y.coordinates,y.type==="LineString",T):y.type==="MultiLineString"?Qf(b,!1,y.coordinates,T):y.type==="Polygon"||y.type==="MultiPolygon"?zh(b,!1,y.type==="Polygon"?[y.coordinates]:y.coordinates,T):null}(o,u,this.geometries);if(r.geometryType()==="LineString")return function(f,m,y){const b=[];for(const E of f){const M=[];for(const I of E)M.push(Hl(I,m));b.push(M)}const T=new Pa(b[0][0][1],"meters");if(y.type==="Point"||y.type==="MultiPoint"||y.type==="LineString")return Qf(y.type==="Point"?[y.coordinates]:y.coordinates,y.type==="LineString",b,T);if(y.type==="MultiLineString"){let E=1/0;for(let M=0;M<y.coordinates.length;M++){const I=Qf(y.coordinates[M],!0,b,T,E);if(isNaN(I))return I;if((E=Math.min(E,I))===0)return E}return E}if(y.type==="Polygon"||y.type==="MultiPolygon"){let E=1/0;for(let M=0;M<b.length;M++){const I=zh(b[M],!0,y.type==="Polygon"?[y.coordinates]:y.coordinates,T,E);if(isNaN(I))return I;if((E=Math.min(E,I))===0)return E}return E}return null}(o,u,this.geometries);if(r.geometryType()==="Polygon")return function(f,m,y){const b=[];for(const E of function(M,I){const k=M.length;if(k<=1)return[M];const F=[];let z,V;for(let W=0;W<k;W++){const G=E1(M[W]);G!==0&&(M[W].area=Math.abs(G),V===void 0&&(V=G<0),V===G<0?(z&&F.push(z),z=[M[W]]):z.push(M[W]))}return z&&F.push(z),F}(f)){const M=[];for(let I=0;I<E.length;++I)M.push(A1(E[I],m));b.push(M)}const T=new Pa(b[0][0][0][1],"meters");if(y.type==="Point"||y.type==="MultiPoint"||y.type==="LineString")return zh(y.type==="Point"?[y.coordinates]:y.coordinates,y.type==="LineString",b,T);if(y.type==="MultiLineString"){let E=1/0;for(let M=0;M<y.coordinates.length;M++){const I=zh(y.coordinates[M],!0,b,T,E);if(isNaN(I))return I;if((E=Math.min(E,I))===0)return E}return E}return y.type==="Polygon"||y.type==="MultiPolygon"?function(E,M,I){let k=1/0;for(const F of E)for(const z of M){const V=I1(F,z,I,k);if(isNaN(V))return V;if((k=Math.min(k,V))===0)return k}return k}(y.type==="Polygon"?[y.coordinates]:y.coordinates,b,T):null}(o,u,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}var Uh=fl;function nu(n,r){switch(n){case"string":return co(r);case"number":return+r;case"boolean":return!!r;case"color":return Qt.parse(r);case"formatted":return gs.fromString(co(r));case"resolvedImage":return ci.fromString(co(r))}return r}function tp(n,r,o,u){return u!==void 0&&(n=u*Math.round(n/u)),r!==void 0&&n<r&&(n=r),o!==void 0&&n>o&&(n=o),n}class su{constructor(r,o,u){this.type=r,this.key=o,this.scope=u}static parse(r,o){let u=o.expectedType;if(u==null&&(u=_i),r.length<2||r.length>3)return o.error("Invalid number of arguments for 'config' expression.");const f=o.parse(r[1],1);if(!(f instanceof Jo))return o.error("Key name of 'config' expression must be a string literal.");if(r.length>=3){const m=o.parse(r[2],2);return m instanceof Jo?new su(u,co(f.value),co(m.value)):o.error("Scope of 'config' expression must be a string literal.")}return new su(u,co(f.value))}evaluate(r){const o=[this.key,this.scope,r.scope].filter(Boolean).join(""),u=r.getConfig(o);if(!u)return null;const{type:f,value:m,values:y,minValue:b,maxValue:T,stepValue:E}=u,M=u.default.evaluate(r);let I=M;if(m){const k=r.scope;r.scope=(k||"").split("").slice(1).join(""),I=m.evaluate(r),r.scope=k}return f&&(I=nu(f,I)),I===void 0||b===void 0&&T===void 0&&E===void 0||(typeof I=="number"?I=tp(I,b,T,E):Array.isArray(I)&&(I=I.map(k=>typeof k=="number"?tp(k,b,T,E):k))),m!==void 0&&I!==void 0&&y&&!y.includes(I)&&(I=M,f&&(I=nu(f,I))),(f&&f!==this.type||I!==void 0&&qn(I)!==this.type)&&(I=nu(this.type.kind,I)),I}eachChild(){}outputDefined(){return!1}serialize(){const r=["config",this.key];return this.scope&&r.concat(this.key),r}}var ql=su;function Gl(n){if(n instanceof Ji&&(n.name==="get"&&n.args.length===1||n.name==="feature-state"||n.name==="has"&&n.args.length===1||n.name==="properties"||n.name==="geometry-type"||n.name==="id"||/^filter-/.test(n.name))||n instanceof Lh||n instanceof Uh)return!1;let r=!0;return n.eachChild(o=>{r&&!Gl(o)&&(r=!1)}),r}function ou(n){if(n instanceof Ji&&n.name==="feature-state")return!1;let r=!0;return n.eachChild(o=>{r&&!ou(o)&&(r=!1)}),r}function au(n){if(n instanceof ql)return!1;let r=!0;return n.eachChild(o=>{r&&!au(o)&&(r=!1)}),r}function ys(n,r){if(n instanceof Ji&&r.indexOf(n.name)>=0)return!1;let o=!0;return n.eachChild(u=>{o&&!ys(u,r)&&(o=!1)}),o}class Ra{constructor(r,o){this.type=o.type,this.name=r,this.boundExpression=o}static parse(r,o){if(r.length!==2||typeof r[1]!="string")return o.error("'var' expression requires exactly one string literal argument.");const u=r[1];return o.scope.has(u)?new Ra(u,o.scope.get(u)):o.error(`Unknown variable "${u}". Make sure "${u}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(r){return this.boundExpression.evaluate(r)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var Ds=Ra;class ip{constructor(r,o=[],u,f=new ue,m=[],y,b){this.registry=r,this.path=o,this.key=o.map(T=>`[${T}]`).join(""),this.scope=f,this.errors=m,this.expectedType=u,this._scope=y,this.options=b}parse(r,o,u,f,m={}){return o||u?this.concat(o,u,f)._parse(r,m):this._parse(r,m)}_parse(r,o){function u(f,m,y){return y==="assert"?new Qo(m,[f]):y==="coerce"?new ea(m,[f]):f}if(r!==null&&typeof r!="string"&&typeof r!="boolean"&&typeof r!="number"||(r=["literal",r]),Array.isArray(r)){if(r.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const f=typeof r[0]=="string"?this.registry[r[0]]:void 0;if(f){let m=f.parse(r,this);if(!m)return null;if(this.expectedType){const y=this.expectedType,b=m.type;if(y.kind!=="string"&&y.kind!=="number"&&y.kind!=="boolean"&&y.kind!=="object"&&y.kind!=="array"||b.kind!=="value")if(y.kind!=="color"&&y.kind!=="formatted"&&y.kind!=="resolvedImage"||b.kind!=="value"&&b.kind!=="string"){if(this.checkSubtype(y,b))return null}else m=u(m,y,o.typeAnnotation||"coerce");else m=u(m,y,o.typeAnnotation||"assert")}if(!(m instanceof Jo)&&m.type.kind!=="resolvedImage"&&rp(m)){const y=new q_(this._scope,this.options);try{m=new Jo(m.type,m.evaluate(y))}catch(b){return this.error(b.message),null}}return m}return ea.parse(["to-array",r],this)}return this.error(r===void 0?"'undefined' value invalid. Use null instead.":typeof r=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof r} instead.`)}concat(r,o,u){const f=typeof r=="number"?this.path.concat(r):this.path,m=u?this.scope.concat(u):this.scope;return new ip(this.registry,f,o||null,m,this.errors,this._scope,this.options)}error(r,...o){const u=`${this.key}${o.map(f=>`[${f}]`).join("")}`;this.errors.push(new on(u,r))}checkSubtype(r,o){const u=al(r,o);return u&&this.error(u),u}}var Q_=ip;function rp(n){if(n instanceof Ds)return rp(n.boundExpression);if(n instanceof Ji&&n.name==="error"||n instanceof Qc||n instanceof Lh||n instanceof Uh||n instanceof ql)return!1;const r=n instanceof ea||n instanceof Qo;let o=!0;return n.eachChild(u=>{o=r?o&&rp(u):o&&u instanceof Jo}),!!o&&Gl(n)&&ys(n,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function pl(n,r){const o=n.length-1;let u,f,m=0,y=o,b=0;for(;m<=y;)if(b=Math.floor((m+y)/2),u=n[b],f=n[b+1],u<=r){if(b===o||r<f)return b;m=b+1}else{if(!(u>r))throw new Gn("Input is not a number.");y=b-1}return 0}class Vh{constructor(r,o,u){this.type=r,this.input=o,this.labels=[],this.outputs=[];for(const[f,m]of u)this.labels.push(f),this.outputs.push(m)}static parse(r,o){if(r.length-1<4)return o.error(`Expected at least 4 arguments, but found only ${r.length-1}.`);if((r.length-1)%2!=0)return o.error("Expected an even number of arguments.");const u=o.parse(r[1],1,_e);if(!u)return null;const f=[];let m=null;o.expectedType&&o.expectedType.kind!=="value"&&(m=o.expectedType);for(let y=1;y<r.length;y+=2){const b=y===1?-1/0:r[y],T=r[y+1],E=y,M=y+1;if(typeof b!="number")return o.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',E);if(f.length&&f[f.length-1][0]>=b)return o.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',E);const I=o.parse(T,M,m);if(!I)return null;m=m||I.type,f.push([b,I])}return new Vh(m,u,f)}evaluate(r){const o=this.labels,u=this.outputs;if(o.length===1)return u[0].evaluate(r);const f=this.input.evaluate(r);if(f<=o[0])return u[0].evaluate(r);const m=o.length;return f>=o[m-1]?u[m-1].evaluate(r):u[pl(o,f)].evaluate(r)}eachChild(r){r(this.input);for(const o of this.outputs)r(o)}outputDefined(){return this.outputs.every(r=>r.outputDefined())}serialize(){const r=["step",this.input.serialize()];for(let o=0;o<this.labels.length;o++)o>0&&r.push(this.labels[o]),r.push(this.outputs[o].serialize());return r}}var lu=Vh;const eg=.95047,Oa=1.08883,tg=4/29,Xl=6/29,np=3*Xl*Xl,ig=Xl*Xl*Xl,R1=Math.PI/180,To=180/Math.PI;function jh(n){return n>ig?Math.pow(n,1/3):n/np+tg}function $h(n){return n>Xl?n*n*n:np*(n-tg)}function Wh(n){return 255*(n<=.0031308?12.92*n:1.055*Math.pow(n,1/2.4)-.055)}function Hh(n){return(n/=255)<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4)}function sp(n){const r=Hh(n.r),o=Hh(n.g),u=Hh(n.b),f=jh((.4124564*r+.3575761*o+.1804375*u)/eg),m=jh((.2126729*r+.7151522*o+.072175*u)/1);return{l:116*m-16,a:500*(f-m),b:200*(m-jh((.0193339*r+.119192*o+.9503041*u)/Oa)),alpha:n.a}}function op(n){let r=(n.l+16)/116,o=isNaN(n.a)?r:r+n.a/500,u=isNaN(n.b)?r:r-n.b/200;return r=1*$h(r),o=eg*$h(o),u=Oa*$h(u),new Qt(Wh(3.2404542*o-1.5371385*r-.4985314*u),Wh(-.969266*o+1.8760108*r+.041556*u),Wh(.0556434*o-.2040259*r+1.0572252*u),n.alpha)}function rg(n,r,o){const u=r-n;return n+o*(u>180||u<-180?u-360*Math.round(u/360):u)}const Zl={forward:sp,reverse:op,interpolate:function(n,r,o){return{l:Ut(n.l,r.l,o),a:Ut(n.a,r.a,o),b:Ut(n.b,r.b,o),alpha:Ut(n.alpha,r.alpha,o)}}},Yl={forward:function(n){const{l:r,a:o,b:u}=sp(n),f=Math.atan2(u,o)*To;return{h:f<0?f+360:f,c:Math.sqrt(o*o+u*u),l:r,alpha:n.a}},reverse:function(n){const r=n.h*R1,o=n.c;return op({l:n.l,a:Math.cos(r)*o,b:Math.sin(r)*o,alpha:n.alpha})},interpolate:function(n,r,o){return{h:rg(n.h,r.h,o),c:Ut(n.c,r.c,o),l:Ut(n.l,r.l,o),alpha:Ut(n.alpha,r.alpha,o)}}};var ap=Object.freeze({__proto__:null,hcl:Yl,lab:Zl});class cu{constructor(r,o,u,f,m){this.type=r,this.operator=o,this.interpolation=u,this.input=f,this.labels=[],this.outputs=[];for(const[y,b]of m)this.labels.push(y),this.outputs.push(b)}static interpolationFactor(r,o,u,f){let m=0;if(r.name==="exponential")m=Kl(o,r.base,u,f);else if(r.name==="linear")m=Kl(o,1,u,f);else if(r.name==="cubic-bezier"){const y=r.controlPoints;m=new je(y[0],y[1],y[2],y[3]).solve(Kl(o,1,u,f))}return m}static parse(r,o){let[u,f,m,...y]=r;if(!Array.isArray(f)||f.length===0)return o.error("Expected an interpolation type expression.",1);if(f[0]==="linear")f={name:"linear"};else if(f[0]==="exponential"){const E=f[1];if(typeof E!="number")return o.error("Exponential interpolation requires a numeric base.",1,1);f={name:"exponential",base:E}}else{if(f[0]!=="cubic-bezier")return o.error(`Unknown interpolation type ${String(f[0])}`,1,0);{const E=f.slice(1);if(E.length!==4||E.some(M=>typeof M!="number"||M<0||M>1))return o.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);f={name:"cubic-bezier",controlPoints:E}}}if(r.length-1<4)return o.error(`Expected at least 4 arguments, but found only ${r.length-1}.`);if((r.length-1)%2!=0)return o.error("Expected an even number of arguments.");if(m=o.parse(m,2,_e),!m)return null;const b=[];let T=null;u==="interpolate-hcl"||u==="interpolate-lab"?T=ni:o.expectedType&&o.expectedType.kind!=="value"&&(T=o.expectedType);for(let E=0;E<y.length;E+=2){const M=y[E],I=y[E+1],k=E+3,F=E+4;if(typeof M!="number")return o.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',k);if(b.length&&b[b.length-1][0]>=M)return o.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',k);const z=o.parse(I,F,T);if(!z)return null;T=T||z.type,b.push([M,z])}return T.kind==="number"||T.kind==="color"||T.kind==="array"&&T.itemType.kind==="number"&&typeof T.N=="number"?new cu(T,u,f,m,b):o.error(`Type ${Nn(T)} is not interpolatable.`)}evaluate(r){const o=this.labels,u=this.outputs;if(o.length===1)return u[0].evaluate(r);const f=this.input.evaluate(r);if(f<=o[0])return u[0].evaluate(r);const m=o.length;if(f>=o[m-1])return u[m-1].evaluate(r);const y=pl(o,f),b=cu.interpolationFactor(this.interpolation,f,o[y],o[y+1]),T=u[y].evaluate(r),E=u[y+1].evaluate(r);return this.operator==="interpolate"?dr[this.type.kind.toLowerCase()](T,E,b):this.operator==="interpolate-hcl"?Yl.reverse(Yl.interpolate(Yl.forward(T),Yl.forward(E),b)):Zl.reverse(Zl.interpolate(Zl.forward(T),Zl.forward(E),b))}eachChild(r){r(this.input);for(const o of this.outputs)r(o)}outputDefined(){return this.outputs.every(r=>r.outputDefined())}serialize(){let r;r=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const o=[this.operator,r,this.input.serialize()];for(let u=0;u<this.labels.length;u++)o.push(this.labels[u],this.outputs[u].serialize());return o}}function Kl(n,r,o,u){const f=u-o,m=n-o;return f===0?0:r===1?m/f:(Math.pow(r,m)-1)/(Math.pow(r,f)-1)}var to=cu;class Jl{constructor(r,o){this.type=r,this.args=o}static parse(r,o){if(r.length<2)return o.error("Expectected at least one argument.");let u=null;const f=o.expectedType;f&&f.kind!=="value"&&(u=f);const m=[];for(const b of r.slice(1)){const T=o.parse(b,1+m.length,u,void 0,{typeAnnotation:"omit"});if(!T)return null;u=u||T.type,m.push(T)}const y=f&&m.some(b=>al(f,b.type));return new Jl(y?_i:u,m)}evaluate(r){let o,u=null,f=0;for(const m of this.args){if(f++,u=m.evaluate(r),u&&u instanceof ci&&!u.available&&(o||(o=u),u=null,f===this.args.length))return o;if(u!==null)break}return u}eachChild(r){this.args.forEach(r)}outputDefined(){return this.args.every(r=>r.outputDefined())}serialize(){const r=["coalesce"];return this.eachChild(o=>{r.push(o.serialize())}),r}}var lp=Jl;class qh{constructor(r,o){this.type=o.type,this.bindings=[].concat(r),this.result=o}evaluate(r){return this.result.evaluate(r)}eachChild(r){for(const o of this.bindings)r(o[1]);r(this.result)}static parse(r,o){if(r.length<4)return o.error(`Expected at least 3 arguments, but found ${r.length-1} instead.`);const u=[];for(let m=1;m<r.length-1;m+=2){const y=r[m];if(typeof y!="string")return o.error(`Expected string, but found ${typeof y} instead.`,m);if(/[^a-zA-Z0-9_]/.test(y))return o.error("Variable names must contain only alphanumeric characters or '_'.",m);const b=o.parse(r[m+1],m+1);if(!b)return null;u.push([y,b])}const f=o.parse(r[r.length-1],r.length-1,o.expectedType,u);return f?new qh(u,f):null}outputDefined(){return this.result.outputDefined()}serialize(){const r=["let"];for(const[o,u]of this.bindings)r.push(o,u.serialize());return r.push(this.result.serialize()),r}}var cp=qh;class ka{constructor(r,o,u){this.type=r,this.index=o,this.input=u}static parse(r,o){if(r.length!==3)return o.error(`Expected 2 arguments, but found ${r.length-1} instead.`);const u=o.parse(r[1],1,_e),f=o.parse(r[2],2,js(o.expectedType||_i));return u&&f?new ka(f.type.itemType,u,f):null}evaluate(r){const o=this.index.evaluate(r),u=this.input.evaluate(r);if(o<0)throw new Gn(`Array index out of bounds: ${o} < 0.`);if(o>=u.length)throw new Gn(`Array index out of bounds: ${o} > ${u.length-1}.`);if(o!==Math.floor(o))throw new Gn(`Array index must be an integer, but found ${o} instead.`);return u[o]}eachChild(r){r(this.index),r(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var nr=ka;class up{constructor(r,o){this.type=ft,this.needle=r,this.haystack=o}static parse(r,o){if(r.length!==3)return o.error(`Expected 2 arguments, but found ${r.length-1} instead.`);const u=o.parse(r[1],1,_i),f=o.parse(r[2],2,_i);return u&&f?vi(u.type,[ft,ze,_e,ge,_i])?new up(u,f):o.error(`Expected first argument to be of type boolean, string, number or null, but found ${Nn(u.type)} instead`):null}evaluate(r){const o=this.needle.evaluate(r),u=this.haystack.evaluate(r);if(u==null)return!1;if(!Ea(o,["boolean","string","number","null"]))throw new Gn(`Expected first argument to be of type boolean, string, number or null, but found ${Nn(qn(o))} instead.`);if(!Ea(u,["string","array"]))throw new Gn(`Expected second argument to be of type array or string, but found ${Nn(qn(u))} instead.`);return u.indexOf(o)>=0}eachChild(r){r(this.needle),r(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var O1=up;class Gh{constructor(r,o,u){this.type=_e,this.needle=r,this.haystack=o,this.fromIndex=u}static parse(r,o){if(r.length<=2||r.length>=5)return o.error(`Expected 3 or 4 arguments, but found ${r.length-1} instead.`);const u=o.parse(r[1],1,_i),f=o.parse(r[2],2,_i);if(!u||!f)return null;if(!vi(u.type,[ft,ze,_e,ge,_i]))return o.error(`Expected first argument to be of type boolean, string, number or null, but found ${Nn(u.type)} instead`);if(r.length===4){const m=o.parse(r[3],3,_e);return m?new Gh(u,f,m):null}return new Gh(u,f)}evaluate(r){const o=this.needle.evaluate(r),u=this.haystack.evaluate(r);if(!Ea(o,["boolean","string","number","null"]))throw new Gn(`Expected first argument to be of type boolean, string, number or null, but found ${Nn(qn(o))} instead.`);if(!Ea(u,["string","array"]))throw new Gn(`Expected second argument to be of type array or string, but found ${Nn(qn(u))} instead.`);if(this.fromIndex){const f=this.fromIndex.evaluate(r);return u.indexOf(o,f)}return u.indexOf(o)}eachChild(r){r(this.needle),r(this.haystack),this.fromIndex&&r(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const r=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),r]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var ng=Gh;class hp{constructor(r,o,u,f,m,y){this.inputType=r,this.type=o,this.input=u,this.cases=f,this.outputs=m,this.otherwise=y}static parse(r,o){if(r.length<5)return o.error(`Expected at least 4 arguments, but found only ${r.length-1}.`);if(r.length%2!=1)return o.error("Expected an even number of arguments.");let u,f;o.expectedType&&o.expectedType.kind!=="value"&&(f=o.expectedType);const m={},y=[];for(let E=2;E<r.length-1;E+=2){let M=r[E];const I=r[E+1];Array.isArray(M)||(M=[M]);const k=o.concat(E);if(M.length===0)return k.error("Expected at least one branch label.");for(const z of M){if(typeof z!="number"&&typeof z!="string")return k.error("Branch labels must be numbers or strings.");if(typeof z=="number"&&Math.abs(z)>Number.MAX_SAFE_INTEGER)return k.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof z=="number"&&Math.floor(z)!==z)return k.error("Numeric branch labels must be integer values.");if(u){if(k.checkSubtype(u,qn(z)))return null}else u=qn(z);if(m[String(z)]!==void 0)return k.error("Branch labels must be unique.");m[String(z)]=y.length}const F=o.parse(I,E,f);if(!F)return null;f=f||F.type,y.push(F)}const b=o.parse(r[1],1,_i);if(!b)return null;const T=o.parse(r[r.length-1],r.length-1,f);return T?b.type.kind!=="value"&&o.concat(1).checkSubtype(u,b.type)?null:new hp(u,f,b,m,y,T):null}evaluate(r){const o=this.input.evaluate(r);return(qn(o)===this.inputType&&this.outputs[this.cases[o]]||this.otherwise).evaluate(r)}eachChild(r){r(this.input),this.outputs.forEach(r),r(this.otherwise)}outputDefined(){return this.outputs.every(r=>r.outputDefined())&&this.otherwise.outputDefined()}serialize(){const r=["match",this.input.serialize()],o=Object.keys(this.cases).sort(),u=[],f={};for(const y of o){const b=f[this.cases[y]];b===void 0?(f[this.cases[y]]=u.length,u.push([this.cases[y],[y]])):u[b][1].push(y)}const m=y=>this.inputType.kind==="number"?Number(y):y;for(const[y,b]of u)r.push(b.length===1?m(b[0]):b.map(m)),r.push(this.outputs[y].serialize());return r.push(this.otherwise.serialize()),r}}var sg=hp;class Xh{constructor(r,o,u){this.type=r,this.branches=o,this.otherwise=u}static parse(r,o){if(r.length<4)return o.error(`Expected at least 3 arguments, but found only ${r.length-1}.`);if(r.length%2!=0)return o.error("Expected an odd number of arguments.");let u;o.expectedType&&o.expectedType.kind!=="value"&&(u=o.expectedType);const f=[];for(let y=1;y<r.length-1;y+=2){const b=o.parse(r[y],y,ft);if(!b)return null;const T=o.parse(r[y+1],y+1,u);if(!T)return null;f.push([b,T]),u=u||T.type}const m=o.parse(r[r.length-1],r.length-1,u);return m?new Xh(u,f,m):null}evaluate(r){for(const[o,u]of this.branches)if(o.evaluate(r))return u.evaluate(r);return this.otherwise.evaluate(r)}eachChild(r){for(const[o,u]of this.branches)r(o),r(u);r(this.otherwise)}outputDefined(){return this.branches.every(([r,o])=>o.outputDefined())&&this.otherwise.outputDefined()}serialize(){const r=["case"];return this.eachChild(o=>{r.push(o.serialize())}),r}}var og=Xh;class uu{constructor(r,o,u,f){this.type=r,this.input=o,this.beginIndex=u,this.endIndex=f}static parse(r,o){if(r.length<=2||r.length>=5)return o.error(`Expected 3 or 4 arguments, but found ${r.length-1} instead.`);const u=o.parse(r[1],1,_i),f=o.parse(r[2],2,_e);if(!u||!f)return null;if(!vi(u.type,[js(_i),ze,_i]))return o.error(`Expected first argument to be of type array or string, but found ${Nn(u.type)} instead`);if(r.length===4){const m=o.parse(r[3],3,_e);return m?new uu(u.type,u,f,m):null}return new uu(u.type,u,f)}evaluate(r){const o=this.input.evaluate(r),u=this.beginIndex.evaluate(r);if(!Ea(o,["string","array"]))throw new Gn(`Expected first argument to be of type array or string, but found ${Nn(qn(o))} instead.`);if(this.endIndex){const f=this.endIndex.evaluate(r);return o.slice(u,f)}return o.slice(u)}eachChild(r){r(this.input),r(this.beginIndex),this.endIndex&&r(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const r=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),r]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var Ql=uu;function dp(n,r){return n==="=="||n==="!="?r.kind==="boolean"||r.kind==="string"||r.kind==="number"||r.kind==="null"||r.kind==="value":r.kind==="string"||r.kind==="number"||r.kind==="value"}function fp(n,r,o,u){return u.compare(r,o)===0}function ec(n,r,o){const u=n!=="=="&&n!=="!=";return class mN{constructor(m,y,b){this.type=ft,this.lhs=m,this.rhs=y,this.collator=b,this.hasUntypedArgument=m.type.kind==="value"||y.type.kind==="value"}static parse(m,y){if(m.length!==3&&m.length!==4)return y.error("Expected two or three arguments.");const b=m[0];let T=y.parse(m[1],1,_i);if(!T)return null;if(!dp(b,T.type))return y.concat(1).error(`"${b}" comparisons are not supported for type '${Nn(T.type)}'.`);let E=y.parse(m[2],2,_i);if(!E)return null;if(!dp(b,E.type))return y.concat(2).error(`"${b}" comparisons are not supported for type '${Nn(E.type)}'.`);if(T.type.kind!==E.type.kind&&T.type.kind!=="value"&&E.type.kind!=="value")return y.error(`Cannot compare types '${Nn(T.type)}' and '${Nn(E.type)}'.`);u&&(T.type.kind==="value"&&E.type.kind!=="value"?T=new Qo(E.type,[T]):T.type.kind!=="value"&&E.type.kind==="value"&&(E=new Qo(T.type,[E])));let M=null;if(m.length===4){if(T.type.kind!=="string"&&E.type.kind!=="string"&&T.type.kind!=="value"&&E.type.kind!=="value")return y.error("Cannot use collator to compare non-string types.");if(M=y.parse(m[3],3,Wn),!M)return null}return new mN(T,E,M)}evaluate(m){const y=this.lhs.evaluate(m),b=this.rhs.evaluate(m);if(u&&this.hasUntypedArgument){const T=qn(y),E=qn(b);if(T.kind!==E.kind||T.kind!=="string"&&T.kind!=="number")throw new Gn(`Expected arguments for "${n}" to be (string, string) or (number, number), but found (${T.kind}, ${E.kind}) instead.`)}if(this.collator&&!u&&this.hasUntypedArgument){const T=qn(y),E=qn(b);if(T.kind!=="string"||E.kind!=="string")return r(m,y,b)}return this.collator?o(m,y,b,this.collator.evaluate(m)):r(m,y,b)}eachChild(m){m(this.lhs),m(this.rhs),this.collator&&m(this.collator)}outputDefined(){return!0}serialize(){const m=[n];return this.eachChild(y=>{m.push(y.serialize())}),m}}}const pp=ec("==",function(n,r,o){return r===o},fp),mp=ec("!=",function(n,r,o){return r!==o},function(n,r,o,u){return!fp(0,r,o,u)}),k1=ec("<",function(n,r,o){return r<o},function(n,r,o,u){return u.compare(r,o)<0}),D1=ec(">",function(n,r,o){return r>o},function(n,r,o,u){return u.compare(r,o)>0}),ag=ec("<=",function(n,r,o){return r<=o},function(n,r,o,u){return u.compare(r,o)<=0}),L1=ec(">=",function(n,r,o){return r>=o},function(n,r,o,u){return u.compare(r,o)>=0});class _p{constructor(r,o,u,f,m,y){this.type=ze,this.number=r,this.locale=o,this.currency=u,this.unit=f,this.minFractionDigits=m,this.maxFractionDigits=y}static parse(r,o){if(r.length!==3)return o.error("Expected two arguments.");const u=o.parse(r[1],1,_e);if(!u)return null;const f=r[2];if(typeof f!="object"||Array.isArray(f))return o.error("NumberFormat options argument must be an object.");let m=null;if(f.locale&&(m=o.parse(f.locale,1,ze),!m))return null;let y=null;if(f.currency&&(y=o.parse(f.currency,1,ze),!y))return null;let b=null;if(f.unit&&(b=o.parse(f.unit,1,ze),!b))return null;let T=null;if(f["min-fraction-digits"]&&(T=o.parse(f["min-fraction-digits"],1,_e),!T))return null;let E=null;return f["max-fraction-digits"]&&(E=o.parse(f["max-fraction-digits"],1,_e),!E)?null:new _p(u,m,y,b,T,E)}evaluate(r){return new Intl.NumberFormat(this.locale?this.locale.evaluate(r):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(r):void 0,unit:this.unit?this.unit.evaluate(r):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(r):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(r):void 0}).format(this.number.evaluate(r))}eachChild(r){r(this.number),this.locale&&r(this.locale),this.currency&&r(this.currency),this.unit&&r(this.unit),this.minFractionDigits&&r(this.minFractionDigits),this.maxFractionDigits&&r(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const r={};return this.locale&&(r.locale=this.locale.serialize()),this.currency&&(r.currency=this.currency.serialize()),this.unit&&(r.unit=this.unit.serialize()),this.minFractionDigits&&(r["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(r["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),r]}}class gp{constructor(r){this.type=_e,this.input=r}static parse(r,o){if(r.length!==2)return o.error(`Expected 1 argument, but found ${r.length-1} instead.`);const u=o.parse(r[1],1);return u?u.type.kind!=="array"&&u.type.kind!=="string"&&u.type.kind!=="value"?o.error(`Expected argument of type string or array, but found ${Nn(u.type)} instead.`):new gp(u):null}evaluate(r){const o=this.input.evaluate(r);if(typeof o=="string"||Array.isArray(o))return o.length;throw new Gn(`Expected value to be of type string or array, but found ${Nn(qn(o))} instead.`)}eachChild(r){r(this.input)}outputDefined(){return!1}serialize(){const r=["length"];return this.eachChild(o=>{r.push(o.serialize())}),r}}function lg(n){return function(){n=1831565813+(n|=0)|0;let r=Math.imul(n^n>>>15,1|n);return r=r+Math.imul(r^r>>>7,61|r)^r,((r^r>>>14)>>>0)/4294967296}}const yp={"==":pp,"!=":mp,">":D1,"<":k1,">=":L1,"<=":ag,array:Qo,at:nr,boolean:Qo,case:og,coalesce:lp,collator:Qc,format:Vl,image:cl,in:O1,"index-of":ng,interpolate:to,"interpolate-hcl":to,"interpolate-lab":to,length:gp,let:cp,literal:Jo,match:sg,number:Qo,"number-format":_p,object:Qo,slice:Ql,step:lu,string:Qo,"to-boolean":ea,"to-color":ea,"to-number":ea,"to-string":ea,var:Ds,within:Lh,distance:Uh,config:ql};function vp(n,[r,o,u,f]){r=r.evaluate(n),o=o.evaluate(n),u=u.evaluate(n);const m=f?f.evaluate(n):1,y=H_(r,o,u,m);if(y)throw new Gn(y);return new Qt(r/255*m,o/255*m,u/255*m,m)}function cg(n,[r,o,u,f]){r=r.evaluate(n),o=o.evaluate(n),u=u.evaluate(n);const m=f?f.evaluate(n):1,y=function(E,M,I,k){return typeof E=="number"&&E>=0&&E<=360?typeof M=="number"&&M>=0&&M<=100&&typeof I=="number"&&I>=0&&I<=100?k===void 0||typeof k=="number"&&k>=0&&k<=1?null:`Invalid hsla value [${[E,M,I,k].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof k=="number"?[E,M,I,k]:[E,M,I]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof k=="number"?[E,M,I,k]:[E,M,I]).join(", ")}]: 'h' must be between 0 and 360.`}(r,o,u,m);if(y)throw new Gn(y);const b=`hsla(${r}, ${o}%, ${u}%, ${m})`,T=Qt.parse(b);if(!T)throw new Gn(`Failed to parse HSLA color: ${b}`);return T}function xp(n,r){return n in r}function bp(n,r){const o=r[n];return o===void 0?null:o}function ml(n){return{type:n}}Ji.register(yp,{error:[{kind:"error"},[ze],(n,[r])=>{throw new Gn(r.evaluate(n))}],typeof:[ze,[_i],(n,[r])=>Nn(qn(r.evaluate(n)))],"to-rgba":[js(_e,4),[ni],(n,[r])=>r.evaluate(n).toArray()],rgb:[ni,[_e,_e,_e],vp],rgba:[ni,[_e,_e,_e,_e],vp],hsl:[ni,[_e,_e,_e],cg],hsla:[ni,[_e,_e,_e,_e],cg],has:{type:ft,overloads:[[[ze],(n,[r])=>xp(r.evaluate(n),n.properties())],[[ze,fr],(n,[r,o])=>xp(r.evaluate(n),o.evaluate(n))]]},get:{type:_i,overloads:[[[ze],(n,[r])=>bp(r.evaluate(n),n.properties())],[[ze,fr],(n,[r,o])=>bp(r.evaluate(n),o.evaluate(n))]]},"feature-state":[_i,[ze],(n,[r])=>bp(r.evaluate(n),n.featureState||{})],properties:[fr,[],n=>n.properties()],"geometry-type":[ze,[],n=>n.geometryType()],id:[_i,[],n=>n.id()],zoom:[_e,[],n=>n.globals.zoom],pitch:[_e,[],n=>n.globals.pitch||0],"distance-from-center":[_e,[],n=>n.distanceFromCenter()],"measure-light":[_e,[ze],(n,[r])=>n.measureLight(r.evaluate(n))],"heatmap-density":[_e,[],n=>n.globals.heatmapDensity||0],"line-progress":[_e,[],n=>n.globals.lineProgress||0],"raster-value":[_e,[],n=>n.globals.rasterValue||0],"raster-particle-speed":[_e,[],n=>n.globals.rasterParticleSpeed||0],"sky-radial-progress":[_e,[],n=>n.globals.skyRadialProgress||0],accumulated:[_i,[],n=>n.globals.accumulated===void 0?null:n.globals.accumulated],"+":[_e,ml(_e),(n,r)=>{let o=0;for(const u of r)o+=u.evaluate(n);return o}],"*":[_e,ml(_e),(n,r)=>{let o=1;for(const u of r)o*=u.evaluate(n);return o}],"-":{type:_e,overloads:[[[_e,_e],(n,[r,o])=>r.evaluate(n)-o.evaluate(n)],[[_e],(n,[r])=>-r.evaluate(n)]]},"/":[_e,[_e,_e],(n,[r,o])=>r.evaluate(n)/o.evaluate(n)],"%":[_e,[_e,_e],(n,[r,o])=>r.evaluate(n)%o.evaluate(n)],ln2:[_e,[],()=>Math.LN2],pi:[_e,[],()=>Math.PI],e:[_e,[],()=>Math.E],"^":[_e,[_e,_e],(n,[r,o])=>Math.pow(r.evaluate(n),o.evaluate(n))],sqrt:[_e,[_e],(n,[r])=>Math.sqrt(r.evaluate(n))],log10:[_e,[_e],(n,[r])=>Math.log(r.evaluate(n))/Math.LN10],ln:[_e,[_e],(n,[r])=>Math.log(r.evaluate(n))],log2:[_e,[_e],(n,[r])=>Math.log(r.evaluate(n))/Math.LN2],sin:[_e,[_e],(n,[r])=>Math.sin(r.evaluate(n))],cos:[_e,[_e],(n,[r])=>Math.cos(r.evaluate(n))],tan:[_e,[_e],(n,[r])=>Math.tan(r.evaluate(n))],asin:[_e,[_e],(n,[r])=>Math.asin(r.evaluate(n))],acos:[_e,[_e],(n,[r])=>Math.acos(r.evaluate(n))],atan:[_e,[_e],(n,[r])=>Math.atan(r.evaluate(n))],min:[_e,ml(_e),(n,r)=>Math.min(...r.map(o=>o.evaluate(n)))],max:[_e,ml(_e),(n,r)=>Math.max(...r.map(o=>o.evaluate(n)))],abs:[_e,[_e],(n,[r])=>Math.abs(r.evaluate(n))],round:[_e,[_e],(n,[r])=>{const o=r.evaluate(n);return o<0?-Math.round(-o):Math.round(o)}],floor:[_e,[_e],(n,[r])=>Math.floor(r.evaluate(n))],ceil:[_e,[_e],(n,[r])=>Math.ceil(r.evaluate(n))],"filter-==":[ft,[ze,_i],(n,[r,o])=>n.properties()[r.value]===o.value],"filter-id-==":[ft,[_i],(n,[r])=>n.id()===r.value],"filter-type-==":[ft,[ze],(n,[r])=>n.geometryType()===r.value],"filter-<":[ft,[ze,_i],(n,[r,o])=>{const u=n.properties()[r.value],f=o.value;return typeof u==typeof f&&u<f}],"filter-id-<":[ft,[_i],(n,[r])=>{const o=n.id(),u=r.value;return typeof o==typeof u&&o<u}],"filter->":[ft,[ze,_i],(n,[r,o])=>{const u=n.properties()[r.value],f=o.value;return typeof u==typeof f&&u>f}],"filter-id->":[ft,[_i],(n,[r])=>{const o=n.id(),u=r.value;return typeof o==typeof u&&o>u}],"filter-<=":[ft,[ze,_i],(n,[r,o])=>{const u=n.properties()[r.value],f=o.value;return typeof u==typeof f&&u<=f}],"filter-id-<=":[ft,[_i],(n,[r])=>{const o=n.id(),u=r.value;return typeof o==typeof u&&o<=u}],"filter->=":[ft,[ze,_i],(n,[r,o])=>{const u=n.properties()[r.value],f=o.value;return typeof u==typeof f&&u>=f}],"filter-id->=":[ft,[_i],(n,[r])=>{const o=n.id(),u=r.value;return typeof o==typeof u&&o>=u}],"filter-has":[ft,[_i],(n,[r])=>r.value in n.properties()],"filter-has-id":[ft,[],n=>n.id()!==null&&n.id()!==void 0],"filter-type-in":[ft,[js(ze)],(n,[r])=>r.value.indexOf(n.geometryType())>=0],"filter-id-in":[ft,[js(_i)],(n,[r])=>r.value.indexOf(n.id())>=0],"filter-in-small":[ft,[ze,js(_i)],(n,[r,o])=>o.value.indexOf(n.properties()[r.value])>=0],"filter-in-large":[ft,[ze,js(_i)],(n,[r,o])=>function(u,f,m,y){for(;m<=y;){const b=m+y>>1;if(f[b]===u)return!0;f[b]>u?y=b-1:m=b+1}return!1}(n.properties()[r.value],o.value,0,o.value.length-1)],all:{type:ft,overloads:[[[ft,ft],(n,[r,o])=>r.evaluate(n)&&o.evaluate(n)],[ml(ft),(n,r)=>{for(const o of r)if(!o.evaluate(n))return!1;return!0}]]},any:{type:ft,overloads:[[[ft,ft],(n,[r,o])=>r.evaluate(n)||o.evaluate(n)],[ml(ft),(n,r)=>{for(const o of r)if(o.evaluate(n))return!0;return!1}]]},"!":[ft,[ft],(n,[r])=>!r.evaluate(n)],"is-supported-script":[ft,[ze],(n,[r])=>{const o=n.globals&&n.globals.isSupportedScript;return!o||o(r.evaluate(n))}],upcase:[ze,[ze],(n,[r])=>r.evaluate(n).toUpperCase()],downcase:[ze,[ze],(n,[r])=>r.evaluate(n).toLowerCase()],concat:[ze,ml(_i),(n,r)=>r.map(o=>co(o.evaluate(n))).join("")],"resolved-locale":[ze,[Wn],(n,[r])=>r.evaluate(n).resolvedLocale()],random:[_e,[_e,_e,_i],(n,r)=>{const[o,u,f]=r.map(y=>y.evaluate(n));if(o>u||o===u)return o;let m;if(typeof f=="string")m=function(y){let b=0;if(y.length===0)return b;for(let T=0;T<y.length;T++)b=(b<<5)-b+y.charCodeAt(T),b|=0;return b}(f);else{if(typeof f!="number")throw new Gn(`Invalid seed input: ${f}`);m=f}return o+lg(m)()*(u-o)}]});var tc=yp;function wp(n){return{result:"success",value:n}}function _l(n){return{result:"error",value:n}}function ug(n,r){return!!n&&!!n.parameters&&n.parameters.indexOf(r)>-1}function Zh(n){return n["property-type"]==="data-driven"}function Tp(n){return ug(n.expression,"measure-light")}function hg(n){return ug(n.expression,"zoom")}function Ep(n){return!!n.expression&&n.expression.interpolated}function Yh(n){return typeof n=="object"&&n!==null&&!Array.isArray(n)}function dg(n){return n}function Sp(n,r){const o=r.type==="color",u=n.stops&&typeof n.stops[0][0]=="object",f=u||!(u||n.property!==void 0),m=n.type||(Ep(r)?"exponential":"interval");if(o&&((n=Sr({},n)).stops&&(n.stops=n.stops.map(E=>[E[0],Qt.parse(E[1])])),n.default=Qt.parse(n.default?n.default:r.default)),n.colorSpace&&n.colorSpace!=="rgb"&&!ap[n.colorSpace])throw new Error(`Unknown color space: ${n.colorSpace}`);let y,b,T;if(m==="exponential")y=fg;else if(m==="interval")y=F1;else if(m==="categorical"){y=N1,b=Object.create(null);for(const E of n.stops)b[E[0]]=E[1];T=typeof n.stops[0][0]}else{if(m!=="identity")throw new Error(`Unknown function type "${m}"`);y=pg}if(u){const E={},M=[];for(let F=0;F<n.stops.length;F++){const z=n.stops[F],V=z[0].zoom;E[V]===void 0&&(E[V]={zoom:V,type:n.type,property:n.property,default:n.default,stops:[]},M.push(V)),E[V].stops.push([z[0].value,z[1]])}const I=[];for(const F of M)I.push([E[F].zoom,Sp(E[F],r)]);const k={name:"linear"};return{kind:"composite",interpolationType:k,interpolationFactor:to.interpolationFactor.bind(void 0,k),zoomStops:I.map(F=>F[0]),evaluate:({zoom:F},z)=>fg({stops:I,base:n.base},r,F).evaluate(F,z)}}if(f){const E=m==="exponential"?{name:"exponential",base:n.base!==void 0?n.base:1}:null;return{kind:"camera",interpolationType:E,interpolationFactor:to.interpolationFactor.bind(void 0,E),zoomStops:n.stops.map(M=>M[0]),evaluate:({zoom:M})=>y(n,r,M,b,T)}}return{kind:"source",evaluate(E,M){const I=M&&M.properties?M.properties[n.property]:void 0;return I===void 0?hu(n.default,r.default):y(n,r,I,b,T)}}}function hu(n,r,o){return n!==void 0?n:r!==void 0?r:o!==void 0?o:void 0}function N1(n,r,o,u,f){return hu(typeof o===f?u[o]:void 0,n.default,r.default)}function F1(n,r,o){if(jl(o)!=="number")return hu(n.default,r.default);const u=n.stops.length;if(u===1||o<=n.stops[0][0])return n.stops[0][1];if(o>=n.stops[u-1][0])return n.stops[u-1][1];const f=pl(n.stops.map(m=>m[0]),o);return n.stops[f][1]}function fg(n,r,o){const u=n.base!==void 0?n.base:1;if(jl(o)!=="number")return hu(n.default,r.default);const f=n.stops.length;if(f===1||o<=n.stops[0][0])return n.stops[0][1];if(o>=n.stops[f-1][0])return n.stops[f-1][1];const m=pl(n.stops.map(M=>M[0]),o),y=function(M,I,k,F){const z=F-k,V=M-k;return z===0?0:I===1?V/z:(Math.pow(I,V)-1)/(Math.pow(I,z)-1)}(o,u,n.stops[m][0],n.stops[m+1][0]),b=n.stops[m][1],T=n.stops[m+1][1];let E=dr[r.type]||dg;if(n.colorSpace&&n.colorSpace!=="rgb"){const M=ap[n.colorSpace];E=(I,k)=>M.reverse(M.interpolate(M.forward(I),M.forward(k),y))}return typeof b.evaluate=="function"?{evaluate(...M){const I=b.evaluate.apply(void 0,M),k=T.evaluate.apply(void 0,M);if(I!==void 0&&k!==void 0)return E(I,k,y)}}:E(b,T,y)}function pg(n,r,o){return r.type==="color"?o=Qt.parse(o):r.type==="formatted"?o=gs.fromString(o.toString()):r.type==="resolvedImage"?o=ci.fromString(o.toString()):jl(o)===r.type||r.type==="enum"&&r.values[o]||(o=void 0),hu(o,n.default,r.default)}class Kh{constructor(r,o,u,f){this.expression=r,this._warningHistory={},this._evaluator=new q_(u,f),this._defaultValue=o?function(m){return m.type==="color"&&(Yh(m.default)||Array.isArray(m.default))?new Qt(0,0,0,0):m.type==="color"?Qt.parse(m.default)||null:m.default===void 0?null:m.default}(o):null,this._enumValues=o&&o.type==="enum"?o.values:null}evaluateWithoutErrorHandling(r,o,u,f,m,y,b,T){return this._evaluator.globals=r,this._evaluator.feature=o,this._evaluator.featureState=u,this._evaluator.canonical=f||null,this._evaluator.availableImages=m||null,this._evaluator.formattedSection=y,this._evaluator.featureTileCoord=b||null,this._evaluator.featureDistanceData=T||null,this.expression.evaluate(this._evaluator)}evaluate(r,o,u,f,m,y,b,T){this._evaluator.globals=r,this._evaluator.feature=o||null,this._evaluator.featureState=u||null,this._evaluator.canonical=f||null,this._evaluator.availableImages=m||null,this._evaluator.formattedSection=y||null,this._evaluator.featureTileCoord=b||null,this._evaluator.featureDistanceData=T||null;try{const E=this.expression.evaluate(this._evaluator);if(E==null||typeof E=="number"&&E!=E)return this._defaultValue;if(this._enumValues&&!(E in this._enumValues))throw new Gn(`Expected value to be one of ${Object.keys(this._enumValues).map(M=>JSON.stringify(M)).join(", ")}, but found ${JSON.stringify(E)} instead.`);return E}catch(E){return this._warningHistory[E.message]||(this._warningHistory[E.message]=!0,typeof console<"u"&&console.warn(E.message)),this._defaultValue}}}function du(n){return Array.isArray(n)&&n.length>0&&typeof n[0]=="string"&&n[0]in tc}function Jh(n,r,o,u){const f=new Q_(tc,[],r?function(y){const b={color:ni,string:ze,number:_e,enum:ze,boolean:ft,formatted:Hn,resolvedImage:Cs};return y.type==="array"?js(b[y.value]||_i,y.length):b[y.type]}(r):void 0,void 0,void 0,o,u),m=f.parse(n,void 0,void 0,void 0,r&&r.type==="string"?{typeAnnotation:"coerce"}:void 0);return m?wp(new Kh(m,r,o,u)):_l(f.errors)}class Ap{constructor(r,o,u){this.kind=r,this._styleExpression=o,this.isLightConstant=u,this.isStateDependent=r!=="constant"&&!ou(o.expression),this.isConfigDependent=!au(o.expression)}evaluateWithoutErrorHandling(r,o,u,f,m,y){return this._styleExpression.evaluateWithoutErrorHandling(r,o,u,f,m,y)}evaluate(r,o,u,f,m,y){return this._styleExpression.evaluate(r,o,u,f,m,y)}}class fu{constructor(r,o,u,f,m){this.kind=r,this.zoomStops=u,this._styleExpression=o,this.isStateDependent=r!=="camera"&&!ou(o.expression),this.isLightConstant=m,this.isConfigDependent=!au(o.expression),this.interpolationType=f}evaluateWithoutErrorHandling(r,o,u,f,m,y){return this._styleExpression.evaluateWithoutErrorHandling(r,o,u,f,m,y)}evaluate(r,o,u,f,m,y){return this._styleExpression.evaluate(r,o,u,f,m,y)}interpolationFactor(r,o,u){return this.interpolationType?to.interpolationFactor(this.interpolationType,r,o,u):0}}function Qh(n,r,o,u){if((n=Jh(n,r,o,u)).result==="error")return n;const f=n.value.expression,m=Gl(f);if(!m&&!Zh(r))return _l([new on("","data expressions not supported")]);const y=ys(f,["zoom","pitch","distance-from-center"]);if(!y&&!hg(r))return _l([new on("","zoom expressions not supported")]);const b=ys(f,["measure-light"]);if(!b&&!Tp(r))return _l([new on("","measure-light expression not supported")]);const T=r.expression&&r.expression.relaxZoomRestriction,E=mu(f);return E||y||T?E instanceof on?_l([E]):E instanceof to&&!Ep(r)?_l([new on("",'"interpolate" expressions cannot be used with this property')]):wp(E?new fu(m?"camera":"composite",n.value,E.labels,E instanceof to?E.interpolation:void 0,b):new Ap(m?"constant":"source",n.value,b)):_l([new on("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class pu{constructor(r,o){this._parameters=r,this._specification=o,Sr(this,Sp(this._parameters,this._specification))}static deserialize(r){return new pu(r._parameters,r._specification)}static serialize(r){return{_parameters:r._parameters,_specification:r._specification}}}function mu(n){let r=null;if(n instanceof cp)r=mu(n.result);else if(n instanceof lp){for(const o of n.args)if(r=mu(o),r)break}else(n instanceof lu||n instanceof to)&&n.input instanceof Ji&&n.input.name==="zoom"&&(r=n);return r instanceof on||n.eachChild(o=>{const u=mu(o);u instanceof on?r=u:r&&u&&r!==u&&(r=new on("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),r}var B1=So,Eo=3;function So(n,r,o){var u=this.cells=[];if(n instanceof ArrayBuffer){this.arrayBuffer=n;var f=new Int32Array(this.arrayBuffer);n=f[0],this.d=(r=f[1])+2*(o=f[2]);for(var m=0;m<this.d*this.d;m++){var y=f[Eo+m],b=f[Eo+m+1];u.push(y===b?null:f.subarray(y,b))}var T=f[Eo+u.length+1];this.keys=f.subarray(f[Eo+u.length],T),this.bboxes=f.subarray(T),this.insert=this._insertReadonly}else{this.d=r+2*o;for(var E=0;E<this.d*this.d;E++)u.push([]);this.keys=[],this.bboxes=[]}this.n=r,this.extent=n,this.padding=o,this.scale=r/n,this.uid=0;var M=o/r*n;this.min=-M,this.max=n+M}So.prototype.insert=function(n,r,o,u,f){this._forEachCell(r,o,u,f,this._insertCell,this.uid++),this.keys.push(n),this.bboxes.push(r),this.bboxes.push(o),this.bboxes.push(u),this.bboxes.push(f)},So.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},So.prototype._insertCell=function(n,r,o,u,f,m){this.cells[f].push(m)},So.prototype.query=function(n,r,o,u,f){var m=this.min,y=this.max;if(n<=m&&r<=m&&y<=o&&y<=u&&!f)return Array.prototype.slice.call(this.keys);var b=[];return this._forEachCell(n,r,o,u,this._queryCell,b,{},f),b},So.prototype._queryCell=function(n,r,o,u,f,m,y,b){var T=this.cells[f];if(T!==null)for(var E=this.keys,M=this.bboxes,I=0;I<T.length;I++){var k=T[I];if(y[k]===void 0){var F=4*k;(b?b(M[F+0],M[F+1],M[F+2],M[F+3]):n<=M[F+2]&&r<=M[F+3]&&o>=M[F+0]&&u>=M[F+1])?(y[k]=!0,m.push(E[k])):y[k]=!1}}},So.prototype._forEachCell=function(n,r,o,u,f,m,y,b){for(var T=this._convertToCellCoord(n),E=this._convertToCellCoord(r),M=this._convertToCellCoord(o),I=this._convertToCellCoord(u),k=T;k<=M;k++)for(var F=E;F<=I;F++){var z=this.d*F+k;if((!b||b(this._convertFromCellCoord(k),this._convertFromCellCoord(F),this._convertFromCellCoord(k+1),this._convertFromCellCoord(F+1)))&&f.call(this,n,r,o,u,z,m,y,b))return}},So.prototype._convertFromCellCoord=function(n){return(n-this.padding)/this.scale},So.prototype._convertToCellCoord=function(n){return Math.max(0,Math.min(this.d-1,Math.floor(n*this.scale)+this.padding))},So.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var n=this.cells,r=Eo+this.cells.length+1+1,o=0,u=0;u<this.cells.length;u++)o+=this.cells[u].length;var f=new Int32Array(r+o+this.keys.length+this.bboxes.length);f[0]=this.extent,f[1]=this.n,f[2]=this.padding;for(var m=r,y=0;y<n.length;y++){var b=n[y];f[Eo+y]=m,f.set(b,m),m+=b.length}return f[Eo+n.length]=m,f.set(this.keys,m),f[Eo+n.length+1]=m+=this.keys.length,f.set(this.bboxes,m),m+=this.bboxes.length,f.buffer};var ia=pe(B1);const _u={};function Ht(n,r,o={}){Object.defineProperty(n,"_classRegistryKey",{value:r,writeable:!1}),_u[r]={klass:n,omit:o.omit||[]}}Ht(Object,"Object"),ia.serialize=function(n,r){const o=n.toArrayBuffer();return r&&r.add(o),{buffer:o}},ia.deserialize=function(n){return new ia(n.buffer)},Object.defineProperty(ia,"name",{value:"Grid"}),Ht(ia,"Grid"),Ht(Qt,"Color"),Ht(Error,"Error"),Ht(gs,"Formatted"),Ht(Ul,"FormattedSection"),Ht(Yr,"AJAXError"),Ht(ci,"ResolvedImage"),Ht(pu,"StylePropertyFunction"),Ht(Kh,"StyleExpression",{omit:["_evaluator"]}),Ht(fu,"ZoomDependentExpression"),Ht(Ap,"ZoomConstantExpression"),Ht(Ji,"CompoundExpression",{omit:["_evaluate"]});for(const n in tc)_u[tc[n]._classRegistryKey]||Ht(tc[n],`Expression${n}`);function mg(n){return n&&typeof ArrayBuffer<"u"&&(n instanceof ArrayBuffer||n.constructor&&n.constructor.name==="ArrayBuffer")}function ed(n){return self.ImageBitmap&&n instanceof ImageBitmap}function Da(n,r){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp)return n;if(mg(n)||ed(n))return r&&r.add(n),n;if(ArrayBuffer.isView(n)){const o=n;return r&&r.add(o.buffer),o}if(n instanceof ImageData)return r&&r.add(n.data.buffer),n;if(Array.isArray(n)){const o=[];for(const u of n)o.push(Da(u,r));return o}if(n instanceof Map){const o={$name:"Map"};for(const[u,f]of n.entries())o[u]=Da(f);return o}if(typeof n=="object"){const o=n.constructor,u=o._classRegistryKey;if(!u)throw new Error(`can't serialize object of unregistered class ${u}`);const f=o.serialize?o.serialize(n,r):{};if(!o.serialize){for(const m in n)n.hasOwnProperty(m)&&(_u[u].omit.indexOf(m)>=0||(f[m]=Da(n[m],r)));n instanceof Error&&(f.message=n.message)}if(f.$name)throw new Error("$name property is reserved for worker serialization logic.");return u!=="Object"&&(f.$name=u),f}throw new Error("can't serialize object of type "+typeof n)}function gl(n){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp||mg(n)||ed(n)||ArrayBuffer.isView(n)||n instanceof ImageData)return n;if(Array.isArray(n))return n.map(gl);if(typeof n=="object"){const r=n.$name||"Object";if(r==="Map"){const f=new Map;for(const m of Object.keys(n))m!=="$name"&&f.set(m,gl(n[m]));return f}const{klass:o}=_u[r];if(!o)throw new Error(`can't deserialize unregistered class ${r}`);if(o.deserialize)return o.deserialize(n);const u=Object.create(o.prototype);for(const f of Object.keys(n))f!=="$name"&&(u[f]=gl(n[f]));return u}throw new Error("can't deserialize object of type "+typeof n)}const Yt={"Latin-1 Supplement":n=>n>=128&&n<=255,Arabic:n=>n>=1536&&n<=1791,"Arabic Supplement":n=>n>=1872&&n<=1919,"Arabic Extended-A":n=>n>=2208&&n<=2303,"Hangul Jamo":n=>n>=4352&&n<=4607,"Unified Canadian Aboriginal Syllabics":n=>n>=5120&&n<=5759,Khmer:n=>n>=6016&&n<=6143,"Unified Canadian Aboriginal Syllabics Extended":n=>n>=6320&&n<=6399,"General Punctuation":n=>n>=8192&&n<=8303,"Letterlike Symbols":n=>n>=8448&&n<=8527,"Number Forms":n=>n>=8528&&n<=8591,"Miscellaneous Technical":n=>n>=8960&&n<=9215,"Control Pictures":n=>n>=9216&&n<=9279,"Optical Character Recognition":n=>n>=9280&&n<=9311,"Enclosed Alphanumerics":n=>n>=9312&&n<=9471,"Geometric Shapes":n=>n>=9632&&n<=9727,"Miscellaneous Symbols":n=>n>=9728&&n<=9983,"Miscellaneous Symbols and Arrows":n=>n>=11008&&n<=11263,"CJK Radicals Supplement":n=>n>=11904&&n<=12031,"Kangxi Radicals":n=>n>=12032&&n<=12255,"Ideographic Description Characters":n=>n>=12272&&n<=12287,"CJK Symbols and Punctuation":n=>n>=12288&&n<=12351,Hiragana:n=>n>=12352&&n<=12447,Katakana:n=>n>=12448&&n<=12543,Bopomofo:n=>n>=12544&&n<=12591,"Hangul Compatibility Jamo":n=>n>=12592&&n<=12687,Kanbun:n=>n>=12688&&n<=12703,"Bopomofo Extended":n=>n>=12704&&n<=12735,"CJK Strokes":n=>n>=12736&&n<=12783,"Katakana Phonetic Extensions":n=>n>=12784&&n<=12799,"Enclosed CJK Letters and Months":n=>n>=12800&&n<=13055,"CJK Compatibility":n=>n>=13056&&n<=13311,"CJK Unified Ideographs Extension A":n=>n>=13312&&n<=19903,"Yijing Hexagram Symbols":n=>n>=19904&&n<=19967,"CJK Unified Ideographs":n=>n>=19968&&n<=40959,"Yi Syllables":n=>n>=40960&&n<=42127,"Yi Radicals":n=>n>=42128&&n<=42191,"Hangul Jamo Extended-A":n=>n>=43360&&n<=43391,"Hangul Syllables":n=>n>=44032&&n<=55215,"Hangul Jamo Extended-B":n=>n>=55216&&n<=55295,"Private Use Area":n=>n>=57344&&n<=63743,"CJK Compatibility Ideographs":n=>n>=63744&&n<=64255,"Arabic Presentation Forms-A":n=>n>=64336&&n<=65023,"Vertical Forms":n=>n>=65040&&n<=65055,"CJK Compatibility Forms":n=>n>=65072&&n<=65103,"Small Form Variants":n=>n>=65104&&n<=65135,"Arabic Presentation Forms-B":n=>n>=65136&&n<=65279,"Halfwidth and Fullwidth Forms":n=>n>=65280&&n<=65519,"CJK Unified Ideographs Extension B":n=>n>=131072&&n<=173791};function La(n){for(const r of n)if(Mp(r.charCodeAt(0)))return!0;return!1}function z1(n){for(const r of n)if(!U1(r.charCodeAt(0)))return!1;return!0}function U1(n){return!(Yt.Arabic(n)||Yt["Arabic Supplement"](n)||Yt["Arabic Extended-A"](n)||Yt["Arabic Presentation Forms-A"](n)||Yt["Arabic Presentation Forms-B"](n))}function Mp(n){return!(n!==746&&n!==747&&(n<4352||!(Yt["Bopomofo Extended"](n)||Yt.Bopomofo(n)||Yt["CJK Compatibility Forms"](n)&&!(n>=65097&&n<=65103)||Yt["CJK Compatibility Ideographs"](n)||Yt["CJK Compatibility"](n)||Yt["CJK Radicals Supplement"](n)||Yt["CJK Strokes"](n)||!(!Yt["CJK Symbols and Punctuation"](n)||n>=12296&&n<=12305||n>=12308&&n<=12319||n===12336)||Yt["CJK Unified Ideographs Extension A"](n)||Yt["CJK Unified Ideographs"](n)||Yt["Enclosed CJK Letters and Months"](n)||Yt["Hangul Compatibility Jamo"](n)||Yt["Hangul Jamo Extended-A"](n)||Yt["Hangul Jamo Extended-B"](n)||Yt["Hangul Jamo"](n)||Yt["Hangul Syllables"](n)||Yt.Hiragana(n)||Yt["Ideographic Description Characters"](n)||Yt.Kanbun(n)||Yt["Kangxi Radicals"](n)||Yt["Katakana Phonetic Extensions"](n)||Yt.Katakana(n)&&n!==12540||!(!Yt["Halfwidth and Fullwidth Forms"](n)||n===65288||n===65289||n===65293||n>=65306&&n<=65310||n===65339||n===65341||n===65343||n>=65371&&n<=65503||n===65507||n>=65512&&n<=65519)||!(!Yt["Small Form Variants"](n)||n>=65112&&n<=65118||n>=65123&&n<=65126)||Yt["Unified Canadian Aboriginal Syllabics"](n)||Yt["Unified Canadian Aboriginal Syllabics Extended"](n)||Yt["Vertical Forms"](n)||Yt["Yijing Hexagram Symbols"](n)||Yt["Yi Syllables"](n)||Yt["Yi Radicals"](n))))}function _g(n){return!(Mp(n)||function(r){return!!(Yt["Latin-1 Supplement"](r)&&(r===167||r===169||r===174||r===177||r===188||r===189||r===190||r===215||r===247)||Yt["General Punctuation"](r)&&(r===8214||r===8224||r===8225||r===8240||r===8241||r===8251||r===8252||r===8258||r===8263||r===8264||r===8265||r===8273)||Yt["Letterlike Symbols"](r)||Yt["Number Forms"](r)||Yt["Miscellaneous Technical"](r)&&(r>=8960&&r<=8967||r>=8972&&r<=8991||r>=8996&&r<=9e3||r===9003||r>=9085&&r<=9114||r>=9150&&r<=9165||r===9167||r>=9169&&r<=9179||r>=9186&&r<=9215)||Yt["Control Pictures"](r)&&r!==9251||Yt["Optical Character Recognition"](r)||Yt["Enclosed Alphanumerics"](r)||Yt["Geometric Shapes"](r)||Yt["Miscellaneous Symbols"](r)&&!(r>=9754&&r<=9759)||Yt["Miscellaneous Symbols and Arrows"](r)&&(r>=11026&&r<=11055||r>=11088&&r<=11097||r>=11192&&r<=11243)||Yt["CJK Symbols and Punctuation"](r)||Yt.Katakana(r)||Yt["Private Use Area"](r)||Yt["CJK Compatibility Forms"](r)||Yt["Small Form Variants"](r)||Yt["Halfwidth and Fullwidth Forms"](r)||r===8734||r===8756||r===8757||r>=9984&&r<=10087||r>=10102&&r<=10131||r===65532||r===65533)}(n))}function gg(n){return n>=1424&&n<=2303||Yt["Arabic Presentation Forms-A"](n)||Yt["Arabic Presentation Forms-B"](n)}function yg(n,r){return!(!r&&gg(n)||n>=2304&&n<=3583||n>=3840&&n<=4255||Yt.Khmer(n))}function Cp(n){for(const r of n)if(gg(r.charCodeAt(0)))return!0;return!1}const Pp="deferred",Ip="loading",Rp="loaded";let Op=null,$s="unavailable",Na=null;const vg=function(n){n&&typeof n=="string"&&n.indexOf("NetworkError")>-1&&($s="error"),Op&&Op(n)};function kp(){Dp.fire(new lo("pluginStateChange",{pluginStatus:$s,pluginURL:Na}))}const Dp=new eo,Fa=function(){return $s},Lp=function(){if($s!==Pp||!Na)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");$s=Ip,kp(),Na&&nt({url:Na},n=>{n?vg(n):($s=Rp,kp())})},io={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>$s===Rp||io.applyArabicShaping!=null,isLoading:()=>$s===Ip,setState(n){$s=n.pluginStatus,Na=n.pluginURL},isParsed:()=>io.applyArabicShaping!=null&&io.processBidirectionalText!=null&&io.processStyledBidirectionalText!=null,getPluginURL:()=>Na};class dn{constructor(r,o){this.zoom=r,o?(this.now=o.now,this.fadeDuration=o.fadeDuration,this.transition=o.transition,this.pitch=o.pitch,this.brightness=o.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(r){return function(o,u){for(const f of o)if(!yg(f.charCodeAt(0),u))return!1;return!0}(r,io.isLoaded())}}class td{constructor(r,o,u,f){this.property=r,this.value=o,this.expression=function(m,y,b,T){if(Yh(m))return new pu(m,y);if(du(m)||Array.isArray(m)&&m.length>0){const E=Qh(m,y,b,T);if(E.result==="error")throw new Error(E.value.map(M=>`${M.key}: ${M.message}`).join(", "));return E.value}{let E=m;return typeof m=="string"&&y.type==="color"&&(E=Qt.parse(m)),{kind:"constant",isConfigDependent:!1,evaluate:()=>E}}}(o===void 0?r.specification.default:o,r.specification,u,f)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(r,o,u){return this.property.possiblyEvaluate(this,r,o,u)}}class Np{constructor(r,o,u){this.property=r,this.value=new td(r,void 0,o,u)}transitioned(r,o){return new Fp(this.property,this.value,o,Ar({},r.transition,this.transition),r.now)}untransitioned(){return new Fp(this.property,this.value,null,{},0)}}class ra{constructor(r,o,u){this._properties=r,this._values=Object.create(r.defaultTransitionablePropertyValues),this._scope=o,this._options=u,this.isConfigDependent=!1}getValue(r){return gn(this._values[r].value.value)}setValue(r,o){this._values.hasOwnProperty(r)||(this._values[r]=new Np(this._values[r].property,this._scope,this._options)),this._values[r].value=new td(this._values[r].property,o===null?void 0:gn(o),this._scope,this._options),this.isConfigDependent=this.isConfigDependent||this._values[r].value.expression.isConfigDependent}setTransitionOrValue(r,o){o&&(this._options=o);const u=this._properties.properties;if(r)for(const f in r){const m=r[f];if(Er(f,"-transition")){const y=f.slice(0,-11);u[y]&&this.setTransition(y,m)}else u[f]&&this.setValue(f,m)}}getTransition(r){return gn(this._values[r].transition)}setTransition(r,o){this._values.hasOwnProperty(r)||(this._values[r]=new Np(this._values[r].property)),this._values[r].transition=gn(o)||void 0}serialize(){const r={};for(const o of Object.keys(this._values)){const u=this.getValue(o);u!==void 0&&(r[o]=u);const f=this.getTransition(o);f!==void 0&&(r[`${o}-transition`]=f)}return r}transitioned(r,o){const u=new yl(this._properties);for(const f of Object.keys(this._values))u._values[f]=this._values[f].transitioned(r,o._values[f]);return u}untransitioned(){const r=new yl(this._properties);for(const o of Object.keys(this._values))r._values[o]=this._values[o].untransitioned();return r}}class Fp{constructor(r,o,u,f,m){const y=f.delay||0,b=f.duration||0;m=m||0,this.property=r,this.value=o,this.begin=m+y,this.end=this.begin+b,r.specification.transition&&(f.delay||f.duration)&&(this.prior=u)}possiblyEvaluate(r,o,u){const f=r.now||0,m=this.value.possiblyEvaluate(r,o,u),y=this.prior;if(y){if(f>this.end)return this.prior=null,m;if(this.value.isDataDriven())return this.prior=null,m;if(f<this.begin)return y.possiblyEvaluate(r,o,u);{const b=(f-this.begin)/(this.end-this.begin);return this.property.interpolate(y.possiblyEvaluate(r,o,u),m,Ie(b))}}return m}}class yl{constructor(r){this._properties=r,this._values=Object.create(r.defaultTransitioningPropertyValues)}possiblyEvaluate(r,o,u){const f=new gu(this._properties);for(const m of Object.keys(this._values))f._values[m]=this._values[m].possiblyEvaluate(r,o,u);return f}hasTransition(){for(const r of Object.keys(this._values))if(this._values[r].prior)return!0;return!1}}class V1{constructor(r,o,u){this._properties=r,this._values=Object.create(r.defaultPropertyValues),this._scope=o,this._options=u,this.isConfigDependent=!1}getValue(r){return gn(this._values[r].value)}setValue(r,o){this._values[r]=new td(this._values[r].property,o===null?void 0:gn(o),this._scope,this._options),this.isConfigDependent=this.isConfigDependent||this._values[r].expression.isConfigDependent}serialize(){const r={};for(const o of Object.keys(this._values)){const u=this.getValue(o);u!==void 0&&(r[o]=u)}return r}possiblyEvaluate(r,o,u){const f=new gu(this._properties);for(const m of Object.keys(this._values))f._values[m]=this._values[m].possiblyEvaluate(r,o,u);return f}}class ic{constructor(r,o,u){this.property=r,this.value=o,this.parameters=u}isConstant(){return this.value.kind==="constant"}constantOr(r){return this.value.kind==="constant"?this.value.value:r}evaluate(r,o,u,f){return this.property.evaluate(this.value,this.parameters,r,o,u,f)}}class gu{constructor(r){this._properties=r,this._values=Object.create(r.defaultPossiblyEvaluatedValues)}get(r){return this._values[r]}}class Pt{constructor(r){this.specification=r}possiblyEvaluate(r,o){return r.expression.evaluate(o)}interpolate(r,o,u){const f=dr[this.specification.type];return f?f(r,o,u):r}}class oi{constructor(r,o){this.specification=r,this.overrides=o}possiblyEvaluate(r,o,u,f){return new ic(this,r.expression.kind==="constant"||r.expression.kind==="camera"?{kind:"constant",value:r.expression.evaluate(o,null,{},u,f)}:r.expression,o)}interpolate(r,o,u){if(r.value.kind!=="constant"||o.value.kind!=="constant")return r;if(r.value.value===void 0||o.value.value===void 0)return new ic(this,{kind:"constant",value:void 0},r.parameters);const f=dr[this.specification.type];return f?new ic(this,{kind:"constant",value:f(r.value.value,o.value.value,u)},r.parameters):r}evaluate(r,o,u,f,m,y){return r.kind==="constant"?r.value:r.evaluate(o,u,f,m,y)}}class vl{constructor(r){this.specification=r}possiblyEvaluate(r,o,u,f){return!!r.expression.evaluate(o,null,{},u,f)}interpolate(){return!1}}class fn{constructor(r){this.properties=r,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const o=new dn(0,{});for(const u in r){const f=r[u];f.specification.overridable&&this.overridableProperties.push(u);const m=this.defaultPropertyValues[u]=new td(f,void 0),y=this.defaultTransitionablePropertyValues[u]=new Np(f);this.defaultTransitioningPropertyValues[u]=y.untransitioned(),this.defaultPossiblyEvaluatedValues[u]=m.possiblyEvaluate(o)}}}function yu(n){return n instanceof Number||n instanceof String||n instanceof Boolean?n.valueOf():n}function vu(n){if(Array.isArray(n))return n.map(vu);if(n instanceof Object&&!(n instanceof Number||n instanceof String||n instanceof Boolean)){const r={};for(const o in n)r[o]=vu(n[o]);return r}return yu(n)}Ht(oi,"DataDrivenProperty"),Ht(Pt,"DataConstantProperty"),Ht(vl,"ColorRampProperty");var Fe=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"camera":{"type":"camera"},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"expression":{},"property-type":"data-constant"},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function Bp(n){if(n===!0||n===!1)return!0;if(!Array.isArray(n)||n.length===0)return!1;switch(n[0]){case"has":return n.length>=2&&n[1]!=="$id"&&n[1]!=="$type";case"in":return n.length>=3&&(typeof n[1]!="string"||Array.isArray(n[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return n.length!==3||Array.isArray(n[1])||Array.isArray(n[2]);case"any":case"all":for(const r of n.slice(1))if(!Bp(r)&&typeof r!="boolean")return!1;return!0;default:return!0}}function ro(n,r="fill"){if(n==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Bp(n)||(n=xu(n));const o=n;let u=!0;try{u=function(E){if(!rc(E))return E;let M=vu(E);return zp(M),M=xg(M),M}(o)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(o,null,2)}
        `)}const f=Fe[`filter_${r}`],m=Jh(u,f);let y=null;if(m.result==="error")throw new Error(m.value.map(E=>`${E.key}: ${E.message}`).join(", "));y=(E,M,I)=>m.value.evaluate(E,M,{},I);let b=null,T=null;if(u!==o){const E=Jh(o,f);if(E.result==="error")throw new Error(E.value.map(M=>`${M.key}: ${M.message}`).join(", "));b=(M,I,k,F,z)=>E.value.evaluate(M,I,{},k,void 0,void 0,F,z),T=!Gl(E.value.expression)}return{filter:y,dynamicFilter:b||void 0,needGeometry:bg(u),needFeature:!!T}}function xg(n){if(!Array.isArray(n))return n;const r=function(o){if(j1.has(o[0])){for(let u=1;u<o.length;u++)if(rc(o[u]))return!0}return o}(n);return r===!0?r:r.map(o=>xg(o))}function zp(n){let r=!1;const o=[];if(n[0]==="case"){for(let u=1;u<n.length-1;u+=2)r=r||rc(n[u]),o.push(n[u+1]);o.push(n[n.length-1])}else if(n[0]==="match"){r=r||rc(n[1]);for(let u=2;u<n.length-1;u+=2)o.push(n[u+1]);o.push(n[n.length-1])}else if(n[0]==="step"){r=r||rc(n[1]);for(let u=1;u<n.length-1;u+=2)o.push(n[u+1])}r&&(n.length=0,n.push("any",...o));for(let u=1;u<n.length;u++)zp(n[u])}function rc(n){if(!Array.isArray(n))return!1;if((r=n[0])==="pitch"||r==="distance-from-center")return!0;var r;for(let o=1;o<n.length;o++)if(rc(n[o]))return!0;return!1}const j1=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function $1(n,r){return n<r?-1:n>r?1:0}function bg(n){if(!Array.isArray(n))return!1;if(n[0]==="within"||n[0]==="distance")return!0;for(let r=1;r<n.length;r++)if(bg(n[r]))return!0;return!1}function xu(n){if(!n)return!0;const r=n[0];return n.length<=1?r!=="any":r==="=="?bu(n[1],n[2],"=="):r==="!="?wu(bu(n[1],n[2],"==")):r==="<"||r===">"||r==="<="||r===">="?bu(n[1],n[2],r):r==="any"?(o=n.slice(1),["any"].concat(o.map(xu))):r==="all"?["all"].concat(n.slice(1).map(xu)):r==="none"?["all"].concat(n.slice(1).map(xu).map(wu)):r==="in"?Up(n[1],n.slice(2)):r==="!in"?wu(Up(n[1],n.slice(2))):r==="has"?wg(n[1]):r!=="!has"||wu(wg(n[1]));var o}function bu(n,r,o){switch(n){case"$type":return[`filter-type-${o}`,r];case"$id":return[`filter-id-${o}`,r];default:return[`filter-${o}`,n,r]}}function Up(n,r){if(r.length===0)return!1;switch(n){case"$type":return["filter-type-in",["literal",r]];case"$id":return["filter-id-in",["literal",r]];default:return r.length>200&&!r.some(o=>typeof o!=typeof r[0])?["filter-in-large",n,["literal",r.sort($1)]]:["filter-in-small",n,["literal",r]]}}function wg(n){switch(n){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",n]}}function wu(n){return["!",n]}const id="";function Vp(n,r){return r?`${n}${id}${r}`:n}const Tu="-transition";class Ws extends eo{constructor(r,o,u,f){if(super(),this.id=r.id,this.fqid=Vp(this.id,u),this.type=r.type,this.scope=u,this.options=f,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.isConfigDependent=!1,r.type!=="custom"&&(this.metadata=r.metadata,this.minzoom=r.minzoom,this.maxzoom=r.maxzoom,r.type!=="background"&&r.type!=="sky"&&r.type!=="slot"&&(this.source=r.source,this.sourceLayer=r["source-layer"],this.filter=r.filter),r.slot&&(this.slot=r.slot),o.layout&&(this._unevaluatedLayout=new V1(o.layout,this.scope,f),this.isConfigDependent=this.isConfigDependent||this._unevaluatedLayout.isConfigDependent),o.paint)){this._transitionablePaint=new ra(o.paint,this.scope,f);for(const m in r.paint)this.setPaintProperty(m,r.paint[m]);for(const m in r.layout)this.setLayoutProperty(m,r.layout[m]);this.isConfigDependent=this.isConfigDependent||this._transitionablePaint.isConfigDependent,this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new gu(o.paint)}}getLayoutProperty(r){return r==="visibility"?this.visibility:this._unevaluatedLayout.getValue(r)}setLayoutProperty(r,o){if(this.type==="custom"&&r==="visibility")return void(this.visibility=o);const u=this._unevaluatedLayout;u._properties.properties[r]&&(u.setValue(r,o),this.isConfigDependent=this.isConfigDependent||u.isConfigDependent,r==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0})}getPaintProperty(r){return Er(r,Tu)?this._transitionablePaint.getTransition(r.slice(0,-11)):this._transitionablePaint.getValue(r)}setPaintProperty(r,o){const u=this._transitionablePaint,f=u._properties.properties;if(Er(r,Tu)){const I=r.slice(0,-11);return f[I]&&u.setTransition(I,o||void 0),!1}if(!f[r])return!1;const m=u._values[r],y=m.value.isDataDriven(),b=m.value;u.setValue(r,o),this.isConfigDependent=this.isConfigDependent||u.isConfigDependent,this._handleSpecialPaintPropertyUpdate(r);const T=u._values[r].value,E=T.isDataDriven(),M=Er(r,"pattern")||r==="line-dasharray";return E||y||M||this._handleOverridablePaintPropertyUpdate(r,b,T)}_handleSpecialPaintPropertyUpdate(r){}getProgramIds(){return null}getDefaultProgramParams(r,o){return null}_handleOverridablePaintPropertyUpdate(r,o,u){return!1}isHidden(r){return!!(this.minzoom&&r<this.minzoom)||!!(this.maxzoom&&r>=this.maxzoom)||this.visibility==="none"}updateTransitions(r){this._transitioningPaint=this._transitionablePaint.transitioned(r,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(r,o){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(r,void 0,o)),this.paint=this._transitioningPaint.possiblyEvaluate(r,void 0,o)}serialize(){return In({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(r,o)=>!(r===void 0||o==="layout"&&!Object.keys(r).length||o==="paint"&&!Object.keys(r).length))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const r in this.paint._values){const o=this.paint.get(r);if(o instanceof ic&&Zh(o.property.specification)&&(o.value.kind==="source"||o.value.kind==="composite")&&o.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=ro(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(r){this._stats&&(r.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}}const W1={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class rd{constructor(r,o){this._structArray=r,this._pos1=o*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class en{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(r,o){return r._trim(),o&&(r.isTransferred=!0,o.add(r.arrayBuffer)),{length:r.length,arrayBuffer:r.arrayBuffer}}static deserialize(r){const o=Object.create(this.prototype);return o.arrayBuffer=r.arrayBuffer,o.length=r.length,o.capacity=r.arrayBuffer.byteLength/o.bytesPerElement,o._refreshViews(),o}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(r){this.reserve(r),this.length=r}reserve(r){if(r>this.capacity){this.capacity=Math.max(r,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const o=this.uint8;this._refreshViews(),o&&this.uint8.set(o)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...r){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...r){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Mr(n,r=1){let o=0,u=0;return{members:n.map(f=>{const m=W1[f.type].BYTES_PER_ELEMENT,y=o=Eu(o,Math.max(r,m)),b=f.components||1;return u=Math.max(u,m),o+=m*b,{name:f.name,type:f.type,components:b,offset:y}}),size:Eu(o,Math.max(u,r)),alignment:r}}function Eu(n,r){return Math.ceil(n/r)*r}class Ao extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(r,o){const u=this.length;return this.resize(u+1),this.emplace(u,r,o)}emplace(r,o,u){const f=2*r;return this.int16[f+0]=o,this.int16[f+1]=u,r}}Ao.prototype.bytesPerElement=4,Ht(Ao,"StructArrayLayout2i4");class Ls extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(r,o,u){const f=this.length;return this.resize(f+1),this.emplace(f,r,o,u)}emplace(r,o,u,f){const m=3*r;return this.int16[m+0]=o,this.int16[m+1]=u,this.int16[m+2]=f,r}}Ls.prototype.bytesPerElement=6,Ht(Ls,"StructArrayLayout3i6");class na extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(r,o,u,f){const m=this.length;return this.resize(m+1),this.emplace(m,r,o,u,f)}emplace(r,o,u,f,m){const y=4*r;return this.int16[y+0]=o,this.int16[y+1]=u,this.int16[y+2]=f,this.int16[y+3]=m,r}}na.prototype.bytesPerElement=8,Ht(na,"StructArrayLayout4i8");class jp extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m){const y=this.length;return this.resize(y+1),this.emplace(y,r,o,u,f,m)}emplace(r,o,u,f,m,y){const b=5*r;return this.int16[b+0]=o,this.int16[b+1]=u,this.int16[b+2]=f,this.int16[b+3]=m,this.int16[b+4]=y,r}}jp.prototype.bytesPerElement=10,Ht(jp,"StructArrayLayout5i10");class $p extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m,y,b){const T=this.length;return this.resize(T+1),this.emplace(T,r,o,u,f,m,y,b)}emplace(r,o,u,f,m,y,b,T){const E=6*r,M=12*r,I=3*r;return this.int16[E+0]=o,this.int16[E+1]=u,this.uint8[M+4]=f,this.uint8[M+5]=m,this.uint8[M+6]=y,this.uint8[M+7]=b,this.float32[I+2]=T,r}}$p.prototype.bytesPerElement=12,Ht($p,"StructArrayLayout2i4ub1f12");class Ba extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(r,o,u,f){const m=this.length;return this.resize(m+1),this.emplace(m,r,o,u,f)}emplace(r,o,u,f,m){const y=4*r;return this.float32[y+0]=o,this.float32[y+1]=u,this.float32[y+2]=f,this.float32[y+3]=m,r}}Ba.prototype.bytesPerElement=16,Ht(Ba,"StructArrayLayout4f16");class za extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m){const y=this.length;return this.resize(y+1),this.emplace(y,r,o,u,f,m)}emplace(r,o,u,f,m,y){const b=6*r,T=3*r;return this.uint16[b+0]=o,this.uint16[b+1]=u,this.uint16[b+2]=f,this.uint16[b+3]=m,this.float32[T+2]=y,r}}za.prototype.bytesPerElement=12,Ht(za,"StructArrayLayout4ui1f12");class nc extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(r,o,u,f){const m=this.length;return this.resize(m+1),this.emplace(m,r,o,u,f)}emplace(r,o,u,f,m){const y=4*r;return this.uint16[y+0]=o,this.uint16[y+1]=u,this.uint16[y+2]=f,this.uint16[y+3]=m,r}}nc.prototype.bytesPerElement=8,Ht(nc,"StructArrayLayout4ui8");class nd extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m,y){const b=this.length;return this.resize(b+1),this.emplace(b,r,o,u,f,m,y)}emplace(r,o,u,f,m,y,b){const T=6*r;return this.int16[T+0]=o,this.int16[T+1]=u,this.int16[T+2]=f,this.int16[T+3]=m,this.int16[T+4]=y,this.int16[T+5]=b,r}}nd.prototype.bytesPerElement=12,Ht(nd,"StructArrayLayout6i12");class Su extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m,y,b,T,E,M,I,k){const F=this.length;return this.resize(F+1),this.emplace(F,r,o,u,f,m,y,b,T,E,M,I,k)}emplace(r,o,u,f,m,y,b,T,E,M,I,k,F){const z=12*r;return this.int16[z+0]=o,this.int16[z+1]=u,this.int16[z+2]=f,this.int16[z+3]=m,this.uint16[z+4]=y,this.uint16[z+5]=b,this.uint16[z+6]=T,this.uint16[z+7]=E,this.int16[z+8]=M,this.int16[z+9]=I,this.int16[z+10]=k,this.int16[z+11]=F,r}}Su.prototype.bytesPerElement=24,Ht(Su,"StructArrayLayout4i4ui4i24");class Wp extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m,y){const b=this.length;return this.resize(b+1),this.emplace(b,r,o,u,f,m,y)}emplace(r,o,u,f,m,y,b){const T=10*r,E=5*r;return this.int16[T+0]=o,this.int16[T+1]=u,this.int16[T+2]=f,this.float32[E+2]=m,this.float32[E+3]=y,this.float32[E+4]=b,r}}Wp.prototype.bytesPerElement=20,Ht(Wp,"StructArrayLayout3i3f20");class Hp extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(r){const o=this.length;return this.resize(o+1),this.emplace(o,r)}emplace(r,o){return this.uint32[1*r+0]=o,r}}Hp.prototype.bytesPerElement=4,Ht(Hp,"StructArrayLayout1ul4");class zo extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(r,o){const u=this.length;return this.resize(u+1),this.emplace(u,r,o)}emplace(r,o,u){const f=2*r;return this.uint16[f+0]=o,this.uint16[f+1]=u,r}}zo.prototype.bytesPerElement=4,Ht(zo,"StructArrayLayout2ui4");class qp extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m,y,b,T,E,M,I,k,F){const z=this.length;return this.resize(z+1),this.emplace(z,r,o,u,f,m,y,b,T,E,M,I,k,F)}emplace(r,o,u,f,m,y,b,T,E,M,I,k,F,z){const V=20*r,W=10*r;return this.int16[V+0]=o,this.int16[V+1]=u,this.int16[V+2]=f,this.int16[V+3]=m,this.int16[V+4]=y,this.float32[W+3]=b,this.float32[W+4]=T,this.float32[W+5]=E,this.float32[W+6]=M,this.int16[V+14]=I,this.uint32[W+8]=k,this.uint16[V+18]=F,this.uint16[V+19]=z,r}}qp.prototype.bytesPerElement=40,Ht(qp,"StructArrayLayout5i4f1i1ul2ui40");class Au extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m,y,b){const T=this.length;return this.resize(T+1),this.emplace(T,r,o,u,f,m,y,b)}emplace(r,o,u,f,m,y,b,T){const E=8*r;return this.int16[E+0]=o,this.int16[E+1]=u,this.int16[E+2]=f,this.int16[E+4]=m,this.int16[E+5]=y,this.int16[E+6]=b,this.int16[E+7]=T,r}}Au.prototype.bytesPerElement=16,Ht(Au,"StructArrayLayout3i2i2i16");class sd extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m){const y=this.length;return this.resize(y+1),this.emplace(y,r,o,u,f,m)}emplace(r,o,u,f,m,y){const b=4*r,T=8*r;return this.float32[b+0]=o,this.float32[b+1]=u,this.float32[b+2]=f,this.int16[T+6]=m,this.int16[T+7]=y,r}}sd.prototype.bytesPerElement=16,Ht(sd,"StructArrayLayout2f1f2i16");class Gp extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(r,o,u,f){const m=this.length;return this.resize(m+1),this.emplace(m,r,o,u,f)}emplace(r,o,u,f,m){const y=12*r,b=3*r;return this.uint8[y+0]=o,this.uint8[y+1]=u,this.float32[b+1]=f,this.float32[b+2]=m,r}}Gp.prototype.bytesPerElement=12,Ht(Gp,"StructArrayLayout2ub2f12");class os extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(r,o,u){const f=this.length;return this.resize(f+1),this.emplace(f,r,o,u)}emplace(r,o,u,f){const m=3*r;return this.uint16[m+0]=o,this.uint16[m+1]=u,this.uint16[m+2]=f,r}}os.prototype.bytesPerElement=6,Ht(os,"StructArrayLayout3ui6");class sc extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m,y,b,T,E,M,I,k,F,z,V,W,G,te,se,ne,ye){const de=this.length;return this.resize(de+1),this.emplace(de,r,o,u,f,m,y,b,T,E,M,I,k,F,z,V,W,G,te,se,ne,ye)}emplace(r,o,u,f,m,y,b,T,E,M,I,k,F,z,V,W,G,te,se,ne,ye,de){const Ee=30*r,Pe=15*r,De=60*r;return this.int16[Ee+0]=o,this.int16[Ee+1]=u,this.int16[Ee+2]=f,this.float32[Pe+2]=m,this.float32[Pe+3]=y,this.uint16[Ee+8]=b,this.uint16[Ee+9]=T,this.uint32[Pe+5]=E,this.uint32[Pe+6]=M,this.uint32[Pe+7]=I,this.uint16[Ee+16]=k,this.uint16[Ee+17]=F,this.uint16[Ee+18]=z,this.float32[Pe+10]=V,this.float32[Pe+11]=W,this.uint8[De+48]=G,this.uint8[De+49]=te,this.uint8[De+50]=se,this.uint32[Pe+13]=ne,this.int16[Ee+28]=ye,this.uint8[De+58]=de,r}}sc.prototype.bytesPerElement=60,Ht(sc,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class od extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m,y,b,T,E,M,I,k,F,z,V,W,G,te,se,ne,ye,de,Ee,Pe,De,Ve,Le,rt,ht,Ze,ct,qe){const at=this.length;return this.resize(at+1),this.emplace(at,r,o,u,f,m,y,b,T,E,M,I,k,F,z,V,W,G,te,se,ne,ye,de,Ee,Pe,De,Ve,Le,rt,ht,Ze,ct,qe)}emplace(r,o,u,f,m,y,b,T,E,M,I,k,F,z,V,W,G,te,se,ne,ye,de,Ee,Pe,De,Ve,Le,rt,ht,Ze,ct,qe,at){const Ot=20*r,dt=40*r,Xt=80*r;return this.float32[Ot+0]=o,this.float32[Ot+1]=u,this.int16[dt+4]=f,this.int16[dt+5]=m,this.int16[dt+6]=y,this.int16[dt+7]=b,this.int16[dt+8]=T,this.int16[dt+9]=E,this.int16[dt+10]=M,this.int16[dt+11]=I,this.int16[dt+12]=k,this.uint16[dt+13]=F,this.uint16[dt+14]=z,this.uint16[dt+15]=V,this.uint16[dt+16]=W,this.uint16[dt+17]=G,this.uint16[dt+18]=te,this.uint16[dt+19]=se,this.uint16[dt+20]=ne,this.uint16[dt+21]=ye,this.uint16[dt+22]=de,this.uint16[dt+23]=Ee,this.uint16[dt+24]=Pe,this.uint16[dt+25]=De,this.uint16[dt+26]=Ve,this.uint16[dt+27]=Le,this.uint32[Ot+14]=rt,this.float32[Ot+15]=ht,this.float32[Ot+16]=Ze,this.float32[Ot+17]=ct,this.float32[Ot+18]=qe,this.uint8[Xt+76]=at,r}}od.prototype.bytesPerElement=80,Ht(od,"StructArrayLayout2f9i15ui1ul4f1ub80");class Mu extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(r){const o=this.length;return this.resize(o+1),this.emplace(o,r)}emplace(r,o){return this.float32[1*r+0]=o,r}}Mu.prototype.bytesPerElement=4,Ht(Mu,"StructArrayLayout1f4");class Ua extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m){const y=this.length;return this.resize(y+1),this.emplace(y,r,o,u,f,m)}emplace(r,o,u,f,m,y){const b=5*r;return this.float32[b+0]=o,this.float32[b+1]=u,this.float32[b+2]=f,this.float32[b+3]=m,this.float32[b+4]=y,r}}Ua.prototype.bytesPerElement=20,Ht(Ua,"StructArrayLayout5f20");class Xp extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m,y,b){const T=this.length;return this.resize(T+1),this.emplace(T,r,o,u,f,m,y,b)}emplace(r,o,u,f,m,y,b,T){const E=7*r;return this.float32[E+0]=o,this.float32[E+1]=u,this.float32[E+2]=f,this.float32[E+3]=m,this.float32[E+4]=y,this.float32[E+5]=b,this.float32[E+6]=T,r}}Xp.prototype.bytesPerElement=28,Ht(Xp,"StructArrayLayout7f28");class Cu extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(r,o,u,f){const m=this.length;return this.resize(m+1),this.emplace(m,r,o,u,f)}emplace(r,o,u,f,m){const y=6*r;return this.uint32[3*r+0]=o,this.uint16[y+2]=u,this.uint16[y+3]=f,this.uint16[y+4]=m,r}}Cu.prototype.bytesPerElement=12,Ht(Cu,"StructArrayLayout1ul3ui12");class Zp extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(r){const o=this.length;return this.resize(o+1),this.emplace(o,r)}emplace(r,o){return this.uint16[1*r+0]=o,r}}Zp.prototype.bytesPerElement=2,Ht(Zp,"StructArrayLayout1ui2");class xl extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(r,o,u){const f=this.length;return this.resize(f+1),this.emplace(f,r,o,u)}emplace(r,o,u,f){const m=3*r;return this.float32[m+0]=o,this.float32[m+1]=u,this.float32[m+2]=f,r}}xl.prototype.bytesPerElement=12,Ht(xl,"StructArrayLayout3f12");class Pu extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(r,o){const u=this.length;return this.resize(u+1),this.emplace(u,r,o)}emplace(r,o,u){const f=2*r;return this.float32[f+0]=o,this.float32[f+1]=u,r}}Pu.prototype.bytesPerElement=8,Ht(Pu,"StructArrayLayout2f8");class Yp extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m,y,b,T,E,M,I,k,F,z,V,W){const G=this.length;return this.resize(G+1),this.emplace(G,r,o,u,f,m,y,b,T,E,M,I,k,F,z,V,W)}emplace(r,o,u,f,m,y,b,T,E,M,I,k,F,z,V,W,G){const te=16*r;return this.float32[te+0]=o,this.float32[te+1]=u,this.float32[te+2]=f,this.float32[te+3]=m,this.float32[te+4]=y,this.float32[te+5]=b,this.float32[te+6]=T,this.float32[te+7]=E,this.float32[te+8]=M,this.float32[te+9]=I,this.float32[te+10]=k,this.float32[te+11]=F,this.float32[te+12]=z,this.float32[te+13]=V,this.float32[te+14]=W,this.float32[te+15]=G,r}}Yp.prototype.bytesPerElement=64,Ht(Yp,"StructArrayLayout16f64");class Iu extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(r,o,u,f,m,y,b){const T=this.length;return this.resize(T+1),this.emplace(T,r,o,u,f,m,y,b)}emplace(r,o,u,f,m,y,b,T){const E=10*r,M=5*r;return this.uint16[E+0]=o,this.uint16[E+1]=u,this.uint16[E+2]=f,this.uint16[E+3]=m,this.float32[M+2]=y,this.float32[M+3]=b,this.float32[M+4]=T,r}}Iu.prototype.bytesPerElement=20,Ht(Iu,"StructArrayLayout4ui3f20");class Kp extends en{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(r){const o=this.length;return this.resize(o+1),this.emplace(o,r)}emplace(r,o){return this.uint8[1*r+0]=o,r}}Kp.prototype.bytesPerElement=1,Ht(Kp,"StructArrayLayout1ub1");class Tg extends rd{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Tg.prototype.size=40;class Eg extends qp{get(r){return new Tg(this,r)}}Ht(Eg,"CollisionBoxArray");class Sg extends rd{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(r){this._structArray.uint8[this._pos1+49]=r}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(r){this._structArray.uint8[this._pos1+50]=r}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(r){this._structArray.uint32[this._pos4+13]=r}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(r){this._structArray.uint8[this._pos1+58]=r}}Sg.prototype.size=60;class Ag extends sc{get(r){return new Sg(this,r)}}Ht(Ag,"PlacedSymbolArray");class Mg extends rd{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(r){this._structArray.uint32[this._pos4+14]=r}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(r){this._structArray.float32[this._pos4+18]=r}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}Mg.prototype.size=80;class Cg extends od{get(r){return new Mg(this,r)}}Ht(Cg,"SymbolInstanceArray");class Pg extends Mu{getoffsetX(r){return this.float32[1*r+0]}}Ht(Pg,"GlyphOffsetArray");class Ru extends Ao{getx(r){return this.int16[2*r+0]}gety(r){return this.int16[2*r+1]}}Ht(Ru,"SymbolLineVertexArray");class Ig extends rd{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Ig.prototype.size=12;class Rg extends Cu{get(r){return new Ig(this,r)}}Ht(Rg,"FeatureIndexArray");class Ou extends zo{geta_centroid_pos0(r){return this.uint16[2*r+0]}geta_centroid_pos1(r){return this.uint16[2*r+1]}}Ht(Ou,"FillExtrusionCentroidArray");const H1=Mr([{name:"a_pos",components:2,type:"Int16"}],4),Og=Mr([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class wn{constructor(r=[]){this.segments=r}_prepareSegment(r,o,u,f){let m=this.segments[this.segments.length-1];return r>wn.MAX_VERTEX_ARRAY_LENGTH&&mr(`Max vertices per segment is ${wn.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${r}`),(!m||m.vertexLength+r>wn.MAX_VERTEX_ARRAY_LENGTH||m.sortKey!==f)&&(m={vertexOffset:o,primitiveOffset:u,vertexLength:0,primitiveLength:0},f!==void 0&&(m.sortKey=f),this.segments.push(m)),m}prepareSegment(r,o,u,f){return this._prepareSegment(r,o.length,u.length,f)}get(){return this.segments}destroy(){for(const r of this.segments)for(const o in r.vaos)r.vaos[o].destroy()}static simpleSegment(r,o,u,f){return new wn([{vertexOffset:r,primitiveOffset:o,vertexLength:u,primitiveLength:f,vaos:{},sortKey:0}])}}function Jp(n,r){return 256*(n=ri(Math.floor(n),0,255))+ri(Math.floor(r),0,255)}wn.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Ht(wn,"SegmentVector");const kg=Mr([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Dg=Mr([{name:"a_dash",components:4,type:"Uint16"}]);var ku={exports:{}},ad={exports:{}};(function(n){n.exports=function(r,o){var u,f,m,y,b,T,E,M;for(f=r.length-(u=3&r.length),m=o,b=3432918353,T=461845907,M=0;M<f;)E=255&r.charCodeAt(M)|(255&r.charCodeAt(++M))<<8|(255&r.charCodeAt(++M))<<16|(255&r.charCodeAt(++M))<<24,++M,m=27492+(65535&(y=5*(65535&(m=(m^=E=(65535&(E=(E=(65535&E)*b+(((E>>>16)*b&65535)<<16)&4294967295)<<15|E>>>17))*T+(((E>>>16)*T&65535)<<16)&4294967295)<<13|m>>>19))+((5*(m>>>16)&65535)<<16)&4294967295))+((58964+(y>>>16)&65535)<<16);switch(E=0,u){case 3:E^=(255&r.charCodeAt(M+2))<<16;case 2:E^=(255&r.charCodeAt(M+1))<<8;case 1:m^=E=(65535&(E=(E=(65535&(E^=255&r.charCodeAt(M)))*b+(((E>>>16)*b&65535)<<16)&4294967295)<<15|E>>>17))*T+(((E>>>16)*T&65535)<<16)&4294967295}return m^=r.length,m=2246822507*(65535&(m^=m>>>16))+((2246822507*(m>>>16)&65535)<<16)&4294967295,m=3266489909*(65535&(m^=m>>>13))+((3266489909*(m>>>16)&65535)<<16)&4294967295,(m^=m>>>16)>>>0}})(ad);var Qp=ad.exports,Lg={exports:{}};(function(n){n.exports=function(r,o){for(var u,f=r.length,m=o^f,y=0;f>=4;)u=1540483477*(65535&(u=255&r.charCodeAt(y)|(255&r.charCodeAt(++y))<<8|(255&r.charCodeAt(++y))<<16|(255&r.charCodeAt(++y))<<24))+((1540483477*(u>>>16)&65535)<<16),m=1540483477*(65535&m)+((1540483477*(m>>>16)&65535)<<16)^(u=1540483477*(65535&(u^=u>>>24))+((1540483477*(u>>>16)&65535)<<16)),f-=4,++y;switch(f){case 3:m^=(255&r.charCodeAt(y+2))<<16;case 2:m^=(255&r.charCodeAt(y+1))<<8;case 1:m=1540483477*(65535&(m^=255&r.charCodeAt(y)))+((1540483477*(m>>>16)&65535)<<16)}return m=1540483477*(65535&(m^=m>>>13))+((1540483477*(m>>>16)&65535)<<16),(m^=m>>>15)>>>0}})(Lg);var Ng=Qp,Fg=Lg.exports;ku.exports=Ng,ku.exports.murmur3=Ng,ku.exports.murmur2=Fg;var em=pe(ku.exports);class Du{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(r,o,u,f){this.ids.push(Bg(r)),this.positions.push(o,u,f)}eachPosition(r,o){const u=Bg(r);let f=0,m=this.ids.length-1;for(;f<m;){const y=f+m>>1;this.ids[y]>=u?m=y:f=y+1}for(;this.ids[f]===u;)o(this.positions[3*f],this.positions[3*f+1],this.positions[3*f+2]),f++}static serialize(r,o){const u=new Float64Array(r.ids),f=new Uint32Array(r.positions);return tm(u,f,0,u.length-1),o&&(o.add(u.buffer),o.add(f.buffer)),{ids:u,positions:f}}static deserialize(r){const o=new Du;let u;o.ids=r.ids,o.positions=r.positions;for(const f of o.ids)f!==u&&o.uniqueIds.push(f),u=f;return o.indexed=!0,o}}function Bg(n){const r=+n;return!isNaN(r)&&Number.MIN_SAFE_INTEGER<=r&&r<=Number.MAX_SAFE_INTEGER?r:em(String(n))}function tm(n,r,o,u){for(;o<u;){const f=n[o+u>>1];let m=o-1,y=u+1;for(;;){do m++;while(n[m]<f);do y--;while(n[y]>f);if(m>=y)break;ld(n,m,y),ld(r,3*m,3*y),ld(r,3*m+1,3*y+1),ld(r,3*m+2,3*y+2)}y-o<u-y?(tm(n,r,o,y),o=y+1):(tm(n,r,y+1,u),u=y)}}function ld(n,r,o){const u=n[r];n[r]=n[o],n[o]=u}Ht(Du,"FeaturePositionMap");class sa{constructor(r){this.gl=r.gl,this.initialized=!1}fetchUniformLocation(r,o){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(r,o),this.initialized=!0),!!this.location}}class cd extends sa{constructor(r){super(r),this.current=0}set(r,o,u){this.fetchUniformLocation(r,o)&&this.current!==u&&(this.current=u,this.gl.uniform1i(this.location,u))}}class Ps extends sa{constructor(r){super(r),this.current=0}set(r,o,u){this.fetchUniformLocation(r,o)&&this.current!==u&&(this.current=u,this.gl.uniform1f(this.location,u))}}class Va extends sa{constructor(r){super(r),this.current=[0,0]}set(r,o,u){this.fetchUniformLocation(r,o)&&(u[0]===this.current[0]&&u[1]===this.current[1]||(this.current=u,this.gl.uniform2f(this.location,u[0],u[1])))}}class zg extends sa{constructor(r){super(r),this.current=[0,0,0]}set(r,o,u){this.fetchUniformLocation(r,o)&&(u[0]===this.current[0]&&u[1]===this.current[1]&&u[2]===this.current[2]||(this.current=u,this.gl.uniform3f(this.location,u[0],u[1],u[2])))}}class _ extends sa{constructor(r){super(r),this.current=[0,0,0,0]}set(r,o,u){this.fetchUniformLocation(r,o)&&(u[0]===this.current[0]&&u[1]===this.current[1]&&u[2]===this.current[2]&&u[3]===this.current[3]||(this.current=u,this.gl.uniform4f(this.location,u[0],u[1],u[2],u[3])))}}class a extends sa{constructor(r){super(r),this.current=Qt.transparent}set(r,o,u){this.fetchUniformLocation(r,o)&&(u.r===this.current.r&&u.g===this.current.g&&u.b===this.current.b&&u.a===this.current.a||(this.current=u,this.gl.uniform4f(this.location,u.r,u.g,u.b,u.a)))}}const d=new Float32Array(16);class g extends sa{constructor(r){super(r),this.current=d}set(r,o,u){if(this.fetchUniformLocation(r,o)){if(u[12]!==this.current[12]||u[0]!==this.current[0])return this.current=u,void this.gl.uniformMatrix4fv(this.location,!1,u);for(let f=1;f<16;f++)if(u[f]!==this.current[f]){this.current=u,this.gl.uniformMatrix4fv(this.location,!1,u);break}}}}const x=new Float32Array(9),w=new Float32Array(4);class S extends sa{constructor(r){super(r),this.current=w}set(r,o,u){if(this.fetchUniformLocation(r,o)){for(let f=0;f<4;f++)if(u[f]!==this.current[f]){this.current=u,this.gl.uniformMatrix2fv(this.location,!1,u);break}}}}function C(n){return[Jp(255*n.r,255*n.g),Jp(255*n.b,255*n.a)]}class R{constructor(r,o,u){this.value=r,this.uniformNames=o.map(f=>`u_${f}`),this.type=u}setUniform(r,o,u,f,m){o.set(r,m,f.constantOr(this.value))}getBinding(r,o){return this.type==="color"?new a(r):new Ps(r)}}class D{constructor(r,o){this.uniformNames=o.map(u=>`u_${u}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(r){this.pixelRatio=r.pixelRatio||1,this.pattern=r.tl.concat(r.br)}setUniform(r,o,u,f,m){const y=m==="u_pattern"||m==="u_dash"?this.pattern:m==="u_pixel_ratio"?this.pixelRatio:null;y&&o.set(r,m,y)}getBinding(r,o){return o==="u_pattern"||o==="u_dash"?new _(r):new Ps(r)}}class N{constructor(r,o,u,f){this.expression=r,this.type=u,this.maxValue=0,this.paintVertexAttributes=o.map(m=>({name:`a_${m}`,type:"Float32",components:u==="color"?2:1,offset:0})),this.paintVertexArray=new f}populatePaintArray(r,o,u,f,m,y,b){const T=this.paintVertexArray.length,E=this.expression.evaluate(new dn(0,{brightness:y}),o,{},m,f,b);this.paintVertexArray.resize(r),this._setPaintValue(T,r,E)}updatePaintArray(r,o,u,f,m,y,b){const T=this.expression.evaluate({zoom:0,brightness:b},u,f,void 0,m);this._setPaintValue(r,o,T)}_setPaintValue(r,o,u){if(this.type==="color"){const f=C(u);for(let m=r;m<o;m++)this.paintVertexArray.emplace(m,f[0],f[1])}else{for(let f=r;f<o;f++)this.paintVertexArray.emplace(f,u);this.maxValue=Math.max(this.maxValue,Math.abs(u))}}upload(r){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=r.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class B{constructor(r,o,u,f,m,y){this.expression=r,this.uniformNames=o.map(b=>`u_${b}_t`),this.type=u,this.useIntegerZoom=f,this.zoom=m,this.maxValue=0,this.paintVertexAttributes=o.map(b=>({name:`a_${b}`,type:"Float32",components:u==="color"?4:2,offset:0})),this.paintVertexArray=new y}populatePaintArray(r,o,u,f,m,y,b){const T=this.expression.evaluate(new dn(this.zoom,{brightness:y}),o,{},m,f,b),E=this.expression.evaluate(new dn(this.zoom+1,{brightness:y}),o,{},m,f,b),M=this.paintVertexArray.length;this.paintVertexArray.resize(r),this._setPaintValue(M,r,T,E)}updatePaintArray(r,o,u,f,m,y,b){const T=this.expression.evaluate({zoom:this.zoom,brightness:b},u,f,void 0,m),E=this.expression.evaluate({zoom:this.zoom+1,brightness:b},u,f,void 0,m);this._setPaintValue(r,o,T,E)}_setPaintValue(r,o,u,f){if(this.type==="color"){const m=C(u),y=C(f);for(let b=r;b<o;b++)this.paintVertexArray.emplace(b,m[0],m[1],y[0],y[1])}else{for(let m=r;m<o;m++)this.paintVertexArray.emplace(m,u,f);this.maxValue=Math.max(this.maxValue,Math.abs(u),Math.abs(f))}}upload(r){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=r.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(r,o,u,f,m){const y=this.useIntegerZoom?Math.floor(u.zoom):u.zoom,b=ri(this.expression.interpolationFactor(y,this.zoom,this.zoom+1),0,1);o.set(r,m,b)}getBinding(r,o){return new Ps(r)}}class j{constructor(r,o,u,f,m){this.expression=r,this.layerId=m,this.paintVertexAttributes=(u==="array"?Dg:kg).members;for(let y=0;y<o.length;++y);this.paintVertexArray=new f}populatePaintArray(r,o,u){const f=this.paintVertexArray.length;this.paintVertexArray.resize(r),this._setPaintValues(f,r,o.patterns&&o.patterns[this.layerId],u)}updatePaintArray(r,o,u,f,m,y,b){this._setPaintValues(r,o,u.patterns&&u.patterns[this.layerId],y)}_setPaintValues(r,o,u,f){if(!f||!u)return;const m=f[u];if(!m)return;const{tl:y,br:b,pixelRatio:T}=m;for(let E=r;E<o;E++)this.paintVertexArray.emplace(E,y[0],y[1],b[0],b[1],T)}upload(r){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=r.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class ${constructor(r,o,u=()=>!0){this.binders={},this._buffers=[];const f=[];for(const m in r.paint._values){const y=r.paint.get(m);if(!u(m)||!(y instanceof ic&&Zh(y.property.specification)))continue;const b=K(m,r.type),T=y.value,E=y.property.specification.type,M=!!y.property.useIntegerZoom,I=m==="line-dasharray"||m.endsWith("pattern"),k=m==="line-dasharray"&&r.layout.get("line-cap").value.kind!=="constant";if(T.kind!=="constant"||k)if(T.kind==="source"||k||I){const F=ae(m,E,"source");this.binders[m]=I?new j(T,b,E,F,r.id):new N(T,b,E,F),f.push(`/a_${m}`)}else{const F=ae(m,E,"composite");this.binders[m]=new B(T,b,E,M,o,F),f.push(`/z_${m}`)}else this.binders[m]=I?new D(T.value,b):new R(T.value,b,E),f.push(`/u_${m}`)}this.cacheKey=f.sort().join("")}getMaxValue(r){const o=this.binders[r];return o instanceof N||o instanceof B?o.maxValue:0}populatePaintArrays(r,o,u,f,m,y,b){for(const T in this.binders){const E=this.binders[T];(E instanceof N||E instanceof B||E instanceof j)&&E.populatePaintArray(r,o,u,f,m,y,b)}}setConstantPatternPositions(r){for(const o in this.binders){const u=this.binders[o];u instanceof D&&u.setConstantPatternPositions(r)}}updatePaintArrays(r,o,u,f,m,y,b,T){let E=!1;const M=Object.keys(r),I=M.length!==0,k=I?M:o.uniqueIds;for(const F in this.binders){const z=this.binders[F];if((z instanceof N||z instanceof B||z instanceof j)&&(z.expression.isStateDependent===!0||z.expression.isLightConstant===!1)){const V=m.paint.get(F);z.expression=V.value;for(const W of k){const G=r[W.toString()];o.eachPosition(W,(te,se,ne)=>{const ye=f.feature(te);z.updatePaintArray(se,ne,ye,G,y,b,T)})}if(!I)for(const W of u.uniqueIds){const G=r[W.toString()];u.eachPosition(W,(te,se,ne)=>{const ye=f.feature(te);z.updatePaintArray(se,ne,ye,G,y,b,T)})}E=!0}}return E}defines(){const r=[];for(const o in this.binders){const u=this.binders[o];(u instanceof R||u instanceof D)&&r.push(...u.uniformNames.map(f=>`#define HAS_UNIFORM_${f}`))}return r}getBinderAttributes(){const r=[];for(const o in this.binders){const u=this.binders[o];if(u instanceof N||u instanceof B||u instanceof j)for(let f=0;f<u.paintVertexAttributes.length;f++)r.push(u.paintVertexAttributes[f].name)}return r}getBinderUniforms(){const r=[];for(const o in this.binders){const u=this.binders[o];if(u instanceof R||u instanceof D||u instanceof B)for(const f of u.uniformNames)r.push(f)}return r}getPaintVertexBuffers(){return this._buffers}getUniforms(r){const o=[];for(const u in this.binders){const f=this.binders[u];if(f instanceof R||f instanceof D||f instanceof B)for(const m of f.uniformNames)o.push({name:m,property:u,binding:f.getBinding(r,m)})}return o}setUniforms(r,o,u,f,m){for(const{name:y,property:b,binding:T}of u)this.binders[b].setUniform(r,T,m,f.get(b),y)}updatePaintBuffers(){this._buffers=[];for(const r in this.binders){const o=this.binders[r];(o instanceof N||o instanceof B||o instanceof j)&&o.paintVertexBuffer&&this._buffers.push(o.paintVertexBuffer)}}upload(r){for(const o in this.binders){const u=this.binders[o];(u instanceof N||u instanceof B||u instanceof j)&&u.upload(r)}this.updatePaintBuffers()}destroy(){for(const r in this.binders){const o=this.binders[r];(o instanceof N||o instanceof B||o instanceof j)&&o.destroy()}}}class Z{constructor(r,o,u=()=>!0){this.programConfigurations={};for(const f of r)this.programConfigurations[f.id]=new $(f,o,u);this.needsUpload=!1,this._featureMap=new Du,this._featureMapWithoutIds=new Du,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(r,o,u,f,m,y,b,T){for(const E in this.programConfigurations)this.programConfigurations[E].populatePaintArrays(r,o,f,m,y,b,T);o.id!==void 0?this._featureMap.add(o.id,u,this._bufferOffset,r):(this._featureMapWithoutIds.add(this._idlessCounter,u,this._bufferOffset,r),this._idlessCounter+=1),this._bufferOffset=r,this.needsUpload=!0}updatePaintArrays(r,o,u,f,m,y){for(const b of u)this.needsUpload=this.programConfigurations[b.id].updatePaintArrays(r,this._featureMap,this._featureMapWithoutIds,o,b,f,m,y||0)||this.needsUpload}get(r){return this.programConfigurations[r]}upload(r){if(this.needsUpload){for(const o in this.programConfigurations)this.programConfigurations[o].upload(r);this.needsUpload=!1}}destroy(){for(const r in this.programConfigurations)this.programConfigurations[r].destroy()}}const X={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function K(n,r){return X[n]||[n.replace(`${r}-`,"").replace(/-/g,"_")]}const q={"line-pattern":{source:za,composite:za},"fill-pattern":{source:za,composite:za},"fill-extrusion-pattern":{source:za,composite:za},"line-dasharray":{source:nc,composite:nc}},ee={color:{source:Pu,composite:Ba},number:{source:Mu,composite:Pu}};function ae(n,r,o){const u=q[n];return u&&u[o]||ee[r][o]}Ht(R,"ConstantBinder"),Ht(D,"PatternConstantBinder"),Ht(N,"SourceExpressionBinder"),Ht(j,"PatternCompositeBinder"),Ht(B,"CompositeExpressionBinder"),Ht($,"ProgramConfiguration",{omit:["_buffers"]}),Ht(Z,"ProgramConfigurationSet");const re=Bt/Math.PI/2,le=5,Q=6,ce=16383,ve=64,we=[ve,32,16],Ce=-re,Ue=re;function Re(n,r,o,u=re){return o=Qe(o),[n*Math.sin(o)*u,-r*u,n*Math.cos(o)*u]}function Ye(n,r,o){return Re(Math.cos(Qe(n)),Math.sin(Qe(n)),r,o)}const Ge=63710088e-1,pt=2*Math.PI*Ge;class ke{constructor(r,o){if(isNaN(r)||isNaN(o))throw new Error(`Invalid LngLat object: (${r}, ${o})`);if(this.lng=+r,this.lat=+o,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new ke(Gr(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(r){const o=Math.PI/180,u=this.lat*o,f=r.lat*o,m=Math.sin(u)*Math.sin(f)+Math.cos(u)*Math.cos(f)*Math.cos((r.lng-this.lng)*o);return Ge*Math.acos(Math.min(m,1))}toBounds(r=0){const o=360*r/40075017,u=o/Math.cos(Math.PI/180*this.lat);return new He({lng:this.lng-u,lat:this.lat-o},{lng:this.lng+u,lat:this.lat+o})}toEcef(r){return Ye(this.lat,this.lng,re+r*re/Ge)}static convert(r){if(r instanceof ke)return r;if(Array.isArray(r)&&(r.length===2||r.length===3))return new ke(Number(r[0]),Number(r[1]));if(!Array.isArray(r)&&typeof r=="object"&&r!==null)return new ke(Number("lng"in r?r.lng:r.lon),Number(r.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class He{constructor(r,o){r&&(o?this.setSouthWest(r).setNorthEast(o):r.length===4?this.setSouthWest([r[0],r[1]]).setNorthEast([r[2],r[3]]):this.setSouthWest(r[0]).setNorthEast(r[1]))}setNorthEast(r){return this._ne=r instanceof ke?new ke(r.lng,r.lat):ke.convert(r),this}setSouthWest(r){return this._sw=r instanceof ke?new ke(r.lng,r.lat):ke.convert(r),this}extend(r){const o=this._sw,u=this._ne;let f,m;if(r instanceof ke)f=r,m=r;else{if(!(r instanceof He))return Array.isArray(r)?r.length===4||r.every(Array.isArray)?this.extend(He.convert(r)):this.extend(ke.convert(r)):typeof r=="object"&&r!==null&&r.hasOwnProperty("lat")&&(r.hasOwnProperty("lon")||r.hasOwnProperty("lng"))?this.extend(ke.convert(r)):this;if(f=r._sw,m=r._ne,!f||!m)return this}return o||u?(o.lng=Math.min(f.lng,o.lng),o.lat=Math.min(f.lat,o.lat),u.lng=Math.max(m.lng,u.lng),u.lat=Math.max(m.lat,u.lat)):(this._sw=new ke(f.lng,f.lat),this._ne=new ke(m.lng,m.lat)),this}getCenter(){return new ke((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new ke(this.getWest(),this.getNorth())}getSouthEast(){return new ke(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(r){const{lng:o,lat:u}=ke.convert(r);let f=this._sw.lng<=o&&o<=this._ne.lng;return this._sw.lng>this._ne.lng&&(f=this._sw.lng>=o&&o>=this._ne.lng),this._sw.lat<=u&&u<=this._ne.lat&&f}static convert(r){return!r||r instanceof He?r:new He(r)}}var Me={};(function(n,r){(function(o){function u(m,y,b){var T=f(256*m,256*(y=Math.pow(2,b)-y-1),b),E=f(256*(m+1),256*(y+1),b);return T[0]+","+T[1]+","+E[0]+","+E[1]}function f(m,y,b){var T=2*Math.PI*6378137/256/Math.pow(2,b);return[m*T-2*Math.PI*6378137/2,y*T-2*Math.PI*6378137/2]}o.getURL=function(m,y,b,T,E,M){return M=M||{},m+"?"+["bbox="+u(b,T,E),"format="+(M.format||"image/png"),"service="+(M.service||"WMS"),"version="+(M.version||"1.1.1"),"request="+(M.request||"GetMap"),"srs="+(M.srs||"EPSG:3857"),"width="+(M.width||256),"height="+(M.height||256),"layers="+y].join("&")},o.getTileBBox=u,o.getMercCoords=f,Object.defineProperty(o,"__esModule",{value:!0})})(r)})(0,Me);var Ne=Me;class mt{constructor(r,o,u){this.z=r,this.x=o,this.y=u,this.key=Lt(0,r,r,o,u)}equals(r){return this.z===r.z&&this.x===r.x&&this.y===r.y}url(r,o){const u=Ne.getTileBBox(this.x,this.y,this.z),f=function(m,y,b){let T,E="";for(let M=m;M>0;M--)T=1<<M-1,E+=(y&T?1:0)+(b&T?2:0);return E}(this.z,this.x,this.y);return r[(this.x+this.y)%r.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(o==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",f).replace("{bbox-epsg-3857}",u)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Mt{constructor(r,o){this.wrap=r,this.canonical=o,this.key=Lt(r,o.z,o.z,o.x,o.y)}}class Tt{constructor(r,o,u,f,m){this.overscaledZ=r,this.wrap=o,this.canonical=new mt(u,+f,+m),this.key=o===0&&r===u?this.canonical.key:Lt(o,r,u,f,m)}equals(r){return this.overscaledZ===r.overscaledZ&&this.wrap===r.wrap&&this.canonical.equals(r.canonical)}scaledTo(r){const o=this.canonical.z-r;return r>this.canonical.z?new Tt(r,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Tt(r,this.wrap,r,this.canonical.x>>o,this.canonical.y>>o)}calculateScaledKey(r,o=!0){if(this.overscaledZ===r&&o)return this.key;if(r>this.canonical.z)return Lt(this.wrap*+o,r,this.canonical.z,this.canonical.x,this.canonical.y);{const u=this.canonical.z-r;return Lt(this.wrap*+o,r,r,this.canonical.x>>u,this.canonical.y>>u)}}isChildOf(r){if(r.wrap!==this.wrap)return!1;const o=this.canonical.z-r.canonical.z;return r.overscaledZ===0||r.overscaledZ<this.overscaledZ&&r.canonical.z<this.canonical.z&&r.canonical.x===this.canonical.x>>o&&r.canonical.y===this.canonical.y>>o}children(r){if(this.overscaledZ>=r)return[new Tt(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const o=this.canonical.z+1,u=2*this.canonical.x,f=2*this.canonical.y;return[new Tt(o,this.wrap,o,u,f),new Tt(o,this.wrap,o,u+1,f),new Tt(o,this.wrap,o,u,f+1),new Tt(o,this.wrap,o,u+1,f+1)]}isLessThan(r){return this.wrap<r.wrap||!(this.wrap>r.wrap)&&(this.overscaledZ<r.overscaledZ||!(this.overscaledZ>r.overscaledZ)&&(this.canonical.x<r.canonical.x||!(this.canonical.x>r.canonical.x)&&this.canonical.y<r.canonical.y))}wrapped(){return new Tt(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(r){return new Tt(this.overscaledZ,r,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Mt(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Lt(n,r,o,u,f){const m=1<<Math.min(o,22);let y=m*(f%m)+u%m;return n&&o<22&&(y+=m*m*((n<0?-2*n-1:2*n)%(1<<2*(22-o)))),16*(32*y+o)+(r-o)}const Zt=[n=>{let r=n.canonical.x-1,o=n.wrap;return r<0&&(r=(1<<n.canonical.z)-1,o--),new Tt(n.overscaledZ,o,n.canonical.z,r,n.canonical.y)},n=>{let r=n.canonical.x+1,o=n.wrap;return r===1<<n.canonical.z&&(r=0,o++),new Tt(n.overscaledZ,o,n.canonical.z,r,n.canonical.y)},n=>new Tt(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,(n.canonical.y===0?1<<n.canonical.z:n.canonical.y)-1),n=>new Tt(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,n.canonical.y===(1<<n.canonical.z)-1?0:n.canonical.y+1)];Ht(mt,"CanonicalTileID"),Ht(Tt,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const si=0,ei=25.5;function ii(n){return pt*Math.cos(n*Math.PI/180)}function Ii(n){return(180+n)/360}function gi(n){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n*Math.PI/360)))/360}function Ti(n,r){return n/ii(r)}function wi(n){return 360*n-180}function Qi(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function Vr(n,r){return n*ii(Qi(r))}const Ui=85.051129;function pn(n){return Math.cos(Qe(ri(n,-Ui,Ui)))}function Vi(n,r){const o=ri(r,si,ei),u=Math.pow(2,o);return pn(n)*pt/(512*u)}function lr(n){return 1/Math.cos(n*Math.PI/180)}function ji(n,r=0){const o=Math.exp(Math.PI*(1-(n.y+r/Bt)/(1<<n.z)*2));return 80150034*o/(o*o+1)/Bt/(1<<n.z)}class sr{constructor(r,o,u=0){this.x=+r,this.y=+o,this.z=+u}static fromLngLat(r,o=0){const u=ke.convert(r);return new sr(Ii(u.lng),gi(u.lat),Ti(o,u.lat))}toLngLat(){return new ke(wi(this.x),Qi(this.y))}toAltitude(){return Vr(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/pt*lr(Qi(this.y))}}function Xr(n,r,o,u,f,m,y,b,T){const E=(r+u)/2,M=(o+f)/2,I=new xe(E,M);b(I),function(k,F,z,V,W,G){const te=z-W,se=V-G;return Math.abs((V-F)*te-(z-k)*se)/Math.hypot(te,se)}(I.x,I.y,m.x,m.y,y.x,y.y)>=T?(Xr(n,r,o,E,M,m,I,b,T),Xr(n,E,M,u,f,I,y,b,T)):n.push(y)}function gr(n,r,o){let u=n[0],f=u.x,m=u.y;r(u);const y=[u];for(let b=1;b<n.length;b++){const T=n[b],{x:E,y:M}=T;r(T),Xr(y,f,m,E,M,u,T,r,o),f=E,m=M,u=T}return y}function as(n,r,o,u){if(u(r,o)){const f=r.add(o)._mult(.5);as(n,r,f,u),as(n,f,o,u)}else n.push(o)}function vs(n,r){let o=n[0];const u=[o];for(let f=1;f<n.length;f++){const m=n[f];as(u,o,m,r),o=m}return u}const Hs=Math.pow(2,14)-1,Uo=-Hs-1;function qs(n,r){const o=Math.round(n.x*r),u=Math.round(n.y*r);return n.x=ri(o,Uo,Hs),n.y=ri(u,Uo,Hs),(o<n.x||o>n.x+1||u<n.y||u>n.y+1)&&mr("Geometry exceeds allowed extent, reduce your vector tile buffer size"),n}function ls(n,r,o){const u=n.loadGeometry(),f=n.extent,m=Bt/f;if(r&&o&&o.projection.isReprojectedInTileSpace){const y=1<<r.z,{scale:b,x:T,y:E,projection:M}=o,I=k=>{const F=wi((r.x+k.x/f)/y),z=Qi((r.y+k.y/f)/y),V=M.project(F,z);k.x=(V.x*b-T)*f,k.y=(V.y*b-E)*f};for(let k=0;k<u.length;k++)if(n.type!==1)u[k]=gr(u[k],I,1);else{const F=[];for(const z of u[k])z.x<0||z.x>=f||z.y<0||z.y>=f||(I(z),F.push(z));u[k]=F}}for(const y of u)for(const b of y)qs(b,m);return u}function Xn(n,r){return{type:n.type,id:n.id,properties:n.properties,geometry:r?ls(n):[]}}function Is(n,r,o,u,f){n.emplaceBack(2*r+(u+1)/2,2*o+(f+1)/2)}function Ns(n,r,o){n.emplaceBack(r.x,r.y,r.z,o[0]*16384,o[1]*16384,o[2]*16384)}class Gs{constructor(r){this.zoom=r.zoom,this.overscaling=r.overscaling,this.layers=r.layers,this.layerIds=this.layers.map(o=>o.fqid),this.index=r.index,this.hasPattern=!1,this.projection=r.projection,this.layoutVertexArray=new Ao,this.indexArray=new os,this.segments=new wn,this.programConfigurations=new Z(r.layers,r.zoom),this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id)}populate(r,o,u,f){const m=this.layers[0],y=[];let b=null;m.type==="circle"&&(b=m.layout.get("circle-sort-key"));for(const{feature:E,id:M,index:I,sourceLayerIndex:k}of r){const F=this.layers[0]._featureFilter.needGeometry,z=Xn(E,F);if(!this.layers[0]._featureFilter.filter(new dn(this.zoom),z,u))continue;const V=b?b.evaluate(z,{},u):void 0,W={id:M,properties:E.properties,type:E.type,sourceLayerIndex:k,index:I,geometry:F?z.geometry:ls(E,u,f),patterns:{},sortKey:V};y.push(W)}b&&y.sort((E,M)=>E.sortKey-M.sortKey);let T=null;f.projection.name==="globe"&&(this.globeExtVertexArray=new nd,T=f.projection);for(const E of y){const{geometry:M,index:I,sourceLayerIndex:k}=E,F=r[I].feature;this.addFeature(E,M,I,o.availableImages,u,T,o.brightness),o.featureIndex.insert(F,M,I,k,this.index)}}update(r,o,u,f,m){const y=Object.keys(r).length!==0;y&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(r,o,y?this.stateDependentLayers:this.layers,u,f,m)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(r){this.uploaded||(this.layoutVertexBuffer=r.createVertexBuffer(this.layoutVertexArray,H1.members),this.indexBuffer=r.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=r.createVertexBuffer(this.globeExtVertexArray,Og.members))),this.programConfigurations.upload(r),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(r,o,u,f,m,y,b){for(const T of o)for(const E of T){const M=E.x,I=E.y;if(M<0||M>=Bt||I<0||I>=Bt)continue;if(y){const z=y.projectTilePoint(M,I,m),V=y.upVector(m,M,I),W=this.globeExtVertexArray;Ns(W,z,V),Ns(W,z,V),Ns(W,z,V),Ns(W,z,V)}const k=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,r.sortKey),F=k.vertexLength;Is(this.layoutVertexArray,M,I,-1,-1),Is(this.layoutVertexArray,M,I,1,-1),Is(this.layoutVertexArray,M,I,1,1),Is(this.layoutVertexArray,M,I,-1,1),this.indexArray.emplaceBack(F,F+1,F+2),this.indexArray.emplaceBack(F,F+2,F+3),k.vertexLength+=4,k.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,r,u,{},f,m,b)}}function Vo(n,r){for(let o=0;o<n.length;o++)if(oa(r,n[o]))return!0;for(let o=0;o<r.length;o++)if(oa(n,r[o]))return!0;return!!Nu(n,r)}function ja(n,r,o){return!!oa(n,r)||!!Fu(r,n,o)}function bl(n,r){if(n.length===1)return ud(r,n[0]);for(let o=0;o<r.length;o++){const u=r[o];for(let f=0;f<u.length;f++)if(oa(n,u[f]))return!0}for(let o=0;o<n.length;o++)if(ud(r,n[o]))return!0;for(let o=0;o<r.length;o++)if(Nu(n,r[o]))return!0;return!1}function Lu(n,r,o){if(n.length>1){if(Nu(n,r))return!0;for(let u=0;u<r.length;u++)if(Fu(r[u],n,o))return!0}for(let u=0;u<n.length;u++)if(Fu(n[u],r,o))return!0;return!1}function Nu(n,r){if(n.length===0||r.length===0)return!1;for(let o=0;o<n.length-1;o++){const u=n[o],f=n[o+1];for(let m=0;m<r.length-1;m++)if(im(u,f,r[m],r[m+1]))return!0}return!1}function im(n,r,o,u){return cn(n,o,u)!==cn(r,o,u)&&cn(n,r,o)!==cn(n,r,u)}function Fu(n,r,o){const u=o*o;if(r.length===1)return n.distSqr(r[0])<u;for(let f=1;f<r.length;f++)if(oc(n,r[f-1],r[f])<u)return!0;return!1}function oc(n,r,o){const u=r.distSqr(o);if(u===0)return n.distSqr(r);const f=((n.x-r.x)*(o.x-r.x)+(n.y-r.y)*(o.y-r.y))/u;return n.distSqr(f<0?r:f>1?o:o.sub(r)._mult(f)._add(r))}function ud(n,r){let o,u,f,m=!1;for(let y=0;y<n.length;y++){o=n[y];for(let b=0,T=o.length-1;b<o.length;T=b++)u=o[b],f=o[T],u.y>r.y!=f.y>r.y&&r.x<(f.x-u.x)*(r.y-u.y)/(f.y-u.y)+u.x&&(m=!m)}return m}function oa(n,r){let o=!1;for(let u=0,f=n.length-1;u<n.length;f=u++){const m=n[u],y=n[f];m.y>r.y!=y.y>r.y&&r.x<(y.x-m.x)*(r.y-m.y)/(y.y-m.y)+m.x&&(o=!o)}return o}function tS(n,r,o,u,f){for(const y of n)if(r<=y.x&&o<=y.y&&u>=y.x&&f>=y.y)return!0;const m=[new xe(r,o),new xe(r,f),new xe(u,f),new xe(u,o)];if(n.length>2){for(const y of m)if(oa(n,y))return!0}for(let y=0;y<n.length-1;y++)if(hF(n[y],n[y+1],m))return!0;return!1}function hF(n,r,o){const u=o[0],f=o[2];if(n.x<u.x&&r.x<u.x||n.x>f.x&&r.x>f.x||n.y<u.y&&r.y<u.y||n.y>f.y&&r.y>f.y)return!1;const m=cn(n,r,o[0]);return m!==cn(n,r,o[1])||m!==cn(n,r,o[2])||m!==cn(n,r,o[3])}function hd(n,r,o,u,f,m){let y=r.y-n.y,b=n.x-r.x;if(m=m||0){const T=y*y+b*b;if(T===0)return!0;const E=Math.sqrt(T);y/=E,b/=E}return!((o.x-n.x)*y+(o.y-n.y)*b-m<0||(u.x-n.x)*y+(u.y-n.y)*b-m<0||(f.x-n.x)*y+(f.y-n.y)*b-m<0)}function q1(n,r,o,u,f,m,y){return!(hd(n,r,u,f,m,y)||hd(r,o,u,f,m,y)||hd(o,n,u,f,m,y)||hd(u,f,n,r,o,y)||hd(f,m,n,r,o,y)||hd(m,u,n,r,o,y))}function dd(n,r,o){const u=r.paint.get(n).value;return u.kind==="constant"?u.value:o.programConfigurations.get(r.id).getMaxValue(n)}function Ug(n){return Math.sqrt(n[0]*n[0]+n[1]*n[1])}function iS(n,r,o,u,f){if(!r[0]&&!r[1])return n;const m=xe.convert(r)._mult(f);o==="viewport"&&m._rotate(-u);const y=[];for(let b=0;b<n.length;b++)y.push(n[b].sub(m));return y}function rS(n,r,o,u){const f=xe.convert(n)._mult(u);return r==="viewport"&&f._rotate(-o),f}Ht(Gs,"CircleBucket",{omit:["layers"]});const dF=new fn({"circle-sort-key":new oi(Fe.layout_circle["circle-sort-key"]),visibility:new Pt(Fe.layout_circle.visibility)});var fF={paint:new fn({"circle-radius":new oi(Fe.paint_circle["circle-radius"]),"circle-color":new oi(Fe.paint_circle["circle-color"]),"circle-blur":new oi(Fe.paint_circle["circle-blur"]),"circle-opacity":new oi(Fe.paint_circle["circle-opacity"]),"circle-translate":new Pt(Fe.paint_circle["circle-translate"]),"circle-translate-anchor":new Pt(Fe.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Pt(Fe.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Pt(Fe.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new oi(Fe.paint_circle["circle-stroke-width"]),"circle-stroke-color":new oi(Fe.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new oi(Fe.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new Pt(Fe.paint_circle["circle-emissive-strength"])}),layout:dF},ds={},fs={};Object.defineProperty(fs,"__esModule",{value:!0}),fs.setMatrixArrayType=function(n){fs.ARRAY_TYPE=sS=n},fs.toRadian=function(n){return n*mF},fs.equals=function(n,r){return Math.abs(n-r)<=nS*Math.max(1,Math.abs(n),Math.abs(r))},fs.RANDOM=fs.ARRAY_TYPE=fs.EPSILON=void 0;var nS=1e-6;fs.EPSILON=nS;var sS=typeof Float32Array<"u"?Float32Array:Array;fs.ARRAY_TYPE=sS;var pF=Math.random;fs.RANDOM=pF;var mF=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var n=0,r=arguments.length;r--;)n+=arguments[r]*arguments[r];return Math.sqrt(n)});var mn={};function G1(n){return G1=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},G1(n)}Object.defineProperty(mn,"__esModule",{value:!0}),mn.create=function(){var n=new ac.ARRAY_TYPE(4);return ac.ARRAY_TYPE!=Float32Array&&(n[1]=0,n[2]=0),n[0]=1,n[3]=1,n},mn.clone=function(n){var r=new ac.ARRAY_TYPE(4);return r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r},mn.copy=function(n,r){return n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n},mn.identity=function(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=1,n},mn.fromValues=function(n,r,o,u){var f=new ac.ARRAY_TYPE(4);return f[0]=n,f[1]=r,f[2]=o,f[3]=u,f},mn.set=function(n,r,o,u,f){return n[0]=r,n[1]=o,n[2]=u,n[3]=f,n},mn.transpose=function(n,r){if(n===r){var o=r[1];n[1]=r[2],n[2]=o}else n[0]=r[0],n[1]=r[2],n[2]=r[1],n[3]=r[3];return n},mn.invert=function(n,r){var o=r[0],u=r[1],f=r[2],m=r[3],y=o*m-f*u;return y?(n[0]=m*(y=1/y),n[1]=-u*y,n[2]=-f*y,n[3]=o*y,n):null},mn.adjoint=function(n,r){var o=r[0];return n[0]=r[3],n[1]=-r[1],n[2]=-r[2],n[3]=o,n},mn.determinant=function(n){return n[0]*n[3]-n[2]*n[1]},mn.multiply=aS,mn.rotate=function(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3],b=Math.sin(o),T=Math.cos(o);return n[0]=u*T+m*b,n[1]=f*T+y*b,n[2]=u*-b+m*T,n[3]=f*-b+y*T,n},mn.scale=function(n,r,o){var u=r[1],f=r[2],m=r[3],y=o[0],b=o[1];return n[0]=r[0]*y,n[1]=u*y,n[2]=f*b,n[3]=m*b,n},mn.fromRotation=function(n,r){var o=Math.sin(r),u=Math.cos(r);return n[0]=u,n[1]=o,n[2]=-o,n[3]=u,n},mn.fromScaling=function(n,r){return n[0]=r[0],n[1]=0,n[2]=0,n[3]=r[1],n},mn.str=function(n){return"mat2("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+")"},mn.frob=function(n){return Math.hypot(n[0],n[1],n[2],n[3])},mn.LDU=function(n,r,o,u){return n[2]=u[2]/u[0],o[0]=u[0],o[1]=u[1],o[3]=u[3]-n[2]*o[1],[n,r,o]},mn.add=function(n,r,o){return n[0]=r[0]+o[0],n[1]=r[1]+o[1],n[2]=r[2]+o[2],n[3]=r[3]+o[3],n},mn.subtract=lS,mn.exactEquals=function(n,r){return n[0]===r[0]&&n[1]===r[1]&&n[2]===r[2]&&n[3]===r[3]},mn.equals=function(n,r){var o=n[0],u=n[1],f=n[2],m=n[3],y=r[0],b=r[1],T=r[2],E=r[3];return Math.abs(o-y)<=ac.EPSILON*Math.max(1,Math.abs(o),Math.abs(y))&&Math.abs(u-b)<=ac.EPSILON*Math.max(1,Math.abs(u),Math.abs(b))&&Math.abs(f-T)<=ac.EPSILON*Math.max(1,Math.abs(f),Math.abs(T))&&Math.abs(m-E)<=ac.EPSILON*Math.max(1,Math.abs(m),Math.abs(E))},mn.multiplyScalar=function(n,r,o){return n[0]=r[0]*o,n[1]=r[1]*o,n[2]=r[2]*o,n[3]=r[3]*o,n},mn.multiplyScalarAndAdd=function(n,r,o,u){return n[0]=r[0]+o[0]*u,n[1]=r[1]+o[1]*u,n[2]=r[2]+o[2]*u,n[3]=r[3]+o[3]*u,n},mn.sub=mn.mul=void 0;var ac=function(n,r){if(n&&n.__esModule)return n;if(n===null||G1(n)!=="object"&&typeof n!="function")return{default:n};var o=oS(void 0);if(o&&o.has(n))return o.get(n);var u={},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var m in n)if(m!=="default"&&Object.prototype.hasOwnProperty.call(n,m)){var y=f?Object.getOwnPropertyDescriptor(n,m):null;y&&(y.get||y.set)?Object.defineProperty(u,m,y):u[m]=n[m]}return u.default=n,o&&o.set(n,u),u}(fs);function oS(n){if(typeof WeakMap!="function")return null;var r=new WeakMap,o=new WeakMap;return(oS=function(u){return u?o:r})(n)}function aS(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3],b=o[0],T=o[1],E=o[2],M=o[3];return n[0]=u*b+m*T,n[1]=f*b+y*T,n[2]=u*E+m*M,n[3]=f*E+y*M,n}function lS(n,r,o){return n[0]=r[0]-o[0],n[1]=r[1]-o[1],n[2]=r[2]-o[2],n[3]=r[3]-o[3],n}mn.mul=aS,mn.sub=lS;var vn={};function X1(n){return X1=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},X1(n)}Object.defineProperty(vn,"__esModule",{value:!0}),vn.create=function(){var n=new $a.ARRAY_TYPE(6);return $a.ARRAY_TYPE!=Float32Array&&(n[1]=0,n[2]=0,n[4]=0,n[5]=0),n[0]=1,n[3]=1,n},vn.clone=function(n){var r=new $a.ARRAY_TYPE(6);return r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r},vn.copy=function(n,r){return n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n[4]=r[4],n[5]=r[5],n},vn.identity=function(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=1,n[4]=0,n[5]=0,n},vn.fromValues=function(n,r,o,u,f,m){var y=new $a.ARRAY_TYPE(6);return y[0]=n,y[1]=r,y[2]=o,y[3]=u,y[4]=f,y[5]=m,y},vn.set=function(n,r,o,u,f,m,y){return n[0]=r,n[1]=o,n[2]=u,n[3]=f,n[4]=m,n[5]=y,n},vn.invert=function(n,r){var o=r[0],u=r[1],f=r[2],m=r[3],y=r[4],b=r[5],T=o*m-u*f;return T?(n[0]=m*(T=1/T),n[1]=-u*T,n[2]=-f*T,n[3]=o*T,n[4]=(f*b-m*y)*T,n[5]=(u*y-o*b)*T,n):null},vn.determinant=function(n){return n[0]*n[3]-n[1]*n[2]},vn.multiply=uS,vn.rotate=function(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3],b=r[4],T=r[5],E=Math.sin(o),M=Math.cos(o);return n[0]=u*M+m*E,n[1]=f*M+y*E,n[2]=u*-E+m*M,n[3]=f*-E+y*M,n[4]=b,n[5]=T,n},vn.scale=function(n,r,o){var u=r[1],f=r[2],m=r[3],y=r[4],b=r[5],T=o[0],E=o[1];return n[0]=r[0]*T,n[1]=u*T,n[2]=f*E,n[3]=m*E,n[4]=y,n[5]=b,n},vn.translate=function(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3],b=r[4],T=r[5],E=o[0],M=o[1];return n[0]=u,n[1]=f,n[2]=m,n[3]=y,n[4]=u*E+m*M+b,n[5]=f*E+y*M+T,n},vn.fromRotation=function(n,r){var o=Math.sin(r),u=Math.cos(r);return n[0]=u,n[1]=o,n[2]=-o,n[3]=u,n[4]=0,n[5]=0,n},vn.fromScaling=function(n,r){return n[0]=r[0],n[1]=0,n[2]=0,n[3]=r[1],n[4]=0,n[5]=0,n},vn.fromTranslation=function(n,r){return n[0]=1,n[1]=0,n[2]=0,n[3]=1,n[4]=r[0],n[5]=r[1],n},vn.str=function(n){return"mat2d("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+", "+n[4]+", "+n[5]+")"},vn.frob=function(n){return Math.hypot(n[0],n[1],n[2],n[3],n[4],n[5],1)},vn.add=function(n,r,o){return n[0]=r[0]+o[0],n[1]=r[1]+o[1],n[2]=r[2]+o[2],n[3]=r[3]+o[3],n[4]=r[4]+o[4],n[5]=r[5]+o[5],n},vn.subtract=hS,vn.multiplyScalar=function(n,r,o){return n[0]=r[0]*o,n[1]=r[1]*o,n[2]=r[2]*o,n[3]=r[3]*o,n[4]=r[4]*o,n[5]=r[5]*o,n},vn.multiplyScalarAndAdd=function(n,r,o,u){return n[0]=r[0]+o[0]*u,n[1]=r[1]+o[1]*u,n[2]=r[2]+o[2]*u,n[3]=r[3]+o[3]*u,n[4]=r[4]+o[4]*u,n[5]=r[5]+o[5]*u,n},vn.exactEquals=function(n,r){return n[0]===r[0]&&n[1]===r[1]&&n[2]===r[2]&&n[3]===r[3]&&n[4]===r[4]&&n[5]===r[5]},vn.equals=function(n,r){var o=n[0],u=n[1],f=n[2],m=n[3],y=n[4],b=n[5],T=r[0],E=r[1],M=r[2],I=r[3],k=r[4],F=r[5];return Math.abs(o-T)<=$a.EPSILON*Math.max(1,Math.abs(o),Math.abs(T))&&Math.abs(u-E)<=$a.EPSILON*Math.max(1,Math.abs(u),Math.abs(E))&&Math.abs(f-M)<=$a.EPSILON*Math.max(1,Math.abs(f),Math.abs(M))&&Math.abs(m-I)<=$a.EPSILON*Math.max(1,Math.abs(m),Math.abs(I))&&Math.abs(y-k)<=$a.EPSILON*Math.max(1,Math.abs(y),Math.abs(k))&&Math.abs(b-F)<=$a.EPSILON*Math.max(1,Math.abs(b),Math.abs(F))},vn.sub=vn.mul=void 0;var $a=function(n,r){if(n&&n.__esModule)return n;if(n===null||X1(n)!=="object"&&typeof n!="function")return{default:n};var o=cS(void 0);if(o&&o.has(n))return o.get(n);var u={},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var m in n)if(m!=="default"&&Object.prototype.hasOwnProperty.call(n,m)){var y=f?Object.getOwnPropertyDescriptor(n,m):null;y&&(y.get||y.set)?Object.defineProperty(u,m,y):u[m]=n[m]}return u.default=n,o&&o.set(n,u),u}(fs);function cS(n){if(typeof WeakMap!="function")return null;var r=new WeakMap,o=new WeakMap;return(cS=function(u){return u?o:r})(n)}function uS(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3],b=r[4],T=r[5],E=o[0],M=o[1],I=o[2],k=o[3],F=o[4],z=o[5];return n[0]=u*E+m*M,n[1]=f*E+y*M,n[2]=u*I+m*k,n[3]=f*I+y*k,n[4]=u*F+m*z+b,n[5]=f*F+y*z+T,n}function hS(n,r,o){return n[0]=r[0]-o[0],n[1]=r[1]-o[1],n[2]=r[2]-o[2],n[3]=r[3]-o[3],n[4]=r[4]-o[4],n[5]=r[5]-o[5],n}vn.mul=uS,vn.sub=hS;var Fr={};function Z1(n){return Z1=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},Z1(n)}Object.defineProperty(Fr,"__esModule",{value:!0}),Fr.create=function(){var n=new Mo.ARRAY_TYPE(9);return Mo.ARRAY_TYPE!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n},Fr.fromMat4=function(n,r){return n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[4],n[4]=r[5],n[5]=r[6],n[6]=r[8],n[7]=r[9],n[8]=r[10],n},Fr.clone=function(n){var r=new Mo.ARRAY_TYPE(9);return r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r},Fr.copy=function(n,r){return n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n[4]=r[4],n[5]=r[5],n[6]=r[6],n[7]=r[7],n[8]=r[8],n},Fr.fromValues=function(n,r,o,u,f,m,y,b,T){var E=new Mo.ARRAY_TYPE(9);return E[0]=n,E[1]=r,E[2]=o,E[3]=u,E[4]=f,E[5]=m,E[6]=y,E[7]=b,E[8]=T,E},Fr.set=function(n,r,o,u,f,m,y,b,T,E){return n[0]=r,n[1]=o,n[2]=u,n[3]=f,n[4]=m,n[5]=y,n[6]=b,n[7]=T,n[8]=E,n},Fr.identity=function(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n},Fr.transpose=function(n,r){if(n===r){var o=r[1],u=r[2],f=r[5];n[1]=r[3],n[2]=r[6],n[3]=o,n[5]=r[7],n[6]=u,n[7]=f}else n[0]=r[0],n[1]=r[3],n[2]=r[6],n[3]=r[1],n[4]=r[4],n[5]=r[7],n[6]=r[2],n[7]=r[5],n[8]=r[8];return n},Fr.invert=function(n,r){var o=r[0],u=r[1],f=r[2],m=r[3],y=r[4],b=r[5],T=r[6],E=r[7],M=r[8],I=M*y-b*E,k=-M*m+b*T,F=E*m-y*T,z=o*I+u*k+f*F;return z?(n[0]=I*(z=1/z),n[1]=(-M*u+f*E)*z,n[2]=(b*u-f*y)*z,n[3]=k*z,n[4]=(M*o-f*T)*z,n[5]=(-b*o+f*m)*z,n[6]=F*z,n[7]=(-E*o+u*T)*z,n[8]=(y*o-u*m)*z,n):null},Fr.adjoint=function(n,r){var o=r[0],u=r[1],f=r[2],m=r[3],y=r[4],b=r[5],T=r[6],E=r[7],M=r[8];return n[0]=y*M-b*E,n[1]=f*E-u*M,n[2]=u*b-f*y,n[3]=b*T-m*M,n[4]=o*M-f*T,n[5]=f*m-o*b,n[6]=m*E-y*T,n[7]=u*T-o*E,n[8]=o*y-u*m,n},Fr.determinant=function(n){var r=n[3],o=n[4],u=n[5],f=n[6],m=n[7],y=n[8];return n[0]*(y*o-u*m)+n[1]*(-y*r+u*f)+n[2]*(m*r-o*f)},Fr.multiply=fS,Fr.translate=function(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3],b=r[4],T=r[5],E=r[6],M=r[7],I=r[8],k=o[0],F=o[1];return n[0]=u,n[1]=f,n[2]=m,n[3]=y,n[4]=b,n[5]=T,n[6]=k*u+F*y+E,n[7]=k*f+F*b+M,n[8]=k*m+F*T+I,n},Fr.rotate=function(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3],b=r[4],T=r[5],E=r[6],M=r[7],I=r[8],k=Math.sin(o),F=Math.cos(o);return n[0]=F*u+k*y,n[1]=F*f+k*b,n[2]=F*m+k*T,n[3]=F*y-k*u,n[4]=F*b-k*f,n[5]=F*T-k*m,n[6]=E,n[7]=M,n[8]=I,n},Fr.scale=function(n,r,o){var u=o[0],f=o[1];return n[0]=u*r[0],n[1]=u*r[1],n[2]=u*r[2],n[3]=f*r[3],n[4]=f*r[4],n[5]=f*r[5],n[6]=r[6],n[7]=r[7],n[8]=r[8],n},Fr.fromTranslation=function(n,r){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=r[0],n[7]=r[1],n[8]=1,n},Fr.fromRotation=function(n,r){var o=Math.sin(r),u=Math.cos(r);return n[0]=u,n[1]=o,n[2]=0,n[3]=-o,n[4]=u,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n},Fr.fromScaling=function(n,r){return n[0]=r[0],n[1]=0,n[2]=0,n[3]=0,n[4]=r[1],n[5]=0,n[6]=0,n[7]=0,n[8]=1,n},Fr.fromMat2d=function(n,r){return n[0]=r[0],n[1]=r[1],n[2]=0,n[3]=r[2],n[4]=r[3],n[5]=0,n[6]=r[4],n[7]=r[5],n[8]=1,n},Fr.fromQuat=function(n,r){var o=r[0],u=r[1],f=r[2],m=r[3],y=o+o,b=u+u,T=f+f,E=o*y,M=u*y,I=u*b,k=f*y,F=f*b,z=f*T,V=m*y,W=m*b,G=m*T;return n[0]=1-I-z,n[3]=M-G,n[6]=k+W,n[1]=M+G,n[4]=1-E-z,n[7]=F-V,n[2]=k-W,n[5]=F+V,n[8]=1-E-I,n},Fr.normalFromMat4=function(n,r){var o=r[0],u=r[1],f=r[2],m=r[3],y=r[4],b=r[5],T=r[6],E=r[7],M=r[8],I=r[9],k=r[10],F=r[11],z=r[12],V=r[13],W=r[14],G=r[15],te=o*b-u*y,se=o*T-f*y,ne=o*E-m*y,ye=u*T-f*b,de=u*E-m*b,Ee=f*E-m*T,Pe=M*V-I*z,De=M*W-k*z,Ve=M*G-F*z,Le=I*W-k*V,rt=I*G-F*V,ht=k*G-F*W,Ze=te*ht-se*rt+ne*Le+ye*Ve-de*De+Ee*Pe;return Ze?(n[0]=(b*ht-T*rt+E*Le)*(Ze=1/Ze),n[1]=(T*Ve-y*ht-E*De)*Ze,n[2]=(y*rt-b*Ve+E*Pe)*Ze,n[3]=(f*rt-u*ht-m*Le)*Ze,n[4]=(o*ht-f*Ve+m*De)*Ze,n[5]=(u*Ve-o*rt-m*Pe)*Ze,n[6]=(V*Ee-W*de+G*ye)*Ze,n[7]=(W*ne-z*Ee-G*se)*Ze,n[8]=(z*de-V*ne+G*te)*Ze,n):null},Fr.projection=function(n,r,o){return n[0]=2/r,n[1]=0,n[2]=0,n[3]=0,n[4]=-2/o,n[5]=0,n[6]=-1,n[7]=1,n[8]=1,n},Fr.str=function(n){return"mat3("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+", "+n[4]+", "+n[5]+", "+n[6]+", "+n[7]+", "+n[8]+")"},Fr.frob=function(n){return Math.hypot(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8])},Fr.add=function(n,r,o){return n[0]=r[0]+o[0],n[1]=r[1]+o[1],n[2]=r[2]+o[2],n[3]=r[3]+o[3],n[4]=r[4]+o[4],n[5]=r[5]+o[5],n[6]=r[6]+o[6],n[7]=r[7]+o[7],n[8]=r[8]+o[8],n},Fr.subtract=pS,Fr.multiplyScalar=function(n,r,o){return n[0]=r[0]*o,n[1]=r[1]*o,n[2]=r[2]*o,n[3]=r[3]*o,n[4]=r[4]*o,n[5]=r[5]*o,n[6]=r[6]*o,n[7]=r[7]*o,n[8]=r[8]*o,n},Fr.multiplyScalarAndAdd=function(n,r,o,u){return n[0]=r[0]+o[0]*u,n[1]=r[1]+o[1]*u,n[2]=r[2]+o[2]*u,n[3]=r[3]+o[3]*u,n[4]=r[4]+o[4]*u,n[5]=r[5]+o[5]*u,n[6]=r[6]+o[6]*u,n[7]=r[7]+o[7]*u,n[8]=r[8]+o[8]*u,n},Fr.exactEquals=function(n,r){return n[0]===r[0]&&n[1]===r[1]&&n[2]===r[2]&&n[3]===r[3]&&n[4]===r[4]&&n[5]===r[5]&&n[6]===r[6]&&n[7]===r[7]&&n[8]===r[8]},Fr.equals=function(n,r){var o=n[0],u=n[1],f=n[2],m=n[3],y=n[4],b=n[5],T=n[6],E=n[7],M=n[8],I=r[0],k=r[1],F=r[2],z=r[3],V=r[4],W=r[5],G=r[6],te=r[7],se=r[8];return Math.abs(o-I)<=Mo.EPSILON*Math.max(1,Math.abs(o),Math.abs(I))&&Math.abs(u-k)<=Mo.EPSILON*Math.max(1,Math.abs(u),Math.abs(k))&&Math.abs(f-F)<=Mo.EPSILON*Math.max(1,Math.abs(f),Math.abs(F))&&Math.abs(m-z)<=Mo.EPSILON*Math.max(1,Math.abs(m),Math.abs(z))&&Math.abs(y-V)<=Mo.EPSILON*Math.max(1,Math.abs(y),Math.abs(V))&&Math.abs(b-W)<=Mo.EPSILON*Math.max(1,Math.abs(b),Math.abs(W))&&Math.abs(T-G)<=Mo.EPSILON*Math.max(1,Math.abs(T),Math.abs(G))&&Math.abs(E-te)<=Mo.EPSILON*Math.max(1,Math.abs(E),Math.abs(te))&&Math.abs(M-se)<=Mo.EPSILON*Math.max(1,Math.abs(M),Math.abs(se))},Fr.sub=Fr.mul=void 0;var Mo=function(n,r){if(n&&n.__esModule)return n;if(n===null||Z1(n)!=="object"&&typeof n!="function")return{default:n};var o=dS(void 0);if(o&&o.has(n))return o.get(n);var u={},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var m in n)if(m!=="default"&&Object.prototype.hasOwnProperty.call(n,m)){var y=f?Object.getOwnPropertyDescriptor(n,m):null;y&&(y.get||y.set)?Object.defineProperty(u,m,y):u[m]=n[m]}return u.default=n,o&&o.set(n,u),u}(fs);function dS(n){if(typeof WeakMap!="function")return null;var r=new WeakMap,o=new WeakMap;return(dS=function(u){return u?o:r})(n)}function fS(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3],b=r[4],T=r[5],E=r[6],M=r[7],I=r[8],k=o[0],F=o[1],z=o[2],V=o[3],W=o[4],G=o[5],te=o[6],se=o[7],ne=o[8];return n[0]=k*u+F*y+z*E,n[1]=k*f+F*b+z*M,n[2]=k*m+F*T+z*I,n[3]=V*u+W*y+G*E,n[4]=V*f+W*b+G*M,n[5]=V*m+W*T+G*I,n[6]=te*u+se*y+ne*E,n[7]=te*f+se*b+ne*M,n[8]=te*m+se*T+ne*I,n}function pS(n,r,o){return n[0]=r[0]-o[0],n[1]=r[1]-o[1],n[2]=r[2]-o[2],n[3]=r[3]-o[3],n[4]=r[4]-o[4],n[5]=r[5]-o[5],n[6]=r[6]-o[6],n[7]=r[7]-o[7],n[8]=r[8]-o[8],n}Fr.mul=fS,Fr.sub=pS;var ki={};function Y1(n){return Y1=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},Y1(n)}Object.defineProperty(ki,"__esModule",{value:!0}),ki.create=function(){var n=new On.ARRAY_TYPE(16);return On.ARRAY_TYPE!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n},ki.clone=function(n){var r=new On.ARRAY_TYPE(16);return r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15],r},ki.copy=function(n,r){return n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n[4]=r[4],n[5]=r[5],n[6]=r[6],n[7]=r[7],n[8]=r[8],n[9]=r[9],n[10]=r[10],n[11]=r[11],n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15],n},ki.fromValues=function(n,r,o,u,f,m,y,b,T,E,M,I,k,F,z,V){var W=new On.ARRAY_TYPE(16);return W[0]=n,W[1]=r,W[2]=o,W[3]=u,W[4]=f,W[5]=m,W[6]=y,W[7]=b,W[8]=T,W[9]=E,W[10]=M,W[11]=I,W[12]=k,W[13]=F,W[14]=z,W[15]=V,W},ki.set=function(n,r,o,u,f,m,y,b,T,E,M,I,k,F,z,V,W){return n[0]=r,n[1]=o,n[2]=u,n[3]=f,n[4]=m,n[5]=y,n[6]=b,n[7]=T,n[8]=E,n[9]=M,n[10]=I,n[11]=k,n[12]=F,n[13]=z,n[14]=V,n[15]=W,n},ki.identity=_S,ki.transpose=function(n,r){if(n===r){var o=r[1],u=r[2],f=r[3],m=r[6],y=r[7],b=r[11];n[1]=r[4],n[2]=r[8],n[3]=r[12],n[4]=o,n[6]=r[9],n[7]=r[13],n[8]=u,n[9]=m,n[11]=r[14],n[12]=f,n[13]=y,n[14]=b}else n[0]=r[0],n[1]=r[4],n[2]=r[8],n[3]=r[12],n[4]=r[1],n[5]=r[5],n[6]=r[9],n[7]=r[13],n[8]=r[2],n[9]=r[6],n[10]=r[10],n[11]=r[14],n[12]=r[3],n[13]=r[7],n[14]=r[11],n[15]=r[15];return n},ki.invert=function(n,r){var o=r[0],u=r[1],f=r[2],m=r[3],y=r[4],b=r[5],T=r[6],E=r[7],M=r[8],I=r[9],k=r[10],F=r[11],z=r[12],V=r[13],W=r[14],G=r[15],te=o*b-u*y,se=o*T-f*y,ne=o*E-m*y,ye=u*T-f*b,de=u*E-m*b,Ee=f*E-m*T,Pe=M*V-I*z,De=M*W-k*z,Ve=M*G-F*z,Le=I*W-k*V,rt=I*G-F*V,ht=k*G-F*W,Ze=te*ht-se*rt+ne*Le+ye*Ve-de*De+Ee*Pe;return Ze?(n[0]=(b*ht-T*rt+E*Le)*(Ze=1/Ze),n[1]=(f*rt-u*ht-m*Le)*Ze,n[2]=(V*Ee-W*de+G*ye)*Ze,n[3]=(k*de-I*Ee-F*ye)*Ze,n[4]=(T*Ve-y*ht-E*De)*Ze,n[5]=(o*ht-f*Ve+m*De)*Ze,n[6]=(W*ne-z*Ee-G*se)*Ze,n[7]=(M*Ee-k*ne+F*se)*Ze,n[8]=(y*rt-b*Ve+E*Pe)*Ze,n[9]=(u*Ve-o*rt-m*Pe)*Ze,n[10]=(z*de-V*ne+G*te)*Ze,n[11]=(I*ne-M*de-F*te)*Ze,n[12]=(b*De-y*Le-T*Pe)*Ze,n[13]=(o*Le-u*De+f*Pe)*Ze,n[14]=(V*se-z*ye-W*te)*Ze,n[15]=(M*ye-I*se+k*te)*Ze,n):null},ki.adjoint=function(n,r){var o=r[0],u=r[1],f=r[2],m=r[3],y=r[4],b=r[5],T=r[6],E=r[7],M=r[8],I=r[9],k=r[10],F=r[11],z=r[12],V=r[13],W=r[14],G=r[15];return n[0]=b*(k*G-F*W)-I*(T*G-E*W)+V*(T*F-E*k),n[1]=-(u*(k*G-F*W)-I*(f*G-m*W)+V*(f*F-m*k)),n[2]=u*(T*G-E*W)-b*(f*G-m*W)+V*(f*E-m*T),n[3]=-(u*(T*F-E*k)-b*(f*F-m*k)+I*(f*E-m*T)),n[4]=-(y*(k*G-F*W)-M*(T*G-E*W)+z*(T*F-E*k)),n[5]=o*(k*G-F*W)-M*(f*G-m*W)+z*(f*F-m*k),n[6]=-(o*(T*G-E*W)-y*(f*G-m*W)+z*(f*E-m*T)),n[7]=o*(T*F-E*k)-y*(f*F-m*k)+M*(f*E-m*T),n[8]=y*(I*G-F*V)-M*(b*G-E*V)+z*(b*F-E*I),n[9]=-(o*(I*G-F*V)-M*(u*G-m*V)+z*(u*F-m*I)),n[10]=o*(b*G-E*V)-y*(u*G-m*V)+z*(u*E-m*b),n[11]=-(o*(b*F-E*I)-y*(u*F-m*I)+M*(u*E-m*b)),n[12]=-(y*(I*W-k*V)-M*(b*W-T*V)+z*(b*k-T*I)),n[13]=o*(I*W-k*V)-M*(u*W-f*V)+z*(u*k-f*I),n[14]=-(o*(b*W-T*V)-y*(u*W-f*V)+z*(u*T-f*b)),n[15]=o*(b*k-T*I)-y*(u*k-f*I)+M*(u*T-f*b),n},ki.determinant=function(n){var r=n[0],o=n[1],u=n[2],f=n[3],m=n[4],y=n[5],b=n[6],T=n[7],E=n[8],M=n[9],I=n[10],k=n[11],F=n[12],z=n[13],V=n[14],W=n[15];return(r*y-o*m)*(I*W-k*V)-(r*b-u*m)*(M*W-k*z)+(r*T-f*m)*(M*V-I*z)+(o*b-u*y)*(E*W-k*F)-(o*T-f*y)*(E*V-I*F)+(u*T-f*b)*(E*z-M*F)},ki.multiply=gS,ki.translate=function(n,r,o){var u,f,m,y,b,T,E,M,I,k,F,z,V=o[0],W=o[1],G=o[2];return r===n?(n[12]=r[0]*V+r[4]*W+r[8]*G+r[12],n[13]=r[1]*V+r[5]*W+r[9]*G+r[13],n[14]=r[2]*V+r[6]*W+r[10]*G+r[14],n[15]=r[3]*V+r[7]*W+r[11]*G+r[15]):(f=r[1],m=r[2],y=r[3],b=r[4],T=r[5],E=r[6],M=r[7],I=r[8],k=r[9],F=r[10],z=r[11],n[0]=u=r[0],n[1]=f,n[2]=m,n[3]=y,n[4]=b,n[5]=T,n[6]=E,n[7]=M,n[8]=I,n[9]=k,n[10]=F,n[11]=z,n[12]=u*V+b*W+I*G+r[12],n[13]=f*V+T*W+k*G+r[13],n[14]=m*V+E*W+F*G+r[14],n[15]=y*V+M*W+z*G+r[15]),n},ki.scale=function(n,r,o){var u=o[0],f=o[1],m=o[2];return n[0]=r[0]*u,n[1]=r[1]*u,n[2]=r[2]*u,n[3]=r[3]*u,n[4]=r[4]*f,n[5]=r[5]*f,n[6]=r[6]*f,n[7]=r[7]*f,n[8]=r[8]*m,n[9]=r[9]*m,n[10]=r[10]*m,n[11]=r[11]*m,n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15],n},ki.rotate=function(n,r,o,u){var f,m,y,b,T,E,M,I,k,F,z,V,W,G,te,se,ne,ye,de,Ee,Pe,De,Ve,Le,rt=u[0],ht=u[1],Ze=u[2],ct=Math.hypot(rt,ht,Ze);return ct<On.EPSILON?null:(rt*=ct=1/ct,ht*=ct,Ze*=ct,f=Math.sin(o),m=Math.cos(o),T=r[1],E=r[2],M=r[3],k=r[5],F=r[6],z=r[7],W=r[9],G=r[10],te=r[11],se=rt*rt*(y=1-m)+m,de=rt*ht*y-Ze*f,Ee=ht*ht*y+m,Pe=Ze*ht*y+rt*f,De=rt*Ze*y+ht*f,Ve=ht*Ze*y-rt*f,Le=Ze*Ze*y+m,n[0]=(b=r[0])*se+(I=r[4])*(ne=ht*rt*y+Ze*f)+(V=r[8])*(ye=Ze*rt*y-ht*f),n[1]=T*se+k*ne+W*ye,n[2]=E*se+F*ne+G*ye,n[3]=M*se+z*ne+te*ye,n[4]=b*de+I*Ee+V*Pe,n[5]=T*de+k*Ee+W*Pe,n[6]=E*de+F*Ee+G*Pe,n[7]=M*de+z*Ee+te*Pe,n[8]=b*De+I*Ve+V*Le,n[9]=T*De+k*Ve+W*Le,n[10]=E*De+F*Ve+G*Le,n[11]=M*De+z*Ve+te*Le,r!==n&&(n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15]),n)},ki.rotateX=function(n,r,o){var u=Math.sin(o),f=Math.cos(o),m=r[4],y=r[5],b=r[6],T=r[7],E=r[8],M=r[9],I=r[10],k=r[11];return r!==n&&(n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15]),n[4]=m*f+E*u,n[5]=y*f+M*u,n[6]=b*f+I*u,n[7]=T*f+k*u,n[8]=E*f-m*u,n[9]=M*f-y*u,n[10]=I*f-b*u,n[11]=k*f-T*u,n},ki.rotateY=function(n,r,o){var u=Math.sin(o),f=Math.cos(o),m=r[0],y=r[1],b=r[2],T=r[3],E=r[8],M=r[9],I=r[10],k=r[11];return r!==n&&(n[4]=r[4],n[5]=r[5],n[6]=r[6],n[7]=r[7],n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15]),n[0]=m*f-E*u,n[1]=y*f-M*u,n[2]=b*f-I*u,n[3]=T*f-k*u,n[8]=m*u+E*f,n[9]=y*u+M*f,n[10]=b*u+I*f,n[11]=T*u+k*f,n},ki.rotateZ=function(n,r,o){var u=Math.sin(o),f=Math.cos(o),m=r[0],y=r[1],b=r[2],T=r[3],E=r[4],M=r[5],I=r[6],k=r[7];return r!==n&&(n[8]=r[8],n[9]=r[9],n[10]=r[10],n[11]=r[11],n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15]),n[0]=m*f+E*u,n[1]=y*f+M*u,n[2]=b*f+I*u,n[3]=T*f+k*u,n[4]=E*f-m*u,n[5]=M*f-y*u,n[6]=I*f-b*u,n[7]=k*f-T*u,n},ki.fromTranslation=function(n,r){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=r[0],n[13]=r[1],n[14]=r[2],n[15]=1,n},ki.fromScaling=function(n,r){return n[0]=r[0],n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=r[1],n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=r[2],n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n},ki.fromRotation=function(n,r,o){var u,f,m,y=o[0],b=o[1],T=o[2],E=Math.hypot(y,b,T);return E<On.EPSILON?null:(y*=E=1/E,b*=E,T*=E,u=Math.sin(r),f=Math.cos(r),n[0]=y*y*(m=1-f)+f,n[1]=b*y*m+T*u,n[2]=T*y*m-b*u,n[3]=0,n[4]=y*b*m-T*u,n[5]=b*b*m+f,n[6]=T*b*m+y*u,n[7]=0,n[8]=y*T*m+b*u,n[9]=b*T*m-y*u,n[10]=T*T*m+f,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n)},ki.fromXRotation=function(n,r){var o=Math.sin(r),u=Math.cos(r);return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=u,n[6]=o,n[7]=0,n[8]=0,n[9]=-o,n[10]=u,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n},ki.fromYRotation=function(n,r){var o=Math.sin(r),u=Math.cos(r);return n[0]=u,n[1]=0,n[2]=-o,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=o,n[9]=0,n[10]=u,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n},ki.fromZRotation=function(n,r){var o=Math.sin(r),u=Math.cos(r);return n[0]=u,n[1]=o,n[2]=0,n[3]=0,n[4]=-o,n[5]=u,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n},ki.fromRotationTranslation=yS,ki.fromQuat2=function(n,r){var o=new On.ARRAY_TYPE(3),u=-r[0],f=-r[1],m=-r[2],y=r[3],b=r[4],T=r[5],E=r[6],M=r[7],I=u*u+f*f+m*m+y*y;return I>0?(o[0]=2*(b*y+M*u+T*m-E*f)/I,o[1]=2*(T*y+M*f+E*u-b*m)/I,o[2]=2*(E*y+M*m+b*f-T*u)/I):(o[0]=2*(b*y+M*u+T*m-E*f),o[1]=2*(T*y+M*f+E*u-b*m),o[2]=2*(E*y+M*m+b*f-T*u)),yS(n,r,o),n},ki.getTranslation=function(n,r){return n[0]=r[12],n[1]=r[13],n[2]=r[14],n},ki.getScaling=vS,ki.getRotation=function(n,r){var o=new On.ARRAY_TYPE(3);vS(o,r);var u=1/o[0],f=1/o[1],m=1/o[2],y=r[0]*u,b=r[1]*f,T=r[2]*m,E=r[4]*u,M=r[5]*f,I=r[6]*m,k=r[8]*u,F=r[9]*f,z=r[10]*m,V=y+M+z,W=0;return V>0?(W=2*Math.sqrt(V+1),n[3]=.25*W,n[0]=(I-F)/W,n[1]=(k-T)/W,n[2]=(b-E)/W):y>M&&y>z?(W=2*Math.sqrt(1+y-M-z),n[3]=(I-F)/W,n[0]=.25*W,n[1]=(b+E)/W,n[2]=(k+T)/W):M>z?(W=2*Math.sqrt(1+M-y-z),n[3]=(k-T)/W,n[0]=(b+E)/W,n[1]=.25*W,n[2]=(I+F)/W):(W=2*Math.sqrt(1+z-y-M),n[3]=(b-E)/W,n[0]=(k+T)/W,n[1]=(I+F)/W,n[2]=.25*W),n},ki.fromRotationTranslationScale=function(n,r,o,u){var f=r[0],m=r[1],y=r[2],b=r[3],T=f+f,E=m+m,M=y+y,I=f*T,k=f*E,F=f*M,z=m*E,V=m*M,W=y*M,G=b*T,te=b*E,se=b*M,ne=u[0],ye=u[1],de=u[2];return n[0]=(1-(z+W))*ne,n[1]=(k+se)*ne,n[2]=(F-te)*ne,n[3]=0,n[4]=(k-se)*ye,n[5]=(1-(I+W))*ye,n[6]=(V+G)*ye,n[7]=0,n[8]=(F+te)*de,n[9]=(V-G)*de,n[10]=(1-(I+z))*de,n[11]=0,n[12]=o[0],n[13]=o[1],n[14]=o[2],n[15]=1,n},ki.fromRotationTranslationScaleOrigin=function(n,r,o,u,f){var m=r[0],y=r[1],b=r[2],T=r[3],E=m+m,M=y+y,I=b+b,k=m*E,F=m*M,z=m*I,V=y*M,W=y*I,G=b*I,te=T*E,se=T*M,ne=T*I,ye=u[0],de=u[1],Ee=u[2],Pe=f[0],De=f[1],Ve=f[2],Le=(1-(V+G))*ye,rt=(F+ne)*ye,ht=(z-se)*ye,Ze=(F-ne)*de,ct=(1-(k+G))*de,qe=(W+te)*de,at=(z+se)*Ee,Ot=(W-te)*Ee,dt=(1-(k+V))*Ee;return n[0]=Le,n[1]=rt,n[2]=ht,n[3]=0,n[4]=Ze,n[5]=ct,n[6]=qe,n[7]=0,n[8]=at,n[9]=Ot,n[10]=dt,n[11]=0,n[12]=o[0]+Pe-(Le*Pe+Ze*De+at*Ve),n[13]=o[1]+De-(rt*Pe+ct*De+Ot*Ve),n[14]=o[2]+Ve-(ht*Pe+qe*De+dt*Ve),n[15]=1,n},ki.fromQuat=function(n,r){var o=r[0],u=r[1],f=r[2],m=r[3],y=o+o,b=u+u,T=f+f,E=o*y,M=u*y,I=u*b,k=f*y,F=f*b,z=f*T,V=m*y,W=m*b,G=m*T;return n[0]=1-I-z,n[1]=M+G,n[2]=k-W,n[3]=0,n[4]=M-G,n[5]=1-E-z,n[6]=F+V,n[7]=0,n[8]=k+W,n[9]=F-V,n[10]=1-E-I,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n},ki.frustum=function(n,r,o,u,f,m,y){var b=1/(o-r),T=1/(f-u),E=1/(m-y);return n[0]=2*m*b,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2*m*T,n[6]=0,n[7]=0,n[8]=(o+r)*b,n[9]=(f+u)*T,n[10]=(y+m)*E,n[11]=-1,n[12]=0,n[13]=0,n[14]=y*m*2*E,n[15]=0,n},ki.perspectiveNO=xS,ki.perspectiveZO=function(n,r,o,u,f){var m,y=1/Math.tan(r/2);return n[0]=y/o,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=y,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,f!=null&&f!==1/0?(n[10]=f*(m=1/(u-f)),n[14]=f*u*m):(n[10]=-1,n[14]=-u),n},ki.perspectiveFromFieldOfView=function(n,r,o,u){var f=Math.tan(r.upDegrees*Math.PI/180),m=Math.tan(r.downDegrees*Math.PI/180),y=Math.tan(r.leftDegrees*Math.PI/180),b=Math.tan(r.rightDegrees*Math.PI/180),T=2/(y+b),E=2/(f+m);return n[0]=T,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=E,n[6]=0,n[7]=0,n[8]=-(y-b)*T*.5,n[9]=(f-m)*E*.5,n[10]=u/(o-u),n[11]=-1,n[12]=0,n[13]=0,n[14]=u*o/(o-u),n[15]=0,n},ki.orthoNO=bS,ki.orthoZO=function(n,r,o,u,f,m,y){var b=1/(r-o),T=1/(u-f),E=1/(m-y);return n[0]=-2*b,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*T,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=E,n[11]=0,n[12]=(r+o)*b,n[13]=(f+u)*T,n[14]=m*E,n[15]=1,n},ki.lookAt=function(n,r,o,u){var f,m,y,b,T,E,M,I,k,F,z=r[0],V=r[1],W=r[2],G=u[0],te=u[1],se=u[2],ne=o[0],ye=o[1],de=o[2];return Math.abs(z-ne)<On.EPSILON&&Math.abs(V-ye)<On.EPSILON&&Math.abs(W-de)<On.EPSILON?_S(n):(M=z-ne,I=V-ye,k=W-de,f=te*(k*=F=1/Math.hypot(M,I,k))-se*(I*=F),m=se*(M*=F)-G*k,y=G*I-te*M,(F=Math.hypot(f,m,y))?(f*=F=1/F,m*=F,y*=F):(f=0,m=0,y=0),b=I*y-k*m,T=k*f-M*y,E=M*m-I*f,(F=Math.hypot(b,T,E))?(b*=F=1/F,T*=F,E*=F):(b=0,T=0,E=0),n[0]=f,n[1]=b,n[2]=M,n[3]=0,n[4]=m,n[5]=T,n[6]=I,n[7]=0,n[8]=y,n[9]=E,n[10]=k,n[11]=0,n[12]=-(f*z+m*V+y*W),n[13]=-(b*z+T*V+E*W),n[14]=-(M*z+I*V+k*W),n[15]=1,n)},ki.targetTo=function(n,r,o,u){var f=r[0],m=r[1],y=r[2],b=u[0],T=u[1],E=u[2],M=f-o[0],I=m-o[1],k=y-o[2],F=M*M+I*I+k*k;F>0&&(M*=F=1/Math.sqrt(F),I*=F,k*=F);var z=T*k-E*I,V=E*M-b*k,W=b*I-T*M;return(F=z*z+V*V+W*W)>0&&(z*=F=1/Math.sqrt(F),V*=F,W*=F),n[0]=z,n[1]=V,n[2]=W,n[3]=0,n[4]=I*W-k*V,n[5]=k*z-M*W,n[6]=M*V-I*z,n[7]=0,n[8]=M,n[9]=I,n[10]=k,n[11]=0,n[12]=f,n[13]=m,n[14]=y,n[15]=1,n},ki.str=function(n){return"mat4("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+", "+n[4]+", "+n[5]+", "+n[6]+", "+n[7]+", "+n[8]+", "+n[9]+", "+n[10]+", "+n[11]+", "+n[12]+", "+n[13]+", "+n[14]+", "+n[15]+")"},ki.frob=function(n){return Math.hypot(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15])},ki.add=function(n,r,o){return n[0]=r[0]+o[0],n[1]=r[1]+o[1],n[2]=r[2]+o[2],n[3]=r[3]+o[3],n[4]=r[4]+o[4],n[5]=r[5]+o[5],n[6]=r[6]+o[6],n[7]=r[7]+o[7],n[8]=r[8]+o[8],n[9]=r[9]+o[9],n[10]=r[10]+o[10],n[11]=r[11]+o[11],n[12]=r[12]+o[12],n[13]=r[13]+o[13],n[14]=r[14]+o[14],n[15]=r[15]+o[15],n},ki.subtract=wS,ki.multiplyScalar=function(n,r,o){return n[0]=r[0]*o,n[1]=r[1]*o,n[2]=r[2]*o,n[3]=r[3]*o,n[4]=r[4]*o,n[5]=r[5]*o,n[6]=r[6]*o,n[7]=r[7]*o,n[8]=r[8]*o,n[9]=r[9]*o,n[10]=r[10]*o,n[11]=r[11]*o,n[12]=r[12]*o,n[13]=r[13]*o,n[14]=r[14]*o,n[15]=r[15]*o,n},ki.multiplyScalarAndAdd=function(n,r,o,u){return n[0]=r[0]+o[0]*u,n[1]=r[1]+o[1]*u,n[2]=r[2]+o[2]*u,n[3]=r[3]+o[3]*u,n[4]=r[4]+o[4]*u,n[5]=r[5]+o[5]*u,n[6]=r[6]+o[6]*u,n[7]=r[7]+o[7]*u,n[8]=r[8]+o[8]*u,n[9]=r[9]+o[9]*u,n[10]=r[10]+o[10]*u,n[11]=r[11]+o[11]*u,n[12]=r[12]+o[12]*u,n[13]=r[13]+o[13]*u,n[14]=r[14]+o[14]*u,n[15]=r[15]+o[15]*u,n},ki.exactEquals=function(n,r){return n[0]===r[0]&&n[1]===r[1]&&n[2]===r[2]&&n[3]===r[3]&&n[4]===r[4]&&n[5]===r[5]&&n[6]===r[6]&&n[7]===r[7]&&n[8]===r[8]&&n[9]===r[9]&&n[10]===r[10]&&n[11]===r[11]&&n[12]===r[12]&&n[13]===r[13]&&n[14]===r[14]&&n[15]===r[15]},ki.equals=function(n,r){var o=n[0],u=n[1],f=n[2],m=n[3],y=n[4],b=n[5],T=n[6],E=n[7],M=n[8],I=n[9],k=n[10],F=n[11],z=n[12],V=n[13],W=n[14],G=n[15],te=r[0],se=r[1],ne=r[2],ye=r[3],de=r[4],Ee=r[5],Pe=r[6],De=r[7],Ve=r[8],Le=r[9],rt=r[10],ht=r[11],Ze=r[12],ct=r[13],qe=r[14],at=r[15];return Math.abs(o-te)<=On.EPSILON*Math.max(1,Math.abs(o),Math.abs(te))&&Math.abs(u-se)<=On.EPSILON*Math.max(1,Math.abs(u),Math.abs(se))&&Math.abs(f-ne)<=On.EPSILON*Math.max(1,Math.abs(f),Math.abs(ne))&&Math.abs(m-ye)<=On.EPSILON*Math.max(1,Math.abs(m),Math.abs(ye))&&Math.abs(y-de)<=On.EPSILON*Math.max(1,Math.abs(y),Math.abs(de))&&Math.abs(b-Ee)<=On.EPSILON*Math.max(1,Math.abs(b),Math.abs(Ee))&&Math.abs(T-Pe)<=On.EPSILON*Math.max(1,Math.abs(T),Math.abs(Pe))&&Math.abs(E-De)<=On.EPSILON*Math.max(1,Math.abs(E),Math.abs(De))&&Math.abs(M-Ve)<=On.EPSILON*Math.max(1,Math.abs(M),Math.abs(Ve))&&Math.abs(I-Le)<=On.EPSILON*Math.max(1,Math.abs(I),Math.abs(Le))&&Math.abs(k-rt)<=On.EPSILON*Math.max(1,Math.abs(k),Math.abs(rt))&&Math.abs(F-ht)<=On.EPSILON*Math.max(1,Math.abs(F),Math.abs(ht))&&Math.abs(z-Ze)<=On.EPSILON*Math.max(1,Math.abs(z),Math.abs(Ze))&&Math.abs(V-ct)<=On.EPSILON*Math.max(1,Math.abs(V),Math.abs(ct))&&Math.abs(W-qe)<=On.EPSILON*Math.max(1,Math.abs(W),Math.abs(qe))&&Math.abs(G-at)<=On.EPSILON*Math.max(1,Math.abs(G),Math.abs(at))},ki.sub=ki.mul=ki.ortho=ki.perspective=void 0;var On=function(n,r){if(n&&n.__esModule)return n;if(n===null||Y1(n)!=="object"&&typeof n!="function")return{default:n};var o=mS(void 0);if(o&&o.has(n))return o.get(n);var u={},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var m in n)if(m!=="default"&&Object.prototype.hasOwnProperty.call(n,m)){var y=f?Object.getOwnPropertyDescriptor(n,m):null;y&&(y.get||y.set)?Object.defineProperty(u,m,y):u[m]=n[m]}return u.default=n,o&&o.set(n,u),u}(fs);function mS(n){if(typeof WeakMap!="function")return null;var r=new WeakMap,o=new WeakMap;return(mS=function(u){return u?o:r})(n)}function _S(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function gS(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3],b=r[4],T=r[5],E=r[6],M=r[7],I=r[8],k=r[9],F=r[10],z=r[11],V=r[12],W=r[13],G=r[14],te=r[15],se=o[0],ne=o[1],ye=o[2],de=o[3];return n[0]=se*u+ne*b+ye*I+de*V,n[1]=se*f+ne*T+ye*k+de*W,n[2]=se*m+ne*E+ye*F+de*G,n[3]=se*y+ne*M+ye*z+de*te,n[4]=(se=o[4])*u+(ne=o[5])*b+(ye=o[6])*I+(de=o[7])*V,n[5]=se*f+ne*T+ye*k+de*W,n[6]=se*m+ne*E+ye*F+de*G,n[7]=se*y+ne*M+ye*z+de*te,n[8]=(se=o[8])*u+(ne=o[9])*b+(ye=o[10])*I+(de=o[11])*V,n[9]=se*f+ne*T+ye*k+de*W,n[10]=se*m+ne*E+ye*F+de*G,n[11]=se*y+ne*M+ye*z+de*te,n[12]=(se=o[12])*u+(ne=o[13])*b+(ye=o[14])*I+(de=o[15])*V,n[13]=se*f+ne*T+ye*k+de*W,n[14]=se*m+ne*E+ye*F+de*G,n[15]=se*y+ne*M+ye*z+de*te,n}function yS(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3],b=u+u,T=f+f,E=m+m,M=u*b,I=u*T,k=u*E,F=f*T,z=f*E,V=m*E,W=y*b,G=y*T,te=y*E;return n[0]=1-(F+V),n[1]=I+te,n[2]=k-G,n[3]=0,n[4]=I-te,n[5]=1-(M+V),n[6]=z+W,n[7]=0,n[8]=k+G,n[9]=z-W,n[10]=1-(M+F),n[11]=0,n[12]=o[0],n[13]=o[1],n[14]=o[2],n[15]=1,n}function vS(n,r){var o=r[4],u=r[5],f=r[6],m=r[8],y=r[9],b=r[10];return n[0]=Math.hypot(r[0],r[1],r[2]),n[1]=Math.hypot(o,u,f),n[2]=Math.hypot(m,y,b),n}function xS(n,r,o,u,f){var m,y=1/Math.tan(r/2);return n[0]=y/o,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=y,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,f!=null&&f!==1/0?(n[10]=(f+u)*(m=1/(u-f)),n[14]=2*f*u*m):(n[10]=-1,n[14]=-2*u),n}function bS(n,r,o,u,f,m,y){var b=1/(r-o),T=1/(u-f),E=1/(m-y);return n[0]=-2*b,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*T,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*E,n[11]=0,n[12]=(r+o)*b,n[13]=(f+u)*T,n[14]=(y+m)*E,n[15]=1,n}function wS(n,r,o){return n[0]=r[0]-o[0],n[1]=r[1]-o[1],n[2]=r[2]-o[2],n[3]=r[3]-o[3],n[4]=r[4]-o[4],n[5]=r[5]-o[5],n[6]=r[6]-o[6],n[7]=r[7]-o[7],n[8]=r[8]-o[8],n[9]=r[9]-o[9],n[10]=r[10]-o[10],n[11]=r[11]-o[11],n[12]=r[12]-o[12],n[13]=r[13]-o[13],n[14]=r[14]-o[14],n[15]=r[15]-o[15],n}ki.perspective=xS,ki.ortho=bS,ki.mul=gS,ki.sub=wS;var Ai={},Ri={};function K1(n){return K1=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},K1(n)}Object.defineProperty(Ri,"__esModule",{value:!0}),Ri.create=ES,Ri.clone=function(n){var r=new wl.ARRAY_TYPE(3);return r[0]=n[0],r[1]=n[1],r[2]=n[2],r},Ri.length=SS,Ri.fromValues=function(n,r,o){var u=new wl.ARRAY_TYPE(3);return u[0]=n,u[1]=r,u[2]=o,u},Ri.copy=function(n,r){return n[0]=r[0],n[1]=r[1],n[2]=r[2],n},Ri.set=function(n,r,o,u){return n[0]=r,n[1]=o,n[2]=u,n},Ri.add=function(n,r,o){return n[0]=r[0]+o[0],n[1]=r[1]+o[1],n[2]=r[2]+o[2],n},Ri.subtract=AS,Ri.multiply=MS,Ri.divide=CS,Ri.ceil=function(n,r){return n[0]=Math.ceil(r[0]),n[1]=Math.ceil(r[1]),n[2]=Math.ceil(r[2]),n},Ri.floor=function(n,r){return n[0]=Math.floor(r[0]),n[1]=Math.floor(r[1]),n[2]=Math.floor(r[2]),n},Ri.min=function(n,r,o){return n[0]=Math.min(r[0],o[0]),n[1]=Math.min(r[1],o[1]),n[2]=Math.min(r[2],o[2]),n},Ri.max=function(n,r,o){return n[0]=Math.max(r[0],o[0]),n[1]=Math.max(r[1],o[1]),n[2]=Math.max(r[2],o[2]),n},Ri.round=function(n,r){return n[0]=Math.round(r[0]),n[1]=Math.round(r[1]),n[2]=Math.round(r[2]),n},Ri.scale=function(n,r,o){return n[0]=r[0]*o,n[1]=r[1]*o,n[2]=r[2]*o,n},Ri.scaleAndAdd=function(n,r,o,u){return n[0]=r[0]+o[0]*u,n[1]=r[1]+o[1]*u,n[2]=r[2]+o[2]*u,n},Ri.distance=PS,Ri.squaredDistance=IS,Ri.squaredLength=RS,Ri.negate=function(n,r){return n[0]=-r[0],n[1]=-r[1],n[2]=-r[2],n},Ri.inverse=function(n,r){return n[0]=1/r[0],n[1]=1/r[1],n[2]=1/r[2],n},Ri.normalize=function(n,r){var o=r[0],u=r[1],f=r[2],m=o*o+u*u+f*f;return m>0&&(m=1/Math.sqrt(m)),n[0]=r[0]*m,n[1]=r[1]*m,n[2]=r[2]*m,n},Ri.dot=OS,Ri.cross=function(n,r,o){var u=r[0],f=r[1],m=r[2],y=o[0],b=o[1],T=o[2];return n[0]=f*T-m*b,n[1]=m*y-u*T,n[2]=u*b-f*y,n},Ri.lerp=function(n,r,o,u){var f=r[0],m=r[1],y=r[2];return n[0]=f+u*(o[0]-f),n[1]=m+u*(o[1]-m),n[2]=y+u*(o[2]-y),n},Ri.hermite=function(n,r,o,u,f,m){var y=m*m,b=y*(2*m-3)+1,T=y*(m-2)+m,E=y*(m-1),M=y*(3-2*m);return n[0]=r[0]*b+o[0]*T+u[0]*E+f[0]*M,n[1]=r[1]*b+o[1]*T+u[1]*E+f[1]*M,n[2]=r[2]*b+o[2]*T+u[2]*E+f[2]*M,n},Ri.bezier=function(n,r,o,u,f,m){var y=1-m,b=y*y,T=m*m,E=b*y,M=3*m*b,I=3*T*y,k=T*m;return n[0]=r[0]*E+o[0]*M+u[0]*I+f[0]*k,n[1]=r[1]*E+o[1]*M+u[1]*I+f[1]*k,n[2]=r[2]*E+o[2]*M+u[2]*I+f[2]*k,n},Ri.random=function(n,r){r=r||1;var o=2*wl.RANDOM()*Math.PI,u=2*wl.RANDOM()-1,f=Math.sqrt(1-u*u)*r;return n[0]=Math.cos(o)*f,n[1]=Math.sin(o)*f,n[2]=u*r,n},Ri.transformMat4=function(n,r,o){var u=r[0],f=r[1],m=r[2],y=o[3]*u+o[7]*f+o[11]*m+o[15];return n[0]=(o[0]*u+o[4]*f+o[8]*m+o[12])/(y=y||1),n[1]=(o[1]*u+o[5]*f+o[9]*m+o[13])/y,n[2]=(o[2]*u+o[6]*f+o[10]*m+o[14])/y,n},Ri.transformMat3=function(n,r,o){var u=r[0],f=r[1],m=r[2];return n[0]=u*o[0]+f*o[3]+m*o[6],n[1]=u*o[1]+f*o[4]+m*o[7],n[2]=u*o[2]+f*o[5]+m*o[8],n},Ri.transformQuat=function(n,r,o){var u=o[0],f=o[1],m=o[2],y=r[0],b=r[1],T=r[2],E=f*T-m*b,M=m*y-u*T,I=u*b-f*y,k=f*I-m*M,F=m*E-u*I,z=u*M-f*E,V=2*o[3];return M*=V,I*=V,F*=2,z*=2,n[0]=y+(E*=V)+(k*=2),n[1]=b+M+F,n[2]=T+I+z,n},Ri.rotateX=function(n,r,o,u){var f=[],m=[];return f[0]=r[0]-o[0],f[1]=r[1]-o[1],f[2]=r[2]-o[2],m[0]=f[0],m[1]=f[1]*Math.cos(u)-f[2]*Math.sin(u),m[2]=f[1]*Math.sin(u)+f[2]*Math.cos(u),n[0]=m[0]+o[0],n[1]=m[1]+o[1],n[2]=m[2]+o[2],n},Ri.rotateY=function(n,r,o,u){var f=[],m=[];return f[0]=r[0]-o[0],f[1]=r[1]-o[1],f[2]=r[2]-o[2],m[0]=f[2]*Math.sin(u)+f[0]*Math.cos(u),m[1]=f[1],m[2]=f[2]*Math.cos(u)-f[0]*Math.sin(u),n[0]=m[0]+o[0],n[1]=m[1]+o[1],n[2]=m[2]+o[2],n},Ri.rotateZ=function(n,r,o,u){var f=[],m=[];return f[0]=r[0]-o[0],f[1]=r[1]-o[1],f[2]=r[2]-o[2],m[0]=f[0]*Math.cos(u)-f[1]*Math.sin(u),m[1]=f[0]*Math.sin(u)+f[1]*Math.cos(u),m[2]=f[2],n[0]=m[0]+o[0],n[1]=m[1]+o[1],n[2]=m[2]+o[2],n},Ri.angle=function(n,r){var o=n[0],u=n[1],f=n[2],m=r[0],y=r[1],b=r[2],T=Math.sqrt(o*o+u*u+f*f)*Math.sqrt(m*m+y*y+b*b),E=T&&OS(n,r)/T;return Math.acos(Math.min(Math.max(E,-1),1))},Ri.zero=function(n){return n[0]=0,n[1]=0,n[2]=0,n},Ri.str=function(n){return"vec3("+n[0]+", "+n[1]+", "+n[2]+")"},Ri.exactEquals=function(n,r){return n[0]===r[0]&&n[1]===r[1]&&n[2]===r[2]},Ri.equals=function(n,r){var o=n[0],u=n[1],f=n[2],m=r[0],y=r[1],b=r[2];return Math.abs(o-m)<=wl.EPSILON*Math.max(1,Math.abs(o),Math.abs(m))&&Math.abs(u-y)<=wl.EPSILON*Math.max(1,Math.abs(u),Math.abs(y))&&Math.abs(f-b)<=wl.EPSILON*Math.max(1,Math.abs(f),Math.abs(b))},Ri.forEach=Ri.sqrLen=Ri.len=Ri.sqrDist=Ri.dist=Ri.div=Ri.mul=Ri.sub=void 0;var wl=function(n,r){if(n&&n.__esModule)return n;if(n===null||K1(n)!=="object"&&typeof n!="function")return{default:n};var o=TS(void 0);if(o&&o.has(n))return o.get(n);var u={},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var m in n)if(m!=="default"&&Object.prototype.hasOwnProperty.call(n,m)){var y=f?Object.getOwnPropertyDescriptor(n,m):null;y&&(y.get||y.set)?Object.defineProperty(u,m,y):u[m]=n[m]}return u.default=n,o&&o.set(n,u),u}(fs);function TS(n){if(typeof WeakMap!="function")return null;var r=new WeakMap,o=new WeakMap;return(TS=function(u){return u?o:r})(n)}function ES(){var n=new wl.ARRAY_TYPE(3);return wl.ARRAY_TYPE!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function SS(n){return Math.hypot(n[0],n[1],n[2])}function AS(n,r,o){return n[0]=r[0]-o[0],n[1]=r[1]-o[1],n[2]=r[2]-o[2],n}function MS(n,r,o){return n[0]=r[0]*o[0],n[1]=r[1]*o[1],n[2]=r[2]*o[2],n}function CS(n,r,o){return n[0]=r[0]/o[0],n[1]=r[1]/o[1],n[2]=r[2]/o[2],n}function PS(n,r){return Math.hypot(r[0]-n[0],r[1]-n[1],r[2]-n[2])}function IS(n,r){var o=r[0]-n[0],u=r[1]-n[1],f=r[2]-n[2];return o*o+u*u+f*f}function RS(n){var r=n[0],o=n[1],u=n[2];return r*r+o*o+u*u}function OS(n,r){return n[0]*r[0]+n[1]*r[1]+n[2]*r[2]}Ri.sub=AS,Ri.mul=MS,Ri.div=CS,Ri.dist=PS,Ri.sqrDist=IS,Ri.len=SS,Ri.sqrLen=RS;var Tl,_F=(Tl=ES(),function(n,r,o,u,f,m){var y,b;for(r||(r=3),o||(o=0),b=u?Math.min(u*r+o,n.length):n.length,y=o;y<b;y+=r)Tl[0]=n[y],Tl[1]=n[y+1],Tl[2]=n[y+2],f(Tl,Tl,m),n[y]=Tl[0],n[y+1]=Tl[1],n[y+2]=Tl[2];return n});Ri.forEach=_F;var Gi={};function J1(n){return J1=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},J1(n)}Object.defineProperty(Gi,"__esModule",{value:!0}),Gi.create=DS,Gi.clone=function(n){var r=new jo.ARRAY_TYPE(4);return r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r},Gi.fromValues=function(n,r,o,u){var f=new jo.ARRAY_TYPE(4);return f[0]=n,f[1]=r,f[2]=o,f[3]=u,f},Gi.copy=function(n,r){return n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n},Gi.set=function(n,r,o,u,f){return n[0]=r,n[1]=o,n[2]=u,n[3]=f,n},Gi.add=function(n,r,o){return n[0]=r[0]+o[0],n[1]=r[1]+o[1],n[2]=r[2]+o[2],n[3]=r[3]+o[3],n},Gi.subtract=LS,Gi.multiply=NS,Gi.divide=FS,Gi.ceil=function(n,r){return n[0]=Math.ceil(r[0]),n[1]=Math.ceil(r[1]),n[2]=Math.ceil(r[2]),n[3]=Math.ceil(r[3]),n},Gi.floor=function(n,r){return n[0]=Math.floor(r[0]),n[1]=Math.floor(r[1]),n[2]=Math.floor(r[2]),n[3]=Math.floor(r[3]),n},Gi.min=function(n,r,o){return n[0]=Math.min(r[0],o[0]),n[1]=Math.min(r[1],o[1]),n[2]=Math.min(r[2],o[2]),n[3]=Math.min(r[3],o[3]),n},Gi.max=function(n,r,o){return n[0]=Math.max(r[0],o[0]),n[1]=Math.max(r[1],o[1]),n[2]=Math.max(r[2],o[2]),n[3]=Math.max(r[3],o[3]),n},Gi.round=function(n,r){return n[0]=Math.round(r[0]),n[1]=Math.round(r[1]),n[2]=Math.round(r[2]),n[3]=Math.round(r[3]),n},Gi.scale=function(n,r,o){return n[0]=r[0]*o,n[1]=r[1]*o,n[2]=r[2]*o,n[3]=r[3]*o,n},Gi.scaleAndAdd=function(n,r,o,u){return n[0]=r[0]+o[0]*u,n[1]=r[1]+o[1]*u,n[2]=r[2]+o[2]*u,n[3]=r[3]+o[3]*u,n},Gi.distance=BS,Gi.squaredDistance=zS,Gi.length=US,Gi.squaredLength=VS,Gi.negate=function(n,r){return n[0]=-r[0],n[1]=-r[1],n[2]=-r[2],n[3]=-r[3],n},Gi.inverse=function(n,r){return n[0]=1/r[0],n[1]=1/r[1],n[2]=1/r[2],n[3]=1/r[3],n},Gi.normalize=function(n,r){var o=r[0],u=r[1],f=r[2],m=r[3],y=o*o+u*u+f*f+m*m;return y>0&&(y=1/Math.sqrt(y)),n[0]=o*y,n[1]=u*y,n[2]=f*y,n[3]=m*y,n},Gi.dot=function(n,r){return n[0]*r[0]+n[1]*r[1]+n[2]*r[2]+n[3]*r[3]},Gi.cross=function(n,r,o,u){var f=o[0]*u[1]-o[1]*u[0],m=o[0]*u[2]-o[2]*u[0],y=o[0]*u[3]-o[3]*u[0],b=o[1]*u[2]-o[2]*u[1],T=o[1]*u[3]-o[3]*u[1],E=o[2]*u[3]-o[3]*u[2],M=r[0],I=r[1],k=r[2],F=r[3];return n[0]=I*E-k*T+F*b,n[1]=-M*E+k*y-F*m,n[2]=M*T-I*y+F*f,n[3]=-M*b+I*m-k*f,n},Gi.lerp=function(n,r,o,u){var f=r[0],m=r[1],y=r[2],b=r[3];return n[0]=f+u*(o[0]-f),n[1]=m+u*(o[1]-m),n[2]=y+u*(o[2]-y),n[3]=b+u*(o[3]-b),n},Gi.random=function(n,r){var o,u,f,m,y,b;r=r||1;do y=(o=2*jo.RANDOM()-1)*o+(u=2*jo.RANDOM()-1)*u;while(y>=1);do b=(f=2*jo.RANDOM()-1)*f+(m=2*jo.RANDOM()-1)*m;while(b>=1);var T=Math.sqrt((1-y)/b);return n[0]=r*o,n[1]=r*u,n[2]=r*f*T,n[3]=r*m*T,n},Gi.transformMat4=function(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3];return n[0]=o[0]*u+o[4]*f+o[8]*m+o[12]*y,n[1]=o[1]*u+o[5]*f+o[9]*m+o[13]*y,n[2]=o[2]*u+o[6]*f+o[10]*m+o[14]*y,n[3]=o[3]*u+o[7]*f+o[11]*m+o[15]*y,n},Gi.transformQuat=function(n,r,o){var u=r[0],f=r[1],m=r[2],y=o[0],b=o[1],T=o[2],E=o[3],M=E*u+b*m-T*f,I=E*f+T*u-y*m,k=E*m+y*f-b*u,F=-y*u-b*f-T*m;return n[0]=M*E+F*-y+I*-T-k*-b,n[1]=I*E+F*-b+k*-y-M*-T,n[2]=k*E+F*-T+M*-b-I*-y,n[3]=r[3],n},Gi.zero=function(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=0,n},Gi.str=function(n){return"vec4("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+")"},Gi.exactEquals=function(n,r){return n[0]===r[0]&&n[1]===r[1]&&n[2]===r[2]&&n[3]===r[3]},Gi.equals=function(n,r){var o=n[0],u=n[1],f=n[2],m=n[3],y=r[0],b=r[1],T=r[2],E=r[3];return Math.abs(o-y)<=jo.EPSILON*Math.max(1,Math.abs(o),Math.abs(y))&&Math.abs(u-b)<=jo.EPSILON*Math.max(1,Math.abs(u),Math.abs(b))&&Math.abs(f-T)<=jo.EPSILON*Math.max(1,Math.abs(f),Math.abs(T))&&Math.abs(m-E)<=jo.EPSILON*Math.max(1,Math.abs(m),Math.abs(E))},Gi.forEach=Gi.sqrLen=Gi.len=Gi.sqrDist=Gi.dist=Gi.div=Gi.mul=Gi.sub=void 0;var jo=function(n,r){if(n&&n.__esModule)return n;if(n===null||J1(n)!=="object"&&typeof n!="function")return{default:n};var o=kS(void 0);if(o&&o.has(n))return o.get(n);var u={},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var m in n)if(m!=="default"&&Object.prototype.hasOwnProperty.call(n,m)){var y=f?Object.getOwnPropertyDescriptor(n,m):null;y&&(y.get||y.set)?Object.defineProperty(u,m,y):u[m]=n[m]}return u.default=n,o&&o.set(n,u),u}(fs);function kS(n){if(typeof WeakMap!="function")return null;var r=new WeakMap,o=new WeakMap;return(kS=function(u){return u?o:r})(n)}function DS(){var n=new jo.ARRAY_TYPE(4);return jo.ARRAY_TYPE!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function LS(n,r,o){return n[0]=r[0]-o[0],n[1]=r[1]-o[1],n[2]=r[2]-o[2],n[3]=r[3]-o[3],n}function NS(n,r,o){return n[0]=r[0]*o[0],n[1]=r[1]*o[1],n[2]=r[2]*o[2],n[3]=r[3]*o[3],n}function FS(n,r,o){return n[0]=r[0]/o[0],n[1]=r[1]/o[1],n[2]=r[2]/o[2],n[3]=r[3]/o[3],n}function BS(n,r){return Math.hypot(r[0]-n[0],r[1]-n[1],r[2]-n[2],r[3]-n[3])}function zS(n,r){var o=r[0]-n[0],u=r[1]-n[1],f=r[2]-n[2],m=r[3]-n[3];return o*o+u*u+f*f+m*m}function US(n){return Math.hypot(n[0],n[1],n[2],n[3])}function VS(n){var r=n[0],o=n[1],u=n[2],f=n[3];return r*r+o*o+u*u+f*f}Gi.sub=LS,Gi.mul=NS,Gi.div=FS,Gi.dist=BS,Gi.sqrDist=zS,Gi.len=US,Gi.sqrLen=VS;var gF=function(){var n=DS();return function(r,o,u,f,m,y){var b,T;for(o||(o=4),u||(u=0),T=f?Math.min(f*o+u,r.length):r.length,b=u;b<T;b+=o)n[0]=r[b],n[1]=r[b+1],n[2]=r[b+2],n[3]=r[b+3],m(n,n,y),r[b]=n[0],r[b+1]=n[1],r[b+2]=n[2],r[b+3]=n[3];return r}}();function Q1(n){return Q1=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},Q1(n)}Gi.forEach=gF,Object.defineProperty(Ai,"__esModule",{value:!0}),Ai.create=ex,Ai.identity=function(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n},Ai.setAxisAngle=$S,Ai.getAxisAngle=function(n,r){var o=2*Math.acos(r[3]),u=Math.sin(o/2);return u>Bu.EPSILON?(n[0]=r[0]/u,n[1]=r[1]/u,n[2]=r[2]/u):(n[0]=1,n[1]=0,n[2]=0),o},Ai.getAngle=function(n,r){var o=ZS(n,r);return Math.acos(2*o*o-1)},Ai.multiply=WS,Ai.rotateX=function(n,r,o){o*=.5;var u=r[0],f=r[1],m=r[2],y=r[3],b=Math.sin(o),T=Math.cos(o);return n[0]=u*T+y*b,n[1]=f*T+m*b,n[2]=m*T-f*b,n[3]=y*T-u*b,n},Ai.rotateY=function(n,r,o){o*=.5;var u=r[0],f=r[1],m=r[2],y=r[3],b=Math.sin(o),T=Math.cos(o);return n[0]=u*T-m*b,n[1]=f*T+y*b,n[2]=m*T+u*b,n[3]=y*T-f*b,n},Ai.rotateZ=function(n,r,o){o*=.5;var u=r[0],f=r[1],m=r[2],y=r[3],b=Math.sin(o),T=Math.cos(o);return n[0]=u*T+f*b,n[1]=f*T-u*b,n[2]=m*T+y*b,n[3]=y*T-m*b,n},Ai.calculateW=function(n,r){var o=r[0],u=r[1],f=r[2];return n[0]=o,n[1]=u,n[2]=f,n[3]=Math.sqrt(Math.abs(1-o*o-u*u-f*f)),n},Ai.exp=HS,Ai.ln=qS,Ai.pow=function(n,r,o){return qS(n,r),XS(n,n,o),HS(n,n),n},Ai.slerp=jg,Ai.random=function(n){var r=Bu.RANDOM(),o=Bu.RANDOM(),u=Bu.RANDOM(),f=Math.sqrt(1-r),m=Math.sqrt(r);return n[0]=f*Math.sin(2*Math.PI*o),n[1]=f*Math.cos(2*Math.PI*o),n[2]=m*Math.sin(2*Math.PI*u),n[3]=m*Math.cos(2*Math.PI*u),n},Ai.invert=function(n,r){var o=r[0],u=r[1],f=r[2],m=r[3],y=o*o+u*u+f*f+m*m,b=y?1/y:0;return n[0]=-o*b,n[1]=-u*b,n[2]=-f*b,n[3]=m*b,n},Ai.conjugate=function(n,r){return n[0]=-r[0],n[1]=-r[1],n[2]=-r[2],n[3]=r[3],n},Ai.fromMat3=GS,Ai.fromEuler=function(n,r,o,u){var f=.5*Math.PI/180;r*=f,o*=f,u*=f;var m=Math.sin(r),y=Math.cos(r),b=Math.sin(o),T=Math.cos(o),E=Math.sin(u),M=Math.cos(u);return n[0]=m*T*M-y*b*E,n[1]=y*b*M+m*T*E,n[2]=y*T*E-m*b*M,n[3]=y*T*M+m*b*E,n},Ai.str=function(n){return"quat("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+")"},Ai.setAxes=Ai.sqlerp=Ai.rotationTo=Ai.equals=Ai.exactEquals=Ai.normalize=Ai.sqrLen=Ai.squaredLength=Ai.len=Ai.length=Ai.lerp=Ai.dot=Ai.scale=Ai.mul=Ai.add=Ai.set=Ai.copy=Ai.fromValues=Ai.clone=void 0;var Bu=Vg(fs),yF=Vg(Fr),El=Vg(Ri),Co=Vg(Gi);function jS(n){if(typeof WeakMap!="function")return null;var r=new WeakMap,o=new WeakMap;return(jS=function(u){return u?o:r})(n)}function Vg(n,r){if(!r&&n&&n.__esModule)return n;if(n===null||Q1(n)!=="object"&&typeof n!="function")return{default:n};var o=jS(r);if(o&&o.has(n))return o.get(n);var u={},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var m in n)if(m!=="default"&&Object.prototype.hasOwnProperty.call(n,m)){var y=f?Object.getOwnPropertyDescriptor(n,m):null;y&&(y.get||y.set)?Object.defineProperty(u,m,y):u[m]=n[m]}return u.default=n,o&&o.set(n,u),u}function ex(){var n=new Bu.ARRAY_TYPE(4);return Bu.ARRAY_TYPE!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n[3]=1,n}function $S(n,r,o){o*=.5;var u=Math.sin(o);return n[0]=u*r[0],n[1]=u*r[1],n[2]=u*r[2],n[3]=Math.cos(o),n}function WS(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3],b=o[0],T=o[1],E=o[2],M=o[3];return n[0]=u*M+y*b+f*E-m*T,n[1]=f*M+y*T+m*b-u*E,n[2]=m*M+y*E+u*T-f*b,n[3]=y*M-u*b-f*T-m*E,n}function HS(n,r){var o=r[0],u=r[1],f=r[2],m=r[3],y=Math.sqrt(o*o+u*u+f*f),b=Math.exp(m),T=y>0?b*Math.sin(y)/y:0;return n[0]=o*T,n[1]=u*T,n[2]=f*T,n[3]=b*Math.cos(y),n}function qS(n,r){var o=r[0],u=r[1],f=r[2],m=r[3],y=Math.sqrt(o*o+u*u+f*f),b=y>0?Math.atan2(y,m)/y:0;return n[0]=o*b,n[1]=u*b,n[2]=f*b,n[3]=.5*Math.log(o*o+u*u+f*f+m*m),n}function jg(n,r,o,u){var f,m,y,b,T,E=r[0],M=r[1],I=r[2],k=r[3],F=o[0],z=o[1],V=o[2],W=o[3];return(m=E*F+M*z+I*V+k*W)<0&&(m=-m,F=-F,z=-z,V=-V,W=-W),1-m>Bu.EPSILON?(f=Math.acos(m),y=Math.sin(f),b=Math.sin((1-u)*f)/y,T=Math.sin(u*f)/y):(b=1-u,T=u),n[0]=b*E+T*F,n[1]=b*M+T*z,n[2]=b*I+T*V,n[3]=b*k+T*W,n}function GS(n,r){var o,u=r[0]+r[4]+r[8];if(u>0)o=Math.sqrt(u+1),n[3]=.5*o,n[0]=(r[5]-r[7])*(o=.5/o),n[1]=(r[6]-r[2])*o,n[2]=(r[1]-r[3])*o;else{var f=0;r[4]>r[0]&&(f=1),r[8]>r[3*f+f]&&(f=2);var m=(f+1)%3,y=(f+2)%3;o=Math.sqrt(r[3*f+f]-r[3*m+m]-r[3*y+y]+1),n[f]=.5*o,n[3]=(r[3*m+y]-r[3*y+m])*(o=.5/o),n[m]=(r[3*m+f]+r[3*f+m])*o,n[y]=(r[3*y+f]+r[3*f+y])*o}return n}Ai.clone=Co.clone,Ai.fromValues=Co.fromValues,Ai.copy=Co.copy,Ai.set=Co.set,Ai.add=Co.add,Ai.mul=WS;var XS=Co.scale;Ai.scale=XS;var ZS=Co.dot;Ai.dot=ZS,Ai.lerp=Co.lerp;var YS=Co.length;Ai.length=YS,Ai.len=YS;var KS=Co.squaredLength;Ai.squaredLength=KS,Ai.sqrLen=KS;var tx=Co.normalize;Ai.normalize=tx,Ai.exactEquals=Co.exactEquals,Ai.equals=Co.equals;var aa,JS,QS,vF=(aa=El.create(),JS=El.fromValues(1,0,0),QS=El.fromValues(0,1,0),function(n,r,o){var u=El.dot(r,o);return u<-.999999?(El.cross(aa,JS,r),El.len(aa)<1e-6&&El.cross(aa,QS,r),El.normalize(aa,aa),$S(n,aa,Math.PI),n):u>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(El.cross(aa,r,o),n[0]=aa[0],n[1]=aa[1],n[2]=aa[2],n[3]=1+u,tx(n,n))});Ai.rotationTo=vF;var ix,rx,xF=(ix=ex(),rx=ex(),function(n,r,o,u,f,m){return jg(ix,r,f,m),jg(rx,o,u,m),jg(n,ix,rx,2*m*(1-m)),n});Ai.sqlerp=xF;var la,bF=(la=yF.create(),function(n,r,o,u){return la[0]=o[0],la[3]=o[1],la[6]=o[2],la[1]=u[0],la[4]=u[1],la[7]=u[2],la[2]=-r[0],la[5]=-r[1],la[8]=-r[2],tx(n,GS(n,la))});Ai.setAxes=bF;var tr={};function nx(n){return nx=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},nx(n)}Object.defineProperty(tr,"__esModule",{value:!0}),tr.create=function(){var n=new no.ARRAY_TYPE(8);return no.ARRAY_TYPE!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[4]=0,n[5]=0,n[6]=0,n[7]=0),n[3]=1,n},tr.clone=function(n){var r=new no.ARRAY_TYPE(8);return r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r},tr.fromValues=function(n,r,o,u,f,m,y,b){var T=new no.ARRAY_TYPE(8);return T[0]=n,T[1]=r,T[2]=o,T[3]=u,T[4]=f,T[5]=m,T[6]=y,T[7]=b,T},tr.fromRotationTranslationValues=function(n,r,o,u,f,m,y){var b=new no.ARRAY_TYPE(8);b[0]=n,b[1]=r,b[2]=o,b[3]=u;var T=.5*f,E=.5*m,M=.5*y;return b[4]=T*u+E*o-M*r,b[5]=E*u+M*n-T*o,b[6]=M*u+T*r-E*n,b[7]=-T*n-E*r-M*o,b},tr.fromRotationTranslation=iA,tr.fromTranslation=function(n,r){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n[4]=.5*r[0],n[5]=.5*r[1],n[6]=.5*r[2],n[7]=0,n},tr.fromRotation=function(n,r){return n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n[4]=0,n[5]=0,n[6]=0,n[7]=0,n},tr.fromMat4=function(n,r){var o=Sl.create();eA.getRotation(o,r);var u=new no.ARRAY_TYPE(3);return eA.getTranslation(u,r),iA(n,o,u),n},tr.copy=rA,tr.identity=function(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n[4]=0,n[5]=0,n[6]=0,n[7]=0,n},tr.set=function(n,r,o,u,f,m,y,b,T){return n[0]=r,n[1]=o,n[2]=u,n[3]=f,n[4]=m,n[5]=y,n[6]=b,n[7]=T,n},tr.getDual=function(n,r){return n[0]=r[4],n[1]=r[5],n[2]=r[6],n[3]=r[7],n},tr.setDual=function(n,r){return n[4]=r[0],n[5]=r[1],n[6]=r[2],n[7]=r[3],n},tr.getTranslation=function(n,r){var o=r[4],u=r[5],f=r[6],m=r[7],y=-r[0],b=-r[1],T=-r[2],E=r[3];return n[0]=2*(o*E+m*y+u*T-f*b),n[1]=2*(u*E+m*b+f*y-o*T),n[2]=2*(f*E+m*T+o*b-u*y),n},tr.translate=function(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3],b=.5*o[0],T=.5*o[1],E=.5*o[2],M=r[4],I=r[5],k=r[6],F=r[7];return n[0]=u,n[1]=f,n[2]=m,n[3]=y,n[4]=y*b+f*E-m*T+M,n[5]=y*T+m*b-u*E+I,n[6]=y*E+u*T-f*b+k,n[7]=-u*b-f*T-m*E+F,n},tr.rotateX=function(n,r,o){var u=-r[0],f=-r[1],m=-r[2],y=r[3],b=r[4],T=r[5],E=r[6],M=r[7],I=b*y+M*u+T*m-E*f,k=T*y+M*f+E*u-b*m,F=E*y+M*m+b*f-T*u,z=M*y-b*u-T*f-E*m;return Sl.rotateX(n,r,o),n[4]=I*(y=n[3])+z*(u=n[0])+k*(m=n[2])-F*(f=n[1]),n[5]=k*y+z*f+F*u-I*m,n[6]=F*y+z*m+I*f-k*u,n[7]=z*y-I*u-k*f-F*m,n},tr.rotateY=function(n,r,o){var u=-r[0],f=-r[1],m=-r[2],y=r[3],b=r[4],T=r[5],E=r[6],M=r[7],I=b*y+M*u+T*m-E*f,k=T*y+M*f+E*u-b*m,F=E*y+M*m+b*f-T*u,z=M*y-b*u-T*f-E*m;return Sl.rotateY(n,r,o),n[4]=I*(y=n[3])+z*(u=n[0])+k*(m=n[2])-F*(f=n[1]),n[5]=k*y+z*f+F*u-I*m,n[6]=F*y+z*m+I*f-k*u,n[7]=z*y-I*u-k*f-F*m,n},tr.rotateZ=function(n,r,o){var u=-r[0],f=-r[1],m=-r[2],y=r[3],b=r[4],T=r[5],E=r[6],M=r[7],I=b*y+M*u+T*m-E*f,k=T*y+M*f+E*u-b*m,F=E*y+M*m+b*f-T*u,z=M*y-b*u-T*f-E*m;return Sl.rotateZ(n,r,o),n[4]=I*(y=n[3])+z*(u=n[0])+k*(m=n[2])-F*(f=n[1]),n[5]=k*y+z*f+F*u-I*m,n[6]=F*y+z*m+I*f-k*u,n[7]=z*y-I*u-k*f-F*m,n},tr.rotateByQuatAppend=function(n,r,o){var u=o[0],f=o[1],m=o[2],y=o[3],b=r[0],T=r[1],E=r[2],M=r[3];return n[0]=b*y+M*u+T*m-E*f,n[1]=T*y+M*f+E*u-b*m,n[2]=E*y+M*m+b*f-T*u,n[3]=M*y-b*u-T*f-E*m,n[4]=(b=r[4])*y+(M=r[7])*u+(T=r[5])*m-(E=r[6])*f,n[5]=T*y+M*f+E*u-b*m,n[6]=E*y+M*m+b*f-T*u,n[7]=M*y-b*u-T*f-E*m,n},tr.rotateByQuatPrepend=function(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3],b=o[0],T=o[1],E=o[2],M=o[3];return n[0]=u*M+y*b+f*E-m*T,n[1]=f*M+y*T+m*b-u*E,n[2]=m*M+y*E+u*T-f*b,n[3]=y*M-u*b-f*T-m*E,n[4]=u*(M=o[7])+y*(b=o[4])+f*(E=o[6])-m*(T=o[5]),n[5]=f*M+y*T+m*b-u*E,n[6]=m*M+y*E+u*T-f*b,n[7]=y*M-u*b-f*T-m*E,n},tr.rotateAroundAxis=function(n,r,o,u){if(Math.abs(u)<no.EPSILON)return rA(n,r);var f=Math.hypot(o[0],o[1],o[2]);u*=.5;var m=Math.sin(u),y=m*o[0]/f,b=m*o[1]/f,T=m*o[2]/f,E=Math.cos(u),M=r[0],I=r[1],k=r[2],F=r[3];n[0]=M*E+F*y+I*T-k*b,n[1]=I*E+F*b+k*y-M*T,n[2]=k*E+F*T+M*b-I*y,n[3]=F*E-M*y-I*b-k*T;var z=r[4],V=r[5],W=r[6],G=r[7];return n[4]=z*E+G*y+V*T-W*b,n[5]=V*E+G*b+W*y-z*T,n[6]=W*E+G*T+z*b-V*y,n[7]=G*E-z*y-V*b-W*T,n},tr.add=function(n,r,o){return n[0]=r[0]+o[0],n[1]=r[1]+o[1],n[2]=r[2]+o[2],n[3]=r[3]+o[3],n[4]=r[4]+o[4],n[5]=r[5]+o[5],n[6]=r[6]+o[6],n[7]=r[7]+o[7],n},tr.multiply=nA,tr.scale=function(n,r,o){return n[0]=r[0]*o,n[1]=r[1]*o,n[2]=r[2]*o,n[3]=r[3]*o,n[4]=r[4]*o,n[5]=r[5]*o,n[6]=r[6]*o,n[7]=r[7]*o,n},tr.lerp=function(n,r,o,u){var f=1-u;return sA(r,o)<0&&(u=-u),n[0]=r[0]*f+o[0]*u,n[1]=r[1]*f+o[1]*u,n[2]=r[2]*f+o[2]*u,n[3]=r[3]*f+o[3]*u,n[4]=r[4]*f+o[4]*u,n[5]=r[5]*f+o[5]*u,n[6]=r[6]*f+o[6]*u,n[7]=r[7]*f+o[7]*u,n},tr.invert=function(n,r){var o=$g(r);return n[0]=-r[0]/o,n[1]=-r[1]/o,n[2]=-r[2]/o,n[3]=r[3]/o,n[4]=-r[4]/o,n[5]=-r[5]/o,n[6]=-r[6]/o,n[7]=r[7]/o,n},tr.conjugate=function(n,r){return n[0]=-r[0],n[1]=-r[1],n[2]=-r[2],n[3]=r[3],n[4]=-r[4],n[5]=-r[5],n[6]=-r[6],n[7]=r[7],n},tr.normalize=function(n,r){var o=$g(r);if(o>0){o=Math.sqrt(o);var u=r[0]/o,f=r[1]/o,m=r[2]/o,y=r[3]/o,b=r[4],T=r[5],E=r[6],M=r[7],I=u*b+f*T+m*E+y*M;n[0]=u,n[1]=f,n[2]=m,n[3]=y,n[4]=(b-u*I)/o,n[5]=(T-f*I)/o,n[6]=(E-m*I)/o,n[7]=(M-y*I)/o}return n},tr.str=function(n){return"quat2("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+", "+n[4]+", "+n[5]+", "+n[6]+", "+n[7]+")"},tr.exactEquals=function(n,r){return n[0]===r[0]&&n[1]===r[1]&&n[2]===r[2]&&n[3]===r[3]&&n[4]===r[4]&&n[5]===r[5]&&n[6]===r[6]&&n[7]===r[7]},tr.equals=function(n,r){var o=n[0],u=n[1],f=n[2],m=n[3],y=n[4],b=n[5],T=n[6],E=n[7],M=r[0],I=r[1],k=r[2],F=r[3],z=r[4],V=r[5],W=r[6],G=r[7];return Math.abs(o-M)<=no.EPSILON*Math.max(1,Math.abs(o),Math.abs(M))&&Math.abs(u-I)<=no.EPSILON*Math.max(1,Math.abs(u),Math.abs(I))&&Math.abs(f-k)<=no.EPSILON*Math.max(1,Math.abs(f),Math.abs(k))&&Math.abs(m-F)<=no.EPSILON*Math.max(1,Math.abs(m),Math.abs(F))&&Math.abs(y-z)<=no.EPSILON*Math.max(1,Math.abs(y),Math.abs(z))&&Math.abs(b-V)<=no.EPSILON*Math.max(1,Math.abs(b),Math.abs(V))&&Math.abs(T-W)<=no.EPSILON*Math.max(1,Math.abs(T),Math.abs(W))&&Math.abs(E-G)<=no.EPSILON*Math.max(1,Math.abs(E),Math.abs(G))},tr.sqrLen=tr.squaredLength=tr.len=tr.length=tr.dot=tr.mul=tr.setReal=tr.getReal=void 0;var no=sx(fs),Sl=sx(Ai),eA=sx(ki);function tA(n){if(typeof WeakMap!="function")return null;var r=new WeakMap,o=new WeakMap;return(tA=function(u){return u?o:r})(n)}function sx(n,r){if(!r&&n&&n.__esModule)return n;if(n===null||nx(n)!=="object"&&typeof n!="function")return{default:n};var o=tA(r);if(o&&o.has(n))return o.get(n);var u={},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var m in n)if(m!=="default"&&Object.prototype.hasOwnProperty.call(n,m)){var y=f?Object.getOwnPropertyDescriptor(n,m):null;y&&(y.get||y.set)?Object.defineProperty(u,m,y):u[m]=n[m]}return u.default=n,o&&o.set(n,u),u}function iA(n,r,o){var u=.5*o[0],f=.5*o[1],m=.5*o[2],y=r[0],b=r[1],T=r[2],E=r[3];return n[0]=y,n[1]=b,n[2]=T,n[3]=E,n[4]=u*E+f*T-m*b,n[5]=f*E+m*y-u*T,n[6]=m*E+u*b-f*y,n[7]=-u*y-f*b-m*T,n}function rA(n,r){return n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n[4]=r[4],n[5]=r[5],n[6]=r[6],n[7]=r[7],n}function nA(n,r,o){var u=r[0],f=r[1],m=r[2],y=r[3],b=o[4],T=o[5],E=o[6],M=o[7],I=r[4],k=r[5],F=r[6],z=r[7],V=o[0],W=o[1],G=o[2],te=o[3];return n[0]=u*te+y*V+f*G-m*W,n[1]=f*te+y*W+m*V-u*G,n[2]=m*te+y*G+u*W-f*V,n[3]=y*te-u*V-f*W-m*G,n[4]=u*M+y*b+f*E-m*T+I*te+z*V+k*G-F*W,n[5]=f*M+y*T+m*b-u*E+k*te+z*W+F*V-I*G,n[6]=m*M+y*E+u*T-f*b+F*te+z*G+I*W-k*V,n[7]=y*M-u*b-f*T-m*E+z*te-I*V-k*W-F*G,n}tr.getReal=Sl.copy,tr.setReal=Sl.copy,tr.mul=nA;var sA=Sl.dot;tr.dot=sA;var oA=Sl.length;tr.length=oA,tr.len=oA;var $g=Sl.squaredLength;tr.squaredLength=$g,tr.sqrLen=$g;var Bi={};function ox(n){return ox=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},ox(n)}Object.defineProperty(Bi,"__esModule",{value:!0}),Bi.create=lA,Bi.clone=function(n){var r=new zu.ARRAY_TYPE(2);return r[0]=n[0],r[1]=n[1],r},Bi.fromValues=function(n,r){var o=new zu.ARRAY_TYPE(2);return o[0]=n,o[1]=r,o},Bi.copy=function(n,r){return n[0]=r[0],n[1]=r[1],n},Bi.set=function(n,r,o){return n[0]=r,n[1]=o,n},Bi.add=function(n,r,o){return n[0]=r[0]+o[0],n[1]=r[1]+o[1],n},Bi.subtract=cA,Bi.multiply=uA,Bi.divide=hA,Bi.ceil=function(n,r){return n[0]=Math.ceil(r[0]),n[1]=Math.ceil(r[1]),n},Bi.floor=function(n,r){return n[0]=Math.floor(r[0]),n[1]=Math.floor(r[1]),n},Bi.min=function(n,r,o){return n[0]=Math.min(r[0],o[0]),n[1]=Math.min(r[1],o[1]),n},Bi.max=function(n,r,o){return n[0]=Math.max(r[0],o[0]),n[1]=Math.max(r[1],o[1]),n},Bi.round=function(n,r){return n[0]=Math.round(r[0]),n[1]=Math.round(r[1]),n},Bi.scale=function(n,r,o){return n[0]=r[0]*o,n[1]=r[1]*o,n},Bi.scaleAndAdd=function(n,r,o,u){return n[0]=r[0]+o[0]*u,n[1]=r[1]+o[1]*u,n},Bi.distance=dA,Bi.squaredDistance=fA,Bi.length=pA,Bi.squaredLength=mA,Bi.negate=function(n,r){return n[0]=-r[0],n[1]=-r[1],n},Bi.inverse=function(n,r){return n[0]=1/r[0],n[1]=1/r[1],n},Bi.normalize=function(n,r){var o=r[0],u=r[1],f=o*o+u*u;return f>0&&(f=1/Math.sqrt(f)),n[0]=r[0]*f,n[1]=r[1]*f,n},Bi.dot=function(n,r){return n[0]*r[0]+n[1]*r[1]},Bi.cross=function(n,r,o){var u=r[0]*o[1]-r[1]*o[0];return n[0]=n[1]=0,n[2]=u,n},Bi.lerp=function(n,r,o,u){var f=r[0],m=r[1];return n[0]=f+u*(o[0]-f),n[1]=m+u*(o[1]-m),n},Bi.random=function(n,r){r=r||1;var o=2*zu.RANDOM()*Math.PI;return n[0]=Math.cos(o)*r,n[1]=Math.sin(o)*r,n},Bi.transformMat2=function(n,r,o){var u=r[0],f=r[1];return n[0]=o[0]*u+o[2]*f,n[1]=o[1]*u+o[3]*f,n},Bi.transformMat2d=function(n,r,o){var u=r[0],f=r[1];return n[0]=o[0]*u+o[2]*f+o[4],n[1]=o[1]*u+o[3]*f+o[5],n},Bi.transformMat3=function(n,r,o){var u=r[0],f=r[1];return n[0]=o[0]*u+o[3]*f+o[6],n[1]=o[1]*u+o[4]*f+o[7],n},Bi.transformMat4=function(n,r,o){var u=r[0],f=r[1];return n[0]=o[0]*u+o[4]*f+o[12],n[1]=o[1]*u+o[5]*f+o[13],n},Bi.rotate=function(n,r,o,u){var f=r[0]-o[0],m=r[1]-o[1],y=Math.sin(u),b=Math.cos(u);return n[0]=f*b-m*y+o[0],n[1]=f*y+m*b+o[1],n},Bi.angle=function(n,r){var o=n[0],u=n[1],f=r[0],m=r[1],y=Math.sqrt(o*o+u*u)*Math.sqrt(f*f+m*m);return Math.acos(Math.min(Math.max(y&&(o*f+u*m)/y,-1),1))},Bi.zero=function(n){return n[0]=0,n[1]=0,n},Bi.str=function(n){return"vec2("+n[0]+", "+n[1]+")"},Bi.exactEquals=function(n,r){return n[0]===r[0]&&n[1]===r[1]},Bi.equals=function(n,r){var o=n[0],u=n[1],f=r[0],m=r[1];return Math.abs(o-f)<=zu.EPSILON*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(u-m)<=zu.EPSILON*Math.max(1,Math.abs(u),Math.abs(m))},Bi.forEach=Bi.sqrLen=Bi.sqrDist=Bi.dist=Bi.div=Bi.mul=Bi.sub=Bi.len=void 0;var zu=function(n,r){if(n&&n.__esModule)return n;if(n===null||ox(n)!=="object"&&typeof n!="function")return{default:n};var o=aA(void 0);if(o&&o.has(n))return o.get(n);var u={},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var m in n)if(m!=="default"&&Object.prototype.hasOwnProperty.call(n,m)){var y=f?Object.getOwnPropertyDescriptor(n,m):null;y&&(y.get||y.set)?Object.defineProperty(u,m,y):u[m]=n[m]}return u.default=n,o&&o.set(n,u),u}(fs);function aA(n){if(typeof WeakMap!="function")return null;var r=new WeakMap,o=new WeakMap;return(aA=function(u){return u?o:r})(n)}function lA(){var n=new zu.ARRAY_TYPE(2);return zu.ARRAY_TYPE!=Float32Array&&(n[0]=0,n[1]=0),n}function cA(n,r,o){return n[0]=r[0]-o[0],n[1]=r[1]-o[1],n}function uA(n,r,o){return n[0]=r[0]*o[0],n[1]=r[1]*o[1],n}function hA(n,r,o){return n[0]=r[0]/o[0],n[1]=r[1]/o[1],n}function dA(n,r){return Math.hypot(r[0]-n[0],r[1]-n[1])}function fA(n,r){var o=r[0]-n[0],u=r[1]-n[1];return o*o+u*u}function pA(n){return Math.hypot(n[0],n[1])}function mA(n){var r=n[0],o=n[1];return r*r+o*o}Bi.len=pA,Bi.sub=cA,Bi.mul=uA,Bi.div=hA,Bi.dist=dA,Bi.sqrDist=fA,Bi.sqrLen=mA;var wF=function(){var n=lA();return function(r,o,u,f,m,y){var b,T;for(o||(o=2),u||(u=0),T=f?Math.min(f*o+u,r.length):r.length,b=u;b<T;b+=o)n[0]=r[b],n[1]=r[b+1],m(n,n,y),r[b]=n[0],r[b+1]=n[1];return r}}();function ax(n){return ax=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},ax(n)}Bi.forEach=wF,Object.defineProperty(ds,"__esModule",{value:!0}),l.a7=ds.vec4=l.N=ds.vec3=ds.vec2=ds.quat2=l.bi=ds.quat=l.a6=ds.mat4=l.co=ds.mat3=ds.mat2d=l.b4=ds.mat2=ds.glMatrix=void 0;var TF=Wa(fs);ds.glMatrix=TF;var EF=Wa(mn);l.b4=ds.mat2=EF;var SF=Wa(vn);ds.mat2d=SF;var AF=Wa(Fr);l.co=ds.mat3=AF;var MF=Wa(ki);l.a6=ds.mat4=MF;var CF=Wa(Ai);l.bi=ds.quat=CF;var PF=Wa(tr);ds.quat2=PF;var IF=Wa(Bi);ds.vec2=IF;var RF=Wa(Ri);l.N=ds.vec3=RF;var OF=Wa(Gi);function _A(n){if(typeof WeakMap!="function")return null;var r=new WeakMap,o=new WeakMap;return(_A=function(u){return u?o:r})(n)}function Wa(n,r){if(!r&&n&&n.__esModule)return n;if(n===null||ax(n)!=="object"&&typeof n!="function")return{default:n};var o=_A(r);if(o&&o.has(n))return o.get(n);var u={},f=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var m in n)if(m!=="default"&&Object.prototype.hasOwnProperty.call(n,m)){var y=f?Object.getOwnPropertyDescriptor(n,m):null;y&&(y.get||y.set)?Object.defineProperty(u,m,y):u[m]=n[m]}return u.default=n,o&&o.set(n,u),u}l.a7=ds.vec4=OF;class lx{constructor(r,o){this.pos=r,this.dir=o}intersectsPlane(r,o,u){const f=l.N.dot(o,this.dir);if(Math.abs(f)<1e-6)return!1;const m=((r[0]-this.pos[0])*o[0]+(r[1]-this.pos[1])*o[1]+(r[2]-this.pos[2])*o[2])/f;return u[0]=this.pos[0]+this.dir[0]*m,u[1]=this.pos[1]+this.dir[1]*m,u[2]=this.pos[2]+this.dir[2]*m,!0}closestPointOnSphere(r,o,u){if(l.N.equals(this.pos,r)||o===0)return u[0]=u[1]=u[2]=0,!1;const[f,m,y]=this.dir,b=this.pos[0]-r[0],T=this.pos[1]-r[1],E=this.pos[2]-r[2],M=f*f+m*m+y*y,I=2*(b*f+T*m+E*y),k=I*I-4*M*(b*b+T*T+E*E-o*o);if(k<0){const F=Math.max(-I/2,0),z=b+f*F,V=T+m*F,W=E+y*F,G=Math.hypot(z,V,W);return u[0]=z*o/G,u[1]=V*o/G,u[2]=W*o/G,!1}{const F=(-I-Math.sqrt(k))/(2*M);if(F<0){const z=Math.hypot(b,T,E);return u[0]=b*o/z,u[1]=T*o/z,u[2]=E*o/z,!1}return u[0]=b+f*F,u[1]=T+m*F,u[2]=E+y*F,!0}}}class cx{constructor(r,o,u,f,m){this.TL=r,this.TR=o,this.BR=u,this.BL=f,this.horizon=m}static fromInvProjectionMatrix(r,o,u){const f=[-1,1,1],m=[1,1,1],y=[1,-1,1],b=[-1,-1,1],T=l.N.transformMat4(f,f,r),E=l.N.transformMat4(m,m,r),M=l.N.transformMat4(y,y,r),I=l.N.transformMat4(b,b,r);return new cx(T,E,M,I,o/u)}}function rm(n,r,o){let u=1/0,f=-1/0;const m=[];for(const y of n){l.N.sub(m,y,r);const b=l.N.dot(m,o);u=Math.min(u,b),f=Math.max(f,b)}return[u,f]}function gA(n,r){let o=!0;for(let u=0;u<n.planes.length;u++){const f=n.planes[u];let m=0;for(let y=0;y<r.length;y++)m+=l.N.dot(f,r[y])+f[3]>=0;if(m===0)return 0;m!==r.length&&(o=!1)}return o?2:1}function yA(n,r){for(const o of n.projections){const u=rm(r,n.points[0],o.axis);if(o.projection[1]<u[0]||o.projection[0]>u[1])return 0}return 1}function vA(n,r){let o=0;const u=[0,0,0,0];for(let f=0;f<n.length;f++)u[0]=n[f][0],u[1]=n[f][1],u[2]=n[f][2],u[3]=1,l.a7.dot(u,r)>=0&&o++;return o}class ux{constructor(r,o){this.points=r||new Array(8).fill([0,0,0]),this.planes=o||new Array(6).fill([0,0,0,0]),this.bounds=xn.fromPoints(this.points),this.projections=[],this.frustumEdges=[l.N.sub([],this.points[2],this.points[3]),l.N.sub([],this.points[0],this.points[3]),l.N.sub([],this.points[4],this.points[0]),l.N.sub([],this.points[5],this.points[1]),l.N.sub([],this.points[6],this.points[2]),l.N.sub([],this.points[7],this.points[3])];for(const u of this.frustumEdges){const f=[0,-u[2],u[1]],m=[u[2],0,-u[0]];this.projections.push({axis:f,projection:rm(this.points,this.points[0],f)}),this.projections.push({axis:m,projection:rm(this.points,this.points[0],m)})}}static fromInvProjectionMatrix(r,o,u,f){const m=Math.pow(2,u),y=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(E=>{const M=l.a7.transformMat4([],E,r),I=1/M[3]/o*m;return l.a7.mul(M,M,[I,I,f?1/M[3]:I,I])}),b=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(E=>{const M=l.N.sub([],y[E[0]],y[E[1]]),I=l.N.sub([],y[E[2]],y[E[1]]),k=l.N.normalize([],l.N.cross([],M,I)),F=-l.N.dot(k,y[E[1]]);return k.concat(F)}),T=[];for(let E=0;E<y.length;E++)T.push([y[E][0],y[E][1],y[E][2]]);return new ux(T,b)}intersectsPrecise(r,o,u){for(let f=0;f<o.length;f++)if(!vA(r,o[f]))return 0;for(let f=0;f<this.planes.length;f++)if(!vA(r,this.planes[f]))return 0;for(const f of u)for(const m of this.frustumEdges){const y=l.N.cross([],f,m),b=l.N.length(y);if(b===0)continue;l.N.scale(y,y,1/b);const T=rm(this.points,this.points[0],y),E=rm(r,this.points[0],y);if(T[0]>E[1]||E[0]>T[1])return 0}return 1}}class xn{static fromPoints(r){const o=[1/0,1/0,1/0],u=[-1/0,-1/0,-1/0];for(const f of r)l.N.min(o,o,f),l.N.max(u,u,f);return new xn(o,u)}static fromTileIdAndHeight(r,o,u){const f=1<<r.canonical.z,m=r.canonical.x,y=r.canonical.y;return new xn([m/f,y/f,o],[(m+1)/f,(y+1)/f,u])}static applyTransform(r,o){const u=r.getCorners();for(let f=0;f<u.length;++f)l.N.transformMat4(u[f],u[f],o);return xn.fromPoints(u)}static projectAabbCorners(r,o){const u=r.getCorners();for(let f=0;f<u.length;++f)l.N.transformMat4(u[f],u[f],o);return u}constructor(r,o){this.min=r,this.max=o,this.center=l.N.scale([],l.N.add([],this.min,this.max),.5)}quadrant(r){const o=[r%2==0,r<2],u=l.N.clone(this.min),f=l.N.clone(this.max);for(let m=0;m<o.length;m++)u[m]=o[m]?this.min[m]:this.center[m],f[m]=o[m]?this.center[m]:this.max[m];return f[2]=this.max[2],new xn(u,f)}distanceX(r){return Math.max(Math.min(this.max[0],r[0]),this.min[0])-r[0]}distanceY(r){return Math.max(Math.min(this.max[1],r[1]),this.min[1])-r[1]}distanceZ(r){return Math.max(Math.min(this.max[2],r[2]),this.min[2])-r[2]}getCorners(){const r=this.min,o=this.max;return[[r[0],r[1],r[2]],[o[0],r[1],r[2]],[o[0],o[1],r[2]],[r[0],o[1],r[2]],[r[0],r[1],o[2]],[o[0],r[1],o[2]],[o[0],o[1],o[2]],[r[0],o[1],o[2]]]}intersects(r){return this.intersectsAabb(r.bounds)?gA(r,this.getCorners()):0}intersectsFlat(r){return this.intersectsAabb(r.bounds)?gA(r,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(r,o){return o||this.intersects(r)?yA(r,this.getCorners()):0}intersectsPreciseFlat(r,o){return o||this.intersectsFlat(r)?yA(r,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(r){for(let o=0;o<3;++o)if(this.min[o]>r.max[o]||r.min[o]>this.max[o])return!1;return!0}intersectsAabbXY(r){return!(this.min[0]>r.max[0]||r.min[0]>this.max[0]||this.min[1]>r.max[1]||r.min[1]>this.max[1])}encapsulate(r){for(let o=0;o<3;o++)this.min[o]=Math.min(this.min[o],r.min[o]),this.max[o]=Math.max(this.max[o],r.max[o])}encapsulatePoint(r){for(let o=0;o<3;o++)this.min[o]=Math.min(this.min[o],r[o]),this.max[o]=Math.max(this.max[o],r[o])}closestPoint(r){return[Math.max(Math.min(this.max[0],r[0]),this.min[0]),Math.max(Math.min(this.max[1],r[1]),this.min[1]),Math.max(Math.min(this.max[2],r[2]),this.min[2])]}}Ht(xn,"Aabb");const kF=Mr([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Wg}=kF,DF=Mr([{name:"a_pos_3",components:3,type:"Int16"}]);var xA=Mr([{name:"a_pos",type:"Int16",components:2}]);function Hg(n){return n*re/Ge}const LF=[new xn([Ce,Ce,Ce],[Ue,Ue,Ue]),new xn([Ce,Ce,Ce],[0,0,Ue]),new xn([0,Ce,Ce],[Ue,0,Ue]),new xn([Ce,0,Ce],[0,Ue,Ue]),new xn([0,0,Ce],[Ue,Ue,Ue])];function bA(n,r,o,u=!0){const f=l.N.scale([],n._camera.position,n.worldSize),m=[r,o,1,1];l.a7.transformMat4(m,m,n.pixelMatrixInverse),l.a7.scale(m,m,1/m[3]);const y=l.N.sub([],m,f),b=l.N.normalize([],y),T=n.globeMatrix,E=[T[12],T[13],T[14]],M=l.N.sub([],E,f),I=l.N.length(M),k=l.N.normalize([],M),F=n.worldSize/(2*Math.PI),z=l.N.dot(k,b),V=Math.asin(F/I);if(V<Math.acos(z)){if(!u)return null;const Le=[],rt=[];l.N.scale(Le,b,I/z),l.N.normalize(rt,l.N.sub(rt,Le,M)),l.N.normalize(b,l.N.add(b,M,l.N.scale(b,rt,Math.tan(V)*I)))}const W=[];new lx(f,b).closestPointOnSphere(E,F,W);const G=l.N.normalize([],he(T,0)),te=l.N.normalize([],he(T,1)),se=l.N.normalize([],he(T,2)),ne=l.N.dot(G,W),ye=l.N.dot(te,W),de=l.N.dot(se,W),Ee=Ct(Math.asin(-ye/F));let Pe=Ct(Math.atan2(ne,de));Pe=n.center.lng+function(Le,rt){const ht=(rt-Le+180)%360-180;return ht<-180?ht+360:ht}(n.center.lng,Pe);const De=Ii(Pe),Ve=ri(gi(Ee),0,1);return new sr(De,Ve)}class NF{constructor(r,o,u){this.a=l.N.sub([],r,u),this.b=l.N.sub([],o,u),this.center=u;const f=l.N.normalize([],this.a),m=l.N.normalize([],this.b);this.angle=Math.acos(l.N.dot(f,m))}}function hx(n,r){if(n.angle===0)return null;let o;return o=n.a[r]===0?1/n.angle*.5*Math.PI:1/n.angle*Math.atan(n.b[r]/n.a[r]/Math.sin(n.angle)-1/Math.tan(n.angle)),o<0||o>1?null:function(u,f,m,y){const b=Math.sin(m);return u*(Math.sin((1-y)*m)/b)+f*(Math.sin(y*m)/b)}(n.a[r],n.b[r],n.angle,ri(o,0,1))+n.center[r]}function Ha(n){if(n.z<=1)return LF[n.z+2*n.y+n.x];const r=dx(qg(n));return xn.fromPoints(r)}function Al(n,r,o){return l.N.scale(n,n,1-o),l.N.scaleAndAdd(n,n,r,o)}function wA(n,r,o){for(const u of n)l.N.transformMat4(u,u,r),l.N.scale(u,u,o)}function TA(n,r,o,u){const f=r/n.worldSize,m=n.globeMatrix;if(o.z<=1){const De=Ha(o).getCorners();return wA(De,m,f),xn.fromPoints(De)}const y=qg(o,u),b=dx(y,re+Hg(n._tileCoverLift));wA(b,m,f);const T=Number.MAX_VALUE,E=[-T,-T,-T],M=[T,T,T];if(y.contains(n.center)){for(const Le of b)l.N.min(M,M,Le),l.N.max(E,E,Le);E[2]=0;const De=n.point,Ve=[De.x*f,De.y*f,0];return l.N.min(M,M,Ve),l.N.max(E,E,Ve),new xn(M,E)}if(n._tileCoverLift>0){for(const De of b)l.N.min(M,M,De),l.N.max(E,E,De);return new xn(M,E)}const I=[m[12]*f,m[13]*f,m[14]*f],k=y.getCenter(),F=ri(n.center.lat,-Ui,Ui),z=ri(k.lat,-Ui,Ui),V=Ii(n.center.lng),W=gi(F);let G=V-Ii(k.lng);const te=W-gi(z);G>.5?G-=1:G<-.5&&(G+=1);let se=0;if(Math.abs(G)>Math.abs(te))se=G>=0?1:3;else{se=te>=0?0:2;const De=[m[4]*f,m[5]*f,m[6]*f],Ve=-Math.sin(Qe(te>=0?y.getSouth():y.getNorth()))*re;l.N.scaleAndAdd(I,I,De,Ve)}const ne=b[se],ye=b[(se+1)%4],de=new NF(ne,ye,I),Ee=[hx(de,0)||ne[0],hx(de,1)||ne[1],hx(de,2)||ne[2]],Pe=lc(n.zoom);if(Pe>0){const De=function({x:Le,y:rt,z:ht},Ze,ct,qe,at){const Ot=1/(1<<ht);let dt=Le*Ot,Xt=dt+Ot,Wt=rt*Ot,_t=Wt+Ot,hi=0;const ti=(dt+Xt)/2-qe;return ti>.5?hi=-1:ti<-.5&&(hi=1),dt=((dt+hi)*Ze-(qe*=Ze))*ct+qe,Xt=((Xt+hi)*Ze-qe)*ct+qe,Wt=(Wt*Ze-(at*=Ze))*ct+at,_t=(_t*Ze-at)*ct+at,[[dt,_t,0],[Xt,_t,0],[Xt,Wt,0],[dt,Wt,0]]}(o,r,n._pixelsPerMercatorPixel,V,W);for(let Le=0;Le<b.length;Le++)Al(b[Le],De[Le],Pe);const Ve=l.N.add([],De[se],De[(se+1)%4]);l.N.scale(Ve,Ve,.5),Al(Ee,Ve,Pe)}for(const De of b)l.N.min(M,M,De),l.N.max(E,E,De);return M[2]=Math.min(ne[2],ye[2]),l.N.min(M,M,Ee),l.N.max(E,E,Ee),new xn(M,E)}function qg({x:n,y:r,z:o},u=!1){const f=1/(1<<o),m=new ke(wi(n*f),r===(1<<o)-1&&u?-90:Qi((r+1)*f)),y=new ke(wi((n+1)*f),r===0&&u?90:Qi(r*f));return new He(m,y)}function dx(n,r=re){const o=Qe(n.getNorth()),u=Qe(n.getSouth()),f=Math.cos(o),m=Math.cos(u),y=Math.sin(o),b=Math.sin(u),T=n.getWest(),E=n.getEast();return[Re(m,b,T,r),Re(m,b,E,r),Re(f,y,E,r),Re(f,y,T,r)]}function nm(n,r,o,u){const f=1<<o.z,m=(n/Bt+o.x)/f;return Ye(Qi((r/Bt+o.y)/f),wi(m),u)}function Gg({min:n,max:r}){return ce/Math.max(r[0]-n[0],r[1]-n[1],r[2]-n[2])}const EA=new Float64Array(16);function Xg(n){const r=Gg(n),o=l.a6.fromScaling(EA,[r,r,r]);return l.a6.translate(o,o,l.N.negate([],n.min))}function fx(n){const r=l.a6.fromTranslation(EA,n.min),o=1/Gg(n);return l.a6.scale(r,r,[o,o,o])}function px(n){const r=Bt/(2*Math.PI);return n/(2*Math.PI)/r}function SA(n,r){return Bt/(512*Math.pow(2,n))*Gg(Ha(r))}function AA(n,r,o,u,f){const m=px(o),y=[n,r,-o/(2*Math.PI)],b=l.a6.identity(new Float64Array(16));return l.a6.translate(b,b,y),l.a6.scale(b,b,[m,m,m]),l.a6.rotateX(b,b,Qe(-f)),l.a6.rotateY(b,b,Qe(-u)),b}function lc(n){return vr(le,Q,n)}function MA(n,r){const o=Ye(r.lat,r.lng),u=function(m){const y=Ye(m._center.lat,m._center.lng),b=l.N.fromValues(0,1,0);let T=l.N.cross([],b,y);const E=l.a6.fromRotation([],-m.angle,y);T=l.N.transformMat4(T,T,E),l.a6.fromRotation(E,-m._pitch,T);const M=l.N.normalize([],y);return l.N.scale(M,M,Hg(m.cameraToCenterDistance/m.pixelsPerMeter)),l.N.transformMat4(M,M,E),l.N.add([],y,M)}(n),f=l.N.subtract([],u,o);return l.N.angle(f,o)}function mx(n,r){return MA(n,r)>Math.PI/2*1.01}const CA=Qe(85),FF=Math.cos(CA),BF=Math.sin(CA),zF=l.a6.create(),PA=n=>{const r=[];return n.paint.get("circle-pitch-alignment")==="map"&&r.push("PITCH_WITH_MAP"),n.paint.get("circle-pitch-scale")==="map"&&r.push("SCALE_WITH_MAP"),r};function IA(n,r,o,u,f,m,y,b,T){if(m&&n.queryGeometry.isAboveHorizon)return!1;m&&(T*=n.pixelToTileUnitsFactor);const E=n.tileID.canonical,M=o.projection.upVectorScale(E,o.center.lat,o.worldSize).metersToTile;for(const I of r)for(const k of I){const F=k.add(b),z=f&&o.elevation?o.elevation.exaggeration()*f.getElevationAt(F.x,F.y,!0):0,V=o.projection.projectTilePoint(F.x,F.y,E);if(z>0){const se=o.projection.upVector(E,F.x,F.y);V.x+=se[0]*M*z,V.y+=se[1]*M*z,V.z+=se[2]*M*z}const W=m?F:UF(V.x,V.y,V.z,u),G=m?n.tilespaceRays.map(se=>jF(se,z)):n.queryGeometry.screenGeometry,te=l.a7.transformMat4([],[V.x,V.y,V.z,1],u);if(!y&&m?T*=te[3]/o.cameraToCenterDistance:y&&!m&&(T*=o.cameraToCenterDistance/te[3]),m){const se=Qi((k.y/Bt+E.y)/(1<<E.z));T/=o.projection.pixelsPerMeter(se,1)/Ti(1,se)}if(ja(G,W,T))return!0}return!1}function UF(n,r,o,u){const f=l.a7.transformMat4([],[n,r,o,1],u);return new xe(f[0]/f[3],f[1]/f[3])}const RA=l.N.fromValues(0,0,0),VF=l.N.fromValues(0,0,1);function jF(n,r){const o=l.N.create();return RA[2]=r,n.intersectsPlane(RA,VF,o),new xe(o[0],o[1])}class OA extends Gs{}function kA(n,{width:r,height:o},u,f){if(f){if(f instanceof Uint8ClampedArray)f=new Uint8Array(f.buffer);else if(f.length!==r*o*u)throw new RangeError("mismatched image size")}else f=new Uint8Array(r*o*u);return n.width=r,n.height=o,n.data=f,n}function DA(n,r,o){const{width:u,height:f}=r;u===n.width&&f===n.height||(_x(n,r,{x:0,y:0},{x:0,y:0},{width:Math.min(n.width,u),height:Math.min(n.height,f)},o),n.width=u,n.height=f,n.data=r.data)}function _x(n,r,o,u,f,m,y){if(f.width===0||f.height===0)return r;if(f.width>n.width||f.height>n.height||o.x>n.width-f.width||o.y>n.height-f.height)throw new RangeError("out of range source coordinates for image copy");if(f.width>r.width||f.height>r.height||u.x>r.width-f.width||u.y>r.height-f.height)throw new RangeError("out of range destination coordinates for image copy");const b=n.data,T=r.data,E=m===4&&y;for(let M=0;M<f.height;M++){const I=((o.y+M)*n.width+o.x)*m,k=((u.y+M)*r.width+u.x)*m;if(E)for(let F=0;F<f.width;F++){const z=I+F*m+3,V=k+F*m;T[V+0]=255,T[V+1]=255,T[V+2]=255,T[V+3]=b[z]}else for(let F=0;F<f.width*m;F++)T[k+F]=b[I+F]}return r}Ht(OA,"HeatmapBucket",{omit:["layers"]});class cc{constructor(r,o){kA(this,r,1,o)}resize(r){DA(this,new cc(r),1)}clone(){return new cc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(r,o,u,f,m){_x(r,o,u,f,m,1)}}class Po{constructor(r,o){kA(this,r,4,o)}resize(r){DA(this,new Po(r),4)}replace(r,o){o?this.data.set(r):this.data=r instanceof Uint8ClampedArray?new Uint8Array(r.buffer):r}clone(){return new Po({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(r,o,u,f,m,y){_x(r,o,u,f,m,4,y)}}class LA{constructor(r,o){this.width=r.width,this.height=r.height,this.data=o instanceof Uint8Array?new Float32Array(o.buffer):o}}Ht(cc,"AlphaImage"),Ht(Po,"RGBAImage");const $F=new fn({visibility:new Pt(Fe.layout_heatmap.visibility)});var WF={paint:new fn({"heatmap-radius":new oi(Fe.paint_heatmap["heatmap-radius"]),"heatmap-weight":new oi(Fe.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Pt(Fe.paint_heatmap["heatmap-intensity"]),"heatmap-color":new vl(Fe.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Pt(Fe.paint_heatmap["heatmap-opacity"])}),layout:$F};function sm(n){const r={},o=n.resolution||256,u=n.clips?n.clips.length:1,f=n.image||new Po({width:o,height:u}),m=(y,b,T)=>{r[n.evaluationKey]=T;const E=n.expression.evaluate(r);E&&(f.data[y+b+0]=Math.floor(255*E.r/E.a),f.data[y+b+1]=Math.floor(255*E.g/E.a),f.data[y+b+2]=Math.floor(255*E.b/E.a),f.data[y+b+3]=Math.floor(255*E.a))};if(n.clips)for(let y=0,b=0;y<u;++y,b+=4*o)for(let T=0,E=0;T<o;T++,E+=4){const M=T/(o-1),{start:I,end:k}=n.clips[y];m(b,E,I*(1-M)+k*M)}else for(let y=0,b=0;y<o;y++,b+=4)m(0,b,y/(o-1));return f}const HF=new fn({visibility:new Pt(Fe.layout_hillshade.visibility)});var qF={paint:new fn({"hillshade-illumination-direction":new Pt(Fe.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Pt(Fe.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Pt(Fe.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Pt(Fe.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Pt(Fe.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Pt(Fe.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new Pt(Fe.paint_hillshade["hillshade-emissive-strength"])}),layout:HF};const GF=Mr([{name:"a_pos",components:2,type:"Int16"}],4),{members:XF}=GF;var gx={exports:{}};function Zg(n,r,o){o=o||2;var u,f,m,y,b,T,E,M=r&&r.length,I=M?r[0]*o:n.length,k=NA(n,0,I,o,!0),F=[];if(!k||k.next===k.prev)return F;if(M&&(k=function(V,W,G,te){var se,ne,ye,de=[];for(se=0,ne=W.length;se<ne;se++)(ye=NA(V,W[se]*te,se<ne-1?W[se+1]*te:V.length,te,!1))===ye.next&&(ye.steiner=!0),de.push(i4(ye));for(de.sort(QF),se=0;se<de.length;se++)G=e4(de[se],G);return G}(n,r,k,o)),n.length>80*o){u=m=n[0],f=y=n[1];for(var z=o;z<I;z+=o)(b=n[z])<u&&(u=b),(T=n[z+1])<f&&(f=T),b>m&&(m=b),T>y&&(y=T);E=(E=Math.max(m-u,y-f))!==0?32767/E:0}return om(k,F,o,u,f,E,0),F}function NA(n,r,o,u,f){var m,y;if(f===xx(n,r,o,u)>0)for(m=r;m<o;m+=u)y=zA(m,n[m],n[m+1],y);else for(m=o-u;m>=r;m-=u)y=zA(m,n[m],n[m+1],y);return y&&Yg(y,y.next)&&(lm(y),y=y.next),y}function Uu(n,r){if(!n)return n;r||(r=n);var o,u=n;do if(o=!1,u.steiner||!Yg(u,u.next)&&Jn(u.prev,u,u.next)!==0)u=u.next;else{if(lm(u),(u=r=u.prev)===u.next)break;o=!0}while(o||u!==r);return r}function om(n,r,o,u,f,m,y){if(n){!y&&m&&function(M,I,k,F){var z=M;do z.z===0&&(z.z=yx(z.x,z.y,I,k,F)),z.prevZ=z.prev,z.nextZ=z.next,z=z.next;while(z!==M);z.prevZ.nextZ=null,z.prevZ=null,function(V){var W,G,te,se,ne,ye,de,Ee,Pe=1;do{for(G=V,V=null,ne=null,ye=0;G;){for(ye++,te=G,de=0,W=0;W<Pe&&(de++,te=te.nextZ);W++);for(Ee=Pe;de>0||Ee>0&&te;)de!==0&&(Ee===0||!te||G.z<=te.z)?(se=G,G=G.nextZ,de--):(se=te,te=te.nextZ,Ee--),ne?ne.nextZ=se:V=se,se.prevZ=ne,ne=se;G=te}ne.nextZ=null,Pe*=2}while(ye>1)}(z)}(n,u,f,m);for(var b,T,E=n;n.prev!==n.next;)if(b=n.prev,T=n.next,m?YF(n,u,f,m):ZF(n))r.push(b.i/o|0),r.push(n.i/o|0),r.push(T.i/o|0),lm(n),n=T.next,E=T.next;else if((n=T)===E){y?y===1?om(n=KF(Uu(n),r,o),r,o,u,f,m,2):y===2&&JF(n,r,o,u,f,m):om(Uu(n),r,o,u,f,m,1);break}}}function ZF(n){var r=n.prev,o=n,u=n.next;if(Jn(r,o,u)>=0)return!1;for(var f=r.x,m=o.x,y=u.x,b=r.y,T=o.y,E=u.y,M=f<m?f<y?f:y:m<y?m:y,I=b<T?b<E?b:E:T<E?T:E,k=f>m?f>y?f:y:m>y?m:y,F=b>T?b>E?b:E:T>E?T:E,z=u.next;z!==r;){if(z.x>=M&&z.x<=k&&z.y>=I&&z.y<=F&&fd(f,b,m,T,y,E,z.x,z.y)&&Jn(z.prev,z,z.next)>=0)return!1;z=z.next}return!0}function YF(n,r,o,u){var f=n.prev,m=n,y=n.next;if(Jn(f,m,y)>=0)return!1;for(var b=f.x,T=m.x,E=y.x,M=f.y,I=m.y,k=y.y,F=b<T?b<E?b:E:T<E?T:E,z=M<I?M<k?M:k:I<k?I:k,V=b>T?b>E?b:E:T>E?T:E,W=M>I?M>k?M:k:I>k?I:k,G=yx(F,z,r,o,u),te=yx(V,W,r,o,u),se=n.prevZ,ne=n.nextZ;se&&se.z>=G&&ne&&ne.z<=te;){if(se.x>=F&&se.x<=V&&se.y>=z&&se.y<=W&&se!==f&&se!==y&&fd(b,M,T,I,E,k,se.x,se.y)&&Jn(se.prev,se,se.next)>=0||(se=se.prevZ,ne.x>=F&&ne.x<=V&&ne.y>=z&&ne.y<=W&&ne!==f&&ne!==y&&fd(b,M,T,I,E,k,ne.x,ne.y)&&Jn(ne.prev,ne,ne.next)>=0))return!1;ne=ne.nextZ}for(;se&&se.z>=G;){if(se.x>=F&&se.x<=V&&se.y>=z&&se.y<=W&&se!==f&&se!==y&&fd(b,M,T,I,E,k,se.x,se.y)&&Jn(se.prev,se,se.next)>=0)return!1;se=se.prevZ}for(;ne&&ne.z<=te;){if(ne.x>=F&&ne.x<=V&&ne.y>=z&&ne.y<=W&&ne!==f&&ne!==y&&fd(b,M,T,I,E,k,ne.x,ne.y)&&Jn(ne.prev,ne,ne.next)>=0)return!1;ne=ne.nextZ}return!0}function KF(n,r,o){var u=n;do{var f=u.prev,m=u.next.next;!Yg(f,m)&&FA(f,u,u.next,m)&&am(f,m)&&am(m,f)&&(r.push(f.i/o|0),r.push(u.i/o|0),r.push(m.i/o|0),lm(u),lm(u.next),u=n=m),u=u.next}while(u!==n);return Uu(u)}function JF(n,r,o,u,f,m){var y=n;do{for(var b=y.next.next;b!==y.prev;){if(y.i!==b.i&&r4(y,b)){var T=BA(y,b);return y=Uu(y,y.next),T=Uu(T,T.next),om(y,r,o,u,f,m,0),void om(T,r,o,u,f,m,0)}b=b.next}y=y.next}while(y!==n)}function QF(n,r){return n.x-r.x}function e4(n,r){var o=function(f,m){var y,b=m,T=f.x,E=f.y,M=-1/0;do{if(E<=b.y&&E>=b.next.y&&b.next.y!==b.y){var I=b.x+(E-b.y)*(b.next.x-b.x)/(b.next.y-b.y);if(I<=T&&I>M&&(M=I,y=b.x<b.next.x?b:b.next,I===T))return y}b=b.next}while(b!==m);if(!y)return null;var k,F=y,z=y.x,V=y.y,W=1/0;b=y;do T>=b.x&&b.x>=z&&T!==b.x&&fd(E<V?T:M,E,z,V,E<V?M:T,E,b.x,b.y)&&(k=Math.abs(E-b.y)/(T-b.x),am(b,f)&&(k<W||k===W&&(b.x>y.x||b.x===y.x&&t4(y,b)))&&(y=b,W=k)),b=b.next;while(b!==F);return y}(n,r);if(!o)return r;var u=BA(o,n);return Uu(u,u.next),Uu(o,o.next)}function t4(n,r){return Jn(n.prev,n,r.prev)<0&&Jn(r.next,n,n.next)<0}function yx(n,r,o,u,f){return(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-o)*f|0)|n<<8))|n<<4))|n<<2))|n<<1))|(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=(r-u)*f|0)|r<<8))|r<<4))|r<<2))|r<<1))<<1}function i4(n){var r=n,o=n;do(r.x<o.x||r.x===o.x&&r.y<o.y)&&(o=r),r=r.next;while(r!==n);return o}function fd(n,r,o,u,f,m,y,b){return(f-y)*(r-b)>=(n-y)*(m-b)&&(n-y)*(u-b)>=(o-y)*(r-b)&&(o-y)*(m-b)>=(f-y)*(u-b)}function r4(n,r){return n.next.i!==r.i&&n.prev.i!==r.i&&!function(o,u){var f=o;do{if(f.i!==o.i&&f.next.i!==o.i&&f.i!==u.i&&f.next.i!==u.i&&FA(f,f.next,o,u))return!0;f=f.next}while(f!==o);return!1}(n,r)&&(am(n,r)&&am(r,n)&&function(o,u){var f=o,m=!1,y=(o.x+u.x)/2,b=(o.y+u.y)/2;do f.y>b!=f.next.y>b&&f.next.y!==f.y&&y<(f.next.x-f.x)*(b-f.y)/(f.next.y-f.y)+f.x&&(m=!m),f=f.next;while(f!==o);return m}(n,r)&&(Jn(n.prev,n,r.prev)||Jn(n,r.prev,r))||Yg(n,r)&&Jn(n.prev,n,n.next)>0&&Jn(r.prev,r,r.next)>0)}function Jn(n,r,o){return(r.y-n.y)*(o.x-r.x)-(r.x-n.x)*(o.y-r.y)}function Yg(n,r){return n.x===r.x&&n.y===r.y}function FA(n,r,o,u){var f=Jg(Jn(n,r,o)),m=Jg(Jn(n,r,u)),y=Jg(Jn(o,u,n)),b=Jg(Jn(o,u,r));return f!==m&&y!==b||!(f!==0||!Kg(n,o,r))||!(m!==0||!Kg(n,u,r))||!(y!==0||!Kg(o,n,u))||!(b!==0||!Kg(o,r,u))}function Kg(n,r,o){return r.x<=Math.max(n.x,o.x)&&r.x>=Math.min(n.x,o.x)&&r.y<=Math.max(n.y,o.y)&&r.y>=Math.min(n.y,o.y)}function Jg(n){return n>0?1:n<0?-1:0}function am(n,r){return Jn(n.prev,n,n.next)<0?Jn(n,r,n.next)>=0&&Jn(n,n.prev,r)>=0:Jn(n,r,n.prev)<0||Jn(n,n.next,r)<0}function BA(n,r){var o=new vx(n.i,n.x,n.y),u=new vx(r.i,r.x,r.y),f=n.next,m=r.prev;return n.next=r,r.prev=n,o.next=f,f.prev=o,u.next=o,o.prev=u,m.next=u,u.prev=m,u}function zA(n,r,o,u){var f=new vx(n,r,o);return u?(f.next=u.next,f.prev=u,u.next.prev=f,u.next=f):(f.prev=f,f.next=f),f}function lm(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function vx(n,r,o){this.i=n,this.x=r,this.y=o,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function xx(n,r,o,u){for(var f=0,m=r,y=o-u;m<o;m+=u)f+=(n[y]-n[m])*(n[m+1]+n[y+1]),y=m;return f}gx.exports=Zg,gx.exports.default=Zg,Zg.deviation=function(n,r,o,u){var f=r&&r.length,m=Math.abs(xx(n,0,f?r[0]*o:n.length,o));if(f)for(var y=0,b=r.length;y<b;y++)m-=Math.abs(xx(n,r[y]*o,y<b-1?r[y+1]*o:n.length,o));var T=0;for(y=0;y<u.length;y+=3){var E=u[y]*o,M=u[y+1]*o,I=u[y+2]*o;T+=Math.abs((n[E]-n[I])*(n[M+1]-n[E+1])-(n[E]-n[M])*(n[I+1]-n[E+1]))}return m===0&&T===0?0:Math.abs((T-m)/m)},Zg.flatten=function(n){for(var r=n[0][0].length,o={vertices:[],holes:[],dimensions:r},u=0,f=0;f<n.length;f++){for(var m=0;m<n[f].length;m++)for(var y=0;y<r;y++)o.vertices.push(n[f][m][y]);f>0&&o.holes.push(u+=n[f-1].length)}return o};var Qg=pe(gx.exports);function bx(n,r){const o=n.length;if(o<=1)return[n];const u=[];let f,m;for(let y=0;y<o;y++){const b=Dr(n[y]);b!==0&&(n[y].area=Math.abs(b),m===void 0&&(m=b<0),m===b<0?(f&&u.push(f),f=[n[y]]):f.push(n[y]))}if(f&&u.push(f),r>1)for(let y=0;y<u.length;y++)u[y].length<=r||(T1(u[y],r,1,u[y].length-1,n4),u[y]=u[y].slice(0,r));return u}function n4(n,r){return r.area-n.area}function wx(n,r,o){const u=o.patternDependencies;let f=!1;for(const m of r){const y=m.paint.get(`${n}-pattern`);y.isConstant()||(f=!0);const b=y.constantOr(null);b&&(f=!0,u[b]=!0)}return f}function Tx(n,r,o,u,f){const m=f.patternDependencies;for(const y of r){const b=y.paint.get(`${n}-pattern`).value;if(b.kind!=="constant"){let T=b.evaluate({zoom:u},o,{},f.availableImages);T=T&&T.name?T.name:T,m[T]=!0,o.patterns[y.id]=T}}return o}class Ex{constructor(r){this.zoom=r.zoom,this.overscaling=r.overscaling,this.layers=r.layers,this.layerIds=this.layers.map(o=>o.fqid),this.index=r.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Ao,this.indexArray=new os,this.indexArray2=new zo,this.programConfigurations=new Z(r.layers,r.zoom),this.segments=new wn,this.segments2=new wn,this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.projection=r.projection}populate(r,o,u,f){this.hasPattern=wx("fill",this.layers,o);const m=this.layers[0].layout.get("fill-sort-key"),y=[];for(const{feature:b,id:T,index:E,sourceLayerIndex:M}of r){const I=this.layers[0]._featureFilter.needGeometry,k=Xn(b,I);if(!this.layers[0]._featureFilter.filter(new dn(this.zoom),k,u))continue;const F=m?m.evaluate(k,{},u,o.availableImages):void 0,z={id:T,properties:b.properties,type:b.type,sourceLayerIndex:M,index:E,geometry:I?k.geometry:ls(b,u,f),patterns:{},sortKey:F};y.push(z)}m&&y.sort((b,T)=>b.sortKey-T.sortKey);for(const b of y){const{geometry:T,index:E,sourceLayerIndex:M}=b;if(this.hasPattern){const I=Tx("fill",this.layers,b,this.zoom,o);this.patternFeatures.push(I)}else this.addFeature(b,T,E,u,{},o.availableImages,o.brightness);o.featureIndex.insert(r[E].feature,T,E,M,this.index)}}update(r,o,u,f,m){const y=Object.keys(r).length!==0;y&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(r,o,y?this.stateDependentLayers:this.layers,u,f,m)}addFeatures(r,o,u,f,m,y){for(const b of this.patternFeatures)this.addFeature(b,b.geometry,b.index,o,u,f,y)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(r){this.uploaded||(this.layoutVertexBuffer=r.createVertexBuffer(this.layoutVertexArray,XF),this.indexBuffer=r.createIndexBuffer(this.indexArray),this.indexBuffer2=r.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(r),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(r,o,u,f,m,y=[],b){for(const T of bx(o,500)){let E=0;for(const V of T)E+=V.length;const M=this.segments.prepareSegment(E,this.layoutVertexArray,this.indexArray),I=M.vertexLength,k=[],F=[];for(const V of T){if(V.length===0)continue;V!==T[0]&&F.push(k.length/2);const W=this.segments2.prepareSegment(V.length,this.layoutVertexArray,this.indexArray2),G=W.vertexLength;this.layoutVertexArray.emplaceBack(V[0].x,V[0].y),this.indexArray2.emplaceBack(G+V.length-1,G),k.push(V[0].x),k.push(V[0].y);for(let te=1;te<V.length;te++)this.layoutVertexArray.emplaceBack(V[te].x,V[te].y),this.indexArray2.emplaceBack(G+te-1,G+te),k.push(V[te].x),k.push(V[te].y);W.vertexLength+=V.length,W.primitiveLength+=V.length}const z=Qg(k,F);for(let V=0;V<z.length;V+=3)this.indexArray.emplaceBack(I+z[V],I+z[V+1],I+z[V+2]);M.vertexLength+=E,M.primitiveLength+=z.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,r,u,m,y,f,b)}}Ht(Ex,"FillBucket",{omit:["layers","patternFeatures"]});const s4=new fn({"fill-sort-key":new oi(Fe.layout_fill["fill-sort-key"]),visibility:new Pt(Fe.layout_fill.visibility)});var o4={paint:new fn({"fill-antialias":new Pt(Fe.paint_fill["fill-antialias"]),"fill-opacity":new oi(Fe.paint_fill["fill-opacity"]),"fill-color":new oi(Fe.paint_fill["fill-color"]),"fill-outline-color":new oi(Fe.paint_fill["fill-outline-color"]),"fill-translate":new Pt(Fe.paint_fill["fill-translate"]),"fill-translate-anchor":new Pt(Fe.paint_fill["fill-translate-anchor"]),"fill-pattern":new oi(Fe.paint_fill["fill-pattern"]),"fill-emissive-strength":new Pt(Fe.paint_fill["fill-emissive-strength"])}),layout:s4};const a4=Mr([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),l4=Mr([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),c4=Mr([{name:"a_centroid_pos",components:2,type:"Uint16"}]),u4=Mr([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),h4=Mr([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:d4}=a4;var ey={},f4=st,UA=pd;function pd(n,r,o,u,f){this.properties={},this.extent=o,this.type=0,this._pbf=n,this._geometry=-1,this._keys=u,this._values=f,n.readFields(p4,this,r)}function p4(n,r,o){n==1?r.id=o.readVarint():n==2?function(u,f){for(var m=u.readVarint()+u.pos;u.pos<m;){var y=f._keys[u.readVarint()],b=f._values[u.readVarint()];f.properties[y]=b}}(o,r):n==3?r.type=o.readVarint():n==4&&(r._geometry=o.pos)}function m4(n){for(var r,o,u=0,f=0,m=n.length,y=m-1;f<m;y=f++)u+=((o=n[y]).x-(r=n[f]).x)*(r.y+o.y);return u}pd.types=["Unknown","Point","LineString","Polygon"],pd.prototype.loadGeometry=function(){var n=this._pbf;n.pos=this._geometry;for(var r,o=n.readVarint()+n.pos,u=1,f=0,m=0,y=0,b=[];n.pos<o;){if(f<=0){var T=n.readVarint();u=7&T,f=T>>3}if(f--,u===1||u===2)m+=n.readSVarint(),y+=n.readSVarint(),u===1&&(r&&b.push(r),r=[]),r.push(new f4(m,y));else{if(u!==7)throw new Error("unknown command "+u);r&&r.push(r[0].clone())}}return r&&b.push(r),b},pd.prototype.bbox=function(){var n=this._pbf;n.pos=this._geometry;for(var r=n.readVarint()+n.pos,o=1,u=0,f=0,m=0,y=1/0,b=-1/0,T=1/0,E=-1/0;n.pos<r;){if(u<=0){var M=n.readVarint();o=7&M,u=M>>3}if(u--,o===1||o===2)(f+=n.readSVarint())<y&&(y=f),f>b&&(b=f),(m+=n.readSVarint())<T&&(T=m),m>E&&(E=m);else if(o!==7)throw new Error("unknown command "+o)}return[y,T,b,E]},pd.prototype.toGeoJSON=function(n,r,o){var u,f,m=this.extent*Math.pow(2,o),y=this.extent*n,b=this.extent*r,T=this.loadGeometry(),E=pd.types[this.type];function M(F){for(var z=0;z<F.length;z++){var V=F[z];F[z]=[360*(V.x+y)/m-180,360/Math.PI*Math.atan(Math.exp((180-360*(V.y+b)/m)*Math.PI/180))-90]}}switch(this.type){case 1:var I=[];for(u=0;u<T.length;u++)I[u]=T[u][0];M(T=I);break;case 2:for(u=0;u<T.length;u++)M(T[u]);break;case 3:for(T=function(F){var z=F.length;if(z<=1)return[F];for(var V,W,G=[],te=0;te<z;te++){var se=m4(F[te]);se!==0&&(W===void 0&&(W=se<0),W===se<0?(V&&G.push(V),V=[F[te]]):V.push(F[te]))}return V&&G.push(V),G}(T),u=0;u<T.length;u++)for(f=0;f<T[u].length;f++)M(T[u][f])}T.length===1?T=T[0]:E="Multi"+E;var k={type:"Feature",geometry:{type:E,coordinates:T},properties:this.properties};return"id"in this&&(k.id=this.id),k};var _4=UA,VA=jA;function jA(n,r){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=n,this._keys=[],this._values=[],this._features=[],n.readFields(g4,this,r),this.length=this._features.length}function g4(n,r,o){n===15?r.version=o.readVarint():n===1?r.name=o.readString():n===5?r.extent=o.readVarint():n===2?r._features.push(o.pos):n===3?r._keys.push(o.readString()):n===4&&r._values.push(function(u){for(var f=null,m=u.readVarint()+u.pos;u.pos<m;){var y=u.readVarint()>>3;f=y===1?u.readString():y===2?u.readFloat():y===3?u.readDouble():y===4?u.readVarint64():y===5?u.readVarint():y===6?u.readSVarint():y===7?u.readBoolean():null}return f}(o))}jA.prototype.feature=function(n){if(n<0||n>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[n];var r=this._pbf.readVarint()+this._pbf.pos;return new _4(this._pbf,r,this.extent,this._keys,this._values)};var y4=VA;function v4(n,r,o){if(n===3){var u=new y4(o,o.readVarint()+o.pos);u.length&&(r[u.name]=u)}}var Sx=ey.VectorTile=function(n,r){this.layers=n.readFields(v4,{},r)},ty=ey.VectorTileFeature=UA;function iy(n,r,o,u){const f=[],m=u===0?(y,b,T,E,M,I)=>{y.push(new xe(I,T+(I-b)/(E-b)*(M-T)))}:(y,b,T,E,M,I)=>{y.push(new xe(b+(I-T)/(M-T)*(E-b),I))};for(const y of n){const b=[];for(const T of y){if(T.length<=2)continue;const E=[];for(let k=0;k<T.length-1;k++){const F=T[k].x,z=T[k].y,V=T[k+1].x,W=T[k+1].y,G=u===0?F:z,te=u===0?V:W;G<r?te>r&&m(E,F,z,V,W,r):G>o?te<o&&m(E,F,z,V,W,o):E.push(T[k]),te<r&&G>=r&&m(E,F,z,V,W,r),te>o&&G<=o&&m(E,F,z,V,W,o)}let M=T[T.length-1];const I=u===0?M.x:M.y;I>=r&&I<=o&&E.push(M),E.length&&(M=E[E.length-1],E[0].x===M.x&&E[0].y===M.y||E.push(E[0]),b.push(E))}b.length&&f.push(b)}return f}function ry(n,r){return n.x-r.x||n.y-r.y}function $A(n,r){return ry(n.min,r.min)===0&&ry(n.max,r.max)===0}function WA(n,r){return!(n.min.x>r.max.x||n.max.x<r.min.x||n.min.y>r.max.y||n.max.y<r.min.y)}function HA(n,r,o){const u=1/Bt,f=1/(1<<o.canonical.z),m=(r.x*u+o.canonical.x)*f+o.wrap,y=(r.y*u+o.canonical.y)*f;return{min:new xe((n.x*u+o.canonical.x)*f+o.wrap,(n.y*u+o.canonical.y)*f),max:new xe(m,y)}}function x4(n,r,o){const u=1<<o.canonical.z,f=((r.x-o.wrap)*u-o.canonical.x)*Bt,m=(r.y*u-o.canonical.y)*Bt;return{min:new xe(((n.x-o.wrap)*u-o.canonical.x)*Bt,(n.y*u-o.canonical.y)*Bt),max:new xe(f,m)}}function qA(n,r,o,u,f,m,y){const b=n.indices,T=n.vertices,E=[];for(let M=u;M<u+f;M+=3){const I=r[o[M+0]+m],k=r[o[M+1]+m],F=r[o[M+2]+m],z=Math.min(I.x,k.x,F.x),V=Math.max(I.x,k.x,F.x),W=Math.min(I.y,k.y,F.y),G=Math.max(I.y,k.y,F.y);E.length=0,n.grid.query(new xe(z,W),new xe(V,G),E);for(let te=0;te<E.length;te++){const se=E[te];if(q1(T[b[3*se+0]],T[b[3*se+1]],T[b[3*se+2]],I,k,F,y))return!0}}return!1}function GA(n,r,o,u){if(!n||!o)return!1;let f=n.vertices;if(!r.canonical.equals(u.canonical)||r.wrap!==u.wrap){if(o.vertices.length<n.vertices.length)return GA(o,u,n,r);const m=r.canonical,y=u.canonical,b=Math.pow(2,y.z-m.z);f=n.vertices.map(T=>new xe(T.x*m.x*Bt*b-y.x*Bt,T.y*m.y*Bt*b-y.y*Bt))}return qA(o,f,n.indices,0,n.indices.length,0,0)}ey.VectorTileLayer=VA;class XA{constructor(r){this.size=r,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(r,o){const u=this.toIdx(r,o);return{min:this.minimums[u],max:this.maximums[u]}}isLeaf(r,o){return this.leaves[this.toIdx(r,o)]}toIdx(r,o){return o*this.size+r}}function ZA(n,r,o,u){let f=0,m=Number.MAX_VALUE;for(let y=0;y<3;y++)if(Math.abs(u[y])<1e-15){if(o[y]<n[y]||o[y]>r[y])return null}else{const b=1/u[y];let T=(n[y]-o[y])*b,E=(r[y]-o[y])*b;if(T>E){const M=T;T=E,E=M}if(T>f&&(f=T),E<m&&(m=E),f>m)return null}return f}function YA(n,r,o,u,f,m,y,b,T,E,M){const I=u-n,k=f-r,F=m-o,z=y-n,V=b-r,W=T-o,G=M[1]*W-M[2]*V,te=M[2]*z-M[0]*W,se=M[0]*V-M[1]*z,ne=I*G+k*te+F*se;if(Math.abs(ne)<1e-15)return null;const ye=1/ne,de=E[0]-n,Ee=E[1]-r,Pe=E[2]-o,De=(de*G+Ee*te+Pe*se)*ye;if(De<0||De>1)return null;const Ve=Ee*F-Pe*k,Le=Pe*I-de*F,rt=de*k-Ee*I,ht=(M[0]*Ve+M[1]*Le+M[2]*rt)*ye;return ht<0||De+ht>1?null:(z*Ve+V*Le+W*rt)*ye}function KA(n,r,o){return(n-r)/(o-r)}function JA(n,r,o,u,f,m,y,b,T){const E=1<<o,M=m-u,I=y-f,k=(n+1)/E*M+u,F=(r+0)/E*I+f,z=(r+1)/E*I+f;b[0]=(n+0)/E*M+u,b[1]=F,T[0]=k,T[1]=z}class QA{constructor(r){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=r,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const o=function(m){const y=Math.ceil(Math.log2(m.dim/8)),b=[];let T=Math.ceil(Math.pow(2,y));const E=1/T,M=(F,z,V,W,G)=>{const te=W?1:0,se=(F+1)*V-te,ne=z*V,ye=(z+1)*V-te;G[0]=F*V,G[1]=ne,G[2]=se,G[3]=ye};let I=new XA(T);const k=[];for(let F=0;F<T*T;F++){M(F%T,Math.floor(F/T),E,!1,k);const z=uc(k[0],k[1],m),V=uc(k[2],k[1],m),W=uc(k[2],k[3],m),G=uc(k[0],k[3],m);I.minimums.push(Math.min(z,V,W,G)),I.maximums.push(Math.max(z,V,W,G)),I.leaves.push(1)}for(b.push(I),T/=2;T>=1;T/=2){const F=b[b.length-1];I=new XA(T);for(let z=0;z<T*T;z++){M(z%T,Math.floor(z/T),2,!0,k);const V=F.getElevation(k[0],k[1]),W=F.getElevation(k[2],k[1]),G=F.getElevation(k[2],k[3]),te=F.getElevation(k[0],k[3]),se=F.isLeaf(k[0],k[1]),ne=F.isLeaf(k[2],k[1]),ye=F.isLeaf(k[2],k[3]),de=F.isLeaf(k[0],k[3]),Ee=Math.min(V.min,W.min,G.min,te.min),Pe=Math.max(V.max,W.max,G.max,te.max),De=se&&ne&&ye&&de;I.maximums.push(Pe),I.minimums.push(Ee),I.leaves.push(Pe-Ee<=5&&De?1:0)}b.push(I)}return b}(this.dem),u=o.length-1,f=o[u];this._addNode(f.minimums[0],f.maximums[0],f.leaves[0]),this._construct(o,0,0,u,0)}raycastRoot(r,o,u,f,m,y,b=1){return ZA([r,o,-100],[u,f,this.maximums[0]*b],m,y)}raycast(r,o,u,f,m,y,b=1){if(!this.nodeCount)return null;const T=this.raycastRoot(r,o,u,f,m,y,b);if(T==null)return null;const E=[],M=[],I=[],k=[],F=[{idx:0,t:T,nodex:0,nodey:0,depth:0}];for(;F.length>0;){const{idx:z,t:V,nodex:W,nodey:G,depth:te}=F.pop();if(this.leaves[z]){JA(W,G,te,r,o,u,f,I,k);const ne=1<<te,ye=(W+0)/ne,de=(W+1)/ne,Ee=(G+0)/ne,Pe=(G+1)/ne,De=uc(ye,Ee,this.dem)*b,Ve=uc(de,Ee,this.dem)*b,Le=uc(de,Pe,this.dem)*b,rt=uc(ye,Pe,this.dem)*b,ht=YA(I[0],I[1],De,k[0],I[1],Ve,k[0],k[1],Le,m,y),Ze=YA(k[0],k[1],Le,I[0],k[1],rt,I[0],I[1],De,m,y),ct=Math.min(ht!==null?ht:Number.MAX_VALUE,Ze!==null?Ze:Number.MAX_VALUE);if(ct!==Number.MAX_VALUE)return ct;{const qe=l.N.scaleAndAdd([],m,y,V);if(eM(De,Ve,rt,Le,KA(qe[0],I[0],k[0]),KA(qe[1],I[1],k[1]))>=qe[2])return V}continue}let se=0;for(let ne=0;ne<this._siblingOffset.length;ne++){JA((W<<1)+this._siblingOffset[ne][0],(G<<1)+this._siblingOffset[ne][1],te+1,r,o,u,f,I,k),I[2]=-100,k[2]=this.maximums[this.childOffsets[z]+ne]*b;const ye=ZA(I,k,m,y);if(ye!=null){const de=ye;E[ne]=de;let Ee=!1;for(let Pe=0;Pe<se&&!Ee;Pe++)de>=E[M[Pe]]&&(M.splice(Pe,0,ne),Ee=!0);Ee||(M[se]=ne),se++}}for(let ne=0;ne<se;ne++){const ye=M[ne];F.push({idx:this.childOffsets[z]+ye,t:E[ye],nodex:(W<<1)+this._siblingOffset[ye][0],nodey:(G<<1)+this._siblingOffset[ye][1],depth:te+1})}}return null}_addNode(r,o,u){return this.minimums.push(r),this.maximums.push(o),this.leaves.push(u),this.childOffsets.push(0),this.nodeCount++}_construct(r,o,u,f,m){if(r[f].isLeaf(o,u)===1)return;this.childOffsets[m]||(this.childOffsets[m]=this.nodeCount);const y=f-1,b=r[y];let T=0,E=0;for(let M=0;M<this._siblingOffset.length;M++){const I=2*o+this._siblingOffset[M][0],k=2*u+this._siblingOffset[M][1],F=b.getElevation(I,k),z=b.isLeaf(I,k),V=this._addNode(F.min,F.max,z);z&&(T|=1<<M),E||(E=V)}for(let M=0;M<this._siblingOffset.length;M++)T&1<<M||this._construct(r,2*o+this._siblingOffset[M][0],2*u+this._siblingOffset[M][1],y,E+M)}}function eM(n,r,o,u,f,m){return Ut(Ut(n,o,m),Ut(r,u,m),f)}function uc(n,r,o){const u=o.dim,f=ri(n*u-.5,0,u-1),m=ri(r*u-.5,0,u-1),y=Math.floor(f),b=Math.floor(m),T=Math.min(y+1,u-1),E=Math.min(b+1,u-1);return eM(o.get(y,b),o.get(T,b),o.get(y,E),o.get(T,E),f-y,m-b)}const b4={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function w4(n,r,o){return(256*n*256+256*r+o)/10-1e4}function T4(n,r,o){return 256*n+r+o/256-32768}class ny{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(r,o,u,f=!1){if(this.uid=r,o.height!==o.width)throw new RangeError("DEM tiles must be square");if(u&&u!=="mapbox"&&u!=="terrarium")return mr(`"${u}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=o.height;const m=this.dim=o.height-2,y=new Uint32Array(o.data.buffer);if(this.pixels=new Uint8Array(o.data.buffer),this.floatView=new Float32Array(o.data.buffer),this.borderReady=f,this._modifiedForSources={},!f){for(let T=0;T<m;T++)y[this._idx(-1,T)]=y[this._idx(0,T)],y[this._idx(m,T)]=y[this._idx(m-1,T)],y[this._idx(T,-1)]=y[this._idx(T,0)],y[this._idx(T,m)]=y[this._idx(T,m-1)];y[this._idx(-1,-1)]=y[this._idx(0,0)],y[this._idx(m,-1)]=y[this._idx(m-1,0)],y[this._idx(-1,m)]=y[this._idx(0,m-1)],y[this._idx(m,m)]=y[this._idx(m-1,m-1)]}const b=u==="terrarium"?T4:w4;for(let T=0;T<y.length;++T){const E=4*T;this.floatView[T]=b(this.pixels[E],this.pixels[E+1],this.pixels[E+2])}this._timestamp=lt.now()}_buildQuadTree(){this._tree=new QA(this)}get(r,o,u=!1){u&&(r=ri(r,-1,this.dim),o=ri(o,-1,this.dim));const f=this._idx(r,o);return this.floatView[f]}set(r,o,u){const f=this._idx(r,o),m=this.floatView[f];return this.floatView[f]=u,u-m}static getUnpackVector(r){return b4[r]}_idx(r,o){if(r<-1||r>=this.dim+1||o<-1||o>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(o+1)*this.stride+(r+1)}static pack(r,o){const u=[0,0,0,0],f=ny.getUnpackVector(o);let m=Math.floor((r+f[3])/f[2]);return u[2]=m%256,m=Math.floor(m/256),u[1]=m%256,m=Math.floor(m/256),u[0]=m,u}getPixels(){return new LA({width:this.stride,height:this.stride},this.pixels)}backfillBorder(r,o,u){if(this.dim!==r.dim)throw new Error("dem dimension mismatch");let f=o*this.dim,m=o*this.dim+this.dim,y=u*this.dim,b=u*this.dim+this.dim;switch(o){case-1:f=m-1;break;case 1:m=f+1}switch(u){case-1:y=b-1;break;case 1:b=y+1}const T=-o*this.dim,E=-u*this.dim;for(let M=y;M<b;M++)for(let I=f;I<m;I++){const k=4*this._idx(I,M),F=4*this._idx(I+T,M+E);this.pixels[k+0]=r.pixels[F+0],this.pixels[k+1]=r.pixels[F+1],this.pixels[k+2]=r.pixels[F+2],this.pixels[k+3]=r.pixels[F+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}Ht(ny,"DEMData"),Ht(QA,"DemMinMaxQuadTree",{omit:["dem"]});class md{constructor(r,o,u){this._demTile=r,this._dem=this._demTile.dem,this._scale=o,this._offset=u}static create(r,o,u){const f=u||r.findDEMTileFor(o);if(!f||!f.dem)return;const m=f.dem,y=f.tileID,b=1<<o.canonical.z-y.canonical.z;return new md(f,m.dim/Bt/b,[(o.canonical.x/b-y.canonical.x)*m.dim,(o.canonical.y/b-y.canonical.y)*m.dim])}tileCoordToPixel(r,o){const u=o*this._scale+this._offset[1],f=Math.floor(r*this._scale+this._offset[0]),m=Math.floor(u);return new xe(f,m)}getElevationAt(r,o,u,f){const m=r*this._scale+this._offset[0],y=o*this._scale+this._offset[1],b=Math.floor(m),T=Math.floor(y),E=this._dem;return f=!!f,u?Ut(Ut(E.get(b,T,f),E.get(b,T+1,f),y-T),Ut(E.get(b+1,T,f),E.get(b+1,T+1,f),y-T),m-b):E.get(b,T,f)}getElevationAtPixel(r,o,u){return this._dem.get(r,o,!!u)}getMeterToDEM(r){return(1<<this._demTile.tileID.canonical.z)*Ti(1,r)*this._dem.stride}}const E4=ty.types,S4=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius"],A4=["fill-extrusion-flood-light-ground-radius"],M4=Math.pow(2,13),C4=Math.pow(2,15)-1,tM=new xe(0,1),hc=2147483648;function cm(n,r,o,u,f,m,y,b){n.emplaceBack((r<<1)+y,(o<<1)+m,(Math.floor(u*M4)<<1)+f,Math.round(b))}function sy(n,r,o,u,f,m){n.emplaceBack(r.x,r.y,(o.x<<1)+u,(o.y<<1)+f,m)}function um(n,r,o){n.emplaceBack(r.x,r.y,r.z,o[0]*16384,o[1]*16384,o[2]*16384)}class iM{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class rM{constructor(){this.centroidXY=new xe(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new xe(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new xe(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new xe(this.max.x-this.min.x,this.max.y-this.min.y)}}class nM{constructor(){this.acc=new xe(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(r,o){r.min.x===Number.MAX_VALUE&&(r.min.x=r.max.x=o.x,r.min.y=r.max.y=o.y)}appendEdge(r,o,u){this.accCount++,this.acc._add(o);let f=!!this.borders;o.x<r.min.x?(r.min.x=o.x,f=!0):o.x>r.max.x&&(r.max.x=o.x,f=!0),o.y<r.min.y?(r.min.y=o.y,f=!0):o.y>r.max.y&&(r.max.y=o.y,f=!0),((o.x===0||o.x===Bt)&&o.x===u.x)!=((o.y===0||o.y===Bt)&&o.y===u.y)&&this.processBorderOverlap(o,u),f&&this.checkBorderIntersection(o,u)}checkBorderIntersection(r,o){o.x<0!=r.x<0&&this.addBorderIntersection(0,Ut(o.y,r.y,(0-o.x)/(r.x-o.x))),o.x>Bt!=r.x>Bt&&this.addBorderIntersection(1,Ut(o.y,r.y,(Bt-o.x)/(r.x-o.x))),o.y<0!=r.y<0&&this.addBorderIntersection(2,Ut(o.x,r.x,(0-o.y)/(r.y-o.y))),o.y>Bt!=r.y>Bt&&this.addBorderIntersection(3,Ut(o.x,r.x,(Bt-o.y)/(r.y-o.y)))}addBorderIntersection(r,o){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const u=this.borders[r];o<u[0]&&(u[0]=o),o>u[1]&&(u[1]=o)}processBorderOverlap(r,o){if(r.x===o.x){if(r.y===o.y)return;const u=r.x===0?0:1;this.addBorderIntersection(u,o.y),this.addBorderIntersection(u,r.y)}else{const u=r.y===0?2:3;this.addBorderIntersection(u,o.x),this.addBorderIntersection(u,r.x)}}centroid(){return this.accCount===0?new xe(0,0):new xe(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((r,o)=>r+ +(o[0]!==Number.MAX_VALUE),0):0}}function sM(n,r){const o=n.add(r)._unit(),u=ri(n.x*o.x+n.y*o.y,-1,1);var f,m,y;return f=Math.acos(u),Math.min(4,Math.max(-4,Math.tan(f)))/4*C4*((m=n).x*(y=r).y-m.y*y.x<0?-1:1)}const P4=[n=>n.x<0,n=>n.x>Bt,n=>n.y<0,n=>n.y>Bt];function I4(n,r,o,u){const f=[4];if(u===0)return f;o._mult(u);const m=n.sub(o),y=r.sub(o),b=[n,r,m,y];for(let T=0;T<4;T++)for(const E of b)if(P4[T](E)){f.push(T);break}return f}class oM{constructor(r){this.vertexArray=new jp,this.indexArray=new os,this.programConfigurations=new Z(r.layers,r.zoom,o=>A4.includes(o)),this._segments=new wn,this.hiddenByLandmarkVertexArray=new Kp,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new wn}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(r,o,u,f=!1){const m=r.length;if(m>2){let y=Math.max(0,this._segments.get().length-1);const b=this._segments._prepareSegment(4*m,this.vertexArray.length,2*this._segmentToGroundQuads[y].length);let T;y!==this._segments.get().length-1&&(y++,this._segmentToGroundQuads[y]=[],this._segmentToRegionTriCounts[y]=[0,0,0,0,0]);{const E=r[0],M=r[1];T=sM(E.sub(r[m-1])._perp()._unit(),M.sub(E)._perp()._unit())}for(let E=0;E<m;E++){const M=E===m-1?0:E+1,I=r[E],k=r[M],F=r[M===m-1?0:M+1],z=k.sub(I)._perp()._unit(),V=sM(z,F.sub(k)._perp()._unit()),W=T,G=V;if(Ax(I,k,o)||f&&cM(I,o)&&cM(k,o)){T=V;continue}const te=b.vertexLength;sy(this.vertexArray,I,k,1,1,W),sy(this.vertexArray,I,k,1,0,W),sy(this.vertexArray,I,k,0,1,G),sy(this.vertexArray,I,k,0,0,G),b.vertexLength+=4;const se=I4(I,k,z,u);for(const ne of se)this._segmentToGroundQuads[y].push({id:te,region:ne}),this._segmentToRegionTriCounts[y][ne]+=2,b.primitiveLength+=2;T=V}}}prepareBorderSegments(){if(!this.hasData())return;const r=this._segments.get(),o=r.length;for(let u=0;u<o;u++)this._segmentToGroundQuads[u].sort((f,m)=>f.region-m.region);for(let u=0;u<o;u++){const f=this._segmentToGroundQuads[u],m=r[u],y=this._segmentToRegionTriCounts[u];y.reduce((T,E)=>T+E,0);let b=0;for(let T=0;T<=4;T++){const E=y[T];if(E!==0){let M=this.regionSegments[T];M||(M=this.regionSegments[T]=new wn);const I={vertexOffset:m.vertexOffset,primitiveOffset:m.primitiveOffset+b,vertexLength:m.vertexLength,primitiveLength:E};M.get().push(I)}b+=E}for(let T=0;T<f.length;T++){const E=f[T].id;this.indexArray.emplaceBack(E,E+1,E+3),this.indexArray.emplaceBack(E,E+3,E+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(r,o,u,f,m,y){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,r,o,u,f,m,y)}upload(r){this.hasData()&&(this.vertexBuffer=r.createVertexBuffer(this.vertexArray,l4.members),this.indexBuffer=r.createIndexBuffer(this.indexArray))}uploadPaintProperties(r){this.hasData()&&this.programConfigurations.upload(r)}update(r,o,u,f,m,y){this.hasData()&&this.programConfigurations.updatePaintArrays(r,o,u,f,m,y)}updateHiddenByLandmark(r){if(!this.hasData())return;const o=r.groundVertexCount+r.groundVertexArrayOffset;if(r.groundVertexCount===0)return;const u=r.flags&hc?1:0;for(let f=r.groundVertexArrayOffset;f<o;++f)this.hiddenByLandmarkVertexArray.emplace(f,u);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(r){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=r.createVertexBuffer(this.hiddenByLandmarkVertexArray,u4.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let r=0;r<=4;r++){const o=this.regionSegments[r];o&&o.destroy()}}}}class oy{constructor(r){this.zoom=r.zoom,this.canonical=r.canonical,this.overscaling=r.overscaling,this.layers=r.layers,this.layerIds=this.layers.map(o=>o.fqid),this.index=r.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=r.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new os,this.footprintVertices=new Ao,this.footprintSegments=[],this.layoutVertexArray=new na,this.centroidVertexArray=new Ou,this.indexArray=new os,this.programConfigurations=new Z(r.layers,r.zoom,o=>S4.includes(o)),this.segments=new wn,this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.groundEffect=new oM(r),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}populate(r,o,u,f){this.features=[],this.hasPattern=wx("fill-extrusion",this.layers,o),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=ji(u),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:m,id:y,index:b,sourceLayerIndex:T}of r){const E=this.layers[0]._featureFilter.needGeometry,M=Xn(m,E);if(!this.layers[0]._featureFilter.filter(new dn(this.zoom),M,u))continue;const I={id:y,sourceLayerIndex:T,index:b,geometry:E?M.geometry:ls(m,u,f),properties:m.properties,type:m.type,patterns:{}},k=this.layoutVertexArray.length;this.hasPattern?this.features.push(Tx("fill-extrusion",this.layers,I,this.zoom,o)):this.addFeature(I,I.geometry,b,u,{},o.availableImages,f,o.brightness),o.featureIndex.insert(m,I.geometry,b,T,this.index,k)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(r,o,u,f,m,y){for(const b of this.features){const{geometry:T}=b;this.addFeature(b,T,b.index,o,u,f,m,y)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(r,o,u,f,m){const y=Object.keys(r).length!==0;if(y&&!this.stateDependentLayers.length)return;const b=y?this.stateDependentLayers:this.layers;this.programConfigurations.updatePaintArrays(r,o,b,u,f,m),this.groundEffect.update(r,o,b,u,f,m)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(r){this.uploaded||(this.layoutVertexBuffer=r.createVertexBuffer(this.layoutVertexArray,d4),this.indexBuffer=r.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=r.createVertexBuffer(this.layoutVertexExtArray,h4.members,!0)),this.groundEffect.upload(r)),this.groundEffect.uploadPaintProperties(r),this.programConfigurations.upload(r),this.uploaded=!0}uploadCentroid(r){this.groundEffect.uploadHiddenByLandmark(r),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=r.createVertexBuffer(this.centroidVertexArray,c4.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(r,o,u,f,m,y,b,T){const E=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(r,{})/this.tileToMeter,M=[new xe(0,0),new xe(Bt,Bt)],I=b.projection,k=I.name==="globe",F=E4[r.type]==="Polygon",z=new nM;z.centroidDataIndex=this.centroidData.length;const V=new rM,W=this.layers[0].paint.get("fill-extrusion-base").evaluate(r,{},f)<=0,G=this.layers[0].paint.get("fill-extrusion-height").evaluate(r,{},f);V.height=G,V.vertexArrayOffset=this.layoutVertexArray.length,V.groundVertexArrayOffset=this.groundEffect.vertexArray.length,k&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new nd);const te=bx(o,500);for(let Pe=te.length-1;Pe>=0;Pe--){const De=te[Pe];(De.length===0||(se=De[0]).every(Ve=>Ve.x<=0)||se.every(Ve=>Ve.x>=Bt)||se.every(Ve=>Ve.y<=0)||se.every(Ve=>Ve.y>=Bt))&&te.splice(Pe,1)}var se;let ne;if(k)ne=fM(te,M,f);else{ne=[];for(const Pe of te)ne.push({polygon:Pe,bounds:M})}const ye=F?this.edgeRadius:0,de=ye>0&&this.zoom<17,Ee=(Pe,De)=>{if(Pe.length===0)return!1;const Ve=Pe[Pe.length-1];return De.x===Ve.x&&De.y===Ve.y};for(const{polygon:Pe,bounds:De}of ne){let Ve=0,Le=0;for(const ct of Pe)F&&!ct[0].equals(ct[ct.length-1])&&ct.push(ct[0]),Le+=F?ct.length-1:ct.length;const rt=this.segments.prepareSegment((F?5:4)*Le,this.layoutVertexArray,this.indexArray);V.footprintSegIdx<0&&(V.footprintSegIdx=this.footprintSegments.length),V.polygonSegIdx<0&&(V.polygonSegIdx=this.polygonSegments.length);const ht={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Ze=new iM;if(Ze.vertexOffset=this.footprintVertices.length,Ze.indexOffset=3*this.footprintIndices.length,Ze.ringIndices=[],F){const ct=[],qe=[];Ve=rt.vertexLength;for(let Ot=0;Ot<Pe.length;Ot++){const dt=Pe[Ot];dt.length&&Ot!==0&&qe.push(ct.length/2);const Xt=[];let Wt,_t;Wt=dt[1].sub(dt[0])._perp()._unit(),Ze.ringIndices.push(dt.length-1);for(let hi=1;hi<dt.length;hi++){const ti=dt[hi],qt=dt[hi===dt.length-1?1:hi+1],gt=ti.clone();if(ye){_t=qt.sub(ti)._perp()._unit();const ai=Wt.add(_t)._unit(),Di=ye*Math.min(4,1/(Wt.x*ai.x+Wt.y*ai.y));gt.x+=Di*ai.x,gt.y+=Di*ai.y,gt.x=Math.round(gt.x),gt.y=Math.round(gt.y),Wt=_t}!W||ye!==0&&!de||Ee(Xt,gt)||Xt.push(gt),cm(this.layoutVertexArray,gt.x,gt.y,0,0,1,1,0),rt.vertexLength++,this.footprintVertices.emplaceBack(ti.x,ti.y),ct.push(ti.x,ti.y),k&&um(this.layoutVertexExtArray,I.projectTilePoint(gt.x,gt.y,f),I.upVector(f,gt.x,gt.y))}W&&(ye===0||de)&&(Xt.length!==0&&Ee(Xt,Xt[0])&&Xt.pop(),this.groundEffect.addData(Xt,De,E))}const at=Qg(ct,qe);for(let Ot=0;Ot<at.length;Ot+=3)this.footprintIndices.emplaceBack(Ze.vertexOffset+at[Ot+0],Ze.vertexOffset+at[Ot+1],Ze.vertexOffset+at[Ot+2]),this.indexArray.emplaceBack(Ve+at[Ot],Ve+at[Ot+2],Ve+at[Ot+1]),rt.primitiveLength++;Ze.indexCount+=at.length,Ze.vertexCount+=this.footprintVertices.length-Ze.vertexOffset}for(let ct=0;ct<Pe.length;ct++){const qe=Pe[ct];z.startRing(V,qe[0]);let at=qe.length>4&&uM(qe[qe.length-2],qe[0],qe[1]),Ot=ye?R4(qe[qe.length-2],qe[0],qe[1],ye):0;const dt=[];let Xt,Wt,_t;Wt=qe[1].sub(qe[0])._perp()._unit();let hi=!0;for(let ti=1,qt=0;ti<qe.length;ti++){let gt=qe[ti-1],ai=qe[ti];const Di=qe[ti===qe.length-1?1:ti+1];if(z.appendEdge(V,ai,gt),Ax(ai,gt,De)){ye&&(Wt=Di.sub(ai)._perp()._unit(),hi=!hi);continue}const di=ai.sub(gt)._perp(),Li=di.x/(Math.abs(di.x)+Math.abs(di.y)),xi=di.y>0?1:0,Xi=gt.dist(ai);if(qt+Xi>32768&&(qt=0),ye){_t=Di.sub(ai)._perp()._unit();let pr=lM(gt,ai,Di,aM(Wt,_t),ye);isNaN(pr)&&(pr=0);const wr=ai.sub(gt)._unit();gt=gt.add(wr.mult(Ot))._round(),ai=ai.add(wr.mult(-pr))._round(),Ot=pr,Wt=_t,W&&this.zoom>=17&&(Ee(dt,gt)||dt.push(gt),Ee(dt,ai)||dt.push(ai))}const Ei=rt.vertexLength,Br=qe.length>4&&uM(gt,ai,Di);let cr=hM(qt,at,hi);if(cm(this.layoutVertexArray,gt.x,gt.y,Li,xi,0,0,cr),cm(this.layoutVertexArray,gt.x,gt.y,Li,xi,0,1,cr),qt+=Xi,cr=hM(qt,Br,!hi),at=Br,cm(this.layoutVertexArray,ai.x,ai.y,Li,xi,0,0,cr),cm(this.layoutVertexArray,ai.x,ai.y,Li,xi,0,1,cr),rt.vertexLength+=4,this.indexArray.emplaceBack(Ei+0,Ei+1,Ei+2),this.indexArray.emplaceBack(Ei+1,Ei+3,Ei+2),rt.primitiveLength+=2,ye){const pr=Ve+(ti===1?qe.length-2:ti-2),wr=ti===1?Ve:pr+1;if(this.indexArray.emplaceBack(Ei+1,pr,Ei+3),this.indexArray.emplaceBack(pr,wr,Ei+3),rt.primitiveLength+=2,Xt===void 0&&(Xt=Ei),!Ax(Di,qe[ti],De)){const ur=ti===qe.length-1?Xt:rt.vertexLength;this.indexArray.emplaceBack(Ei+2,Ei+3,ur),this.indexArray.emplaceBack(Ei+3,ur+1,ur),this.indexArray.emplaceBack(Ei+3,wr,ur+1),rt.primitiveLength+=3}hi=!hi}if(k){const pr=this.layoutVertexExtArray,wr=I.projectTilePoint(gt.x,gt.y,f),ur=I.projectTilePoint(ai.x,ai.y,f),ln=I.upVector(f,gt.x,gt.y),Or=I.upVector(f,ai.x,ai.y);um(pr,wr,ln),um(pr,wr,ln),um(pr,ur,Or),um(pr,ur,Or)}}F&&(Ve+=qe.length-1),W&&ye&&this.zoom>=17&&(dt.length!==0&&Ee(dt,dt[0])&&dt.pop(),this.groundEffect.addData(dt,De,E,ye>0))}this.footprintSegments.push(Ze),ht.triangleCount=this.indexArray.length-ht.triangleArrayOffset,this.polygonSegments.push(ht),++V.footprintSegLen,++V.polygonSegLen}if(V.vertexCount=this.layoutVertexArray.length-V.vertexArrayOffset,V.groundVertexCount=this.groundEffect.vertexArray.length-V.groundVertexArrayOffset,V.vertexCount!==0){if(V.centroidXY=z.borders?tM:this.encodeCentroid(z,V),this.centroidData.push(V),z.borders){this.featuresOnBorder.push(z);const Pe=this.featuresOnBorder.length-1;for(let De=0;De<z.borders.length;De++)z.borders[De][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[De].push(Pe)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,r,u,m,y,f,T),this.groundEffect.addPaintPropertiesData(r,u,m,y,f,T),this.maxHeight=Math.max(this.maxHeight,G)}}sortBorders(){for(let r=0;r<this.borderFeatureIndices.length;r++)this.borderFeatureIndices[r].sort((o,u)=>this.featuresOnBorder[o].borders[r][0]-this.featuresOnBorder[u].borders[r][0])}splitToSubtiles(){const r=[];for(let b=0;b<this.centroidData.length;b++){const T=this.centroidData[b],E=+(T.min.y+T.max.y>Bt),M=2*E+(+(T.min.x+T.max.x>Bt)^E);for(let I=0;I<T.polygonSegLen;I++){const k=T.polygonSegIdx+I;r.push({centroidIdx:b,subtile:M,polygonSegmentIdx:k,triangleSegmentIdx:this.polygonSegments[k].triangleSegIdx})}}const o=new os;r.sort((b,T)=>b.triangleSegmentIdx===T.triangleSegmentIdx?b.subtile-T.subtile:b.triangleSegmentIdx-T.triangleSegmentIdx);let u=0,f=0,m=0;for(const b of r){if(b.triangleSegmentIdx!==u)break;m++}const y=r.length;for(;f!==r.length;){u=r[f].triangleSegmentIdx;let b=0,T=f,E=f;for(let M=T;M<m&&r[M].subtile===b;M++)E++;for(;T!==m;){const M=r[T];b=M.subtile;const I=this.centroidData[M.centroidIdx].min.clone(),k=this.centroidData[M.centroidIdx].max.clone(),F={vertexOffset:this.segments.segments[u].vertexOffset,primitiveOffset:o.length,vertexLength:this.segments.segments[u].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let z=T;z<E;z++){const V=r[z],W=this.polygonSegments[V.polygonSegmentIdx],G=this.centroidData[V.centroidIdx].min,te=this.centroidData[V.centroidIdx].max,se=this.indexArray.uint16;for(let ne=W.triangleArrayOffset;ne<W.triangleArrayOffset+W.triangleCount;ne++)o.emplaceBack(se[3*ne],se[3*ne+1],se[3*ne+2]);F.primitiveLength+=W.triangleCount,I.x=Math.min(I.x,G.x),I.y=Math.min(I.y,G.y),k.x=Math.max(k.x,te.x),k.y=Math.max(k.y,te.y)}F.primitiveLength>0&&this.triangleSubSegments.push({segment:F,min:I,max:k}),T=E;for(let z=T;z<m&&r[z].subtile===r[T].subtile;z++)E++}f=m;for(let M=f;M<y&&r[M].triangleSegmentIdx===r[f].triangleSegmentIdx;M++)m++}o._trim(),this.indexArray=o}getVisibleSegments(r,o,u){let f=0,m=0;const y=1<<r.canonical.z;if(o){const V=o.getMinMaxForTile(r);V&&(f=V.min,m=V.max)}m+=this.maxHeight;const b=r.toUnwrapped();let T;const E=[b.canonical.x/y+b.wrap,b.canonical.y/y],M=[(b.canonical.x+1)/y+b.wrap,(b.canonical.y+1)/y],I=new wn,k=(V,W,G)=>[V[0]*(1-G[0])+W[0]*G[0],V[1]*(1-G[1])+W[1]*G[1]],F=[],z=[];for(const V of this.triangleSubSegments){F[0]=V.min.x/Bt,F[1]=V.min.y/Bt,z[0]=V.max.x/Bt,z[1]=V.max.y/Bt;const W=k(E,M,F),G=k(E,M,z);if(new xn([W[0],W[1],f],[G[0],G[1],m]).intersectsPrecise(u)===0){T&&(I.segments.push(T),T=void 0);continue}const te=V.segment;T&&T.vertexOffset!==te.vertexOffset&&(I.segments.push(T),T=void 0),T?(T.vertexLength+=te.vertexLength,T.primitiveLength+=te.primitiveLength):T={vertexOffset:te.vertexOffset,primitiveLength:te.primitiveLength,vertexLength:te.vertexLength,primitiveOffset:te.primitiveOffset,sortKey:void 0,vaos:{}}}return T&&I.segments.push(T),I}encodeCentroid(r,o){const u=r.centroid(),f=o.span(),m=Math.min(7,Math.round(f.x*this.tileToMeter/10)),y=Math.min(7,Math.round(f.y*this.tileToMeter/10));return new xe(ri(u.x,1,Bt-1)<<3|m,ri(u.y,1,Bt-1)<<3|y)}encodeBorderCentroid(r){if(!r.borders)return new xe(0,0);const o=r.borders,u=Number.MAX_VALUE;if(o[0][0]!==u||o[1][0]!==u){const f=o[0][0]!==u?0:1;return new xe(6|(o[0][0]!==u?0:65528),(o[f][0]+o[f][1])/2<<3|6)}{const f=o[2][0]!==u?2:3;return new xe((o[f][0]+o[f][1])/2<<3|6,6|(o[2][0]!==u?0:65528))}}showCentroid(r){const o=this.centroidData[r.centroidDataIndex];o.flags&=hc,o.centroidXY.x=0,o.centroidXY.y=0,this.writeCentroidToBuffer(o)}writeCentroidToBuffer(r){this.groundEffect.updateHiddenByLandmark(r);const o=r.vertexArrayOffset,u=r.vertexCount+r.vertexArrayOffset,f=r.flags&hc?tM:r.centroidXY,m=this.centroidVertexArray.geta_centroid_pos0(o);if(this.centroidVertexArray.geta_centroid_pos1(o)!==f.y||m!==f.x){for(let y=o;y<u;++y)this.centroidVertexArray.emplace(y,f.x,f.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const r of this.centroidData)this.writeCentroidToBuffer(r)}updateReplacement(r,o){if(o.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=o.updateTime;const u=o.getReplacementRegionsForTile(r.toUnwrapped());if(function(m,y){if(m.length!==y.length)return!1;for(let b=0;b<m.length;b++)if(m[b].sourceId!==y[b].sourceId||!$A(m[b],y[b]))return!1;return!0}(this.activeReplacements,u))return;if(this.activeReplacements=u,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const m of this.centroidData)m.flags&=2147483647;const f=[];for(const m of this.activeReplacements){const y=Math.pow(2,m.footprintTileId.canonical.z-r.canonical.z);for(const b of this.centroidData)if(!(b.flags&hc||m.min.x>b.max.x||b.min.x>m.max.x||m.min.y>b.max.y||b.min.y>m.max.y))for(let T=0;T<b.footprintSegLen;T++){const E=this.footprintSegments[b.footprintSegIdx+T];if(f.length=0,O4(this.footprintVertices,E.vertexOffset,E.vertexCount,m.footprintTileId.canonical,r.canonical,f),qA(m.footprint,f,this.footprintIndices.uint16,E.indexOffset,E.indexCount,-E.vertexOffset,-y)){b.flags|=hc;break}}}for(const m of this.centroidData)this.writeCentroidToBuffer(m);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(r,o,u){let f=!1;for(let m=0;m<u.footprintSegLen;m++){const y=this.footprintSegments[u.footprintSegIdx+m];let b=0;for(const T of y.ringIndices){for(let E=b,M=T+b-1;E<T+b;M=E++){const I=this.footprintVertices.int16[2*(E+y.vertexOffset)+0],k=this.footprintVertices.int16[2*(E+y.vertexOffset)+1],F=this.footprintVertices.int16[2*(M+y.vertexOffset)+1];k>o!=F>o&&r<(this.footprintVertices.int16[2*(M+y.vertexOffset)+0]-I)*(o-k)/(F-k)+I&&(f=!f)}b=T}}return f}getHeightAtTileCoord(r,o){let u=Number.NEGATIVE_INFINITY,f=!0;const m=4*(r+Bt)*Bt+(o+Bt);if(this.partLookup.hasOwnProperty(m)){const y=this.partLookup[m];return y?{height:y.height,hidden:!!(y.flags&hc)}:void 0}for(const y of this.centroidData)r>y.max.x||y.min.x>r||o>y.max.y||y.min.y>o||this.footprintContainsPoint(r,o,y)&&y&&y.height>u&&(u=y.height,this.partLookup[m]=y,f=!!(y.flags&hc));if(u!==Number.NEGATIVE_INFINITY)return{height:u,hidden:f};this.partLookup[m]=void 0}}function aM(n,r){const o=n.add(r)._unit();return n.x*o.x+n.y*o.y}function R4(n,r,o,u){const f=r.sub(n)._perp()._unit(),m=o.sub(r)._perp()._unit();return lM(n,r,o,aM(f,m),u)}function lM(n,r,o,u,f){const m=Math.sqrt(1-u*u);return Math.min(n.dist(r)/3,r.dist(o)/3,f*m/u)}function Ax(n,r,o){return n.x<o[0].x&&r.x<o[0].x||n.x>o[1].x&&r.x>o[1].x||n.y<o[0].y&&r.y<o[0].y||n.y>o[1].y&&r.y>o[1].y}function cM(n,r){return n.x<r[0].x||n.x>r[1].x||n.y<r[0].y||n.y>r[1].y}function uM(n,r,o){if(n.x<0||n.x>=Bt||r.x<0||r.x>=Bt||o.x<0||o.x>=Bt)return!1;const u=o.sub(r),f=u.perp(),m=n.sub(r);return(u.x*m.x+u.y*m.y)/Math.sqrt((u.x*u.x+u.y*u.y)*(m.x*m.x+m.y*m.y))>-.866&&f.x*m.x+f.y*m.y<0}function hM(n,r,o){const u=r?2|n:-3&n;return o?1|u:-2&u}function dM(){const n=Math.PI/32,r=Math.tan(n),o=Ge;return o*Math.sqrt(1+2*r*r)-o}function fM(n,r,o){const u=1<<o.z,f=wi(o.x/u),m=wi((o.x+1)/u),y=Qi(o.y/u),b=Qi((o.y+1)/u);return function(T,E,M,I,k=0,F){const z=[];if(!T.length||!M||!I)return z;const V=(de,Ee)=>{for(const Pe of de)z.push({polygon:Pe,bounds:Ee})},W=Math.ceil(Math.log2(M)),G=Math.ceil(Math.log2(I)),te=W-G,se=[];for(let de=0;de<Math.abs(te);de++)se.push(te>0?0:1);for(let de=0;de<Math.min(W,G);de++)se.push(0),se.push(1);let ne=T;if(ne=iy(ne,E[0].y-k,E[1].y+k,1),ne=iy(ne,E[0].x-k,E[1].x+k,0),!ne.length)return z;const ye=[];for(se.length?ye.push({polygons:ne,bounds:E,depth:0}):V(ne,E);ye.length;){const de=ye.pop(),Ee=de.depth,Pe=se[Ee],De=de.bounds[0],Ve=de.bounds[1],Le=Pe===0?De.x:De.y,rt=Pe===0?Ve.x:Ve.y,ht=F?F(Pe,Le,rt):.5*(Le+rt),Ze=iy(de.polygons,Le-k,ht+k,Pe),ct=iy(de.polygons,ht-k,rt+k,Pe);if(Ze.length){const qe=[De,new xe(Pe===0?ht:Ve.x,Pe===1?ht:Ve.y)];se.length>Ee+1?ye.push({polygons:Ze,bounds:qe,depth:Ee+1}):V(Ze,qe)}if(ct.length){const qe=[new xe(Pe===0?ht:De.x,Pe===1?ht:De.y),Ve];se.length>Ee+1?ye.push({polygons:ct,bounds:qe,depth:Ee+1}):V(ct,qe)}}return z}(n,r,Math.ceil((m-f)/11.25),Math.ceil((y-b)/11.25),1,(T,E,M)=>{if(T===0)return .5*(E+M);{const I=Qi((o.y+E/Bt)/u);return(gi(.5*(Qi((o.y+M/Bt)/u)+I))*u-o.y)*Bt}})}function O4(n,r,o,u,f,m){const y=Math.pow(2,u.z-f.z);for(let b=0;b<o;b++){let T=n.int16[2*(b+r)+0],E=n.int16[2*(b+r)+1];T=(T+f.x*Bt)*y-u.x*Bt,E=(E+f.y*Bt)*y-u.y*Bt,m.push(new xe(T,E))}}Ht(oy,"FillExtrusionBucket",{omit:["layers","features"]}),Ht(rM,"PartData"),Ht(iM,"FootprintSegment"),Ht(nM,"BorderCentroidData"),Ht(oM,"GroundEffect");const k4=new fn({visibility:new Pt(Fe["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new Pt(Fe["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var D4={paint:new fn({"fill-extrusion-opacity":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new oi(Fe["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new oi(Fe["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new oi(Fe["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new oi(Fe["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new oi(Fe["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new oi(Fe["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Pt(Fe["paint_fill-extrusion"]["fill-extrusion-emissive-strength"])}),layout:k4};class _d extends xe{constructor(r,o,u){super(r,o),this.z=u}}function hm(n,r){return n.x*r.x+n.y*r.y}function pM(n,r){if(n.length===1){let o=0;const u=r[o++];let f;for(;!f||u.equals(f);)if(f=r[o++],!f)return 1/0;for(;o<r.length;o++){const m=r[o],y=n[0],b=f.sub(u),T=m.sub(u),E=y.sub(u),M=hm(b,b),I=hm(b,T),k=hm(T,T),F=hm(E,b),z=hm(E,T),V=M*k-I*I,W=(k*F-I*z)/V,G=(M*z-I*F)/V,te=u.z*(1-W-G)+f.z*W+m.z*G;if(isFinite(te))return te}return 1/0}{let o=1/0;for(const u of r)o=Math.min(o,u.z);return o}}function mM(n,r,o,u,f,m,y,b){const T=y*f.getElevationAt(n,r,!0,!0),E=m[0]!==0,M=E?m[1]===0?y*(m[0]/7-450):y*function(I,k,F){const z=Math.floor(k[0]/8),V=Math.floor(k[1]/8),W=10*(k[0]-8*z),G=10*(k[1]-8*V),te=I.getElevationAt(z,V,!0,!0),se=I.getMeterToDEM(F),ne=Math.floor(.5*(W*se-1)),ye=Math.floor(.5*(G*se-1)),de=I.tileCoordToPixel(z,V),Ee=2*ne+1,Pe=2*ye+1,De=function(ct,qe,at,Ot,dt){return[ct.getElevationAtPixel(qe,at,!0),ct.getElevationAtPixel(qe+dt,at,!0),ct.getElevationAtPixel(qe,at+dt,!0),ct.getElevationAtPixel(qe+Ot,at+dt,!0)]}(I,de.x-ne,de.y-ye,Ee,Pe),Ve=Math.abs(De[0]-De[1]),Le=Math.abs(De[2]-De[3]),rt=Math.abs(De[0]-De[2])+Math.abs(De[1]-De[3]),ht=Math.min(.25,.5*se*(Ve+Le)/Ee),Ze=Math.min(.25,.5*se*rt/Pe);return te+Math.max(ht*W,Ze*G)}(f,m,b):T;return{base:T+(o===0)?-1:o,top:E?Math.max(M+u,T+o+2):T+u}}const L4=Mr([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:N4}=L4,F4=Mr([{name:"a_packed",components:4,type:"Float32"}]),{members:B4}=F4;class _M{constructor(r,o){this.width=r,this.height=o,this.nextRow=0,this.image=new cc({width:r,height:o}),this.positions={},this.uploaded=!1}getDash(r,o){const u=this.getKey(r,o);return this.positions[u]}trim(){const r=this.width,o=this.height=Pn(this.nextRow);this.image.resize({width:r,height:o})}getKey(r,o){return r.join(",")+o}getDashRanges(r,o,u){const f=[];let m=r.length%2==1?-r[r.length-1]*u:0,y=r[0]*u,b=!0;f.push({left:m,right:y,isDash:b,zeroLength:r[0]===0});let T=r[0];for(let E=1;E<r.length;E++){b=!b;const M=r[E];m=T*u,T+=M,y=T*u,f.push({left:m,right:y,isDash:b,zeroLength:M===0})}return f}addRoundDash(r,o,u){const f=o/2;for(let m=-u;m<=u;m++){const y=this.width*(this.nextRow+u+m);let b=0,T=r[b];for(let E=0;E<this.width;E++){E/T.right>1&&(T=r[++b]);const M=Math.abs(E-T.left),I=Math.abs(E-T.right),k=Math.min(M,I);let F;const z=m/u*(f+1);if(T.isDash){const V=f-Math.abs(z);F=Math.sqrt(k*k+V*V)}else F=f-Math.sqrt(k*k+z*z);this.image.data[y+E]=Math.max(0,Math.min(255,F+128))}}}addRegularDash(r,o){for(let T=r.length-1;T>=0;--T){const E=r[T],M=r[T+1];E.zeroLength?r.splice(T,1):M&&M.isDash===E.isDash&&(M.left=E.left,r.splice(T,1))}const u=r[0],f=r[r.length-1];u.isDash===f.isDash&&(u.left=f.left-this.width,f.right=u.right+this.width);const m=this.width*this.nextRow;let y=0,b=r[y];for(let T=0;T<this.width;T++){T/b.right>1&&(b=r[++y]);const E=Math.abs(T-b.left),M=Math.abs(T-b.right),I=Math.min(E,M);this.image.data[m+T]=Math.max(0,Math.min(255,(b.isDash?I:-I)+o+128))}}addDash(r,o){const u=this.getKey(r,o);if(this.positions[u])return this.positions[u];const f=o==="round",m=f?7:0,y=2*m+1;if(this.nextRow+y>this.height)return mr("LineAtlas out of space"),null;r.length===0&&r.push(1);let b=0;for(let M=0;M<r.length;M++)r[M]<0&&(mr("Negative value is found in line dasharray, replacing values with 0"),r[M]=0),b+=r[M];if(b!==0){const M=this.width/b,I=this.getDashRanges(r,this.width,M);f?this.addRoundDash(I,M,m):this.addRegularDash(I,o==="square"?.5*M:0)}const T=this.nextRow+m;this.nextRow+=y;const E={tl:[T,m],br:[b,0]};return this.positions[u]=E,E}}Ht(_M,"LineAtlas");const z4=ty.types,U4=Math.cos(Math.PI/180*37.5);class Mx{constructor(r){this.zoom=r.zoom,this.overscaling=r.overscaling,this.layers=r.layers,this.layerIds=this.layers.map(o=>o.fqid),this.index=r.index,this.projection=r.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(o=>{this.gradients[o.id]={}}),this.layoutVertexArray=new $p,this.layoutVertexArray2=new Ba,this.indexArray=new os,this.programConfigurations=new Z(r.layers,r.zoom),this.segments=new wn,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id)}populate(r,o,u,f){this.hasPattern=wx("line",this.layers,o);const m=this.layers[0].layout.get("line-sort-key"),y=[];for(const{feature:M,id:I,index:k,sourceLayerIndex:F}of r){const z=this.layers[0]._featureFilter.needGeometry,V=Xn(M,z);if(!this.layers[0]._featureFilter.filter(new dn(this.zoom),V,u))continue;const W=m?m.evaluate(V,{},u):void 0,G={id:I,properties:M.properties,type:M.type,sourceLayerIndex:F,index:k,geometry:z?V.geometry:ls(M,u,f),patterns:{},sortKey:W};y.push(G)}m&&y.sort((M,I)=>M.sortKey-I.sortKey);const{lineAtlas:b,featureIndex:T}=o,E=this.addConstantDashes(b);for(const M of y){const{geometry:I,index:k,sourceLayerIndex:F}=M;if(E&&this.addFeatureDashes(M,b),this.hasPattern){const z=Tx("line",this.layers,M,this.zoom,o);this.patternFeatures.push(z)}else this.addFeature(M,I,k,u,b.positions,o.availableImages,o.brightness);T.insert(r[k].feature,I,k,F,this.index)}}addConstantDashes(r){let o=!1;for(const u of this.layers){const f=u.paint.get("line-dasharray").value,m=u.layout.get("line-cap").value;if(f.kind!=="constant"||m.kind!=="constant")o=!0;else{const y=m.value,b=f.value;if(!b)continue;r.addDash(b,y)}}return o}addFeatureDashes(r,o){const u=this.zoom;for(const f of this.layers){const m=f.paint.get("line-dasharray").value,y=f.layout.get("line-cap").value;if(m.kind==="constant"&&y.kind==="constant")continue;let b,T;if(m.kind==="constant"){if(b=m.value,!b)continue}else b=m.evaluate({zoom:u},r);T=y.kind==="constant"?y.value:y.evaluate({zoom:u},r),o.addDash(b,T),r.patterns[f.id]=o.getKey(b,T)}}update(r,o,u,f,m){const y=Object.keys(r).length!==0;y&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(r,o,y?this.stateDependentLayers:this.layers,u,f,m)}addFeatures(r,o,u,f,m,y){for(const b of this.patternFeatures)this.addFeature(b,b.geometry,b.index,o,u,f,y)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(r){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=r.createVertexBuffer(this.layoutVertexArray2,B4)),this.layoutVertexBuffer=r.createVertexBuffer(this.layoutVertexArray,N4),this.indexBuffer=r.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(r),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(r){if(r.properties&&r.properties.hasOwnProperty("mapbox_clip_start")&&r.properties.hasOwnProperty("mapbox_clip_end"))return{start:+r.properties.mapbox_clip_start,end:+r.properties.mapbox_clip_end}}addFeature(r,o,u,f,m,y,b){const T=this.layers[0].layout,E=T.get("line-join").evaluate(r,{}),M=T.get("line-cap").evaluate(r,{}),I=T.get("line-miter-limit"),k=T.get("line-round-limit");this.lineClips=this.lineFeatureClips(r);for(const F of o)this.addLine(F,r,E,M,I,k);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,r,u,m,y,f,b)}addLine(r,o,u,f,m,y){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let G=0;G<r.length-1;G++)this.totalDistance+=r[G].dist(r[G+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const b=z4[o.type]==="Polygon";let T=r.length;for(;T>=2&&r[T-1].equals(r[T-2]);)T--;let E=0;for(;E<T-1&&r[E].equals(r[E+1]);)E++;if(T<(b?3:2))return;u==="bevel"&&(m=1.05);const M=this.overscaling<=16?15*Bt/(512*this.overscaling):0,I=this.segments.prepareSegment(10*T,this.layoutVertexArray,this.indexArray);let k,F,z,V,W;this.e1=this.e2=-1,b&&(k=r[T-2],W=r[E].sub(k)._unit()._perp());for(let G=E;G<T;G++){if(z=G===T-1?b?r[E+1]:void 0:r[G+1],z&&r[G].equals(z))continue;W&&(V=W),k&&(F=k),k=r[G],W=z?z.sub(k)._unit()._perp():V,V=V||W;let te=V.add(W);te.x===0&&te.y===0||te._unit();const se=V.x*W.x+V.y*W.y,ne=te.x*W.x+te.y*W.y,ye=ne!==0?1/ne:1/0,de=2*Math.sqrt(2-2*ne),Ee=ne<U4&&F&&z,Pe=V.x*W.y-V.y*W.x>0;if(Ee&&G>E){const Le=k.dist(F);if(Le>2*M){const rt=k.sub(k.sub(F)._mult(M/Le)._round());this.updateDistance(F,rt),this.addCurrentVertex(rt,V,0,0,I),F=rt}}const De=F&&z;let Ve=De?u:b?"butt":f;if(De&&Ve==="round"&&(ye<y?Ve="miter":ye<=2&&(Ve="fakeround")),Ve==="miter"&&ye>m&&(Ve="bevel"),Ve==="bevel"&&(ye>2&&(Ve="flipbevel"),ye<m&&(Ve="miter")),F&&this.updateDistance(F,k),Ve==="miter")te._mult(ye),this.addCurrentVertex(k,te,0,0,I);else if(Ve==="flipbevel"){if(ye>100)te=W.mult(-1);else{const Le=ye*V.add(W).mag()/V.sub(W).mag();te._perp()._mult(Le*(Pe?-1:1))}this.addCurrentVertex(k,te,0,0,I),this.addCurrentVertex(k,te.mult(-1),0,0,I)}else if(Ve==="bevel"||Ve==="fakeround"){const Le=-Math.sqrt(ye*ye-1),rt=Pe?Le:0,ht=Pe?0:Le;if(F&&this.addCurrentVertex(k,V,rt,ht,I),Ve==="fakeround"){const Ze=Math.round(180*de/Math.PI/20);for(let ct=1;ct<Ze;ct++){let qe=ct/Ze;if(qe!==.5){const Ot=qe-.5;qe+=qe*Ot*(qe-1)*((1.0904+se*(se*(3.55645-1.43519*se)-3.2452))*Ot*Ot+(.848013+se*(.215638*se-1.06021)))}const at=W.sub(V)._mult(qe)._add(V)._unit()._mult(Pe?-1:1);this.addHalfVertex(k,at.x,at.y,!1,Pe,0,I)}}z&&this.addCurrentVertex(k,W,-rt,-ht,I)}else if(Ve==="butt")this.addCurrentVertex(k,te,0,0,I);else if(Ve==="square"){const Le=F?1:-1;F||this.addCurrentVertex(k,te,Le,Le,I),this.addCurrentVertex(k,te,0,0,I),F&&this.addCurrentVertex(k,te,Le,Le,I)}else Ve==="round"&&(F&&(this.addCurrentVertex(k,V,0,0,I),this.addCurrentVertex(k,V,1,1,I,!0)),z&&(this.addCurrentVertex(k,W,-1,-1,I,!0),this.addCurrentVertex(k,W,0,0,I)));if(Ee&&G<T-1){const Le=k.dist(z);if(Le>2*M){const rt=k.add(z.sub(k)._mult(M/Le)._round());this.updateDistance(k,rt),this.addCurrentVertex(rt,W,0,0,I),k=rt}}}}addCurrentVertex(r,o,u,f,m,y=!1){const b=o.y*f-o.x,T=-o.y-o.x*f;this.addHalfVertex(r,o.x+o.y*u,o.y-o.x*u,y,!1,u,m),this.addHalfVertex(r,b,T,y,!0,-f,m)}addHalfVertex({x:r,y:o},u,f,m,y,b,T){this.layoutVertexArray.emplaceBack((r<<1)+(m?1:0),(o<<1)+(y?1:0),Math.round(63*u)+128,Math.round(63*f)+128,1+(b===0?0:b<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const E=T.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,E),T.primitiveLength++),y?this.e2=E:this.e1=E}updateScaledDistance(){if(this.lineClips){const r=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=r*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(r,o){this.distance+=r.dist(o),this.updateScaledDistance()}}Ht(Mx,"LineBucket",{omit:["layers","patternFeatures"]});const V4=new fn({"line-cap":new oi(Fe.layout_line["line-cap"]),"line-join":new oi(Fe.layout_line["line-join"]),"line-miter-limit":new Pt(Fe.layout_line["line-miter-limit"]),"line-round-limit":new Pt(Fe.layout_line["line-round-limit"]),"line-sort-key":new oi(Fe.layout_line["line-sort-key"]),visibility:new Pt(Fe.layout_line.visibility)});var gM={paint:new fn({"line-opacity":new oi(Fe.paint_line["line-opacity"]),"line-color":new oi(Fe.paint_line["line-color"]),"line-translate":new Pt(Fe.paint_line["line-translate"]),"line-translate-anchor":new Pt(Fe.paint_line["line-translate-anchor"]),"line-width":new oi(Fe.paint_line["line-width"]),"line-gap-width":new oi(Fe.paint_line["line-gap-width"]),"line-offset":new oi(Fe.paint_line["line-offset"]),"line-blur":new oi(Fe.paint_line["line-blur"]),"line-dasharray":new oi(Fe.paint_line["line-dasharray"]),"line-pattern":new oi(Fe.paint_line["line-pattern"]),"line-gradient":new vl(Fe.paint_line["line-gradient"]),"line-trim-offset":new Pt(Fe.paint_line["line-trim-offset"]),"line-emissive-strength":new Pt(Fe.paint_line["line-emissive-strength"]),"line-border-width":new oi(Fe.paint_line["line-border-width"]),"line-border-color":new oi(Fe.paint_line["line-border-color"])}),layout:V4};function yM(n,r,o){return r*(Bt/(n.tileSize*Math.pow(2,o-n.tileID.overscaledZ)))}function vM(n,r){return 1/yM(n,1,r.tileZoom)}function xM(n,r,o,u){return n.translatePosMatrix(u||r.tileID.projMatrix,r,o.paint.get("line-translate"),o.paint.get("line-translate-anchor"))}const bM=n=>{const r=[];wM(n)&&r.push("RENDER_LINE_DASH"),n.paint.get("line-gradient")&&r.push("RENDER_LINE_GRADIENT");const o=n.paint.get("line-trim-offset");return o[0]===0&&o[1]===0||r.push("RENDER_LINE_TRIM_OFFSET"),n.paint.get("line-border-width").constantOr(1)!==0&&r.push("RENDER_LINE_BORDER"),r};function wM(n){const r=n.paint.get("line-dasharray").value;return r.value||r.kind!=="constant"}const TM=new class extends oi{possiblyEvaluate(n,r){return r=new dn(Math.floor(r.zoom),{now:r.now,fadeDuration:r.fadeDuration,transition:r.transition}),super.possiblyEvaluate(n,r)}evaluate(n,r,o,u){return r=Ar({},r,{zoom:Math.floor(r.zoom)}),super.evaluate(n,r,o,u)}}(gM.paint.properties["line-width"].specification);function EM(n,r){return r>0?r+2*n:n}TM.useIntegerZoom=!0;const j4=Mr([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),$4=Mr([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),W4=Mr([{name:"a_projected_pos",components:4,type:"Float32"}],4);Mr([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const H4=Mr([{name:"a_z_offset",components:1,type:"Float32"}],4),q4=Mr([{name:"a_texb",components:2,type:"Uint16"}]),G4=Mr([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),X4=Mr([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_z_offset",components:1,type:"Float32"}]);Mr([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const SM=Mr([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Z4=Mr([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Mr([{name:"triangle",components:3,type:"Uint16"}]),Mr([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Mr([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),Mr([{type:"Float32",name:"offsetX"}]),Mr([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Ts=24;const ca=128;function Cx(n,r){const{expression:o}=r;if(o.kind==="constant")return{kind:"constant",layoutSize:o.evaluate(new dn(n+1))};if(o.kind==="source")return{kind:"source"};{const{zoomStops:u,interpolationType:f}=o;let m=0;for(;m<u.length&&u[m]<=n;)m++;m=Math.max(0,m-1);let y=m;for(;y<u.length&&u[y]<n+1;)y++;y=Math.min(u.length-1,y);const b=u[m],T=u[y];return o.kind==="composite"?{kind:"composite",minZoom:b,maxZoom:T,interpolationType:f}:{kind:"camera",minZoom:b,maxZoom:T,minSize:o.evaluate(new dn(b)),maxSize:o.evaluate(new dn(T)),interpolationType:f}}}function ay(n,{uSize:r,uSizeT:o},{lowerSize:u,upperSize:f}){return n.kind==="source"?u/ca:n.kind==="composite"?Ut(u/ca,f/ca,o):r}function gd(n,r){let o=0,u=0;if(n.kind==="constant")u=n.layoutSize;else if(n.kind!=="source"){const{interpolationType:f,minZoom:m,maxZoom:y}=n,b=f?ri(to.interpolationFactor(f,r,m,y),0,1):0;n.kind==="camera"?u=Ut(n.minSize,n.maxSize,b):o=b}return{uSizeT:o,uSize:u}}var Y4=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:ca,evaluateSizeForFeature:ay,evaluateSizeForZoom:gd,getSizeData:Cx});function K4(n,r,o){return n.sections.forEach(u=>{u.text=function(f,m,y){const b=m.layout.get("text-transform").evaluate(y,{});return b==="uppercase"?f=f.toLocaleUpperCase():b==="lowercase"&&(f=f.toLocaleLowerCase()),io.applyArabicShaping&&(f=io.applyArabicShaping(f)),f}(u.text,r,o)}),n}const dm={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂","←":"↑","→":"↓"};function J4(n){return n==="︶"||n==="﹈"||n==="︸"||n==="﹄"||n==="﹂"||n==="︾"||n==="︼"||n==="︺"||n==="︘"||n==="﹀"||n==="︐"||n==="︓"||n==="︔"||n==="｀"||n==="￣"||n==="︑"||n==="︒"}function Q4(n){return n==="︵"||n==="﹇"||n==="︷"||n==="﹃"||n==="﹁"||n==="︽"||n==="︻"||n==="︹"||n==="︗"||n==="︿"}var eB={read:function(n,r,o,u,f){var m,y,b=8*f-u-1,T=(1<<b)-1,E=T>>1,M=-7,I=o?f-1:0,k=o?-1:1,F=n[r+I];for(I+=k,m=F&(1<<-M)-1,F>>=-M,M+=b;M>0;m=256*m+n[r+I],I+=k,M-=8);for(y=m&(1<<-M)-1,m>>=-M,M+=u;M>0;y=256*y+n[r+I],I+=k,M-=8);if(m===0)m=1-E;else{if(m===T)return y?NaN:1/0*(F?-1:1);y+=Math.pow(2,u),m-=E}return(F?-1:1)*y*Math.pow(2,m-u)},write:function(n,r,o,u,f,m){var y,b,T,E=8*m-f-1,M=(1<<E)-1,I=M>>1,k=f===23?Math.pow(2,-24)-Math.pow(2,-77):0,F=u?0:m-1,z=u?1:-1,V=r<0||r===0&&1/r<0?1:0;for(r=Math.abs(r),isNaN(r)||r===1/0?(b=isNaN(r)?1:0,y=M):(y=Math.floor(Math.log(r)/Math.LN2),r*(T=Math.pow(2,-y))<1&&(y--,T*=2),(r+=y+I>=1?k/T:k*Math.pow(2,1-I))*T>=2&&(y++,T/=2),y+I>=M?(b=0,y=M):y+I>=1?(b=(r*T-1)*Math.pow(2,f),y+=I):(b=r*Math.pow(2,I-1)*Math.pow(2,f),y=0));f>=8;n[o+F]=255&b,F+=z,b/=256,f-=8);for(y=y<<f|b,E+=f;E>0;n[o+F]=255&y,F+=z,y/=256,E-=8);n[o+F-z]|=128*V}},AM=an,ly=eB;function an(n){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(n)?n:new Uint8Array(n||0),this.pos=0,this.type=0,this.length=this.buf.length}an.Varint=0,an.Fixed64=1,an.Bytes=2,an.Fixed32=5;var Px=4294967296,MM=1/Px,CM=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function Ml(n){return n.type===an.Bytes?n.readVarint()+n.pos:n.pos+1}function yd(n,r,o){return o?4294967296*r+(n>>>0):4294967296*(r>>>0)+(n>>>0)}function PM(n,r,o){var u=r<=16383?1:r<=2097151?2:r<=268435455?3:Math.floor(Math.log(r)/(7*Math.LN2));o.realloc(u);for(var f=o.pos-1;f>=n;f--)o.buf[f+u]=o.buf[f]}function tB(n,r){for(var o=0;o<n.length;o++)r.writeVarint(n[o])}function iB(n,r){for(var o=0;o<n.length;o++)r.writeSVarint(n[o])}function rB(n,r){for(var o=0;o<n.length;o++)r.writeFloat(n[o])}function nB(n,r){for(var o=0;o<n.length;o++)r.writeDouble(n[o])}function sB(n,r){for(var o=0;o<n.length;o++)r.writeBoolean(n[o])}function oB(n,r){for(var o=0;o<n.length;o++)r.writeFixed32(n[o])}function aB(n,r){for(var o=0;o<n.length;o++)r.writeSFixed32(n[o])}function lB(n,r){for(var o=0;o<n.length;o++)r.writeFixed64(n[o])}function cB(n,r){for(var o=0;o<n.length;o++)r.writeSFixed64(n[o])}function cy(n,r){return(n[r]|n[r+1]<<8|n[r+2]<<16)+16777216*n[r+3]}function vd(n,r,o){n[o]=r,n[o+1]=r>>>8,n[o+2]=r>>>16,n[o+3]=r>>>24}function IM(n,r){return(n[r]|n[r+1]<<8|n[r+2]<<16)+(n[r+3]<<24)}an.prototype={destroy:function(){this.buf=null},readFields:function(n,r,o){for(o=o||this.length;this.pos<o;){var u=this.readVarint(),f=u>>3,m=this.pos;this.type=7&u,n(f,r,this),this.pos===m&&this.skip(u)}return r},readMessage:function(n,r){return this.readFields(n,r,this.readVarint()+this.pos)},readFixed32:function(){var n=cy(this.buf,this.pos);return this.pos+=4,n},readSFixed32:function(){var n=IM(this.buf,this.pos);return this.pos+=4,n},readFixed64:function(){var n=cy(this.buf,this.pos)+cy(this.buf,this.pos+4)*Px;return this.pos+=8,n},readSFixed64:function(){var n=cy(this.buf,this.pos)+IM(this.buf,this.pos+4)*Px;return this.pos+=8,n},readFloat:function(){var n=ly.read(this.buf,this.pos,!0,23,4);return this.pos+=4,n},readDouble:function(){var n=ly.read(this.buf,this.pos,!0,52,8);return this.pos+=8,n},readVarint:function(n){var r,o,u=this.buf;return r=127&(o=u[this.pos++]),o<128?r:(r|=(127&(o=u[this.pos++]))<<7,o<128?r:(r|=(127&(o=u[this.pos++]))<<14,o<128?r:(r|=(127&(o=u[this.pos++]))<<21,o<128?r:function(f,m,y){var b,T,E=y.buf;if(b=(112&(T=E[y.pos++]))>>4,T<128||(b|=(127&(T=E[y.pos++]))<<3,T<128)||(b|=(127&(T=E[y.pos++]))<<10,T<128)||(b|=(127&(T=E[y.pos++]))<<17,T<128)||(b|=(127&(T=E[y.pos++]))<<24,T<128)||(b|=(1&(T=E[y.pos++]))<<31,T<128))return yd(f,b,m);throw new Error("Expected varint not more than 10 bytes")}(r|=(15&(o=u[this.pos]))<<28,n,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var n=this.readVarint();return n%2==1?(n+1)/-2:n/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var n=this.readVarint()+this.pos,r=this.pos;return this.pos=n,n-r>=12&&CM?function(o,u,f){return CM.decode(o.subarray(u,f))}(this.buf,r,n):function(o,u,f){for(var m="",y=u;y<f;){var b,T,E,M=o[y],I=null,k=M>239?4:M>223?3:M>191?2:1;if(y+k>f)break;k===1?M<128&&(I=M):k===2?(192&(b=o[y+1]))==128&&(I=(31&M)<<6|63&b)<=127&&(I=null):k===3?(T=o[y+2],(192&(b=o[y+1]))==128&&(192&T)==128&&((I=(15&M)<<12|(63&b)<<6|63&T)<=2047||I>=55296&&I<=57343)&&(I=null)):k===4&&(T=o[y+2],E=o[y+3],(192&(b=o[y+1]))==128&&(192&T)==128&&(192&E)==128&&((I=(15&M)<<18|(63&b)<<12|(63&T)<<6|63&E)<=65535||I>=1114112)&&(I=null)),I===null?(I=65533,k=1):I>65535&&(I-=65536,m+=String.fromCharCode(I>>>10&1023|55296),I=56320|1023&I),m+=String.fromCharCode(I),y+=k}return m}(this.buf,r,n)},readBytes:function(){var n=this.readVarint()+this.pos,r=this.buf.subarray(this.pos,n);return this.pos=n,r},readPackedVarint:function(n,r){if(this.type!==an.Bytes)return n.push(this.readVarint(r));var o=Ml(this);for(n=n||[];this.pos<o;)n.push(this.readVarint(r));return n},readPackedSVarint:function(n){if(this.type!==an.Bytes)return n.push(this.readSVarint());var r=Ml(this);for(n=n||[];this.pos<r;)n.push(this.readSVarint());return n},readPackedBoolean:function(n){if(this.type!==an.Bytes)return n.push(this.readBoolean());var r=Ml(this);for(n=n||[];this.pos<r;)n.push(this.readBoolean());return n},readPackedFloat:function(n){if(this.type!==an.Bytes)return n.push(this.readFloat());var r=Ml(this);for(n=n||[];this.pos<r;)n.push(this.readFloat());return n},readPackedDouble:function(n){if(this.type!==an.Bytes)return n.push(this.readDouble());var r=Ml(this);for(n=n||[];this.pos<r;)n.push(this.readDouble());return n},readPackedFixed32:function(n){if(this.type!==an.Bytes)return n.push(this.readFixed32());var r=Ml(this);for(n=n||[];this.pos<r;)n.push(this.readFixed32());return n},readPackedSFixed32:function(n){if(this.type!==an.Bytes)return n.push(this.readSFixed32());var r=Ml(this);for(n=n||[];this.pos<r;)n.push(this.readSFixed32());return n},readPackedFixed64:function(n){if(this.type!==an.Bytes)return n.push(this.readFixed64());var r=Ml(this);for(n=n||[];this.pos<r;)n.push(this.readFixed64());return n},readPackedSFixed64:function(n){if(this.type!==an.Bytes)return n.push(this.readSFixed64());var r=Ml(this);for(n=n||[];this.pos<r;)n.push(this.readSFixed64());return n},skip:function(n){var r=7&n;if(r===an.Varint)for(;this.buf[this.pos++]>127;);else if(r===an.Bytes)this.pos=this.readVarint()+this.pos;else if(r===an.Fixed32)this.pos+=4;else{if(r!==an.Fixed64)throw new Error("Unimplemented type: "+r);this.pos+=8}},writeTag:function(n,r){this.writeVarint(n<<3|r)},realloc:function(n){for(var r=this.length||16;r<this.pos+n;)r*=2;if(r!==this.length){var o=new Uint8Array(r);o.set(this.buf),this.buf=o,this.length=r}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(n){this.realloc(4),vd(this.buf,n,this.pos),this.pos+=4},writeSFixed32:function(n){this.realloc(4),vd(this.buf,n,this.pos),this.pos+=4},writeFixed64:function(n){this.realloc(8),vd(this.buf,-1&n,this.pos),vd(this.buf,Math.floor(n*MM),this.pos+4),this.pos+=8},writeSFixed64:function(n){this.realloc(8),vd(this.buf,-1&n,this.pos),vd(this.buf,Math.floor(n*MM),this.pos+4),this.pos+=8},writeVarint:function(n){(n=+n||0)>268435455||n<0?function(r,o){var u,f;if(r>=0?(u=r%4294967296|0,f=r/4294967296|0):(f=~(-r/4294967296),4294967295^(u=~(-r%4294967296))?u=u+1|0:(u=0,f=f+1|0)),r>=18446744073709552e3||r<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");o.realloc(10),function(m,y,b){b.buf[b.pos++]=127&m|128,m>>>=7,b.buf[b.pos++]=127&m|128,m>>>=7,b.buf[b.pos++]=127&m|128,m>>>=7,b.buf[b.pos++]=127&m|128,b.buf[b.pos]=127&(m>>>=7)}(u,0,o),function(m,y){var b=(7&m)<<4;y.buf[y.pos++]|=b|((m>>>=3)?128:0),m&&(y.buf[y.pos++]=127&m|((m>>>=7)?128:0),m&&(y.buf[y.pos++]=127&m|((m>>>=7)?128:0),m&&(y.buf[y.pos++]=127&m|((m>>>=7)?128:0),m&&(y.buf[y.pos++]=127&m|((m>>>=7)?128:0),m&&(y.buf[y.pos++]=127&m)))))}(f,o)}(n,this):(this.realloc(4),this.buf[this.pos++]=127&n|(n>127?128:0),n<=127||(this.buf[this.pos++]=127&(n>>>=7)|(n>127?128:0),n<=127||(this.buf[this.pos++]=127&(n>>>=7)|(n>127?128:0),n<=127||(this.buf[this.pos++]=n>>>7&127))))},writeSVarint:function(n){this.writeVarint(n<0?2*-n-1:2*n)},writeBoolean:function(n){this.writeVarint(!!n)},writeString:function(n){n=String(n),this.realloc(4*n.length),this.pos++;var r=this.pos;this.pos=function(u,f,m){for(var y,b,T=0;T<f.length;T++){if((y=f.charCodeAt(T))>55295&&y<57344){if(!b){y>56319||T+1===f.length?(u[m++]=239,u[m++]=191,u[m++]=189):b=y;continue}if(y<56320){u[m++]=239,u[m++]=191,u[m++]=189,b=y;continue}y=b-55296<<10|y-56320|65536,b=null}else b&&(u[m++]=239,u[m++]=191,u[m++]=189,b=null);y<128?u[m++]=y:(y<2048?u[m++]=y>>6|192:(y<65536?u[m++]=y>>12|224:(u[m++]=y>>18|240,u[m++]=y>>12&63|128),u[m++]=y>>6&63|128),u[m++]=63&y|128)}return m}(this.buf,n,this.pos);var o=this.pos-r;o>=128&&PM(r,o,this),this.pos=r-1,this.writeVarint(o),this.pos+=o},writeFloat:function(n){this.realloc(4),ly.write(this.buf,n,this.pos,!0,23,4),this.pos+=4},writeDouble:function(n){this.realloc(8),ly.write(this.buf,n,this.pos,!0,52,8),this.pos+=8},writeBytes:function(n){var r=n.length;this.writeVarint(r),this.realloc(r);for(var o=0;o<r;o++)this.buf[this.pos++]=n[o]},writeRawMessage:function(n,r){this.pos++;var o=this.pos;n(r,this);var u=this.pos-o;u>=128&&PM(o,u,this),this.pos=o-1,this.writeVarint(u),this.pos+=u},writeMessage:function(n,r,o){this.writeTag(n,an.Bytes),this.writeRawMessage(r,o)},writePackedVarint:function(n,r){r.length&&this.writeMessage(n,tB,r)},writePackedSVarint:function(n,r){r.length&&this.writeMessage(n,iB,r)},writePackedBoolean:function(n,r){r.length&&this.writeMessage(n,sB,r)},writePackedFloat:function(n,r){r.length&&this.writeMessage(n,rB,r)},writePackedDouble:function(n,r){r.length&&this.writeMessage(n,nB,r)},writePackedFixed32:function(n,r){r.length&&this.writeMessage(n,oB,r)},writePackedSFixed32:function(n,r){r.length&&this.writeMessage(n,aB,r)},writePackedFixed64:function(n,r){r.length&&this.writeMessage(n,lB,r)},writePackedSFixed64:function(n,r){r.length&&this.writeMessage(n,cB,r)},writeBytesField:function(n,r){this.writeTag(n,an.Bytes),this.writeBytes(r)},writeFixed32Field:function(n,r){this.writeTag(n,an.Fixed32),this.writeFixed32(r)},writeSFixed32Field:function(n,r){this.writeTag(n,an.Fixed32),this.writeSFixed32(r)},writeFixed64Field:function(n,r){this.writeTag(n,an.Fixed64),this.writeFixed64(r)},writeSFixed64Field:function(n,r){this.writeTag(n,an.Fixed64),this.writeSFixed64(r)},writeVarintField:function(n,r){this.writeTag(n,an.Varint),this.writeVarint(r)},writeSVarintField:function(n,r){this.writeTag(n,an.Varint),this.writeSVarint(r)},writeStringField:function(n,r){this.writeTag(n,an.Bytes),this.writeString(r)},writeFloatField:function(n,r){this.writeTag(n,an.Fixed32),this.writeFloat(r)},writeDoubleField:function(n,r){this.writeTag(n,an.Fixed64),this.writeDouble(r)},writeBooleanField:function(n,r){this.writeVarintField(n,!!r)}};var xd=pe(AM);const Ix=3;function uB(n,r,o){r.glyphs=[],n===1&&o.readMessage(hB,r)}function hB(n,r,o){if(n===3){const{id:u,bitmap:f,width:m,height:y,left:b,top:T,advance:E}=o.readMessage(dB,{});r.glyphs.push({id:u,bitmap:new cc({width:m+2*Ix,height:y+2*Ix},f),metrics:{width:m,height:y,left:b,top:T,advance:E}})}else n===4?r.ascender=o.readSVarint():n===5&&(r.descender=o.readSVarint())}function dB(n,r,o){n===1?r.id=o.readVarint():n===2?r.bitmap=o.readBytes():n===3?r.width=o.readVarint():n===4?r.height=o.readVarint():n===5?r.left=o.readSVarint():n===6?r.top=o.readSVarint():n===7&&(r.advance=o.readVarint())}const RM=Ix,Io={horizontal:1,vertical:2,horizontalOnly:3};class fm{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(r,o){const u=new fm;return u.scale=r||1,u.fontStack=o,u}static forImage(r){const o=new fm;return o.imageName=r,o}}class bd{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(r,o){const u=new bd;for(let f=0;f<r.sections.length;f++){const m=r.sections[f];m.image?u.addImageSection(m):u.addTextSection(m,o)}return u}length(){return this.text.length}getSection(r){return this.sections[this.sectionIndex[r]]}getSections(){return this.sections}getSectionIndex(r){return this.sectionIndex[r]}getCodePoint(r){return this.text.codePointAt(r)}verticalizePunctuation(r){this.text=function(o,u){let f="";for(let m=0;m<o.length;m++){const y=o.charCodeAt(m+1)||null,b=o.charCodeAt(m-1)||null;f+=!u&&(y&&_g(y)&&!dm[o[m+1]]||b&&_g(b)&&!dm[o[m-1]])||!dm[o[m]]?o[m]:dm[o[m]]}return f}(this.text,r)}trim(){let r=0;for(let u=0;u<this.text.length&&uy[this.text.charCodeAt(u)];u++)r++;let o=this.text.length;for(let u=this.text.length-1;u>=0&&u>=r&&uy[this.text.charCodeAt(u)];u--)o--;this.text=this.text.substring(r,o),this.sectionIndex=this.sectionIndex.slice(r,o)}substring(r,o){const u=new bd;return u.text=this.text.substring(r,o),u.sectionIndex=this.sectionIndex.slice(r,o),u.sections=this.sections,u}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((r,o)=>Math.max(r,this.sections[o].scale),0)}addTextSection(r,o){this.text+=r.text,this.sections.push(fm.forText(r.scale,r.fontStack||o));const u=this.sections.length-1;for(let f=0;f<r.text.length;++f)this.sectionIndex.push(u)}addImageSection(r){const o=r.image?r.image.namePrimary:"";if(o.length===0)return void mr("Can't add FormattedSection with an empty image.");const u=this.getNextImageSectionCharCode();u?(this.text+=String.fromCodePoint(u),this.sections.push(fm.forImage(o)),this.sectionIndex.push(this.sections.length-1)):mr("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Rx(n,r,o,u,f,m,y,b,T,E,M,I,k,F,z){const V=bd.fromFeature(n,f);I===Io.vertical&&V.verticalizePunctuation(k);let W=[];const G=function(de,Ee,Pe,De,Ve,Le){if(!de)return[];const rt=[],ht=function(at,Ot,dt,Xt,Wt,_t){let hi=0;for(let ti=0;ti<at.length();ti++){const qt=at.getSection(ti);hi+=OM(at.getCodePoint(ti),qt,Xt,Wt,Ot,_t)}return hi/Math.max(1,Math.ceil(hi/dt))}(de,Ee,Pe,De,Ve,Le),Ze=de.text.indexOf("​")>=0;let ct=0;for(let at=0;at<de.length();at++){const Ot=de.getSection(at),dt=de.getCodePoint(at);if(uy[dt]||(ct+=OM(dt,Ot,De,Ve,Ee,Le)),at<de.length()-1){const Xt=!((qe=dt)<11904||!(Yt["Bopomofo Extended"](qe)||Yt.Bopomofo(qe)||Yt["CJK Compatibility Forms"](qe)||Yt["CJK Compatibility Ideographs"](qe)||Yt["CJK Compatibility"](qe)||Yt["CJK Radicals Supplement"](qe)||Yt["CJK Strokes"](qe)||Yt["CJK Symbols and Punctuation"](qe)||Yt["CJK Unified Ideographs Extension A"](qe)||Yt["CJK Unified Ideographs"](qe)||Yt["Enclosed CJK Letters and Months"](qe)||Yt["Halfwidth and Fullwidth Forms"](qe)||Yt.Hiragana(qe)||Yt["Ideographic Description Characters"](qe)||Yt["Kangxi Radicals"](qe)||Yt["Katakana Phonetic Extensions"](qe)||Yt.Katakana(qe)||Yt["Vertical Forms"](qe)||Yt["Yi Radicals"](qe)||Yt["Yi Syllables"](qe)));(fB[dt]||Xt||Ot.imageName)&&rt.push(DM(at+1,ct,ht,rt,pB(dt,de.getCodePoint(at+1),Xt&&Ze),!1))}}var qe;return LM(DM(de.length(),ct,ht,rt,0,!0))}(V,E,m,r,u,F),{processBidirectionalText:te,processStyledBidirectionalText:se}=io;if(te&&V.sections.length===1){const de=te(V.toString(),G);for(const Ee of de){const Pe=new bd;Pe.text=Ee,Pe.sections=V.sections;for(let De=0;De<Ee.length;De++)Pe.sectionIndex.push(0);W.push(Pe)}}else if(se){const de=se(V.text,V.sectionIndex,G);for(const Ee of de){const Pe=new bd;Pe.text=Ee[0],Pe.sectionIndex=Ee[1],Pe.sections=V.sections,W.push(Pe)}}else W=function(de,Ee){const Pe=[],De=de.text;let Ve=0;for(const Le of Ee)Pe.push(de.substring(Ve,Le)),Ve=Le;return Ve<De.length&&Pe.push(de.substring(Ve,De.length)),Pe}(V,G);const ne=[],ye={positionedLines:ne,text:V.toString(),top:M[1],bottom:M[1],left:M[0],right:M[0],writingMode:I,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(de,Ee,Pe,De,Ve,Le,rt,ht,Ze,ct,qe,at){let Ot=0,dt=0,Xt=0;const Wt=ht==="right"?1:ht==="left"?0:.5;let _t=!1;for(const Di of Ve){const di=Di.getSections();for(const Li of di){if(Li.imageName)continue;const xi=Ee[Li.fontStack];if(xi&&(_t=xi.ascender!==void 0&&xi.descender!==void 0,!_t))break}if(!_t)break}let hi=0;for(const Di of Ve){Di.trim();const di=Di.getMaxScale(),Li=(di-1)*Ts,xi={positionedGlyphs:[],lineOffset:0};de.positionedLines[hi]=xi;const Xi=xi.positionedGlyphs;let Ei=0;if(!Di.length()){dt+=Le,++hi;continue}let Br=0,cr=0;for(let wr=0;wr<Di.length();wr++){const ur=Di.getSection(wr),ln=Di.getSectionIndex(wr),Or=Di.getCodePoint(wr);let Tn=ur.scale,Qn=null,xs=null,tn=null,_n=Ts,ps=0;const ms=!(Ze===Io.horizontal||!qe&&!Mp(Or)||qe&&(uy[Or]||(ti=Or,Yt.Arabic(ti)||Yt["Arabic Supplement"](ti)||Yt["Arabic Extended-A"](ti)||Yt["Arabic Presentation Forms-A"](ti)||Yt["Arabic Presentation Forms-B"](ti))));if(ur.imageName){const _s=De[ur.imageName];if(!_s)continue;tn=ur.imageName,de.iconsInText=de.iconsInText||!0,xs=_s.paddedRect;const Zr=_s.displaySize;Tn=Tn*Ts/at,Qn={width:Zr[0],height:Zr[1],left:0,top:-RM,advance:ms?Zr[1]:Zr[0],localGlyph:!1},ps=_t?-Qn.height*Tn:di*Ts-17-Zr[1]*Tn,_n=Qn.advance;const po=(ms?Zr[0]:Zr[1])*Tn-Ts*di;po>0&&po>Ei&&(Ei=po)}else{const _s=Pe[ur.fontStack];if(!_s)continue;_s[Or]&&(xs=_s[Or]);const Zr=Ee[ur.fontStack];if(!Zr)continue;const po=Zr.glyphs[Or];if(!po)continue;if(Qn=po.metrics,_n=Or!==8203?Ts:0,_t){const yc=Zr.ascender!==void 0?Math.abs(Zr.ascender):0,Xs=Zr.descender!==void 0?Math.abs(Zr.descender):0,Fs=(yc+Xs)*Tn;Br<Fs&&(Br=Fs,cr=(yc-Xs)/2*Tn),ps=-yc*Tn}else ps=(di-Tn)*Ts-17}ms?(de.verticalizable=!0,Xi.push({glyph:Or,imageName:tn,x:Ot,y:dt+ps,vertical:ms,scale:Tn,localGlyph:Qn.localGlyph,fontStack:ur.fontStack,sectionIndex:ln,metrics:Qn,rect:xs}),Ot+=_n*Tn+ct):(Xi.push({glyph:Or,imageName:tn,x:Ot,y:dt+ps,vertical:ms,scale:Tn,localGlyph:Qn.localGlyph,fontStack:ur.fontStack,sectionIndex:ln,metrics:Qn,rect:xs}),Ot+=Qn.advance*Tn+ct)}Xi.length!==0&&(Xt=Math.max(Ot-ct,Xt),_t?NM(Xi,Wt,Ei,cr,Le*di/2):NM(Xi,Wt,Ei,0,Le/2)),Ot=0;const pr=Le*di+Ei;xi.lineOffset=Math.max(Ei,Li),dt+=pr,++hi}var ti;const qt=dt,{horizontalAlign:gt,verticalAlign:ai}=Ox(rt);(function(Di,di,Li,xi,Xi,Ei){const Br=(di-Li)*Xi,cr=-Ei*xi;for(const pr of Di)for(const wr of pr.positionedGlyphs)wr.x+=Br,wr.y+=cr})(de.positionedLines,Wt,gt,ai,Xt,qt),de.top+=-ai*qt,de.bottom=de.top+qt,de.left+=-gt*Xt,de.right=de.left+Xt,de.hasBaseline=_t}(ye,r,o,u,W,y,b,T,I,E,k,z),!function(de){for(const Ee of de)if(Ee.positionedGlyphs.length!==0)return!1;return!0}(ne)&&ye}const uy={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},fB={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function OM(n,r,o,u,f,m){if(r.imageName){const y=u[r.imageName];return y?y.displaySize[0]*r.scale*Ts/m+f:0}{const y=o[r.fontStack],b=y&&y.glyphs[n];return b?b.metrics.advance*r.scale+f:0}}function kM(n,r,o,u){const f=Math.pow(n-r,2);return u?n<r?f/2:2*f:f+Math.abs(o)*o}function pB(n,r,o){let u=0;return n===10&&(u-=1e4),o&&(u+=150),n!==40&&n!==65288||(u+=50),r!==41&&r!==65289||(u+=50),u}function DM(n,r,o,u,f,m){let y=null,b=kM(r,o,f,m);for(const T of u){const E=kM(r-T.x,o,f,m)+T.badness;E<=b&&(y=T,b=E)}return{index:n,x:r,priorBreak:y,badness:b}}function LM(n){return n?LM(n.priorBreak).concat(n.index):[]}function Ox(n){let r=.5,o=.5;switch(n){case"right":case"top-right":case"bottom-right":r=1;break;case"left":case"top-left":case"bottom-left":r=0}switch(n){case"bottom":case"bottom-right":case"bottom-left":o=1;break;case"top":case"top-right":case"top-left":o=0}return{horizontalAlign:r,verticalAlign:o}}function NM(n,r,o,u,f){if(!(r||o||u||f))return;const m=n.length-1,y=n[m],b=(y.x+y.metrics.advance*y.scale)*r;for(let T=0;T<=m;T++)n[T].x-=b,n[T].y+=o+u+f}function mB(n,r,o,u){const{horizontalAlign:f,verticalAlign:m}=Ox(u),y=o[0]-n.displaySize[0]*f,b=o[1]-n.displaySize[1]*m;return{imagePrimary:n,imageSecondary:r,top:b,bottom:b+n.displaySize[1],left:y,right:y+n.displaySize[0]}}function FM(n,r,o,u,f,m){const y=n.imagePrimary;let b;if(y.content){const W=y.content,G=y.pixelRatio||1;b=[W[0]/G,W[1]/G,y.displaySize[0]-W[2]/G,y.displaySize[1]-W[3]/G]}const T=r.left*m,E=r.right*m;let M,I,k,F;o==="width"||o==="both"?(F=f[0]+T-u[3],I=f[0]+E+u[1]):(F=f[0]+(T+E-y.displaySize[0])/2,I=F+y.displaySize[0]);const z=r.top*m,V=r.bottom*m;return o==="height"||o==="both"?(M=f[1]+z-u[0],k=f[1]+V+u[2]):(M=f[1]+(z+V-y.displaySize[1])/2,k=M+y.displaySize[1]),{imagePrimary:y,imageSecondary:void 0,top:M,right:I,bottom:k,left:F,collisionPadding:b}}class Cl extends xe{constructor(r,o,u,f,m){super(r,o),this.angle=f,this.z=u,m!==void 0&&(this.segment=m)}clone(){return new Cl(this.x,this.y,this.z,this.angle,this.segment)}}function BM(n,r,o,u,f){if(r.segment===void 0)return!0;let m=r,y=r.segment+1,b=0;for(;b>-o/2;){if(y--,y<0)return!1;b-=n[y].dist(m),m=n[y]}b+=n[y].dist(n[y+1]),y++;const T=[];let E=0;for(;b<o/2;){const M=n[y],I=n[y+1];if(!I)return!1;let k=n[y-1].angleTo(M)-M.angleTo(I);for(k=Math.abs((k+3*Math.PI)%(2*Math.PI)-Math.PI),T.push({distance:b,angleDelta:k}),E+=k;b-T[0].distance>u;)E-=T.shift().angleDelta;if(E>f)return!1;y++,b+=M.dist(I)}return!0}function zM(n){let r=0;for(let o=0;o<n.length-1;o++)r+=n[o].dist(n[o+1]);return r}function UM(n,r,o){return n?.6*r*o:0}function VM(n,r){return Math.max(n?n.right-n.left:0,r?r.right-r.left:0)}function _B(n,r,o,u,f,m){const y=UM(o,f,m),b=VM(o,u)*m;let T=0;const E=zM(n)/2;for(let M=0;M<n.length-1;M++){const I=n[M],k=n[M+1],F=I.dist(k);if(T+F>E){const z=(E-T)/F,V=Ut(I.x,k.x,z),W=Ut(I.y,k.y,z),G=new Cl(V,W,0,k.angleTo(I),M);return!y||BM(n,G,b,y,r)?G:void 0}T+=F}}function gB(n,r,o,u,f,m,y,b,T){const E=UM(u,m,y),M=VM(u,f),I=M*y,k=n[0].x===0||n[0].x===T||n[0].y===0||n[0].y===T;return r-I<r/4&&(r=I+r/4),jM(n,k?r/2*b%r:(M/2+2*m)*y*b%r,r,E,o,I,k,!1,T)}function jM(n,r,o,u,f,m,y,b,T){const E=m/2,M=zM(n);let I=0,k=r-o,F=[];for(let z=0;z<n.length-1;z++){const V=n[z],W=n[z+1],G=V.dist(W),te=W.angleTo(V);for(;k+o<I+G;){k+=o;const se=(k-I)/G,ne=Ut(V.x,W.x,se),ye=Ut(V.y,W.y,se);if(ne>=0&&ne<T&&ye>=0&&ye<T&&k-E>=0&&k+E<=M){const de=new Cl(ne,ye,0,te,z);u&&!BM(n,de,m,u,f)||F.push(de)}}I+=G}return b||F.length||y||(F=jM(n,I/2,o,u,f,m,y,!0,T)),F}function $M(n,r,o,u,f){const m=[];for(let y=0;y<n.length;y++){const b=n[y];let T;for(let E=0;E<b.length-1;E++){let M=b[E],I=b[E+1];M.x<r&&I.x<r||(M.x<r?M=new xe(r,M.y+(r-M.x)/(I.x-M.x)*(I.y-M.y))._round():I.x<r&&(I=new xe(r,M.y+(r-M.x)/(I.x-M.x)*(I.y-M.y))._round()),M.y<o&&I.y<o||(M.y<o?M=new xe(M.x+(o-M.y)/(I.y-M.y)*(I.x-M.x),o)._round():I.y<o&&(I=new xe(M.x+(o-M.y)/(I.y-M.y)*(I.x-M.x),o)._round()),M.x>=u&&I.x>=u||(M.x>=u?M=new xe(u,M.y+(u-M.x)/(I.x-M.x)*(I.y-M.y))._round():I.x>=u&&(I=new xe(u,M.y+(u-M.x)/(I.x-M.x)*(I.y-M.y))._round()),M.y>=f&&I.y>=f||(M.y>=f?M=new xe(M.x+(f-M.y)/(I.y-M.y)*(I.x-M.x),f)._round():I.y>=f&&(I=new xe(M.x+(f-M.y)/(I.y-M.y)*(I.x-M.x),f)._round()),T&&M.equals(T[T.length-1])||(T=[M],m.push(T)),T.push(I)))))}}return m}function WM(n){let r=0,o=0;for(const y of n)r+=y.w*y.h,o=Math.max(o,y.w);n.sort((y,b)=>b.h-y.h);const u=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(r/.95)),o),h:1/0}];let f=0,m=0;for(const y of n)for(let b=u.length-1;b>=0;b--){const T=u[b];if(!(y.w>T.w||y.h>T.h)){if(y.x=T.x,y.y=T.y,m=Math.max(m,y.y+y.h),f=Math.max(f,y.x+y.w),y.w===T.w&&y.h===T.h){const E=u.pop();b<u.length&&(u[b]=E)}else y.h===T.h?(T.x+=y.w,T.w-=y.w):y.w===T.w?(T.y+=y.h,T.h-=y.h):(u.push({x:T.x+y.w,y:T.y,w:T.w-y.w,h:y.h}),T.y+=y.h,T.h-=y.h);break}}return{w:f,h:m,fill:r/(f*m)||0}}Ht(Cl,"Anchor");const fo=1;class kx{constructor(r,{pixelRatio:o,version:u,stretchX:f,stretchY:m,content:y}){this.paddedRect=r,this.pixelRatio=o,this.stretchX=f,this.stretchY=m,this.content=y,this.version=u}get tl(){return[this.paddedRect.x+fo,this.paddedRect.y+fo]}get br(){return[this.paddedRect.x+this.paddedRect.w-fo,this.paddedRect.y+this.paddedRect.h-fo]}get displaySize(){return[(this.paddedRect.w-2*fo)/this.pixelRatio,(this.paddedRect.h-2*fo)/this.pixelRatio]}}class HM{constructor(r,o){const u={},f={};this.haveRenderCallbacks=[];const m=[];this.addImages(r,u,m),this.addImages(o,f,m);const{w:y,h:b}=WM(m),T=new Po({width:y||1,height:b||1});for(const E in r){const M=r[E],I=u[E].paddedRect;Po.copy(M.data,T,{x:0,y:0},{x:I.x+fo,y:I.y+fo},M.data,M.sdf)}for(const E in o){const M=o[E],I=f[E].paddedRect,k=I.x+fo,F=I.y+fo,z=M.data.width,V=M.data.height;Po.copy(M.data,T,{x:0,y:0},{x:k,y:F},M.data),Po.copy(M.data,T,{x:0,y:V-1},{x:k,y:F-1},{width:z,height:1}),Po.copy(M.data,T,{x:0,y:0},{x:k,y:F+V},{width:z,height:1}),Po.copy(M.data,T,{x:z-1,y:0},{x:k-1,y:F},{width:1,height:V}),Po.copy(M.data,T,{x:0,y:0},{x:k+z,y:F},{width:1,height:V})}this.image=T,this.iconPositions=u,this.patternPositions=f}addImages(r,o,u){for(const f in r){const m=r[f],y={x:0,y:0,w:m.data.width+2*fo,h:m.data.height+2*fo};u.push(y),o[f]=new kx(y,m),m.hasRenderCallback&&this.haveRenderCallbacks.push(f)}}patchUpdatedImages(r,o,u){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(f=>r.hasImage(f,u)),r.dispatchRenderCallbacks(this.haveRenderCallbacks,u);for(const f in r.getUpdatedImages(u))this.patchUpdatedImage(this.iconPositions[f],r.getImage(f,u),o),this.patchUpdatedImage(this.patternPositions[f],r.getImage(f,u),o)}patchUpdatedImage(r,o,u){if(!r||!o||r.version===o.version)return;r.version=o.version;const[f,m]=r.tl,y=!!Object.keys(this.patternPositions).length;u.update(o.data,{useMipmap:y},{x:f,y:m})}}Ht(kx,"ImagePosition"),Ht(HM,"ImageAtlas");const pm=1e20;function qM(n,r,o,u,f,m,y,b,T){for(let E=r;E<r+u;E++)GM(n,o*m+E,m,f,y,b,T);for(let E=o;E<o+f;E++)GM(n,E*m+r,1,u,y,b,T)}function GM(n,r,o,u,f,m,y){m[0]=0,y[0]=-pm,y[1]=pm,f[0]=n[r];for(let b=1,T=0,E=0;b<u;b++){f[b]=n[r+b*o];const M=b*b;do{const I=m[T];E=(f[b]-f[I]+M-I*I)/(b-I)/2}while(E<=y[T]&&--T>-1);T++,m[T]=b,y[T]=E,y[T+1]=pm}for(let b=0,T=0;b<u;b++){for(;y[T+1]<b;)T++;const E=m[T],M=b-E;n[r+b*o]=f[E]+M*M}}const ua=2,Dx={none:0,ideographs:1,all:2};class wd{constructor(r,o,u){this.requestManager=r,this.localGlyphMode=o,this.localFontFamily=u,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(r,o){this.urls[o]=r}getGlyphs(r,o,u){const f=[],m=this.urls[o]||O.GLYPHS_URL;for(const y in r)for(const b of r[y])f.push({stack:y,id:b});Tr(f,({stack:y,id:b},T)=>{let E=this.entries[y];E||(E=this.entries[y]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let M=E.glyphs[b];if(M!==void 0)return void T(null,{stack:y,id:b,glyph:M});if(M=this._tinySDF(E,y,b),M)return E.glyphs[b]=M,void T(null,{stack:y,id:b,glyph:M});const I=Math.floor(b/256);if(256*I>65535)return void T(new Error("glyphs > 65535 not supported"));if(E.ranges[I])return void T(null,{stack:y,id:b,glyph:M});let k=E.requests[I];k||(k=E.requests[I]=[],wd.loadGlyphRange(y,I,m,this.requestManager,(F,z)=>{if(z){E.ascender=z.ascender,E.descender=z.descender;for(const V in z.glyphs)this._doesCharSupportLocalGlyph(+V)||(E.glyphs[+V]=z.glyphs[+V]);E.ranges[I]=!0}for(const V of k)V(F,z);delete E.requests[I]})),k.push((F,z)=>{F?T(F):z&&T(null,{stack:y,id:b,glyph:z.glyphs[b]||null})})},(y,b)=>{if(y)u(y);else if(b){const T={};for(const{stack:E,id:M,glyph:I}of b)T[E]===void 0&&(T[E]={}),T[E].glyphs===void 0&&(T[E].glyphs={}),T[E].glyphs[M]=I&&{id:I.id,bitmap:I.bitmap.clone(),metrics:I.metrics},T[E].ascender=this.entries[E].ascender,T[E].descender=this.entries[E].descender;u(null,T)}})}_doesCharSupportLocalGlyph(r){return this.localGlyphMode!==Dx.none&&(this.localGlyphMode===Dx.all?!!this.localFontFamily:!!this.localFontFamily&&(Yt["CJK Unified Ideographs"](r)||Yt["Hangul Syllables"](r)||Yt.Hiragana(r)||Yt.Katakana(r)||Yt["CJK Symbols and Punctuation"](r)||Yt["CJK Unified Ideographs Extension A"](r)||Yt["CJK Unified Ideographs Extension B"](r)))}_tinySDF(r,o,u){const f=this.localFontFamily;if(!f||!this._doesCharSupportLocalGlyph(u))return;let m=r.tinySDF;if(!m){let V="400";/bold/i.test(o)?V="900":/medium/i.test(o)?V="500":/light/i.test(o)&&(V="200"),m=r.tinySDF=new wd.TinySDF({fontFamily:f,fontWeight:V,fontSize:24*ua,buffer:3*ua,radius:8*ua}),m.fontWeight=V}if(this.localGlyphs[m.fontWeight][u])return this.localGlyphs[m.fontWeight][u];const y=String.fromCodePoint(u),{data:b,width:T,height:E,glyphWidth:M,glyphHeight:I,glyphLeft:k,glyphTop:F,glyphAdvance:z}=m.draw(y);return this.localGlyphs[m.fontWeight][u]={id:u,bitmap:new cc({width:T,height:E},b),metrics:{width:M/ua,height:I/ua,left:k/ua,top:F/ua-27,advance:z/ua,localGlyph:!0}}}}wd.loadGlyphRange=function(n,r,o,u,f){const m=256*r,y=m+255,b=u.transformRequest(u.normalizeGlyphsURL(o).replace("{fontstack}",n).replace("{range}",`${m}-${y}`),ns.Glyphs);nt(b,(T,E)=>{if(T)f(T);else if(E){const M={},I=function(k){return new xd(k).readFields(uB,{})}(E);for(const k of I.glyphs)M[k.id]=k;f(null,{glyphs:M,ascender:I.ascender,descender:I.descender})}})},wd.TinySDF=class{constructor({fontSize:n=24,buffer:r=3,radius:o=8,cutoff:u=.25,fontFamily:f="sans-serif",fontWeight:m="normal",fontStyle:y="normal"}={}){this.buffer=r,this.cutoff=u,this.radius=o;const b=this.size=n+4*r,T=this._createCanvas(b),E=this.ctx=T.getContext("2d",{willReadFrequently:!0});E.font=`${y} ${m} ${n}px ${f}`,E.textBaseline="alphabetic",E.textAlign="left",E.fillStyle="black",this.gridOuter=new Float64Array(b*b),this.gridInner=new Float64Array(b*b),this.f=new Float64Array(b),this.z=new Float64Array(b+1),this.v=new Uint16Array(b)}_createCanvas(n){const r=document.createElement("canvas");return r.width=r.height=n,r}draw(n){const{width:r,actualBoundingBoxAscent:o,actualBoundingBoxDescent:u,actualBoundingBoxLeft:f,actualBoundingBoxRight:m}=this.ctx.measureText(n),y=Math.ceil(o),b=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(m-f))),T=Math.min(this.size-this.buffer,y+Math.ceil(u)),E=b+2*this.buffer,M=T+2*this.buffer,I=Math.max(E*M,0),k=new Uint8ClampedArray(I),F={data:k,width:E,height:M,glyphWidth:b,glyphHeight:T,glyphTop:y,glyphLeft:0,glyphAdvance:r};if(b===0||T===0)return F;const{ctx:z,buffer:V,gridInner:W,gridOuter:G}=this;z.clearRect(V,V,b,T),z.fillText(n,V,V+y);const te=z.getImageData(V,V,b,T);G.fill(pm,0,I),W.fill(0,0,I);for(let se=0;se<T;se++)for(let ne=0;ne<b;ne++){const ye=te.data[4*(se*b+ne)+3]/255;if(ye===0)continue;const de=(se+V)*E+ne+V;if(ye===1)G[de]=0,W[de]=pm;else{const Ee=.5-ye;G[de]=Ee>0?Ee*Ee:0,W[de]=Ee<0?Ee*Ee:0}}qM(G,0,0,E,M,E,this.f,this.v,this.z),qM(W,V,V,b,T,E,this.f,this.v,this.z);for(let se=0;se<I;se++){const ne=Math.sqrt(G[se])-Math.sqrt(W[se]);k[se]=Math.round(255-255*(ne/this.radius+this.cutoff))}return F}};const dc=fo;function XM(n,r,o,u){const f=[],m=n.imagePrimary,y=m.pixelRatio,b=m.paddedRect.w-2*dc,T=m.paddedRect.h-2*dc,E=n.right-n.left,M=n.bottom-n.top,I=m.stretchX||[[0,b]],k=m.stretchY||[[0,T]],F=(Le,rt)=>Le+rt[1]-rt[0],z=I.reduce(F,0),V=k.reduce(F,0),W=b-z,G=T-V;let te=0,se=z,ne=0,ye=V,de=0,Ee=W,Pe=0,De=G;if(m.content&&u){const Le=m.content;te=hy(I,0,Le[0]),ne=hy(k,0,Le[1]),se=hy(I,Le[0],Le[2]),ye=hy(k,Le[1],Le[3]),de=Le[0]-te,Pe=Le[1]-ne,Ee=Le[2]-Le[0]-se,De=Le[3]-Le[1]-ye}const Ve=(Le,rt,ht,Ze)=>{const ct=dy(Le.stretch-te,se,E,n.left),qe=fy(Le.fixed-de,Ee,Le.stretch,z),at=dy(rt.stretch-ne,ye,M,n.top),Ot=fy(rt.fixed-Pe,De,rt.stretch,V),dt=dy(ht.stretch-te,se,E,n.left),Xt=fy(ht.fixed-de,Ee,ht.stretch,z),Wt=dy(Ze.stretch-ne,ye,M,n.top),_t=fy(Ze.fixed-Pe,De,Ze.stretch,V),hi=new xe(ct,at),ti=new xe(dt,at),qt=new xe(dt,Wt),gt=new xe(ct,Wt),ai=new xe(qe/y,Ot/y),Di=new xe(Xt/y,_t/y),di=r*Math.PI/180;if(di){const cr=Math.sin(di),pr=Math.cos(di),wr=[pr,-cr,cr,pr];hi._matMult(wr),ti._matMult(wr),gt._matMult(wr),qt._matMult(wr)}const Li=Le.stretch+Le.fixed,xi=ht.stretch+ht.fixed,Xi=rt.stretch+rt.fixed,Ei=Ze.stretch+Ze.fixed,Br=n.imageSecondary;return{tl:hi,tr:ti,bl:gt,br:qt,texPrimary:{x:m.paddedRect.x+dc+Li,y:m.paddedRect.y+dc+Xi,w:xi-Li,h:Ei-Xi},texSecondary:Br?{x:Br.paddedRect.x+dc+Li,y:Br.paddedRect.y+dc+Xi,w:xi-Li,h:Ei-Xi}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:ai,pixelOffsetBR:Di,minFontScaleX:Ee/y/E,minFontScaleY:De/y/M,isSDF:o}};if(u&&(m.stretchX||m.stretchY)){const Le=ZM(I,W,z),rt=ZM(k,G,V);for(let ht=0;ht<Le.length-1;ht++){const Ze=Le[ht],ct=Le[ht+1];for(let qe=0;qe<rt.length-1;qe++)f.push(Ve(Ze,rt[qe],ct,rt[qe+1]))}}else f.push(Ve({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:b+1},{fixed:0,stretch:T+1}));return f}function hy(n,r,o){let u=0;for(const f of n)u+=Math.max(r,Math.min(o,f[1]))-Math.max(r,Math.min(o,f[0]));return u}function ZM(n,r,o){const u=[{fixed:-dc,stretch:0}];for(const[f,m]of n){const y=u[u.length-1];u.push({fixed:f-y.stretch,stretch:y.stretch}),u.push({fixed:f-y.stretch,stretch:y.stretch+(m-f)})}return u.push({fixed:r+dc,stretch:o}),u}function dy(n,r,o,u){return n/r*o+u}function fy(n,r,o,u){return n-r*o/u}function yB(n,r,o,u){const f=r+n.positionedLines[u].lineOffset;return u===0?o+f/2:o+(f+(r+n.positionedLines[u-1].lineOffset))/2}function vB(n,r=1,o=!1){let u=1/0,f=1/0,m=-1/0,y=-1/0;const b=n[0];for(let F=0;F<b.length;F++){const z=b[F];(!F||z.x<u)&&(u=z.x),(!F||z.y<f)&&(f=z.y),(!F||z.x>m)&&(m=z.x),(!F||z.y>y)&&(y=z.y)}const T=Math.min(m-u,y-f);let E=T/2;const M=new ho([],xB);if(T===0)return new xe(u,f);for(let F=u;F<m;F+=T)for(let z=f;z<y;z+=T)M.push(new Td(F+E,z+E,E,n));let I=function(F){let z=0,V=0,W=0;const G=F[0];for(let te=0,se=G.length,ne=se-1;te<se;ne=te++){const ye=G[te],de=G[ne],Ee=ye.x*de.y-de.x*ye.y;V+=(ye.x+de.x)*Ee,W+=(ye.y+de.y)*Ee,z+=3*Ee}return new Td(V/z,W/z,0,F)}(n),k=M.length;for(;M.length;){const F=M.pop();(F.d>I.d||!I.d)&&(I=F,o&&console.log("found best %d after %d probes",Math.round(1e4*F.d)/1e4,k)),F.max-I.d<=r||(E=F.h/2,M.push(new Td(F.p.x-E,F.p.y-E,E,n)),M.push(new Td(F.p.x+E,F.p.y-E,E,n)),M.push(new Td(F.p.x-E,F.p.y+E,E,n)),M.push(new Td(F.p.x+E,F.p.y+E,E,n)),k+=4)}return o&&(console.log(`num probes: ${k}`),console.log(`best distance: ${I.d}`)),I.p}function xB(n,r){return r.max-n.max}class Td{constructor(r,o,u,f){this.p=new xe(r,o),this.h=u,this.d=function(m,y){let b=!1,T=1/0;for(let E=0;E<y.length;E++){const M=y[E];for(let I=0,k=M.length,F=k-1;I<k;F=I++){const z=M[I],V=M[F];z.y>m.y!=V.y>m.y&&m.x<(V.x-z.x)*(m.y-z.y)/(V.y-z.y)+z.x&&(b=!b),T=Math.min(T,oc(m,z,V))}}return(b?1:-1)*Math.sqrt(T)}(this.p,f),this.max=this.d+this.h*Math.SQRT2}}const Lx=Number.POSITIVE_INFINITY,bB=Math.sqrt(2);function YM(n,[r,o]){let u=0,f=0;if(o===Lx){r<0&&(r=0);const m=r/bB;switch(n){case"top-right":case"top-left":f=m-7;break;case"bottom-right":case"bottom-left":f=7-m;break;case"bottom":f=7-r;break;case"top":f=r-7}switch(n){case"top-right":case"bottom-right":u=-m;break;case"top-left":case"bottom-left":u=m;break;case"left":u=r;break;case"right":u=-r}}else{switch(r=Math.abs(r),o=Math.abs(o),n){case"top-right":case"top-left":case"top":f=o-7;break;case"bottom-right":case"bottom-left":case"bottom":f=7-o}switch(n){case"top-right":case"bottom-right":case"right":u=-r;break;case"top-left":case"bottom-left":case"left":u=r}}return[u,f]}function Nx(n){switch(n){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function wB(n,r,o,u,f,m,y,b,T,E,M,I,k,F,z){let V=m.textMaxSize.evaluate(r,{},I);V===void 0&&(V=y);const W=n.layers[0].layout,G=W.get("icon-offset").evaluate(r,{},I),te=JM(o.horizontal)||o.vertical,se=k.name==="globe",ne=Ts,ye=y/ne,de=n.tilePixelRatio*V/ne,Ee=(ct=n.overscaling,n.zoom>18&&ct>2&&(ct>>=1),Math.max(Bt/(512*ct),1)*W.get("symbol-spacing")),Pe=W.get("text-padding")*n.tilePixelRatio,De=W.get("icon-padding")*n.tilePixelRatio,Ve=Qe(W.get("text-max-angle")),Le=W.get("text-rotation-alignment")==="map"&&W.get("symbol-placement")!=="point",rt=W.get("icon-rotation-alignment")==="map"&&W.get("symbol-placement")!=="point",ht=W.get("symbol-placement"),Ze=Ee/2;var ct;const qe=W.get("icon-text-fit").evaluate(r,{},I),at=W.get("icon-text-fit-padding").evaluate(r,{},I),Ot=qe!=="none";let dt;n.hasAnyIconTextFit===!1&&Ot&&(n.hasAnyIconTextFit=!0),u&&Ot&&(n.allowVerticalPlacement&&o.vertical&&(dt=FM(u,o.vertical,qe,at,G,ye)),te&&(u=FM(u,te,qe,at,G,ye)));const Xt=(Wt,_t,hi)=>{if(_t.x<0||_t.x>=Bt||_t.y<0||_t.y>=Bt)return;let ti=null;if(se){const{x:qt,y:gt,z:ai}=k.projectTilePoint(_t.x,_t.y,hi);ti={anchor:new Cl(qt,gt,ai,0,void 0),up:k.upVector(hi,_t.x,_t.y)}}(function(qt,gt,ai,Di,di,Li,xi,Xi,Ei,Br,cr,pr,wr,ur,ln,Or,Tn,Qn,xs,tn,_n,ps,ms,_s,Zr,po,yc){const Xs=qt.addToLineVertexArray(gt,Di);let Fs,Oo,Im,Dy,JC,QC,e3,t3=0,i3=0,r3=0,n3=0,ob=-1,ab=-1;const qa={};let s3=em("");const Wu=ai?ai.anchor:gt,lb=Ei.layout.get("icon-text-fit").evaluate(_n,{},Zr)!=="none";let cb=0,ub=0;if(Ei._unevaluatedLayout.getValue("text-radial-offset")===void 0?[cb,ub]=Ei.layout.get("text-offset").evaluate(_n,{},Zr).map(mo=>mo*Ts):(cb=Ei.layout.get("text-radial-offset").evaluate(_n,{},Zr)*Ts,ub=Lx),qt.allowVerticalPlacement&&di.vertical){const mo=di.vertical;if(ln)QC=Fx(mo),Xi&&(e3=Fx(Xi));else{const _o=Ei.layout.get("text-rotate").evaluate(_n,{},Zr)+90;Im=py(Br,Wu,gt,cr,pr,wr,mo,ur,_o,Or),Xi&&(Dy=py(Br,Wu,gt,cr,pr,wr,Xi,Qn,_o))}}if(Li){const mo=Ei.layout.get("icon-rotate").evaluate(_n,{},Zr),_o=XM(Li,mo,ms,lb),Rd=Xi?XM(Xi,mo,ms,lb):void 0;Oo=py(Br,Wu,gt,cr,pr,wr,Li,Qn,mo),t3=4*_o.length;const o3=qt.iconSizeData;let Hu=null;o3.kind==="source"?(Hu=[ca*Ei.layout.get("icon-size").evaluate(_n,{},Zr)],Hu[0]>fc&&mr(`${qt.layerIds[0]}: Value for "icon-size" is >= ${mm}. Reduce your "icon-size".`)):o3.kind==="composite"&&(Hu=[ca*ps.compositeIconSizes[0].evaluate(_n,{},Zr),ca*ps.compositeIconSizes[1].evaluate(_n,{},Zr)],(Hu[0]>fc||Hu[1]>fc)&&mr(`${qt.layerIds[0]}: Value for "icon-size" is >= ${mm}. Reduce your "icon-size".`)),qt.addSymbols(qt.icon,_o,Hu,tn,xs,_n,!1,ai,gt,Xs.lineStartIndex,Xs.lineLength,-1,_s,Zr,po,yc),ob=qt.icon.placedSymbolArray.length-1,Rd&&(i3=4*Rd.length,qt.addSymbols(qt.icon,Rd,Hu,tn,xs,_n,Io.vertical,ai,gt,Xs.lineStartIndex,Xs.lineLength,-1,_s,Zr,po,yc),ab=qt.icon.placedSymbolArray.length-1)}for(const mo in di.horizontal){const _o=di.horizontal[mo];Fs||(s3=em(_o.text),ln?JC=Fx(_o):Fs=py(Br,Wu,gt,cr,pr,wr,_o,ur,Ei.layout.get("text-rotate").evaluate(_n,{},Zr),Or));const Rd=_o.positionedLines.length===1;if(r3+=KM(qt,ai,gt,_o,xi,Ei,ln,_n,Or,Xs,di.vertical?Io.horizontal:Io.horizontalOnly,Rd?Object.keys(di.horizontal):[mo],qa,ob,ps,_s,Zr,po),Rd)break}di.vertical&&(n3+=KM(qt,ai,gt,di.vertical,xi,Ei,ln,_n,Or,Xs,Io.vertical,["vertical"],qa,ab,ps,_s,Zr,po));let vc=-1;const hb=(mo,_o)=>mo?Math.max(mo,_o):_o;vc=hb(JC,vc),vc=hb(QC,vc),vc=hb(e3,vc);const Uz=vc>-1?1:0;qt.glyphOffsetArray.length>=65535&&mr("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),_n.sortKey!==void 0&&qt.addToSortKeyRanges(qt.symbolInstances.length,_n.sortKey),qt.symbolInstances.emplaceBack(gt.x,gt.y,Wu.x,Wu.y,Wu.z,qa.right>=0?qa.right:-1,qa.center>=0?qa.center:-1,qa.left>=0?qa.left:-1,qa.vertical>=0?qa.vertical:-1,ob,ab,s3,Fs!==void 0?Fs:qt.collisionBoxArray.length,Fs!==void 0?Fs+1:qt.collisionBoxArray.length,Im!==void 0?Im:qt.collisionBoxArray.length,Im!==void 0?Im+1:qt.collisionBoxArray.length,Oo!==void 0?Oo:qt.collisionBoxArray.length,Oo!==void 0?Oo+1:qt.collisionBoxArray.length,Dy||qt.collisionBoxArray.length,Dy?Dy+1:qt.collisionBoxArray.length,cr,r3,n3,t3,i3,Uz,0,cb,ub,vc,0,lb?1:0)})(n,_t,ti,Wt,o,u,f,dt,n.layers[0],n.collisionBoxArray,r.index,r.sourceLayerIndex,n.index,Pe,Le,T,0,De,rt,G,r,m,E,M,I,F,z)};if(ht==="line")for(const Wt of $M(r.geometry,0,0,Bt,Bt)){const _t=gB(Wt,Ee,Ve,o.vertical||te,u,ne,de,n.overscaling,Bt);for(const hi of _t)te&&TB(n,te.text,Ze,hi)||Xt(Wt,hi,I)}else if(ht==="line-center"){for(const Wt of r.geometry)if(Wt.length>1){const _t=_B(Wt,Ve,o.vertical||te,u,ne,de);_t&&Xt(Wt,_t,I)}}else if(r.type==="Polygon")for(const Wt of bx(r.geometry,0)){const _t=vB(Wt,16);Xt(Wt[0],new Cl(_t.x,_t.y,0,0,void 0),I)}else if(r.type==="LineString")for(const Wt of r.geometry)Xt(Wt,new Cl(Wt[0].x,Wt[0].y,0,0,void 0),I);else if(r.type==="Point")for(const Wt of r.geometry)for(const _t of Wt)Xt([_t],new Cl(_t.x,_t.y,0,0,void 0),I)}const mm=255,fc=mm*ca;function KM(n,r,o,u,f,m,y,b,T,E,M,I,k,F,z,V,W,G){const te=function(ye,de,Ee,Pe,De,Ve,Le,rt){const ht=[];if(de.positionedLines.length===0)return ht;const Ze=Pe.layout.get("text-rotate").evaluate(Ve,{})*Math.PI/180,ct=function(Xt){const Wt=Xt[0],_t=Xt[1],hi=Wt*_t;return hi>0?[Wt,-_t]:hi<0?[-Wt,_t]:Wt===0?[_t,Wt]:[_t,-Wt]}(Ee);let qe=Math.abs(de.top-de.bottom);for(const Xt of de.positionedLines)qe-=Xt.lineOffset;const at=de.positionedLines.length,Ot=qe/at;let dt=de.top-Ee[1];for(let Xt=0;Xt<at;++Xt){const Wt=de.positionedLines[Xt];dt=yB(de,Ot,dt,Xt);for(const _t of Wt.positionedGlyphs){if(!_t.rect)continue;const hi=_t.rect||{};let ti=RM+1,qt=!0,gt=1,ai=0;if(_t.imageName){const tn=Le[_t.imageName];if(!tn)continue;if(tn.sdf){mr("SDF images are not supported in formatted text and will be ignored.");continue}qt=!1,gt=tn.pixelRatio,ti=fo/gt}const Di=(De||rt)&&_t.vertical,di=_t.metrics.advance*_t.scale/2,Li=_t.metrics,xi=_t.rect;if(xi===null)continue;rt&&de.verticalizable&&(ai=_t.imageName?di-_t.metrics.width*_t.scale/2:0);const Xi=De?[_t.x+di,_t.y]:[0,0];let Ei=[0,0],Br=[0,0],cr=!1;De||(Di?(Br=[_t.x+di+ct[0],_t.y+ct[1]-ai],cr=!0):Ei=[_t.x+di+Ee[0],_t.y+Ee[1]-ai]);const pr=xi.w*_t.scale/(gt*(_t.localGlyph?ua:1)),wr=xi.h*_t.scale/(gt*(_t.localGlyph?ua:1));let ur,ln,Or,Tn;if(Di){const tn=_t.y-dt,_n=new xe(-di,di-tn),ps=-Math.PI/2,ms=new xe(...Br);ur=new xe(-di+Ei[0],Ei[1]),ur._rotateAround(ps,_n)._add(ms),ur.x+=-tn+di,ur.y-=(Li.left-ti)*_t.scale;const _s=_t.imageName?Li.advance*_t.scale:Ts*_t.scale,Zr=String.fromCodePoint(_t.glyph);J4(Zr)?ur.x+=(1-ti)*_t.scale:Q4(Zr)?ur.x+=_s-Li.height*_t.scale+(-ti-1)*_t.scale:ur.x+=_t.imageName||Li.width+2*ti===xi.w&&Li.height+2*ti===xi.h?(_s-wr)/2:(_s-(Li.height+2*ti)*_t.scale)/2,ln=new xe(ur.x,ur.y-pr),Or=new xe(ur.x+wr,ur.y),Tn=new xe(ur.x+wr,ur.y-pr)}else{const tn=(Li.left-ti)*_t.scale-di+Ei[0],_n=(-Li.top-ti)*_t.scale+Ei[1],ps=tn+pr,ms=_n+wr;ur=new xe(tn,_n),ln=new xe(ps,_n),Or=new xe(tn,ms),Tn=new xe(ps,ms)}if(Ze){let tn;tn=De?new xe(0,0):cr?new xe(ct[0],ct[1]):new xe(Ee[0],Ee[1]),ur._rotateAround(Ze,tn),ln._rotateAround(Ze,tn),Or._rotateAround(Ze,tn),Tn._rotateAround(Ze,tn)}const Qn=new xe(0,0),xs=new xe(0,0);ht.push({tl:ur,tr:ln,bl:Or,br:Tn,texPrimary:hi,texSecondary:void 0,writingMode:de.writingMode,glyphOffset:Xi,sectionIndex:_t.sectionIndex,isSDF:qt,pixelOffsetTL:Qn,pixelOffsetBR:xs,minFontScaleX:0,minFontScaleY:0})}}return ht}(0,u,T,m,y,b,f,n.allowVerticalPlacement),se=n.textSizeData;let ne=null;se.kind==="source"?(ne=[ca*m.layout.get("text-size").evaluate(b,{},W)],ne[0]>fc&&mr(`${n.layerIds[0]}: Value for "text-size" is >= ${mm}. Reduce your "text-size".`)):se.kind==="composite"&&(ne=[ca*z.compositeTextSizes[0].evaluate(b,{},W),ca*z.compositeTextSizes[1].evaluate(b,{},W)],(ne[0]>fc||ne[1]>fc)&&mr(`${n.layerIds[0]}: Value for "text-size" is >= ${mm}. Reduce your "text-size".`)),n.addSymbols(n.text,te,ne,T,y,b,M,r,o,E.lineStartIndex,E.lineLength,F,V,W,G,!1);for(const ye of I)k[ye]=n.text.placedSymbolArray.length-1;return 4*te.length}function JM(n){for(const r in n)return n[r];return null}function py(n,r,o,u,f,m,y,b,T,E){let M=y.top,I=y.bottom,k=y.left,F=y.right;const z=y.collisionPadding;if(z&&(k-=z[0],M-=z[1],F+=z[2],I+=z[3]),T){const V=new xe(k,M),W=new xe(F,M),G=new xe(k,I),te=new xe(F,I),se=Qe(T);let ne=new xe(0,0);E&&(ne=new xe(E[0],E[1])),V._rotateAround(se,ne),W._rotateAround(se,ne),G._rotateAround(se,ne),te._rotateAround(se,ne),k=Math.min(V.x,W.x,G.x,te.x),F=Math.max(V.x,W.x,G.x,te.x),M=Math.min(V.y,W.y,G.y,te.y),I=Math.max(V.y,W.y,G.y,te.y)}return n.emplaceBack(r.x,r.y,r.z,o.x,o.y,k,M,F,I,b,u,f,m),n.length-1}function Fx(n){n.collisionPadding&&(n.top-=n.collisionPadding[1],n.bottom+=n.collisionPadding[3]);const r=n.bottom-n.top;return r>0?Math.max(10,r):null}function TB(n,r,o,u){const f=n.compareText;if(r in f){const m=f[r];for(let y=m.length-1;y>=0;y--)if(u.dist(m[y])<o)return!0}else f[r]=[];return f[r].push(u),!1}function QM(n,r){const o=n.fovAboveCenter,u=n.elevation?n.elevation.getMinElevationBelowMSL()*r:0,f=(n._camera.position[2]*n.worldSize-u)/Math.cos(n._pitch),m=Math.sin(o)*f/Math.sin(Math.max(Math.PI/2-n._pitch-o,.01)),y=Math.sin(n._pitch)*m+f;return Math.min(1.01*y,f*(1/n._horizonShift))}function _m(n,r){if(!r.isReprojectedInTileSpace)return{scale:1<<n.z,x:n.x,y:n.y,x2:n.x+1,y2:n.y+1,projection:r};const o=Math.pow(2,-n.z),u=n.x*o,f=(n.x+1)*o,m=n.y*o,y=(n.y+1)*o,b=wi(u),T=wi(f),E=Qi(m),M=Qi(y),I=r.project(b,E),k=r.project(T,E),F=r.project(T,M),z=r.project(b,M);let V=Math.min(I.x,k.x,F.x,z.x),W=Math.min(I.y,k.y,F.y,z.y),G=Math.max(I.x,k.x,F.x,z.x),te=Math.max(I.y,k.y,F.y,z.y);const se=o/16;function ne(de,Ee,Pe,De,Ve,Le){const rt=(Pe+Ve)/2,ht=(De+Le)/2,Ze=r.project(wi(rt),Qi(ht)),ct=Math.max(0,V-Ze.x,W-Ze.y,Ze.x-G,Ze.y-te);V=Math.min(V,Ze.x),G=Math.max(G,Ze.x),W=Math.min(W,Ze.y),te=Math.max(te,Ze.y),ct>se&&(ne(de,Ze,Pe,De,rt,ht),ne(Ze,Ee,rt,ht,Ve,Le))}ne(I,k,u,m,f,m),ne(k,F,f,m,f,y),ne(F,z,f,y,u,y),ne(z,I,u,y,u,m),V-=se,W-=se,G+=se,te+=se;const ye=1/Math.max(G-V,te-W);return{scale:ye,x:V*ye,y:W*ye,x2:G*ye,y2:te*ye,projection:r}}function eC(n,{x:r,y:o},u=0){return new xe(((r-u)*n.scale-n.x)*Bt,(o*n.scale-n.y)*Bt)}const EB=l.a6.identity(new Float32Array(16));class pc{constructor(r){this.spec=r,this.name=r.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(r,o){return{x:0,y:0,z:0}}unproject(r,o){return new ke(0,0)}projectTilePoint(r,o,u){return{x:r,y:o,z:0}}locationPoint(r,o,u=!0){return r._coordinatePoint(r.locationCoordinate(o),u)}pixelsPerMeter(r,o){return Ti(1,r)*o}pixelSpaceConversion(r,o,u){return 1}farthestPixelDistance(r){return QM(r,r.pixelsPerMeter)}pointCoordinate(r,o,u,f){const m=r.horizonLineFromTop(!1),y=new xe(o,Math.max(m,u));return r.rayIntersectionCoordinate(r.pointRayIntersection(y,f))}pointCoordinate3D(r,o,u){const f=new xe(o,u);if(r.elevation)return r.elevation.pointCoordinate(f);{const m=this.pointCoordinate(r,f.x,f.y,0);return[m.x,m.y,m.z]}}isPointAboveHorizon(r,o){if(r.elevation)return!this.pointCoordinate3D(r,o.x,o.y);const u=r.horizonLineFromTop();return o.y<u}createInversionMatrix(r,o){return EB}createTileMatrix(r,o,u){let f,m,y;const b=u.canonical,T=l.a6.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const E=_m(b,this);f=1,m=E.x+u.wrap*E.scale,y=E.y,l.a6.scale(T,T,[f/E.scale,f/E.scale,r.pixelsPerMeter/o])}else f=o/r.zoomScale(b.z),m=(b.x+Math.pow(2,b.z)*u.wrap)*f,y=b.y*f;return l.a6.translate(T,T,[m,y,0]),l.a6.scale(T,T,[f/Bt,f/Bt,1]),T}upVector(r,o,u){return[0,0,1]}upVectorScale(r,o,u){return{metersToTile:1}}}class SB extends pc{constructor(r){super(r),this.range=[4,7],this.center=r.center||[-96,37.5];const[o,u]=this.parallels=r.parallels||[29.5,45.5],f=Math.sin(Qe(o));this.n=(f+Math.sin(Qe(u)))/2,this.c=1+f*(2*this.n-f),this.r0=Math.sqrt(this.c)/this.n}project(r,o){const{n:u,c:f,r0:m}=this,y=Qe(r-this.center[0]),b=Qe(o),T=Math.sqrt(f-2*u*Math.sin(b))/u;return{x:T*Math.sin(y*u),y:T*Math.cos(y*u)-m,z:0}}unproject(r,o){const{n:u,c:f,r0:m}=this,y=m+o;let b=Math.atan2(r,Math.abs(y))*Math.sign(y);y*u<0&&(b-=Math.PI*Math.sign(r)*Math.sign(y));const T=Qe(this.center[0])*u;b=Gr(b,-Math.PI-T,Math.PI-T);const E=ri(Ct(b/u)+this.center[0],-180,180),M=Math.asin(ri((f-(r*r+y*y)*u*u)/(2*u),-1,1)),I=ri(Ct(M),-Ui,Ui);return new ke(E,I)}}const gm=1.340264,ym=-.081106,vm=893e-6,xm=.003796,my=Math.sqrt(3)/2;class AB extends pc{project(r,o){o=o/180*Math.PI,r=r/180*Math.PI;const u=Math.asin(my*Math.sin(o)),f=u*u,m=f*f*f;return{x:.5*(r*Math.cos(u)/(my*(gm+3*ym*f+m*(7*vm+9*xm*f)))/Math.PI+.5),y:1-.5*(u*(gm+ym*f+m*(vm+xm*f))/Math.PI+1),z:0}}unproject(r,o){r=(2*r-.5)*Math.PI;let u=o=(2*(1-o)-1)*Math.PI,f=u*u,m=f*f*f;for(let M,I,k,F=0;F<12&&(I=u*(gm+ym*f+m*(vm+xm*f))-o,k=gm+3*ym*f+m*(7*vm+9*xm*f),M=I/k,u=ri(u-M,-Math.PI/3,Math.PI/3),f=u*u,m=f*f*f,!(Math.abs(M)<1e-12));++F);const y=my*r*(gm+3*ym*f+m*(7*vm+9*xm*f))/Math.cos(u),b=Math.asin(Math.sin(u)/my),T=ri(180*y/Math.PI,-180,180),E=ri(180*b/Math.PI,-Ui,Ui);return new ke(T,E)}}class MB extends pc{constructor(r){super(r),this.wrap=!0,this.supportsWorldCopies=!0}project(r,o){return{x:.5+r/360,y:.5-o/360,z:0}}unproject(r,o){const u=360*(r-.5),f=ri(360*(.5-o),-Ui,Ui);return new ke(u,f)}}const Ed=Math.PI/2;function _y(n){return Math.tan((Ed+n)/2)}class CB extends pc{constructor(r){super(r),this.center=r.center||[0,30];const[o,u]=this.parallels=r.parallels||[30,30];let f=Qe(o),m=Qe(u);this.southernCenter=f+m<0,this.southernCenter&&(f=-f,m=-m);const y=Math.cos(f),b=_y(f);this.n=f===m?Math.sin(f):Math.log(y/Math.cos(m))/Math.log(_y(m)/b),this.f=y*Math.pow(_y(f),this.n)/this.n}project(r,o){o=Qe(o),this.southernCenter&&(o=-o),r=Qe(r-this.center[0]);const u=1e-6,{n:f,f:m}=this;m>0?o<-Ed+u&&(o=-Ed+u):o>Ed-u&&(o=Ed-u);const y=m/Math.pow(_y(o),f);let b=y*Math.sin(f*r),T=m-y*Math.cos(f*r);return b=.5*(b/Math.PI+.5),T=.5*(T/Math.PI+.5),{x:b,y:this.southernCenter?T:1-T,z:0}}unproject(r,o){r=(2*r-.5)*Math.PI,this.southernCenter&&(o=1-o),o=(2*(1-o)-.5)*Math.PI;const{n:u,f}=this,m=f-o,y=Math.sign(m),b=Math.sign(u)*Math.sqrt(r*r+m*m);let T=Math.atan2(r,Math.abs(m))*y;m*u<0&&(T-=Math.PI*Math.sign(r)*y);const E=ri(Ct(T/u)+this.center[0],-180,180),M=ri(Ct(2*Math.atan(Math.pow(f/b,1/u))-Ed),-Ui,Ui);return new ke(E,this.southernCenter?-M:M)}}class tC extends pc{constructor(r){super(r),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(r,o){return{x:Ii(r),y:gi(o),z:0}}unproject(r,o){const u=wi(r),f=Qi(o);return new ke(u,f)}}const iC=Qe(Ui);class PB extends pc{project(r,o){const u=(o=Qe(o))*o,f=u*u;return{x:.5*((r=Qe(r))*(.8707-.131979*u+f*(f*(.003971*u-.001529*f)-.013791))/Math.PI+.5),y:1-.5*(o*(1.007226+u*(.015085+f*(.028874*u-.044475-.005916*f)))/Math.PI+1),z:0}}unproject(r,o){r=(2*r-.5)*Math.PI;let u=o=(2*(1-o)-1)*Math.PI,f=25,m=0,y=u*u;do{y=u*u;const E=y*y;m=(u*(1.007226+y*(.015085+E*(.028874*y-.044475-.005916*E)))-o)/(1.007226+y*(.045255+E*(.259866*y-.311325-.005916*11*E))),u=ri(u-m,-iC,iC)}while(Math.abs(m)>1e-6&&--f>0);y=u*u;const b=ri(Ct(r/(.8707+y*(y*(y*y*y*(.003971-.001529*y)-.013791)-.131979))),-180,180),T=Ct(u);return new ke(b,T)}}const rC=Qe(Ui);class IB extends pc{project(r,o){o=Qe(o),r=Qe(r);const u=Math.cos(o),f=2/Math.PI,m=Math.acos(u*Math.cos(r/2)),y=Math.sin(m)/m,b=.5*(r*f+2*u*Math.sin(r/2)/y)||0,T=.5*(o+Math.sin(o)/y)||0;return{x:.5*(b/Math.PI+.5),y:1-.5*(T/Math.PI+1),z:0}}unproject(r,o){let u=r=(2*r-.5)*Math.PI,f=o=(2*(1-o)-1)*Math.PI,m=25;const y=1e-6;let b=0,T=0;do{const E=Math.cos(f),M=Math.sin(f),I=2*M*E,k=M*M,F=E*E,z=Math.cos(u/2),V=Math.sin(u/2),W=2*z*V,G=V*V,te=1-F*z*z,se=te?1/te:0,ne=te?Math.acos(E*z)*Math.sqrt(1/te):0,ye=.5*(2*ne*E*V+2*u/Math.PI)-r,de=.5*(ne*M+f)-o,Ee=.5*se*(F*G+ne*E*z*k)+1/Math.PI,Pe=se*(W*I/4-ne*M*V),De=.125*se*(I*V-ne*M*F*W),Ve=.5*se*(k*z+ne*G*E)+.5,Le=Pe*De-Ve*Ee;b=(de*Pe-ye*Ve)/Le,T=(ye*De-de*Ee)/Le,u=ri(u-b,-Math.PI,Math.PI),f=ri(f-T,-rC,rC)}while((Math.abs(b)>y||Math.abs(T)>y)&&--m>0);return new ke(Ct(u),Ct(f))}}class nC extends pc{constructor(r){super(r),this.center=r.center||[0,0],this.parallels=r.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Qe(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(r,o){const{scale:u,cosPhi:f}=this;return{x:Qe(r)*f*u+.5,y:-Math.sin(Qe(o))/f*u+.5,z:0}}unproject(r,o){const{scale:u,cosPhi:f}=this,m=-(o-.5)/u,y=ri(Ct((r-.5)/u)/f,-180,180),b=Math.asin(ri(m*f,-1,1)),T=ri(Ct(b),-Ui,Ui);return new ke(y,T)}}class RB extends tC{constructor(r){super(r),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(r,o,u){const f=nm(r,o,u),m=Xg(Ha(u));return l.N.transformMat4(f,f,m),{x:f[0],y:f[1],z:f[2]}}locationPoint(r,o){const u=Ye(o.lat,o.lng),f=l.N.normalize([],u),m=r.elevation?r.elevation.getAtPointOrZero(r.locationCoordinate(o),r._centerAltitude):r._centerAltitude,y=Ti(1,0)*Bt*m;l.N.scaleAndAdd(u,u,f,y);const b=l.a6.identity(new Float64Array(16));return l.a6.multiply(b,r.pixelMatrix,r.globeMatrix),l.N.transformMat4(u,u,b),new xe(u[0],u[1])}pixelsPerMeter(r,o){return Ti(1,0)*o}pixelSpaceConversion(r,o,u){const f=Ti(1,r)*o,m=Ut(Ti(1,45)*o,f,u);return this.pixelsPerMeter(r,o)/m}createTileMatrix(r,o,u){const f=fx(Ha(u.canonical));return l.a6.multiply(new Float64Array(16),r.globeMatrix,f)}createInversionMatrix(r,o){const{center:u}=r,f=Xg(Ha(o));return l.a6.rotateY(f,f,Qe(u.lng)),l.a6.rotateX(f,f,Qe(u.lat)),l.a6.scale(f,f,[r._pixelsPerMercatorPixel,r._pixelsPerMercatorPixel,1]),Float32Array.from(f)}pointCoordinate(r,o,u,f){return bA(r,o,u,!0)||new sr(0,0)}pointCoordinate3D(r,o,u){const f=this.pointCoordinate(r,o,u,0);return[f.x,f.y,f.z]}isPointAboveHorizon(r,o){return!bA(r,o.x,o.y,!1)}farthestPixelDistance(r){const o=function(f,m){const y=f.cameraToCenterDistance,b=f._centerAltitude*m,T=f._camera,E=f._camera.forward(),M=l.N.add([],l.N.scale([],E,-y),[0,0,b]),I=f.worldSize/(2*Math.PI),k=[0,0,-I],F=f.width/f.height,z=Math.tan(f.fovAboveCenter),V=l.N.scale([],T.up(),z),W=l.N.scale([],T.right(),z*F),G=l.N.normalize([],l.N.add([],l.N.add([],E,V),W)),te=[];let se;if(new lx(M,G).closestPointOnSphere(k,I,te)){const ne=l.N.add([],te,k),ye=l.N.sub([],ne,M);se=Math.cos(f.fovAboveCenter)*l.N.length(ye)}else{const ne=l.N.sub([],M,k),ye=l.N.sub([],k,M);l.N.normalize(ye,ye);const de=l.N.length(ne)-I;se=Math.sqrt(de*(de+2*I));const Ee=Math.acos(se/(I+de))-Math.acos(l.N.dot(E,ye));se*=Math.cos(Ee)}return 1.01*se}(r,this.pixelsPerMeter(r.center.lat,r.worldSize)),u=lc(r.zoom);if(u>0){const f=QM(r,Ti(1,r.center.lat)*r.worldSize),m=r.worldSize/(2*Math.PI),y=Math.max(r.width,r.height)/r.worldSize*Math.PI;return Ut(o,f+m*(1-Math.cos(y)),Math.pow(u,10))}return o}upVector(r,o,u){return nm(o,u,r,1)}upVectorScale(r){return{metersToTile:Hg(Gg(Ha(r)))}}}function sC(n){const r=n.parallels,o=!!r&&Math.abs(r[0]+r[1])<.01;switch(n.name){case"mercator":return new tC(n);case"equirectangular":return new MB(n);case"naturalEarth":return new PB(n);case"equalEarth":return new AB(n);case"winkelTripel":return new IB(n);case"albers":return o?new nC(n):new SB(n);case"lambertConformalConic":return o?new nC(n):new CB(n);case"globe":return new RB(n)}throw new Error(`Invalid projection name: ${n.name}`)}const OB=ty.types,kB=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function gy(n,r,o,u,f,m,y,b,T,E,M,I,k){const F=b?Math.min(fc,Math.round(b[0])):0,z=b?Math.min(fc,Math.round(b[1])):0;n.emplaceBack(r,o,Math.round(32*u),Math.round(32*f),m,y,(F<<1)+(T?1:0),z,16*E,16*M,256*I,256*k)}function yy(n,r,o){n.emplaceBack(r,o)}function vy(n,r,o,u,f,m,y){n.emplaceBack(r,o,u,f,m,y)}function xy(n,r,o,u,f){n.emplaceBack(r,o,u,f),n.emplaceBack(r,o,u,f),n.emplaceBack(r,o,u,f),n.emplaceBack(r,o,u,f)}function DB(n){for(const r of n.sections)if(Cp(r.text))return!0;return!1}class Bx{constructor(r){this.layoutVertexArray=new Su,this.indexArray=new os,this.programConfigurations=r,this.segments=new wn,this.dynamicLayoutVertexArray=new Ba,this.opacityVertexArray=new Hp,this.placedSymbolArray=new Ag,this.iconTransitioningVertexArray=new zo,this.globeExtVertexArray=new Wp,this.zOffsetVertexArray=new Mu}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(r,o,u,f,m){this.isEmpty()||(u&&(this.layoutVertexBuffer=r.createVertexBuffer(this.layoutVertexArray,j4.members),this.indexBuffer=r.createIndexBuffer(this.indexArray,o),this.dynamicLayoutVertexBuffer=r.createVertexBuffer(this.dynamicLayoutVertexArray,W4.members,!0),this.opacityVertexBuffer=r.createVertexBuffer(this.opacityVertexArray,kB,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=r.createVertexBuffer(this.iconTransitioningVertexArray,q4.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=r.createVertexBuffer(this.globeExtVertexArray,$4.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||m)&&(this.zOffsetVertexBuffer=r.createVertexBuffer(this.zOffsetVertexArray,H4.members,!0)),this.opacityVertexBuffer.itemSize=1),(u||f)&&this.programConfigurations.upload(r))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}Ht(Bx,"SymbolBuffers");class zx{constructor(r,o,u){this.layoutVertexArray=new r,this.layoutAttributes=o,this.indexArray=new u,this.segments=new wn,this.collisionVertexArray=new Gp,this.collisionVertexArrayExt=new Ba}upload(r){this.layoutVertexBuffer=r.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=r.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=r.createVertexBuffer(this.collisionVertexArray,G4.members,!0),this.collisionVertexBufferExt=r.createVertexBuffer(this.collisionVertexArrayExt,X4.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Ht(zx,"CollisionBuffers");class by{constructor(r){this.collisionBoxArray=r.collisionBoxArray,this.zoom=r.zoom,this.overscaling=r.overscaling,this.layers=r.layers,this.layerIds=this.layers.map(y=>y.fqid),this.index=r.index,this.pixelRatio=r.pixelRatio,this.sourceLayerIndex=r.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=l.a6.identity([]),this.placementViewportMatrix=l.a6.identity([]);const o=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Cx(this.zoom,o["text-size"]),this.iconSizeData=Cx(this.zoom,o["icon-size"]);const u=this.layers[0].layout,f=u.get("symbol-sort-key"),m=u.get("symbol-z-order");this.canOverlap=u.get("text-allow-overlap")||u.get("icon-allow-overlap")||u.get("text-ignore-placement")||u.get("icon-ignore-placement"),this.sortFeaturesByKey=m!=="viewport-y"&&f.constantOr(1)!==void 0,this.sortFeaturesByY=(m==="viewport-y"||m==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=u.get("text-writing-mode").map(y=>Io[y]),this.stateDependentLayerIds=this.layers.filter(y=>y.isStateDependent()).map(y=>y.id),this.sourceID=r.sourceID,this.projection=r.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=u.get("symbol-z-elevate")}createArrays(){this.text=new Bx(new Z(this.layers,this.zoom,r=>/^text/.test(r))),this.icon=new Bx(new Z(this.layers,this.zoom,r=>/^icon/.test(r))),this.glyphOffsetArray=new Pg,this.lineVertexArray=new Ru,this.symbolInstances=new Cg}calculateGlyphDependencies(r,o,u,f,m){for(let y=0;y<r.length;y++){const b=r.codePointAt(y);if(b===void 0)break;if(o[b]=!0,f&&m&&b<=65535){const T=dm[r.charAt(y)];T&&(o[T.charCodeAt(0)]=!0)}}}populate(r,o,u,f){const m=this.layers[0],y=m.layout,b=this.projection.name==="globe",T=y.get("text-font"),E=y.get("text-field"),M=y.get("icon-image"),I=(E.value.kind!=="constant"||E.value.value instanceof gs&&!E.value.value.isEmpty()||E.value.value.toString().length>0)&&(T.value.kind!=="constant"||T.value.value.length>0),k=M.value.kind!=="constant"||!!M.value.value||Object.keys(M.parameters).length>0,F=y.get("symbol-sort-key");if(this.features=[],!I&&!k)return;const z=o.iconDependencies,V=o.glyphDependencies,W=o.availableImages,G=new dn(this.zoom);for(const{feature:te,id:se,index:ne,sourceLayerIndex:ye}of r){const de=m._featureFilter.needGeometry,Ee=Xn(te,de);if(!m._featureFilter.filter(G,Ee,u))continue;if(de||(Ee.geometry=ls(te,u,f)),b&&te.type!==1&&u.z<=5){const Le=Ee.geometry,rt=.98078528056,ht=(Ze,ct)=>{const qe=nm(Ze.x,Ze.y,u,1),at=nm(ct.x,ct.y,u,1);return l.N.dot(qe,at)<rt};for(let Ze=0;Ze<Le.length;Ze++)Le[Ze]=vs(Le[Ze],ht)}let Pe,De;if(I){const Le=m.getValueAndResolveTokens("text-field",Ee,u,W),rt=gs.factory(Le);DB(rt)&&(this.hasRTLText=!0),(!this.hasRTLText||Fa()==="unavailable"||this.hasRTLText&&io.isParsed())&&(Pe=K4(rt,m,Ee))}if(k){const Le=m.getValueAndResolveTokens("icon-image",Ee,u,W);De=Le instanceof ci?Le:ci.fromString(Le)}if(!Pe&&!De)continue;const Ve=this.sortFeaturesByKey?F.evaluate(Ee,{},u):void 0;if(this.features.push({id:se,text:Pe,icon:De,index:ne,sourceLayerIndex:ye,geometry:Ee.geometry,properties:te.properties,type:OB[te.type],sortKey:Ve}),De&&(z[De.namePrimary]=!0,De.nameSecondary&&(z[De.nameSecondary]=!0)),Pe){const Le=T.evaluate(Ee,{},u).join(","),rt=y.get("text-rotation-alignment")==="map"&&y.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Io.vertical)>=0;for(const ht of Pe.sections)if(ht.image)z[ht.image.namePrimary]=!0;else{const Ze=La(Pe.toString()),ct=ht.fontStack||Le,qe=V[ct]=V[ct]||{};this.calculateGlyphDependencies(ht.text,qe,rt,this.allowVerticalPlacement,Ze)}}}y.get("symbol-placement")==="line"&&(this.features=function(te){const se={},ne={},ye=[];let de=0;function Ee(Le){ye.push(te[Le]),de++}function Pe(Le,rt,ht){const Ze=ne[Le];return delete ne[Le],ne[rt]=Ze,ye[Ze].geometry[0].pop(),ye[Ze].geometry[0]=ye[Ze].geometry[0].concat(ht[0]),Ze}function De(Le,rt,ht){const Ze=se[rt];return delete se[rt],se[Le]=Ze,ye[Ze].geometry[0].shift(),ye[Ze].geometry[0]=ht[0].concat(ye[Ze].geometry[0]),Ze}function Ve(Le,rt,ht){const Ze=ht?rt[0][rt[0].length-1]:rt[0][0];return`${Le}:${Ze.x}:${Ze.y}`}for(let Le=0;Le<te.length;Le++){const rt=te[Le],ht=rt.geometry,Ze=rt.text?rt.text.toString():null;if(!Ze){Ee(Le);continue}const ct=Ve(Ze,ht),qe=Ve(Ze,ht,!0);if(ct in ne&&qe in se&&ne[ct]!==se[qe]){const at=De(ct,qe,ht),Ot=Pe(ct,qe,ye[at].geometry);delete se[ct],delete ne[qe],ne[Ve(Ze,ye[Ot].geometry,!0)]=Ot,ye[at].geometry=null}else ct in ne?Pe(ct,qe,ht):qe in se?De(ct,qe,ht):(Ee(Le),se[ct]=de-1,ne[qe]=de-1)}return ye.filter(Le=>Le.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((te,se)=>te.sortKey-se.sortKey)}update(r,o,u,f,m){const y=Object.keys(r).length!==0;if(y&&!this.stateDependentLayers.length)return;const b=y?this.stateDependentLayers:this.layers;this.text.programConfigurations.updatePaintArrays(r,o,b,u,f,m),this.icon.programConfigurations.updatePaintArrays(r,o,b,u,f,m)}updateZOffset(){const r=(m,y,b)=>{u+=y,u>m.length&&m.resize(u);for(let T=-y;T<0;T++)m.emplace(T+u,b)},o=(m,y,b)=>{f+=y,f>m.length&&m.resize(f);for(let T=-y;T<0;T++)m.emplace(T+f,b)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let u=0,f=0;for(let m=0;m<this.symbolInstances.length;m++){const y=this.symbolInstances.get(m),{numHorizontalGlyphVertices:b,numVerticalGlyphVertices:T,numIconVertices:E}=y,M=y.zOffset,I=E>0;if((b>0||T>0)&&(r(this.text.zOffsetVertexArray,b,M),r(this.text.zOffsetVertexArray,T,M)),I){const{placedIconSymbolIndex:k,verticalPlacedIconSymbolIndex:F}=y;k>=0&&o(this.icon.zOffsetVertexArray,E,M),F>=0&&o(this.icon.zOffsetVertexArray,y.numVerticalIconVertices,M)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(r){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(r),this.iconCollisionBox.upload(r)),this.text.upload(r,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(r,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=sC(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(r,o){const u=this.lineVertexArray.length;if(r.segment!==void 0)for(const{x:f,y:m}of o)this.lineVertexArray.emplaceBack(f,m);return{lineStartIndex:u,lineLength:this.lineVertexArray.length-u}}addSymbols(r,o,u,f,m,y,b,T,E,M,I,k,F,z,V,W){const G=r.indexArray,te=r.layoutVertexArray,se=r.globeExtVertexArray,ne=r.segments.prepareSegment(4*o.length,te,G,this.canOverlap?y.sortKey:void 0),ye=this.glyphOffsetArray.length,de=ne.vertexLength,Ee=this.allowVerticalPlacement&&b===Io.vertical?Math.PI/2:0,Pe=y.text&&y.text.sections;for(let Ve=0;Ve<o.length;Ve++){const{tl:Le,tr:rt,bl:ht,br:Ze,texPrimary:ct,texSecondary:qe,pixelOffsetTL:at,pixelOffsetBR:Ot,minFontScaleX:dt,minFontScaleY:Xt,glyphOffset:Wt,isSDF:_t,sectionIndex:hi}=o[Ve],ti=ne.vertexLength,qt=Wt[1];if(gy(te,E.x,E.y,Le.x,qt+Le.y,ct.x,ct.y,u,_t,at.x,at.y,dt,Xt),gy(te,E.x,E.y,rt.x,qt+rt.y,ct.x+ct.w,ct.y,u,_t,Ot.x,at.y,dt,Xt),gy(te,E.x,E.y,ht.x,qt+ht.y,ct.x,ct.y+ct.h,u,_t,at.x,Ot.y,dt,Xt),gy(te,E.x,E.y,Ze.x,qt+Ze.y,ct.x+ct.w,ct.y+ct.h,u,_t,Ot.x,Ot.y,dt,Xt),T){const{x:gt,y:ai,z:Di}=T.anchor,[di,Li,xi]=T.up;vy(se,gt,ai,Di,di,Li,xi),vy(se,gt,ai,Di,di,Li,xi),vy(se,gt,ai,Di,di,Li,xi),vy(se,gt,ai,Di,di,Li,xi),xy(r.dynamicLayoutVertexArray,gt,ai,Di,Ee)}else xy(r.dynamicLayoutVertexArray,E.x,E.y,E.z,Ee);if(W){const gt=qe||ct;yy(r.iconTransitioningVertexArray,gt.x,gt.y),yy(r.iconTransitioningVertexArray,gt.x+gt.w,gt.y),yy(r.iconTransitioningVertexArray,gt.x,gt.y+gt.h),yy(r.iconTransitioningVertexArray,gt.x+gt.w,gt.y+gt.h)}G.emplaceBack(ti,ti+1,ti+2),G.emplaceBack(ti+1,ti+2,ti+3),ne.vertexLength+=4,ne.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Wt[0]),Ve!==o.length-1&&hi===o[Ve+1].sectionIndex||r.programConfigurations.populatePaintArrays(te.length,y,y.index,{},F,z,V,Pe&&Pe[hi])}const De=T?T.anchor:E;r.placedSymbolArray.emplaceBack(De.x,De.y,De.z,E.x,E.y,ye,this.glyphOffsetArray.length-ye,de,M,I,E.segment,u?u[0]:0,u?u[1]:0,f[0],f[1],b,0,!1,0,k,0)}_commitLayoutVertex(r,o,u,f,m,y,b){r.emplaceBack(o,u,f,m,y,Math.round(b.x),Math.round(b.y))}_addCollisionDebugVertices(r,o,u,f,m,y,b){const T=u.segments.prepareSegment(4,u.layoutVertexArray,u.indexArray),E=T.vertexLength,M=b.tileAnchorX,I=b.tileAnchorY;for(let F=0;F<4;F++)u.collisionVertexArray.emplaceBack(0,0,0,0);this._commitDebugCollisionVertexUpdate(u.collisionVertexArrayExt,o,r.padding,b.zOffset),this._commitLayoutVertex(u.layoutVertexArray,f,m,y,M,I,new xe(r.x1,r.y1)),this._commitLayoutVertex(u.layoutVertexArray,f,m,y,M,I,new xe(r.x2,r.y1)),this._commitLayoutVertex(u.layoutVertexArray,f,m,y,M,I,new xe(r.x2,r.y2)),this._commitLayoutVertex(u.layoutVertexArray,f,m,y,M,I,new xe(r.x1,r.y2)),T.vertexLength+=4;const k=u.indexArray;k.emplaceBack(E,E+1),k.emplaceBack(E+1,E+2),k.emplaceBack(E+2,E+3),k.emplaceBack(E+3,E),T.primitiveLength+=4}_addTextDebugCollisionBoxes(r,o,u,f,m,y){for(let b=f;b<m;b++){const T=u.get(b),E=this.getSymbolInstanceTextSize(r,y,o,b);this._addCollisionDebugVertices(T,E,this.textCollisionBox,T.projectedAnchorX,T.projectedAnchorY,T.projectedAnchorZ,y)}}_addIconDebugCollisionBoxes(r,o,u,f,m,y){for(let b=f;b<m;b++){const T=u.get(b),E=this.getSymbolInstanceIconSize(r,o,y.placedIconSymbolIndex);this._addCollisionDebugVertices(T,E,this.iconCollisionBox,T.projectedAnchorX,T.projectedAnchorY,T.projectedAnchorZ,y)}}generateCollisionDebugBuffers(r,o){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new zx(Au,SM.members,zo),this.iconCollisionBox=new zx(Au,SM.members,zo);const u=gd(this.iconSizeData,r),f=gd(this.textSizeData,r);for(let m=0;m<this.symbolInstances.length;m++){const y=this.symbolInstances.get(m);this._addTextDebugCollisionBoxes(f,r,o,y.textBoxStartIndex,y.textBoxEndIndex,y),this._addTextDebugCollisionBoxes(f,r,o,y.verticalTextBoxStartIndex,y.verticalTextBoxEndIndex,y),this._addIconDebugCollisionBoxes(u,r,o,y.iconBoxStartIndex,y.iconBoxEndIndex,y),this._addIconDebugCollisionBoxes(u,r,o,y.verticalIconBoxStartIndex,y.verticalIconBoxEndIndex,y)}}getSymbolInstanceTextSize(r,o,u,f){const m=this.text.placedSymbolArray.get(o.rightJustifiedTextSymbolIndex>=0?o.rightJustifiedTextSymbolIndex:o.centerJustifiedTextSymbolIndex>=0?o.centerJustifiedTextSymbolIndex:o.leftJustifiedTextSymbolIndex>=0?o.leftJustifiedTextSymbolIndex:o.verticalPlacedTextSymbolIndex>=0?o.verticalPlacedTextSymbolIndex:f),y=ay(this.textSizeData,r,m)/Ts;return this.tilePixelRatio*y}getSymbolInstanceIconSize(r,o,u){const f=this.icon.placedSymbolArray.get(u),m=ay(this.iconSizeData,r,f);return this.tilePixelRatio*m}_commitDebugCollisionVertexUpdate(r,o,u,f){r.emplaceBack(o,-u,-u,f),r.emplaceBack(o,u,-u,f),r.emplaceBack(o,u,u,f),r.emplaceBack(o,-u,u,f)}_updateTextDebugCollisionBoxes(r,o,u,f,m,y){for(let b=f;b<m;b++){const T=u.get(b),E=this.getSymbolInstanceTextSize(r,y,o,b);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,E,T.padding,y.zOffset)}}_updateIconDebugCollisionBoxes(r,o,u,f,m,y){for(let b=f;b<m;b++){const T=u.get(b),E=this.getSymbolInstanceIconSize(r,o,y.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,E,T.padding,y.zOffset)}}updateCollisionDebugBuffers(r,o){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const u=gd(this.iconSizeData,r),f=gd(this.textSizeData,r);for(let m=0;m<this.symbolInstances.length;m++){const y=this.symbolInstances.get(m);this._updateTextDebugCollisionBoxes(f,r,o,y.textBoxStartIndex,y.textBoxEndIndex,y),this._updateTextDebugCollisionBoxes(f,r,o,y.verticalTextBoxStartIndex,y.verticalTextBoxEndIndex,y),this._updateIconDebugCollisionBoxes(u,r,o,y.iconBoxStartIndex,y.iconBoxEndIndex,y),this._updateIconDebugCollisionBoxes(u,r,o,y.verticalIconBoxStartIndex,y.verticalIconBoxEndIndex,y)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(r,o,u,f,m,y,b,T,E){const M={};if(o<u){const{x1:I,y1:k,x2:F,y2:z,padding:V,projectedAnchorX:W,projectedAnchorY:G,projectedAnchorZ:te,tileAnchorX:se,tileAnchorY:ne,featureIndex:ye}=r.get(o);M.textBox={x1:I,y1:k,x2:F,y2:z,padding:V,projectedAnchorX:W,projectedAnchorY:G,projectedAnchorZ:te,tileAnchorX:se,tileAnchorY:ne},M.textFeatureIndex=ye}if(f<m){const{x1:I,y1:k,x2:F,y2:z,padding:V,projectedAnchorX:W,projectedAnchorY:G,projectedAnchorZ:te,tileAnchorX:se,tileAnchorY:ne,featureIndex:ye}=r.get(f);M.verticalTextBox={x1:I,y1:k,x2:F,y2:z,padding:V,projectedAnchorX:W,projectedAnchorY:G,projectedAnchorZ:te,tileAnchorX:se,tileAnchorY:ne},M.verticalTextFeatureIndex=ye}if(y<b){const{x1:I,y1:k,x2:F,y2:z,padding:V,projectedAnchorX:W,projectedAnchorY:G,projectedAnchorZ:te,tileAnchorX:se,tileAnchorY:ne,featureIndex:ye}=r.get(y);M.iconBox={x1:I,y1:k,x2:F,y2:z,padding:V,projectedAnchorX:W,projectedAnchorY:G,projectedAnchorZ:te,tileAnchorX:se,tileAnchorY:ne},M.iconFeatureIndex=ye}if(T<E){const{x1:I,y1:k,x2:F,y2:z,padding:V,projectedAnchorX:W,projectedAnchorY:G,projectedAnchorZ:te,tileAnchorX:se,tileAnchorY:ne,featureIndex:ye}=r.get(T);M.verticalIconBox={x1:I,y1:k,x2:F,y2:z,padding:V,projectedAnchorX:W,projectedAnchorY:G,projectedAnchorZ:te,tileAnchorX:se,tileAnchorY:ne},M.verticalIconFeatureIndex=ye}return M}deserializeCollisionBoxes(r){this.collisionArrays=[];for(let o=0;o<this.symbolInstances.length;o++){const u=this.symbolInstances.get(o);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(r,u.textBoxStartIndex,u.textBoxEndIndex,u.verticalTextBoxStartIndex,u.verticalTextBoxEndIndex,u.iconBoxStartIndex,u.iconBoxEndIndex,u.verticalIconBoxStartIndex,u.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(r,o){const u=r.placedSymbolArray.get(o),f=u.vertexStartIndex+4*u.numGlyphs;for(let m=u.vertexStartIndex;m<f;m+=4)r.indexArray.emplaceBack(m,m+1,m+2),r.indexArray.emplaceBack(m+1,m+2,m+3)}getSortedSymbolIndexes(r){if(this.sortedAngle===r&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const o=Math.sin(r),u=Math.cos(r),f=[],m=[],y=[];for(let b=0;b<this.symbolInstances.length;++b){y.push(b);const T=this.symbolInstances.get(b);f.push(0|Math.round(o*T.tileAnchorX+u*T.tileAnchorY)),m.push(T.featureIndex)}return y.sort((b,T)=>f[b]-f[T]||m[T]-m[b]),y}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let r=0;r<this.symbolInstances.length;++r)this.symbolInstanceIndexesSortedZOffset.push(r)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((r,o)=>this.symbolInstances.get(o).zOffset-this.symbolInstances.get(r).zOffset)}addToSortKeyRanges(r,o){const u=this.sortKeyRanges[this.sortKeyRanges.length-1];u&&u.sortKey===o?u.symbolInstanceEnd=r+1:this.sortKeyRanges.push({sortKey:o,symbolInstanceStart:r,symbolInstanceEnd:r+1})}sortFeatures(r){if(this.sortFeaturesByY&&this.sortedAngle!==r&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(r),this.sortedAngle=r,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const o of this.symbolInstanceIndexes){const u=this.symbolInstances.get(o);this.featureSortOrder.push(u.featureIndex);const{rightJustifiedTextSymbolIndex:f,centerJustifiedTextSymbolIndex:m,leftJustifiedTextSymbolIndex:y,verticalPlacedTextSymbolIndex:b,placedIconSymbolIndex:T,verticalPlacedIconSymbolIndex:E}=u;f>=0&&this.addIndicesForPlacedSymbol(this.text,f),m>=0&&m!==f&&this.addIndicesForPlacedSymbol(this.text,m),y>=0&&y!==m&&y!==f&&this.addIndicesForPlacedSymbol(this.text,y),b>=0&&this.addIndicesForPlacedSymbol(this.text,b),T>=0&&this.addIndicesForPlacedSymbol(this.icon,T),E>=0&&this.addIndicesForPlacedSymbol(this.icon,E)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Ht(by,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),by.addDynamicAttributes=xy;const LB=new fn({"symbol-placement":new Pt(Fe.layout_symbol["symbol-placement"]),"symbol-spacing":new Pt(Fe.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Pt(Fe.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new oi(Fe.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Pt(Fe.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new Pt(Fe.layout_symbol["symbol-z-elevate"]),"icon-allow-overlap":new Pt(Fe.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Pt(Fe.layout_symbol["icon-ignore-placement"]),"icon-optional":new Pt(Fe.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Pt(Fe.layout_symbol["icon-rotation-alignment"]),"icon-size":new oi(Fe.layout_symbol["icon-size"]),"icon-text-fit":new oi(Fe.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new oi(Fe.layout_symbol["icon-text-fit-padding"]),"icon-image":new oi(Fe.layout_symbol["icon-image"]),"icon-rotate":new oi(Fe.layout_symbol["icon-rotate"]),"icon-padding":new Pt(Fe.layout_symbol["icon-padding"]),"icon-keep-upright":new Pt(Fe.layout_symbol["icon-keep-upright"]),"icon-offset":new oi(Fe.layout_symbol["icon-offset"]),"icon-anchor":new oi(Fe.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Pt(Fe.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Pt(Fe.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Pt(Fe.layout_symbol["text-rotation-alignment"]),"text-field":new oi(Fe.layout_symbol["text-field"]),"text-font":new oi(Fe.layout_symbol["text-font"]),"text-size":new oi(Fe.layout_symbol["text-size"]),"text-max-width":new oi(Fe.layout_symbol["text-max-width"]),"text-line-height":new oi(Fe.layout_symbol["text-line-height"]),"text-letter-spacing":new oi(Fe.layout_symbol["text-letter-spacing"]),"text-justify":new oi(Fe.layout_symbol["text-justify"]),"text-radial-offset":new oi(Fe.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Pt(Fe.layout_symbol["text-variable-anchor"]),"text-anchor":new oi(Fe.layout_symbol["text-anchor"]),"text-max-angle":new Pt(Fe.layout_symbol["text-max-angle"]),"text-writing-mode":new Pt(Fe.layout_symbol["text-writing-mode"]),"text-rotate":new oi(Fe.layout_symbol["text-rotate"]),"text-padding":new Pt(Fe.layout_symbol["text-padding"]),"text-keep-upright":new Pt(Fe.layout_symbol["text-keep-upright"]),"text-transform":new oi(Fe.layout_symbol["text-transform"]),"text-offset":new oi(Fe.layout_symbol["text-offset"]),"text-allow-overlap":new Pt(Fe.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Pt(Fe.layout_symbol["text-ignore-placement"]),"text-optional":new Pt(Fe.layout_symbol["text-optional"]),visibility:new Pt(Fe.layout_symbol.visibility)});var Ux={paint:new fn({"icon-opacity":new oi(Fe.paint_symbol["icon-opacity"]),"icon-emissive-strength":new oi(Fe.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new oi(Fe.paint_symbol["text-emissive-strength"]),"icon-color":new oi(Fe.paint_symbol["icon-color"]),"icon-halo-color":new oi(Fe.paint_symbol["icon-halo-color"]),"icon-halo-width":new oi(Fe.paint_symbol["icon-halo-width"]),"icon-halo-blur":new oi(Fe.paint_symbol["icon-halo-blur"]),"icon-translate":new Pt(Fe.paint_symbol["icon-translate"]),"icon-translate-anchor":new Pt(Fe.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new oi(Fe.paint_symbol["icon-image-cross-fade"]),"text-opacity":new oi(Fe.paint_symbol["text-opacity"]),"text-color":new oi(Fe.paint_symbol["text-color"],{runtimeType:ni,getOverride:n=>n.textColor,hasOverride:n=>!!n.textColor}),"text-halo-color":new oi(Fe.paint_symbol["text-halo-color"]),"text-halo-width":new oi(Fe.paint_symbol["text-halo-width"]),"text-halo-blur":new oi(Fe.paint_symbol["text-halo-blur"]),"text-translate":new Pt(Fe.paint_symbol["text-translate"]),"text-translate-anchor":new Pt(Fe.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new Pt(Fe.paint_symbol["icon-color-saturation"])}),layout:LB};class oC{constructor(r){this.type=r.property.overrides?r.property.overrides.runtimeType:ge,this.defaultValue=r}evaluate(r){if(r.formattedSection){const o=this.defaultValue.property.overrides;if(o&&o.hasOverride(r.formattedSection))return o.getOverride(r.formattedSection)}return r.feature&&r.featureState?this.defaultValue.evaluate(r.feature,r.featureState):this.defaultValue.property.specification.default}eachChild(r){this.defaultValue.isConstant()||r(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Ht(oC,"FormatSectionOverride",{omit:["defaultValue"]});class wy extends Ws{constructor(r,o,u){super(r,Ux,o,u)}recalculate(r,o){super.recalculate(r,o),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const u=this.layout.get("text-writing-mode");if(u){const f=[];for(const m of u)f.indexOf(m)<0&&f.push(m);this.layout._values["text-writing-mode"]=f}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(r,o,u,f){const m=this.layout.get(r).evaluate(o,{},u,f),y=this._unevaluatedLayout._values[r];return y.isDataDriven()||du(y.value)||!m?m:function(b,T){return T.replace(/{([^{}]+)}/g,(E,M)=>M in b?String(b[M]):"")}(o.properties,m)}createBucket(r){return new by(r)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const r of Ux.paint.overridableProperties){if(!wy.hasPaintOverride(this.layout,r))continue;const o=this.paint.get(r),u=new oC(o),f=new Kh(u,o.property.specification,this.scope,this.options);let m=null;m=o.value.kind==="constant"||o.value.kind==="source"?new Ap("source",f):new fu("composite",f,o.value.zoomStops,o.value._interpolationType),this.paint._values[r]=new ic(o.property,m,o.parameters)}}_handleOverridablePaintPropertyUpdate(r,o,u){return!(!this.layout||o.isDataDriven()||u.isDataDriven())&&wy.hasPaintOverride(this.layout,r)}static hasPaintOverride(r,o){const u=r.get("text-field"),f=Ux.paint.properties[o];let m=!1;const y=b=>{for(const T of b)if(f.overrides&&f.overrides.hasOverride(T))return void(m=!0)};if(u.value.kind==="constant"&&u.value.value instanceof gs)y(u.value.value.sections);else if(u.value.kind==="source"){const b=E=>{m||(E instanceof Jo&&qn(E.value)===Hn?y(E.value.sections):E instanceof Vl?y(E.sections):E.eachChild(b))},T=u.value;T._styleExpression&&b(T._styleExpression.expression)}return m}getProgramIds(){const r=this.paint.get("icon-opacity").constantOr(1)!==0,o=this.paint.get("text-opacity").constantOr(1)!==0,u=[];return r&&u.push("symbolIcon"),o&&u.push("symbolSDF"),u}getDefaultProgramParams(r,o){return{config:new $(this,o),overrideFog:!1}}}const NB=new fn({visibility:new Pt(Fe.layout_background.visibility)});var FB={paint:new fn({"background-color":new Pt(Fe.paint_background["background-color"]),"background-pattern":new Pt(Fe.paint_background["background-pattern"]),"background-opacity":new Pt(Fe.paint_background["background-opacity"]),"background-emissive-strength":new Pt(Fe.paint_background["background-emissive-strength"])}),layout:NB};const BB=new fn({visibility:new Pt(Fe.layout_raster.visibility)});var zB={paint:new fn({"raster-opacity":new Pt(Fe.paint_raster["raster-opacity"]),"raster-color":new vl(Fe.paint_raster["raster-color"]),"raster-color-mix":new Pt(Fe.paint_raster["raster-color-mix"]),"raster-color-range":new Pt(Fe.paint_raster["raster-color-range"]),"raster-hue-rotate":new Pt(Fe.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Pt(Fe.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Pt(Fe.paint_raster["raster-brightness-max"]),"raster-saturation":new Pt(Fe.paint_raster["raster-saturation"]),"raster-contrast":new Pt(Fe.paint_raster["raster-contrast"]),"raster-resampling":new Pt(Fe.paint_raster["raster-resampling"]),"raster-fade-duration":new Pt(Fe.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new Pt(Fe.paint_raster["raster-emissive-strength"]),"raster-array-band":new Pt(Fe.paint_raster["raster-array-band"]),"raster-elevation":new Pt(Fe.paint_raster["raster-elevation"])}),layout:BB},Vx=Mr([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class jx{constructor(r,o,u,f){this.context=r,this.format=u,this.texture=r.gl.createTexture(),this.update(o,f)}update(r,o,u){const{width:f,height:m}=r,{context:y}=this,{gl:b}=y;if(b.bindTexture(b.TEXTURE_2D,this.texture),y.pixelStoreUnpackFlipY.set(!1),y.pixelStoreUnpack.set(1),y.pixelStoreUnpackPremultiplyAlpha.set(this.format===b.RGBA&&(!o||o.premultiply!==!1)),u||this.size&&this.size[0]===f&&this.size[1]===m){const{x:T,y:E}=u||{x:0,y:0};if(r instanceof HTMLImageElement||r instanceof HTMLCanvasElement||r instanceof HTMLVideoElement||r instanceof ImageData||ImageBitmap&&r instanceof ImageBitmap)b.texSubImage2D(b.TEXTURE_2D,0,T,E,b.RGBA,b.UNSIGNED_BYTE,r);else{let M=this.format,I=b.UNSIGNED_BYTE;this.format===b.R32F&&(M=b.RED,I=b.FLOAT),b.texSubImage2D(b.TEXTURE_2D,0,T,E,f,m,M,I,r.data)}}else if(this.size=[f,m],r instanceof HTMLImageElement||r instanceof HTMLCanvasElement||r instanceof HTMLVideoElement||r instanceof ImageData||ImageBitmap&&r instanceof ImageBitmap){let T=this.format;this.format===b.R8&&(T=b.RED),b.texImage2D(b.TEXTURE_2D,0,this.format,T,b.UNSIGNED_BYTE,r)}else{let T=this.format,E=this.format,M=b.UNSIGNED_BYTE;this.format===b.DEPTH_COMPONENT&&(T=b.DEPTH_COMPONENT16,M=b.UNSIGNED_SHORT),this.format===b.R8&&(E=b.RED),this.format===b.R32F&&(M=b.FLOAT,E=b.RED),b.texImage2D(b.TEXTURE_2D,0,T,f,m,0,E,M,r.data)}this.useMipmap=!!(o&&o.useMipmap),this.useMipmap&&b.generateMipmap(b.TEXTURE_2D)}bind(r,o,u=!1){const{context:f}=this,{gl:m}=f;m.bindTexture(m.TEXTURE_2D,this.texture),r!==this.minFilter&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,r),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,this.useMipmap&&!u?r===m.NEAREST?m.NEAREST_MIPMAP_NEAREST:m.LINEAR_MIPMAP_LINEAR:r),this.minFilter=r),o!==this.wrapS&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,o),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,o),this.wrapS=o)}bindExtraParam(r,o,u,f){const{context:m}=this,{gl:y}=m;y.bindTexture(y.TEXTURE_2D,this.texture),o!==this.magFilter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,o),this.magFilter=o),r!==this.minFilter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,this.useMipmap?r===y.NEAREST?y.NEAREST_MIPMAP_NEAREST:y.LINEAR_MIPMAP_LINEAR:r),this.minFilter=r),u!==this.wrapS&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,u),this.wrapS=u),f!==this.wrapT&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,f),this.wrapT=f)}destroy(){const{gl:r}=this.context;r.deleteTexture(this.texture),this.texture=null}}class Ty{constructor(r,o){this.context=r,this.texture=o}bind(r,o){const{context:u}=this,{gl:f}=u;f.bindTexture(f.TEXTURE_2D,this.texture),r!==this.minFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,r),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,r),this.minFilter=r),o!==this.wrapS&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,o),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,o),this.wrapS=o)}}function Ey(n,r,o,u,f,m,y,b){const T=[n,r,1,o,u,1,f,m,1],E=[y,b,1],M=l.co.adjoint([],T),[I,k,F]=l.N.transformMat3(E,E,M);return l.co.multiply(T,T,[I,0,0,0,k,0,0,0,F])}function aC(n,r,o,u,f,m,y,b){const T=function(E,M,I,k,F,z,V,W){const G=Ey(0,0,1,0,1,1,0,1),te=Ey(E,M,I,k,F,z,V,W),se=l.co.adjoint([],G);return l.co.multiply(te,te,se)}(n,r,o,u,f,m,y,b);return[T[2]/T[8]/Bt,T[5]/T[8]/Bt]}function Sy(n){return[n[0],Math.min(Math.max(n[1],-Ui),Ui)]}class lC extends eo{constructor(r,o,u,f){super(),this.id=r,this.dispatcher=u,this.coordinates=o.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(f),this.options=o,this._dirty=!1}load(r,o){if(this._loaded=o||!1,this.fire(new lo("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return r&&(this.coordinates=r),this._loaded=!0,void this._finishLoading();this._imageRequest=kt(this.map._requestManager.transformRequest(this.url,ns.Image),(u,f)=>{this._imageRequest=null,this._loaded=!0,u?this.fire(new Ta(u)):f&&(this.image=f instanceof HTMLImageElement?lt.getImageData(f):f,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,r&&(this.coordinates=r),this._finishLoading())})}loaded(){return this._loaded}updateImage(r){return r.url?(this._imageRequest&&r.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=r.url,this.load(r.coordinates,this._loaded),this):this}setTexture(r){if(!(r.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Ty(this.map.painter.context,r.handle),this.width=r.dimensions[0],this.height=r.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new lo("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(r){this.map=r,this.load()}onRemove(){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Ty||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(r){if(this.coordinates=r,this._boundsArray=void 0,this._unsupportedCoords=!1,!r.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let o=r[0][1],u=r[0][1];for(const m of r)m[1]>u&&(u=m[1]),m[1]<o&&(o=m[1]);const f=(u+o)/2;if(f>Ui?this.onNorthPole=!0:f<-Ui&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const m=r.map(sr.fromLngLat);this.tileID=function(y){let b=1/0,T=1/0,E=-1/0,M=-1/0;for(const V of y)b=Math.min(b,V.x),T=Math.min(T,V.y),E=Math.max(E,V.x),M=Math.max(M,V.y);const I=Math.max(E-b,M-T),k=Math.max(0,Math.floor(-Math.log(I)/Math.LN2)),F=Math.pow(2,k);let z=Math.floor((b+E)/2*F);return z>1&&(z-=1),new mt(k,z,Math.floor((T+M)/2*F))}(m),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new lo("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(r){for(const G in this.tiles){const te=this.tiles[G];te.state!=="loaded"&&(te.state="loaded",te.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const o=_m(new mt(0,0,0),this.map.transform.projection),u=[o.projection.project(this.coordinates[0][0],this.coordinates[0][1]),o.projection.project(this.coordinates[1][0],this.coordinates[1][1]),o.projection.project(this.coordinates[2][0],this.coordinates[2][1]),o.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(G){const te=G[1].x-G[0].x,se=G[1].y-G[0].y,ne=G[2].x-G[1].x,ye=G[2].y-G[1].y,de=G[3].x-G[2].x,Ee=G[3].y-G[2].y,Pe=G[0].x-G[3].x,De=G[0].y-G[3].y,Ve=te*ye-ne*se,Le=ne*Ee-de*ye,rt=de*De-Pe*Ee,ht=Pe*se-te*De;return Ve>0&&Le>0&&rt>0&&ht>0||Ve<0&&Le<0&&rt<0&&ht<0}(u))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const f=_m(this.tileID,this.map.transform.projection),[m,y,b,T]=this.coordinates.map(G=>{const te=f.projection.project(G[0],G[1]);return eC(f,te)._round()});this.perspectiveTransform=aC(m.x,m.y,y.x,y.y,b.x,b.y,T.x,T.y);const E=this._boundsArray=new na;E.emplaceBack(m.x,m.y,0,0),E.emplaceBack(y.x,y.y,Bt,0),E.emplaceBack(T.x,T.y,0,Bt),E.emplaceBack(b.x,b.y,Bt,Bt),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=r.createVertexBuffer(E,Vx.members),this.boundsSegments=wn.simpleSegment(0,0,4,2);const M=[],I=[Sy((k=this.coordinates)[0]),Sy(k[1]),Sy(k[2]),Sy(k[3])];var k;const[F,z,V,W]=function(G){let te=G[0][0],se=te,ne=G[0][1],ye=ne;for(let de=1;de<G.length;de++)G[de][0]<te?te=G[de][0]:G[de][0]>se&&(se=G[de][0]),G[de][1]<ne?ne=G[de][1]:G[de][1]>ye&&(ye=G[de][1]);return[te,ne,se-te,ye-ne]}(I);{const G=new na,[te,se,ne,ye]=function(at){let Ot=at[0].x,dt=Ot,Xt=at[0].y,Wt=Xt;for(let _t=1;_t<at.length;_t++)at[_t].x<Ot?Ot=at[_t].x:at[_t].x>dt&&(dt=at[_t].x),at[_t].y<Xt?Xt=at[_t].y:at[_t].y>Wt&&(Wt=at[_t].y);return[Ot,Xt,dt-Ot,Wt-Xt]}(u),de=at=>[(at.x-te)/ne,(at.y-se)/ye],[Ee,Pe,De,Ve]=u.map(de),Le=function(at,Ot,dt,Xt,Wt,_t,hi,ti){const qt=Ey(0,0,1,0,1,1,0,1),gt=Ey(at,Ot,dt,Xt,Wt,_t,hi,ti),ai=l.co.adjoint([],gt);return l.co.multiply(qt,qt,ai)}(Ee[0],Ee[1],Pe[0],Pe[1],De[0],De[1],Ve[0],Ve[1]);this.elevatedGlobePerspectiveTransform=aC(Ee[0],Ee[1],Pe[0],Pe[1],De[0],De[1],Ve[0],Ve[1]);const rt=(at,Ot)=>{M.push(at.lng);const dt=Math.round((at.lng-F)/V*Bt),Xt=Math.round((at.lat-z)/W*Bt),Wt=de(Ot),_t=l.N.transformMat3([],[Wt[0],Wt[1],1],Le),hi=Math.round(_t[0]/_t[2]*Bt),ti=Math.round(_t[1]/_t[2]*Bt);G.emplaceBack(dt,Xt,hi,ti)},ht=u[3].x-u[0].x,Ze=u[3].y-u[0].y,ct=u[2].x-u[1].x,qe=u[2].y-u[1].y;for(let at=0;at<65;at++){const Ot=at/64,dt=[u[0].x+Ot*ht,u[0].y+Ot*Ze],Xt=[u[1].x+Ot*ct,u[1].y+Ot*qe],Wt=Xt[0]-dt[0],_t=Xt[1]-dt[1];for(let hi=0;hi<65;hi++){const ti=hi/64,qt={x:dt[0]+Wt*ti,y:dt[1]+_t*ti,z:0};rt(o.projection.unproject(qt.x,qt.y),qt)}}this.elevatedGlobeVertexBuffer=r.createVertexBuffer(G,Vx.members)}{this.maxLongitudeTriangleSize=0;let G=[],te=new os;const se=(ne,ye,de)=>{te.emplaceBack(ne,ye,de);const Ee=M[ne],Pe=M[ye],De=M[de],Ve=Math.min(Math.min(Ee,Pe),De),Le=Math.max(Math.max(Ee,Pe),De)-Ve;Le>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Le),G.push(Ve+Le/2)};for(let ne=0;ne<64;ne++)for(let ye=0;ye<64;ye++){const de=65*ne+ye,Ee=de+1,Pe=de+65,De=Pe+1;se(de,Pe,Ee),se(Ee,Pe,De)}[G,te]=function(ne,ye){const de=Array.from({length:ne.length},(De,Ve)=>Ve);de.sort((De,Ve)=>ne[De]-ne[Ve]);const Ee=[],Pe=new os;for(let De=0;De<de.length;De++){const Ve=de[De];Ee.push(ne[Ve]);const Le=3*Ve,rt=Le+1;Pe.emplaceBack(ye.uint16[Le],ye.uint16[rt],ye.uint16[rt+1])}return[Ee,Pe]}(G,te),this.elevatedGlobeTrianglesCenterLongitudes=G,this.elevatedGlobeIndexBuffer=r.createIndexBuffer(te)}this.elevatedGlobeSegments=wn.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,V/Bt,0,W/Bt,0,0,z,F,0])}prepare(){const r=Object.keys(this.tiles).length!==0;if(this.tileID&&!r)return;const o=this.map.painter.context,u=o.gl;!this._dirty||this.texture instanceof Ty||(this.texture?this.texture.update(this.image):(this.texture=new jx(o,this.image,u.RGBA),this.texture.bind(u.LINEAR,u.CLAMP_TO_EDGE)),this._dirty=!1),r&&this._prepareData(o)}loadTile(r,o){this.tileID&&this.tileID.equals(r.tileID.canonical)?(this.tiles[String(r.tileID.wrap)]=r,r.buckets={},o(null)):(r.state="errored",o(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(r){const o=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!o)return null;const u=this.elevatedGlobeTrianglesCenterLongitudes;let f=((M,I)=>M+360*Math.round((I-M)/360))(r+180,u[0]);const m=new wn,y=(M,I)=>{m.segments.push({vertexOffset:0,primitiveOffset:M,vertexLength:o.segments[0].vertexLength,primitiveLength:I,sortKey:void 0,vaos:{}})},b=.51*this.maxLongitudeTriangleSize;if(Math.abs(u[0]-f)<=b){const M=Xe(u,0,u.length,f+b);return M===u.length||y(M,Te(u,M+1,u.length,f+360-b)-M),m}f<u[0]&&(f+=360);const T=Te(u,0,u.length,f-b);if(T===u.length)return y(0,u.length),m;y(0,T-0);const E=Xe(u,T+1,u.length,f+b);return E!==u.length&&y(E,u.length-E),m}}const UB=(Math.pow(256,2)-1)/16907520;class cC extends Ws{constructor(r,o,u){super(r,zB,o,u),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isLayerDraped(r){return!(r&&r._source instanceof lC&&(r._source.onNorthPole||r._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(r){r!=="raster-color"&&r!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(r){if(!this.hasColorMap()||!this._curRampRange)return;const o=this._transitionablePaint._values["raster-color"].value.expression,[u,f]=r||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(u)&&isNaN(f)||u===this._curRampRange[0]&&f===this._curRampRange[1]||(this.colorRamp=sm({expression:o,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:u,end:f}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[u,f])}}const VB=new fn({visibility:new Pt(Fe["layout_raster-particle"].visibility)});var jB={paint:new fn({"raster-particle-array-band":new Pt(Fe["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new Pt(Fe["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new vl(Fe["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new Pt(Fe["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new Pt(Fe["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new Pt(Fe["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new Pt(Fe["paint_raster-particle"]["raster-particle-reset-rate-factor"])}),layout:VB};class uC extends Ws{constructor(r,o,u){super(r,jB,o,u),this._updateColorRamp(),this.onRemove=f=>{this.colorRampTexture&&this.colorRampTexture.destroy(),this.transformFeedbackObject&&f.painter.context.gl.deleteTransformFeedback(this.transformFeedbackObject),this.tileFramebuffer&&this.tileFramebuffer.destroy()},this.lastInvalidatedAt=lt.now()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isLayerDraped(r){return!1}_handleSpecialPaintPropertyUpdate(r){r!=="raster-particle-color"&&r!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),r==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const r=this._transitionablePaint._values["raster-particle-color"].value.expression,o=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=sm({expression:r,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:o}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=lt.now()}}class $B extends Ws{constructor(r,o){super(r,{},o),this.implementation=r,r.slot&&(this.slot=r.slot)}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isLayerDraped(r){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(r){this.implementation.onAdd&&this.implementation.onAdd(r,r.painter.context.gl)}onRemove(r){this.implementation.onRemove&&this.implementation.onRemove(r,r.painter.context.gl)}}const WB=new fn({visibility:new Pt(Fe.layout_sky.visibility)});var HB={paint:new fn({"sky-type":new Pt(Fe.paint_sky["sky-type"]),"sky-atmosphere-sun":new Pt(Fe.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Pt(Fe.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Pt(Fe.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Pt(Fe.paint_sky["sky-gradient-radius"]),"sky-gradient":new vl(Fe.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Pt(Fe.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Pt(Fe.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Pt(Fe.paint_sky["sky-opacity"])}),layout:WB};function $x(n,r,o){const u=[0,0,1],f=l.bi.identity([]);return l.bi.rotateY(f,f,o?-Qe(n)+Math.PI:Qe(n)),l.bi.rotateX(f,f,-Qe(r)),l.N.transformQuat(u,u,f),l.N.normalize(u,u)}var qB={paint:new fn({})};function hC(n,r){const o=Ay(n.projection,n.zoom,n.width,n.height),u=function(m,y,b,T,E){const M=new ke(b.lng-180*mc,b.lat),I=new ke(b.lng+180*mc,b.lat),k=m.project(M.lng,M.lat),F=m.project(I.lng,I.lat),z=-Math.atan2(F.y-k.y,F.x-k.x),V=sr.fromLngLat(b);V.y=ri(V.y,-1+mc,1-mc);const W=V.toLngLat(),G=m.project(W.lng,W.lat),te=sr.fromLngLat(W);te.x+=mc;const se=te.toLngLat(),ne=m.project(se.lng,se.lat),ye=pC(ne.x-G.x,ne.y-G.y,z),de=sr.fromLngLat(W);de.y+=mc;const Ee=de.toLngLat(),Pe=m.project(Ee.lng,Ee.lat),De=pC(Pe.x-G.x,Pe.y-G.y,z),Ve=Math.abs(ye.x)/Math.abs(De.y),Le=l.a6.identity([]);l.a6.rotateZ(Le,Le,-z*(1-(E?0:T)));const rt=l.a6.identity([]);return l.a6.scale(rt,rt,[1,1-(1-Ve)*T,1]),rt[4]=-De.x/De.y*T,l.a6.rotateZ(rt,rt,z),l.a6.multiply(rt,Le,rt),rt}(n.projection,0,n.center,o,r),f=dC(n);return l.a6.scale(u,u,[f,f,1]),u}function dC(n){const r=n.projection,o=Ay(n.projection,n.zoom,n.width,n.height),u=fC(r,n.center),f=fC(r,ke.convert(r.center));return Math.pow(2,u*o+(1-o)*f)}function Ay(n,r,o,u,f=1/0){const m=n.range;if(!m)return 0;const y=Math.min(f,Math.max(o,u)),b=Math.log(y/1024)/Math.LN2;return vr(m[0]+b,m[1]+b,r)}const mc=1/4e4;function fC(n,r){const o=ri(r.lat,-Ui,Ui),u=new ke(r.lng-180*mc,o),f=new ke(r.lng+180*mc,o),m=n.project(u.lng,o),y=n.project(f.lng,o),b=sr.fromLngLat(u),T=sr.fromLngLat(f),E=y.x-m.x,M=y.y-m.y,I=T.x-b.x,k=T.y-b.y,F=Math.sqrt((I*I+k*k)/(E*E+M*M));return Math.log(F)/Math.LN2}function pC(n,r,o){const u=Math.cos(o),f=Math.sin(o);return{x:n*u-r*f,y:n*f+r*u}}function mC(n,r,o){l.a6.identity(n),l.a6.rotateZ(n,n,Qe(r[2])),l.a6.rotateX(n,n,Qe(r[0])),l.a6.rotateY(n,n,Qe(r[1])),l.a6.scale(n,n,o),l.a6.multiply(n,n,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function My(n,r,o,u,f,m,y,b){const T=[o[0]-r[0],o[1]-r[1],0],E=[u[0]-r[0],u[1]-r[1],0];if(l.N.length(T)<1e-12||l.N.length(E)<1e-12)return l.bi.identity(n);const M=l.N.cross([],T,E);l.N.normalize(M,M),l.N.subtract(E,u,r),T[2]=(m-f)*b,E[2]=(y-f)*b;const I=T;return l.N.cross(I,T,E),l.N.normalize(I,I),l.bi.rotationTo(n,M,I)}function Wx(n,r,o=!1){const u=lc(r.zoom),f=function(m,y,b){const T=y.worldSize,E=[m[12],m[13],m[14]],M=Qi(E[1]/T),I=wi(E[0]/T),k=l.a6.identity([]),F=Ti(1,M)*T,z=Ti(1,0)*T*Vi(M,y.zoom),V=1/px(T);let W=z*V;if(b){const ne=Ay(y.projection,y.zoom,y.width,y.height,1024);W=V*y.projection.pixelSpaceConversion(y.center.lat,T,ne)}const G=Ye(M,I);l.N.add(G,G,l.N.scale([],l.N.normalize([],G),F*W*E[2]));const te=function(ne){const ye=[ne[0],ne[1],ne[2]];let de=[0,1,0];const Ee=l.N.cross([],de,ye);return l.N.cross(de,ye,Ee),l.N.squaredLength(de)===0&&(de=[0,1,0],l.N.cross(Ee,ye,de)),l.N.normalize(Ee,Ee),l.N.normalize(de,de),l.N.normalize(ye,ye),[Ee[0],Ee[1],Ee[2],0,de[0],de[1],de[2],0,ye[0],ye[1],ye[2],0,ne[0],ne[1],ne[2],1]}(G);l.a6.scale(k,k,[W,W,W*F]),l.a6.translate(k,k,[-E[0],-E[1],-E[2]]);const se=l.a6.multiply([],y.globeMatrix,te);return l.a6.multiply(se,se,k),l.a6.multiply(se,se,m),se}(n,r,o);if(u>0){const m=function(y,b){const T=b.worldSize,E=Ti(1,0)*T*Vi(b.center.lat,b.zoom)/px(T),M=Ti(1,b.center.lat)*T,I=l.a6.identity([]);return l.a6.rotateY(I,I,Qe(b.center.lng)),l.a6.rotateX(I,I,Qe(b.center.lat)),l.a6.translate(I,I,[0,0,re]),l.a6.scale(I,I,[E,E,E*M]),l.a6.translate(I,I,[b.point.x-.5*T,b.point.y-.5*T,0]),l.a6.multiply(I,I,y),l.a6.multiply(I,b.globeMatrix,I)}(n,r);return function(y,b,T){const E=(z,V,W)=>{const G=l.N.length(z),te=l.N.length(V),se=Al(z,V,W);return l.N.scale(se,se,1/l.N.length(se)*Ut(G,te,W))},M=E([y[0],y[1],y[2]],[b[0],b[1],b[2]],T),I=E([y[4],y[5],y[6]],[b[4],b[5],b[6]],T),k=E([y[8],y[9],y[10]],[b[8],b[9],b[10]],T),F=Al([y[12],y[13],y[14]],[b[12],b[13],b[14]],T);return[M[0],M[1],M[2],0,I[0],I[1],I[2],0,k[0],k[1],k[2],0,F[0],F[1],F[2],1]}(f,m,u)}return f}function _C(n,r,o,u){const f=xn.projectAabbCorners(u,o);let m=Number.MAX_VALUE,y=-1;for(let E=0;E<f.length;++E){const M=f[E];M[0]=(.5*M[0]+.5)*r.width,M[1]=(.5-.5*M[1])*r.height,M[2]<m&&(y=E,m=M[2])}const b=E=>new xe(f[E][0],f[E][1]);let T;switch(y){case 0:case 6:T=[b(1),b(5),b(4),b(7),b(3),b(2),b(1)];break;case 1:case 7:T=[b(0),b(4),b(5),b(6),b(2),b(3),b(0)];break;case 3:case 5:T=[b(1),b(0),b(4),b(7),b(6),b(2),b(1)];break;default:T=[b(1),b(5),b(6),b(7),b(3),b(0),b(1)]}if(Vo(n,T))return m}const GB=Mr([{name:"a_pos_3f",components:3,type:"Float32"}]),XB=Mr([{name:"a_color_3f",components:3,type:"Float32"}]),ZB=Mr([{name:"a_color_4f",components:4,type:"Float32"}]),YB=Mr([{name:"a_uv_2f",components:2,type:"Float32"}]),KB=Mr([{name:"a_normal_3f",components:3,type:"Float32"}]),JB=Mr([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),QB=Mr([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);class gC{constructor(r,o){this.feature=r,this.instancedDataOffset=o,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class yC{constructor(){this.instancedDataArray=new Yp,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Hx{constructor(r){this.zoom=r.zoom,this.canonical=r.canonical,this.layers=r.layers,this.layerIds=this.layers.map(o=>o.fqid),this.projection=r.projection,this.index=r.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(o=>o.isStateDependent()).map(o=>o.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0}}populate(r,o,u,f){this.tileToMeter=ji(u);const m=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:y,id:b,index:T,sourceLayerIndex:E}of r){const M=Xn(y,m);if(!this.layers[0]._featureFilter.filter(new dn(this.zoom),M,u))continue;const I={id:b,sourceLayerIndex:E,index:T,geometry:m?M.geometry:ls(y,u,f),properties:y.properties,type:y.type,patterns:{}},k=this.addFeature(I,I.geometry,M);k&&o.featureIndex.insert(y,I.geometry,T,E,this.index,this.instancesPerModel[k].instancedDataArray.length,Bt/32)}this.lookup=null}update(r,o,u,f){for(const m in this.instancesPerModel){const y=this.instancesPerModel[m];for(const b in r)y.idToFeaturesIndex.hasOwnProperty(b)&&this.evaluate(y.features[y.idToFeaturesIndex[b]],r[b],y,!0)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let r=!1;for(const o in this.instancesPerModel){const u=this.instancesPerModel[o];for(const f of u.features){const m=this.layers[0],y=f.feature,b=this.canonical,T=m.paint.get("model-rotation").evaluate(y,{},b),E=m.paint.get("model-scale").evaluate(y,{},b),M=m.paint.get("model-translation").evaluate(y,{},b);l.N.exactEquals(f.rotation,T)&&l.N.exactEquals(f.scale,E)&&l.N.exactEquals(f.translation,M)||(this.evaluate(f,f.featureStates,u,!0),r=!0)}}return r}isEmpty(){for(const r in this.instancesPerModel)if(this.instancesPerModel[r].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(r){if(!this.uploaded)for(const o in this.instancesPerModel){const u=this.instancesPerModel[o];u.instancedDataArray.length<0||u.instancedDataArray.length===0||(u.instancedDataBuffer?u.instancedDataBuffer.updateData(u.instancedDataArray):u.instancedDataBuffer=r.createVertexBuffer(u.instancedDataArray,JB.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const r in this.instancesPerModel){const o=this.instancesPerModel[r];o.instancedDataArray.length!==0&&o.instancedDataBuffer&&o.instancedDataBuffer.destroy()}}addFeature(r,o,u){const f=this.layers[0],m=f.layout.get("model-id").evaluate(u,{},this.canonical);if(!m)return mr(`modelId is not evaluated for layer ${f.id} and it is not going to get rendered.`),m;this.instancesPerModel[m]||(this.instancesPerModel[m]=new yC);const y=this.instancesPerModel[m],b=y.instancedDataArray,T=new gC(u,b.length);for(const E of o)for(const M of E){if(M.x<0||M.x>=Bt||M.y<0||M.y>=Bt)continue;const I=(this.lookupDim-1)/Bt,k=this.lookupDim*(M.y*I|0)+M.x*I|0;if(this.lookup){if(this.lookup[k]!==0)continue;this.lookup[k]=1}this.instanceCount++;const F=b.length;b.resize(F+1),y.instancesEvaluatedElevation.push(0),b.float32[16*F]=M.x,b.float32[16*F+1]=M.y}return T.instancedDataCount=y.instancedDataArray.length-T.instancedDataOffset,T.instancedDataCount>0&&(r.id&&(y.idToFeaturesIndex[r.id]=y.features.length),y.features.push(T),this.evaluate(T,{},y,!1)),m}evaluate(r,o,u,f){const m=this.layers[0],y=r.feature,b=this.canonical,T=r.rotation=m.paint.get("model-rotation").evaluate(y,o,b),E=r.scale=m.paint.get("model-scale").evaluate(y,o,b),M=r.translation=m.paint.get("model-translation").evaluate(y,o,b),I=m.paint.get("model-color").evaluate(y,o,b);I.a=m.paint.get("model-color-mix-intensity").evaluate(y,o,b);const k=[];this.maxVerticalOffset<M[2]&&(this.maxVerticalOffset=M[2]),this.maxScale=Math.max(Math.max(this.maxScale,E[0]),Math.max(E[1],E[2])),mC(k,T,E);const F=Math.round(100*I.a)+I.b/1.05;for(let z=0;z<r.instancedDataCount;++z){const V=r.instancedDataOffset+z,W=16*V,G=u.instancedDataArray.float32;let te=0;f&&(te=G[W+6]-u.instancesEvaluatedElevation[V]);const se=0|G[W+1];G[W]=(0|G[W])+I.r/1.05,G[W+1]=se+I.g/1.05,G[W+2]=F,G[W+3]=1/(b.z>10?this.tileToMeter:ji(b,se)),G[W+4]=M[0],G[W+5]=M[1],G[W+6]=M[2]+te,G[W+7]=k[0],G[W+8]=k[1],G[W+9]=k[2],G[W+10]=k[4],G[W+11]=k[5],G[W+12]=k[6],G[W+13]=k[8],G[W+14]=k[9],G[W+15]=k[10],u.instancesEvaluatedElevation[V]=M[2]}}}Ht(Hx,"ModelBucket",{omit:["layers"]}),Ht(yC,"PerModelAttributes"),Ht(gC,"ModelFeature");const ez=new fn({visibility:new Pt(Fe.layout_model.visibility),"model-id":new oi(Fe.layout_model["model-id"])});var tz={paint:new fn({"model-opacity":new Pt(Fe.paint_model["model-opacity"]),"model-rotation":new oi(Fe.paint_model["model-rotation"]),"model-scale":new oi(Fe.paint_model["model-scale"]),"model-translation":new oi(Fe.paint_model["model-translation"]),"model-color":new oi(Fe.paint_model["model-color"]),"model-color-mix-intensity":new oi(Fe.paint_model["model-color-mix-intensity"]),"model-type":new Pt(Fe.paint_model["model-type"]),"model-cast-shadows":new Pt(Fe.paint_model["model-cast-shadows"]),"model-receive-shadows":new Pt(Fe.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new Pt(Fe.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new oi(Fe.paint_model["model-emissive-strength"]),"model-roughness":new oi(Fe.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new oi(Fe.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new Pt(Fe.paint_model["model-cutoff-fade-range"])}),layout:ez};const Vu=64,Sd={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function vC(n,r,o,u,f,m,y,b,T,E=!1){const M=o.zoom,I=o.project(u),k=Vi(u.lat,M),F=1/k;l.a6.identity(n),l.a6.translate(n,n,[I.x+y[0]*F,I.y+y[1]*F,y[2]]);let z=1,V=1;const W=o.worldSize;if(E){if(o.projection.name==="mercator"){let ne=0;o.elevation&&(ne=o.elevation.getAtPointOrZero(new sr(I.x/W,I.y/W),0));const ye=l.a7.transformMat4([],[I.x,I.y,ne,1],o.projMatrix)[3]/o.cameraToCenterDistance;z=ye,V=ye*Vi(o.center.lat,M)}else if(o.projection.name==="globe"){const ne=Wx(n,o),ye=l.a6.multiply([],o.projMatrix,ne),de=[0,0,0,1];l.a7.transformMat4(de,de,ye);const Ee=de[3]/o.cameraToCenterDistance,Pe=lc(M),De=o.projection.pixelsPerMeter(u.lat,W)*Vi(u.lat,M),Ve=o.projection.pixelsPerMeter(o.center.lat,W)*Vi(o.center.lat,M);z=Ee/Ut(De,pn(o.center.lat),Pe),V=Ee*k/De,z*=Ve,V*=Ve}}else z=F;l.a6.scale(n,n,[z,z,V]);const G=[...n],te=r.orientation,se=[];if(mC(se,[te[0]+f[0],te[1]+f[1],te[2]+f[2]],m),l.a6.multiply(n,G,se),b&&o.elevation){let ne=0;const ye=[];if(T&&o.elevation){ne=function(Pe,De,Ve,Le,rt){const ht=De.elevation;if(!ht)return 0;const Ze=xn.projectAabbCorners(Ve,Le),ct=Ti(1,rt.lat)*De.worldSize,qe=function(ai,Di){const di=[0,0,1],Li=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const xi of Li){const Xi=ai[xi.corners[0]],Ei=ai[xi.corners[1]],Br=ai[xi.corners[2]],cr=[Ei[0]-Xi[0],Ei[1]-Xi[1],Di*(Ei[2]-Xi[2])],pr=l.N.cross(cr,cr,[Br[0]-Xi[0],Br[1]-Xi[1],Di*(Br[2]-Xi[2])]);l.N.normalize(pr,pr),xi.dotProductWithUp=l.N.dot(pr,di)}return Li.sort((xi,Xi)=>xi.dotProductWithUp-Xi.dotProductWithUp),Li[0].corners}(Ze,ct),at=Ze[qe[0]],Ot=Ze[qe[1]],dt=Ze[qe[2]],Xt=Ze[qe[3]],Wt=ht.getAtPointOrZero(new sr(at[0]/De.worldSize,at[1]/De.worldSize),0),_t=ht.getAtPointOrZero(new sr(Ot[0]/De.worldSize,Ot[1]/De.worldSize),0),hi=ht.getAtPointOrZero(new sr(dt[0]/De.worldSize,dt[1]/De.worldSize),0),ti=ht.getAtPointOrZero(new sr(Xt[0]/De.worldSize,Xt[1]/De.worldSize),0),qt=(Wt+ti)/2,gt=(_t+hi)/2;return qt>gt?_t<hi?My(Pe,Ot,Xt,at,_t,ti,Wt,ct):My(Pe,dt,at,Xt,hi,Wt,ti,ct):Wt<ti?My(Pe,at,Ot,dt,Wt,_t,hi,ct):My(Pe,Xt,dt,Ot,ti,hi,_t,ct),Math.max(qt,gt)}(ye,o,r.aabb,n,u);const de=l.a6.fromQuat([],ye),Ee=l.a6.multiply([],de,se);l.a6.multiply(n,G,Ee)}else ne=o.elevation.getAtPointOrZero(new sr(I.x/W,I.y/W),0);ne!==0&&(n[14]+=ne)}}function bm(n,r,o=!1){n.uploaded||(n.gfxTexture=new jx(r,n.image,o?r.gl.R8:r.gl.RGBA,{useMipmap:n.sampler.minFilter>=r.gl.NEAREST_MIPMAP_NEAREST}),n.uploaded=!0,n.image=null)}function iz(n,r,o){n.indexBuffer=r.createIndexBuffer(n.indexArray,!1,!0),n.vertexBuffer=r.createVertexBuffer(n.vertexArray,GB.members,!1,!0),n.normalArray&&(n.normalBuffer=r.createVertexBuffer(n.normalArray,KB.members,!1,!0)),n.texcoordArray&&(n.texcoordBuffer=r.createVertexBuffer(n.texcoordArray,YB.members,!1,!0)),n.colorArray&&(n.colorBuffer=r.createVertexBuffer(n.colorArray,(n.colorArray.bytesPerElement===12?XB:ZB).members,!1,!0)),n.featureArray&&(n.pbrBuffer=r.createVertexBuffer(n.featureArray,QB.members,!0)),n.segments=wn.simpleSegment(0,0,n.vertexArray.length,n.indexArray.length);const u=n.material;u.pbrMetallicRoughness.baseColorTexture&&bm(u.pbrMetallicRoughness.baseColorTexture,r),u.pbrMetallicRoughness.metallicRoughnessTexture&&bm(u.pbrMetallicRoughness.metallicRoughnessTexture,r),u.normalTexture&&bm(u.normalTexture,r),u.occlusionTexture&&bm(u.occlusionTexture,r,o),u.emissionTexture&&bm(u.emissionTexture,r)}function qx(n,r,o){if(n.meshes)for(const u of n.meshes)iz(u,r,o);if(n.children)for(const u of n.children)qx(u,r,o)}function Cy(n){if(n.meshes)for(const r of n.meshes)r.indexArray.destroy(),r.vertexArray.destroy(),r.colorArray&&r.colorArray.destroy(),r.normalArray&&r.normalArray.destroy(),r.texcoordArray&&r.texcoordArray.destroy(),r.featureArray&&r.featureArray.destroy();if(n.children)for(const r of n.children)Cy(r)}function Gx(n){if(n.meshes)for(const o of n.meshes)o.vertexBuffer&&(o.vertexBuffer.destroy(),o.indexBuffer.destroy(),o.normalBuffer&&o.normalBuffer.destroy(),o.texcoordBuffer&&o.texcoordBuffer.destroy(),o.colorBuffer&&o.colorBuffer.destroy(),o.pbrBuffer&&o.pbrBuffer.destroy(),o.segments.destroy(),o.material&&((r=o.material).pbrMetallicRoughness.baseColorTexture&&r.pbrMetallicRoughness.baseColorTexture.gfxTexture&&r.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),r.pbrMetallicRoughness.metallicRoughnessTexture&&r.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&r.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),r.normalTexture&&r.normalTexture.gfxTexture&&r.normalTexture.gfxTexture.destroy(),r.emissionTexture&&r.emissionTexture.gfxTexture&&r.emissionTexture.gfxTexture.destroy(),r.occlusionTexture&&r.occlusionTexture.gfxTexture&&r.occlusionTexture.gfxTexture.destroy()));var r;if(n.children)for(const o of n.children)Gx(o)}class rz{constructor(r){this._callback=r,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class nz{constructor(){this.tasks={},this.taskQueue=[],Ir(["process"],this),this.invoker=new rz(this.process),this.nextId=0}add(r,o){const u=this.nextId++,f=function({type:m,isSymbolTile:y,zoom:b}){return b=b||0,m==="message"?0:m!=="maybePrepare"||y?m!=="parseTile"||y?m==="parseTile"&&y?300-b:m==="maybePrepare"&&y?400-b:500:200-b:100-b}(o);if(f===0){Rn();try{r()}finally{}return null}return this.tasks[u]={fn:r,metadata:o,priority:f,id:u},this.taskQueue.push(u),this.invoker.trigger(),{cancel:()=>{delete this.tasks[u]}}}process(){Rn();try{if(this.taskQueue=this.taskQueue.filter(u=>!!this.tasks[u]),!this.taskQueue.length)return;const r=this.pick();if(r===null)return;const o=this.tasks[r];if(delete this.tasks[r],this.taskQueue.length&&this.invoker.trigger(),!o)return;o.fn()}finally{}}pick(){let r=null,o=1/0;for(let f=0;f<this.taskQueue.length;f++){const m=this.tasks[this.taskQueue[f]];m.priority<o&&(o=m.priority,r=f)}if(r===null)return null;const u=this.taskQueue[r];return this.taskQueue.splice(r,1),u}remove(){this.invoker.remove()}}class xC{constructor(r,o,u){this.target=r,this.parent=o,this.mapId=u,this.callbacks={},this.cancelCallbacks={},Ir(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new nz}send(r,o,u,f,m=!1,y){const b=Math.round(1e18*Math.random()).toString(36).substring(0,10);u&&(u.metadata=y,this.callbacks[b]=u);const T=new Set;return this.target.postMessage({id:b,type:r,hasCallback:!!u,targetMapId:f,mustQueue:m,sourceMapId:this.mapId,data:Da(o,T)},T),{cancel:()=>{u&&delete this.callbacks[b],this.target.postMessage({id:b,type:"<cancel>",targetMapId:f,sourceMapId:this.mapId})}}}receive(r){const o=r.data,u=o.id;if(u&&(!o.targetMapId||this.mapId===o.targetMapId))if(o.type==="<cancel>"){const f=this.cancelCallbacks[u];delete this.cancelCallbacks[u],f&&f.cancel()}else if(o.mustQueue||Rn()){const f=this.callbacks[u],m=this.scheduler.add(()=>this.processTask(u,o),f&&f.metadata||{type:"message"});m&&(this.cancelCallbacks[u]=m)}else this.processTask(u,o)}processTask(r,o){if(delete this.cancelCallbacks[r],o.type==="<response>"){const u=this.callbacks[r];delete this.callbacks[r],u&&(o.error?u(gl(o.error)):u(null,gl(o.data)))}else{const u=new Set,f=o.hasCallback?(y,b)=>{this.target.postMessage({id:r,type:"<response>",sourceMapId:this.mapId,error:y?Da(y):null,data:Da(b,u)},u)}:y=>{},m=gl(o.data);if(this.parent[o.type])this.parent[o.type](o.sourceMapId,m,f);else if(this.parent.getWorkerSource){const y=o.type.split(".");this.parent.getWorkerSource(o.sourceMapId,y[0],m.source,m.scope)[y[1]](m,f)}else f(new Error(`Could not find function ${o.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}class Ad{constructor(r,o){this.workerPool=r,this.actors=[],this.currentActor=0,this.id=$r();const u=this.workerPool.acquire(this.id);for(let f=0;f<u.length;f++){const m=new Ad.Actor(u[f],o,this.id);m.name=`Worker ${f}`,this.actors.push(m)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(r,o,u){Tr(this.actors,(f,m)=>{f.send(r,o,m)},u=u||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(r=>{r.remove()}),this.actors=[],this.workerPool.release(this.id)}}Ad.Actor=xC;var wm={workerUrl:"",workerClass:null,workerParams:void 0};function sz(){return wm.workerClass!=null?new wm.workerClass:new self.Worker(wm.workerUrl,wm.workerParams)}const Xx="mapboxgl_preloaded_worker_pool";class Tm{constructor(){this.active={}}acquire(r){if(!this.workers)for(this.workers=[];this.workers.length<Tm.workerCount;)this.workers.push(new sz);return this.active[r]=!0,this.workers.slice()}release(r){delete this.active[r],this.workers&&this.numActive()===0&&(this.workers.forEach(o=>{o.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Xx]}numActive(){return Object.keys(this.active).length}}let Em;function Py(){return Em||(Em=new Tm),Em}Tm.workerCount=2;let Iy,Zx,ha,Md,Yx,Cd=null;function bC(){return Rn()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:Zx||O.DRACO_URL}function wC(){if(Rn()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Md)return Md;const n=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Md=WebAssembly.validate(n)?O.MESHOPT_SIMD_URL:O.MESHOPT_URL,Md}const Ry={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},oz={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Sm={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function TC(n,r,o){const u=o.json.bufferViews.length,f=o.buffers.length;r.bufferView=u,o.json.bufferViews[u]={buffer:f,byteLength:n.byteLength},o.buffers[f]=n}const Kx="KHR_draco_mesh_compression";function az(n,r){const o=n.extensions&&n.extensions[Kx];if(!o)return;const u=new ha.Decoder,f=MC(r,o.bufferView),m=new ha.Mesh;if(!u.DecodeArrayToMesh(f,f.byteLength,m))throw new Error("Failed to decode Draco mesh");const y=r.json.accessors[n.indices],b=Ry[y.componentType],T=y.count*b.BYTES_PER_ELEMENT,E=ha._malloc(T);b===Uint16Array?u.GetTrianglesUInt16Array(m,T,E):u.GetTrianglesUInt32Array(m,T,E),TC(ha.memory.buffer.slice(E,E+T),y,r),ha._free(E);for(const M of Object.keys(o.attributes)){const I=u.GetAttributeByUniqueId(m,o.attributes[M]),k=r.json.accessors[n.attributes[M]],F=oz[k.componentType],z=k.count*Sm[k.type]*Ry[k.componentType].BYTES_PER_ELEMENT,V=ha._malloc(z);u.GetAttributeDataArrayForAllPoints(m,I,ha[F],z,V),TC(ha.memory.buffer.slice(V,V+z),k,r),ha._free(V)}u.destroy(),m.destroy(),delete n.extensions[Kx]}const Oy="EXT_meshopt_compression";function lz(n,r){if(!n.extensions||!n.extensions[Oy])return;const o=n.extensions[Oy],u=new Uint8Array(r.buffers[o.buffer],o.byteOffset||0,o.byteLength||0),f=new Uint8Array(o.count*o.byteStride);Yx.decodeGltfBuffer(f,o.count,o.byteStride,u,o.mode,o.filter),n.buffer=r.buffers.length,n.byteOffset=0,r.buffers[n.buffer]=f.buffer,delete n.extensions[Oy]}const EC=1179937895,SC=new TextDecoder("utf8");function AC(n,r){return new URL(n,r).href}function cz(n,r,o,u){return fetch(AC(n.uri,u)).then(f=>f.arrayBuffer()).then(f=>{r.buffers[o]=f})}function MC(n,r){const o=n.json.bufferViews[r];return new Uint8Array(n.buffers[o.buffer],o.byteOffset||0,o.byteLength)}function uz(n,r,o,u){if(n.uri){const f=AC(n.uri,u);return fetch(f).then(m=>m.blob()).then(m=>createImageBitmap(m)).then(m=>{r.images[o]=m})}if(n.bufferView!==void 0){const f=MC(r,n.bufferView),m=new Blob([f],{type:n.mimeType});return createImageBitmap(m).then(y=>{r.images[o]=y})}}function CC(n,r=0,o){const u={json:null,images:[],buffers:[]};if(new Uint32Array(n,r,1)[0]===EC){const M=new Uint32Array(n,r);let I=2;const k=(M[I++]>>2)-3,F=M[I++]>>2;if(I++,u.json=JSON.parse(SC.decode(M.subarray(I,I+F))),I+=F,I<k){const z=M[I++];I++;const V=r+(I<<2);u.buffers[0]=n.slice(V,V+z)}}else u.json=JSON.parse(SC.decode(new Uint8Array(n,r)));const{buffers:f,images:m,meshes:y,extensionsUsed:b,bufferViews:T}=u.json;let E=Promise.resolve();if(f){const M=[];for(let I=0;I<f.length;I++){const k=f[I];k.uri?M.push(cz(k,u,I,o)):u.buffers[I]||(u.buffers[I]=null)}E=Promise.all(M)}return E.then(()=>{const M=[],I=b&&b.includes(Kx),k=b&&b.includes(Oy);if(I&&M.push(function(){if(!ha)return Iy||(Iy=function(F){let z,V=null;function W(){z=new Uint8Array(V.buffer)}function G(){throw new Error("Unexpected Draco error.")}const te={a:{a:G,d:function(se,ne,ye){return z.copyWithin(se,ne,ne+ye)},c:function(se){const ne=z.length,ye=Math.max(se>>>0,Math.ceil(1.2*ne)),de=Math.ceil((ye-ne)/65536);try{return V.grow(de),W(),!0}catch{return!1}},b:G}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(F,te):F.then(se=>se.arrayBuffer()).then(se=>WebAssembly.instantiate(se,te))).then(se=>{const{Rb:ne,Qb:ye,P:de,T:Ee,X:Pe,Ja:De,La:Ve,Qa:Le,Va:rt,Wa:ht,eb:Ze,jb:ct,f:qe,e:at,yb:Ot,zb:dt,Ab:Xt,Bb:Wt,Db:_t,Gb:hi}=se.instance.exports;V=at;const ti=(()=>{let qt=0,gt=0,ai=0,Di=0;return di=>{ai&&(ne(Di),ne(qt),gt+=ai,ai=qt=0),qt||(gt+=128,qt=ye(gt));const Li=di.length+7&-8;let xi=qt;Li>=gt&&(ai=Li,xi=Di=ye(Li));for(let Xi=0;Xi<di.length;Xi++)z[xi+Xi]=di[Xi];return xi}})();return W(),qe(),{memory:at,_free:ne,_malloc:ye,Mesh:class{constructor(){this.ptr=de()}destroy(){Ee(this.ptr)}},Decoder:class{constructor(){this.ptr=De()}destroy(){ct(this.ptr)}DecodeArrayToMesh(qt,gt,ai){const Di=ti(qt),di=Ve(this.ptr,Di,gt,ai.ptr);return!!Pe(di)}GetAttributeByUniqueId(qt,gt){return{ptr:Le(this.ptr,qt.ptr,gt)}}GetTrianglesUInt16Array(qt,gt,ai){rt(this.ptr,qt.ptr,gt,ai)}GetTrianglesUInt32Array(qt,gt,ai){ht(this.ptr,qt.ptr,gt,ai)}GetAttributeDataArrayForAllPoints(qt,gt,ai,Di,di){Ze(this.ptr,qt.ptr,gt.ptr,ai,Di,di)}},DT_INT8:Ot(),DT_UINT8:dt(),DT_INT16:Xt(),DT_UINT16:Wt(),DT_UINT32:_t(),DT_FLOAT32:hi()}})}(fetch(bC())),Iy.then(F=>{ha=F,Iy=void 0}))}()),k&&M.push(function(){if(Yx)return;const F=function(z){let V;const W=WebAssembly.instantiateStreaming(z,{}).then(se=>{V=se.instance,V.exports.__wasm_call_ctors()}),G={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},te={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:W,supported:!0,decodeGltfBuffer(se,ne,ye,de,Ee,Pe){(function(De,Ve,Le,rt,ht,Ze,ct){const qe=De.exports.sbrk,at=rt+3&-4,Ot=qe(at*ht),dt=qe(Ze.length),Xt=new Uint8Array(De.exports.memory.buffer);Xt.set(Ze,dt);const Wt=Ve(Ot,rt,ht,dt,Ze.length);if(Wt===0&&ct&&ct(Ot,at,ht),Le.set(Xt.subarray(Ot,Ot+rt*ht)),qe(Ot-qe(0)),Wt!==0)throw new Error(`Malformed buffer data: ${Wt}`)})(V,V.exports[te[Ee]],se,ne,ye,de,V.exports[G[Pe]])}}}(fetch(wC()));return F.ready.then(()=>{Yx=F})}()),m)for(let F=0;F<m.length;F++)M.push(uz(m[F],u,F,o));return(M.length?Promise.all(M):Promise.resolve()).then(()=>{if(I&&y)for(const{primitives:F}of y)for(const z of F)az(z,u);if(k&&y&&T)for(const F of T)lz(F,u);return u})})}class PC{constructor(r,o,u){if(this.triangleCount=o.length/3,this.min=new xe(0,0),this.max=new xe(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||r.length===0||u===0)return;const f=r.map(M=>M.x),m=r.map(M=>M.y);this.min=new xe(Math.min(...f),Math.min(...m)),this.max=new xe(Math.max(...f),Math.max(...m));const y=this.max.sub(this.min);y.x=Math.max(y.x,1),y.y=Math.max(y.y,1);const b=Math.max(y.x,y.y)/u;this.cellsX=Math.max(1,Math.ceil(y.x/b)),this.cellsY=Math.max(1,Math.ceil(y.y/b)),this.xScale=1/b,this.yScale=1/b;const T=[];for(let M=0;M<this.triangleCount;M++){const I=r[o[3*M+0]].sub(this.min),k=r[o[3*M+1]].sub(this.min),F=r[o[3*M+2]].sub(this.min),z=_c(Math.floor(Math.min(I.x,k.x,F.x)),this.xScale,this.cellsX),V=_c(Math.floor(Math.max(I.x,k.x,F.x)),this.xScale,this.cellsX),W=_c(Math.floor(Math.min(I.y,k.y,F.y)),this.yScale,this.cellsY),G=_c(Math.floor(Math.max(I.y,k.y,F.y)),this.yScale,this.cellsY),te=new xe(0,0),se=new xe(0,0),ne=new xe(0,0),ye=new xe(0,0);for(let de=W;de<=G;++de){te.y=se.y=de*b,ne.y=ye.y=(de+1)*b;for(let Ee=z;Ee<=V;++Ee)te.x=ne.x=Ee*b,se.x=ye.x=(Ee+1)*b,(q1(I,k,F,te,se,ye)||q1(I,k,F,te,ye,ne))&&T.push({cellIdx:de*this.cellsX+Ee,triIdx:M})}}if(T.length===0)return;T.sort((M,I)=>M.cellIdx-I.cellIdx||M.triIdx-I.triIdx);let E=0;for(;E<T.length;){const M=T[E].cellIdx,I={start:this.payload.length,len:0};for(;E<T.length&&T[E].cellIdx===M;)++I.len,this.payload.push(T[E++].triIdx);this.cells[M]=I}}query(r,o,u){if(this.triangleCount===0||this.cells.length===0||r.x>this.max.x||this.min.x>o.x||r.y>this.max.y||this.min.y>o.y)return;this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8)));for(let T=0;T<this.lookup.length;T++)this.lookup[T]=0;const f=_c(r.x-this.min.x,this.xScale,this.cellsX),m=_c(o.x-this.min.x,this.xScale,this.cellsX),y=_c(r.y-this.min.y,this.yScale,this.cellsY),b=_c(o.y-this.min.y,this.yScale,this.cellsY);for(let T=y;T<=b;T++)for(let E=f;E<=m;E++){const M=this.cells[T*this.cellsX+E];if(M)for(let I=0;I<M.len;I++){const k=this.payload[M.start+I],F=Math.floor(k/8),z=1<<k%8;if(!(this.lookup[F]&z)&&(this.lookup[F]|=z,u.push(k),u.length===this.triangleCount))return}}}}function _c(n,r,o){return Math.max(0,Math.min(o-1,Math.floor(n*r)))}function ju(n,r){const o=n.json.bufferViews[r.bufferView],u=Ry[r.componentType];return new u(n.buffers[o.buffer],(r.byteOffset||0)+(o.byteOffset||0),r.count*(o.byteStride&&o.byteStride!==Sm[r.type]*u.BYTES_PER_ELEMENT?o.byteStride/u.BYTES_PER_ELEMENT:Sm[r.type]))}function Jx(n,r,o,u){const f=Ry[r.componentType],m=function(M){switch(M){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(f),y=n.json.bufferViews[r.bufferView],b=y.byteStride?y.byteStride/f.BYTES_PER_ELEMENT:Sm[r.type],T=o.float32,E=T.length/o.capacity;for(let M=0,I=0;M<r.count*b;M+=b,I+=E)for(let k=0;k<E;k++)T[I+k]=u[M+k]*m;o._trim()}function hz(n,r,o){const u=n.indices,f=n.attributes,m={};m.indexArray=new os;const y=r.json.accessors[u],b=y.count/3;m.indexArray.reserve(b);const T=ju(r,y);for(let k=0;k<b;k++)m.indexArray.emplaceBack(T[3*k],T[3*k+1],T[3*k+2]);m.indexArray._trim(),m.vertexArray=new xl;const E=r.json.accessors[f.POSITION];m.vertexArray.reserve(E.count);const M=ju(r,E);for(let k=0;k<E.count;k++)m.vertexArray.emplaceBack(M[3*k],M[3*k+1],M[3*k+2]);if(m.vertexArray._trim(),m.aabb=new xn(E.min,E.max),m.centroid=function(k,F){const z=[0,0,0],V=k.length;if(V>0){for(let W=0;W<V;W++){const G=3*k[W];z[0]+=F[G],z[1]+=F[G+1],z[2]+=F[G+2]}z[0]/=V,z[1]/=V,z[2]/=V}return z}(T,M),f.COLOR_0!==void 0){const k=r.json.accessors[f.COLOR_0],F=Sm[k.type],z=ju(r,k);m.colorArray=F===3?new xl:new Ba,m.colorArray.resize(k.count),Jx(r,k,m.colorArray,z)}if(f.NORMAL!==void 0){m.normalArray=new xl;const k=r.json.accessors[f.NORMAL];m.normalArray.resize(k.count);const F=ju(r,k);Jx(r,k,m.normalArray,F)}if(f.TEXCOORD_0!==void 0&&o.length>0){m.texcoordArray=new Pu;const k=r.json.accessors[f.TEXCOORD_0];m.texcoordArray.resize(k.count);const F=ju(r,k);Jx(r,k,m.texcoordArray,F)}if(f._FEATURE_ID_RGBA4444!==void 0){const k=r.json.accessors[f._FEATURE_ID_RGBA4444];r.json.extensionsUsed&&r.json.extensionsUsed.includes("EXT_meshopt_compression")&&(m.featureData=ju(r,k))}f._FEATURE_RGBA4444!==void 0&&(m.featureData=new Uint32Array(ju(r,r.json.accessors[f._FEATURE_RGBA4444]).buffer));const I=n.material;return m.material=function(k,F){const{emissiveFactor:z=[0,0,0],alphaMode:V="OPAQUE",alphaCutoff:W=.5,normalTexture:G,occlusionTexture:te,emissiveTexture:se,doubleSided:ne}=k,{baseColorFactor:ye=[1,1,1,1],metallicFactor:de=1,roughnessFactor:Ee=1,baseColorTexture:Pe,metallicRoughnessTexture:De}=k.pbrMetallicRoughness||{},Ve=te?F[te.index]:void 0;if(te&&te.extensions&&te.extensions.KHR_texture_transform&&Ve){const Le=te.extensions.KHR_texture_transform;Ve.offsetScale=[Le.offset[0],Le.offset[1],Le.scale[0],Le.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Qt(...ye),metallicFactor:de,roughnessFactor:Ee,baseColorTexture:Pe?F[Pe.index]:void 0,metallicRoughnessTexture:De?F[De.index]:void 0},doubleSided:ne,emissiveFactor:z,alphaMode:V,alphaCutoff:W,normalTexture:G?F[G.index]:void 0,occlusionTexture:Ve,emissionTexture:se?F[se.index]:void 0,defined:k.defined===void 0}}(I!==void 0?r.json.materials[I]:{defined:!1},o),m}function IC(n,r,o){const{matrix:u,rotation:f,translation:m,scale:y,mesh:b,extras:T,children:E}=n,M={};if(M.matrix=u||l.a6.fromRotationTranslationScale([],f||[0,0,0,1],m||[0,0,0],y||[1,1,1]),b!==void 0){M.meshes=o[b];const I=M.anchor=[0,0];for(const k of M.meshes){const{min:F,max:z}=k.aabb;I[0]+=F[0]+z[0],I[1]+=F[1]+z[1]}I[0]=Math.floor(I[0]/M.meshes.length/2),I[1]=Math.floor(I[1]/M.meshes.length/2)}if(T&&(T.id&&(M.id=T.id),T.lights&&(M.lights=function(I){if(!I.length)return[];const k=function(G){const te=atob(G),se=new Uint8Array(te.length);for(let ne=0;ne<te.length;ne++)se[ne]=te.codePointAt(ne);return se}(I),F=[],z=k.length/24,V=new Uint16Array(k.buffer),W=new Float32Array(k.buffer);for(let G=0;G<z;G++){const te=V[2*G*6]/30,se=V[2*G*6+1]/30,ne=V[2*G*6+10]/100,ye=W[6*G+1],de=W[6*G+2],Ee=W[6*G+3],Pe=W[6*G+4],De=Ee-ye,Ve=Pe-de,Le=Math.hypot(De,Ve);F.push({pos:[ye+.5*De,de+.5*Ve,se],normal:[Ve/Le,-De/Le,0],width:Le,height:te,depth:ne,points:[ye,de,Ee,Pe]})}return F}(T.lights))),E){const I=[];for(const k of E)I.push(IC(r.json.nodes[k],r,o));M.children=I}return M}function dz(n){if(n.vertices.length===0||n.indices.length===0)return null;const[r,o]=[n.vertices[0].clone(),n.vertices[0].clone()];for(let y=1;y<n.vertices.length;++y){const b=n.vertices[y];r.x=Math.min(r.x,b.x),r.y=Math.min(r.y,b.y),o.x=Math.max(o.x,b.x),o.y=Math.max(o.y,b.y)}const u=Math.ceil(Math.max(o.x-r.x,o.y-r.y)/256),f=Math.max(8,u),m=new PC(n.vertices,n.indices,f);return{vertices:n.vertices,indices:n.indices,grid:m,min:r,max:o}}function fz(n){if(!n.extras||!n.extras.ground)return null;const r=n.extras.ground;if(!r||!Array.isArray(r)||r.length===0)return null;const o=r[0];if(!o||!Array.isArray(o)||o.length===0)return null;const u=[];for(const y of o){if(!Array.isArray(y)||y.length!==2)continue;const b=y[0],T=y[1];typeof b=="number"&&typeof T=="number"&&u.push(new xe(b,T))}if(u.length<3)return null;u.length>1&&u[u.length-1].equals(u[0])&&u.pop();let f=0;for(let y=0;y<u.length;y++){const b=u[y],T=u[(y+1)%u.length],E=u[(y+2)%u.length];f+=(b.x-T.x)*(E.y-T.y)-(E.x-T.x)*(b.y-T.y)}f>0&&u.reverse();const m=Qg(u.flatMap(y=>[y.x,y.y]),[]);return m.length===0?null:{vertices:u,indices:m}}function pz(n){const r=[],o=[];let u=0;for(const f of n){u=r.length;const m=f.vertexArray.float32,y=f.indexArray.uint16;for(let b=0;b<f.vertexArray.length;b++)r.push(new xe(m[3*b+0],m[3*b+1]));for(let b=0;b<3*f.indexArray.length;b++)o.push(y[b]+u)}if(o.length%3!=0)return null;for(let f=0;f<o.length;f+=3){const m=r[o[f+0]],y=r[o[f+1]],b=r[o[f+2]];(m.x-y.x)*(b.y-y.y)-(b.x-y.x)*(m.y-y.y)>0&&([o[f+1],o[f+2]]=[o[f+2],o[f+1]])}return{vertices:r,indices:o}}function RC(n){const r=function(T,E){const M=[],I=WebGL2RenderingContext;if(T.json.textures)for(const k of T.json.textures){const F={magFilter:I.LINEAR,minFilter:I.NEAREST,wrapS:I.REPEAT,wrapT:I.REPEAT};k.sampler!==void 0&&Object.assign(F,T.json.samplers[k.sampler]),M.push({image:E[k.source],sampler:F,uploaded:!1})}return M}(n,n.images),o=function(T,E){const M=[];for(const I of T.json.meshes){const k=[];for(const F of I.primitives)k.push(hz(F,T,E));M.push(k)}return M}(n,r),{scenes:u,scene:f,nodes:m}=n.json,y=u?u[f||0].nodes:m,b=[];for(const T of y)b.push(IC(m[T],n,o));return function(T,E,M){const I={},k=new Set;for(let F=0;F<T.length;F++){const z=M[E[F]];if(!z.extras)continue;const V=z.extras["mapbox:footprint:version"],W=z.extras["mapbox:footprint:id"];(V||W)&&k.add(F),V==="1.0.0"&&W&&(I[W]=F)}for(let F=0;F<T.length;F++){if(k.has(F))continue;const z=T[F],V=M[E[F]];if(!V.extras)continue;let W=null;z.id in I&&(W=pz(T[I[z.id]].meshes)),W||(W=fz(V)),W&&(z.footprint=dz(W))}if(k.size>0){const F=Array.from(k.values()).sort((z,V)=>z-V);for(let z=F.length-1;z>=0;z--)T.splice(F[z],1)}}(b,y,n.json.nodes),b}function mz(n){n.heightmap=new Float32Array(4096),n.heightmap.fill(-1);const r=n.vertexArray.float32,o=n.aabb.min[0]-1,u=n.aabb.min[1]-1,f=Vu/(n.aabb.max[0]-o+2),m=Vu/(n.aabb.max[1]-u+2);for(let y=0;y<r.length;y+=3){const b=r[y+2],T=(r[y+0]-o)*f|0,E=(r[y+1]-u)*m|0;b>n.heightmap[E*Vu+T]&&(n.heightmap[E*Vu+T]=b)}}function _z(n,r){const o={};o.indexArray=new os,o.indexArray.reserve(4*n.length),o.vertexArray=new xl,o.vertexArray.reserve(10*n.length),o.colorArray=new Ba,o.vertexArray.reserve(10*n.length);let u=0;for(const y of n){const b=Math.min(10,Math.max(4,1.3*y.height))*r,T=[-y.normal[1],y.normal[0],0],E=Math.min(.29,.1*y.width/y.depth),M=y.width-2*y.depth*r*(E+.01),I=l.N.scaleAndAdd([],y.pos,T,M/2),k=l.N.scaleAndAdd([],y.pos,T,-M/2),F=[I[0],I[1],I[2]+y.height],z=[k[0],k[1],k[2]+y.height],V=l.N.scaleAndAdd([],y.normal,T,E);l.N.scale(V,V,b);const W=l.N.scaleAndAdd([],y.normal,T,-E);l.N.scale(W,W,b),l.N.add(V,I,V),l.N.add(W,k,W),I[2]+=.1,k[2]+=.1,o.vertexArray.emplaceBack(V[0],V[1],V[2]),o.vertexArray.emplaceBack(W[0],W[1],W[2]),o.vertexArray.emplaceBack(I[0],I[1],I[2]),o.vertexArray.emplaceBack(k[0],k[1],k[2]),o.vertexArray.emplaceBack(F[0],F[1],F[2]),o.vertexArray.emplaceBack(z[0],z[1],z[2]),o.vertexArray.emplaceBack(I[0],I[1],I[2]),o.vertexArray.emplaceBack(k[0],k[1],k[2]),o.vertexArray.emplaceBack(V[0],V[1],V[2]),o.vertexArray.emplaceBack(W[0],W[1],W[2]);const G=M/b/2;o.colorArray.emplaceBack(-G-E,-1,G,.8),o.colorArray.emplaceBack(G+E,-1,G,.8),o.colorArray.emplaceBack(-G,0,G,1.3),o.colorArray.emplaceBack(G,0,G,1.3),o.colorArray.emplaceBack(G+E,-.8,G,.7),o.colorArray.emplaceBack(G+E,-.8,G,.7),o.colorArray.emplaceBack(0,0,G,1.3),o.colorArray.emplaceBack(0,0,G,1.3),o.colorArray.emplaceBack(G+E,-1.2,G,.8),o.colorArray.emplaceBack(G+E,-1.2,G,.8),o.indexArray.emplaceBack(6+u,4+u,8+u),o.indexArray.emplaceBack(7+u,9+u,5+u),o.indexArray.emplaceBack(0+u,1+u,2+u),o.indexArray.emplaceBack(1+u,3+u,2+u),u+=10}const f={defined:!0,emissiveFactor:[0,0,0]},m={};return m.baseColorFactor=Qt.white,f.pbrMetallicRoughness=m,o.material=f,o.aabb=new xn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),o}Ht(PC,"TriangleGridIndex");class OC{constructor(r){this._stringToNumber={},this._numberToString=[];for(let o=0;o<r.length;o++){const u=r[o];this._stringToNumber[u]=o,this._numberToString[o]=u}}encode(r){return this._stringToNumber[r]}decode(r){return this._numberToString[r]}}const gz=["tile","layer","source","sourceLayer","state"];class kC{constructor(r,o,u,f,m){this.type="Feature",this._vectorTileFeature=r,this._z=o,this._x=u,this._y=f,this.properties=r.properties,this.id=m}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(r){this._geometry=r}toJSON(){const r={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};this.id!==void 0&&(r.id=this.id);for(const o of gz)this[o]!==void 0&&(r[o]=this[o]);return r}}class DC{constructor(r,o){this.tileID=r,this.x=r.canonical.x,this.y=r.canonical.y,this.z=r.canonical.z,this.grid=new ia(Bt,16,0),this.featureIndexArray=new Rg,this.promoteId=o,this.is3DTile=!1}insert(r,o,u,f,m,y=0,b=0){const T=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(u,f,m,y);const E=this.grid;for(let M=0;M<o.length;M++){const I=o[M],k=[1/0,1/0,-1/0,-1/0];for(let F=0;F<I.length;F++){const z=I[F];k[0]=Math.min(k[0],z.x),k[1]=Math.min(k[1],z.y),k[2]=Math.max(k[2],z.x),k[3]=Math.max(k[3],z.y)}b!==0&&(k[0]-=b,k[1]-=b,k[2]+=b,k[3]+=b),k[0]<Bt&&k[1]<Bt&&k[2]>=0&&k[3]>=0&&E.insert(T,k[0],k[1],k[2],k[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Sx(new xd(this.rawTileData)).layers,this.sourceLayerCoder=new OC(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const r in this.vtLayers)this.vtFeatures[r]=[]}return this.vtLayers}query(r,o,u,f){this.loadVTLayers();const m=r.params||{},y=ro(m.filter),b=r.tileResult,T=r.transform,E=b.bufferedTilespaceBounds,M=this.grid.query(E.min.x,E.min.y,E.max.x,E.max.y,(z,V,W,G)=>tS(b.bufferedTilespaceGeometry,z,V,W,G));M.sort(yz);let I=null;T.elevation&&M.length>0&&(I=md.create(T.elevation,this.tileID));const k={};let F;for(let z=0;z<M.length;z++){const V=M[z];if(V===F)continue;F=V;const W=this.featureIndexArray.get(V);let G=null;if(this.is3DTile){const te=this.bucketLayerIDs[0][0],se=o[te];if(se.type!=="model")continue;const{queryFeature:ne,intersectionZ:ye}=se.queryIntersectsMatchingFeature(b,W.featureIndex,y,T);ne&&this.appendToResult(k,te,W.featureIndex,ne,ye)}else this.loadMatchingFeature(k,W,y,m.layers,m.availableImages,o,u,f,(te,se,ne,ye=0)=>(G||(G=ls(te,this.tileID.canonical,r.tileTransform)),se.queryIntersectsFeature(b,te,ne,G,this.z,r.transform,r.pixelPosMatrix,I,ye)))}return k}loadMatchingFeature(r,o,u,f,m,y,b,T,E){const{featureIndex:M,bucketIndex:I,sourceLayerIndex:k,layoutVertexArrayOffset:F}=o,z=this.bucketLayerIDs[I];if(f&&!function(te,se){for(let ne=0;ne<te.length;ne++)if(se.indexOf(te[ne])>=0)return!0;return!1}(f,z))return;const V=this.sourceLayerCoder.decode(k),W=this.vtLayers[V].feature(M);if(u.needGeometry){const te=Xn(W,!0);if(!u.filter(new dn(this.tileID.overscaledZ),te,this.tileID.canonical))return}else if(!u.filter(new dn(this.tileID.overscaledZ),W))return;const G=this.getId(W,V);for(let te=0;te<z.length;te++){const se=z[te];if(f&&f.indexOf(se)<0)continue;const ne=y[se];if(!ne)continue;let ye={};G!==void 0&&T&&(ye=T.getState(ne.sourceLayer||"_geojsonTileLayer",G));const de=!E||E(W,ne,ye,F);if(!de)continue;const Ee=new kC(W,this.z,this.x,this.y,G),Pe=Ar({},b[se]);Pe.paint=LC(Pe.paint,ne.paint,W,ye,m),Pe.layout=LC(Pe.layout,ne.layout,W,ye,m),Ee.layer=Pe,this.appendToResult(r,se,M,Ee,de)}}appendToResult(r,o,u,f,m){let y=r[o];y===void 0&&(y=r[o]=[]),y.push({featureIndex:u,feature:f,intersectionZ:m})}lookupSymbolFeatures(r,o,u,f,m,y,b,T){const E={};this.loadVTLayers();const M=ro(m);for(const I of r)this.loadMatchingFeature(E,{bucketIndex:u,sourceLayerIndex:f,featureIndex:I,layoutVertexArrayOffset:0},M,y,b,T,o);return E}loadFeature(r){const{featureIndex:o,sourceLayerIndex:u}=r;this.loadVTLayers();const f=this.sourceLayerCoder.decode(u),m=this.vtFeatures[f];if(m[o])return m[o];const y=this.vtLayers[f].feature(o);return m[o]=y,y}hasLayer(r){for(const o of this.bucketLayerIDs)for(const u of o)if(r===u)return!0;return!1}getId(r,o){let u=r.id;if(this.promoteId){const f=typeof this.promoteId=="string"?this.promoteId:this.promoteId[o];f!=null&&(u=r.properties[f]),typeof u=="boolean"&&(u=Number(u))}return u}}function LC(n,r,o,u,f){return Ki(n,(m,y)=>{const b=r instanceof gu?r.get(y):null;return b&&b.evaluate?b.evaluate(o,u,f):b})}function yz(n,r){return r-n}Ht(DC,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const Qx=new Float32Array(262144),$u=new Uint8Array(262144);function NC(n){let r=0;if(n.meshes)for(const o of n.meshes)r=Math.max(r,o.aabb.max[2]);if(n.children)for(const o of n.children)r=Math.max(r,NC(o));return r}function FC(n,r,o){if(n.meshes)for(const u of n.meshes)u.aabb.min[0]!==1/0&&o.insert(r,u.aabb.min[0],u.aabb.min[1],u.aabb.max[0],u.aabb.max[1]);if(n.children)for(const u of n.children)FC(u,r,o)}const BC=["","wall","door","roof","window","lamp","logo"];class zC{constructor(r){this.node=r,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.feature={type:"Point",id:r.id,geometry:[],properties:{height:NC(r)}}}getLocalBounds(){if(!this.node.meshes)return new xn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let r=0;const o=new xn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const u of this.node.meshes)this.node.lightMeshIndex!==r&&o.encapsulate(u.aabb),r++;this.aabb=o}return this.aabb}}class ky{constructor(r,o,u,f,m,y){this.id=o,this.modelTraits|=Sd.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,u&&(this.modelTraits|=Sd.HasMapboxMeshFeatures),f&&(this.modelTraits|=Sd.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=m,this.dirty=!0,this.needsUpload=!1,this.nodesInfo=[];for(const b of r)this.nodesInfo.push(new zC(b)),FC(b,y.featureIndexArray.length,y.grid),y.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,y.bucketLayerIDs.length-1,0)}update(){console.log("Update 3D model bucket")}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(r){if(!this.needsUpload)return;const o=this.getNodesInfo();for(const u of o){const f=u.node;this.uploaded?this.updatePbrBuffer(f):qx(f,r,!0)}for(const u of o)Cy(u.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(r){let o=!1;if(!r.meshes)return o;for(const u of r.meshes)u.pbrBuffer&&(u.pbrBuffer.updateData(u.featureArray),o=!0);return o}needsReEvaluation(r,o,u){const f=r.transform.projectionOptions,m=r.style.getBrightness(),y=this.brightness!==m;return!!(!this.uploaded||this.dirty||f.name!==this.projection.name||Am(u.paint.get("model-color").value,y)||Am(u.paint.get("model-color-mix-intensity").value,y)||Am(u.paint.get("model-roughness").value,y)||Am(u.paint.get("model-emissive-strength").value,y)||Am(u.paint.get("model-height-based-emissive-strength-multiplier").value,y))&&(this.projection=f,this.brightness=m,!0)}evaluateScale(r,o){if(r.transform.zoom===this.zoom)return;this.zoom=r.transform.zoom;const u=this.getNodesInfo(),f=this.id.canonical;for(const m of u){const y=m.feature;m.evaluatedScale=o.paint.get("model-scale").evaluate(y,{},f)}}evaluate(r){const o=this.getNodesInfo();for(const u of o){if(!u.node.meshes)continue;const f=u.feature,m=u.node.meshes&&u.node.meshes[0].featureData,y=u.evaluatedColor[2],b=u.evaluatedRMEA[2],T=this.id.canonical;if(u.hasTranslucentParts=!1,m){for(let E=0;E<BC.length;E++){const M=BC[E];M.length&&(f.properties.part=M);const I=r.paint.get("model-color").evaluate(f,{},T),k=r.paint.get("model-color-mix-intensity").evaluate(f,{},T);u.evaluatedColor[E]=[I.r,I.g,I.b,k],u.evaluatedRMEA[E][0]=r.paint.get("model-roughness").evaluate(f,{},T),u.evaluatedRMEA[E][2]=r.paint.get("model-emissive-strength").evaluate(f,{},T),u.evaluatedRMEA[E][3]=I.a,u.emissionHeightBasedParams[E]=r.paint.get("model-height-based-emissive-strength-multiplier").evaluate(f,{},T),!u.hasTranslucentParts&&I.a<1&&(u.hasTranslucentParts=!0)}delete f.properties.part,xz(u,y!==u.evaluatedColor[2]||b!==u.evaluatedRMEA[2],this.modelTraits)}else u.evaluatedRMEA[0][2]=r.paint.get("model-emissive-strength").evaluate(f,{},T);u.evaluatedScale=r.paint.get("model-scale").evaluate(f,{},T),this.updatePbrBuffer(u.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(r,o,u,f){const m=r.findDEMTileFor(u);if(m&&(m.tileID.canonical!==this.terrainTile||o!==this.terrainExaggeration)){if(m.dem&&m.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=m.tileID.overscaledZ;const y=md.create(r,u,m);if(!y)return;this.modelTraits&Sd.HasMapboxMeshFeatures&&this.updateDEM(r,y,u,f);for(const b of this.getNodesInfo()){const T=b.node;if(!T.footprint||!T.footprint.vertices||!T.footprint.vertices.length)continue;const E=T.footprint.vertices;let M=y.getElevationAt(E[0].x,E[0].y,!0,!0);for(let I=1;I<E.length;I++)M=Math.min(M,y.getElevationAt(E[I].x,E[I].y,!0,!0));T.elevation=M}}this.terrainTile=m.tileID.canonical,this.terrainExaggeration=o}}updateDEM(r,o,u,f){let m=o._dem._modifiedForSources[f];if(m===void 0&&(o._dem._modifiedForSources[f]=[],m=o._dem._modifiedForSources[f]),m.includes(u.canonical))return;const y=o._dem.dim;m.push(u.canonical);let b=!1;for(const T of this.getNodesInfo()){const E=T.node;if(!E.footprint||!E.footprint.grid)continue;const M=E.footprint.grid,I=o.tileCoordToPixel(M.min.x,M.min.y),k=o.tileCoordToPixel(M.max.x,M.max.y),F=Math.min(Math.min(y-k.y,I.x),Math.min(I.y,y-k.x));if(F<0)continue;const z=ri(F,2,5);let V=Math.max(0,I.x-z),W=Math.max(0,I.y-z),G=Math.min(k.x+z,y-1),te=Math.min(k.y+z,y-1);for(let de=W;de<=te;++de)for(let Ee=V;Ee<=G;++Ee)$u[de*y+Ee]=255;let se=0,ne=0;for(let de=0;de<M.cellsY;++de)for(let Ee=0;Ee<M.cellsX;++Ee){if(!M.cells[de*M.cellsX+Ee])continue;const Pe=o.tileCoordToPixel(M.min.x+Ee/M.xScale,M.min.y+de/M.yScale),De=o.tileCoordToPixel(M.min.x+(Ee+1)/M.xScale,M.min.y+(de+1)/M.yScale);for(let Ve=Pe.y;Ve<=Math.min(De.y+1,y-1);++Ve)for(let Le=Pe.x;Le<=Math.min(De.x+1,y-1);++Le)$u[Ve*y+Le]===255&&($u[Ve*y+Le]=0,se+=o.getElevationAtPixel(Le,Ve),ne++)}const ye=se/ne;V=Math.max(1,I.x-z),W=Math.max(1,I.y-z),G=Math.min(k.x+z,y-2),te=Math.min(k.y+z,y-2),b=!0;for(let de=W;de<=te;++de)for(let Ee=V;Ee<=G;++Ee)$u[de*y+Ee]===0&&(Qx[de*y+Ee]=o._dem.set(Ee,de,ye));for(let de=1;de<z;++de){V=Math.max(1,I.x-de),W=Math.max(1,I.y-de),G=Math.min(k.x+de,y-2),te=Math.min(k.y+de,y-2);for(let Ee=W;Ee<=te;++Ee)for(let Pe=V;Pe<=G;++Pe){const De=Ee*y+Pe;if($u[De]===255){let Ve=0,Le=0,rt=-1,ht=-1;for(let Ze=-1;Ze<=1;++Ze)for(let ct=-1;ct<=1;++ct){const qe=(Ee+Ze)*y+Pe+ct;if($u[qe]>=de)continue;const at=Qx[qe],Ot=Math.abs(at);Ot>Le&&(Ve=at,Le=Ot,rt=ct,ht=Ze)}if(Le>.1){const Ze=1-(de+.5*Math.abs(rt*ht))/z;let ct=o._dem.get(Pe,Ee)+Ve*Ze;const qe=o._dem.get(Pe+rt,Ee+ht),at=o._dem.get(Pe-rt,Ee-ht,!0);(ct-qe)*(ct-at)>0&&(ct=(qe+at)/2),Qx[De]=o._dem.set(Pe,Ee,ct),$u[De]=de}}}}}b&&(o._demTile.needsDEMTextureUpload=!0,o._dem._timestamp=lt.now())}getNodesInfo(){return this.nodesInfo}destroy(){const r=this.getNodesInfo();for(const o of r)Cy(o.node),Gx(o.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(r,o){if(o.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=o.updateTime;const u=o.getReplacementRegionsForTile(r.toUnwrapped()),f=this.getNodesInfo();for(let m=0;m<this.nodesInfo.length;m++){const y=f[m].node;f[m].hiddenByReplacement=!!y.footprint&&!u.find(b=>b.footprint===y.footprint)}}getHeightAtTileCoord(r,o){const u=this.getNodesInfo(),f=[];for(let m=0;m<this.nodesInfo.length;m++){const y=u[m],b=y.node.meshes[0];if(r<b.aabb.min[0]||o<b.aabb.min[1]||r>b.aabb.max[0]||o>b.aabb.max[1])continue;const T=(r-b.aabb.min[0])/(b.aabb.max[0]-b.aabb.min[0])*Vu|0,E=Math.min(63,(o-b.aabb.min[1])/(b.aabb.max[1]-b.aabb.min[1])*Vu|0)*Vu+Math.min(63,T);if(!(b.heightmap[E]<0&&y.node.footprint))return y.hiddenByReplacement?void 0:{height:b.heightmap[E],maxHeight:y.feature.properties.height,hidden:!1,verticalScale:y.evaluatedScale[2]};if(y.node.footprint.grid.query(new xe(r,o),new xe(r,o),f),f.length>0)return{height:void 0,maxHeight:y.feature.properties.height,hidden:y.hiddenByReplacement,verticalScale:y.evaluatedScale[2]}}}}function Am(n,r){return!n.isLightConstant&&r}function vz(n,r,o,u,f,m,y,b){let T=(61440&r|(61440&r)>>4)>>8,E=(3840&r|(3840&r)>>4)>>4,M=240&r|(240&r)>>4;o[3]>0&&(T=Ut(T,255*o[0],o[3]),E=Ut(E,255*o[1],o[3]),M=Ut(M,255*o[2],o[3]));const I=T<<8|E,k=M<<8|Math.floor(255*u[3]),F=function(de){const Ee=ri(de,0,2);return Math.min(Math.round(.5*Ee*255),255)}(u[2])<<8|15*u[0]<<4|15*u[1],z=ri(f[0],0,1),V=ri(f[1],0,1),W=ri(f[2],0,1),G=ri(f[3],0,1);let te,se,ne,ye;if(z!==V&&y!==m&&V!==z){const de=y-m;se=1/(de*(V-z)),ne=-(m+de*z)/(de*(V-z));const Ee=ri(f[4],-1,1);ye=Math.pow(10,Ee),te=255*W<<8|255*G}else te=65535,se=0,ne=1,ye=1;if(n.emplaceBack(I,k,F,te,se,ne,ye),b){const de=b.length;b.clear();for(let Ee=0;Ee<de;Ee++)b.emplaceBack(I,k,F,te,se,ne,ye)}}function xz(n,r,o){const u=n.node;let f=0;const m=o&Sd.HasMeshoptCompression;for(const y of u.meshes){if(u.lights&&u.lightMeshIndex===f||!y.featureData)continue;y.featureArray=new Iu,y.featureArray.reserve(y.featureData.length);let b=r;for(const T of y.featureData){const E=m?65535&T:T>>16&65535,M=m?T>>16&65535:65535&T,I=(15&M)<8?15&M:0,k=n.evaluatedRMEA[I],F=n.evaluatedColor[I],z=n.emissionHeightBasedParams[I];let V;if(b&&I===2&&u.lights&&(V=new Iu,V.resize(10*u.lights.length)),vz(y.featureArray,E,F,k,z,y.aabb.min[2],y.aabb.max[2],V),V&&b){b=!1;const W=u.meshes[u.lightMeshIndex];W.featureArray=V,W.featureArray._trim()}}y.featureArray._trim(),f++}}function UC(n,r,o,u){const f=1<<n.z;r.lat=Qi((u/Bt+n.y)/f),r.lng=wi((o/Bt+n.x)/f)}Ht(ky,"Tiled3dModelBucket",{omit:["layers"]}),Ht(zC,"Tiled3dModelFeature");const bz={circle:class extends Ws{constructor(n,r,o){super(n,fF,r,o)}createBucket(n){return new Gs(n)}queryRadius(n){const r=n;return dd("circle-radius",this,r)+dd("circle-stroke-width",this,r)+Ug(this.paint.get("circle-translate"))}queryIntersectsFeature(n,r,o,u,f,m,y,b){const T=rS(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),m.angle,n.pixelToTileUnitsFactor),E=this.paint.get("circle-radius").evaluate(r,o)+this.paint.get("circle-stroke-width").evaluate(r,o);return IA(n,u,m,y,b,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",T,E)}getProgramIds(){return["circle"]}getDefaultProgramParams(n,r){const o=PA(this);return{config:new $(this,r),defines:o,overrideFog:!1}}},heatmap:class extends Ws{createBucket(n){return new OA(n)}constructor(n,r,o){super(n,WF,r,o),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(n){n==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=sm({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(n){return dd("heatmap-radius",this,n)}queryIntersectsFeature(n,r,o,u,f,m,y,b){const T=this.paint.get("heatmap-radius").evaluate(r,o);return IA(n,u,m,y,b,!0,!0,new xe(0,0),T)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(n,r){return n==="heatmap"?{config:new $(this,r),overrideFog:!1}:{}}},hillshade:class extends Ws{constructor(n,r,o){super(n,qF,r,o)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(n,r){return{overrideFog:!1}}},fill:class extends Ws{constructor(n,r,o){super(n,o4,r,o)}getProgramIds(){const n=this.paint.get("fill-pattern"),r=n&&n.constantOr(1),o=[r?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&o.push(r&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),o}getDefaultProgramParams(n,r){return{config:new $(this,r),overrideFog:!1}}recalculate(n,r){super.recalculate(n,r);const o=this.paint._values["fill-outline-color"];o.value.kind==="constant"&&o.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(n){return new Ex(n)}queryRadius(){return Ug(this.paint.get("fill-translate"))}queryIntersectsFeature(n,r,o,u,f,m){return!n.queryGeometry.isAboveHorizon&&bl(iS(n.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),m.angle,n.pixelToTileUnitsFactor),u)}isTileClipped(){return!0}},"fill-extrusion":class extends Ws{constructor(n,r,o){super(n,D4,r,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new oy(n)}queryRadius(){return Ug(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return!0}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(n,r,o,u,f,m,y,b,T){const E=rS(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),m.angle,n.pixelToTileUnitsFactor),M=this.paint.get("fill-extrusion-height").evaluate(r,o),I=this.paint.get("fill-extrusion-base").evaluate(r,o),k=[0,0],F=b&&m.elevation,z=m.elevation?m.elevation.exaggeration():1,V=n.tile.getBucket(this);if(F&&V instanceof oy){const ne=V.centroidVertexArray,ye=T+1;ye<ne.length&&(k[0]=ne.geta_centroid_pos0(ye),k[1]=ne.geta_centroid_pos1(ye))}if(k[0]===0&&k[1]===1)return!1;m.projection.name==="globe"&&(u=fM([u],[new xe(0,0),new xe(Bt,Bt)],n.tileID.canonical).map(ne=>ne.polygon).flat());const W=F?b:null,[G,te]=function(ne,ye,de,Ee,Pe,De,Ve,Le,rt,ht,Ze){return ne.projection.name==="globe"?function(ct,qe,at,Ot,dt,Xt,Wt,_t,hi,ti,qt){const gt=[],ai=[],Di=ct.projection.upVectorScale(qt,ct.center.lat,ct.worldSize).metersToTile,di=[0,0,0,1],Li=[0,0,0,1],xi=(Ei,Br,cr,pr)=>{Ei[0]=Br,Ei[1]=cr,Ei[2]=pr,Ei[3]=1},Xi=dM();at>0&&(at+=Xi),Ot+=Xi;for(const Ei of qe){const Br=[],cr=[];for(const pr of Ei){const wr=pr.x+dt.x,ur=pr.y+dt.y,ln=ct.projection.projectTilePoint(wr,ur,qt),Or=ct.projection.upVector(qt,pr.x,pr.y);let Tn=at,Qn=Ot;if(Wt){const xs=mM(wr,ur,at,Ot,Wt,_t,hi,ti);Tn+=xs.base,Qn+=xs.top}at!==0?xi(di,ln.x+Or[0]*Di*Tn,ln.y+Or[1]*Di*Tn,ln.z+Or[2]*Di*Tn):xi(di,ln.x,ln.y,ln.z),xi(Li,ln.x+Or[0]*Di*Qn,ln.y+Or[1]*Di*Qn,ln.z+Or[2]*Di*Qn),l.N.transformMat4(di,di,Xt),l.N.transformMat4(Li,Li,Xt),Br.push(new _d(di[0],di[1],di[2])),cr.push(new _d(Li[0],Li[1],Li[2]))}gt.push(Br),ai.push(cr)}return[gt,ai]}(ne,ye,de,Ee,Pe,De,Ve,Le,rt,ht,Ze):Ve?function(ct,qe,at,Ot,dt,Xt,Wt,_t,hi){const ti=[],qt=[],gt=[0,0,0,1];for(const ai of ct){const Di=[],di=[];for(const Li of ai){const xi=Li.x+Ot.x,Xi=Li.y+Ot.y,Ei=mM(xi,Xi,qe,at,Xt,Wt,_t,hi);gt[0]=xi,gt[1]=Xi,gt[2]=Ei.base,gt[3]=1,l.a7.transformMat4(gt,gt,dt),gt[3]=Math.max(gt[3],1e-5);const Br=new _d(gt[0]/gt[3],gt[1]/gt[3],gt[2]/gt[3]);gt[0]=xi,gt[1]=Xi,gt[2]=Ei.top,gt[3]=1,l.a7.transformMat4(gt,gt,dt),gt[3]=Math.max(gt[3],1e-5);const cr=new _d(gt[0]/gt[3],gt[1]/gt[3],gt[2]/gt[3]);Di.push(Br),di.push(cr)}ti.push(Di),qt.push(di)}return[ti,qt]}(ye,de,Ee,Pe,De,Ve,Le,rt,ht):function(ct,qe,at,Ot,dt){const Xt=[],Wt=[],_t=dt[8]*qe,hi=dt[9]*qe,ti=dt[10]*qe,qt=dt[11]*qe,gt=dt[8]*at,ai=dt[9]*at,Di=dt[10]*at,di=dt[11]*at;for(const Li of ct){const xi=[],Xi=[];for(const Ei of Li){const Br=Ei.x+Ot.x,cr=Ei.y+Ot.y,pr=dt[0]*Br+dt[4]*cr+dt[12],wr=dt[1]*Br+dt[5]*cr+dt[13],ur=dt[2]*Br+dt[6]*cr+dt[14],ln=dt[3]*Br+dt[7]*cr+dt[15],Or=pr+_t,Tn=wr+hi,Qn=ur+ti,xs=Math.max(ln+qt,1e-5),tn=pr+gt,_n=wr+ai,ps=ur+Di,ms=Math.max(ln+di,1e-5);xi.push(new _d(Or/xs,Tn/xs,Qn/xs)),Xi.push(new _d(tn/ms,_n/ms,ps/ms))}Xt.push(xi),Wt.push(Xi)}return[Xt,Wt]}(ye,de,Ee,Pe,De)}(m,u,I,M,E,y,W,k,z,m.center.lat,n.tileID.canonical),se=n.queryGeometry;return function(ne,ye,de){let Ee=1/0;bl(de,ye)&&(Ee=pM(de,ye[0]));for(let Pe=0;Pe<ye.length;Pe++){const De=ye[Pe],Ve=ne[Pe];for(let Le=0;Le<De.length-1;Le++){const rt=De[Le],ht=[rt,De[Le+1],Ve[Le+1],Ve[Le],rt];Vo(de,ht)&&(Ee=Math.min(Ee,pM(de,ht)))}}return Ee!==1/0&&Ee}(G,te,se.isPointQuery()?se.screenBounds:se.screenGeometry)}},line:class extends Ws{constructor(n,r,o){super(n,gM,r,o),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(n){if(n==="line-gradient"){const r=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=r._styleExpression&&r._styleExpression.expression instanceof lu,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(n,r){super.recalculate(n,r),this.paint._values["line-floorwidth"]=TM.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,n)}createBucket(n){return new Mx(n)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(n,r){const o=bM(this);return{config:new $(this,r),defines:o,overrideFog:!1}}queryRadius(n){const r=n,o=EM(dd("line-width",this,r),dd("line-gap-width",this,r)),u=dd("line-offset",this,r);return o/2+Math.abs(u)+Ug(this.paint.get("line-translate"))}queryIntersectsFeature(n,r,o,u,f,m){if(n.queryGeometry.isAboveHorizon)return!1;const y=iS(n.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),m.angle,n.pixelToTileUnitsFactor),b=n.pixelToTileUnitsFactor/2*EM(this.paint.get("line-width").evaluate(r,o),this.paint.get("line-gap-width").evaluate(r,o)),T=this.paint.get("line-offset").evaluate(r,o);return T&&(u=function(E,M){const I=[],k=new xe(0,0);for(let F=0;F<E.length;F++){const z=E[F],V=[];for(let W=0;W<z.length;W++){const G=z[W],te=z[W+1],se=W===0?k:G.sub(z[W-1])._unit()._perp(),ne=W===z.length-1?k:te.sub(G)._unit()._perp(),ye=se._add(ne)._unit();ye._mult(1/(ye.x*ne.x+ye.y*ne.y)),V.push(ye._mult(M)._add(G))}I.push(V)}return I}(u,T*n.pixelToTileUnitsFactor)),function(E,M,I){for(let k=0;k<M.length;k++){const F=M[k];if(E.length>=3){for(let z=0;z<F.length;z++)if(oa(E,F[z]))return!0}if(Lu(E,F,I))return!0}return!1}(y,u,b)}isTileClipped(){return!0}},symbol:wy,background:class extends Ws{constructor(n,r,o){super(n,FB,r,o)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(n,r){return{overrideFog:!1}}},raster:cC,"raster-particle":uC,sky:class extends Ws{constructor(n,r,o){super(n,HB,r,o),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(n){n==="sky-gradient"?this._updateColorRamp():n!=="sky-atmosphere-sun"&&n!=="sky-atmosphere-halo-color"&&n!=="sky-atmosphere-color"&&n!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=sm({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(n){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const r=n.style.light.properties.get("position");return this._lightPosition.azimuthal!==r.azimuthal||this._lightPosition.polar!==r.polar}return!1}getCenter(n,r){if(this.paint.get("sky-type")==="atmosphere"){const u=this.paint.get("sky-atmosphere-sun"),f=!u,m=n.style.light,y=m.properties.get("position");return f&&m.properties.get("anchor")==="viewport"&&mr("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),f?$x(y.azimuthal,90-y.polar,r):$x(u[0],90-u[1],r)}const o=this.paint.get("sky-gradient-center");return $x(o[0],90-o[1],r)}isSky(){return!0}markSkyboxValid(n){this._skyboxInvalidated=!1,this._lightPosition=n.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const n=this.paint.get("sky-type");return n==="atmosphere"?["skyboxCapture","skybox"]:n==="gradient"?["skyboxGradient"]:null}},slot:class extends Ws{constructor(n,r,o){super(n,qB,r)}},model:class extends Ws{constructor(n,r,o){super(n,tz,r,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new Hx(n)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(n){return n instanceof ky?Bt-1:0}queryIntersectsFeature(n,r,o,u,f,m){if(!this.modelManager)return!1;const y=this.modelManager,b=n.tile.getBucket(this);if(!(b&&b instanceof Hx))return!1;const T=b;for(const E in T.instancesPerModel){const M=T.instancesPerModel[E];if(M.idToFeaturesIndex.hasOwnProperty(r.id)){const I=M.features[M.idToFeaturesIndex[r.id]],k=y.getModel(E,this.scope);if(!k)return!1;let F=l.a6.create();const z=new ke(0,0),V=T.canonical;let W=Number.MAX_VALUE;for(let G=0;G<I.instancedDataCount;++G){const te=16*(I.instancedDataOffset+G),se=M.instancedDataArray.float32,ne=[se[te+4],se[te+5],se[te+6]];UC(V,z,se[te],0|se[te+1]),vC(F,k,m,z,I.rotation,I.scale,ne,!1,!1,!1),m.projection.name==="globe"&&(F=Wx(F,m));const ye=l.a6.multiply([],m.projMatrix,F),de=n.queryGeometry,Ee=_C(de.isPointQuery()?de.screenBounds:de.screenGeometry,m,ye,k.aabb);Ee!=null&&(W=Math.min(Ee,W))}return W!==Number.MAX_VALUE&&W}}return!1}_handleOverridablePaintPropertyUpdate(n,r,o){return!(!this.layout||r.isDataDriven()||o.isDataDriven()||n!=="model-color"&&n!=="model-color-mix-intensity"&&n!=="model-rotation"&&n!=="model-scale"&&n!=="model-translation"&&n!=="model-emissive-strength")}_isPropertyZoomDependent(n){const r=this._transitionablePaint._values[n];return r!=null&&r.value!=null&&r.value.expression!=null&&r.value.expression instanceof fu}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}queryIntersectsMatchingFeature(n,r,o,u){const f=n.tile,m=f.getBucket(this);let y=null,b=Number.MAX_VALUE;if(!(m&&m instanceof ky))return{queryFeature:y,intersectionZ:b};const T=m.getNodesInfo()[r];if(T.hiddenByReplacement||!T.node.meshes||!o.filter(new dn(f.tileID.overscaledZ),T.feature,f.tileID.canonical))return{queryFeature:y,intersectionZ:b};const E=T.node,M=u.calculatePosMatrix(f.tileID.toUnwrapped(),u.worldSize),I=T.evaluatedScale;let k=0;u.elevation&&E.elevation&&(k=E.elevation*u.elevation.exaggeration()),l.a6.translate(M,M,[(E.anchor?E.anchor[0]:0)*(I[0]-1),(E.anchor?E.anchor[1]:0)*(I[1]-1),k]),l.a6.scale(M,M,I),l.a6.multiply(M,M,E.matrix);const F=n.queryGeometry,z=F.isPointQuery()?F.screenBounds:F.screenGeometry,V=function(G){const te=l.a6.multiply([],M,G.matrix),se=l.a6.multiply(te,u.expandedFarZProjMatrix,te);for(let ne=0;ne<G.meshes.length;++ne){const ye=G.meshes[ne];if(ne===G.lightMeshIndex)continue;const de=_C(z,u,se,ye.aabb);de!=null&&(b=Math.min(de,b))}if(G.children)for(const ne of G.children)V(ne)};if(V(E),b===Number.MAX_VALUE)return{queryFeature:y,intersectionZ:b};const W=new ke(0,0);return UC(f.tileID.canonical,W,T.node.anchor[0],T.node.anchor[1]),y={type:"Feature",geometry:{type:"Point",coordinates:[W.lng,W.lat]},properties:T.feature.properties,id:T.feature.id,state:{},layer:this.serialize()},{queryFeature:y,intersectionZ:b}}}},Mi={read:function(n,r){return n.readFields(Mi._readField,{header_length:0,x:0,y:0,z:0,layers:[]},r)},_readField:function(n,r,o){n===1?r.header_length=o.readFixed32():n===2?r.x=o.readVarint():n===3?r.y=o.readVarint():n===4?r.z=o.readVarint():n===5&&r.layers.push(Mi.Layer.read(o,o.readVarint()+o.pos))},PixelFormat:{PIXEL_FORMAT_UNKNOWN:{value:0,options:{}},PIXEL_FORMAT_UINT32:{value:1,options:{}},PIXEL_FORMAT_UINT16:{value:2,options:{}},PIXEL_FORMAT_UINT8:{value:3,options:{}}},Filter:{}};Mi.Filter.read=function(n,r){return n.readFields(Mi.Filter._readField,{delta_filter:null,filter:null,zigzag_filter:null,bitshuffle_filter:null,byteshuffle_filter:null},r)},Mi.Filter._readField=function(n,r,o){n===1?(r.delta_filter=Mi.Filter.Delta.read(o,o.readVarint()+o.pos),r.filter="delta_filter"):n===2?(r.zigzag_filter=Mi.Filter.Zigzag.read(o,o.readVarint()+o.pos),r.filter="zigzag_filter"):n===3?(r.bitshuffle_filter=Mi.Filter.BitShuffle.read(o,o.readVarint()+o.pos),r.filter="bitshuffle_filter"):n===4&&(r.byteshuffle_filter=Mi.Filter.ByteShuffle.read(o,o.readVarint()+o.pos),r.filter="byteshuffle_filter")},Mi.Filter.Delta={},Mi.Filter.Delta.read=function(n,r){return n.readFields(Mi.Filter.Delta._readField,{block_size:0},r)},Mi.Filter.Delta._readField=function(n,r,o){n===1&&(r.block_size=o.readVarint())},Mi.Filter.Zigzag={},Mi.Filter.Zigzag.read=function(n,r){return n.readFields(Mi.Filter.Zigzag._readField,{},r)},Mi.Filter.Zigzag._readField=function(n,r,o){},Mi.Filter.BitShuffle={},Mi.Filter.BitShuffle.read=function(n,r){return n.readFields(Mi.Filter.BitShuffle._readField,{},r)},Mi.Filter.BitShuffle._readField=function(n,r,o){},Mi.Filter.ByteShuffle={},Mi.Filter.ByteShuffle.read=function(n,r){return n.readFields(Mi.Filter.ByteShuffle._readField,{},r)},Mi.Filter.ByteShuffle._readField=function(n,r,o){},Mi.Codec={},Mi.Codec.read=function(n,r){return n.readFields(Mi.Codec._readField,{gzip_data:null,codec:null,jpeg_image:null,webp_image:null,png_image:null},r)},Mi.Codec._readField=function(n,r,o){n===1?(r.gzip_data=Mi.Codec.GzipData.read(o,o.readVarint()+o.pos),r.codec="gzip_data"):n===2?(r.jpeg_image=Mi.Codec.JpegImage.read(o,o.readVarint()+o.pos),r.codec="jpeg_image"):n===3?(r.webp_image=Mi.Codec.WebpImage.read(o,o.readVarint()+o.pos),r.codec="webp_image"):n===4&&(r.png_image=Mi.Codec.PngImage.read(o,o.readVarint()+o.pos),r.codec="png_image")},Mi.Codec.GzipData={},Mi.Codec.GzipData.read=function(n,r){return n.readFields(Mi.Codec.GzipData._readField,{},r)},Mi.Codec.GzipData._readField=function(n,r,o){},Mi.Codec.JpegImage={},Mi.Codec.JpegImage.read=function(n,r){return n.readFields(Mi.Codec.JpegImage._readField,{},r)},Mi.Codec.JpegImage._readField=function(n,r,o){},Mi.Codec.WebpImage={},Mi.Codec.WebpImage.read=function(n,r){return n.readFields(Mi.Codec.WebpImage._readField,{},r)},Mi.Codec.WebpImage._readField=function(n,r,o){},Mi.Codec.PngImage={},Mi.Codec.PngImage.read=function(n,r){return n.readFields(Mi.Codec.PngImage._readField,{},r)},Mi.Codec.PngImage._readField=function(n,r,o){},Mi.DataIndexEntry={},Mi.DataIndexEntry.read=function(n,r){return n.readFields(Mi.DataIndexEntry._readField,{first_byte:0,last_byte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},r)},Mi.DataIndexEntry._readField=function(n,r,o){n===1?r.first_byte=o.readFixed64():n===2?r.last_byte=o.readFixed64():n===3?r.filters.push(Mi.Filter.read(o,o.readVarint()+o.pos)):n===4?r.codec=Mi.Codec.read(o,o.readVarint()+o.pos):n===5?r.offset=o.readFloat():n===6?r.scale=o.readFloat():n===7&&r.bands.push(o.readString())},Mi.Layer={},Mi.Layer.read=function(n,r){return n.readFields(Mi.Layer._readField,{version:0,name:"",units:"",tilesize:0,buffer:0,pixel_format:0,data_index:[]},r)},Mi.Layer._readField=function(n,r,o){n===1?r.version=o.readVarint():n===2?r.name=o.readString():n===3?r.units=o.readString():n===4?r.tilesize=o.readVarint():n===5?r.buffer=o.readVarint():n===6?r.pixel_format=o.readVarint():n===7&&r.data_index.push(Mi.DataIndexEntry.read(o,o.readVarint()+o.pos))};const da={read:function(n,r){return n.readFields(da._readField,{uint32_values:null,values:null,fixed32_values:null},r)},_readField:function(n,r,o){n===2?(r.uint32_values=da.Uint32Values.read(o,o.readVarint()+o.pos),r.values="uint32_values"):n===3&&(r.fixed32_values=da.Fixed32Values.read(o,o.readVarint()+o.pos),r.values="fixed32_values")},Uint32Values:{}};da.Uint32Values.read=function(n,r){return n.readFields(da.Uint32Values._readField,{values:[]},r)},da.Uint32Values._readField=function(n,r,o){n===1&&(r.readValuesInto=function(u){if(u.type!==2)throw new Error(`Unsupported pbf type "${u.type}"`);const f=function(y){return y.type===2?y.readVarint()+y.pos:y.pos+1}(u),m=u.pos;return u.pos=f,function(y){u.pos=m;let b=0;for(;u.pos<f;){const T=u.readVarint();y[b++]=T}return y}}(o))},da.Fixed32Values={},da.Fixed32Values.read=function(n,r){return n.readFields(da.Fixed32Values._readField,{values:[]},r)},da.Fixed32Values._readField=function(n,r,o){throw new Error("Not implemented")};/**
 * tiny-lru
 *
 * @copyright 2023 Jason Mulligan <jason.mulligan@avoidwork.com>
 * @license BSD-3-Clause
 * @version 11.2.5
 */class wz{constructor(r=0,o=0,u=!1){this.first=null,this.items=Object.create(null),this.last=null,this.max=r,this.resetTtl=u,this.size=0,this.ttl=o}clear(){return this.first=null,this.items=Object.create(null),this.last=null,this.size=0,this}delete(r){if(this.has(r)){const o=this.items[r];delete this.items[r],this.size--,o.prev!==null&&(o.prev.next=o.next),o.next!==null&&(o.next.prev=o.prev),this.first===o&&(this.first=o.next),this.last===o&&(this.last=o.prev)}return this}entries(r=this.keys()){return r.map(o=>[o,this.get(o)])}evict(r=!1){if(r||this.size>0){const o=this.first;delete this.items[o.key],--this.size==0?(this.first=null,this.last=null):(this.first=o.next,this.first.prev=null)}return this}expiresAt(r){let o;return this.has(r)&&(o=this.items[r].expiry),o}get(r){let o;if(this.has(r)){const u=this.items[r];this.ttl>0&&u.expiry<=Date.now()?this.delete(r):(o=u.value,this.set(r,o,!0))}return o}has(r){return r in this.items}keys(){const r=[];let o=this.first;for(;o!==null;)r.push(o.key),o=o.next;return r}set(r,o,u=!1,f=this.resetTtl){let m;if(u||this.has(r)){if(m=this.items[r],m.value=o,u===!1&&f&&(m.expiry=this.ttl>0?Date.now()+this.ttl:this.ttl),this.last!==m){const y=this.last,b=m.next,T=m.prev;this.first===m&&(this.first=m.next),m.next=null,m.prev=this.last,y.next=m,T!==null&&(T.next=b),b!==null&&(b.prev=T)}}else this.max>0&&this.size===this.max&&this.evict(!0),m=this.items[r]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:r,prev:this.last,next:null,value:o},++this.size==1?this.first=m:this.last.next=m;return this.last=m,this}values(r=this.keys()){return r.map(o=>this.get(o))}}function Tz(n,r){if(r.length!==4)throw new Error(`Expected data of dimension 4 but got ${r.length}.`);let o=r[3];for(let u=2;u>=1;u--){const f=u===1?1:0,m=u===2?1:0;for(let y=0;y<r[0];y++){const b=r[1]*y;for(let T=f;T<r[1];T++){const E=r[2]*(T+b);for(let M=m;M<r[2];M++){const I=r[3]*(M+E);for(let k=0;k<r[3];k++){const F=I+k;n[F]+=n[F-o]}}}}o*=r[u]}return n}function Ez(n){for(let r=0,o=n.length;r<o;r++)n[r]=n[r]>>>1^-(1&n[r]);return n}function Sz(n,r){switch(r){case"uint32":return n;case"uint16":for(let o=0;o<n.length;o+=2){const u=n[o],f=n[o+1];n[o]=(240&u)>>4|(61440&u)>>8|(240&f)<<4|61440&f,n[o+1]=15&u|(3840&u)>>4|(15&f)<<8|(3840&f)<<4}return n;case"uint8":for(let o=0;o<n.length;o+=4){const u=n[o],f=n[o+1],m=n[o+2],y=n[o+3];n[o+0]=(192&u)>>6|(192&f)>>4|(192&m)>>2|192&y,n[o+1]=(48&u)>>4|(48&f)>>2|48&m|(48&y)<<2,n[o+2]=(12&u)>>2|12&f|(12&m)<<2|(12&y)<<4,n[o+3]=3&u|(3&f)<<2|(3&m)<<4|(3&y)<<6}return n;default:throw new Error(`Invalid pixel format, "${r}"`)}}class gc extends Error{constructor(r){super(r),this.name="MRTError"}}var Ro=Uint8Array,Pd=Uint16Array,Az=Int32Array,VC=new Ro([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),jC=new Ro([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Mz=new Ro([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),$C=function(n,r){for(var o=new Pd(31),u=0;u<31;++u)o[u]=r+=1<<n[u-1];var f=new Az(o[30]);for(u=1;u<30;++u)for(var m=o[u];m<o[u+1];++m)f[m]=m-o[u]<<5|u;return{b:o,r:f}},WC=$C(VC,2),HC=WC.b,Cz=WC.r;HC[28]=258,Cz[258]=28;for(var Pz=$C(jC,0).b,eb=new Pd(32768),Un=0;Un<32768;++Un){var Id=(43690&Un)>>1|(21845&Un)<<1;eb[Un]=((65280&(Id=(61680&(Id=(52428&Id)>>2|(13107&Id)<<2))>>4|(3855&Id)<<4))>>8|(255&Id)<<8)>>1}var Mm=function(n,r,o){for(var u=n.length,f=0,m=new Pd(r);f<u;++f)n[f]&&++m[n[f]-1];var y,b=new Pd(r);for(f=1;f<r;++f)b[f]=b[f-1]+m[f-1]<<1;if(o){y=new Pd(1<<r);var T=15-r;for(f=0;f<u;++f)if(n[f])for(var E=f<<4|n[f],M=r-n[f],I=b[n[f]-1]++<<M,k=I|(1<<M)-1;I<=k;++I)y[eb[I]>>T]=E}else for(y=new Pd(u),f=0;f<u;++f)n[f]&&(y[f]=eb[b[n[f]-1]++]>>15-n[f]);return y},Cm=new Ro(288);for(Un=0;Un<144;++Un)Cm[Un]=8;for(Un=144;Un<256;++Un)Cm[Un]=9;for(Un=256;Un<280;++Un)Cm[Un]=7;for(Un=280;Un<288;++Un)Cm[Un]=8;var qC=new Ro(32);for(Un=0;Un<32;++Un)qC[Un]=5;var Iz=Mm(Cm,9,1),Rz=Mm(qC,5,1),tb=function(n){for(var r=n[0],o=1;o<n.length;++o)n[o]>r&&(r=n[o]);return r},fa=function(n,r,o){var u=r/8|0;return(n[u]|n[u+1]<<8)>>(7&r)&o},ib=function(n,r){var o=r/8|0;return(n[o]|n[o+1]<<8|n[o+2]<<16)>>(7&r)},Oz=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],pa=function(n,r,o){var u=new Error(r||Oz[n]);if(u.code=n,Error.captureStackTrace&&Error.captureStackTrace(u,pa),!o)throw u;return u},kz=new Ro(0),Dz=typeof TextDecoder<"u"&&new TextDecoder;try{Dz.decode(kz,{stream:!0})}catch{}const Lz={gzip_data:"gzip"},Nz={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},Fz={uint32:1,uint16:2,uint8:4},Bz={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};class GC{constructor(r=1){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=r}getLayer(r){return this.layers[r]}getHeaderLength(r){const o=new Uint8Array(r),u=new DataView(r);if(o[0]!==13)throw new gc("File is not a valid MRT.");return u.getUint32(1,!0)}parseHeader(r){const o=new Uint8Array(r),u=this.getHeaderLength(r);if(o.length<u)throw new gc(`Expected header with length >= ${u} but got buffer of length ${o.length}`);const f=new xd(o.subarray(0,u)),m=Mi.read(f);if(!isNaN(this.x)&&(this.x!==m.x||this.y!==m.y||this.z!==m.z))throw new gc(`Invalid attempt to parse header ${m.z}/${m.x}/${m.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=m.x,this.y=m.y,this.z=m.z;for(const y of m.layers)this.layers[y.name]=new zz(y,{cacheSize:this._cacheSize});return this}createDecodingTask(r){const o=[],u=this.getLayer(r.layerName);for(let f=0;f<u.dataIndex.length;f++){const m=u.dataIndex[f],y=m.first_byte-r.firstByte,b=m.last_byte+1-r.firstByte;if(f<r.firstBlock||f>r.lastBlock||u._blocksInProgress.has(f))continue;const T={layerName:u.name,firstByte:y,lastByte:b,pixelFormat:u.pixelFormat,blockIndex:f,blockShape:[m.bands.length].concat(u.bandShape),buffer:u.buffer,codec:m.codec.codec,filters:m.filters.map(E=>E.filter)};u._blocksInProgress.add(f),o.push(T)}return new XC(o,()=>{o.forEach(f=>u._blocksInProgress.delete(f.blockIndex))},(f,m)=>{if(o.forEach(y=>u._blocksInProgress.delete(y.blockIndex)),f)throw f;m.forEach(y=>{this.getLayer(y.layerName).processDecodedData(y)})})}}class zz{constructor({version:r,name:o,units:u,tilesize:f,pixel_format:m,buffer:y,data_index:b},T){if(this.version=r,this.version!==1)throw new gc(`Cannot parse raster layer encoded with MRT version ${r}`);this.name=o,this.units=u,this.tileSize=f,this.buffer=y,this.pixelFormat=Nz[m],this.dataIndex=b,this.bandShape=[f+2*y,f+2*y,Fz[this.pixelFormat]],this._decodedBlocks=function(E=1e3,M=0,I=!1){if(isNaN(E)||E<0)throw new TypeError("Invalid max value");if(isNaN(M)||M<0)throw new TypeError("Invalid ttl value");if(typeof I!="boolean")throw new TypeError("Invalid resetTtl value");return new wz(E,M,I)}(T?T.cacheSize:5),this._blocksInProgress=new Set}processDecodedData(r){const o=r.blockIndex.toString();this._decodedBlocks.get(o)||this._decodedBlocks.set(o,r.data)}getBlockForBand(r){let o=0;switch(typeof r){case"string":for(const[u,f]of this.dataIndex.entries()){for(const[m,y]of f.bands.entries())if(y===r)return{bandIndex:o+m,blockIndex:u,blockBandIndex:m};o+=f.bands.length}break;case"number":for(const[u,f]of this.dataIndex.entries()){if(r>=o&&r<o+f.bands.length)return{bandIndex:r,blockIndex:u,blockBandIndex:r-o};o+=f.bands.length}break;default:throw new gc(`Invalid band \`${JSON.stringify(r)}\`. Expected string or integer.`)}throw new gc(`Band not found: ${JSON.stringify(r)}`)}getDataRange(r){let o=1/0,u=-1/0,f=1/0,m=-1/0;for(const y of r){const{blockIndex:b}=this.getBlockForBand(y);if(b<0)throw new gc(`Invalid band: ${JSON.stringify(y)}`);const T=this.dataIndex[b];f=Math.min(f,b),m=Math.max(m,b),o=Math.min(o,T.first_byte),u=Math.max(u,T.last_byte)}return{layerName:this.name,firstByte:o,lastByte:u,firstBlock:f,lastBlock:m}}hasBand(r){const{blockIndex:o}=this.getBlockForBand(r);return o>=0}hasDataForBand(r){const{blockIndex:o}=this.getBlockForBand(r);return o>=0&&!!this._decodedBlocks.get(o.toString())}getBandView(r){const{blockIndex:o,blockBandIndex:u}=this.getBlockForBand(r),f=this._decodedBlocks.get(o.toString());if(!f)throw new gc(`Data for band ${JSON.stringify(r)} of layer "${this.name}" not decoded.`);const m=this.dataIndex[o],y=this.bandShape.reduce((E,M)=>E*M,1),b=u*y,T=f.subarray(b,b+y);return{data:T,bytes:new Uint8Array(T.buffer).subarray(T.byteOffset,T.byteOffset+T.byteLength),tileSize:this.tileSize,buffer:this.buffer,offset:m.offset,scale:m.scale}}}class XC{constructor(r,o,u){this.tasks=r,this._onCancel=o,this._onComplete=u,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(r,o){this._finalized||(this._onComplete(r,o),this._finalized=!0)}}GC.performDecoding=function(n,r){return Promise.all(r.tasks.map(o=>{const{layerName:u,firstByte:f,lastByte:m,pixelFormat:y,blockShape:b,blockIndex:T,filters:E,codec:M}=o,I=new Uint8Array(n).subarray(f,m+1),k=new Uint32Array(b[0]*b[1]*b[2]);let F;if(M!=="gzip_data")throw new Error(`Unhandled codec: ${M}`);return F=function(z,V){if(!globalThis.DecompressionStream&&V==="gzip_data")return Promise.resolve(((se=function(de){de[0]==31&&de[1]==139&&de[2]==8||pa(6,"invalid gzip data");var Ee=de[3],Pe=10;4&Ee&&(Pe+=2+(de[10]|de[11]<<8));for(var De=(Ee>>3&1)+(Ee>>4&1);De>0;De-=!de[Pe++]);return Pe+(2&Ee)}(te=z))+8>te.length&&pa(6,"invalid gzip data"),function(de,Ee,Pe,De){var Ve=de.length;if(!Ve||Ee.f&&!Ee.l)return Pe||new Ro(0);var Le=!Pe,rt=Le||Ee.i!=2,ht=Ee.i;Le&&(Pe=new Ro(3*Ve));var Ze=function(Xs){var Fs=Pe.length;if(Xs>Fs){var Oo=new Ro(Math.max(2*Fs,Xs));Oo.set(Pe),Pe=Oo}},ct=Ee.f||0,qe=Ee.p||0,at=Ee.b||0,Ot=Ee.l,dt=Ee.d,Xt=Ee.m,Wt=Ee.n,_t=8*Ve;do{if(!Ot){ct=fa(de,qe,1);var hi=fa(de,qe+1,3);if(qe+=3,!hi){var ti=de[(cr=4+((qe+7)/8|0))-4]|de[cr-3]<<8,qt=cr+ti;if(qt>Ve){ht&&pa(0);break}rt&&Ze(at+ti),Pe.set(de.subarray(cr,qt),at),Ee.b=at+=ti,Ee.p=qe=8*qt,Ee.f=ct;continue}if(hi==1)Ot=Iz,dt=Rz,Xt=9,Wt=5;else if(hi==2){var gt=fa(de,qe,31)+257,ai=fa(de,qe+10,15)+4,Di=gt+fa(de,qe+5,31)+1;qe+=14;for(var di=new Ro(Di),Li=new Ro(19),xi=0;xi<ai;++xi)Li[Mz[xi]]=fa(de,qe+3*xi,7);qe+=3*ai;var Xi=tb(Li),Ei=(1<<Xi)-1,Br=Mm(Li,Xi,1);for(xi=0;xi<Di;){var cr,pr=Br[fa(de,qe,Ei)];if(qe+=15&pr,(cr=pr>>4)<16)di[xi++]=cr;else{var wr=0,ur=0;for(cr==16?(ur=3+fa(de,qe,3),qe+=2,wr=di[xi-1]):cr==17?(ur=3+fa(de,qe,7),qe+=3):cr==18&&(ur=11+fa(de,qe,127),qe+=7);ur--;)di[xi++]=wr}}var ln=di.subarray(0,gt),Or=di.subarray(gt);Xt=tb(ln),Wt=tb(Or),Ot=Mm(ln,Xt,1),dt=Mm(Or,Wt,1)}else pa(1);if(qe>_t){ht&&pa(0);break}}rt&&Ze(at+131072);for(var Tn=(1<<Xt)-1,Qn=(1<<Wt)-1,xs=qe;;xs=qe){var tn=(wr=Ot[ib(de,qe)&Tn])>>4;if((qe+=15&wr)>_t){ht&&pa(0);break}if(wr||pa(2),tn<256)Pe[at++]=tn;else{if(tn==256){xs=qe,Ot=null;break}var _n=tn-254;tn>264&&(_n=fa(de,qe,(1<<(_s=VC[xi=tn-257]))-1)+HC[xi],qe+=_s);var ps=dt[ib(de,qe)&Qn],ms=ps>>4;if(ps||pa(3),qe+=15&ps,Or=Pz[ms],ms>3){var _s=jC[ms];Or+=ib(de,qe)&(1<<_s)-1,qe+=_s}if(qe>_t){ht&&pa(0);break}rt&&Ze(at+131072);var Zr=at+_n;if(at<Or){var po=0-Or,yc=Math.min(Or,Zr);for(po+at<0&&pa(3);at<yc;++at)Pe[at]=De[po+at]}for(;at<Zr;++at)Pe[at]=Pe[at-Or]}}Ee.l=Ot,Ee.p=xs,Ee.b=at,Ee.f=ct,Ot&&(ct=1,Ee.m=Xt,Ee.d=dt,Ee.n=Wt)}while(!ct);return at!=Pe.length&&Le?function(Xs,Fs,Oo){return(Fs==null||Fs<0)&&(Fs=0),(Oo==null||Oo>Xs.length)&&(Oo=Xs.length),new Ro(Xs.subarray(Fs,Oo))}(Pe,0,at):Pe.subarray(0,at)}(te.subarray(se,-8),{i:2},new Ro(((W=te)[(G=W.length)-4]|W[G-3]<<8|W[G-2]<<16|W[G-1]<<24)>>>0),void 0)));var W,G,te,se;const ne=Lz[V];if(!ne)throw new Error(`Unhandled codec: ${V}`);const ye=new globalThis.DecompressionStream(ne);return new Response(new Blob([z]).stream().pipeThrough(ye)).arrayBuffer().then(de=>new Uint8Array(de))}(I,M).then(z=>{const V=da.read(new xd(z));if(V.values==="uint32_values")return V.uint32_values.readValuesInto(k),new Bz[y](k.buffer);throw new Error(`Unhandled numeric data "${V.values}"`)}),F.then(z=>{for(let V=E.length-1;V>=0;V--)switch(E[V]){case"delta_filter":Tz(z,b);break;case"zigzag_filter":Ez(z);break;case"bitshuffle_filter":Sz(z,y);break;default:throw new Error(`Unhandled filter "${E[V]}"`)}return{layerName:u,blockIndex:T,data:z}}).catch(z=>{throw z})}))},Ht(XC,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]});const ZC=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class rb{static from(r){if(!(r instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[o,u]=new Uint8Array(r,0,2);if(o!==219)throw new Error("Data does not appear to be in a KDBush format.");const f=u>>4;if(f!==1)throw new Error(`Got v${f} data when expected v1.`);const m=ZC[15&u];if(!m)throw new Error("Unrecognized array type.");const[y]=new Uint16Array(r,2,1),[b]=new Uint32Array(r,4,1);return new rb(b,y,m,r)}constructor(r,o=64,u=Float64Array,f){if(isNaN(r)||r<0)throw new Error(`Unpexpected numItems value: ${r}.`);this.numItems=+r,this.nodeSize=Math.min(Math.max(+o,2),65535),this.ArrayType=u,this.IndexArrayType=r<65536?Uint16Array:Uint32Array;const m=ZC.indexOf(this.ArrayType),y=2*r*this.ArrayType.BYTES_PER_ELEMENT,b=r*this.IndexArrayType.BYTES_PER_ELEMENT,T=(8-b%8)%8;if(m<0)throw new Error(`Unexpected typed array class: ${u}.`);f&&f instanceof ArrayBuffer?(this.data=f,this.ids=new this.IndexArrayType(this.data,8,r),this.coords=new this.ArrayType(this.data,8+b+T,2*r),this._pos=2*r,this._finished=!0):(this.data=new ArrayBuffer(8+y+b+T),this.ids=new this.IndexArrayType(this.data,8,r),this.coords=new this.ArrayType(this.data,8+b+T,2*r),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+m]),new Uint16Array(this.data,2,1)[0]=o,new Uint32Array(this.data,4,1)[0]=r)}add(r,o){const u=this._pos>>1;return this.ids[u]=u,this.coords[this._pos++]=r,this.coords[this._pos++]=o,u}finish(){const r=this._pos>>1;if(r!==this.numItems)throw new Error(`Added ${r} items when expected ${this.numItems}.`);return nb(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(r,o,u,f){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:m,coords:y,nodeSize:b}=this,T=[0,m.length-1,0],E=[];for(;T.length;){const M=T.pop()||0,I=T.pop()||0,k=T.pop()||0;if(I-k<=b){for(let W=k;W<=I;W++){const G=y[2*W],te=y[2*W+1];G>=r&&G<=u&&te>=o&&te<=f&&E.push(m[W])}continue}const F=k+I>>1,z=y[2*F],V=y[2*F+1];z>=r&&z<=u&&V>=o&&V<=f&&E.push(m[F]),(M===0?r<=z:o<=V)&&(T.push(k),T.push(F-1),T.push(1-M)),(M===0?u>=z:f>=V)&&(T.push(F+1),T.push(I),T.push(1-M))}return E}within(r,o,u){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:f,coords:m,nodeSize:y}=this,b=[0,f.length-1,0],T=[],E=u*u;for(;b.length;){const M=b.pop()||0,I=b.pop()||0,k=b.pop()||0;if(I-k<=y){for(let W=k;W<=I;W++)KC(m[2*W],m[2*W+1],r,o)<=E&&T.push(f[W]);continue}const F=k+I>>1,z=m[2*F],V=m[2*F+1];KC(z,V,r,o)<=E&&T.push(f[F]),(M===0?r-u<=z:o-u<=V)&&(b.push(k),b.push(F-1),b.push(1-M)),(M===0?r+u>=z:o+u>=V)&&(b.push(F+1),b.push(I),b.push(1-M))}return T}}function nb(n,r,o,u,f,m){if(f-u<=o)return;const y=u+f>>1;YC(n,r,y,u,f,m),nb(n,r,o,u,y-1,1-m),nb(n,r,o,y+1,f,1-m)}function YC(n,r,o,u,f,m){for(;f>u;){if(f-u>600){const E=f-u+1,M=o-u+1,I=Math.log(E),k=.5*Math.exp(2*I/3),F=.5*Math.sqrt(I*k*(E-k)/E)*(M-E/2<0?-1:1);YC(n,r,o,Math.max(u,Math.floor(o-M*k/E+F)),Math.min(f,Math.floor(o+(E-M)*k/E+F)),m)}const y=r[2*o+m];let b=u,T=f;for(Pm(n,r,u,o),r[2*f+m]>y&&Pm(n,r,u,f);b<T;){for(Pm(n,r,b,T),b++,T--;r[2*b+m]<y;)b++;for(;r[2*T+m]>y;)T--}r[2*u+m]===y?Pm(n,r,u,T):(T++,Pm(n,r,T,f)),T<=o&&(u=T+1),o<=T&&(f=T-1)}}function Pm(n,r,o,u){sb(n,o,u),sb(r,2*o,2*u),sb(r,2*o+1,2*u+1)}function sb(n,r,o){const u=n[r];n[r]=n[o],n[o]=u}function KC(n,r,o,u){const f=n-o,m=r-u;return f*f+m*m}l.$=eC,l.A=Yh,l.B=Tp,l.C=Ji,l.D=Fe,l.E=eo,l.F=fn,l.G=Pt,l.H=class{constructor(n){this.specification=n}possiblyEvaluate(n,r){return yn(n.expression.evaluate(r))}interpolate(n,r,o){return{x:Ut(n.x,r.x,o),y:Ut(n.y,r.y,o),z:Ut(n.z,r.z,o),azimuthal:Ut(n.azimuthal,r.azimuthal,o),polar:Ut(n.polar,r.polar,o)}}},l.I=kx,l.J=ra,l.K=dn,l.L=sr,l.M=class{constructor(n,r,o,u){this.id=n,this.position=r!=null?new ke(r[0],r[1]):new ke(0,0),this.orientation=o??[0,0,0],this.nodes=u,this.uploaded=!1,this.aabb=new xn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(n,r){if(l.a6.multiply(n.matrix,r,n.matrix),n.meshes)for(const o of n.meshes){const u=xn.applyTransform(o.aabb,n.matrix);this.aabb.encapsulate(u)}if(n.children)for(const o of n.children)this._applyTransformations(o,n.matrix)}computeBoundsAndApplyParent(){const n=l.a6.identity([]);for(const r of this.nodes)this._applyTransformations(r,n)}computeModelMatrix(n,r,o,u,f,m,y=!1){vC(this.matrix,this,n.transform,this.position,r,o,u,f,m,y)}upload(n){if(!this.uploaded){for(const r of this.nodes)qx(r,n);for(const r of this.nodes)Cy(r);this.uploaded=!0}}destroy(){for(const n of this.nodes)Gx(n)}},l.O=vr,l.P=xe,l.Q=gu,l.R=ns,l.S=lc,l.T=jx,l.U=Ut,l.V=Bt,l.W=Pi,l.X=class{constructor(n){this.specification=n}possiblyEvaluate(n,r){return function([o,u]){const f=yn([1,o,u]);return{x:f.x,y:f.y,z:f.z}}(n.expression.evaluate(r))}interpolate(n,r,o){return{x:Ut(n.x,r.x,o),y:Ut(n.y,r.y,o),z:Ut(n.z,r.z,o)}}},l.Y=function(n,r,o=0,u=!0){const f=new xe(o,o),m=n.sub(f),y=r.add(f),b=[m,new xe(y.x,m.y),y,new xe(m.x,y.y)];return u&&b.push(m.clone()),b},l.Z=fu,l._=function(n,r){const o=[];for(let u=0;u<n.length;u++){const f=Gr(u-1,-1,n.length-1),m=Gr(u+1,-1,n.length-1),y=n[u],b=n[m],T=n[f].sub(y).unit(),E=b.sub(y).unit(),M=E.angleWithSep(T.x,T.y),I=T.add(E).unit().mult(-1*r/Math.sin(M/2));o.push(y.add(I))}return o},l.a=Ta,l.a$=function(n){const r=[];for(const o in n)r.push(n[o]);return r},l.a0=tS,l.a1=function(n,r,o=0){return l.N.fromValues(((r.x-o)*n.scale-n.x)*Bt,(r.y*n.scale-n.y)*Bt,Vr(r.z,r.y))},l.a2=lx,l.a3=yM,l.a4=function(n){let r=1/0,o=1/0,u=-1/0,f=-1/0;for(const m of n)r=Math.min(r,m.x),o=Math.min(o,m.y),u=Math.max(u,m.x),f=Math.max(f,m.y);return{min:new xe(r,o),max:new xe(u,f)}},l.a5=Ii,l.a8=oa,l.a9=gr,l.aA=lg,l.aB=wn,l.aC=$r,l.aD=Eg,l.aE=by,l.aF=function(){io.isLoading()||io.isLoaded()||Fa()!=="deferred"||Lp()},l.aG=ro,l.aH=Xn,l.aI=kC,l.aJ=ir,l.aK=Mx,l.aL=Ex,l.aM=ls,l.aN=Ao,l.aO=Zp,l.aP=xA,l.aQ=Qg,l.aR=Vx,l.aS=function(n,r){const o=lc(r.zoom);if(o===0)return Ha(n);const u=qg(n),f=dx(u),m=Ii(u.getWest())*r.worldSize,y=Ii(u.getEast())*r.worldSize,b=gi(u.getNorth())*r.worldSize,T=gi(u.getSouth())*r.worldSize,E=[m,b,0],M=[y,b,0],I=[m,T,0],k=[y,T,0],F=l.a6.invert([],r.globeMatrix);return l.N.transformMat4(E,E,F),l.N.transformMat4(M,M,F),l.N.transformMat4(I,I,F),l.N.transformMat4(k,k,F),f[0]=Al(f[0],I,o),f[1]=Al(f[1],k,o),f[2]=Al(f[2],M,o),f[3]=Al(f[3],E,o),xn.fromPoints(f)},l.aT=Xg,l.aU=nm,l.aV=Al,l.aW=Ls,l.aX=DF,l.aY=Ir,l.aZ=GC,l.a_=nt,l.aa=ri,l.ab=re,l.ac=function(n,r){const o={};for(let u=0;u<r.length;u++){const f=r[u];f in n&&(o[f]=n[f])}return o},l.ad=He,l.ae=gi,l.af=class{constructor(n){this.entries={},this.scheduler=n}request(n,r,o,u){const f=this.entries[n]=this.entries[n]||{callbacks:[]};if(f.result){const[m,y]=f.result;return this.scheduler?this.scheduler.add(()=>{u(m,y)},r):u(m,y),()=>{}}return f.callbacks.push(u),f.cancel||(f.cancel=o((m,y)=>{f.result=[m,y];for(const b of f.callbacks)this.scheduler?this.scheduler.add(()=>{b(m,y)},r):b(m,y);setTimeout(()=>delete this.entries[n],3e3)})),()=>{f.result||(f.callbacks=f.callbacks.filter(m=>m!==u),f.callbacks.length||(f.cancel(),delete this.entries[n]))}}},l.ag=Vp,l.ah=function(n,r,o){const u=JSON.stringify(n.request);return n.data&&(this.deduped.entries[u]={result:[null,n.data]}),this.deduped.request(u,{type:"parseTile",isSymbolTile:n.isSymbolTile,zoom:n.tileZoom},f=>{const m=nt(n.request,(y,b,T,E)=>{y?f(y):b&&f(null,{vectorTile:o?void 0:new Sx(new xd(b)),rawData:b,cacheControl:T,expires:E})});return()=>{m.cancel(),f()}},r)},l.ai=function(n){Ci++,Ci>ot&&(n.getActor().send("enforceCacheSizeLimit",Se),Ci=0)},l.aj=bn,l.ak=Je,l.al=function(n){return n<=1?1:Math.pow(2,Math.floor(Math.log(n)/Math.LN2))},l.am=Tt,l.an=cC,l.ao=uC,l.ap=lC,l.aq=function(n,r){const o=document.createElement("video");o.muted=!0,o.onloadstart=function(){r(null,o)};for(let u=0;u<n.length;u++){const f=document.createElement("source");yt(n[u])||(o.crossOrigin="Anonymous"),f.src=n[u],o.appendChild(f)}return{cancel:()=>{}}},l.ar=Ty,l.as=_m,l.at=wi,l.au=Qi,l.av=na,l.aw=os,l.ax=Qt,l.ay=Mr,l.az=xl,l.b=lo,l.b$=vg,l.b0=function(n,r){const o=[];for(const u in n)u in r||o.push(u);return o},l.b1=Tr,l.b2=["type","source","source-layer","minzoom","maxzoom","filter","layout"],l.b3=function(n,r){const{x:o,y:u}=n.point,f=AA(o,u,n.worldSize/n._pixelsPerMercatorPixel,0,0);return l.a6.multiply(f,f,fx(Ha(r)))},l.b5=gd,l.b6=Io,l.b7=ay,l.b8=function(n,r,o,u,f){const m=5*r+2;n.float32[m+0]=o,n.float32[m+1]=u,n.float32[m+2]=f},l.b9=xy,l.bA=Ay,l.bB=hC,l.bC=function(n){const r=hC(n,!0);return l.b4.invert([],[r[0],r[1],r[4],r[5]])},l.bD=cx,l.bE=function(n){const{x:r,y:o}=n.point,{lng:u,lat:f}=n._center;return AA(r,o,n.worldSize,u,f)},l.bF=Ct,l.bG=le,l.bH=function(n){const r=Math.round((n+45+360)%360/90)%4;return Kt[r]},l.bI=45,l.bJ=ii,l.bK=g,l.bL=Va,l.bM=zg,l.bN=Ps,l.bO=cd,l.bP=_,l.bQ=function(n,r,o){const u=Math.sqrt(n*n+r*r+o*o),f=u>0?Math.acos(o/u)*Be:0;let m=n!==0||r!==0?Math.atan2(-r,-n)*Be+90:0;return m<0&&(m+=360),[u,m,f]},l.bR=ji,l.bS=xn,l.bT=yn,l.bU=function(n){return[Math.pow(n[0],1/2.2),Math.pow(n[1],1/2.2),Math.pow(n[2],1/2.2)]},l.bV=function(n){return n({pluginStatus:$s,pluginURL:Na}),Dp.on("pluginStateChange",n),n},l.bW=Ad,l.bX=Py,l.bY=wd,l.bZ=Dx,l.b_=un,l.ba=$M,l.bb=Vo,l.bc=Ts,l.bd=YM,l.be=Nx,l.bf=Ox,l.bg=rb,l.bh=Gr,l.bj=Qe,l.bk=he,l.bl=Ti,l.bm=function(n,r,o){n[4*r+0]=o[0],n[4*r+1]=o[1],n[4*r+2]=o[2],n[4*r+3]=o[3]},l.bn=ke,l.bo=sC,l.bp=Mt,l.bq=ux,l.br=dC,l.bs=mt,l.bt=TA,l.bu=function(n,r,o,u,f,m,y,b,T){if(T.name==="globe")return TA(n,r,new mt(o,u,f),!1);const E=_m({z:o,x:u,y:f},T);return new xn([(m+E.x/E.scale)*r,r*(E.y/E.scale),y],[(m+E.x2/E.scale)*r,r*(E.y2/E.scale),b])},l.bv=function(n,r,o){let u=0;for(let f=0;f<2;++f){const m=o?o[f]:0;n[f]>m&&(u+=(n[f]-m)*(n[f]-m)),r[f]<m&&(u+=(m-r[f])*(m-r[f]))}return u},l.bw=Ui,l.bx=Q,l.by=function(n){const r=l.a6.identity(new Float64Array(16));l.a6.multiply(r,n.pixelMatrix,n.globeMatrix);const o=[0,Ce,0],u=[0,Ue,0];return l.N.transformMat4(o,o,r),l.N.transformMat4(u,u,r),[o[0]>0&&o[0]<=n.width&&o[1]>0&&o[1]<=n.height&&!mx(n,new ke(n.center.lat,90)),u[0]>0&&u[0]<=n.width&&u[1]>0&&u[1]<=n.height&&!mx(n,new ke(n.center.lat,-90))]},l.bz=function(n,r){const{scale:o}=n.tileTransform,u=o*Bt/(n.tileSize*Math.pow(2,r.zoom-n.tileID.overscaledZ+n.tileID.canonical.z));return l.b4.scale(new Float32Array(4),r.inverseAdjustmentMatrix,[u,u])},l.c=RC,l.c$=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},l.c0=U,l.c1=gn,l.c2=function(n,r,o){return n.type==="custom"?new $B(n,r):new bz[n.type](n,r,o)},l.c3=function(n){const r=n.indexOf(id);return r>=0?n.slice(0,r):n},l.c4=function(n){return n.indexOf(id)>=0},l.c5=function(n){const r=n.indexOf(id);return r>=0?n.slice(r+1):""},l.c6=function(n){const r=[],o=n.id;return o===void 0&&r.push({message:`layers.${o}: missing required property "id"`}),n.render===void 0&&r.push({message:`layers.${o}: missing required method "render"`}),n.renderingMode&&n.renderingMode!=="2d"&&n.renderingMode!=="3d"&&r.push({message:`layers.${o}: property "renderingMode" must be either "2d" or "3d"`}),r},l.c7=In,l.c8=Dp,l.c9=et,l.cA=bM,l.cB=(n,r,o,u,f,m)=>{const y=n.transform;return{u_matrix:xM(n,r,o,u),u_texsize:r.imageAtlasTexture?r.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:y.calculatePixelsToTileUnitsMatrix(r),u_device_pixel_ratio:f,u_image:0,u_tile_units_to_pixels:vM(r,y),u_units_to_pixels:[1/y.pixelsToGLUnits[0],1/y.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:m}},l.cC=(n,r,o,u,f,m,y)=>{const b=n.transform,T=b.calculatePixelsToTileUnitsMatrix(r);return{u_matrix:xM(n,r,o,u),u_pixels_to_tile_units:T,u_device_pixel_ratio:m,u_units_to_pixels:[1/b.pixelsToGLUnits[0],1/b.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:f,u_texsize:wM(o)&&r.lineAtlasTexture?r.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:vM(r,n.transform),u_alpha_discard_threshold:0,u_trim_offset:y,u_emissive_strength:o.paint.get("line-emissive-strength")}},l.cD=Pn,l.cE=sm,l.cF=dM,l.cG=Zt,l.cH=oy,l.cI=hc,l.cJ=450,l.cK=7,l.cL=UB,l.cM=256,l.cN=fx,l.cO=Ua,l.cP=Xp,l.cQ=function(n,r,o,u,f){return ri((n-r)/(o-r)*(f-u)+u,u,f)},l.cR=Vi,l.cS=Wx,l.cT=[1,1,1],l.cU=md,l.cV=Sd,l.cW=zo,l.cX=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[]}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(n){const r=HA(new xe(0,0),new xe(Bt,Bt),n),o=[];for(const u of this._activeRegions){if(u.hiddenByOverlap||!WA(r,u))continue;const f=x4(u.min,u.max,n);o.push({min:f.min,max:f.max,sourceId:this._sourceIds[u.priority],footprint:u.footprint,footprintTileId:u.tileId})}return o}setSources(n){this._setSources(n.map(r=>({getSourceId:()=>r.cache.id,getFootprints:()=>{const o=[];for(const u of r.cache.getVisibleCoordinates()){const f=r.cache.getTile(u).buckets[r.layer];if(f)for(const m of f.getNodesInfo()){const y=m.node;y.footprint&&o.push({footprint:y.footprint,id:u.toUnwrapped()})}}return o}})))}_addSource(n){const r=n.getFootprints();if(r.length!==0){for(const o of r){if(!o.footprint)continue;const u=HA(o.footprint.min,o.footprint.max,o.id);this._activeRegions.push({min:u.min,max:u.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:o.id,footprint:o.footprint})}this._sourceIds.push(n.getSourceId())}}_computeReplacement(){this._activeRegions.sort((r,o)=>r.priority-o.priority||ry(r.min,o.min)||ry(r.max,o.max));let n=this._activeRegions.length!==this._prevRegions.length;if(!n){let r=0,o=0;for(;!n&&r!==this._activeRegions.length;){const u=this._activeRegions[r],f=this._prevRegions[o];n=u.priority!==f.priority||!$A(u,f),++r,++o}}if(n){++this._updateTime;const r=o=>{const u=this._activeRegions;if(o>=u.length)return o;const f=u[o].priority;for(;o<u.length&&u[o].priority===f;)++o;return o};if(this._sourceIds.length>1){let o=0,u=r(o);for(;o!==u;){let f=o;const m=o;for(;f!==u;){const y=this._activeRegions[f];y.hiddenByOverlap=!1;for(let b=0;b<m;b++){const T=this._activeRegions[b];if(!T.hiddenByOverlap&&WA(y,T)&&(y.hiddenByOverlap=GA(y.footprint,y.tileId,T.footprint,T.tileId),y.hiddenByOverlap))break}++f}o=u,u=r(o)}}}}_setSources(n){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let r=n.length-1;r>=0;r--)this._addSource(n[r]);this._computeReplacement()}},l.cY=class{constructor(n){this._createGrid(n),this._createPoles(n)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const n of this._poleSegments)n.destroy();for(const n of this._gridSegments)n.withSkirts.destroy(),n.withoutSkirts.destroy()}_fillGridMeshWithLods(n,r){const o=new Ao,u=new os,f=[],m=n+1+2,y=r[0]+1,b=r[0]+1+(1+r.length),T=(E,M,I)=>{let k=E===m-1?E-2:E===0?E:E-1;return k+=I?24575:0,[k,M]};for(let E=0;E<m;++E)o.emplaceBack(...T(E,0,!0));for(let E=0;E<y;++E)for(let M=0;M<m;++M)o.emplaceBack(...T(M,E,(M===0||M===m-1)&&!0));for(let E=0;E<r.length;++E){const M=r[E];for(let I=0;I<m;++I)o.emplaceBack(...T(I,M,!0))}for(let E=0;E<r.length;++E){const M=u.length,I=r[E]+1+2,k=new os;for(let V=0;V<I-1;V++){const W=V===I-2,G=W?m*(b-r.length+E-V):m;for(let te=0;te<m-1;te++){const se=V*m+te;V===0||W||te===0||te===m-2?(k.emplaceBack(se+1,se,se+G),k.emplaceBack(se+G,se+G+1,se+1)):(u.emplaceBack(se+1,se,se+G),u.emplaceBack(se+G,se+G+1,se+1))}}const F=wn.simpleSegment(0,M,o.length,u.length-M);for(let V=0;V<k.uint16.length;V+=3)u.emplaceBack(k.uint16[V],k.uint16[V+1],k.uint16[V+2]);const z=wn.simpleSegment(0,M,o.length,u.length-M);f.push({withoutSkirts:F,withSkirts:z})}return{vertices:o,indices:u,segments:f}}_createGrid(n){const r=this._fillGridMeshWithLods(ve,we);this._gridSegments=r.segments,this._gridBuffer=n.createVertexBuffer(r.vertices,xA.members),this._gridIndexBuffer=n.createIndexBuffer(r.indices,!0)}_createPoles(n){const r=new os;for(let y=0;y<=ve;y++)r.emplaceBack(0,y+1,y+2);this._poleIndexBuffer=n.createIndexBuffer(r,!0);const o=new Ua,u=new Ua,f=new Ua,m=new Ua;this._poleSegments=[];for(let y=0,b=0;y<le;y++){const T=360/(1<<y);o.emplaceBack(0,-re,0,.5,0),u.emplaceBack(0,-re,0,.5,1),f.emplaceBack(0,-re,0,.5,.5),m.emplaceBack(0,-re,0,.5,.5);for(let E=0;E<=ve;E++){let M=E/ve,I=0;const k=Ut(0,T,M),[F,z,V]=Re(FF,BF,k,re);o.emplaceBack(F,z,V,M,I),u.emplaceBack(F,z,V,M,1-I);const W=Qe(k);M=.5+.5*Math.sin(W),I=.5+.5*Math.cos(W),f.emplaceBack(F,z,V,M,I),m.emplaceBack(F,z,V,M,1-I)}this._poleSegments.push(wn.simpleSegment(b,0,66,64)),b+=66}this._poleNorthVertexBuffer=n.createVertexBuffer(o,Wg,!1),this._poleSouthVertexBuffer=n.createVertexBuffer(u,Wg,!1),this._texturedPoleNorthVertexBuffer=n.createVertexBuffer(f,Wg,!1),this._texturedPoleSouthVertexBuffer=n.createVertexBuffer(m,Wg,!1)}getGridBuffers(n,r){return[this._gridBuffer,this._gridIndexBuffer,r?this._gridSegments[n].withSkirts:this._gridSegments[n].withoutSkirts]}getPoleBuffers(n,r){return[r?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,r?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[n]]}},l.cZ=function(n){return As.has(n)},l.c_=fi,l.ca=a,l.cb=class extends sa{constructor(n){super(n),this.current=x}set(n,r,o){if(this.fetchUniformLocation(n,r)){for(let u=0;u<9;u++)if(o[u]!==this.current[u]){this.current=o,this.gl.uniformMatrix3fv(this.location,!1,o);break}}}},l.cc=Ie,l.cd=function(n,r,o){const u=lc(o.zoom),f=n.style.map._antialias,m=r.options.extStandardDerivativesForceOff||n.terrain&&n.terrain.exaggeration()>0;return u===0&&!f&&!m},l.ce=function(n){const r=n.pixelsPerMeter,o=r/Ti(1,n.center.lat),u=l.a6.identity(new Float64Array(16));return l.a6.translate(u,u,[n.point.x,n.point.y,0]),l.a6.scale(u,u,[o,o,r]),Float32Array.from(u)},l.cf=qg,l.cg=function(n){const r=Ui-5;n=ri(n,-r,r)/r*90;const o=Math.pow(Math.abs(Math.sin(Qe(n))),3);return Math.round(o*(we.length-1))},l.ch=function(n,r,o,u){const f=r.getNorth(),m=r.getSouth(),y=r.getWest(),b=r.getEast(),T=1<<n.z,E=b-y,M=f-m,I=E/ve,k=-M/we[o],F=[0,I,0,k,0,0,f,y,0];if(n.z>0){const z=180/u;l.co.multiply(F,F,[z/E+1,0,0,0,z/M+1,0,-.5*z/I,.5*z/k,1])}return F[2]=T,F[5]=n.x,F[8]=n.y,F},l.ci=Ha,l.cj=function(n,r,o){const u=l.a6.identity(new Float64Array(16)),f=(r/(1<<n)-.5)*Math.PI*2;return l.a6.rotateY(u,o.globeMatrix,f),Float32Array.from(u)},l.ck=class{isDataAvailableAtPoint(n){const r=this._source();if(this.isUsingMockSource()||!r||n.y<0||n.y>1)return!1;const o=r.getSource().maxzoom,u=1<<o,f=Math.floor(n.x),m=Math.floor((n.x-f)*u),y=Math.floor(n.y*u),b=this.findDEMTileFor(new Tt(o,f,o,m,y));return!(!b||!b.dem)}getAtPointOrZero(n,r=0){return this.getAtPoint(n,r)||0}getAtPoint(n,r,o=!0){if(this.isUsingMockSource())return null;r==null&&(r=null);const u=this._source();if(!u||n.y<0||n.y>1)return r;const f=u.getSource().maxzoom,m=1<<f,y=Math.floor(n.x),b=n.x-y,T=new Tt(f,y,f,Math.floor(b*m),Math.floor(n.y*m)),E=this.findDEMTileFor(T);if(!E||!E.dem)return r;const M=E.dem,I=1<<E.tileID.canonical.z,k=(b*I-E.tileID.canonical.x)*M.dim,F=(n.y*I-E.tileID.canonical.y)*M.dim,z=Math.floor(k),V=Math.floor(F);return(o?this.exaggeration():1)*Ut(Ut(M.get(z,V),M.get(z,V+1),F-V),Ut(M.get(z+1,V),M.get(z+1,V+1),F-V),k-z)}getAtTileOffset(n,r,o){const u=1<<n.canonical.z;return this.getAtPointOrZero(new sr(n.wrap+(n.canonical.x+r/Bt)/u,(n.canonical.y+o/Bt)/u))}getAtTileOffsetFunc(n,r,o,u){return f=>{const m=this.getAtTileOffset(n,f.x,f.y),y=u.upVector(n.canonical,f.x,f.y),b=u.upVectorScale(n.canonical,r,o).metersToTile;return l.N.scale(y,y,m*b),y}}getForTilePoints(n,r,o,u){if(this.isUsingMockSource())return!1;const f=md.create(this,n,u);return!!f&&(r.forEach(m=>{m[2]=this.exaggeration()*f.getElevationAt(m[0],m[1],o)}),!0)}getMinMaxForTile(n){if(this.isUsingMockSource())return null;const r=this.findDEMTileFor(n);if(!r||!r.dem)return null;const o=r.dem.tree,u=r.tileID,f=1<<n.canonical.z-u.canonical.z;let m=n.canonical.x/f-u.canonical.x,y=n.canonical.y/f-u.canonical.y,b=0;for(let T=0;T<n.canonical.z-u.canonical.z&&!o.leaves[b];T++){m*=2,y*=2;const E=2*Math.floor(y)+Math.floor(m);b=o.childOffsets[b]+E,m%=1,y%=1}return{min:this.exaggeration()*o.minimums[b],max:this.exaggeration()*o.maximums[b]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(n,r,o){throw new Error("Pure virtual method called.")}pointCoordinate(n){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(n){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const n=this.visibleDemTiles;if(n.length===0)return null;let r=!1,o=Number.MAX_VALUE,u=Number.MIN_VALUE;for(const f of n){const m=this.getMinMaxForTile(f.tileID);m&&(o=Math.min(o,m.min),u=Math.max(u,m.max),r=!0)}return r?{min:o,max:u}:null}},l.cl=Hg,l.cm=LA,l.cn=function(n,r){return[Math.pow(n[0],2.2)*r,Math.pow(n[1],2.2)*r,Math.pow(n[2],2.2)*r]},l.cp=SA,l.cq=256,l.cr=function(n,r){const o=[0,0,0],u=Xg(Ha(r.canonical));return l.N.transformMat4(o,o,u),l.N.transformMat4(o,o,n),o},l.cs=n=>({u_camera_to_center_distance:new Ps(n),u_extrude_scale:new S(n),u_device_pixel_ratio:new Ps(n),u_matrix:new g(n),u_inv_rot_matrix:new g(n),u_merc_center:new Va(n),u_tile_id:new zg(n),u_zoom_transition:new Ps(n),u_up_dir:new zg(n),u_emissive_strength:new Ps(n)}),l.ct=n=>({u_matrix:new g(n),u_pixels_to_tile_units:new S(n),u_device_pixel_ratio:new Ps(n),u_units_to_pixels:new Va(n),u_dash_image:new cd(n),u_gradient_image:new cd(n),u_image_height:new Ps(n),u_texsize:new Va(n),u_tile_units_to_pixels:new Ps(n),u_alpha_discard_threshold:new Ps(n),u_trim_offset:new Va(n),u_emissive_strength:new Ps(n)}),l.cu=n=>({u_matrix:new g(n),u_texsize:new Va(n),u_pixels_to_tile_units:new S(n),u_device_pixel_ratio:new Ps(n),u_image:new cd(n),u_units_to_pixels:new Va(n),u_tile_units_to_pixels:new Ps(n),u_alpha_discard_threshold:new Ps(n),u_trim_offset:new Va(n)}),l.cv=sd,l.cw=Z4,l.cx=Y4,l.cy=PA,l.cz=(n,r,o,u,f,m)=>{const y=n.transform,b=y.projection.name==="globe";let T;if(m.paint.get("circle-pitch-alignment")==="map")if(b){const M=SA(y.zoom,r.canonical)*y._pixelsPerMercatorPixel;T=Float32Array.from([M,0,0,M])}else T=y.calculatePixelsToTileUnitsMatrix(o);else T=new Float32Array([y.pixelsToGLUnits[0],0,0,y.pixelsToGLUnits[1]]);const E={u_camera_to_center_distance:n.transform.getCameraToCenterDistance(y.projection),u_matrix:n.translatePosMatrix(r.projMatrix,o,m.paint.get("circle-translate"),m.paint.get("circle-translate-anchor")),u_device_pixel_ratio:lt.devicePixelRatio,u_extrude_scale:T,u_inv_rot_matrix:zF,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:m.paint.get("circle-emissive-strength")};if(b){E.u_inv_rot_matrix=u,E.u_merc_center=f,E.u_tile_id=[r.canonical.x,r.canonical.y,1<<r.canonical.z],E.u_zoom_transition=lc(y.zoom);const M=f[0]*Bt,I=f[1]*Bt;E.u_up_dir=y.projection.upVector(new mt(0,0,0),M,I)}return E},l.d=kt,l.d0=Yi,l.d1=lr,l.d2=Ye,l.d3=function([n,r,o]){const u=Math.hypot(n,r,o),f=Math.atan2(n,o),m=.5*Math.PI-Math.acos(-r/u);return new ke(Ct(f),Ct(m))},l.d4=Ge,l.d5=O,l.d6=mx,l.d7=MA,l.d8=function(n){const r=[0,0,0],o=l.a6.identity(new Float64Array(16));return l.a6.multiply(o,n.pixelMatrix,n.globeMatrix),l.N.transformMat4(r,r,o),new xe(r[0],r[1])},l.d9=function(n){const r=n.navigator?n.navigator.userAgent:null;return!!function(o){if(Ke==null){const u=o.navigator?o.navigator.userAgent:null;Ke=!!o.safari||!(!u||!(/\b(iPad|iPhone|iPod)\b/.test(u)||u.match("Safari")&&!u.match("Chrome")))}return Ke}(n)&&r&&(r.match("Version/15.4")||r.match("Version/15.5")||r.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},l.dA=ua,l.dB=OC,l.dC=DC,l.dD=_M,l.dE=Ki,l.dF=HM,l.dG=function(n,r,o,u,f,m,y,b,T,E,M){n.createArrays(),n.tilePixelRatio=Bt/(512*n.overscaling),n.compareText={},n.iconsNeedLinear=!1;const I=n.layers[0].layout,k=n.layers[0]._unevaluatedLayout._values,F={};if(n.textSizeData.kind==="composite"){const{minZoom:G,maxZoom:te}=n.textSizeData;F.compositeTextSizes=[k["text-size"].possiblyEvaluate(new dn(G),b),k["text-size"].possiblyEvaluate(new dn(te),b)]}if(n.iconSizeData.kind==="composite"){const{minZoom:G,maxZoom:te}=n.iconSizeData;F.compositeIconSizes=[k["icon-size"].possiblyEvaluate(new dn(G),b),k["icon-size"].possiblyEvaluate(new dn(te),b)]}F.layoutTextSize=k["text-size"].possiblyEvaluate(new dn(T+1),b),F.layoutIconSize=k["icon-size"].possiblyEvaluate(new dn(T+1),b),F.textMaxSize=k["text-size"].possiblyEvaluate(new dn(18),b);const z=I.get("text-rotation-alignment")==="map"&&I.get("symbol-placement")!=="point",V=I.get("text-size");let W=!1;for(const G of n.features)if(G.icon&&G.icon.nameSecondary){W=!0;break}for(const G of n.features){const te=I.get("text-font").evaluate(G,{},b).join(","),se=V.evaluate(G,{},b),ne=F.layoutTextSize.evaluate(G,{},b),ye=(F.layoutIconSize.evaluate(G,{},b),{horizontal:{},vertical:void 0}),de=G.text;let Ee,Pe=[0,0];if(de){const Le=de.toString(),rt=I.get("text-letter-spacing").evaluate(G,{},b)*Ts,ht=I.get("text-line-height").evaluate(G,{},b)*Ts,Ze=z1(Le)?rt:0,ct=I.get("text-anchor").evaluate(G,{},b),qe=I.get("text-variable-anchor");if(!qe){const Wt=I.get("text-radial-offset").evaluate(G,{},b);Pe=Wt?YM(ct,[Wt*Ts,Lx]):I.get("text-offset").evaluate(G,{},b).map(_t=>_t*Ts)}let at=z?"center":I.get("text-justify").evaluate(G,{},b);const Ot=I.get("symbol-placement")==="point",dt=Ot?I.get("text-max-width").evaluate(G,{},b)*Ts:1/0,Xt=Wt=>{n.allowVerticalPlacement&&La(Le)&&(ye.vertical=Rx(de,r,o,f,te,dt,ht,ct,Wt,Ze,Pe,Io.vertical,!0,ne,se))};if(!z&&qe){const Wt=at==="auto"?qe.map(hi=>Nx(hi)):[at];let _t=!1;for(let hi=0;hi<Wt.length;hi++){const ti=Wt[hi];if(!ye.horizontal[ti])if(_t)ye.horizontal[ti]=ye.horizontal[0];else{const qt=Rx(de,r,o,f,te,dt,ht,"center",ti,Ze,Pe,Io.horizontal,!1,ne,se);qt&&(ye.horizontal[ti]=qt,_t=qt.positionedLines.length===1)}}Xt("left")}else{if(at==="auto"&&(at=Nx(ct)),Ot||I.get("text-writing-mode").indexOf("horizontal")>=0||!La(Le)){const Wt=Rx(de,r,o,f,te,dt,ht,ct,at,Ze,Pe,Io.horizontal,!1,ne,se);Wt&&(ye.horizontal[at]=Wt)}Xt(Ot?"left":at)}}let De=!1;if(G.icon&&G.icon.namePrimary){const Le=u[G.icon.namePrimary];Le&&(Ee=mB(f[G.icon.namePrimary],G.icon.nameSecondary?f[G.icon.nameSecondary]:void 0,I.get("icon-offset").evaluate(G,{},b),I.get("icon-anchor").evaluate(G,{},b)),De=Le.sdf,n.sdfIcons===void 0?n.sdfIcons=Le.sdf:n.sdfIcons!==Le.sdf&&mr("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Le.pixelRatio!==n.pixelRatio||I.get("icon-rotate").constantOr(1)!==0)&&(n.iconsNeedLinear=!0))}const Ve=JM(ye.horizontal)||ye.vertical;n.iconsInText||(n.iconsInText=!!Ve&&Ve.iconsInText),(Ve||Ee)&&wB(n,G,ye,Ee,u,F,ne,0,Pe,De,y,b,E,M,W)}m&&n.generateCollisionDebugBuffers(T,n.collisionBoxArray)},l.dH=Sx,l.dI=xd,l.dJ=ny,l.dK=pe,l.dL=ty,l.dM=ey,l.dN=st,l.dO=AM,l.dP=function(n){let r=0;if(new Uint32Array(n,0,1)[0]!==EC){const o=new Uint32Array(n,0,7),[,,u,f,m,y]=o;r=o.byteLength+f+m+y+m,(u!==n.byteLength||r>=n.byteLength)&&mr("Invalid b3dm header information.")}return CC(n,r)},l.dQ=function(n,r){const o=RC(n);for(const u of o){for(const f of u.meshes)mz(f);u.lights&&(u.lightMeshIndex=u.meshes.length,u.meshes.push(_z(u.lights,r)))}return o},l.dR=ky,l.dS=xC,l.dT=io,l.dU=function(n){Wi(),xt&&xt.then(r=>{r.keys().then(o=>{for(let u=0;u<o.length-n;u++)r.delete(o[u])})})},l.da=class{constructor(n,r,o){this._transformRequestFn=n,this._customAccessToken=r,this._silenceAuthErrors=!!o,this._createSkuToken()}_createSkuToken(){const n=function(){let r="";for(let o=0;o<10;o++)r+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",vt,r].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=n.token,this._skuTokenExpiresAt=n.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(n,r){return this._transformRequestFn&&this._transformRequestFn(n,r)||{url:n}}normalizeStyleURL(n,r){if(!U(n))return n;const o=ui(n);return o.params.push(`sdk=js-${A}`),o.path=`/styles/v1${o.path}`,this._makeAPIURL(o,this._customAccessToken||r)}normalizeGlyphsURL(n,r){if(!U(n))return n;const o=ui(n);return o.path=`/fonts/v1${o.path}`,this._makeAPIURL(o,this._customAccessToken||r)}normalizeModelURL(n,r){if(!U(n))return n;const o=ui(n);return o.path=`/models/v1${o.path}`,this._makeAPIURL(o,this._customAccessToken||r)}normalizeSourceURL(n,r,o,u){if(!U(n))return n;const f=ui(n);return f.path=`/v4/${f.authority}.json`,f.params.push("secure"),o&&f.params.push(`language=${o}`),u&&f.params.push(`worldview=${u}`),this._makeAPIURL(f,this._customAccessToken||r)}normalizeSpriteURL(n,r,o,u){const f=ui(n);return U(n)?(f.path=`/styles/v1${f.path}/sprite${r}${o}`,this._makeAPIURL(f,this._customAccessToken||u)):(f.path+=`${r}${o}`,bi(f))}normalizeTileURL(n,r,o){if(this._isSkuTokenExpired()&&this._createSkuToken(),n&&!U(n))return n;const u=ui(n);u.path=u.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${r||o&&u.authority!=="raster"&&o===512?"@2x":""}${zi.supported?".webp":"$1"}`),u.authority==="raster"?u.path=`/${O.RASTER_URL_PREFIX}${u.path}`:u.authority==="rasterarrays"?u.path=`/${O.RASTERARRAYS_URL_PREFIX}${u.path}`:(u.path=u.path.replace(/^.+\/v4\//,"/"),u.path=`/${O.TILE_URL_VERSION}${u.path}`);const f=this._customAccessToken||function(m){for(const y of m){const b=y.match(/^access_token=(.*)$/);if(b)return b[1]}return null}(u.params)||O.ACCESS_TOKEN;return O.REQUIRE_ACCESS_TOKEN&&f&&this._skuToken&&u.params.push(`sku=${this._skuToken}`),this._makeAPIURL(u,f)}canonicalizeTileURL(n,r){const o=ui(n);if(!o.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!o.path.match(/\.[\w]+$/))return n;let u="mapbox://";o.path.match(/^\/raster\/v1\//)?u+=`raster/${o.path.replace(`/${O.RASTER_URL_PREFIX}/`,"")}`:o.path.match(/^\/rasterarrays\/v1\//)?u+=`rasterarrays/${o.path.replace(`/${O.RASTERARRAYS_URL_PREFIX}/`,"")}`:u+=`tiles/${o.path.replace(`/${O.TILE_URL_VERSION}/`,"")}`;let f=o.params;return r&&(f=f.filter(m=>!m.match(/^access_token=/))),f.length&&(u+=`?${f.join("&")}`),u}canonicalizeTileset(n,r){const o=!!r&&U(r),u=[];for(const f of n.tiles||[])L(f)?u.push(this.canonicalizeTileURL(f,o)):u.push(f);return u}_makeAPIURL(n,r){const o="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",u=ui(O.API_URL);if(n.protocol=u.protocol,n.authority=u.authority,n.protocol==="http"){const f=n.params.indexOf("secure");f>=0&&n.params.splice(f,1)}if(u.path!=="/"&&(n.path=`${u.path}${n.path}`),!O.REQUIRE_ACCESS_TOKEN)return bi(n);if(r=r||O.ACCESS_TOKEN,!this._silenceAuthErrors){if(!r)throw new Error(`An API access token is required to use Mapbox GL. ${o}`);if(r[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${o}`)}return n.params=n.params.filter(f=>f.indexOf("access_token")===-1),n.params.push(`access_token=${r||""}`),bi(n)}},l.db=function(n,r){r?As.add(n):As.delete(n)},l.dc=zi,l.dd=ss,l.de=ws,l.df=Ft,l.dg=qi,l.dh=function(n){As.delete(n)},l.di=sn,l.dj=jn,l.dk=A,l.dl=function(n,r){Se=n,ot=r},l.dm=function(n,r,o=!1){if($s===Pp||$s===Ip||$s===Rp)throw new Error("setRTLTextPlugin cannot be called multiple times.");Na=lt.resolveURL(n),$s=Pp,Op=r,kp(),o||Lp()},l.dn=Fa,l.dp=function(){Py().acquire(Xx)},l.dq=function(){const n=Em;n&&(n.isPreloaded()&&n.numActive()===1?(n.release(Xx),Em=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},l.dr=Tm,l.ds=function(n){const r=pi();if(!r)return;const o=r.delete(It);n&&o.catch(n).then(()=>n())},l.dt=wm,l.du=bC,l.dv=function(n){Zx=lt.resolveURL(n),Cd||(Cd=new Ad(Py(),new eo)),Cd.broadcast("setDracoUrl",Zx)},l.dw=wC,l.dx=function(n){Md=lt.resolveURL(n),Cd||(Cd=new Ad(Py(),new eo)),Cd.broadcast("setMeshoptUrl",Md)},l.dy=Ht,l.dz=cc,l.e=Ar,l.f=lt,l.g=function(n,r){return et(Ar(n,{type:"json"}),r)},l.h=Po,l.i=jl,l.j=Sr,l.k=Zh,l.l=function(n){return fetch(n).then(r=>r.arrayBuffer()).then(r=>CC(r,0,n))},l.m=hg,l.n=du,l.o=vu,l.p=WM,l.q=Qh,l.r=Jh,l.s=Ep,l.t=ou,l.u=yu,l.v=ys,l.w=mr,l.x=Gl,l.z=Bp}),p(["./shared"],function(l){function A(Ke){const ie=Ke?Ke.url.toString():void 0;return ie?performance.getEntriesByName(ie):[]}function P(Ke){if(typeof Ke=="number"||typeof Ke=="boolean"||typeof Ke=="string"||Ke==null)return JSON.stringify(Ke);if(Array.isArray(Ke)){let he="[";for(const Te of Ke)he+=`${P(Te)},`;return`${he}]`}let ie="{";for(const he of Object.keys(Ke).sort())ie+=`${he}:${P(Ke[he])},`;return`${ie}}`}function O(Ke){let ie="";for(const he of l.b2)ie+=`/${P(Ke[he])}`;return ie}class L{constructor(ie){this.keyCache={},this._layers={},this._layerConfigs={},ie&&this.replace(ie)}replace(ie,he){this._layerConfigs={},this._layers={},this.update(ie,[],he)}update(ie,he,Te){this._options=Te;for(const Je of ie)this._layerConfigs[Je.id]=Je,(this._layers[Je.id]=l.c2(Je,this.scope,this._options)).compileFilter(),this.keyCache[Je.id]&&delete this.keyCache[Je.id];for(const Je of he)delete this.keyCache[Je],delete this._layerConfigs[Je],delete this._layers[Je];this.familiesBySource={};const Xe=function(Je,lt){const It={};for(let ot=0;ot<Je.length;ot++){const xt=lt&&lt[Je[ot].id]||O(Je[ot]);lt&&(lt[Je[ot].id]=xt);let $t=It[xt];$t||($t=It[xt]=[]),$t.push(Je[ot])}const Se=[];for(const ot in It)Se.push(It[ot]);return Se}(l.a$(this._layerConfigs),this.keyCache);for(const Je of Xe){const lt=Je.map(pi=>this._layers[pi.id]),It=lt[0];if(It.visibility==="none")continue;const Se=It.source||"";let ot=this.familiesBySource[Se];ot||(ot=this.familiesBySource[Se]={});const xt=It.sourceLayer||"_geojsonTileLayer";let $t=ot[xt];$t||($t=ot[xt]=[]),$t.push(lt)}}}const U=1*l.dA;class H{constructor(ie){const he={},Te=[];for(const It in ie){const Se=ie[It],ot=he[It]={};for(const xt in Se.glyphs){const $t=Se.glyphs[+xt];if(!$t||$t.bitmap.width===0||$t.bitmap.height===0)continue;const pi=$t.metrics.localGlyph?U:1,Wi={x:0,y:0,w:$t.bitmap.width+2*pi,h:$t.bitmap.height+2*pi};Te.push(Wi),ot[xt]=Wi}}const{w:Xe,h:Je}=l.p(Te),lt=new l.dz({width:Xe||1,height:Je||1});for(const It in ie){const Se=ie[It];for(const ot in Se.glyphs){const xt=Se.glyphs[+ot];if(!xt||xt.bitmap.width===0||xt.bitmap.height===0)continue;const $t=he[It][ot],pi=xt.metrics.localGlyph?U:1;l.dz.copy(xt.bitmap,lt,{x:0,y:0},{x:$t.x+pi,y:$t.y+pi},xt.bitmap)}}this.image=lt,this.positions=he}}l.dy(H,"GlyphAtlas");class Y{constructor(ie){this.tileID=new l.am(ie.tileID.overscaledZ,ie.tileID.wrap,ie.tileID.canonical.z,ie.tileID.canonical.x,ie.tileID.canonical.y),this.tileZoom=ie.tileZoom,this.uid=ie.uid,this.zoom=ie.zoom,this.canonical=ie.tileID.canonical,this.pixelRatio=ie.pixelRatio,this.tileSize=ie.tileSize,this.source=ie.source,this.scope=ie.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=ie.showCollisionBoxes,this.collectResourceTiming=!!ie.collectResourceTiming,this.promoteId=ie.promoteId,this.isSymbolTile=ie.isSymbolTile,this.tileTransform=l.as(ie.tileID.canonical,ie.projection),this.projection=ie.projection,this.brightness=ie.brightness,this.extraShadowCaster=!!ie.extraShadowCaster}parse(ie,he,Te,Xe,Je){this.status="parsing",this.data=ie,this.collisionBoxArray=new l.aD;const lt=new l.dB(Object.keys(ie.layers).sort()),It=new l.dC(this.tileID,this.promoteId);It.bucketLayerIDs=[];const Se={},ot=new l.dD(256,256),xt={featureIndex:It,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:ot,availableImages:Te,brightness:this.brightness},$t=he.familiesBySource[this.source];for(const er in $t){const Rr=ie.layers[er];if(!Rr)continue;let nn=!1,br=!1,Ln=!1;for(const Yr of $t[er])Yr[0].type==="symbol"?nn=!0:br=!0,Yr[0].is3D()&&Yr[0].type!=="model"&&(Ln=!0);if(this.extraShadowCaster&&!Ln||this.isSymbolTile===!0&&!nn||this.isSymbolTile===!1&&!br)continue;Rr.version===1&&l.w(`Vector tile source "${this.source}" layer "${er}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const rs=lt.encode(er),ns=[];for(let Yr=0;Yr<Rr.length;Yr++){const un=Rr.feature(Yr),et=It.getId(un,er);ns.push({feature:un,id:et,index:Yr,sourceLayerIndex:rs})}for(const Yr of $t[er]){const un=Yr[0];(!this.extraShadowCaster||un.is3D()&&un.type!=="model")&&(this.isSymbolTile!==void 0&&un.type==="symbol"!==this.isSymbolTile||un.minzoom&&this.zoom<Math.floor(un.minzoom)||un.maxzoom&&this.zoom>=un.maxzoom||un.visibility!=="none"&&(J(Yr,this.zoom,xt.brightness,Te),(Se[un.id]=un.createBucket({index:It.bucketLayerIDs.length,layers:Yr,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:rs,sourceID:this.source,projection:this.projection.spec})).populate(ns,xt,this.tileID.canonical,this.tileTransform),It.bucketLayerIDs.push(Yr.map(et=>et.id))))}}let pi,Wi,xr,Hi;ot.trim();const Ci={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},zi=()=>{if(pi)return this.status="done",Je(pi);if(this.extraShadowCaster)this.status="done",Je(null,{buckets:l.a$(Se).filter(er=>!er.isEmpty()),featureIndex:It,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:xt.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Wi&&xr&&Hi){const er=new H(Wi),Rr=new l.dF(xr,Hi);for(const nn in Se){const br=Se[nn];br instanceof l.aE?(J(br.layers,this.zoom,xt.brightness,Te),l.dG(br,Wi,er.positions,xr,Rr.iconPositions,this.showCollisionBoxes,Te,this.tileID.canonical,this.tileZoom,this.projection,this.brightness)):br.hasPattern&&(br instanceof l.aK||br instanceof l.aL||br instanceof l.cH)&&(J(br.layers,this.zoom,xt.brightness,Te),br.addFeatures(xt,this.tileID.canonical,Rr.patternPositions,Te,this.tileTransform,this.brightness))}this.status="done",Je(null,{buckets:l.a$(Se).filter(nn=>!nn.isEmpty()),featureIndex:It,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:er.image,lineAtlas:ot,imageAtlas:Rr,brightness:xt.brightness})}};if(!this.extraShadowCaster){const er=l.dE(xt.glyphDependencies,br=>Object.keys(br).map(Number));Object.keys(er).length?Xe.send("getGlyphs",{uid:this.uid,stacks:er,scope:this.scope},(br,Ln)=>{pi||(pi=br,Wi=Ln,zi())},void 0,!1,Ci):Wi={};const Rr=Object.keys(xt.iconDependencies);Rr.length?Xe.send("getImages",{icons:Rr,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(br,Ln)=>{pi||(pi=br,xr=Ln,zi())},void 0,!1,Ci):xr={};const nn=Object.keys(xt.patternDependencies);nn.length?Xe.send("getImages",{icons:nn,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(br,Ln)=>{pi||(pi=br,Hi=Ln,zi())},void 0,!1,Ci):Hi={}}zi()}}function J(Ke,ie,he,Te){const Xe=new l.K(ie,{brightness:he});for(const Je of Ke)Je.recalculate(Xe,Te)}class oe extends l.E{constructor(ie,he,Te,Xe,Je,lt){super(),this.actor=ie,this.layerIndex=he,this.availableImages=Te,this.loadVectorData=Je||l.ah,this.loading={},this.loaded={},this.deduped=new l.af(ie.scheduler),this.isSpriteLoaded=Xe,this.scheduler=ie.scheduler,this.brightness=lt}loadTile(ie,he){const Te=ie.uid,Xe=ie&&ie.request,Je=Xe&&Xe.collectResourceTiming,lt=this.loading[Te]=new Y(ie);lt.abort=this.loadVectorData(ie,(It,Se)=>{const ot=!this.loading[Te];if(delete this.loading[Te],ot||It||!Se)return lt.status="done",ot||(this.loaded[Te]=lt),he(It);const xt=Se.rawData,$t={};Se.expires&&($t.expires=Se.expires),Se.cacheControl&&($t.cacheControl=Se.cacheControl),lt.vectorTile=Se.vectorTile||new l.dH(new l.dI(xt));const pi=()=>{lt.parse(lt.vectorTile,this.layerIndex,this.availableImages,this.actor,(Wi,xr)=>{if(Wi||!xr)return he(Wi);const Hi={};if(Je){const Ci=A(Xe);Ci.length>0&&(Hi.resourceTiming=JSON.parse(JSON.stringify(Ci)))}he(null,l.e({rawTileData:xt.slice(0)},xr,$t,Hi))})};this.isSpriteLoaded?pi():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(pi,{type:"parseTile",isSymbolTile:ie.isSymbolTile,zoom:ie.tileZoom}):pi()}),this.loaded=this.loaded||{},this.loaded[Te]=lt})}reloadTile(ie,he){const Te=this.loaded,Xe=ie.uid,Je=this;if(Te&&Te[Xe]){const lt=Te[Xe];lt.showCollisionBoxes=ie.showCollisionBoxes,lt.projection=ie.projection,lt.brightness=ie.brightness,lt.tileTransform=l.as(ie.tileID.canonical,ie.projection),lt.extraShadowCaster=ie.extraShadowCaster;const It=(Se,ot)=>{const xt=lt.reloadCallback;xt&&(delete lt.reloadCallback,lt.parse(lt.vectorTile,Je.layerIndex,this.availableImages,Je.actor,xt)),he(Se,ot)};lt.status==="parsing"?lt.reloadCallback=It:lt.status==="done"&&(lt.vectorTile?lt.parse(lt.vectorTile,this.layerIndex,this.availableImages,this.actor,It):It())}else he(null,void 0)}abortTile(ie,he){const Te=ie.uid,Xe=this.loading[Te];Xe&&(Xe.abort&&Xe.abort(),delete this.loading[Te]),he()}removeTile(ie,he){const Te=this.loaded,Xe=ie.uid;Te&&Te[Xe]&&delete Te[Xe],he()}}class me{loadTile(ie,he){const{uid:Te,encoding:Xe,rawImageData:Je,padding:lt}=ie,It=ImageBitmap&&Je instanceof ImageBitmap?this.getImageData(Je,lt):Je;he(null,new l.dJ(Te,It,Xe,lt<1))}getImageData(ie,he){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(ie.width,ie.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=ie.width,this.offscreenCanvas.height=ie.height,this.offscreenCanvasContext.drawImage(ie,0,0,ie.width,ie.height);const Te=this.offscreenCanvasContext.getImageData(-he,-he,ie.width+2*he,ie.height+2*he);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),Te}}class pe{decodeRasterArray({task:ie,buffer:he},Te){l.aZ.performDecoding(he,ie).then(Xe=>{Te(null,Xe)},Xe=>{Te(Xe)})}}function be(Ke,ie){if(Ke.length!==0){Oe(Ke[0],ie);for(var he=1;he<Ke.length;he++)Oe(Ke[he],!ie)}}function Oe(Ke,ie){for(var he=0,Te=0,Xe=0,Je=Ke.length,lt=Je-1;Xe<Je;lt=Xe++){var It=(Ke[Xe][0]-Ke[lt][0])*(Ke[lt][1]+Ke[Xe][1]),Se=he+It;Te+=Math.abs(he)>=Math.abs(It)?he-Se+It:It-Se+he,he=Se}he+Te>=0!=!!ie&&Ke.reverse()}var je=l.dK(function Ke(ie,he){var Te,Xe=ie&&ie.type;if(Xe==="FeatureCollection")for(Te=0;Te<ie.features.length;Te++)Ke(ie.features[Te],he);else if(Xe==="GeometryCollection")for(Te=0;Te<ie.geometries.length;Te++)Ke(ie.geometries[Te],he);else if(Xe==="Feature")Ke(ie.geometry,he);else if(Xe==="Polygon")be(ie.coordinates,he);else if(Xe==="MultiPolygon")for(Te=0;Te<ie.coordinates.length;Te++)be(ie.coordinates[Te],he);return ie});const st=l.dL.prototype.toGeoJSON;let ut=class{constructor(Ke){this._feature=Ke,this.extent=l.V,this.type=Ke.type,this.properties=Ke.tags,"id"in Ke&&!isNaN(Ke.id)&&(this.id=parseInt(Ke.id,10))}loadGeometry(){if(this._feature.type===1){const Ke=[];for(const ie of this._feature.geometry)Ke.push([new l.P(ie[0],ie[1])]);return Ke}{const Ke=[];for(const ie of this._feature.geometry){const he=[];for(const Te of ie)he.push(new l.P(Te[0],Te[1]));Ke.push(he)}return Ke}}toGeoJSON(Ke,ie,he){return st.call(this,Ke,ie,he)}},xe=class{constructor(Ke){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=l.V,this.length=Ke.length,this._features=Ke}feature(Ke){return new ut(this._features[Ke])}};var it={exports:{}},Be=l.dN,Qe=l.dM.VectorTileFeature,Ct=Kt;function Kt(Ke,ie){this.options=ie||{},this.features=Ke,this.length=Ke.length}function Ie(Ke,ie){this.id=typeof Ke.id=="number"?Ke.id:void 0,this.type=Ke.type,this.rawGeometry=Ke.type===1?[Ke.geometry]:Ke.geometry,this.properties=Ke.tags,this.extent=ie||4096}Kt.prototype.feature=function(Ke){return new Ie(this.features[Ke],this.options.extent)},Ie.prototype.loadGeometry=function(){var Ke=this.rawGeometry;this.geometry=[];for(var ie=0;ie<Ke.length;ie++){for(var he=Ke[ie],Te=[],Xe=0;Xe<he.length;Xe++)Te.push(new Be(he[Xe][0],he[Xe][1]));this.geometry.push(Te)}return this.geometry},Ie.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var Ke=this.geometry,ie=1/0,he=-1/0,Te=1/0,Xe=-1/0,Je=0;Je<Ke.length;Je++)for(var lt=Ke[Je],It=0;It<lt.length;It++){var Se=lt[It];ie=Math.min(ie,Se.x),he=Math.max(he,Se.x),Te=Math.min(Te,Se.y),Xe=Math.max(Xe,Se.y)}return[ie,Te,he,Xe]},Ie.prototype.toGeoJSON=Qe.prototype.toGeoJSON;var fi=l.dO,Yi=Ct;function ri(Ke){var ie=new fi;return function(he,Te){for(var Xe in he.layers)Te.writeMessage(3,vr,he.layers[Xe])}(Ke,ie),ie.finish()}function vr(Ke,ie){var he;ie.writeVarintField(15,Ke.version||1),ie.writeStringField(1,Ke.name||""),ie.writeVarintField(5,Ke.extent||4096);var Te={keys:[],values:[],keycache:{},valuecache:{}};for(he=0;he<Ke.length;he++)Te.feature=Ke.feature(he),ie.writeMessage(2,Gr,Te);var Xe=Te.keys;for(he=0;he<Xe.length;he++)ie.writeStringField(3,Xe[he]);var Je=Te.values;for(he=0;he<Je.length;he++)ie.writeMessage(4,Vn,Je[he])}function Gr(Ke,ie){var he=Ke.feature;he.id!==void 0&&ie.writeVarintField(1,he.id),ie.writeMessage(2,Tr,Ke),ie.writeVarintField(3,he.type),ie.writeMessage(4,$r,he)}function Tr(Ke,ie){var he=Ke.feature,Te=Ke.keys,Xe=Ke.values,Je=Ke.keycache,lt=Ke.valuecache;for(var It in he.properties){var Se=he.properties[It],ot=Je[It];if(Se!==null){ot===void 0&&(Te.push(It),Je[It]=ot=Te.length-1),ie.writeVarint(ot);var xt=typeof Se;xt!=="string"&&xt!=="boolean"&&xt!=="number"&&(Se=JSON.stringify(Se));var $t=xt+":"+Se,pi=lt[$t];pi===void 0&&(Xe.push(Se),lt[$t]=pi=Xe.length-1),ie.writeVarint(pi)}}}function Ar(Ke,ie){return(ie<<3)+(7&Ke)}function kr(Ke){return Ke<<1^Ke>>31}function $r(Ke,ie){for(var he=Ke.loadGeometry(),Te=Ke.type,Xe=0,Je=0,lt=he.length,It=0;It<lt;It++){var Se=he[It],ot=1;Te===1&&(ot=Se.length),ie.writeVarint(Ar(1,ot));for(var xt=Te===3?Se.length-1:Se.length,$t=0;$t<xt;$t++){$t===1&&Te!==1&&ie.writeVarint(Ar(2,xt-1));var pi=Se[$t].x-Xe,Wi=Se[$t].y-Je;ie.writeVarint(kr(pi)),ie.writeVarint(kr(Wi)),Xe+=pi,Je+=Wi}Te===3&&ie.writeVarint(Ar(7,1))}}function Vn(Ke,ie){var he=typeof Ke;he==="string"?ie.writeStringField(1,Ke):he==="boolean"?ie.writeBooleanField(7,Ke):he==="number"&&(Ke%1!=0?ie.writeDoubleField(3,Ke):Ke<0?ie.writeSVarintField(6,Ke):ie.writeVarintField(5,Ke))}it.exports=ri,it.exports.fromVectorTileJs=ri,it.exports.fromGeojsonVt=function(Ke,ie){ie=ie||{};var he={};for(var Te in Ke)he[Te]=new Yi(Ke[Te].features,ie),he[Te].name=Te,he[Te].version=ie.version,he[Te].extent=ie.extent;return ri({layers:he})},it.exports.GeoJSONWrapper=Yi;var Pn=l.dK(it.exports);const Si={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Ke=>Ke},Ir=Math.fround||(Er=new Float32Array(1),Ke=>(Er[0]=+Ke,Er[0]));var Er;const Ki=3,In=5,gn=6;class Kn{constructor(ie){this.options=Object.assign(Object.create(Si),ie),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(ie){const{log:he,minZoom:Te,maxZoom:Xe}=this.options;he&&console.time("total time");const Je=`prepare ${ie.length} points`;he&&console.time(Je),this.points=ie;const lt=[];for(let Se=0;Se<ie.length;Se++){const ot=ie[Se];if(!ot.geometry)continue;const[xt,$t]=ot.geometry.coordinates,pi=Ir(Dr(xt)),Wi=Ir(yn($t));lt.push(pi,Wi,1/0,Se,-1,1),this.options.reduce&&lt.push(0)}let It=this.trees[Xe+1]=this._createTree(lt);he&&console.timeEnd(Je);for(let Se=Xe;Se>=Te;Se--){const ot=+Date.now();It=this.trees[Se]=this._createTree(this._cluster(It,Se)),he&&console.log("z%d: %d clusters in %dms",Se,It.numItems,+Date.now()-ot)}return he&&console.timeEnd("total time"),this}getClusters(ie,he){let Te=((ie[0]+180)%360+360)%360-180;const Xe=Math.max(-90,Math.min(90,ie[1]));let Je=ie[2]===180?180:((ie[2]+180)%360+360)%360-180;const lt=Math.max(-90,Math.min(90,ie[3]));if(ie[2]-ie[0]>=360)Te=-180,Je=180;else if(Te>Je){const $t=this.getClusters([Te,Xe,180,lt],he),pi=this.getClusters([-180,Xe,Je,lt],he);return $t.concat(pi)}const It=this.trees[this._limitZoom(he)],Se=It.range(Dr(Te),yn(lt),Dr(Je),yn(Xe)),ot=It.data,xt=[];for(const $t of Se){const pi=this.stride*$t;xt.push(ot[pi+In]>1?mr(ot,pi,this.clusterProps):this.points[ot[pi+Ki]])}return xt}getChildren(ie){const he=this._getOriginId(ie),Te=this._getOriginZoom(ie),Xe="No cluster with the specified id.",Je=this.trees[Te];if(!Je)throw new Error(Xe);const lt=Je.data;if(he*this.stride>=lt.length)throw new Error(Xe);const It=this.options.radius/(this.options.extent*Math.pow(2,Te-1)),Se=Je.within(lt[he*this.stride],lt[he*this.stride+1],It),ot=[];for(const xt of Se){const $t=xt*this.stride;lt[$t+4]===ie&&ot.push(lt[$t+In]>1?mr(lt,$t,this.clusterProps):this.points[lt[$t+Ki]])}if(ot.length===0)throw new Error(Xe);return ot}getLeaves(ie,he,Te){const Xe=[];return this._appendLeaves(Xe,ie,he=he||10,Te=Te||0,0),Xe}getTile(ie,he,Te){const Xe=this.trees[this._limitZoom(ie)],Je=Math.pow(2,ie),{extent:lt,radius:It}=this.options,Se=It/lt,ot=(Te-Se)/Je,xt=(Te+1+Se)/Je,$t={features:[]};return this._addTileFeatures(Xe.range((he-Se)/Je,ot,(he+1+Se)/Je,xt),Xe.data,he,Te,Je,$t),he===0&&this._addTileFeatures(Xe.range(1-Se/Je,ot,1,xt),Xe.data,Je,Te,Je,$t),he===Je-1&&this._addTileFeatures(Xe.range(0,ot,Se/Je,xt),Xe.data,-1,Te,Je,$t),$t.features.length?$t:null}getClusterExpansionZoom(ie){let he=this._getOriginZoom(ie)-1;for(;he<=this.options.maxZoom;){const Te=this.getChildren(ie);if(he++,Te.length!==1)break;ie=Te[0].properties.cluster_id}return he}_appendLeaves(ie,he,Te,Xe,Je){const lt=this.getChildren(he);for(const It of lt){const Se=It.properties;if(Se&&Se.cluster?Je+Se.point_count<=Xe?Je+=Se.point_count:Je=this._appendLeaves(ie,Se.cluster_id,Te,Xe,Je):Je<Xe?Je++:ie.push(It),ie.length===Te)break}return Je}_createTree(ie){const he=new l.bg(ie.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Te=0;Te<ie.length;Te+=this.stride)he.add(ie[Te],ie[Te+1]);return he.finish(),he.data=ie,he}_addTileFeatures(ie,he,Te,Xe,Je,lt){for(const It of ie){const Se=It*this.stride,ot=he[Se+In]>1;let xt,$t,pi;if(ot)xt=cn(he,Se,this.clusterProps),$t=he[Se],pi=he[Se+1];else{const Hi=this.points[he[Se+Ki]];xt=Hi.properties;const[Ci,zi]=Hi.geometry.coordinates;$t=Dr(Ci),pi=yn(zi)}const Wi={type:1,geometry:[[Math.round(this.options.extent*($t*Je-Te)),Math.round(this.options.extent*(pi*Je-Xe))]],tags:xt};let xr;xr=ot||this.options.generateId?he[Se+Ki]:this.points[he[Se+Ki]].id,xr!==void 0&&(Wi.id=xr),lt.features.push(Wi)}}_limitZoom(ie){return Math.max(this.options.minZoom,Math.min(Math.floor(+ie),this.options.maxZoom+1))}_cluster(ie,he){const{radius:Te,extent:Xe,reduce:Je,minPoints:lt}=this.options,It=Te/(Xe*Math.pow(2,he)),Se=ie.data,ot=[],xt=this.stride;for(let $t=0;$t<Se.length;$t+=xt){if(Se[$t+2]<=he)continue;Se[$t+2]=he;const pi=Se[$t],Wi=Se[$t+1],xr=ie.within(Se[$t],Se[$t+1],It),Hi=Se[$t+In];let Ci=Hi;for(const zi of xr){const er=zi*xt;Se[er+2]>he&&(Ci+=Se[er+In])}if(Ci>Hi&&Ci>=lt){let zi,er=pi*Hi,Rr=Wi*Hi,nn=-1;const br=($t/xt<<5)+(he+1)+this.points.length;for(const Ln of xr){const rs=Ln*xt;if(Se[rs+2]<=he)continue;Se[rs+2]=he;const ns=Se[rs+In];er+=Se[rs]*ns,Rr+=Se[rs+1]*ns,Se[rs+4]=br,Je&&(zi||(zi=this._map(Se,$t,!0),nn=this.clusterProps.length,this.clusterProps.push(zi)),Je(zi,this._map(Se,rs)))}Se[$t+4]=br,ot.push(er/Ci,Rr/Ci,1/0,br,-1,Ci),Je&&ot.push(nn)}else{for(let zi=0;zi<xt;zi++)ot.push(Se[$t+zi]);if(Ci>1)for(const zi of xr){const er=zi*xt;if(!(Se[er+2]<=he)){Se[er+2]=he;for(let Rr=0;Rr<xt;Rr++)ot.push(Se[er+Rr])}}}}return ot}_getOriginId(ie){return ie-this.points.length>>5}_getOriginZoom(ie){return(ie-this.points.length)%32}_map(ie,he,Te){if(ie[he+In]>1){const lt=this.clusterProps[ie[he+gn]];return Te?Object.assign({},lt):lt}const Xe=this.points[ie[he+Ki]].properties,Je=this.options.map(Xe);return Te&&Je===Xe?Object.assign({},Je):Je}}function mr(Ke,ie,he){return{type:"Feature",id:Ke[ie+Ki],properties:cn(Ke,ie,he),geometry:{type:"Point",coordinates:[(Te=Ke[ie],360*(Te-.5)),Rn(Ke[ie+1])]}};var Te}function cn(Ke,ie,he){const Te=Ke[ie+In],Xe=Te>=1e4?`${Math.round(Te/1e3)}k`:Te>=1e3?Math.round(Te/100)/10+"k":Te,Je=Ke[ie+gn],lt=Je===-1?{}:Object.assign({},he[Je]);return Object.assign(lt,{cluster:!0,cluster_id:Ke[ie+Ki],point_count:Te,point_count_abbreviated:Xe})}function Dr(Ke){return Ke/360+.5}function yn(Ke){const ie=Math.sin(Ke*Math.PI/180),he=.5-.25*Math.log((1+ie)/(1-ie))/Math.PI;return he<0?0:he>1?1:he}function Rn(Ke){const ie=(180-360*Ke)*Math.PI/180;return 360*Math.atan(Math.exp(ie))/Math.PI-90}var ir={exports:{}};ir.exports=function(){function Ke(et,nt,yt,St){for(var wt,Dt=St,kt=yt-nt>>1,vt=yt-nt,Ft=et[nt],At=et[nt+1],ui=et[yt],bi=et[yt+1],Gt=nt+3;Gt<yt;Gt+=3){var hr=ie(et[Gt],et[Gt+1],Ft,At,ui,bi);if(hr>Dt)wt=Gt,Dt=hr;else if(hr===Dt){var Lr=Math.abs(Gt-kt);Lr<vt&&(wt=Gt,vt=Lr)}}Dt>St&&(wt-nt>3&&Ke(et,nt,wt,St),et[wt+2]=Dt,yt-wt>3&&Ke(et,wt,yt,St))}function ie(et,nt,yt,St,wt,Dt){var kt=wt-yt,vt=Dt-St;if(kt!==0||vt!==0){var Ft=((et-yt)*kt+(nt-St)*vt)/(kt*kt+vt*vt);Ft>1?(yt=wt,St=Dt):Ft>0&&(yt+=kt*Ft,St+=vt*Ft)}return(kt=et-yt)*kt+(vt=nt-St)*vt}function he(et,nt,yt,St){var wt={id:et===void 0?null:et,type:nt,geometry:yt,tags:St,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(Dt){var kt=Dt.geometry,vt=Dt.type;if(vt==="Point"||vt==="MultiPoint"||vt==="LineString")Te(Dt,kt);else if(vt==="Polygon"||vt==="MultiLineString")for(var Ft=0;Ft<kt.length;Ft++)Te(Dt,kt[Ft]);else if(vt==="MultiPolygon")for(Ft=0;Ft<kt.length;Ft++)for(var At=0;At<kt[Ft].length;At++)Te(Dt,kt[Ft][At])}(wt),wt}function Te(et,nt){for(var yt=0;yt<nt.length;yt+=3)et.minX=Math.min(et.minX,nt[yt]),et.minY=Math.min(et.minY,nt[yt+1]),et.maxX=Math.max(et.maxX,nt[yt]),et.maxY=Math.max(et.maxY,nt[yt+1])}function Xe(et,nt,yt,St){if(nt.geometry){var wt=nt.geometry.coordinates,Dt=nt.geometry.type,kt=Math.pow(yt.tolerance/((1<<yt.maxZoom)*yt.extent),2),vt=[],Ft=nt.id;if(yt.promoteId?Ft=nt.properties[yt.promoteId]:yt.generateId&&(Ft=St||0),Dt==="Point")Je(wt,vt);else if(Dt==="MultiPoint")for(var At=0;At<wt.length;At++)Je(wt[At],vt);else if(Dt==="LineString")lt(wt,vt,kt,!1);else if(Dt==="MultiLineString"){if(yt.lineMetrics){for(At=0;At<wt.length;At++)lt(wt[At],vt=[],kt,!1),et.push(he(Ft,"LineString",vt,nt.properties));return}It(wt,vt,kt,!1)}else if(Dt==="Polygon")It(wt,vt,kt,!0);else{if(Dt!=="MultiPolygon"){if(Dt==="GeometryCollection"){for(At=0;At<nt.geometry.geometries.length;At++)Xe(et,{id:Ft,geometry:nt.geometry.geometries[At],properties:nt.properties},yt,St);return}throw new Error("Input data is not a valid GeoJSON object.")}for(At=0;At<wt.length;At++){var ui=[];It(wt[At],ui,kt,!0),vt.push(ui)}}et.push(he(Ft,Dt,vt,nt.properties))}}function Je(et,nt){nt.push(Se(et[0])),nt.push(ot(et[1])),nt.push(0)}function lt(et,nt,yt,St){for(var wt,Dt,kt=0,vt=0;vt<et.length;vt++){var Ft=Se(et[vt][0]),At=ot(et[vt][1]);nt.push(Ft),nt.push(At),nt.push(0),vt>0&&(kt+=St?(wt*At-Ft*Dt)/2:Math.sqrt(Math.pow(Ft-wt,2)+Math.pow(At-Dt,2))),wt=Ft,Dt=At}var ui=nt.length-3;nt[2]=1,Ke(nt,0,ui,yt),nt[ui+2]=1,nt.size=Math.abs(kt),nt.start=0,nt.end=nt.size}function It(et,nt,yt,St){for(var wt=0;wt<et.length;wt++){var Dt=[];lt(et[wt],Dt,yt,St),nt.push(Dt)}}function Se(et){return et/360+.5}function ot(et){var nt=Math.sin(et*Math.PI/180),yt=.5-.25*Math.log((1+nt)/(1-nt))/Math.PI;return yt<0?0:yt>1?1:yt}function xt(et,nt,yt,St,wt,Dt,kt,vt){if(St/=nt,Dt>=(yt/=nt)&&kt<St)return et;if(kt<yt||Dt>=St)return null;for(var Ft=[],At=0;At<et.length;At++){var ui=et[At],bi=ui.geometry,Gt=ui.type,hr=wt===0?ui.minX:ui.minY,Lr=wt===0?ui.maxX:ui.maxY;if(hr>=yt&&Lr<St)Ft.push(ui);else if(!(Lr<yt||hr>=St)){var Pr=[];if(Gt==="Point"||Gt==="MultiPoint")$t(bi,Pr,yt,St,wt);else if(Gt==="LineString")pi(bi,Pr,yt,St,wt,!1,vt.lineMetrics);else if(Gt==="MultiLineString")xr(bi,Pr,yt,St,wt,!1);else if(Gt==="Polygon")xr(bi,Pr,yt,St,wt,!0);else if(Gt==="MultiPolygon")for(var bn=0;bn<bi.length;bn++){var jn=[];xr(bi[bn],jn,yt,St,wt,!0),jn.length&&Pr.push(jn)}if(Pr.length){if(vt.lineMetrics&&Gt==="LineString"){for(bn=0;bn<Pr.length;bn++)Ft.push(he(ui.id,Gt,Pr[bn],ui.tags));continue}Gt!=="LineString"&&Gt!=="MultiLineString"||(Pr.length===1?(Gt="LineString",Pr=Pr[0]):Gt="MultiLineString"),Gt!=="Point"&&Gt!=="MultiPoint"||(Gt=Pr.length===3?"Point":"MultiPoint"),Ft.push(he(ui.id,Gt,Pr,ui.tags))}}}return Ft.length?Ft:null}function $t(et,nt,yt,St,wt){for(var Dt=0;Dt<et.length;Dt+=3){var kt=et[Dt+wt];kt>=yt&&kt<=St&&(nt.push(et[Dt]),nt.push(et[Dt+1]),nt.push(et[Dt+2]))}}function pi(et,nt,yt,St,wt,Dt,kt){for(var vt,Ft,At=Wi(et),ui=wt===0?Ci:zi,bi=et.start,Gt=0;Gt<et.length-3;Gt+=3){var hr=et[Gt],Lr=et[Gt+1],Pr=et[Gt+2],bn=et[Gt+3],jn=et[Gt+4],qi=wt===0?hr:Lr,hn=wt===0?bn:jn,ss=!1;kt&&(vt=Math.sqrt(Math.pow(hr-bn,2)+Math.pow(Lr-jn,2))),qi<yt?hn>yt&&(Ft=ui(At,hr,Lr,bn,jn,yt),kt&&(At.start=bi+vt*Ft)):qi>St?hn<St&&(Ft=ui(At,hr,Lr,bn,jn,St),kt&&(At.start=bi+vt*Ft)):Hi(At,hr,Lr,Pr),hn<yt&&qi>=yt&&(Ft=ui(At,hr,Lr,bn,jn,yt),ss=!0),hn>St&&qi<=St&&(Ft=ui(At,hr,Lr,bn,jn,St),ss=!0),!Dt&&ss&&(kt&&(At.end=bi+vt*Ft),nt.push(At),At=Wi(et)),kt&&(bi+=vt)}var sn=et.length-3;hr=et[sn],Lr=et[sn+1],Pr=et[sn+2],(qi=wt===0?hr:Lr)>=yt&&qi<=St&&Hi(At,hr,Lr,Pr),sn=At.length-3,Dt&&sn>=3&&(At[sn]!==At[0]||At[sn+1]!==At[1])&&Hi(At,At[0],At[1],At[2]),At.length&&nt.push(At)}function Wi(et){var nt=[];return nt.size=et.size,nt.start=et.start,nt.end=et.end,nt}function xr(et,nt,yt,St,wt,Dt){for(var kt=0;kt<et.length;kt++)pi(et[kt],nt,yt,St,wt,Dt,!1)}function Hi(et,nt,yt,St){et.push(nt),et.push(yt),et.push(St)}function Ci(et,nt,yt,St,wt,Dt){var kt=(Dt-nt)/(St-nt);return et.push(Dt),et.push(yt+(wt-yt)*kt),et.push(1),kt}function zi(et,nt,yt,St,wt,Dt){var kt=(Dt-yt)/(wt-yt);return et.push(nt+(St-nt)*kt),et.push(Dt),et.push(1),kt}function er(et,nt){for(var yt=[],St=0;St<et.length;St++){var wt,Dt=et[St],kt=Dt.type;if(kt==="Point"||kt==="MultiPoint"||kt==="LineString")wt=Rr(Dt.geometry,nt);else if(kt==="MultiLineString"||kt==="Polygon"){wt=[];for(var vt=0;vt<Dt.geometry.length;vt++)wt.push(Rr(Dt.geometry[vt],nt))}else if(kt==="MultiPolygon")for(wt=[],vt=0;vt<Dt.geometry.length;vt++){for(var Ft=[],At=0;At<Dt.geometry[vt].length;At++)Ft.push(Rr(Dt.geometry[vt][At],nt));wt.push(Ft)}yt.push(he(Dt.id,kt,wt,Dt.tags))}return yt}function Rr(et,nt){var yt=[];yt.size=et.size,et.start!==void 0&&(yt.start=et.start,yt.end=et.end);for(var St=0;St<et.length;St+=3)yt.push(et[St]+nt,et[St+1],et[St+2]);return yt}function nn(et,nt){if(et.transformed)return et;var yt,St,wt,Dt=1<<et.z,kt=et.x,vt=et.y;for(yt=0;yt<et.features.length;yt++){var Ft=et.features[yt],At=Ft.geometry,ui=Ft.type;if(Ft.geometry=[],ui===1)for(St=0;St<At.length;St+=2)Ft.geometry.push(br(At[St],At[St+1],nt,Dt,kt,vt));else for(St=0;St<At.length;St++){var bi=[];for(wt=0;wt<At[St].length;wt+=2)bi.push(br(At[St][wt],At[St][wt+1],nt,Dt,kt,vt));Ft.geometry.push(bi)}}return et.transformed=!0,et}function br(et,nt,yt,St,wt,Dt){return[Math.round(yt*(et*St-wt)),Math.round(yt*(nt*St-Dt))]}function Ln(et,nt,yt,St,wt){for(var Dt=nt===wt.maxZoom?0:wt.tolerance/((1<<nt)*wt.extent),kt={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:yt,y:St,z:nt,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},vt=0;vt<et.length;vt++){kt.numFeatures++,rs(kt,et[vt],Dt,wt);var Ft=et[vt].minX,At=et[vt].minY,ui=et[vt].maxX,bi=et[vt].maxY;Ft<kt.minX&&(kt.minX=Ft),At<kt.minY&&(kt.minY=At),ui>kt.maxX&&(kt.maxX=ui),bi>kt.maxY&&(kt.maxY=bi)}return kt}function rs(et,nt,yt,St){var wt=nt.geometry,Dt=nt.type,kt=[];if(Dt==="Point"||Dt==="MultiPoint")for(var vt=0;vt<wt.length;vt+=3)kt.push(wt[vt]),kt.push(wt[vt+1]),et.numPoints++,et.numSimplified++;else if(Dt==="LineString")ns(kt,wt,et,yt,!1,!1);else if(Dt==="MultiLineString"||Dt==="Polygon")for(vt=0;vt<wt.length;vt++)ns(kt,wt[vt],et,yt,Dt==="Polygon",vt===0);else if(Dt==="MultiPolygon")for(var Ft=0;Ft<wt.length;Ft++){var At=wt[Ft];for(vt=0;vt<At.length;vt++)ns(kt,At[vt],et,yt,!0,vt===0)}if(kt.length){var ui=nt.tags||null;if(Dt==="LineString"&&St.lineMetrics){for(var bi in ui={},nt.tags)ui[bi]=nt.tags[bi];ui.mapbox_clip_start=wt.start/wt.size,ui.mapbox_clip_end=wt.end/wt.size}var Gt={geometry:kt,type:Dt==="Polygon"||Dt==="MultiPolygon"?3:Dt==="LineString"||Dt==="MultiLineString"?2:1,tags:ui};nt.id!==null&&(Gt.id=nt.id),et.features.push(Gt)}}function ns(et,nt,yt,St,wt,Dt){var kt=St*St;if(St>0&&nt.size<(wt?kt:St))yt.numPoints+=nt.length/3;else{for(var vt=[],Ft=0;Ft<nt.length;Ft+=3)(St===0||nt[Ft+2]>kt)&&(yt.numSimplified++,vt.push(nt[Ft]),vt.push(nt[Ft+1])),yt.numPoints++;wt&&function(At,ui){for(var bi=0,Gt=0,hr=At.length,Lr=hr-2;Gt<hr;Lr=Gt,Gt+=2)bi+=(At[Gt]-At[Lr])*(At[Gt+1]+At[Lr+1]);if(bi>0===ui)for(Gt=0,hr=At.length;Gt<hr/2;Gt+=2){var Pr=At[Gt],bn=At[Gt+1];At[Gt]=At[hr-2-Gt],At[Gt+1]=At[hr-1-Gt],At[hr-2-Gt]=Pr,At[hr-1-Gt]=bn}}(vt,Dt),et.push(vt)}}function Yr(et,nt){var yt=(nt=this.options=function(wt,Dt){for(var kt in Dt)wt[kt]=Dt[kt];return wt}(Object.create(this.options),nt)).debug;if(yt&&console.time("preprocess data"),nt.maxZoom<0||nt.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(nt.promoteId&&nt.generateId)throw new Error("promoteId and generateId cannot be used together.");var St=function(wt,Dt){var kt=[];if(wt.type==="FeatureCollection")for(var vt=0;vt<wt.features.length;vt++)Xe(kt,wt.features[vt],Dt,vt);else Xe(kt,wt.type==="Feature"?wt:{geometry:wt},Dt);return kt}(et,nt);this.tiles={},this.tileCoords=[],yt&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",nt.indexMaxZoom,nt.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(St=function(wt,Dt){var kt=Dt.buffer/Dt.extent,vt=wt,Ft=xt(wt,1,-1-kt,kt,0,-1,2,Dt),At=xt(wt,1,1-kt,2+kt,0,-1,2,Dt);return(Ft||At)&&(vt=xt(wt,1,-kt,1+kt,0,-1,2,Dt)||[],Ft&&(vt=er(Ft,1).concat(vt)),At&&(vt=vt.concat(er(At,-1)))),vt}(St,nt)).length&&this.splitTile(St,0,0,0),yt&&(St.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function un(et,nt,yt){return 32*((1<<et)*yt+nt)+et}return Yr.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},Yr.prototype.splitTile=function(et,nt,yt,St,wt,Dt,kt){for(var vt=[et,nt,yt,St],Ft=this.options,At=Ft.debug;vt.length;){St=vt.pop(),yt=vt.pop(),nt=vt.pop(),et=vt.pop();var ui=1<<nt,bi=un(nt,yt,St),Gt=this.tiles[bi];if(!Gt&&(At>1&&console.time("creation"),Gt=this.tiles[bi]=Ln(et,nt,yt,St,Ft),this.tileCoords.push({z:nt,x:yt,y:St}),At)){At>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",nt,yt,St,Gt.numFeatures,Gt.numPoints,Gt.numSimplified),console.timeEnd("creation"));var hr="z"+nt;this.stats[hr]=(this.stats[hr]||0)+1,this.total++}if(Gt.source=et,wt){if(nt===Ft.maxZoom||nt===wt)continue;var Lr=1<<wt-nt;if(yt!==Math.floor(Dt/Lr)||St!==Math.floor(kt/Lr))continue}else if(nt===Ft.indexMaxZoom||Gt.numPoints<=Ft.indexMaxPoints)continue;if(Gt.source=null,et.length!==0){At>1&&console.time("clipping");var Pr,bn,jn,qi,hn,ss,sn=.5*Ft.buffer/Ft.extent,ws=.5-sn,As=.5+sn,hs=1+sn;Pr=bn=jn=qi=null,hn=xt(et,ui,yt-sn,yt+As,0,Gt.minX,Gt.maxX,Ft),ss=xt(et,ui,yt+ws,yt+hs,0,Gt.minX,Gt.maxX,Ft),et=null,hn&&(Pr=xt(hn,ui,St-sn,St+As,1,Gt.minY,Gt.maxY,Ft),bn=xt(hn,ui,St+ws,St+hs,1,Gt.minY,Gt.maxY,Ft),hn=null),ss&&(jn=xt(ss,ui,St-sn,St+As,1,Gt.minY,Gt.maxY,Ft),qi=xt(ss,ui,St+ws,St+hs,1,Gt.minY,Gt.maxY,Ft),ss=null),At>1&&console.timeEnd("clipping"),vt.push(Pr||[],nt+1,2*yt,2*St),vt.push(bn||[],nt+1,2*yt,2*St+1),vt.push(jn||[],nt+1,2*yt+1,2*St),vt.push(qi||[],nt+1,2*yt+1,2*St+1)}}},Yr.prototype.getTile=function(et,nt,yt){var St=this.options,wt=St.extent,Dt=St.debug;if(et<0||et>24)return null;var kt=1<<et,vt=un(et,nt=(nt%kt+kt)%kt,yt);if(this.tiles[vt])return nn(this.tiles[vt],wt);Dt>1&&console.log("drilling down to z%d-%d-%d",et,nt,yt);for(var Ft,At=et,ui=nt,bi=yt;!Ft&&At>0;)At--,ui=Math.floor(ui/2),bi=Math.floor(bi/2),Ft=this.tiles[un(At,ui,bi)];return Ft&&Ft.source?(Dt>1&&console.log("found parent tile z%d-%d-%d",At,ui,bi),Dt>1&&console.time("drilling down"),this.splitTile(Ft.source,At,ui,bi,et,nt,yt),Dt>1&&console.timeEnd("drilling down"),this.tiles[vt]?nn(this.tiles[vt],wt):null):null},function(et,nt){return new Yr(et,nt)}}();var Ni=l.dK(ir.exports);function _r(Ke,ie){const he=Ke.tileID.canonical;if(!this._geoJSONIndex)return ie(null,null);const Te=this._geoJSONIndex.getTile(he.z,he.x,he.y);if(!Te)return ie(null,null);const Xe=new xe(Te.features);let Je=Pn(Xe);Je.byteOffset===0&&Je.byteLength===Je.buffer.byteLength||(Je=new Uint8Array(Je)),ie(null,{vectorTile:Xe,rawData:Je.buffer})}class Ur extends oe{constructor(ie,he,Te,Xe,Je,lt){super(ie,he,Te,Xe,_r,lt),Je&&(this.loadGeoJSON=Je)}loadData(ie,he){const Te=ie&&ie.request,Xe=Te&&Te.collectResourceTiming;this.loadGeoJSON(ie,(Je,lt)=>{if(Je||!lt)return he(Je);if(typeof lt!="object")return he(new Error(`Input data given to '${ie.source}' is not a valid GeoJSON object.`));{je(lt,!0);try{if(ie.filter){const Se=l.r(ie.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Se.result==="error")throw new Error(Se.value.map(xt=>`${xt.key}: ${xt.message}`).join(", "));lt={type:"FeatureCollection",features:lt.features.filter(xt=>Se.value.evaluate({zoom:0},xt))}}this._geoJSONIndex=ie.cluster?new Kn(function({superclusterOptions:Se,clusterProperties:ot}){if(!ot||!Se)return Se;const xt={},$t={},pi={accumulated:null,zoom:0},Wi={properties:null},xr=Object.keys(ot);for(const Hi of xr){const[Ci,zi]=ot[Hi],er=l.r(zi),Rr=l.r(typeof Ci=="string"?[Ci,["accumulated"],["get",Hi]]:Ci);xt[Hi]=er.value,$t[Hi]=Rr.value}return Se.map=Hi=>{Wi.properties=Hi;const Ci={};for(const zi of xr)Ci[zi]=xt[zi].evaluate(pi,Wi);return Ci},Se.reduce=(Hi,Ci)=>{Wi.properties=Ci;for(const zi of xr)pi.accumulated=Hi[zi],Hi[zi]=$t[zi].evaluate(pi,Wi)},Se}(ie)).load(lt.features):Ni(lt,ie.geojsonVtOptions)}catch(Se){return he(Se)}this.loaded={};const It={};if(Xe){const Se=A(Te);Se&&(It.resourceTiming={},It.resourceTiming[ie.source]=JSON.parse(JSON.stringify(Se)))}he(null,It)}})}reloadTile(ie,he){const Te=this.loaded;return Te&&Te[ie.uid]?super.reloadTile(ie,he):this.loadTile(ie,he)}loadGeoJSON(ie,he){if(ie.request)l.g(ie.request,he);else{if(typeof ie.data!="string")return he(new Error(`Input data given to '${ie.source}' is not a valid GeoJSON object.`));try{return he(null,JSON.parse(ie.data))}catch{return he(new Error(`Input data given to '${ie.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(ie,he){try{he(null,this._geoJSONIndex.getClusterExpansionZoom(ie.clusterId))}catch(Te){he(Te)}}getClusterChildren(ie,he){try{he(null,this._geoJSONIndex.getChildren(ie.clusterId))}catch(Te){he(Te)}}getClusterLeaves(ie,he){try{he(null,this._geoJSONIndex.getLeaves(ie.clusterId,ie.limit,ie.offset))}catch(Te){he(Te)}}}class Cr{constructor(ie,he){this.tileID=new l.am(ie.tileID.overscaledZ,ie.tileID.wrap,ie.tileID.canonical.z,ie.tileID.canonical.x,ie.tileID.canonical.y),this.tileZoom=ie.tileZoom,this.uid=ie.uid,this.zoom=ie.zoom,this.canonical=ie.tileID.canonical,this.pixelRatio=ie.pixelRatio,this.tileSize=ie.tileSize,this.source=ie.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=ie.projection,this.brightness=he}parse(ie,he,Te,Xe){this.status="parsing";const Je=new l.am(Te.tileID.overscaledZ,Te.tileID.wrap,Te.tileID.canonical.z,Te.tileID.canonical.x,Te.tileID.canonical.y),lt={},It=he.familiesBySource[Te.source],Se=new l.dC(Je,Te.promoteId);return Se.bucketLayerIDs=[],Se.is3DTile=!0,l.dP(ie).then(ot=>{if(!ot)return Xe(new Error("Could not parse tile"));const xt=l.dQ(ot,1/l.bR(Te.tileID.canonical)),$t=ot.json.extensionsUsed&&ot.json.extensionsUsed.includes("MAPBOX_mesh_features")||ot.json.asset.extras&&ot.json.asset.extras.MAPBOX_mesh_features,pi=ot.json.extensionsUsed&&ot.json.extensionsUsed.includes("EXT_meshopt_compression"),Wi=new l.K(this.zoom,{brightness:this.brightness});for(const xr in It)for(const Hi of It[xr]){const Ci=Hi[0];Se.bucketLayerIDs.push(Hi.map(er=>er.id)),Ci.recalculate(Wi,[]);const zi=new l.dR(xt,Je,$t,pi,this.brightness,Se);$t||(zi.needsUpload=!0),lt[Ci.fqid]=zi,zi.evaluate(Ci)}this.status="done",Xe(null,{buckets:lt,featureIndex:Se})}).catch(ot=>Xe(new Error(ot.message)))}}class Oi{constructor(ie,he,Te,Xe,Je,lt){this.actor=ie,this.layerIndex=he,this.brightness=lt,this.loading={},this.loaded={}}loadTile(ie,he){const Te=ie.uid,Xe=this.loading[Te]=new Cr(ie,this.brightness);l.a_(ie.request,(Je,lt)=>{const It=!this.loading[Te];return delete this.loading[Te],It||Je?(Xe.status="done",It||(this.loaded[Te]=Xe),he(Je)):lt&&lt.byteLength!==0?void Xe.parse(lt,this.layerIndex,ie,(Se,ot)=>{Xe.status="done",this.loaded=this.loaded||{},this.loaded[Te]=Xe,Se||!ot?he(Se):he(null,ot)}):(Xe.status="done",this.loaded[Te]=Xe,he())})}reloadTile(ie,he){const Te=this.loaded,Xe=ie.uid;if(Te&&Te[Xe]){const Je=Te[Xe];Je.projection=ie.projection,Je.brightness=ie.brightness;const lt=(It,Se)=>{Je.reloadCallback&&(delete Je.reloadCallback,this.loadTile(ie,he)),he(It,Se)};Je.status==="parsing"?Je.reloadCallback=lt:Je.status==="done"&&this.loadTile(ie,he)}}abortTile(ie,he){const Te=ie.uid;this.loading[Te]&&delete this.loading[Te],he()}removeTile(ie,he){const Te=this.loaded,Xe=ie.uid;Te&&Te[Xe]&&delete Te[Xe],he()}}class Nr{constructor(ie){this.self=ie,this.actor=new l.dS(ie,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=l.bo({name:"mercator"}),this.workerSourceTypes={vector:oe,geojson:Ur,"batched-model":Oi},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(he,Te)=>{if(this.workerSourceTypes[he])throw new Error(`Worker source with name "${he}" already registered.`);this.workerSourceTypes[he]=Te},this.self.registerRTLTextPlugin=he=>{if(l.dT.isParsed())throw new Error("RTL text plugin already registered.");l.dT.applyArabicShaping=he.applyArabicShaping,l.dT.processBidirectionalText=he.processBidirectionalText,l.dT.processStyledBidirectionalText=he.processStyledBidirectionalText}}clearCaches(ie,he,Te){delete this.layerIndexes[ie],delete this.availableImages[ie],delete this.workerSources[ie],delete this.demWorkerSources[ie],delete this.rasterArrayWorkerSource,Te()}checkIfReady(ie,he,Te){Te()}setReferrer(ie,he){this.referrer=he}spriteLoaded(ie,{scope:he,isLoaded:Te}){if(this.isSpriteLoaded[ie]||(this.isSpriteLoaded[ie]={}),this.isSpriteLoaded[ie][he]=Te,this.workerSources[ie]&&this.workerSources[ie][he])for(const Xe in this.workerSources[ie][he]){const Je=this.workerSources[ie][he][Xe];for(const lt in Je)Je[lt]instanceof oe&&(Je[lt].isSpriteLoaded=Te,Je[lt].fire(new l.b("isSpriteLoaded")))}}setImages(ie,{scope:he,images:Te},Xe){if(this.availableImages[ie]||(this.availableImages[ie]={}),this.availableImages[ie][he]=Te,this.workerSources[ie]&&this.workerSources[ie][he]){for(const Je in this.workerSources[ie][he]){const lt=this.workerSources[ie][he][Je];for(const It in lt)lt[It].availableImages=Te}Xe()}else Xe()}setProjection(ie,he){this.projections[ie]=l.bo(he)}setBrightness(ie,he,Te){this.brightness=he,Te()}setLayers(ie,he,Te){this.getLayerIndex(ie,he.scope).replace(he.layers,he.options),Te()}updateLayers(ie,he,Te){this.getLayerIndex(ie,he.scope).update(he.layers,he.removedIds,he.options),Te()}loadTile(ie,he,Te){he.projection=this.projections[ie]||this.defaultProjection,this.getWorkerSource(ie,he.type,he.source,he.scope).loadTile(he,Te)}loadDEMTile(ie,he,Te){this.getDEMWorkerSource(ie,he.source,he.scope).loadTile(he,Te)}decodeRasterArray(ie,he,Te){this.getRasterArrayWorkerSource().decodeRasterArray(he,Te)}reloadTile(ie,he,Te){he.projection=this.projections[ie]||this.defaultProjection,this.getWorkerSource(ie,he.type,he.source,he.scope).reloadTile(he,Te)}abortTile(ie,he,Te){this.getWorkerSource(ie,he.type,he.source,he.scope).abortTile(he,Te)}removeTile(ie,he,Te){this.getWorkerSource(ie,he.type,he.source,he.scope).removeTile(he,Te)}removeSource(ie,he,Te){if(!(this.workerSources[ie]&&this.workerSources[ie][he.scope]&&this.workerSources[ie][he.scope][he.type]&&this.workerSources[ie][he.scope][he.type][he.source]))return;const Xe=this.workerSources[ie][he.scope][he.type][he.source];delete this.workerSources[ie][he.scope][he.type][he.source],Xe.removeSource!==void 0?Xe.removeSource(he,Te):Te()}loadWorkerSource(ie,he,Te){try{this.self.importScripts(he.url),Te()}catch(Xe){Te(Xe.toString())}}syncRTLPluginState(ie,he,Te){try{l.dT.setState(he);const Xe=l.dT.getPluginURL();if(l.dT.isLoaded()&&!l.dT.isParsed()&&Xe!=null){this.self.importScripts(Xe);const Je=l.dT.isParsed();Te(Je?void 0:new Error(`RTL Text Plugin failed to import scripts from ${Xe}`),Je)}}catch(Xe){Te(Xe.toString())}}setDracoUrl(ie,he){this.dracoUrl=he}getAvailableImages(ie,he){this.availableImages[ie]||(this.availableImages[ie]={});let Te=this.availableImages[ie][he];return Te||(Te=[]),Te}getLayerIndex(ie,he){this.layerIndexes[ie]||(this.layerIndexes[ie]={});let Te=this.layerIndexes[ie][he];return Te||(Te=this.layerIndexes[ie][he]=new L,Te.scope=he),Te}getWorkerSource(ie,he,Te,Xe){if(this.workerSources[ie]||(this.workerSources[ie]={}),this.workerSources[ie][Xe]||(this.workerSources[ie][Xe]={}),this.workerSources[ie][Xe][he]||(this.workerSources[ie][Xe][he]={}),this.isSpriteLoaded[ie]||(this.isSpriteLoaded[ie]={}),!this.workerSources[ie][Xe][he][Te]){const Je={send:(lt,It,Se,ot,xt,$t)=>{this.actor.send(lt,It,Se,ie,xt,$t)},scheduler:this.actor.scheduler};this.workerSources[ie][Xe][he][Te]=new this.workerSourceTypes[he](Je,this.getLayerIndex(ie,Xe),this.getAvailableImages(ie,Xe),this.isSpriteLoaded[ie][Xe],void 0,this.brightness)}return this.workerSources[ie][Xe][he][Te]}getDEMWorkerSource(ie,he,Te){return this.demWorkerSources[ie]||(this.demWorkerSources[ie]={}),this.demWorkerSources[ie][Te]||(this.demWorkerSources[ie][Te]={}),this.demWorkerSources[ie][Te][he]||(this.demWorkerSources[ie][Te][he]=new me),this.demWorkerSources[ie][Te][he]}getRasterArrayWorkerSource(){return this.rasterArrayWorkerSource||(this.rasterArrayWorkerSource=new pe),this.rasterArrayWorkerSource}enforceCacheSizeLimit(ie,he){l.dU(he)}getWorkerPerformanceMetrics(ie,he,Te){Te(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new Nr(self)),Nr}),p(["./shared"],function(l){function A(_,a){if(Array.isArray(_)){if(!Array.isArray(a)||_.length!==a.length)return!1;for(let d=0;d<_.length;d++)if(!A(_[d],a[d]))return!1;return!0}if(typeof _=="object"&&_!==null&&a!==null){if(typeof a!="object"||Object.keys(_).length!==Object.keys(a).length)return!1;for(const d in _)if(!A(_[d],a[d]))return!1;return!0}return _===a}var P=O;function O(_){return!function(a){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var g,x,w=new Blob([""],{type:"text/javascript"}),S=URL.createObjectURL(w);try{x=new Worker(S),g=!0}catch{g=!1}return x&&x.terminate(),URL.revokeObjectURL(S),g}()?function(){var g=document.createElement("canvas");g.width=g.height=1;var x=g.getContext("2d");if(!x)return!1;var w=x.getImageData(0,0,1,1);return w&&w.width===g.width}()?(L[d=a&&a.failIfMajorPerformanceCaveat]===void 0&&(L[d]=function(g){var x,w=function(S){var C=document.createElement("canvas"),R=Object.create(O.webGLContextAttributes);return R.failIfMajorPerformanceCaveat=S,C.getContext("webgl2",R)}(g);if(!w)return!1;try{x=w.createShader(w.VERTEX_SHADER)}catch{return!1}return!(!x||w.isContextLost())&&(w.shaderSource(x,"void main() {}"),w.compileShader(x),w.getShaderParameter(x,w.COMPILE_STATUS)===!0)}(d)),L[d]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var d}(_)}var L={};function U(_,a,d){const g=document.createElement(_);return a!=null&&(g.className=a),d&&d.appendChild(g),g}function H(_,a,d){const g=document.createElementNS("http://www.w3.org/2000/svg",_);for(const x of Object.keys(a))g.setAttributeNS(null,x,String(a[x]));return d&&d.appendChild(g),g}O.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const Y=typeof document<"u"?document.documentElement&&document.documentElement.style:null,J=Y&&Y.userSelect!==void 0?"userSelect":"WebkitUserSelect";let oe;function me(){Y&&J&&(oe=Y[J],Y[J]="none")}function pe(){Y&&J&&(Y[J]=oe)}function be(_){_.preventDefault(),_.stopPropagation(),window.removeEventListener("click",be,!0)}function Oe(){window.addEventListener("click",be,!0),window.setTimeout(()=>{window.removeEventListener("click",be,!0)},0)}function je(_,a){const d=_.getBoundingClientRect();return xe(_,d,a)}function st(_,a){const d=_.getBoundingClientRect(),g=[];for(let x=0;x<a.length;x++)g.push(xe(_,d,a[x]));return g}function ut(_){return window.InstallTrigger!==void 0&&_.button===2&&_.ctrlKey&&window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:_.button}function xe(_,a,d){const g=_.offsetWidth===a.width?1:_.offsetWidth/a.width;return new l.P((d.clientX-a.left)*g,(d.clientY-a.top)*g)}class it{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(a,d){this._updatedSourceCaches[a]=d,this.setDirty()}discardSourceCacheUpdate(a){delete this._updatedSourceCaches[a]}updateLayer(a){const d=a.scope;this._updatedLayers[d]=this._updatedLayers[d]||new Set,this._updatedLayers[d].add(a.id),this.setDirty()}removeLayer(a){const d=a.scope;this._removedLayers[d]=this._removedLayers[d]||{},this._updatedLayers[d]=this._updatedLayers[d]||new Set,this._removedLayers[d][a.id]=a,this._updatedLayers[d].delete(a.id),this._updatedPaintProps.delete(a.fqid),this.setDirty()}getRemovedLayer(a){return this._removedLayers[a.scope]?this._removedLayers[a.scope][a.id]:null}discardLayerRemoval(a){this._removedLayers[a.scope]&&delete this._removedLayers[a.scope][a.id]}getLayerUpdatesByScope(){const a={};for(const d in this._updatedLayers)a[d]=a[d]||{},a[d].updatedIds=Array.from(this._updatedLayers[d].values());for(const d in this._removedLayers)a[d]=a[d]||{},a[d].removedIds=Object.keys(this._removedLayers[d]);return a}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(a){this._updatedPaintProps.add(a.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(a){this._updatedImages.add(a),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}class Be extends l.E{constructor(a){super(),this.requestManager=a,this.models={"":{}},this.numModelsLoading={}}loadModel(a,d){return l.l(this.requestManager.transformRequest(d,l.R.Model).url).then(g=>{if(!g)return;const x=l.c(g),w=new l.M(a,void 0,void 0,x);return w.computeBoundsAndApplyParent(),w}).catch(g=>{this.fire(new l.a(new Error(`Could not load model ${a} from ${d}: ${g.message}`)))})}load(a,d){this.models[d]||(this.models[d]={});const g=Object.keys(a);this.numModelsLoading[d]=(this.numModelsLoading[d]||0)+g.length;const x=[];for(const w of g)x.push(this.loadModel(w,a[w]));Promise.allSettled(x).then(w=>{for(let S=0;S<w.length;S++){const{status:C,value:R}=w[S];C==="fulfilled"&&R&&(this.models[d][g[S]]=R)}this.numModelsLoading[d]-=g.length,this.fire(new l.b("data",{dataType:"style"}))}).catch(w=>{this.fire(new l.a(new Error(`Could not load models: ${w.message}`)))})}isLoaded(){for(const a in this.numModelsLoading)if(this.numModelsLoading[a]>0)return!1;return!0}hasModel(a,d){return!!this.getModel(a,d)}getModel(a,d){return this.models[d]||(this.models[d]={}),this.models[d][a]}addModel(a,d,g){this.models[g]||(this.models[g]={}),this.hasModel(a,g)&&this.removeModel(a,g),this.load({[a]:this.requestManager.normalizeModelURL(d)},g)}addModels(a,d){const g={};for(const x in a)g[x]=this.requestManager.normalizeModelURL(a[x]);this.load(g,d)}removeModel(a,d){this.models[d]||(this.models[d]={});const g=this.models[d][a];delete this.models[d][a],g.destroy()}listModels(a){return this.models[a]||(this.models[a]={}),Object.keys(this.models[a])}upload(a,d){this.models[d]||(this.models[d]={});for(const g in this.models[d])this.models[d][g].upload(a.context)}}class Qe{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(a,d,g){const x=String(d);if(this.stateChanges[a]=this.stateChanges[a]||{},this.stateChanges[a][x]=this.stateChanges[a][x]||{},l.e(this.stateChanges[a][x],g),this.deletedStates[a]===null){this.deletedStates[a]={};for(const w in this.state[a])w!==x&&(this.deletedStates[a][w]=null)}else if(this.deletedStates[a]&&this.deletedStates[a][x]===null){this.deletedStates[a][x]={};for(const w in this.state[a][x])g[w]||(this.deletedStates[a][x][w]=null)}else for(const w in g)this.deletedStates[a]&&this.deletedStates[a][x]&&this.deletedStates[a][x][w]===null&&delete this.deletedStates[a][x][w]}removeFeatureState(a,d,g){if(this.deletedStates[a]===null)return;const x=String(d);if(this.deletedStates[a]=this.deletedStates[a]||{},g&&d!==void 0)this.deletedStates[a][x]!==null&&(this.deletedStates[a][x]=this.deletedStates[a][x]||{},this.deletedStates[a][x][g]=null);else if(d!==void 0)if(this.stateChanges[a]&&this.stateChanges[a][x])for(g in this.deletedStates[a][x]={},this.stateChanges[a][x])this.deletedStates[a][x][g]=null;else this.deletedStates[a][x]=null;else this.deletedStates[a]=null}getState(a,d){const g=String(d),x=l.e({},(this.state[a]||{})[g],(this.stateChanges[a]||{})[g]);if(this.deletedStates[a]===null)return{};if(this.deletedStates[a]){const w=this.deletedStates[a][d];if(w===null)return{};for(const S in w)delete x[S]}return x}initializeTileState(a,d){a.setFeatureState(this.state,d)}coalesceChanges(a,d){const g={};for(const x in this.stateChanges){this.state[x]=this.state[x]||{};const w={};for(const S in this.stateChanges[x])this.state[x][S]||(this.state[x][S]={}),l.e(this.state[x][S],this.stateChanges[x][S]),w[S]=this.state[x][S];g[x]=w}for(const x in this.deletedStates){this.state[x]=this.state[x]||{};const w={};if(this.deletedStates[x]===null)for(const S in this.state[x])w[S]={},this.state[x][S]={};else for(const S in this.deletedStates[x]){if(this.deletedStates[x][S]===null)this.state[x][S]={};else if(this.state[x][S])for(const C of Object.keys(this.deletedStates[x][S]))delete this.state[x][S][C];w[S]=this.state[x][S]}g[x]=g[x]||{},l.e(g[x],w)}if(this.stateChanges={},this.deletedStates={},Object.keys(g).length!==0)for(const x in a)a[x].setFeatureState(g,d)}}function Ct(_){const{userImage:a}=_;return!!(a&&a.render&&a.render())&&(_.data.replace(new Uint8Array(a.data.buffer)),!0)}class Kt extends l.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0}createScope(a){this.images[a]={},this.loaded[a]=!1,this.updatedImages[a]={},this.patterns[a]={},this.callbackDispatchedThisFrame[a]={},this.atlasImage[a]=new l.h({width:1,height:1})}isLoaded(){for(const a in this.loaded)if(!this.loaded[a])return!1;return!0}setLoaded(a,d){if(this.loaded[d]!==a&&(this.loaded[d]=a,a)){for(const{ids:g,callback:x}of this.requestors)this._notify(g,d,x);this.requestors=[]}}hasImage(a,d){return!!this.getImage(a,d)}getImage(a,d){return this.images[d][a]}addImage(a,d,g){this._validate(a,g)&&(this.images[d][a]=g)}_validate(a,d){let g=!0;return this._validateStretch(d.stretchX,d.data&&d.data.width)||(this.fire(new l.a(new Error(`Image "${a}" has invalid "stretchX" value`))),g=!1),this._validateStretch(d.stretchY,d.data&&d.data.height)||(this.fire(new l.a(new Error(`Image "${a}" has invalid "stretchY" value`))),g=!1),this._validateContent(d.content,d)||(this.fire(new l.a(new Error(`Image "${a}" has invalid "content" value`))),g=!1),g}_validateStretch(a,d){if(!a)return!0;let g=0;for(const x of a){if(x[0]<g||x[1]<x[0]||d<x[1])return!1;g=x[1]}return!0}_validateContent(a,d){return!(a&&(a.length!==4||a[0]<0||d.data.width<a[0]||a[1]<0||d.data.height<a[1]||a[2]<0||d.data.width<a[2]||a[3]<0||d.data.height<a[3]||a[2]<a[0]||a[3]<a[1]))}updateImage(a,d,g){g.version=this.images[d][a].version+1,this.images[d][a]=g,this.updatedImages[d][a]=!0}removeImage(a,d){const g=this.images[d][a];delete this.images[d][a],delete this.patterns[d][a],g.userImage&&g.userImage.onRemove&&g.userImage.onRemove()}listImages(a){return Object.keys(this.images[a])}getImages(a,d,g){let x=!0;const w=!!this.loaded[d];if(!w)for(const S of a)this.images[d][S]||(x=!1);w||x?this._notify(a,d,g):this.requestors.push({ids:a,scope:d,callback:g})}getUpdatedImages(a){return this.updatedImages[a]}_notify(a,d,g){const x={};for(const w of a){this.images[d][w]||this.fire(new l.b("styleimagemissing",{id:w}));const S=this.images[d][w];S?x[w]={data:S.data.clone(),pixelRatio:S.pixelRatio,sdf:S.sdf,version:S.version,stretchX:S.stretchX,stretchY:S.stretchY,content:S.content,hasRenderCallback:!!(S.userImage&&S.userImage.render)}:l.w(`Image "${w}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}g(null,x)}getPixelSize(a){const{width:d,height:g}=this.atlasImage[a];return{width:d,height:g}}getPattern(a,d){const g=this.patterns[d][a],x=this.getImage(a,d);if(!x)return null;if(g&&g.position.version===x.version)return g.position;if(g)g.position.version=x.version;else{const w={w:x.data.width+2,h:x.data.height+2,x:0,y:0},S=new l.I(w,x);this.patterns[d][a]={bin:w,position:S}}return this._updatePatternAtlas(d),this.patterns[d][a].position}bind(a,d){const g=a.gl;let x=this.atlasTexture[d];x?this.dirty&&(x.update(this.atlasImage[d]),this.dirty=!1):(x=new l.T(a,this.atlasImage[d],g.RGBA),this.atlasTexture[d]=x),x.bind(g.LINEAR,g.CLAMP_TO_EDGE)}_updatePatternAtlas(a){const d=[];for(const S in this.patterns[a])d.push(this.patterns[a][S].bin);const{w:g,h:x}=l.p(d),w=this.atlasImage[a];w.resize({width:g||1,height:x||1});for(const S in this.patterns[a]){const{bin:C}=this.patterns[a][S],R=C.x+1,D=C.y+1,N=this.images[a][S].data,B=N.width,j=N.height;l.h.copy(N,w,{x:0,y:0},{x:R,y:D},{width:B,height:j}),l.h.copy(N,w,{x:0,y:j-1},{x:R,y:D-1},{width:B,height:1}),l.h.copy(N,w,{x:0,y:0},{x:R,y:D+j},{width:B,height:1}),l.h.copy(N,w,{x:B-1,y:0},{x:R-1,y:D},{width:1,height:j}),l.h.copy(N,w,{x:0,y:0},{x:R+B,y:D},{width:1,height:j})}this.dirty=!0}beginFrame(){for(const a in this.images)this.callbackDispatchedThisFrame[a]={}}dispatchRenderCallbacks(a,d){for(const g of a){if(this.callbackDispatchedThisFrame[d][g])continue;this.callbackDispatchedThisFrame[d][g]=!0;const x=this.images[d][g];Ct(x)&&this.updateImage(g,d,x)}}}class Ie{constructor(a,d,g,x){this.message=(a?`${a}: `:"")+g,x&&(this.identifier=x),d!=null&&d.__line__&&(this.line=d.__line__)}}class fi extends Ie{}function Yi(_){const a=_.key,d=_.value,g=_.valueSpec||{},x=_.objectElementValidators||{},w=_.style,S=_.styleSpec;let C=[];const R=l.i(d);if(R!=="object")return[new Ie(a,d,`object expected, ${R} found`)];for(const D in d){const N=D.split(".")[0];let B;x[N]?B=x[N]:g[N]?B=Ni:x["*"]?B=x["*"]:g["*"]&&(B=Ni),B?C=C.concat(B({key:(a&&`${a}.`)+D,value:d[D],valueSpec:g[N]||g["*"],style:w,styleSpec:S,object:d,objectKey:D},d)):C.push(new fi(a,d[D],`unknown property "${D}"`))}for(const D in g)x[D]||g[D].required&&g[D].default===void 0&&d[D]===void 0&&C.push(new Ie(a,d,`missing required property "${D}"`));return C}function ri(_){const a=_.value,d=_.valueSpec,g=_.style,x=_.styleSpec,w=_.key,S=_.arrayElementValidator||Ni;if(l.i(a)!=="array")return[new Ie(w,a,`array expected, ${l.i(a)} found`)];if(d.length&&a.length!==d.length)return[new Ie(w,a,`array length ${d.length} expected, length ${a.length} found`)];if(d["min-length"]&&a.length<d["min-length"])return[new Ie(w,a,`array length at least ${d["min-length"]} expected, length ${a.length} found`)];let C={type:d.value,values:d.values,minimum:d.minimum,maximum:d.maximum,function:void 0};x.$version<7&&(C.function=d.function),l.i(d.value)==="object"&&(C=d.value);let R=[];for(let D=0;D<a.length;D++)R=R.concat(S({array:a,arrayIndex:D,value:a[D],valueSpec:C,style:g,styleSpec:x,key:`${w}[${D}]`},!0));return R}function vr(_){const a=_.key,d=_.value,g=_.valueSpec;let x=l.i(d);if(x==="number"&&d!=d&&(x="NaN"),x!=="number")return[new Ie(a,d,`number expected, ${x} found`)];if("minimum"in g){let w=g.minimum;if(l.i(g.minimum)==="array"&&(w=g.minimum[_.arrayIndex]),d<w)return[new Ie(a,d,`${d} is less than the minimum value ${w}`)]}if("maximum"in g){let w=g.maximum;if(l.i(g.maximum)==="array"&&(w=g.maximum[_.arrayIndex]),d>w)return[new Ie(a,d,`${d} is greater than the maximum value ${w}`)]}return[]}function Gr(_){const a=_.valueSpec,d=l.u(_.value.type);let g,x,w,S={};const C=d!=="categorical"&&_.value.property===void 0,R=!C,D=l.i(_.value.stops)==="array"&&l.i(_.value.stops[0])==="array"&&l.i(_.value.stops[0][0])==="object",N=Yi({key:_.key,value:_.value,valueSpec:_.styleSpec.function,style:_.style,styleSpec:_.styleSpec,objectElementValidators:{stops:function($){if(d==="identity")return[new Ie($.key,$.value,'identity function may not have a "stops" property')];let Z=[];const X=$.value;return Z=Z.concat(ri({key:$.key,value:X,valueSpec:$.valueSpec,style:$.style,styleSpec:$.styleSpec,arrayElementValidator:B})),l.i(X)==="array"&&X.length===0&&Z.push(new Ie($.key,X,"array must have at least one stop")),Z},default:function($){return Ni({key:$.key,value:$.value,valueSpec:a,style:$.style,styleSpec:$.styleSpec})}}});return d==="identity"&&C&&N.push(new Ie(_.key,_.value,'missing required property "property"')),d==="identity"||_.value.stops||N.push(new Ie(_.key,_.value,'missing required property "stops"')),d==="exponential"&&_.valueSpec.expression&&!l.s(_.valueSpec)&&N.push(new Ie(_.key,_.value,"exponential functions not supported")),_.styleSpec.$version>=8&&(R&&!l.k(_.valueSpec)?N.push(new Ie(_.key,_.value,"property functions not supported")):C&&!l.m(_.valueSpec)&&N.push(new Ie(_.key,_.value,"zoom functions not supported"))),d!=="categorical"&&!D||_.value.property!==void 0||N.push(new Ie(_.key,_.value,'"property" property is required')),N;function B($){let Z=[];const X=$.value,K=$.key;if(l.i(X)!=="array")return[new Ie(K,X,`array expected, ${l.i(X)} found`)];if(X.length!==2)return[new Ie(K,X,`array length 2 expected, length ${X.length} found`)];if(D){if(l.i(X[0])!=="object")return[new Ie(K,X,`object expected, ${l.i(X[0])} found`)];if(X[0].zoom===void 0)return[new Ie(K,X,"object stop key must have zoom")];if(X[0].value===void 0)return[new Ie(K,X,"object stop key must have value")];const q=l.u(X[0].zoom);if(typeof q!="number")return[new Ie(K,X[0].zoom,"stop zoom values must be numbers")];if(w&&w>q)return[new Ie(K,X[0].zoom,"stop zoom values must appear in ascending order")];q!==w&&(w=q,x=void 0,S={}),Z=Z.concat(Yi({key:`${K}[0]`,value:X[0],valueSpec:{zoom:{}},style:$.style,styleSpec:$.styleSpec,objectElementValidators:{zoom:vr,value:j}}))}else Z=Z.concat(j({key:`${K}[0]`,value:X[0],valueSpec:{},style:$.style,styleSpec:$.styleSpec},X));return l.n(l.o(X[1]))?Z.concat([new Ie(`${K}[1]`,X[1],"expressions are not allowed in function stops.")]):Z.concat(Ni({key:`${K}[1]`,value:X[1],valueSpec:a,style:$.style,styleSpec:$.styleSpec}))}function j($,Z){const X=l.i($.value),K=l.u($.value),q=$.value!==null?$.value:Z;if(g){if(X!==g)return[new Ie($.key,q,`${X} stop domain type must match previous stop domain type ${g}`)]}else g=X;if(X!=="number"&&X!=="string"&&X!=="boolean"&&typeof K!="number"&&typeof K!="string"&&typeof K!="boolean")return[new Ie($.key,q,"stop domain value must be a number, string, or boolean")];if(X!=="number"&&d!=="categorical"){let ee=`number expected, ${X} found`;return l.k(a)&&d===void 0&&(ee+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new Ie($.key,q,ee)]}return d!=="categorical"||X!=="number"||typeof K=="number"&&isFinite(K)&&Math.floor(K)===K?d!=="categorical"&&X==="number"&&typeof K=="number"&&typeof x=="number"&&x!==void 0&&K<x?[new Ie($.key,q,"stop domain values must appear in ascending order")]:(x=K,d==="categorical"&&K in S?[new Ie($.key,q,"stop domain values must be unique")]:(S[K]=!0,[])):[new Ie($.key,q,`integer expected, found ${String(K)}`)]}}function Tr(_){const a=(_.expressionContext==="property"?l.q:l.r)(l.o(_.value),_.valueSpec);if(a.result==="error")return a.value.map(g=>new Ie(`${_.key}${g.key}`,_.value,g.message));const d=a.value.expression||a.value._styleExpression.expression;if(_.expressionContext==="property"&&_.propertyKey==="text-font"&&!d.outputDefined())return[new Ie(_.key,_.value,`Invalid data expression for "${_.propertyKey}". Output values must be contained as literals within the expression.`)];if(_.expressionContext==="property"&&_.propertyType==="layout"&&!l.t(d))return[new Ie(_.key,_.value,'"feature-state" data expressions are not supported with layout properties.')];if(_.expressionContext==="filter")return Ar(d,_);if(_.expressionContext&&_.expressionContext.indexOf("cluster")===0){if(!l.v(d,["zoom","feature-state"]))return[new Ie(_.key,_.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(_.expressionContext==="cluster-initial"&&!l.x(d))return[new Ie(_.key,_.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Ar(_,a){const d=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(a.valueSpec&&a.valueSpec.expression)for(const x of a.valueSpec.expression.parameters)d.delete(x);if(d.size===0)return[];const g=[];return _ instanceof l.C&&d.has(_.name)?[new Ie(a.key,a.value,`["${_.name}"] expression is not supported in a filter for a ${a.object.type} layer with id: ${a.object.id}`)]:(_.eachChild(x=>{g.push(...Ar(x,a))}),g)}function kr(_){const a=_.key,d=_.value,g=_.valueSpec,x=[];return Array.isArray(g.values)?g.values.indexOf(l.u(d))===-1&&x.push(new Ie(a,d,`expected one of [${g.values.join(", ")}], ${JSON.stringify(d)} found`)):Object.keys(g.values).indexOf(l.u(d))===-1&&x.push(new Ie(a,d,`expected one of [${Object.keys(g.values).join(", ")}], ${JSON.stringify(d)} found`)),x}function $r(_){return l.z(l.o(_.value))?Tr(l.j({},_,{expressionContext:"filter",valueSpec:_.styleSpec[`filter_${_.layerType||"fill"}`]})):Vn(_)}function Vn(_){const a=_.value,d=_.key;if(l.i(a)!=="array")return[new Ie(d,a,`array expected, ${l.i(a)} found`)];const g=_.styleSpec;let x,w=[];if(a.length<1)return[new Ie(d,a,"filter array must have at least 1 element")];switch(w=w.concat(kr({key:`${d}[0]`,value:a[0],valueSpec:g.filter_operator,style:_.style,styleSpec:_.styleSpec})),l.u(a[0])){case"<":case"<=":case">":case">=":a.length>=2&&l.u(a[1])==="$type"&&w.push(new Ie(d,a,`"$type" cannot be use with operator "${a[0]}"`));case"==":case"!=":a.length!==3&&w.push(new Ie(d,a,`filter array for operator "${a[0]}" must have 3 elements`));case"in":case"!in":a.length>=2&&(x=l.i(a[1]),x!=="string"&&w.push(new Ie(`${d}[1]`,a[1],`string expected, ${x} found`)));for(let S=2;S<a.length;S++)x=l.i(a[S]),l.u(a[1])==="$type"?w=w.concat(kr({key:`${d}[${S}]`,value:a[S],valueSpec:g.geometry_type,style:_.style,styleSpec:_.styleSpec})):x!=="string"&&x!=="number"&&x!=="boolean"&&w.push(new Ie(`${d}[${S}]`,a[S],`string, number, or boolean expected, ${x} found`));break;case"any":case"all":case"none":for(let S=1;S<a.length;S++)w=w.concat(Vn({key:`${d}[${S}]`,value:a[S],style:_.style,styleSpec:_.styleSpec}));break;case"has":case"!has":x=l.i(a[1]),a.length!==2?w.push(new Ie(d,a,`filter array for "${a[0]}" operator must have 2 elements`)):x!=="string"&&w.push(new Ie(`${d}[1]`,a[1],`string expected, ${x} found`))}return w}function Pn(_,a){const d=_.key,g=_.style,x=_.layer,w=_.styleSpec,S=_.value,C=_.objectKey,R=w[`${a}_${_.layerType}`];if(!R)return[];const D=C.match(/^(.*)-transition$/);if(a==="paint"&&D&&R[D[1]]&&R[D[1]].transition)return Ni({key:d,value:S,valueSpec:w.transition,style:g,styleSpec:w});const N=_.valueSpec||R[C];if(!N)return[new fi(d,S,`unknown property "${C}"`)];let B;if(l.i(S)==="string"&&l.k(N)&&!N.tokens&&(B=/^{([^}]+)}$/.exec(S))){const $=`\`{ "type": "identity", "property": ${B?JSON.stringify(B[1]):'"_"'} }\``;return[new Ie(d,S,`"${C}" does not support interpolation syntax
Use an identity property function instead: ${$}.`)]}const j=[];if(_.layerType==="symbol")C!=="text-field"||!g||g.glyphs||g.imports||j.push(new Ie(d,S,'use of "text-field" requires a style "glyphs" property')),C==="text-font"&&l.A(l.o(S))&&l.u(S.type)==="identity"&&j.push(new Ie(d,S,'"text-font" does not support identity functions'));else if(_.layerType==="model"&&a==="paint"&&x&&x.layout&&x.layout.hasOwnProperty("model-id")&&l.k(N)&&(l.B(N)||l.m(N))){const $=l.q(l.o(S),N),Z=$.value.expression||$.value._styleExpression.expression;Z&&!l.v(Z,["measure-light"])&&(C==="model-emissive-strength"&&l.x(Z)&&l.t(Z)||j.push(new Ie(d,S,`${C} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return j.concat(Ni({key:_.key,value:S,valueSpec:N,style:g,styleSpec:w,expressionContext:"property",propertyType:a,propertyKey:C}))}function Si(_){return Pn(_,"paint")}function Ir(_){return Pn(_,"layout")}function Er(_){let a=[];const d=_.value,g=_.key,x=_.style,w=_.styleSpec;d.type||d.ref||a.push(new Ie(g,d,'either "type" or "ref" is required'));let S=l.u(d.type);const C=l.u(d.ref);if(d.id){const R=l.u(d.id);for(let D=0;D<_.arrayIndex;D++){const N=x.layers[D];l.u(N.id)===R&&a.push(new Ie(g,d.id,`duplicate layer id "${d.id}", previously used at line ${N.id.__line__}`))}}if("ref"in d){let R;["type","source","source-layer","filter","layout"].forEach(D=>{D in d&&a.push(new Ie(g,d[D],`"${D}" is prohibited for ref layers`))}),x.layers.forEach(D=>{l.u(D.id)===C&&(R=D)}),R?R.ref?a.push(new Ie(g,d.ref,"ref cannot reference another ref layer")):S=l.u(R.type):typeof C=="string"&&a.push(new Ie(g,d.ref,`ref layer "${C}" not found`))}else if(S!=="background"&&S!=="sky"&&S!=="slot")if(d.source){const R=x.sources&&x.sources[d.source],D=R&&l.u(R.type);R?D==="vector"&&S==="raster"?a.push(new Ie(g,d.source,`layer "${d.id}" requires a raster source`)):D==="raster"&&S!=="raster"?a.push(new Ie(g,d.source,`layer "${d.id}" requires a vector source`)):D!=="vector"||d["source-layer"]?D==="raster-dem"&&S!=="hillshade"?a.push(new Ie(g,d.source,"raster-dem source can only be used with layer type 'hillshade'.")):D!=="raster-array"||["raster","raster-particle"].includes(S)?S!=="line"||!d.paint||!d.paint["line-gradient"]&&!d.paint["line-trim-offset"]||D==="geojson"&&R.lineMetrics?S==="raster-particle"&&D!=="raster-array"&&a.push(new Ie(g,d.source,`layer "${d.id}" requires a 'raster-array' source.`)):a.push(new Ie(g,d,`layer "${d.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):a.push(new Ie(g,d.source,"raster-array source can only be used with layer type 'raster'.")):a.push(new Ie(g,d,`layer "${d.id}" must specify a "source-layer"`)):a.push(new Ie(g,d.source,`source "${d.source}" not found`))}else a.push(new Ie(g,d,'missing required property "source"'));return a=a.concat(Yi({key:g,value:d,valueSpec:w.layer,style:_.style,styleSpec:_.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Ni({key:`${g}.type`,value:d.type,valueSpec:w.layer.type,style:_.style,styleSpec:_.styleSpec,object:d,objectKey:"type"}),filter:R=>$r(l.j({layerType:S},R)),layout:R=>Yi({layer:d,key:R.key,value:R.value,valueSpec:{},style:R.style,styleSpec:R.styleSpec,objectElementValidators:{"*":D=>Ir(l.j({layerType:S},D))}}),paint:R=>Yi({layer:d,key:R.key,value:R.value,valueSpec:{},style:R.style,styleSpec:R.styleSpec,objectElementValidators:{"*":D=>Si(l.j({layerType:S,layer:d},D))}})}})),a}function Ki(_){const a=_.value,d=_.key,g=l.i(a);return g!=="string"?[new Ie(d,a,`string expected, ${g} found`)]:[]}const In={promoteId:function({key:_,value:a}){if(l.i(a)==="string")return Ki({key:_,value:a});{const d=[];for(const g in a)d.push(...Ki({key:`${_}.${g}`,value:a[g]}));return d}}};function gn(_){const a=_.value,d=_.key,g=_.styleSpec,x=_.style;if(!a.type)return[new Ie(d,a,'"type" is required')];const w=l.u(a.type);let S=[];switch(["vector","raster","raster-dem","raster-array"].includes(w)&&(a.url||a.tiles||S.push(new fi(d,a,'Either "url" or "tiles" is required.'))),w){case"vector":case"raster":case"raster-dem":case"raster-array":return S=S.concat(Yi({key:d,value:a,valueSpec:g[`source_${w.replace("-","_")}`],style:_.style,styleSpec:g,objectElementValidators:In})),S;case"geojson":if(S=Yi({key:d,value:a,valueSpec:g.source_geojson,style:x,styleSpec:g,objectElementValidators:In}),a.cluster)for(const C in a.clusterProperties){const[R,D]=a.clusterProperties[C],N=typeof R=="string"?[R,["accumulated"],["get",C]]:R;S.push(...Tr({key:`${d}.${C}.map`,value:D,expressionContext:"cluster-map"})),S.push(...Tr({key:`${d}.${C}.reduce`,value:N,expressionContext:"cluster-reduce"}))}return S;case"video":return Yi({key:d,value:a,valueSpec:g.source_video,style:x,styleSpec:g});case"image":return Yi({key:d,value:a,valueSpec:g.source_image,style:x,styleSpec:g});case"canvas":return[new Ie(d,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return kr({key:`${d}.type`,value:a.type,valueSpec:{values:Kn(g)},style:x,styleSpec:g})}}function Kn(_){return _.source.reduce((a,d)=>{const g=_[d];return g.type.type==="enum"&&(a=a.concat(Object.keys(g.type.values))),a},[])}function mr(_){const a=_.value;let d=[];if(!a)return d;const g=l.i(a);return g!=="string"?(d=d.concat([new Ie(_.key,a,`string expected, "${g}" found`)]),d):(function(x){const w=x.indexOf("://")===-1;try{return new URL(x,w?"http://example.com":void 0),!0}catch{return!1}}(a)||(d=d.concat([new Ie(_.key,a,`invalid url "${a}"`)])),d)}function cn(_){const a=_.value,d=_.styleSpec,g=d.light,x=_.style;let w=[];const S=l.i(a);if(a===void 0)return w;if(S!=="object")return w=w.concat([new Ie("light",a,`object expected, ${S} found`)]),w;for(const C in a){const R=C.match(/^(.*)-transition$/);w=w.concat(R&&g[R[1]]&&g[R[1]].transition?Ni({key:C,value:a[C],valueSpec:d.transition,style:x,styleSpec:d}):g[C]?Ni({key:C,value:a[C],valueSpec:g[C],style:x,styleSpec:d}):[new Ie(C,a[C],`unknown property "${C}"`)])}return w}function Dr(_){const a=_.value;let d=[];if(!a)return d;const g=l.i(a);if(g!=="object")return d=d.concat([new Ie("light-3d",a,`object expected, ${g} found`)]),d;const x=_.styleSpec,w=x["light-3d"],S=_.key,C=_.style,R=_.style.lights;for(const B of["type","id"])if(!(B in a))return d=d.concat([new Ie("light-3d",a,`missing property ${B} on light`)]),d;if(a.type&&R)for(let B=0;B<_.arrayIndex;B++){const j=l.u(a.type),$=R[B];l.u($.type)===j&&d.push(new Ie(S,a.id,`duplicate light type "${a.type}", previously defined at line ${$.id.__line__}`))}const D=`properties_light_${a.type}`;if(!(D in x))return d=d.concat([new Ie("light-3d",a,`Invalid light type ${a.type}`)]),d;const N=x[D];for(const B in a)if(B==="properties"){const j=a[B],$=l.i(j);if($!=="object")return d=d.concat([new Ie("properties",j,`object expected, ${$} found`)]),d;for(const Z in j)d=d.concat(N[Z]?Ni({key:Z,value:j[Z],valueSpec:N[Z],style:C,styleSpec:x}):[new fi(_.key,j[Z],`unknown property "${Z}"`)])}else{const j=B.match(/^(.*)-transition$/);d=d.concat(j&&w[j[1]]&&w[j[1]].transition?Ni({key:B,value:a[B],valueSpec:x.transition,style:C,styleSpec:x}):w[B]?Ni({key:B,value:a[B],valueSpec:w[B],style:C,styleSpec:x}):[new fi(B,a[B],`unknown property "${B}"`)])}return d}function yn(_){const a=_.value,d=_.key,g=_.style,x=_.styleSpec,w=x.terrain;let S=[];const C=l.i(a);if(a===void 0||C==="null")return S;if(C!=="object")return S=S.concat([new Ie("terrain",a,`object expected, ${C} found`)]),S;for(const R in a){const D=R.match(/^(.*)-transition$/);S=S.concat(D&&w[D[1]]&&w[D[1]].transition?Ni({key:R,value:a[R],valueSpec:x.transition,style:g,styleSpec:x}):w[R]?Ni({key:R,value:a[R],valueSpec:w[R],style:g,styleSpec:x}):[new fi(R,a[R],`unknown property "${R}"`)])}if(a.source){const R=g.sources&&g.sources[a.source],D=R&&l.u(R.type);R?D!=="raster-dem"&&S.push(new Ie(d,a.source,`terrain cannot be used with a source of type ${String(D)}, it only be used with a "raster-dem" source type`)):S.push(new Ie(d,a.source,`source "${a.source}" not found`))}else S.push(new Ie(d,a,'terrain is missing required property "source"'));return S}function Rn(_){const a=_.value,d=_.style,g=_.styleSpec,x=g.fog;let w=[];const S=l.i(a);if(a===void 0)return w;if(S!=="object")return w=w.concat([new Ie("fog",a,`object expected, ${S} found`)]),w;for(const C in a){const R=C.match(/^(.*)-transition$/);w=w.concat(R&&x[R[1]]&&x[R[1]].transition?Ni({key:C,value:a[C],valueSpec:g.transition,style:d,styleSpec:g}):x[C]?Ni({key:C,value:a[C],valueSpec:x[C],style:d,styleSpec:g}):[new fi(C,a[C],`unknown property "${C}"`)])}return w}const ir={"*":()=>[],array:ri,boolean:function(_){const a=_.value,d=_.key,g=l.i(a);return g!=="boolean"?[new Ie(d,a,`boolean expected, ${g} found`)]:[]},number:vr,color:function(_){const a=_.key,d=_.value,g=l.i(d);return g!=="string"?[new Ie(a,d,`color expected, ${g} found`)]:l.y(d)===null?[new Ie(a,d,`color expected, "${d}" found`)]:[]},enum:kr,filter:$r,function:Gr,layer:Er,object:Yi,source:gn,model:mr,light:cn,"light-3d":Dr,terrain:yn,fog:Rn,string:Ki,formatted:function(_){return Ki(_).length===0?[]:Tr(_)},resolvedImage:function(_){return Ki(_).length===0?[]:Tr(_)},projection:function(_){const a=_.value,d=_.styleSpec,g=d.projection,x=_.style;let w=[];const S=l.i(a);if(S==="object")for(const C in a)w=w.concat(Ni({key:C,value:a[C],valueSpec:g[C],style:x,styleSpec:d}));else S!=="string"&&(w=w.concat([new Ie("projection",a,`object or string expected, ${S} found`)]));return w},import:function(_){const{value:a,styleSpec:d}=_,{data:g,...x}=a;Object.defineProperty(x,"__line__",{value:a.__line__,enumerable:!1});let w=Yi(l.j({},_,{value:x,valueSpec:d.import}));return l.u(x.id)===""&&w.push(new Ie(`${_.key}.id`,x,"import id can't be an empty string")),g&&(w=w.concat(Ur(g,d,{key:`${_.key}.data`}))),w}};function Ni(_,a=!1){const d=_.value,g=_.valueSpec,x=_.styleSpec;if(g.expression&&l.A(l.u(d)))return Gr(_);if(g.expression&&l.n(l.o(d)))return Tr(_);if(g.type&&ir[g.type]){const w=ir[g.type](_);return a===!0&&w.length>0&&l.i(_.value)==="array"?Tr(_):w}return Yi(l.j({},_,{valueSpec:g.type?x[g.type]:g}))}function _r(_){const a=_.value,d=_.key,g=Ki(_);return g.length||(a.indexOf("{fontstack}")===-1&&g.push(new Ie(d,a,'"glyphs" url must include a "{fontstack}" token')),a.indexOf("{range}")===-1&&g.push(new Ie(d,a,'"glyphs" url must include a "{range}" token'))),g}function Ur(_,a=l.D,d={}){return Ni({key:d.key||"",value:_,valueSpec:a.$root,styleSpec:a,style:_,objectElementValidators:{glyphs:_r,"*":()=>[]}})}function Cr(_,a=l.D){return Se(Ur(_,a))}const Oi=_=>Se(gn(_)),Nr=_=>Se(cn(_)),Ke=_=>Se(Dr(_)),ie=_=>Se(yn(_)),he=_=>Se(Rn(_)),Te=_=>Se(Er(_)),Xe=_=>Se($r(_)),Je=_=>Se(Si(_)),lt=_=>Se(Ir(_)),It=_=>Se(mr(_));function Se(_){return _.slice().sort((a,d)=>a.line&&d.line?a.line-d.line:0)}function ot(_,a){let d=!1;if(a&&a.length)for(const g of a)g instanceof fi?l.w(g.message):(_.fire(new l.a(new Error(g.message))),d=!0);return d}const xt=new l.F({anchor:new l.G(l.D.light.anchor),position:new l.H(l.D.light.position),color:new l.G(l.D.light.color),intensity:new l.G(l.D.light.intensity)});class $t extends l.E{constructor(a,d="flat"){super(),this._transitionable=new l.J(xt),this.setLight(a,d),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(a,d,g={}){this._validate(Nr,a,g)||(this._transitionable.setTransitionOrValue(a),this.id=d)}updateTransitions(a){this._transitioning=this._transitionable.transitioned(a,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(a){this.properties=this._transitioning.possiblyEvaluate(a)}_validate(a,d,g){return(!g||g.validate!==!1)&&ot(this,a.call(Cr,l.e({value:d,style:{glyphs:!0,sprite:!0},styleSpec:l.D})))}}const pi=new l.F({source:new l.G(l.D.terrain.source),exaggeration:new l.G(l.D.terrain.exaggeration)});let Wi=class extends l.E{constructor(_,a,d,g){super(),this.scope=d,this._transitionable=new l.J(pi,d,g),this._transitionable.setTransitionOrValue(_,g),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=a}get(){return this._transitionable.serialize()}set(_,a){this._transitionable.setTransitionOrValue(_,a)}updateTransitions(_){this._transitioning=this._transitionable.transitioned(_,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(_){this.properties=this._transitioning.possiblyEvaluate(_)}getExaggeration(_){return this._transitioning.possiblyEvaluate(new l.K(_)).get("exaggeration")}isZoomDependent(){const _=this._transitionable._values.exaggeration;return _!=null&&_.value!=null&&_.value.expression!=null&&_.value.expression instanceof l.Z}};const xr=45,Hi=65,Ci=.05;function zi(_,a,d,g){const x=l.O(xr,Hi,d),[w,S]=er(_,g);let C=1-Math.min(1,Math.exp((a-w)/(S-w)*-6));return C*=C*C,C=Math.min(1,1.00747*C),C*x*_.alpha}function er(_,a){const d=.5/Math.tan(.5*a);return[_.range[0]+d,_.range[1]+d]}function Rr(_,a,d,g,x){const w=l.N.transformMat4([],[a,d,g],x.mercatorFogMatrix);return zi(_,l.N.length(w),x.pitch,x._fov)}function nn(_,a,d,g,x,w,S){const C=[[d,g,0],[x,g,0],[x,w,0],[d,w,0]];let R=Number.MAX_VALUE,D=-Number.MAX_VALUE;for(const N of C){const B=l.N.transformMat4([],N,a),j=l.N.length(B);R=Math.min(R,j),D=Math.max(D,j)}return[zi(_,R,S.pitch,S._fov),zi(_,D,S.pitch,S._fov)]}const br=new l.F({range:new l.G(l.D.fog.range),color:new l.G(l.D.fog.color),"high-color":new l.G(l.D.fog["high-color"]),"space-color":new l.G(l.D.fog["space-color"]),"horizon-blend":new l.G(l.D.fog["horizon-blend"]),"star-intensity":new l.G(l.D.fog["star-intensity"]),"vertical-range":new l.G(l.D.fog["vertical-range"])});class Ln extends l.E{constructor(a,d,g,x){super(),this._transitionable=new l.J(br,g,new Map(x)),this.set(a,x),this._transitioning=this._transitionable.untransitioned(),this._transform=d,this.properties=new l.Q(br)}get state(){const a=this._transform,d=a.projection.name==="globe",g=l.S(a.zoom),x=this.properties.get("range"),w=[.5,3];return{range:d?[l.U(w[0],x[0],g),l.U(w[1],x[1],g)]:x,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(a,d,g={}){if(this._validate(he,a,g))return;const x=l.e({},a);for(const w of Object.keys(l.D.fog))x[w]===void 0&&(x[w]=l.D.fog[w].default);this._options=x,this._transitionable.setTransitionOrValue(this._options,d)}getOpacity(a){if(!this._transform.projection.supportsFog)return 0;const d=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:l.O(xr,Hi,a))*d.a}getOpacityAtLatLng(a,d){return this._transform.projection.supportsFog?function(g,x,w){const S=l.L.fromLngLat(x),C=w.elevation?w.elevation.getAtPointOrZero(S):0;return Rr(g,S.x,S.y,C,w)}(this.state,a,d):0}getOpacityForTile(a){if(!this._transform.projection.supportsFog)return[1,1];const d=this._transform.calculateFogTileMatrix(a.toUnwrapped());return nn(this.state,d,0,0,l.V,l.V,this._transform)}getOpacityForBounds(a,d,g,x,w){return this._transform.projection.supportsFog?nn(this.state,a,d,g,x,w,this._transform):[1,1]}getFovAdjustedRange(a){return this._transform.projection.supportsFog?er(this.state,a):[0,1]}isVisibleOnFrustum(a){if(!this._transform.projection.supportsFog)return!1;const d=[4,5,6,7];for(const g of d){const x=a.points[g];let w;if(x[2]>=0)w=x;else{const S=a.points[g-4];w=l.W(S,x,S[2]/(S[2]-x[2]))}if(Rr(this.state,w[0],w[1],0,this._transform)>=Ci)return!0}return!1}updateConfig(a){this._transitionable.setTransitionOrValue(this._options,new Map(a))}updateTransitions(a){this._transitioning=this._transitionable.transitioned(a,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(a){this.properties=this._transitioning.possiblyEvaluate(a)}_validate(a,d,g){return(!g||g.validate!==!1)&&ot(this,a.call(Cr,l.e({value:d,style:{glyphs:!0,sprite:!0},styleSpec:l.D})))}}class rs extends l.E{constructor(a,d,g,x){super(),this.scope=g,this._options=a,this.properties=new l.Q(d),this._transitionable=new l.J(d,g,new Map(x)),this._transitionable.setTransitionOrValue(a.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(a){this._transitionable.setTransitionOrValue(this._options.properties,new Map(a))}updateTransitions(a){this._transitioning=this._transitionable.transitioned(a,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(a){this.properties=this._transitioning.possiblyEvaluate(a)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(a,d){this._options=a,this._transitionable.setTransitionOrValue(a.properties,d)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}const ns=new l.F({color:new l.G(l.D.properties_light_ambient.color),intensity:new l.G(l.D.properties_light_ambient.intensity)}),Yr=new l.F({direction:new l.X(l.D.properties_light_directional.direction),color:new l.G(l.D.properties_light_directional.color),intensity:new l.G(l.D.properties_light_directional.intensity),"cast-shadows":new l.G(l.D.properties_light_directional["cast-shadows"]),"shadow-intensity":new l.G(l.D.properties_light_directional["shadow-intensity"])});class un{constructor(a,d,g,x){this.screenBounds=a,this.cameraPoint=d,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=g,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,x)}static createFromScreenPoints(a,d){let g,x;if(a instanceof l.P||typeof a[0]=="number"){const w=l.P.convert(a);g=[w],x=d.isPointAboveHorizon(w)}else{const w=l.P.convert(a[0]),S=l.P.convert(a[1]);g=[w,S],x=l.Y(w,S).every(C=>d.isPointAboveHorizon(C))}return new un(g,d.getCameraPoint(),x,d)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(a){return l.Y(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],a)}bufferedCameraGeometry(a){const d=this.screenBounds[0],g=this.screenBounds.length===1?this.screenBounds[0].add(new l.P(1,1)):this.screenBounds[1],x=l.Y(d,g,0,!1);return this.cameraPoint.y>g.y&&(this.cameraPoint.x>d.x&&this.cameraPoint.x<g.x?x.splice(3,0,this.cameraPoint):this.cameraPoint.x>=g.x?x[2]=this.cameraPoint:this.cameraPoint.x<=d.x&&(x[3]=this.cameraPoint)),l._(x,a)}bufferedCameraGeometryGlobe(a){const d=this.screenBounds[0],g=this.screenBounds.length===1?this.screenBounds[0].add(new l.P(1,1)):this.screenBounds[1],x=l.Y(d,g,a),w=this.cameraPoint.clone();switch(3*((w.y>d.y)+(w.y>g.y))+((w.x>d.x)+(w.x>g.x))){case 0:x[0]=w,x[4]=w.clone();break;case 1:x.splice(1,0,w);break;case 2:x[1]=w;break;case 3:x.splice(4,0,w);break;case 5:x.splice(2,0,w);break;case 6:x[3]=w;break;case 7:x.splice(3,0,w);break;case 8:x[2]=w}return x}containsTile(a,d,g,x=0){const w=a.queryPadding/d._pixelsPerMercatorPixel+1,S=g?this._bufferedCameraMercator(w,d):this._bufferedScreenMercator(w,d);let C=a.tileID.wrap+(S.unwrapped?x:0);const R=S.polygon.map(K=>l.$(a.tileTransform,K,C));if(!l.a0(R,0,0,l.V,l.V))return;C=a.tileID.wrap+(this.screenGeometryMercator.unwrapped?x:0);const D=this.screenGeometryMercator.polygon.map(K=>l.a1(a.tileTransform,K,C)),N=D.map(K=>new l.P(K[0],K[1])),B=d.getFreeCameraOptions().position||new l.L(0,0,0),j=l.a1(a.tileTransform,B,C),$=D.map(K=>{const q=l.N.sub(K,K,j);return l.N.normalize(q,q),new l.a2(j,q)}),Z=l.a3(a,1,d.zoom)*d._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:N,tilespaceRays:$,bufferedTilespaceGeometry:R,bufferedTilespaceBounds:(X=l.a4(R),X.min.x=l.aa(X.min.x,0,l.V),X.min.y=l.aa(X.min.y,0,l.V),X.max.x=l.aa(X.max.x,0,l.V),X.max.y=l.aa(X.max.y,0,l.V),X),tile:a,tileID:a.tileID,pixelToTileUnitsFactor:Z};var X}_bufferedScreenMercator(a,d){const g=yt(a);if(this._screenRaycastCache[g])return this._screenRaycastCache[g];{let x;return x=d.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(a),d):{polygon:this.bufferedScreenGeometry(a).map(w=>d.pointCoordinate3D(w)),unwrapped:!0},this._screenRaycastCache[g]=x,x}}_bufferedCameraMercator(a,d){const g=yt(a);if(this._cameraRaycastCache[g])return this._cameraRaycastCache[g];{let x;return x=d.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(a),d):{polygon:this.bufferedCameraGeometry(a).map(w=>d.pointCoordinate3D(w)),unwrapped:!0},this._cameraRaycastCache[g]=x,x}}_projectAndResample(a,d){const g=function(w,S){const C=l.a6.multiply([],S.pixelMatrix,S.globeMatrix),R=[0,-l.ab,0,1],D=[0,l.ab,0,1],N=[0,0,0,1];l.a7.transformMat4(R,R,C),l.a7.transformMat4(D,D,C),l.a7.transformMat4(N,N,C);const B=new l.P(R[0]/R[3],R[1]/R[3]),j=new l.P(D[0]/D[3],D[1]/D[3]),$=l.a8(w,B)&&R[3]<N[3],Z=l.a8(w,j)&&D[3]<N[3];if(!$&&!Z)return null;const X=function(ce,ve,we){for(let Ce=1;Ce<ce.length;Ce++){const Ue=nt(ve.pointCoordinate3D(ce[Ce-1]).x),Re=nt(ve.pointCoordinate3D(ce[Ce]).x);if(we<0){if(Ue<Re)return{idx:Ce,t:-Ue/(Re-1-Ue)}}else if(Re<Ue)return{idx:Ce,t:(1-Ue)/(Re+1-Ue)}}return null}(w,S,$?-1:1);if(!X)return null;const{idx:K,t:q}=X;let ee=K>1?et(w.slice(0,K),S):[],ae=K<w.length?et(w.slice(K),S):[];ee=ee.map(ce=>new l.P(nt(ce.x),ce.y)),ae=ae.map(ce=>new l.P(nt(ce.x),ce.y));const re=[...ee];re.length===0&&re.push(ae[ae.length-1]);const le=l.U(re[re.length-1].y,(ae.length===0?ee[0]:ae[0]).y,q);let Q;return Q=$?[new l.P(0,le),new l.P(0,0),new l.P(1,0),new l.P(1,le)]:[new l.P(1,le),new l.P(1,1),new l.P(0,1),new l.P(0,le)],re.push(...Q),ae.length===0?re.push(ee[0]):re.push(...ae),{polygon:re.map(ce=>new l.L(ce.x,ce.y)),unwrapped:!1}}(a,d);if(g)return g;const x=function(w,S){let C=!1,R=-1/0,D=0;for(let B=0;B<w.length-1;B++)w[B].x>R&&(R=w[B].x,D=B);for(let B=0;B<w.length-1;B++){const j=(D+B)%(w.length-1),$=w[j],Z=w[j+1];Math.abs($.x-Z.x)>.5&&($.x<Z.x?($.x+=1,j===0&&(w[w.length-1].x+=1)):(Z.x+=1,j+1===w.length-1&&(w[0].x+=1)),C=!0)}const N=l.a5(S.center.lng);return C&&N<Math.abs(N-1)&&w.forEach(B=>{B.x-=1}),{polygon:w,unwrapped:C}}(et(a,d).map(w=>new l.P(nt(w.x),w.y)),d);return{polygon:x.polygon.map(w=>new l.L(w.x,w.y)),unwrapped:x.unwrapped}}}function et(_,a){return l.a9(_,d=>{const g=a.pointCoordinate3D(d);d.x=g.x,d.y=g.y},1/256)}function nt(_){return _<0?1+_%1:_%1}function yt(_){return 100*_|0}function St(_,a,d,g,x){const w=function(S,C){if(S)return x(S);if(C){_.url&&C.tiles&&_.tiles&&delete _.tiles;const R=l.ac(l.e(C,_),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);C.vector_layers&&(R.vectorLayers=C.vector_layers,R.vectorLayerIds=R.vectorLayers.map(D=>D.id)),C.raster_layers&&(R.rasterLayers=C.raster_layers,R.rasterLayerIds=R.rasterLayers.map(D=>D.id)),R.tiles=a.canonicalizeTileset(R,_.url),x(null,R)}};return _.url?l.g(a.transformRequest(a.normalizeSourceURL(_.url,null,d,g),l.R.Source),w):l.f.frame(()=>w(null,_))}class wt{constructor(a,d,g){this.bounds=l.ad.convert(this.validateBounds(a)),this.minzoom=d||0,this.maxzoom=g||24}validateBounds(a){return Array.isArray(a)&&a.length===4?[Math.max(-180,a[0]),Math.max(-90,a[1]),Math.min(180,a[2]),Math.min(90,a[3])]:[-180,-90,180,90]}contains(a){const d=Math.pow(2,a.z),g=Math.floor(l.a5(this.bounds.getWest())*d),x=Math.floor(l.ae(this.bounds.getNorth())*d),w=Math.ceil(l.a5(this.bounds.getEast())*d),S=Math.ceil(l.ae(this.bounds.getSouth())*d);return a.x>=g&&a.x<w&&a.y>=x&&a.y<S}}class Dt extends l.E{constructor(a,d,g,x){if(super(),this.id=a,this.dispatcher=g,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,l.e(this,l.ac(d,["url","scheme","tileSize","promoteId"])),this._options=l.e({type:"vector"},d),this._collectResourceTiming=!!d.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(x),this._tileWorkers={},this._deduped=new l.af}load(a){this._loaded=!1,this.fire(new l.b("dataloading",{dataType:"source"}));const d=Array.isArray(this.map._language)?this.map._language.join():this.map._language,g=this.map._worldview;this._tileJSONRequest=St(this._options,this.map._requestManager,d,g,(x,w)=>{this._tileJSONRequest=null,this._loaded=!0,x?(d&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${d}`),g&&g.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${g}`),this.fire(new l.a(x))):w&&(l.e(this,w),w.bounds&&(this.tileBounds=new wt(w.bounds,this.minzoom,this.maxzoom)),l.aj(w.tiles,this.map._requestManager._customAccessToken),this.fire(new l.b("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new l.b("data",{dataType:"source",sourceDataType:"content"}))),a&&a(x)})}loaded(){return this._loaded}hasTile(a){return!this.tileBounds||this.tileBounds.contains(a.canonical)}onAdd(a){this.map=a,this.load()}reload(){this.cancelTileJSONRequest();const a=l.ag(this.id,this.scope);this.load(()=>this.map.style.clearSource(a))}setTiles(a){return this._options.tiles=a,this.reload(),this}setUrl(a){return this.url=a,this._options.url=a,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return l.e({},this._options)}loadTile(a,d){const g=this.map._requestManager.normalizeTileURL(a.tileID.canonical.url(this.tiles,this.scheme)),x={request:this.map._requestManager.transformRequest(g,l.R.Tile),data:void 0,uid:a.uid,tileID:a.tileID,tileZoom:a.tileZoom,zoom:a.tileID.overscaledZ,tileSize:this.tileSize*a.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:l.f.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:a.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:a.isExtraShadowCaster};if(x.request.collectResourceTiming=this._collectResourceTiming,a.actor&&a.state!=="expired")a.state==="loading"?a.reloadCallback=d:a.request=a.actor.send("reloadTile",x,w.bind(this));else if(a.actor=this._tileWorkers[g]=this._tileWorkers[g]||this.dispatcher.getActor(),this.dispatcher.ready)a.request=a.actor.send("loadTile",x,w.bind(this),void 0,!0);else{const S=l.ah.call({deduped:this._deduped},x,(C,R)=>{C||!R?w.call(this,C):(x.data={cacheControl:R.cacheControl,expires:R.expires,rawData:R.rawData.slice(0)},a.actor&&a.actor.send("loadTile",x,w.bind(this),void 0,!0))},!0);a.request={cancel:S}}function w(S,C){return delete a.request,a.aborted?d(null):S&&S.status!==404?d(S):(C&&C.resourceTiming&&(a.resourceTiming=C.resourceTiming),this.map._refreshExpiredTiles&&C&&a.setExpiryData(C),a.loadVectorData(C,this.map.painter),l.ai(this.dispatcher),d(null),void(a.reloadCallback&&(this.loadTile(a,a.reloadCallback),a.reloadCallback=null)))}}abortTile(a){a.request&&(a.request.cancel(),delete a.request),a.actor&&a.actor.send("abortTile",{uid:a.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(a){a.actor&&a.actor.send("removeTile",{uid:a.uid,type:this.type,source:this.id,scope:this.scope}),a.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class kt extends l.E{constructor(a,d,g,x){super(),this.id=a,this.dispatcher=g,this.setEventedParent(x),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=l.e({type:"raster"},d),l.e(this,l.ac(d,["url","scheme","tileSize"]))}load(a){this._loaded=!1,this.fire(new l.b("dataloading",{dataType:"source"})),this._tileJSONRequest=St(this._options,this.map._requestManager,null,null,(d,g)=>{this._tileJSONRequest=null,this._loaded=!0,d?this.fire(new l.a(d)):g&&(l.e(this,g),g.bounds&&(this.tileBounds=new wt(g.bounds,this.minzoom,this.maxzoom)),l.aj(g.tiles),this.fire(new l.b("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new l.b("data",{dataType:"source",sourceDataType:"content"}))),a&&a(d)})}loaded(){return this._loaded}onAdd(a){this.map=a,this.load()}reload(){this.cancelTileJSONRequest();const a=l.ag(this.id,this.scope);this.load(()=>this.map.style.clearSource(a))}setTiles(a){return this._options.tiles=a,this.reload(),this}setUrl(a){return this.url=a,this._options.url=a,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return l.e({},this._options)}hasTile(a){return!this.tileBounds||this.tileBounds.contains(a.canonical)}loadTile(a,d){const g=l.f.devicePixelRatio>=2,x=this.map._requestManager.normalizeTileURL(a.tileID.canonical.url(this.tiles,this.scheme),g,this.tileSize);a.request=l.d(this.map._requestManager.transformRequest(x,l.R.Tile),(w,S,C,R)=>(delete a.request,a.aborted?(a.state="unloaded",d(null)):w?(a.state="errored",d(w)):S?(this.map._refreshExpiredTiles&&a.setExpiryData({cacheControl:C,expires:R}),a.setTexture(S,this.map.painter),a.state="loaded",l.ai(this.dispatcher),void d(null)):d(null)))}abortTile(a,d){a.request&&(a.request.cancel(),delete a.request),d()}unloadTile(a,d){a.texture&&a.texture instanceof l.T?(a.destroy(!0),a.texture&&a.texture instanceof l.T&&this.map.painter.saveTileTexture(a.texture)):a.destroy(),d()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class vt extends kt{constructor(a,d,g,x){super(a,d,g,x),this.type="raster-array",this.maxzoom=22,this._options=l.e({type:"raster-array"},d)}triggerRepaint(a){const d=this.map.painter._terrain,g=this.map.style.getSourceCache(this.id);d&&d.enabled&&g&&d._clearRenderCacheForTile(g.id,a.tileID),this.map.triggerRepaint()}loadTile(a,d){const g=this.map._requestManager.normalizeTileURL(a.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),x=this.map._requestManager.transformRequest(g,l.R.Tile);a.requestParams=x,a.actor||(a.actor=this.dispatcher.getActor()),a.request=a.fetchHeader(void 0,(w,S,C,R)=>{if(delete a.request,a.aborted)return a.state="unloaded",d(null);if(w)return w.code===20?void 0:(a.state="errored",d(w));this.map._refreshExpiredTiles&&a.setExpiryData({cacheControl:C,expires:R}),a.state="empty",d(null)})}unloadTile(a){const d=a.texture;d&&d instanceof l.T?(a.destroy(!0),this.map.painter.saveTileTexture(d)):(a.destroy(),a.flushQueues(),a._isHeaderLoaded=!1,delete a._mrt,delete a.textureDescriptor),a.fbo&&(a.fbo.destroy(),delete a.fbo),delete a.request,delete a.requestParams,delete a.neighboringTiles,a.state="unloaded"}prepareTile(a,d,g){a._isHeaderLoaded&&(a.state!=="empty"&&(a.state="reloading"),a.fetchBand(d,g,(x,w)=>{if(x)return a.state="errored",this.fire(new l.a(x)),void this.triggerRepaint(a);w&&(a.setTexture(w,this.map.painter),a.state="loaded",this.triggerRepaint(a))}))}getInitialBand(a){if(!this.rasterLayers)return 0;const d=this.rasterLayers.find(({id:w})=>w===a),g=d&&d.fields,x=g&&g.bands&&g.bands;return x?x[0]:0}getTextureDescriptor(a,d,g){if(!a)return;const x=d.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!x)return;let w=null;d instanceof l.an?w=d.paint.get("raster-array-band"):d instanceof l.ao&&(w=d.paint.get("raster-particle-array-band"));const S=w||this.getInitialBand(x);if(S!=null)if(a.textureDescriptor){if(!a.updateNeeded(x,S)||g)return Object.assign({},a.textureDescriptor,{texture:a.texture})}else this.prepareTile(a,x,S)}}const Ft=32,At=33,ui=new Uint16Array(8184);for(let _=0;_<2046;_++){let a=_+2,d=0,g=0,x=0,w=0,S=0,C=0;for(1&a?x=w=S=Ft:d=g=C=Ft;(a>>=1)>1;){const D=d+x>>1,N=g+w>>1;1&a?(x=d,w=g,d=S,g=C):(d=x,g=w,x=S,w=C),S=D,C=N}const R=4*_;ui[R+0]=d,ui[R+1]=g,ui[R+2]=x,ui[R+3]=w}const bi=new Uint16Array(2178),Gt=new Uint8Array(1089),hr=new Uint16Array(1089);function Lr(_){return _===0?-.03125:_===32?.03125:0}class Pr{constructor(a,d,g,x){this.id=Pr.uniqueIdxCounter,Pr.uniqueIdxCounter++,this.context=a;const w=a.gl;this.buffer=w.createBuffer(),this.dynamicDraw=!!g,this.context.unbindVAO(),a.bindElementBuffer.set(this.buffer),w.bufferData(w.ELEMENT_ARRAY_BUFFER,d.arrayBuffer,this.dynamicDraw?w.DYNAMIC_DRAW:w.STATIC_DRAW),this.dynamicDraw||x||d.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(a){this.id=Pr.uniqueIdxCounter,Pr.uniqueIdxCounter++;const d=this.context.gl;this.context.unbindVAO(),this.bind(),d.bufferSubData(d.ELEMENT_ARRAY_BUFFER,0,a.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}Pr.uniqueIdxCounter=0;const bn={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class jn{constructor(a,d,g,x,w,S){this.length=d.length,this.attributes=g,this.itemSize=d.bytesPerElement,this.dynamicDraw=x,this.instanceCount=S,this.context=a;const C=a.gl;this.buffer=C.createBuffer(),a.bindVertexBuffer.set(this.buffer),C.bufferData(C.ARRAY_BUFFER,d.arrayBuffer,this.dynamicDraw?C.DYNAMIC_DRAW:C.STATIC_DRAW),this.dynamicDraw||w||d.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(a){const d=this.context.gl;this.bind(),d.bufferSubData(d.ARRAY_BUFFER,0,a.arrayBuffer)}enableAttributes(a,d){for(let g=0;g<this.attributes.length;g++){const x=d.attributes[this.attributes[g].name];x!==void 0&&a.enableVertexAttribArray(x)}}setVertexAttribPointers(a,d,g){for(let x=0;x<this.attributes.length;x++){const w=this.attributes[x],S=d.attributes[w.name];S!==void 0&&a.vertexAttribPointer(S,w.components,a[bn[w.type]],!1,this.itemSize,w.offset+this.itemSize*(g||0))}}setVertexAttribDivisor(a,d,g){for(let x=0;x<this.attributes.length;x++){const w=d.attributes[this.attributes[x].name];w!==void 0&&this.instanceCount&&this.instanceCount>0&&a.vertexAttribDivisor(w,g)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class qi{constructor(a){this.gl=a.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(a){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class hn extends qi{getDefault(){return l.ax.transparent}set(a){const d=this.current;(a.r!==d.r||a.g!==d.g||a.b!==d.b||a.a!==d.a||this.dirty)&&(this.gl.clearColor(a.r,a.g,a.b,a.a),this.current=a,this.dirty=!1)}}class ss extends qi{getDefault(){return 1}set(a){(a!==this.current||this.dirty)&&(this.gl.clearDepth(a),this.current=a,this.dirty=!1)}}class sn extends qi{getDefault(){return 0}set(a){(a!==this.current||this.dirty)&&(this.gl.clearStencil(a),this.current=a,this.dirty=!1)}}class ws extends qi{getDefault(){return[!0,!0,!0,!0]}set(a){const d=this.current;(a[0]!==d[0]||a[1]!==d[1]||a[2]!==d[2]||a[3]!==d[3]||this.dirty)&&(this.gl.colorMask(a[0],a[1],a[2],a[3]),this.current=a,this.dirty=!1)}}class As extends qi{getDefault(){return!0}set(a){(a!==this.current||this.dirty)&&(this.gl.depthMask(a),this.current=a,this.dirty=!1)}}class hs extends qi{getDefault(){return 255}set(a){(a!==this.current||this.dirty)&&(this.gl.stencilMask(a),this.current=a,this.dirty=!1)}}class ks extends qi{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(a){const d=this.current;(a.func!==d.func||a.ref!==d.ref||a.mask!==d.mask||this.dirty)&&(this.gl.stencilFunc(a.func,a.ref,a.mask),this.current=a,this.dirty=!1)}}class lo extends qi{getDefault(){const a=this.gl;return[a.KEEP,a.KEEP,a.KEEP]}set(a){const d=this.current;(a[0]!==d[0]||a[1]!==d[1]||a[2]!==d[2]||this.dirty)&&(this.gl.stencilOp(a[0],a[1],a[2]),this.current=a,this.dirty=!1)}}class Ta extends qi{getDefault(){return!1}set(a){if(a===this.current&&!this.dirty)return;const d=this.gl;a?d.enable(d.STENCIL_TEST):d.disable(d.STENCIL_TEST),this.current=a,this.dirty=!1}}class eo extends qi{getDefault(){return[0,1]}set(a){const d=this.current;(a[0]!==d[0]||a[1]!==d[1]||this.dirty)&&(this.gl.depthRange(a[0],a[1]),this.current=a,this.dirty=!1)}}class Ms extends qi{getDefault(){return!1}set(a){if(a===this.current&&!this.dirty)return;const d=this.gl;a?d.enable(d.DEPTH_TEST):d.disable(d.DEPTH_TEST),this.current=a,this.dirty=!1}}class xo extends qi{getDefault(){return this.gl.LESS}set(a){(a!==this.current||this.dirty)&&(this.gl.depthFunc(a),this.current=a,this.dirty=!1)}}class Rt extends qi{getDefault(){return!1}set(a){if(a===this.current&&!this.dirty)return;const d=this.gl;a?d.enable(d.BLEND):d.disable(d.BLEND),this.current=a,this.dirty=!1}}class mi extends qi{getDefault(){const a=this.gl;return[a.ONE,a.ZERO,a.ONE,a.ZERO]}set(a){const d=this.current;(a[0]!==d[0]||a[1]!==d[1]||a[2]!==d[2]||a[3]!==d[3]||this.dirty)&&(this.gl.blendFuncSeparate(a[0],a[1],a[2],a[3]),this.current=a,this.dirty=!1)}}class rr extends qi{getDefault(){return l.ax.transparent}set(a){const d=this.current;(a.r!==d.r||a.g!==d.g||a.b!==d.b||a.a!==d.a||this.dirty)&&(this.gl.blendColor(a.r,a.g,a.b,a.a),this.current=a,this.dirty=!1)}}class zt extends qi{getDefault(){return this.gl.FUNC_ADD}set(a){(a!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(a,a),this.current=a,this.dirty=!1)}}class Qt extends qi{getDefault(){return!1}set(a){if(a===this.current&&!this.dirty)return;const d=this.gl;a?d.enable(d.CULL_FACE):d.disable(d.CULL_FACE),this.current=a,this.dirty=!1}}class Ut extends qi{getDefault(){return this.gl.BACK}set(a){(a!==this.current||this.dirty)&&(this.gl.cullFace(a),this.current=a,this.dirty=!1)}}class Pi extends qi{getDefault(){return this.gl.CCW}set(a){(a!==this.current||this.dirty)&&(this.gl.frontFace(a),this.current=a,this.dirty=!1)}}let dr=class extends qi{getDefault(){return null}set(_){(_!==this.current||this.dirty)&&(this.gl.useProgram(_),this.current=_,this.dirty=!1)}};class Sr extends qi{getDefault(){return this.gl.TEXTURE0}set(a){(a!==this.current||this.dirty)&&(this.gl.activeTexture(a),this.current=a,this.dirty=!1)}}class Qr extends qi{getDefault(){const a=this.gl;return[0,0,a.drawingBufferWidth,a.drawingBufferHeight]}set(a){const d=this.current;(a[0]!==d[0]||a[1]!==d[1]||a[2]!==d[2]||a[3]!==d[3]||this.dirty)&&(this.gl.viewport(a[0],a[1],a[2],a[3]),this.current=a,this.dirty=!1)}}class on extends qi{getDefault(){return null}set(a){if(a===this.current&&!this.dirty)return;const d=this.gl;d.bindFramebuffer(d.FRAMEBUFFER,a),this.current=a,this.dirty=!1}}class $n extends qi{getDefault(){return null}set(a){if(a===this.current&&!this.dirty)return;const d=this.gl;d.bindRenderbuffer(d.RENDERBUFFER,a),this.current=a,this.dirty=!1}}class ue extends qi{getDefault(){return null}set(a){if(a===this.current&&!this.dirty)return;const d=this.gl;d.bindTexture(d.TEXTURE_2D,a),this.current=a,this.dirty=!1}}class ge extends qi{getDefault(){return null}set(a){if(a===this.current&&!this.dirty)return;const d=this.gl;d.bindBuffer(d.ARRAY_BUFFER,a),this.current=a,this.dirty=!1}}class _e extends qi{getDefault(){return null}set(a){const d=this.gl;d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,a),this.current=a,this.dirty=!1}}class ze extends qi{getDefault(){return null}set(a){this.gl&&(a!==this.current||this.dirty)&&(this.gl.bindVertexArray(a),this.current=a,this.dirty=!1)}}class ft extends qi{getDefault(){return 4}set(a){if(a===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_ALIGNMENT,a),this.current=a,this.dirty=!1}}class ni extends qi{getDefault(){return!1}set(a){if(a===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a),this.current=a,this.dirty=!1}}class fr extends qi{getDefault(){return!1}set(a){if(a===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,a),this.current=a,this.dirty=!1}}class _i extends qi{constructor(a,d){super(a),this.context=a,this.parent=d}getDefault(){return null}}class Wn extends _i{setDirty(){this.dirty=!0}set(a){if(a===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,a,0),this.current=a,this.dirty=!1}}class Hn extends _i{attachment(){return this.gl.DEPTH_ATTACHMENT}set(a){if(a===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferRenderbuffer(d.FRAMEBUFFER,this.attachment(),d.RENDERBUFFER,a),this.current=a,this.dirty=!1}}class Cs extends _i{attachment(){return this.gl.DEPTH_ATTACHMENT}set(a){if(a===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferTexture2D(d.FRAMEBUFFER,this.attachment(),d.TEXTURE_2D,a,0),this.current=a,this.dirty=!1}}class js extends Hn{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class Nn{constructor(a,d,g,x,w){this.context=a,this.width=d,this.height=g;const S=this.framebuffer=a.gl.createFramebuffer();x&&(this.colorAttachment=new Wn(a,S)),w&&(this.depthAttachmentType=w,this.depthAttachment=w==="renderbuffer"?new Hn(a,S):new Cs(a,S))}destroy(){const a=this.context.gl;if(this.colorAttachment){const d=this.colorAttachment.get();d&&a.deleteTexture(d)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const d=this.depthAttachment.get();d&&a.deleteRenderbuffer(d)}else{const d=this.depthAttachment.get();d&&a.deleteTexture(d)}a.deleteFramebuffer(this.framebuffer)}}class li{constructor(a,d,g){this.func=a,this.mask=d,this.range=g}}li.ReadOnly=!1,li.ReadWrite=!0,li.disabled=new li(519,li.ReadOnly,[0,1]);const al=7680;class vi{constructor(a,d,g,x,w,S){this.test=a,this.ref=d,this.mask=g,this.fail=x,this.depthFail=w,this.pass=S}}vi.disabled=new vi({func:519,mask:0},0,0,al,al,al);const Ea=771;class Fi{constructor(a,d,g,x){this.blendFunction=a,this.blendColor=d,this.mask=g,this.blendEquation=x}}Fi.Replace=[1,0,1,0],Fi.disabled=new Fi(Fi.Replace,l.ax.transparent,[!1,!1,!1,!1]),Fi.unblended=new Fi(Fi.Replace,l.ax.transparent,[!0,!0,!0,!0]),Fi.alphaBlended=new Fi([1,Ea,1,Ea],l.ax.transparent,[!0,!0,!0,!0]),Fi.multiply=new Fi([774,0,774,0],l.ax.transparent,[!0,!0,!0,!0]);const Ul=1029,gs=2305;class ci{constructor(a,d,g){this.enable=a,this.mode=d,this.frontFace=g}}ci.disabled=new ci(!1,Ul,gs),ci.backCCW=new ci(!0,Ul,gs),ci.backCW=new ci(!0,Ul,2304),ci.frontCW=new ci(!0,1028,2304),ci.frontCCW=new ci(!0,1028,gs);class H_{constructor(a,d){this.gl=a,this.clearColor=new hn(this),this.clearDepth=new ss(this),this.clearStencil=new sn(this),this.colorMask=new ws(this),this.depthMask=new As(this),this.stencilMask=new hs(this),this.stencilFunc=new ks(this),this.stencilOp=new lo(this),this.stencilTest=new Ta(this),this.depthRange=new eo(this),this.depthTest=new Ms(this),this.depthFunc=new xo(this),this.blend=new Rt(this),this.blendFunc=new mi(this),this.blendColor=new rr(this),this.blendEquation=new zt(this),this.cullFace=new Qt(this),this.cullFaceSide=new Ut(this),this.frontFace=new Pi(this),this.program=new dr(this),this.activeTexture=new Sr(this),this.viewport=new Qr(this),this.bindFramebuffer=new on(this),this.bindRenderbuffer=new $n(this),this.bindTexture=new ue(this),this.bindVertexBuffer=new ge(this),this.bindElementBuffer=new _e(this),this.bindVertexArrayOES=new ze(this),this.pixelStoreUnpack=new ft(this),this.pixelStoreUnpackPremultiplyAlpha=new ni(this),this.pixelStoreUnpackFlipY=new fr(this),this.options=d?{...d}:{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=a.getExtension("EXT_texture_filter_anisotropic")||a.getExtension("MOZ_EXT_texture_filter_anisotropic")||a.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=a.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=a.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=a.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=a.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=a.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=a.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=a.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=a.getParameter(a.MAX_TEXTURE_SIZE),this.maxPointSize=a.getParameter(a.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(a,d,g){return new Pr(this,a,d,g)}createVertexBuffer(a,d,g,x,w){return new jn(this,a,d,g,x,w)}createRenderbuffer(a,d,g){const x=this.gl,w=x.createRenderbuffer();return this.bindRenderbuffer.set(w),x.renderbufferStorage(x.RENDERBUFFER,a,d,g),this.bindRenderbuffer.set(null),w}createFramebuffer(a,d,g,x){return new Nn(this,a,d,g,x)}clear({color:a,depth:d,stencil:g,colorMask:x}){const w=this.gl;let S=0;a&&(S|=w.COLOR_BUFFER_BIT,this.clearColor.set(a),this.colorMask.set(x||[!0,!0,!0,!0])),d!==void 0&&(S|=w.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(d),this.depthMask.set(!0)),g!==void 0&&(S|=w.STENCIL_BUFFER_BIT,this.clearStencil.set(g),this.stencilMask.set(255)),w.clear(S)}setCullFace(a){a.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(a.mode),this.frontFace.set(a.frontFace))}setDepthMode(a){a.func!==this.gl.ALWAYS||a.mask?(this.depthTest.set(!0),this.depthFunc.set(a.func),this.depthMask.set(a.mask),this.depthRange.set(a.range)):this.depthTest.set(!1)}setStencilMode(a){a.test.func!==this.gl.ALWAYS||a.mask?(this.stencilTest.set(!0),this.stencilMask.set(a.mask),this.stencilOp.set([a.fail,a.depthFail,a.pass]),this.stencilFunc.set({func:a.test.func,ref:a.ref,mask:a.test.mask})):this.stencilTest.set(!1)}setColorMode(a){A(a.blendFunction,Fi.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(a.blendFunction),this.blendColor.set(a.blendColor),a.blendEquation?this.blendEquation.set(a.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(a.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}var ll=l.ay([{name:"a_pos",type:"Float32",components:3}]);class qn{constructor(a,d,g,x){const w={width:g[0],height:g[1],data:null},S=a.gl;this.targetColorTexture=new l.T(a,w,S.RGBA,{useMipmap:!1}),this.backgroundColorTexture=new l.T(a,w,S.RGBA,{useMipmap:!1}),this.context=a,this.setNumParticles(d,x),this.lastInvalidatedAt=0}setNumParticles(a,d){if(this.numParticles===d)return;(this.particleVertices0||this.particleVertices1||this.particleSegment)&&(this.particleVertices0.destroy(),this.particleVertices1.destroy(),this.particleSegment.destroy());const g=new l.az;g.reserve(Math.round(d));const x=l.aA(a.key);for(let w=0;w<d;w++)g.emplaceBack(x(),x(),x());this.particleVertices0=this.context.createVertexBuffer(g,ll.members,!0),this.particleVertices1=this.context.createVertexBuffer(g,ll.members,!0),this.particleSegment=l.aB.simpleSegment(0,0,this.particleVertices0.length,0),this.numParticles=d}update(a){return!(this.lastInvalidatedAt<a&&(this.lastInvalidatedAt=l.f.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleVertices0.destroy(),this.particleVertices1.destroy(),this.particleSegment.destroy()}}const co={type:2,extent:l.V,loadGeometry:()=>[[new l.P(0,0),new l.P(l.V+1,0),new l.P(l.V+1,l.V+1),new l.P(0,l.V+1),new l.P(0,0)]]};class Sa{constructor(a,d,g,x,w){this.tileID=a,this.uid=l.aC(),this.uses=0,this.tileSize=d,this.tileZoom=g,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=w,x&&x.style&&(this._lastUpdatedBrightness=x.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",x&&x.transform&&(this.projection=x.transform.projection)}registerFadeDuration(a){const d=a+this.timeAdded;d<l.f.now()||this.fadeEndTime&&d<this.fadeEndTime||(this.fadeEndTime=d)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=l.as(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(a,d,g){if(this.unloadVectorData(),this.state="loaded",a){a.featureIndex&&(this.latestFeatureIndex=a.featureIndex,a.rawTileData?(this.latestRawTileData=a.rawTileData,this.latestFeatureIndex.rawTileData=a.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=a.collisionBoxArray,this.buckets=function(x,w){const S={};if(!w)return S;for(const C of x){const R=C.layerIds.map(D=>w.getLayer(D)).filter(Boolean);if(R.length!==0){C.layers=R,C.stateDependentLayerIds&&(C.stateDependentLayers=C.stateDependentLayerIds.map(D=>R.filter(N=>N.id===D)[0]));for(const D of R)S[D.fqid]=C}}return S}(a.buckets,d.style),this.hasSymbolBuckets=!1;for(const x in this.buckets){const w=this.buckets[x];if(w instanceof l.aE){if(this.hasSymbolBuckets=!0,!g)break;w.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const x in this.buckets){const w=this.buckets[x];if(w instanceof l.aE&&w.hasRTLText){this.hasRTLText=!0,l.aF();break}}this.queryPadding=0;for(const x in this.buckets){const w=this.buckets[x],S=d.style.getOwnLayer(x);if(!S)continue;const C=S.queryRadius(w);this.queryPadding=Math.max(this.queryPadding,C)}a.imageAtlas&&(this.imageAtlas=a.imageAtlas),a.glyphAtlasImage&&(this.glyphAtlasImage=a.glyphAtlasImage),a.lineAtlas&&(this.lineAtlas=a.lineAtlas),this._lastUpdatedBrightness=a.brightness}else this.collisionBoxArray=new l.aD}unloadVectorData(){if(this.hasData()){for(const a in this.buckets)this.buckets[a].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(a){return this.buckets[a.fqid]}upload(a){for(const x in this.buckets){const w=this.buckets[x];w.uploadPending()&&w.upload(a)}const d=a.gl,g=this.imageAtlas;if(g&&!g.uploaded){const x=!!Object.keys(g.patternPositions).length;this.imageAtlasTexture=new l.T(a,g.image,d.RGBA,{useMipmap:x}),this.imageAtlas.uploaded=!0}this.glyphAtlasImage&&(this.glyphAtlasTexture=new l.T(a,this.glyphAtlasImage,d.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new l.T(a,this.lineAtlas.image,d.R8),this.lineAtlas.uploaded=!0)}prepare(a,d,g){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(a,this.imageAtlasTexture,g),!d||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const x=d.style.getBrightness();(this._lastUpdatedBrightness||x)&&(this._lastUpdatedBrightness&&x&&Math.abs(this._lastUpdatedBrightness-x)<.001||(this._lastUpdatedBrightness=x,this.updateBuckets(void 0,d)))}queryRenderedFeatures(a,d,g,x,w,S,C,R){return this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)?this.latestFeatureIndex.query({tileResult:x,pixelPosMatrix:C,transform:S,params:w,tileTransform:this.tileTransform},a,d,g):{}}querySourceFeatures(a,d){const g=this.latestFeatureIndex;if(!g||!g.rawTileData)return;const x=g.loadVTLayers(),w=d?d.sourceLayer:"",S=x._geojsonTileLayer||x[w];if(!S)return;const C=l.aG(d&&d.filter),{z:R,x:D,y:N}=this.tileID.canonical,B={z:R,x:D,y:N};for(let j=0;j<S.length;j++){const $=S.feature(j);if(C.needGeometry){const K=l.aH($,!0);if(!C.filter(new l.K(this.tileID.overscaledZ),K,this.tileID.canonical))continue}else if(!C.filter(new l.K(this.tileID.overscaledZ),$))continue;const Z=g.getId($,w),X=new l.aI($,R,D,N,Z);X.tile=B,a.push(X)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}bucketsLoaded(){for(const a in this.buckets)if(this.buckets[a].uploadPending())return!1;return!0}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(a){const d=this.expirationTime;if(a.cacheControl){const g=l.aJ(a.cacheControl);g["max-age"]&&(this.expirationTime=Date.now()+1e3*g["max-age"])}else a.expires&&(this.expirationTime=new Date(a.expires).getTime());if(this.expirationTime){const g=Date.now();let x=!1;if(this.expirationTime>g)x=!1;else if(d)if(this.expirationTime<d)x=!0;else{const w=this.expirationTime-d;w?this.expirationTime=g+Math.max(w,3e4):x=!0}else x=!0;x?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(a,d){this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&Object.keys(a).length!==0&&d&&this.updateBuckets(a,d)}updateBuckets(a,d){if(!this.latestFeatureIndex)return;const g=this.latestFeatureIndex.loadVTLayers(),x=d.style.listImages(),w=d.style.getBrightness();for(const S in this.buckets){if(!d.style.hasLayer(S))continue;const C=this.buckets[S],R=C.layers[0].sourceLayer||"_geojsonTileLayer",D=g[R];let N={};if(a&&(N=a[R],!D||!N||Object.keys(N).length===0))continue;if(C.update(N,D,x,this.imageAtlas&&this.imageAtlas.patternPositions||{},w),C instanceof l.aK||C instanceof l.aL){const j=d.style.getOwnSourceCache(C.layers[0].source);d._terrain&&d._terrain.enabled&&j&&C.programConfigurations.needsUpload&&d._terrain._clearRenderCacheForTile(j.id,this.tileID)}const B=d&&d.style&&d.style.getOwnLayer(S);B&&(this.queryPadding=Math.max(this.queryPadding,B.queryRadius(C)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<l.f.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(a){this.symbolFadeHoldUntil=l.f.now()+a}setTexture(a,d){const g=d.context,x=g.gl;this.texture=this.texture||d.getTileTexture(a.width),this.texture&&this.texture instanceof l.T?this.texture.update(a,{useMipmap:!0}):(this.texture=new l.T(g,a,x.RGBA,{useMipmap:!0}),this.texture.bind(x.LINEAR,x.CLAMP_TO_EDGE))}setDependencies(a,d){const g={};for(const x of d)g[x]=!0;this.dependencies[a]=g}hasDependency(a,d){for(const g of a){const x=this.dependencies[g];if(x){for(const w of d)if(x[w])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(a,d){if(!d||d.name==="mercator"||this._tileDebugBuffer)return;const g=l.aM(co,this.tileID.canonical,this.tileTransform)[0],x=new l.aN,w=new l.aO;for(let S=0;S<g.length;S++){const{x:C,y:R}=g[S];x.emplaceBack(C,R),w.emplaceBack(S)}w.emplaceBack(0),this._tileDebugIndexBuffer=a.createIndexBuffer(w),this._tileDebugBuffer=a.createVertexBuffer(x,l.aP.members),this._tileDebugSegments=l.aB.simpleSegment(0,0,x.length,w.length)}_makeTileBoundsBuffers(a,d){if(this._tileBoundsBuffer||!d||d.name==="mercator")return;const g=l.aM(co,this.tileID.canonical,this.tileTransform)[0];let x,w;if(this.isRaster){const S=function(C,R){const D=l.as(C,R),N=Math.pow(2,C.z);for(let K=0;K<At;K++)for(let q=0;q<At;q++){const ee=l.at((C.x+(q+Lr(q))/Ft)/N),ae=l.au((C.y+(K+Lr(K))/Ft)/N),re=R.project(ee,ae),le=K*At+q;bi[2*le+0]=Math.round((re.x*D.scale-D.x)*l.V),bi[2*le+1]=Math.round((re.y*D.scale-D.y)*l.V)}Gt.fill(0),hr.fill(0);for(let K=2045;K>=0;K--){const q=4*K,ee=ui[q+0],ae=ui[q+1],re=ui[q+2],le=ui[q+3],Q=ee+re>>1,ce=ae+le>>1,ve=Q+ce-ae,we=ce+ee-Q,Ce=ae*At+ee,Ue=le*At+re,Re=ce*At+Q,Ye=Math.hypot((bi[2*Ce+0]+bi[2*Ue+0])/2-bi[2*Re+0],(bi[2*Ce+1]+bi[2*Ue+1])/2-bi[2*Re+1])>=16;Gt[Re]=Gt[Re]||(Ye?1:0),K<1022&&(Gt[Re]=Gt[Re]||Gt[(ae+we>>1)*At+(ee+ve>>1)]||Gt[(le+we>>1)*At+(re+ve>>1)])}const B=new l.av,j=new l.aw;let $=0;function Z(K,q){const ee=q*At+K;return hr[ee]===0&&(B.emplaceBack(bi[2*ee+0],bi[2*ee+1],K*l.V/Ft,q*l.V/Ft),hr[ee]=++$),hr[ee]-1}function X(K,q,ee,ae,re,le){const Q=K+ee>>1,ce=q+ae>>1;if(Math.abs(K-re)+Math.abs(q-le)>1&&Gt[ce*At+Q])X(re,le,K,q,Q,ce),X(ee,ae,re,le,Q,ce);else{const ve=Z(K,q),we=Z(ee,ae),Ce=Z(re,le);j.emplaceBack(ve,we,Ce)}}return X(0,0,Ft,Ft,Ft,0),X(Ft,Ft,0,0,0,Ft),{vertices:B,indices:j}}(this.tileID.canonical,d);x=S.vertices,w=S.indices}else{x=new l.av,w=new l.aw;for(const{x:C,y:R}of g)x.emplaceBack(C,R,0,0);const S=l.aQ(x.int16,void 0,4);for(let C=0;C<S.length;C+=3)w.emplaceBack(S[C],S[C+1],S[C+2])}this._tileBoundsBuffer=a.createVertexBuffer(x,l.aR.members),this._tileBoundsIndexBuffer=a.createIndexBuffer(w),this._tileBoundsSegments=l.aB.simpleSegment(0,0,x.length,w.length)}_makeGlobeTileDebugBuffers(a,d){const g=d.projection;if(!g||g.name!=="globe"||d.freezeTileCoverage)return;const x=this.tileID.canonical,w=l.aS(x,d),S=l.aT(w),C=l.S(d.zoom);let R;C>0&&(R=l.a6.invert(new Float64Array(16),d.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(a,x,d,S,R,C),this._makeGlobeTileDebugTextBuffer(a,x,d,S,R,C)}_globePoint(a,d,g,x,w,S,C){let R=l.aU(a,d,g);if(S){const D=1<<g.z,N=l.a5(x.center.lng),B=l.ae(x.center.lat),j=(g.x+.5)/D-N;let $=0;j>.5?$=-1:j<-.5&&($=1);let Z=(a/l.V+g.x)/D+$,X=(d/l.V+g.y)/D;Z=(Z-N)*x._pixelsPerMercatorPixel+N,X=(X-B)*x._pixelsPerMercatorPixel+B;const K=[Z*x.worldSize,X*x.worldSize,0];l.N.transformMat4(K,K,S),R=l.aV(R,K,C)}return l.N.transformMat4(R,R,w)}_makeGlobeTileDebugBorderBuffer(a,d,g,x,w,S){const C=new l.aN,R=new l.aO,D=new l.aW,N=(j,$,Z,X,K)=>{const q=(Z-j)/(K-1),ee=(X-$)/(K-1),ae=C.length;for(let re=0;re<K;re++){const le=j+re*q,Q=$+re*ee;C.emplaceBack(le,Q);const ce=this._globePoint(le,Q,d,g,x,w,S);D.emplaceBack(ce[0],ce[1],ce[2]),R.emplaceBack(ae+re)}},B=l.V;N(0,0,B,0,16),N(B,0,B,B,16),N(B,B,0,B,16),N(0,B,0,0,16),this._tileDebugIndexBuffer=a.createIndexBuffer(R),this._tileDebugBuffer=a.createVertexBuffer(C,l.aP.members),this._globeTileDebugBorderBuffer=a.createVertexBuffer(D,l.aX.members),this._tileDebugSegments=l.aB.simpleSegment(0,0,C.length,R.length)}_makeGlobeTileDebugTextBuffer(a,d,g,x,w,S){const C=l.V/4,R=new l.aN,D=new l.aw,N=new l.aW,B=25;D.reserve(32),R.reserve(B),N.reserve(B);const j=($,Z)=>B*$+Z;for(let $=0;$<B;$++){const Z=$*C;for(let X=0;X<B;X++){const K=X*C;R.emplaceBack(K,Z);const q=this._globePoint(K,Z,d,g,x,w,S);N.emplaceBack(q[0],q[1],q[2])}}for(let $=0;$<4;$++)for(let Z=0;Z<4;Z++){const X=j($,Z),K=j($,Z+1),q=j($+1,Z),ee=j($+1,Z+1);D.emplaceBack(X,K,q),D.emplaceBack(q,K,ee)}this._tileDebugTextIndexBuffer=a.createIndexBuffer(D),this._tileDebugTextBuffer=a.createVertexBuffer(R,l.aP.members),this._globeTileDebugTextBuffer=a.createVertexBuffer(N,l.aX.members),this._tileDebugTextSegments=l.aB.simpleSegment(0,0,B,32)}destroy(a=!1){for(const d in this.buckets)this.buckets[d].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!a&&this.texture&&this.texture instanceof l.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}const Jo={vector:Dt,raster:kt,"raster-dem":class extends kt{constructor(_,a,d,g){super(_,a,d,g),this.type="raster-dem",this.maxzoom=22,this._options=l.e({type:"raster-dem"},a),this.encoding=a.encoding||"mapbox"}loadTile(_,a){const d=this.map._requestManager.normalizeTileURL(_.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function g(x,w){x&&(_.state="errored",a(x)),w&&(_.dem=w,_.dem.onDeserialize(),_.needsHillshadePrepare=!0,_.needsDEMTextureUpload=!0,_.state="loaded",a(null))}_.request=l.d(this.map._requestManager.transformRequest(d,l.R.Tile),(function(x,w,S,C){if(delete _.request,_.aborted)_.state="unloaded",a(null);else if(x)_.state="errored",a(x);else if(w){this.map._refreshExpiredTiles&&_.setExpiryData({cacheControl:S,expires:C});const R=ImageBitmap&&w instanceof ImageBitmap&&l.ak(),D=1-(w.width-l.al(w.width))/2;D<1||_.neighboringTiles||(_.neighboringTiles=this._getNeighboringTiles(_.tileID));const N=R?w:l.f.getImageData(w,D),B={uid:_.uid,coord:_.tileID,source:this.id,scope:this.scope,rawImageData:N,encoding:this.encoding,padding:D};_.actor&&_.state!=="expired"||(_.actor=this.dispatcher.getActor(),_.actor.send("loadDEMTile",B,g.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(_){const a=_.canonical,d=Math.pow(2,a.z),g=(a.x-1+d)%d,x=a.x===0?_.wrap-1:_.wrap,w=(a.x+1+d)%d,S=a.x+1===d?_.wrap+1:_.wrap,C={};return C[new l.am(_.overscaledZ,x,a.z,g,a.y).key]={backfilled:!1},C[new l.am(_.overscaledZ,S,a.z,w,a.y).key]={backfilled:!1},a.y>0&&(C[new l.am(_.overscaledZ,x,a.z,g,a.y-1).key]={backfilled:!1},C[new l.am(_.overscaledZ,_.wrap,a.z,a.x,a.y-1).key]={backfilled:!1},C[new l.am(_.overscaledZ,S,a.z,w,a.y-1).key]={backfilled:!1}),a.y+1<d&&(C[new l.am(_.overscaledZ,x,a.z,g,a.y+1).key]={backfilled:!1},C[new l.am(_.overscaledZ,_.wrap,a.z,a.x,a.y+1).key]={backfilled:!1},C[new l.am(_.overscaledZ,S,a.z,w,a.y+1).key]={backfilled:!1}),C}},"raster-array":vt,geojson:class extends l.E{constructor(_,a,d,g){super(),this.id=_,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=d.getActor(),this.setEventedParent(g),this._data=a.data,this._options=l.e({},a),this._collectResourceTiming=a.collectResourceTiming,a.maxzoom!==void 0&&(this.maxzoom=a.maxzoom),a.type&&(this.type=a.type),a.attribution&&(this.attribution=a.attribution),this.promoteId=a.promoteId;const x=l.V/this.tileSize;this.workerOptions=l.e({source:this.id,scope:this.scope,cluster:a.cluster||!1,geojsonVtOptions:{buffer:(a.buffer!==void 0?a.buffer:128)*x,tolerance:(a.tolerance!==void 0?a.tolerance:.375)*x,extent:l.V,maxZoom:this.maxzoom,lineMetrics:a.lineMetrics||!1,generateId:a.generateId||!1},superclusterOptions:{maxZoom:a.clusterMaxZoom!==void 0?a.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,a.clusterMinPoints||2),extent:l.V,radius:(a.clusterRadius!==void 0?a.clusterRadius:50)*x,log:!1,generateId:a.generateId||!1},clusterProperties:a.clusterProperties,filter:a.filter},a.workerOptions)}onAdd(_){this.map=_,this.setData(this._data)}setData(_){return this._data=_,this._updateWorkerData(),this}getClusterExpansionZoom(_,a){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:_,source:this.id,scope:this.scope},a),this}getClusterChildren(_,a){return this.actor.send("geojson.getClusterChildren",{clusterId:_,source:this.id,scope:this.scope},a),this}getClusterLeaves(_,a,d,g){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:_,limit:a,offset:d},g),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new l.b("dataloading",{dataType:"source"})),this._loaded=!1;const _=l.e({},this.workerOptions);_.scope=this.scope;const a=this._data;typeof a=="string"?(_.request=this.map._requestManager.transformRequest(l.f.resolveURL(a),l.R.Source),_.request.collectResourceTiming=this._collectResourceTiming):_.data=JSON.stringify(a),this._pendingLoad=this.actor.send(`${this.type}.loadData`,_,(d,g)=>{if(this._loaded=!0,this._pendingLoad=null,d)this.fire(new l.a(d));else{const x={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&g&&g.resourceTiming&&g.resourceTiming[this.id]&&(x.resourceTiming=g.resourceTiming[this.id]),this.fire(new l.b("data",x)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(_,a){const d=_.actor?"reloadTile":"loadTile";_.actor=this.actor;const g={type:this.type,uid:_.uid,tileID:_.tileID,tileZoom:_.tileZoom,zoom:_.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,scope:this.scope,pixelRatio:l.f.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0};_.request=this.actor.send(d,g,(x,w)=>(delete _.request,_.destroy(),_.aborted?a(null):x?a(x):(_.loadVectorData(w,this.map.painter,d==="reloadTile"),a(null))),void 0,d==="loadTile")}abortTile(_){_.request&&(_.request.cancel(),delete _.request),_.aborted=!0}unloadTile(_){this.actor.send("removeTile",{uid:_.uid,type:this.type,source:this.id,scope:this.scope}),_.destroy()}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return l.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends l.ap{constructor(_,a,d,g){super(_,a,d,g),this.roundZoom=!0,this.type="video",this.options=a}load(){this._loaded=!1;const _=this.options;this.urls=[];for(const a of _.urls)this.urls.push(this.map._requestManager.transformRequest(a,l.R.Source).url);l.aq(this.urls,(a,d)=>{this._loaded=!0,a?this.fire(new l.a(a)):d&&(this.video=d,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(_){if(this.video){const a=this.video.seekable;_<a.start(0)||_>a.end(0)?this.fire(new l.a(new Ie(`sources.${this.id}`,null,`Playback for this video can be set only between the ${a.start(0)} and ${a.end(0)}-second mark.`))):this.video.currentTime=_}}getVideo(){return this.video}onAdd(_){this.map||(this.map=_,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const _=this.map.painter.context,a=_.gl;this.texture?this.video.paused||(this.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE),a.texSubImage2D(a.TEXTURE_2D,0,0,0,a.RGBA,a.UNSIGNED_BYTE,this.video)):(this.texture=new l.T(_,this.video,a.RGBA),this.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(_)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:l.ap,model:class extends l.E{constructor(_,a,d,g){super(),this.id=_,this.type="model",this.models=[],this._loaded=!1,this._options=a}load(){const _=[];for(const a in this._options.models){const d=this._options.models[a],g=l.l(this.map._requestManager.transformRequest(d.uri,l.R.Model).url).then(x=>{if(!x)return;const w=l.c(x),S=new l.M(a,d.position,d.orientation,w);S.computeBoundsAndApplyParent(),this.models.push(S)}).catch(x=>{this.fire(new l.a(new Error(`Could not load model ${a} from ${d.uri}: ${x.message}`)))});_.push(g)}return Promise.allSettled(_).then(()=>{this._loaded=!0,this.fire(new l.b("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(a=>{this.fire(new l.a(new Error(`Could not load models: ${a.message}`)))})}onAdd(_){this.map=_,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(_,a){}serialize(){return{type:"model"}}},"batched-model":class extends l.E{constructor(_,a,d,g){super(),this.type="batched-model",this.id=_,this.tileSize=512,this._options=a,this.tiles=this._options.tiles,this.maxzoom=a.maxzoom||19,this.minzoom=a.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=d,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(g)}onAdd(_){this.map=_,this.load()}load(_){this._loaded=!1,this.fire(new l.b("dataloading",{dataType:"source"}));const a=Array.isArray(this.map._language)?this.map._language.join():this.map._language,d=this.map._worldview;this._tileJSONRequest=St(this._options,this.map._requestManager,a,d,(g,x)=>{this._tileJSONRequest=null,this._loaded=!0,g?(a&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${a}`),d&&d.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${d}`),this.fire(new l.a(g))):x&&(l.e(this,x),x.bounds&&(this.tileBounds=new wt(x.bounds,this.minzoom,this.maxzoom)),l.aj(x.tiles,this.map._requestManager._customAccessToken),this.fire(new l.b("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new l.b("data",{dataType:"source",sourceDataType:"content"}))),_&&_(g)})}hasTransition(){return!1}hasTile(_){return!this.tileBounds||this.tileBounds.contains(_.canonical)}loaded(){return this._loaded}loadTile(_,a){const d=this.map._requestManager.normalizeTileURL(_.tileID.canonical.url(this.tiles,this.scheme)),g={request:this.map._requestManager.transformRequest(d,l.R.Tile),data:void 0,uid:_.uid,tileID:_.tileID,tileZoom:_.tileZoom,zoom:_.tileID.overscaledZ,tileSize:this.tileSize*_.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:_.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(_.actor&&_.state!=="expired")if(_.state==="loading")_.reloadCallback=a;else{if(_.buckets){const w=Object.values(_.buckets);for(const S of w)S.dirty=!0;return void(_.state="loaded")}_.request=_.actor.send("reloadTile",g,x.bind(this))}else _.actor=this.dispatcher.getActor(),_.request=_.actor.send("loadTile",g,x.bind(this),void 0,!0);function x(w,S){return _.aborted?a(null):w&&w.status!==404?a(w):(S&&(S.resourceTiming&&(_.resourceTiming=S.resourceTiming),this.map._refreshExpiredTiles&&_.setExpiryData(S),_.buckets={..._.buckets,...S.buckets},S.featureIndex&&(_.latestFeatureIndex=S.featureIndex)),_.state="loaded",void a(null))}}serialize(){return l.e({},this._options)}},canvas:class extends l.ap{constructor(_,a,d,g){super(_,a,d,g),a.coordinates?Array.isArray(a.coordinates)&&a.coordinates.length===4&&!a.coordinates.some(x=>!Array.isArray(x)||x.length!==2||x.some(w=>typeof w!="number"))||this.fire(new l.a(new Ie(`sources.${_}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new l.a(new Ie(`sources.${_}`,null,'missing required property "coordinates"'))),a.animate&&typeof a.animate!="boolean"&&this.fire(new l.a(new Ie(`sources.${_}`,null,'optional "animate" property must be a boolean value'))),a.canvas?typeof a.canvas=="string"||a.canvas instanceof HTMLCanvasElement||this.fire(new l.a(new Ie(`sources.${_}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new l.a(new Ie(`sources.${_}`,null,'missing required property "canvas"'))),this.options=a,this.animate=a.animate===void 0||a.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new l.a(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(_){this.map=_,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let _=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,_=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,_=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const a=this.map.painter.context;this.texture?!_&&!this._playing||this.texture instanceof l.ar||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new l.T(a,this.canvas,a.gl.RGBA,{premultiply:!0}),this._prepareData(a)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const _ of[this.canvas.width,this.canvas.height])if(isNaN(_)||_<=0)return!0;return!1}},custom:class extends l.E{constructor(_,a,d,g){super(),this.id=_,this.type="custom",this._dataType="raster",this._dispatcher=d,this._implementation=a,this.setEventedParent(g),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new l.a(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new l.a(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new wt(this._implementation.bounds,this.minzoom,this.maxzoom)),a.update=this._update.bind(this),a.clearTiles=this._clearTiles.bind(this),a.coveringTiles=this._coveringTiles.bind(this),l.e(this,l.ac(a,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return l.ac(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new l.b("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new l.b("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(_){this._map=_,this._loaded=!1,this.fire(new l.b("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(_),this.load()}onRemove(_){this._implementation.onRemove&&this._implementation.onRemove(_)}hasTile(_){if(this._implementation.hasTile){const{x:a,y:d,z:g}=_.canonical;return this._implementation.hasTile({x:a,y:d,z:g})}return!this.tileBounds||this.tileBounds.contains(_.canonical)}loadTile(_,a){const{x:d,y:g,z:x}=_.tileID.canonical,w=new AbortController;_.request=Promise.resolve(this._implementation.loadTile({x:d,y:g,z:x},{signal:w.signal})).then((function(S){return delete _.request,_.aborted?(_.state="unloaded",a(null)):S===void 0?(_.state="errored",a(null)):S===null?(this.loadTileData(_,{width:this.tileSize,height:this.tileSize,data:null}),_.state="loaded",a(null)):function(C){return C instanceof ImageData||C instanceof HTMLCanvasElement||C instanceof ImageBitmap||C instanceof HTMLImageElement}(S)?(this.loadTileData(_,S),_.state="loaded",void a(null)):(_.state="errored",a(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(S=>{S.code!==20&&(_.state="errored",a(S))}),_.request.cancel=()=>w.abort()}loadTileData(_,a){_.setTexture(a,this._map.painter)}unloadTile(_,a){if(_.texture&&_.texture instanceof l.T?(_.destroy(!0),_.texture&&_.texture instanceof l.T&&this._map.painter.saveTileTexture(_.texture)):_.destroy(),this._implementation.unloadTile){const{x:d,y:g,z:x}=_.tileID.canonical;this._implementation.unloadTile({x:d,y:g,z:x})}a()}abortTile(_,a){_.request&&_.request.cancel&&(_.request.cancel(),delete _.request),a()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(_=>({x:_.canonical.x,y:_.canonical.y,z:_.canonical.z}))}_clearTiles(){const _=l.ag(this.id,this.scope);this._map.style.clearSource(_)}_update(){this.fire(new l.b("data",{dataType:"source",sourceDataType:"content"}))}}},Gn=function(_,a,d,g){const x=new Jo[a.type](_,a,d,g);if(x.id!==_)throw new Error(`Expected Source id to be ${_} instead of ${x.id}`);return l.aY(["load","abort","unload","serialize","prepare"],x),x};function Lf(_,a){const d=l.a6.identity([]);return l.a6.scale(d,d,[.5*_.width,.5*-_.height,1]),l.a6.translate(d,d,[1,-1,0]),l.a6.multiply(d,d,_.calculateProjMatrix(a.toUnwrapped())),Float32Array.from(d)}function Nf(_,a,d,g,x,w,S,C=!1){const R=_.tilesIn(g,S,C);R.sort(Vl);const D=[];for(const B of R)D.push({wrappedTileID:B.tile.tileID.wrapped().key,queryResults:B.tile.queryRenderedFeatures(a,d,_._state,B,x,w,Lf(_.transform,B.tile.tileID),C)});const N=function(B){const j={},$={};for(const Z of B){const X=Z.queryResults,K=Z.wrappedTileID,q=$[K]=$[K]||{};for(const ee in X){const ae=X[ee],re=q[ee]=q[ee]||{},le=j[ee]=j[ee]||[];for(const Q of ae)re[Q.featureIndex]||(re[Q.featureIndex]=!0,le.push(Q))}}return j}(D);for(const B in N)N[B].forEach(j=>{const $=j.feature,Z=$.layer;Z&&Z.type!=="background"&&Z.type!=="sky"&&Z.type!=="slot"&&($.source=Z.source,Z["source-layer"]&&($.sourceLayer=Z["source-layer"]),$.state=$.id!==void 0?_.getFeatureState(Z["source-layer"],$.id):{})});return N}function Qo(_,a){const d=_.getRenderableIds().map(w=>_.getTileByID(w)),g=[],x={};for(let w=0;w<d.length;w++){const S=d[w],C=S.tileID.canonical.key;x[C]||(x[C]=!0,S.querySourceFeatures(g,a))}return g}function Vl(_,a){const d=_.tileID,g=a.tileID;return d.overscaledZ-g.overscaledZ||d.canonical.y-g.canonical.y||d.wrap-g.wrap||d.canonical.x-g.canonical.x}class cl extends Sa{constructor(a,d,g,x,w){super(a,d,g,x,w),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}setTexture(a,d){const g=d.context,x=g.gl;this.texture=this.texture||d.getTileTexture(a.width),this.texture&&this.texture instanceof l.T?this.texture.update(a,{useMipmap:!1,premultiply:!1}):this.texture=new l.T(g,a,x.RGBA,{useMipmap:!1,premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(a=16384,d){const g=this._mrt=new l.aZ(30),x=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(a-1)}});return this.entireBuffer=null,this.request=l.a_(x,(w,S,C,R)=>{if(w)d(w);else try{const D=g.getHeaderLength(S);if(D>a)return void(this.request=this.fetchHeader(D,d));g.parseHeader(S),this._isHeaderLoaded=!0;let N=0;for(const B of Object.values(g.layers))N=Math.max(N,B.dataIndex[B.dataIndex.length-1].last_byte);S.byteLength>=N&&(this.entireBuffer=S),d(null,this.entireBuffer||S,C,R)}catch(D){d(D)}}),this.request}fetchBand(a,d,g){const x=this._mrt;if(!this._isHeaderLoaded||!x)return void g(new Error("Tile header is not ready"));const w=this.actor;if(!w)return void g(new Error("Can't fetch tile band without an actor"));let S;const C=(B,j)=>{S.complete(B,j),B?g(B):(this.updateTextureDescriptor(a,d),g(null,this.textureDescriptor&&this.textureDescriptor.img))},R=(B,j)=>{if(B)return g(B);const $=w.send("decodeRasterArray",{buffer:j,task:S},C,void 0,!0);this._workQueue.push(()=>{$&&$.cancel(),S.cancel()})},D=x.getLayer(a);if(!D)return void g(new Error(`Unknown sourceLayer "${a}"`));if(D.hasDataForBand(d))return this.updateTextureDescriptor(a,d),void g(null,this.textureDescriptor?this.textureDescriptor.img:null);const N=D.getDataRange([d]);if(S=x.createDecodingTask(N),!S||S.tasks.length)if(this.flushQueues(),this.entireBuffer)R(null,this.entireBuffer.slice(N.firstByte,N.lastByte+1));else{const B=Object.assign({},this.requestParams,{headers:{Range:`bytes=${N.firstByte}-${N.lastByte}`}}),j=l.a_(B,R);this._fetchQueue.push(()=>{j.cancel(),S.cancel()})}else g(null)}updateNeeded(a,d){return(!this.textureDescriptor||this.textureDescriptor.band!==d||this.textureDescriptor.layer!==a)&&this.state!=="errored"}updateTextureDescriptor(a,d){if(!this._mrt)return;const g=this._mrt.getLayer(a);if(!g||!g.hasBand(d)||!g.hasDataForBand(d))return;const{bytes:x,tileSize:w,buffer:S,offset:C,scale:R}=g.getBandView(d),D=w+2*S,N={data:x,width:D,height:D},B=this.texture;B&&B instanceof l.T&&B.update(N,{useMipmap:!1,premultiply:!1}),this.textureDescriptor={layer:a,band:d,img:N,buffer:S,offset:C,tileSize:w,format:g.pixelFormat,mix:[R,256*R,65536*R,16777216*R]}}}class jl{constructor(a,d){this.max=a,this.onRemove=d,this.reset()}reset(){for(const a in this.data)for(const d of this.data[a])d.timeout&&clearTimeout(d.timeout),this.onRemove(d.value);return this.data={},this.order=[],this}add(a,d,g){const x=a.wrapped().key;this.data[x]===void 0&&(this.data[x]=[]);const w={value:d,timeout:void 0};if(g!==void 0&&(w.timeout=setTimeout(()=>{this.remove(a,w)},g)),this.data[x].push(w),this.order.push(x),this.order.length>this.max){const S=this._getAndRemoveByKey(this.order[0]);S&&this.onRemove(S)}return this}has(a){return a.wrapped().key in this.data}getAndRemove(a){return this.has(a)?this._getAndRemoveByKey(a.wrapped().key):null}_getAndRemoveByKey(a){const d=this.data[a].shift();return d.timeout&&clearTimeout(d.timeout),this.data[a].length===0&&delete this.data[a],this.order.splice(this.order.indexOf(a),1),d.value}getByKey(a){const d=this.data[a];return d?d[0].value:null}get(a){return this.has(a)?this.data[a.wrapped().key][0].value:null}remove(a,d){if(!this.has(a))return this;const g=a.wrapped().key,x=d===void 0?0:this.data[g].indexOf(d),w=this.data[g][x];return this.data[g].splice(x,1),w.timeout&&clearTimeout(w.timeout),this.data[g].length===0&&delete this.data[g],this.onRemove(w.value),this.order.splice(this.order.indexOf(g),1),this}setMaxSize(a){for(this.max=a;this.order.length>this.max;){const d=this._getAndRemoveByKey(this.order[0]);d&&this.onRemove(d)}return this}filter(a){const d=[];for(const g in this.data)for(const x of this.data[g])a(x.value)||d.push(x);for(const g of d)this.remove(g.value.tileID,g)}}class bo extends l.E{constructor(a,d,g){super(),this.id=a,this._onlySymbols=g,d.on("data",x=>{x.dataType==="source"&&x.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&x.dataType==="source"&&x.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),d.on("error",()=>{this._sourceErrored=!0}),this._source=d,this._tiles={},this._cache=new jl(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=d.minTileCacheSize,this._maxTileCacheSize=d.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Qe,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(a){this.map=a,this._minTileCacheSize=this._minTileCacheSize===void 0&&a?a._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&a?a._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const a in this._tiles){const d=this._tiles[a];if(d.state!=="errored"&&(d.state!=="loaded"||!d.bucketsLoaded()))return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const a=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,a&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(a,d){return a.isSymbolTile=this._onlySymbols,a.isExtraShadowCaster=this._shadowCasterTiles[a.tileID.key],this._source.loadTile(a,d)}_unloadTile(a){if(this._source.unloadTile)return this._source.unloadTile(a,()=>{})}_abortTile(a){if(this._source.abortTile)return this._source.abortTile(a,()=>{})}serialize(){return this._source.serialize()}prepare(a){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const d in this._tiles){const g=this._tiles[d];g.upload(a),g.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return l.a$(this._tiles).map(a=>a.tileID).sort(kh).map(a=>a.key)}getRenderableIds(a,d){const g=[];for(const x in this._tiles)this._isIdRenderable(+x,a,d)&&g.push(this._tiles[x]);return a?g.sort((x,w)=>{const S=x.tileID,C=w.tileID,R=new l.P(S.canonical.x,S.canonical.y)._rotate(this.transform.angle),D=new l.P(C.canonical.x,C.canonical.y)._rotate(this.transform.angle);return S.overscaledZ-C.overscaledZ||D.y-R.y||D.x-R.x}).map(x=>x.tileID.key):g.map(x=>x.tileID).sort(kh).map(x=>x.key)}hasRenderableParent(a){const d=this.findLoadedParent(a,0);return!!d&&this._isIdRenderable(d.tileID.key)}_isIdRenderable(a,d,g){return this._tiles[a]&&this._tiles[a].hasData()&&!this._coveredTiles[a]&&(d||!this._tiles[a].holdingForFade())&&(g||!this._shadowCasterTiles[a])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const a in this._tiles)this._tiles[a].state!=="errored"&&this._reloadTile(+a,"reloading")}}_reloadTile(a,d){const g=this._tiles[a];g&&(g.state!=="loading"&&(g.state=d),this._loadTile(g,this._tileLoaded.bind(this,g,a,d)))}_tileLoaded(a,d,g,x){if(x)if(a.state="errored",x.status!==404)this._source.fire(new l.a(x,{tile:a}));else{if(!(a.tileID.key in this._loadedParentTiles))return void this._source.fire(new l.b("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id}));if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const w=this.map.painter.terrain;this.update(this.transform,w.getScaledDemTileSize(),!0),w.resetTileLookupCache(this.id)}else this.update(this.transform)}else a.timeAdded=l.f.now(),g==="expired"&&(a.refreshedUponExpiration=!0),this._setTileReloadTimer(d,a),this._source.type==="raster-dem"&&a.dem&&this._backfillDEM(a),this._state.initializeTileState(a,this.map?this.map.painter:null),this._source.fire(new l.b("data",{dataType:"source",tile:a,coord:a.tileID,sourceCacheId:this.id}))}_backfillDEM(a){const d=this.getRenderableIds();for(let x=0;x<d.length;x++){const w=d[x];if(a.neighboringTiles&&a.neighboringTiles[w]){const S=this.getTileByID(w);g(a,S),g(S,a)}}function g(x,w){if(!x.dem||x.dem.borderReady)return;x.needsHillshadePrepare=!0,x.needsDEMTextureUpload=!0;let S=w.tileID.canonical.x-x.tileID.canonical.x;const C=w.tileID.canonical.y-x.tileID.canonical.y,R=Math.pow(2,x.tileID.canonical.z),D=w.tileID.key;S===0&&C===0||Math.abs(C)>1||(Math.abs(S)>1&&(Math.abs(S+R)===1?S+=R:Math.abs(S-R)===1&&(S-=R)),w.dem&&x.dem&&(x.dem.backfillBorder(w.dem,S,C),x.neighboringTiles&&x.neighboringTiles[D]&&(x.neighboringTiles[D].backfilled=!0)))}}getTile(a){return this.getTileByID(a.key)}getTileByID(a){return this._tiles[a]}_retainLoadedChildren(a,d,g,x){for(const w in this._tiles){let S=this._tiles[w];if(x[w]||!S.hasData()||S.tileID.overscaledZ<=d||S.tileID.overscaledZ>g)continue;let C=S.tileID;for(;S&&S.tileID.overscaledZ>d+1;){const D=S.tileID.scaledTo(S.tileID.overscaledZ-1);S=this._tiles[D.key],S&&S.hasData()&&(C=D)}let R=C;for(;R.overscaledZ>d;)if(R=R.scaledTo(R.overscaledZ-1),a[R.key]){x[C.key]=C;break}}}findLoadedParent(a,d){if(a.key in this._loadedParentTiles){const g=this._loadedParentTiles[a.key];return g&&g.tileID.overscaledZ>=d?g:null}for(let g=a.overscaledZ-1;g>=d;g--){const x=a.scaledTo(g),w=this._getLoadedTile(x);if(w)return w}}_getLoadedTile(a){const d=this._tiles[a.key];return d&&d.hasData()?d:this._cache.getByKey(this._source.reparseOverscaled?a.wrapped().key:a.canonical.key)}updateCacheSize(a,d){d=d||this._source.tileSize;const g=Math.ceil(a.width/d)+1,x=Math.ceil(a.height/d)+1,w=Math.floor(g*x*5),S=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,w):w,C=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,S):S;this._cache.setMaxSize(C)}handleWrapJump(a){const d=Math.round((a-(this._prevLng===void 0?a:this._prevLng))/360);if(this._prevLng=a,d){const g={};for(const x in this._tiles){const w=this._tiles[x];w.tileID=w.tileID.unwrapTo(w.tileID.wrap+d),g[w.tileID.key]=w}this._tiles=g;for(const x in this._timers)clearTimeout(this._timers[x]),delete this._timers[x];for(const x in this._tiles)this._setTileReloadTimer(+x,this._tiles[x])}}update(a,d,g,x){if(this.transform=a,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!g)return;let w;if(this.updateCacheSize(a,d),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={},this.used||this.usedForTerrain)if(this._source.tileID)w=a.getVisibleUnwrappedCoordinates(this._source.tileID).map(R=>new l.am(R.canonical.z,R.wrap,R.canonical.z,R.canonical.x,R.canonical.y));else if(this.tileCoverLift!==0){const R=a.clone();R.tileCoverLift=this.tileCoverLift,w=R.coveringTiles({tileSize:d||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!g,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.minzoom<=1&&a.projection.name==="globe"&&(w.push(new l.am(1,0,1,0,0)),w.push(new l.am(1,0,1,1,0)),w.push(new l.am(1,0,1,0,1)),w.push(new l.am(1,0,1,1,1)))}else w=a.coveringTiles({tileSize:d||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!g,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(w=w.filter(R=>this._source.hasTile(R)));else w=[];if(w.length>0&&this.castsShadows&&x&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!ea(this._source.type)){const R=a.coveringZoomLevel({tileSize:d||this._source.tileSize,roundZoom:this._source.roundZoom&&!g}),D=Math.min(R,this._source.maxzoom),N=a.extendTileCoverForShadows(w,x,D);for(const B of N)this._shadowCasterTiles[B.key]=!0,w.push(B)}const S=this._updateRetainedTiles(w);if(ea(this._source.type)&&w.length!==0){const R={},D={},N=Object.keys(S);for(const j of N){const $=S[j],Z=this._tiles[j];if(!Z||Z.fadeEndTime&&Z.fadeEndTime<=l.f.now())continue;const X=this.findLoadedParent($,Math.max($.overscaledZ-bo.maxOverzooming,this._source.minzoom));X&&(this._addTile(X.tileID),R[X.tileID.key]=X.tileID),D[j]=$}const B=w[w.length-1].overscaledZ;for(const j in this._tiles){const $=this._tiles[j];if(S[j]||!$.hasData())continue;let Z=$.tileID;for(;Z.overscaledZ>B;){Z=Z.scaledTo(Z.overscaledZ-1);const X=this._tiles[Z.key];if(X&&X.hasData()&&D[Z.key]){S[j]=$.tileID;break}}}for(const j in R)S[j]||(this._coveredTiles[j]=!0,S[j]=R[j])}for(const R in S)this._tiles[R].clearFadeHold();const C=l.b0(this._tiles,S);for(const R of C){const D=this._tiles[R];D.hasSymbolBuckets&&!D.holdingForFade()?D.setHoldDuration(this.map._fadeDuration):D.hasSymbolBuckets&&!D.symbolFadeFinished()||this._removeTile(+R)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const a in this._tiles)this._tiles[a].holdingForFade()&&this._removeTile(+a)}_updateRetainedTiles(a){const d={};if(a.length===0)return d;const g={},x=a.reduce((D,N)=>Math.min(D,N.overscaledZ),1/0),w=a[0].overscaledZ,S=Math.max(w-bo.maxOverzooming,this._source.minzoom),C=Math.max(w+bo.maxUnderzooming,this._source.minzoom),R={};for(const D of a){const N=this._addTile(D);d[D.key]=D,N.hasData()||x<this._source.maxzoom&&(R[D.key]=D)}this._retainLoadedChildren(R,x,C,d);for(const D of a){let N=this._tiles[D.key];if(N.hasData())continue;if(D.canonical.z>=this._source.maxzoom){const j=D.children(this._source.maxzoom)[0],$=this.getTile(j);if($&&$.hasData()){d[j.key]=j;continue}}else{const j=D.children(this._source.maxzoom);if(d[j[0].key]&&d[j[1].key]&&d[j[2].key]&&d[j[3].key])continue}let B=N.wasRequested();for(let j=D.overscaledZ-1;j>=S;--j){const $=D.scaledTo(j);if(g[$.key]||(g[$.key]=!0,N=this.getTile($),!N&&B&&(N=this._addTile($)),N&&(d[$.key]=$,B=N.wasRequested(),N.hasData())))break}}return d}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const a in this._tiles){const d=[];let g,x=this._tiles[a].tileID;for(;x.overscaledZ>0;){if(x.key in this._loadedParentTiles){g=this._loadedParentTiles[x.key];break}d.push(x.key);const w=x.scaledTo(x.overscaledZ-1);if(g=this._getLoadedTile(w),g)break;x=w}for(const w of d)this._loadedParentTiles[w]=g}}_addTile(a){let d=this._tiles[a.key];if(d)return d.isExtraShadowCaster!==!0||this._shadowCasterTiles[a.key]||this._reloadTile(a.key,"reloading"),d;d=this._cache.getAndRemove(a),d&&(this._setTileReloadTimer(a.key,d),d.tileID=a,this._state.initializeTileState(d,this.map?this.map.painter:null),this._cacheTimers[a.key]&&(clearTimeout(this._cacheTimers[a.key]),delete this._cacheTimers[a.key],this._setTileReloadTimer(a.key,d)));const g=!!d;if(!g){const x=this.map?this.map.painter:null,w=this._source.tileSize*a.overscaleFactor();d=this._source.type==="raster-array"?new cl(a,w,this.transform.tileZoom,x,this._isRaster):new Sa(a,w,this.transform.tileZoom,x,this._isRaster),this._loadTile(d,this._tileLoaded.bind(this,d,a.key,d.state))}return d?(d.uses++,this._tiles[a.key]=d,g||this._source.fire(new l.b("dataloading",{tile:d,coord:d.tileID,dataType:"source"})),d):null}_setTileReloadTimer(a,d){a in this._timers&&(clearTimeout(this._timers[a]),delete this._timers[a]);const g=d.getExpiryTimeout();g&&(this._timers[a]=setTimeout(()=>{this._reloadTile(a,"expired"),delete this._timers[a]},g))}_removeTile(a){const d=this._tiles[a];d&&(d.uses--,delete this._tiles[a],this._timers[a]&&(clearTimeout(this._timers[a]),delete this._timers[a]),d.uses>0||(d.hasData()&&d.state!=="reloading"||d.state==="empty"?this._cache.add(d.tileID,d,d.getExpiryTimeout()):(d.aborted=!0,this._abortTile(d),this._unloadTile(d))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const a in this._tiles)this._removeTile(+a);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(a,d,g){const x=[],w=this.transform;if(!w)return x;const S=w.projection.name==="globe",C=l.a5(w.center.lng);for(const R in this._tiles){const D=this._tiles[R];if(g&&D.clearQueryDebugViz(),D.holdingForFade())continue;let N;if(S){const B=D.tileID.canonical;if(B.z===0){const j=[Math.abs(l.aa(C,...Jc(B,-1))-C),Math.abs(l.aa(C,...Jc(B,1))-C)];N=[0,2*j.indexOf(Math.min(...j))-1]}else{const j=[Math.abs(l.aa(C,...Jc(B,-1))-C),Math.abs(l.aa(C,...Jc(B,0))-C),Math.abs(l.aa(C,...Jc(B,1))-C)];N=[j.indexOf(Math.min(...j))-1]}}else N=[0];for(const B of N){const j=a.containsTile(D,w,d,B);j&&x.push(j)}}return x}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(a){return this._getRenderableCoordinates(a)}_getRenderableCoordinates(a,d){const g=this.getRenderableIds(a,d).map(w=>this._tiles[w].tileID),x=this.transform.projection.name==="globe";for(const w of g)w.projMatrix=this.transform.calculateProjMatrix(w.toUnwrapped()),w.expandedProjMatrix=x?this.transform.calculateProjMatrix(w.toUnwrapped(),!1,!0):w.projMatrix;return g}sortCoordinatesByDistance(a){const d=a.slice(),g=this.transform._camera.position,x=this.transform._camera.forward(),w={};for(const S of d){const C=1/(1<<S.canonical.z);w[S.key]=((S.canonical.x+.5)*C+S.wrap-g[0])*x[0]+((S.canonical.y+.5)*C-g[1])*x[1]-g[2]*x[2]}return d.sort((S,C)=>w[S.key]-w[C.key]),d}hasTransition(){if(this._source.hasTransition())return!0;if(ea(this._source.type))for(const a in this._tiles){const d=this._tiles[a];if(d.fadeEndTime!==void 0&&d.fadeEndTime>=l.f.now())return!0}return!1}setFeatureState(a,d,g){this._state.updateState(a=a||"_geojsonTileLayer",d,g)}removeFeatureState(a,d,g){this._state.removeFeatureState(a=a||"_geojsonTileLayer",d,g)}getFeatureState(a,d){return this._state.getState(a=a||"_geojsonTileLayer",d)}setDependencies(a,d,g){const x=this._tiles[a];x&&x.setDependencies(d,g)}reloadTilesForDependencies(a,d){for(const g in this._tiles)this._tiles[g].hasDependency(a,d)&&this._reloadTile(+g,"reloading");this._cache.filter(g=>!g.hasDependency(a,d))}_preloadTiles(a,d){if(!this._sourceLoaded){const R=()=>{this._sourceLoaded&&(this._source.off("data",R),this._preloadTiles(a,d))};return void this._source.on("data",R)}const g=new Map,x=Array.isArray(a)?a:[a],w=this.map.painter.terrain,S=this.usedForTerrain&&w?w.getScaledDemTileSize():this._source.tileSize;for(const R of x){const D=R.coveringTiles({tileSize:S,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const N of D)g.set(N.key,N);this.usedForTerrain&&R.updateElevation(!1)}const C=Array.from(g.values());l.b1(C,(R,D)=>{const N=new Sa(R,this._source.tileSize*R.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(N,B=>{this._source.type==="raster-dem"&&N.dem&&this._backfillDEM(N),D(B,N)})},d)}}function kh(_,a){const d=Math.abs(2*_.wrap)-+(_.wrap<0),g=Math.abs(2*a.wrap)-+(a.wrap<0);return _.overscaledZ-a.overscaledZ||g-d||a.canonical.y-_.canonical.y||a.canonical.x-_.canonical.x}function ea(_){return _==="raster"||_==="image"||_==="video"||_==="custom"}function Jc(_,a){const d=1<<_.z;return[_.x/d+a,(_.x+1)/d+a]}bo.maxOverzooming=10,bo.maxUnderzooming=3;class q_{constructor(a){this.style=a,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const a=!1,d=!1;for(const g in this.style._mergedLayers){const x=this.style._mergedLayers[g];if(x.type==="fill-extrusion")this.layers.push({layer:x,visible:a,visibilityChanged:d});else if(x.type==="model"){const w=this.style.getLayerSource(x);w&&w.type==="batched-model"&&this.layers.push({layer:x,visible:a,visibilityChanged:d})}}}onNewFrame(a){this.layersGotHidden=!1;for(const d of this.layers){const g=d.layer;let x=!1;g.type==="fill-extrusion"?x=!g.isHidden(a)&&g.paint.get("fill-extrusion-opacity")>0:g.type==="model"&&(x=!g.isHidden(a)&&g.paint.get("model-opacity")>0),this.layersGotHidden=this.layersGotHidden||!x&&d.visible,d.visible=x}}updateZOffset(a,d){this.currentBuildingBuckets=[];for(const x of this.layers){const w=x.layer,S=this.style.getLayerSourceCache(w);let C=1;w.type==="fill-extrusion"&&(C=x.visible?w.paint.get("fill-extrusion-vertical-scale"):0);let R=S?S.getTile(d):null;if(!R&&S&&d.canonical.z>S.getSource().minzoom){let D=d.scaledTo(Math.min(S.getSource().maxzoom,d.overscaledZ-1));for(;D.overscaledZ>=S.getSource().minzoom&&(R=S.getTile(D),!R&&D.overscaledZ!==0);)D=D.scaledTo(D.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:R?R.getBucket(w):null,tileID:R?R.tileID:d,verticalScale:C})}a.hasAnyZOffset=!1;let g=!1;for(let x=0;x<a.symbolInstances.length;x++){const w=a.symbolInstances.get(x),S=w.zOffset,C=this._getHeightAtTileOffset(d,w.tileAnchorX,w.tileAnchorY);w.zOffset=C!==Number.NEGATIVE_INFINITY?C:S,g||S===w.zOffset||(g=!0),a.hasAnyZOffset||w.zOffset===0||(a.hasAnyZOffset=!0)}g&&(a.zOffsetBuffersNeedUpload=!0,a.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(a,d,g,x){let w=d,S=g;if(a.canonical.z!==x.canonical.z){const C=x.canonical,R=1/(1<<a.canonical.z-C.z);w=(d+a.canonical.x*l.V)*R-C.x*l.V|0,S=(g+a.canonical.y*l.V)*R-C.y*l.V|0}return{tileX:w,tileY:S}}_getHeightAtTileOffset(a,d,g){let x,w;for(let S=0;S<this.layers.length;++S){if(this.layers[S].layer.type!=="fill-extrusion")continue;const{bucket:C,tileID:R,verticalScale:D}=this.currentBuildingBuckets[S];if(!C)continue;const{tileX:N,tileY:B}=this._mapCoordToOverlappingTile(a,d,g,R),j=C.getHeightAtTileCoord(N,B);j&&j.height!==void 0&&(j.hidden?x=j.height:w=Math.max(j.height*D,w||0))}if(w!==void 0)return w;for(let S=0;S<this.layers.length;++S){const C=this.layers[S];if(C.layer.type!=="model"||!C.visible)continue;const{bucket:R,tileID:D}=this.currentBuildingBuckets[S];if(!R)continue;const{tileX:N,tileY:B}=this._mapCoordToOverlappingTile(a,d,g,D),j=R.getHeightAtTileCoord(N,B);if(j&&!j.hidden)return j.height===void 0&&x!==void 0?Math.min(j.maxHeight,x)*j.verticalScale:(j.height||0)*j.verticalScale}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function ul(_,a){const d={};for(const g in _)g!=="ref"&&(d[g]=_[g]);return l.b2.forEach(g=>{g in a&&(d[g]=a[g])}),d}function G_(_){_=_.slice();const a=Object.create(null);for(let d=0;d<_.length;d++)a[_[d].id]=_[d];for(let d=0;d<_.length;d++)"ref"in _[d]&&(_[d]=ul(_[d],a[_[d].ref]));return _}const Ji={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function Qc(_,a,d){d.push({command:Ji.addSource,args:[_,a[_]]})}function Ff(_,a,d){a.push({command:Ji.removeSource,args:[_]}),d[_]=!0}function T1(_,a,d,g){Ff(_,d,g),Qc(_,a,d)}function E1(_,a,d){let g;for(g in _[d])if(_[d].hasOwnProperty(g)&&g!=="data"&&!A(_[d][g],a[d][g]))return!1;for(g in a[d])if(a[d].hasOwnProperty(g)&&g!=="data"&&!A(_[d][g],a[d][g]))return!1;return!0}function Aa(_,a,d,g,x,w){let S;for(S in a=a||{},_=_||{})_.hasOwnProperty(S)&&(A(_[S],a[S])||d.push({command:w,args:[g,S,a[S],x]}));for(S in a)a.hasOwnProperty(S)&&!_.hasOwnProperty(S)&&(A(_[S],a[S])||d.push({command:w,args:[g,S,a[S],x]}))}function Ma(_){return _.id}function Dh(_,a){return _[a.id]=a,_}class $l{constructor(a,d){this.reset(a,d)}reset(a,d){this.points=a||[],this._distances=[0];for(let g=1;g<this.points.length;g++)this._distances[g]=this._distances[g-1]+this.points[g].dist(this.points[g-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(d||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(a){if(this.points.length===1)return this.points[0];a=l.aa(a,0,1);let d=1,g=this._distances[d];const x=a*this.paddedLength+this.padding;for(;g<x&&d<this._distances.length;)g=this._distances[++d];const w=d-1,S=this._distances[w],C=g-S,R=C>0?(x-S)/C:0;return this.points[w].mult(1-R).add(this.points[d].mult(R))}}class Bf{constructor(a,d,g){const x=this.boxCells=[],w=this.circleCells=[];this.xCellCount=Math.ceil(a/g),this.yCellCount=Math.ceil(d/g);for(let S=0;S<this.xCellCount*this.yCellCount;S++)x.push([]),w.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=a,this.height=d,this.xScale=this.xCellCount/a,this.yScale=this.yCellCount/d,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(a,d,g,x,w){this._forEachCell(d,g,x,w,this._insertBoxCell,this.boxUid++),this.boxKeys.push(a),this.bboxes.push(d),this.bboxes.push(g),this.bboxes.push(x),this.bboxes.push(w)}insertCircle(a,d,g,x){this._forEachCell(d-x,g-x,d+x,g+x,this._insertCircleCell,this.circleUid++),this.circleKeys.push(a),this.circles.push(d),this.circles.push(g),this.circles.push(x)}_insertBoxCell(a,d,g,x,w,S){this.boxCells[w].push(S)}_insertCircleCell(a,d,g,x,w,S){this.circleCells[w].push(S)}_query(a,d,g,x,w,S){if(g<0||a>this.width||x<0||d>this.height)return!w&&[];const C=[];if(a<=0&&d<=0&&this.width<=g&&this.height<=x){if(w)return!0;for(let R=0;R<this.boxKeys.length;R++)C.push({key:this.boxKeys[R],x1:this.bboxes[4*R],y1:this.bboxes[4*R+1],x2:this.bboxes[4*R+2],y2:this.bboxes[4*R+3]});for(let R=0;R<this.circleKeys.length;R++){const D=this.circles[3*R],N=this.circles[3*R+1],B=this.circles[3*R+2];C.push({key:this.circleKeys[R],x1:D-B,y1:N-B,x2:D+B,y2:N+B})}return S?C.filter(S):C}return this._forEachCell(a,d,g,x,this._queryCell,C,{hitTest:w,seenUids:{box:{},circle:{}}},S),w?C.length>0:C}_queryCircle(a,d,g,x,w){const S=a-g,C=a+g,R=d-g,D=d+g;if(C<0||S>this.width||D<0||R>this.height)return!x&&[];const N=[];return this._forEachCell(S,R,C,D,this._queryCellCircle,N,{hitTest:x,circle:{x:a,y:d,radius:g},seenUids:{box:{},circle:{}}},w),x?N.length>0:N}query(a,d,g,x,w){return this._query(a,d,g,x,!1,w)}hitTest(a,d,g,x,w){return this._query(a,d,g,x,!0,w)}hitTestCircle(a,d,g,x){return this._queryCircle(a,d,g,!0,x)}_queryCell(a,d,g,x,w,S,C,R){const D=C.seenUids,N=this.boxCells[w];if(N!==null){const j=this.bboxes;for(const $ of N)if(!D.box[$]){D.box[$]=!0;const Z=4*$;if(a<=j[Z+2]&&d<=j[Z+3]&&g>=j[Z+0]&&x>=j[Z+1]&&(!R||R(this.boxKeys[$]))){if(C.hitTest)return S.push(!0),!0;S.push({key:this.boxKeys[$],x1:j[Z],y1:j[Z+1],x2:j[Z+2],y2:j[Z+3]})}}}const B=this.circleCells[w];if(B!==null){const j=this.circles;for(const $ of B)if(!D.circle[$]){D.circle[$]=!0;const Z=3*$;if(this._circleAndRectCollide(j[Z],j[Z+1],j[Z+2],a,d,g,x)&&(!R||R(this.circleKeys[$]))){if(C.hitTest)return S.push(!0),!0;{const X=j[Z],K=j[Z+1],q=j[Z+2];S.push({key:this.circleKeys[$],x1:X-q,y1:K-q,x2:X+q,y2:K+q})}}}}}_queryCellCircle(a,d,g,x,w,S,C,R){const D=C.circle,N=C.seenUids,B=this.boxCells[w];if(B!==null){const $=this.bboxes;for(const Z of B)if(!N.box[Z]){N.box[Z]=!0;const X=4*Z;if(this._circleAndRectCollide(D.x,D.y,D.radius,$[X+0],$[X+1],$[X+2],$[X+3])&&(!R||R(this.boxKeys[Z])))return S.push(!0),!0}}const j=this.circleCells[w];if(j!==null){const $=this.circles;for(const Z of j)if(!N.circle[Z]){N.circle[Z]=!0;const X=3*Z;if(this._circlesCollide($[X],$[X+1],$[X+2],D.x,D.y,D.radius)&&(!R||R(this.circleKeys[Z])))return S.push(!0),!0}}}_forEachCell(a,d,g,x,w,S,C,R){const D=this._convertToXCellCoord(a),N=this._convertToYCellCoord(d),B=this._convertToXCellCoord(g),j=this._convertToYCellCoord(x);for(let $=D;$<=B;$++)for(let Z=N;Z<=j;Z++)if(w.call(this,a,d,g,x,this.xCellCount*Z+$,S,C,R))return}_convertToXCellCoord(a){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(a*this.xScale)))}_convertToYCellCoord(a){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(a*this.yScale)))}_circlesCollide(a,d,g,x,w,S){const C=x-a,R=w-d,D=g+S;return D*D>C*C+R*R}_circleAndRectCollide(a,d,g,x,w,S,C){const R=(S-x)/2,D=Math.abs(a-(x+R));if(D>R+g)return!1;const N=(C-w)/2,B=Math.abs(d-(w+N));if(B>N+g)return!1;if(D<=R||B<=N)return!0;const j=D-R,$=B-N;return j*j+$*$<=g*g}}const ta={unknown:0,flipRequired:1,flipNotRequired:2},Ca=Math.tan(85*Math.PI/180);function eu(_,a,d,g,x,w,S){const C=l.a6.create();if(d)if(w.name==="globe"){const R=l.b3(x,a);l.a6.multiply(C,C,R)}else{const R=l.b4.invert([],S);C[0]=R[0],C[1]=R[1],C[4]=R[2],C[5]=R[3],g||l.a6.rotateZ(C,C,x.angle)}else l.a6.multiply(C,x.labelPlaneMatrix,_);return C}function zf(_,a,d,g,x,w,S){const C=eu(_,a,d,g,x,w,S);return w.name==="globe"&&d||(C[2]=C[6]=C[10]=C[14]=0),C}function Uf(_,a,d,g,x,w,S){if(d){if(w.name==="globe"){const C=eu(_,a,d,g,x,w,S);return l.a6.invert(C,C),l.a6.multiply(C,_,C),C}{const C=l.a6.clone(_),R=l.a6.identity([]);return R[0]=S[0],R[1]=S[1],R[4]=S[2],R[5]=S[3],l.a6.multiply(C,C,R),g||l.a6.rotateZ(C,C,-x.angle),C}}return x.glCoordMatrix}function uo(_,a,d,g){const x=[_,a,d,1];d?l.a7.transformMat4(x,x,g):qf(x,x,g);const w=x[3];return x[0]/=w,x[1]/=w,x[2]/=w,x}function X_(_,a){return Math.min(.5+_/a*.5,1.5)}function Vf(_,a){const d=_[0]/_[3],g=_[1]/_[3];return d>=-a[0]&&d<=a[0]&&g>=-a[1]&&g<=a[1]}function jf(_,a,d,g,x,w,S,C,R,D){const N=d.transform,B=g?_.textSizeData:_.iconSizeData,j=l.b5(B,d.transform.zoom),$=N.projection.name==="globe",Z=[256/d.width*2+1,256/d.height*2+1],X=g?_.text.dynamicLayoutVertexArray:_.icon.dynamicLayoutVertexArray;X.clear();let K=null;$&&(K=g?_.text.globeExtVertexArray:_.icon.globeExtVertexArray);const q=_.lineVertexArray,ee=g?_.text.placedSymbolArray:_.icon.placedSymbolArray,ae=d.transform.width/d.transform.height;let re,le=!1;for(let Q=0;Q<ee.length;Q++){const ce=ee.get(Q),{numGlyphs:ve,writingMode:we}=ce;if(we!==l.b6.vertical||le||re===l.b6.horizontal||(le=!0),re=we,(ce.hidden||we===l.b6.vertical)&&!le){Pa(ve,X);continue}le=!1;const Ce=new l.P(ce.tileAnchorX,ce.tileAnchorY);let{x:Ue,y:Re,z:Ye}=N.projection.projectTilePoint(Ce.x,Ce.y,D.canonical);if(R){const[Lt,Zt,si]=R(Ce);Ue+=Lt,Re+=Zt,Ye+=si}const Ge=[Ue,Re,Ye,1];if(l.a7.transformMat4(Ge,Ge,a),!Vf(Ge,Z)){Pa(ve,X);continue}const pt=Ge[3],ke=X_(d.transform.getCameraToCenterDistance(N.projection),pt),He=l.b7(B,j,ce),Me=S?He/ke:He*ke,Ne=uo(Ue,Re,Ye,x);if(Ne[3]<=0){Pa(ve,X);continue}let mt={};const Mt=S?null:R,Tt=Hf(ce,Me,!1,C,a,x,w,_.glyphOffsetArray,q,X,K,Ne,Ce,mt,ae,Mt,N.projection,D,S);le=Tt.useVertical,Mt&&Tt.needsFlipping&&(mt={}),(Tt.notEnoughRoom||le||Tt.needsFlipping&&Hf(ce,Me,!0,C,a,x,w,_.glyphOffsetArray,q,X,K,Ne,Ce,mt,ae,Mt,N.projection,D,S).notEnoughRoom)&&Pa(ve,X)}g?(_.text.dynamicLayoutVertexBuffer.updateData(X),K&&_.text.globeExtVertexBuffer&&_.text.globeExtVertexBuffer.updateData(K)):(_.icon.dynamicLayoutVertexBuffer.updateData(X),K&&_.icon.globeExtVertexBuffer&&_.icon.globeExtVertexBuffer.updateData(K))}function $f(_,a,d,g,x,w,S,C,R,D,N,B,j,$,Z,X){const{lineStartIndex:K,glyphStartIndex:q,segment:ee}=C,ae=q+C.numGlyphs,re=K+C.lineLength,le=a.getoffsetX(q),Q=a.getoffsetX(ae-1),ce=tu(_*le,d,g,x,w,S,ee,K,re,R,D,N,B,j,!0,$,Z,X);if(!ce)return null;const ve=tu(_*Q,d,g,x,w,S,ee,K,re,R,D,N,B,j,!0,$,Z,X);return ve?{first:ce,last:ve}:null}function Wf(_,a,d,g){return _===l.b6.horizontal&&Math.abs(g)>Math.abs(d)?{useVertical:!0}:_===l.b6.vertical?g>0?{needsFlipping:!0}:null:a!==ta.unknown&&function(x,w){return x===0||Math.abs(w/x)>Ca}(d,g)?a===ta.flipRequired?{needsFlipping:!0}:null:d<0?{needsFlipping:!0}:null}function Hf(_,a,d,g,x,w,S,C,R,D,N,B,j,$,Z,X,K,q,ee){const ae=a/24,re=_.lineOffsetX*ae,le=_.lineOffsetY*ae,{lineStartIndex:Q,glyphStartIndex:ce,numGlyphs:ve,segment:we,writingMode:Ce,flipState:Ue}=_,Re=Q+_.lineLength,Ye=Ge=>{if(N){const[Me,Ne,mt]=Ge.up,Mt=D.length;l.b8(N,Mt+0,Me,Ne,mt),l.b8(N,Mt+1,Me,Ne,mt),l.b8(N,Mt+2,Me,Ne,mt),l.b8(N,Mt+3,Me,Ne,mt)}const[pt,ke,He]=Ge.point;l.b9(D,pt,ke,He,Ge.angle)};if(ve>1){const Ge=$f(ae,C,re,le,d,B,j,_,R,w,$,X,!1,K,q,ee);if(!Ge)return{notEnoughRoom:!0};if(g&&!d){let[pt,ke,He]=Ge.first.point,[Me,Ne,mt]=Ge.last.point;[pt,ke]=uo(pt,ke,He,S),[Me,Ne]=uo(Me,Ne,mt,S);const Mt=Wf(Ce,Ue,(Me-pt)*Z,Ne-ke);if(_.flipState=Mt&&Mt.needsFlipping?ta.flipRequired:ta.flipNotRequired,Mt)return Mt}Ye(Ge.first);for(let pt=ce+1;pt<ce+ve-1;pt++){const ke=tu(ae*C.getoffsetX(pt),re,le,d,B,j,we,Q,Re,R,w,$,X,!1,!1,K,q,ee);if(!ke)return D.length-=4*(pt-ce),{notEnoughRoom:!0};Ye(ke)}Ye(Ge.last)}else{if(g&&!d){const pt=uo(j.x,j.y,0,x),ke=Q+we+1,He=new l.P(R.getx(ke),R.gety(ke)),Me=uo(He.x,He.y,0,x),Ne=Me[3]>0?Me:Lh(j,He,pt,1,x,void 0,K,q.canonical),mt=Wf(Ce,Ue,(Ne[0]-pt[0])*Z,Ne[1]-pt[1]);if(_.flipState=mt&&mt.needsFlipping?ta.flipRequired:ta.flipNotRequired,mt)return mt}const Ge=tu(ae*C.getoffsetX(ce),re,le,d,B,j,we,Q,Re,R,w,$,X,!1,!1,K,q,ee);if(!Ge)return{notEnoughRoom:!0};Ye(Ge)}return{}}function Wl(_,a,d,g,x){const{x:w,y:S,z:C}=g.projectTilePoint(_.x,_.y,a);if(!x)return uo(w,S,C,d);const[R,D,N]=x(_);return uo(w+R,S+D,C+N,d)}function Lh(_,a,d,g,x,w,S,C){const R=Wl(_.sub(a)._unit()._add(_),C,x,S,w);return l.N.sub(R,d,R),l.N.normalize(R,R),l.N.scaleAndAdd(R,d,R,g)}function tu(_,a,d,g,x,w,S,C,R,D,N,B,j,$,Z,X,K,q){const ee=g?_-a:_+a;let ae=ee>0?1:-1,re=0;g&&(ae*=-1,re=Math.PI),ae<0&&(re+=Math.PI);let le=C+S+(ae>0?0:1)|0,Q=x,ce=x,ve=0,we=0;const Ce=Math.abs(ee),Ue=[],Re=[];let Ye=w,Ge=Ye;const pt=()=>Lh(Ge,Ye,ce,Ce-ve+1,N,j,X,K.canonical);for(;ve+we<=Ce;){if(le+=ae,le<C||le>=R)return null;if(ce=Q,Ge=Ye,Ue.push(ce),$&&Re.push(Ge),Ye=new l.P(D.getx(le),D.gety(le)),Q=B[le],!Q){const Zt=Wl(Ye,K.canonical,N,X,j);Q=Zt[3]>0?B[le]=Zt:pt()}ve+=we,we=l.N.distance(ce,Q)}Z&&j&&(B[le]&&(Q=pt(),we=l.N.distance(ce,Q)),B[le]=Q);const ke=(Ce-ve)/we,He=Ye.sub(Ge)._mult(ke)._add(Ge),Me=l.N.sub([],Q,ce),Ne=l.N.scaleAndAdd([],ce,Me,ke);let mt=[0,0,1],Mt=Me[0],Tt=Me[1];if(q&&(mt=X.upVector(K.canonical,He.x,He.y),mt[0]!==0||mt[1]!==0||mt[2]!==1)){const Zt=[mt[2],0,-mt[0]],si=l.N.cross([],mt,Zt);l.N.normalize(Zt,Zt),l.N.normalize(si,si),Mt=l.N.dot(Me,Zt),Tt=l.N.dot(Me,si)}if(d){const Zt=l.N.cross([],mt,Me);l.N.normalize(Zt,Zt),l.N.scaleAndAdd(Ne,Ne,Zt,d*ae)}const Lt=re+Math.atan2(Tt,Mt);return Ue.push(Ne),$&&Re.push(He),{point:Ne,angle:Lt,path:Ue,tilePath:Re,up:mt}}function Pa(_,a){const d=a.length,g=d+4*_;a.resize(g),a.float32.fill(-1/0,4*d,4*g)}function qf(_,a,d){const g=a[0],x=a[1];return _[0]=d[0]*g+d[4]*x+d[12],_[1]=d[1]*g+d[5]*x+d[13],_[3]=d[3]*g+d[7]*x+d[15],_}const ho=100;class Bt{constructor(a,d,g=new Bf(a.width+200,a.height+200,25),x=new Bf(a.width+200,a.height+200,25)){this.transform=a,this.grid=g,this.ignoredGrid=x,this.pitchfactor=Math.cos(a._pitch)*a.cameraToCenterDistance,this.screenRightBoundary=a.width+ho,this.screenBottomBoundary=a.height+ho,this.gridRightBoundary=a.width+200,this.gridBottomBoundary=a.height+200,this.fogState=d}placeCollisionBox(a,d,g,x,w,S,C,R){let D=g.projectedAnchorX,N=g.projectedAnchorY,B=g.projectedAnchorZ;const j=g.elevation,$=g.tileID,Z=a.getProjection();if(j&&$){const[Q,ce,ve]=Z.upVector($.canonical,g.tileAnchorX,g.tileAnchorY),we=Z.upVectorScale($.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;D+=Q*j*we,N+=ce*j*we,B+=ve*j*we}const X=this.projectAndGetPerspectiveRatio(C,D,N,B,g.tileID,Z.name==="globe"||!!j||this.transform.pitch>0,Z),K=S*X.perspectiveRatio,q=(g.x1*d+x.x-g.padding)*K+X.point.x,ee=(g.y1*d+x.y-g.padding)*K+X.point.y,ae=(g.x2*d+x.x+g.padding)*K+X.point.x,re=(g.y2*d+x.y+g.padding)*K+X.point.y,le=X.perspectiveRatio<=.55||X.occluded;return!this.isInsideGrid(q,ee,ae,re)||!w&&this.grid.hitTest(q,ee,ae,re,R)||le?{box:[],offscreen:!1,occluded:X.occluded}:{box:[q,ee,ae,re],offscreen:this.isOffscreen(q,ee,ae,re),occluded:!1}}placeCollisionCircles(a,d,g,x,w,S,C,R,D,N,B,j,$,Z,X){const K=[],q=this.transform.elevation,ee=a.getProjection(),ae=q?q.getAtTileOffsetFunc(X,this.transform.center.lat,this.transform.worldSize,ee):null,re=new l.P(g.tileAnchorX,g.tileAnchorY);let{x:le,y:Q,z:ce}=ee.projectTilePoint(re.x,re.y,X.canonical);if(ae){const[He,Me,Ne]=ae(re);le+=He,Q+=Me,ce+=Ne}const ve=ee.name==="globe",we=this.projectAndGetPerspectiveRatio(C,le,Q,ce,X,ve||!!q||this.transform.pitch>0,ee),{perspectiveRatio:Ce}=we,Ue=(B?S/Ce:S*Ce)/l.bc,Re=uo(le,Q,ce,R),Ye=we.signedDistanceFromCamera>0?$f(Ue,w,g.lineOffsetX*Ue,g.lineOffsetY*Ue,!1,Re,re,g,x,R,{},q&&!B?ae:null,B&&!!q,ee,X,B):null;let Ge=!1,pt=!1,ke=!0;if(Ye&&!we.occluded){const He=.5*$*Ce+Z,Me=new l.P(-100,-100),Ne=new l.P(this.screenRightBoundary,this.screenBottomBoundary),mt=new $l,{first:Mt,last:Tt}=Ye,Lt=Mt.path.length;let Zt=[];for(let ii=Lt-1;ii>=1;ii--)Zt.push(Mt.path[ii]);for(let ii=1;ii<Tt.path.length;ii++)Zt.push(Tt.path[ii]);const si=2.5*He;D&&(Zt=Zt.map(([ii,Ii,gi],Ti)=>(ae&&!ve&&(gi=ae(Ti<Lt-1?Mt.tilePath[Lt-1-Ti]:Tt.tilePath[Ti-Lt+2])[2]),uo(ii,Ii,gi,D))),Zt.some(ii=>ii[3]<=0)&&(Zt=[]));let ei=[];if(Zt.length>0){let ii=1/0,Ii=-1/0,gi=1/0,Ti=-1/0;for(const wi of Zt)ii=Math.min(ii,wi[0]),gi=Math.min(gi,wi[1]),Ii=Math.max(Ii,wi[0]),Ti=Math.max(Ti,wi[1]);Ii>=Me.x&&ii<=Ne.x&&Ti>=Me.y&&gi<=Ne.y&&(ei=[Zt.map(wi=>new l.P(wi[0],wi[1]))],(ii<Me.x||Ii>Ne.x||gi<Me.y||Ti>Ne.y)&&(ei=l.ba(ei,Me.x,Me.y,Ne.x,Ne.y)))}for(const ii of ei){mt.reset(ii,.25*He);let Ii=0;Ii=mt.length<=.5*He?1:Math.ceil(mt.paddedLength/si)+1;for(let gi=0;gi<Ii;gi++){const Ti=gi/Math.max(Ii-1,1),wi=mt.lerp(Ti),Qi=wi.x+ho,Vr=wi.y+ho;K.push(Qi,Vr,He,0);const Ui=Qi-He,pn=Vr-He,Vi=Qi+He,lr=Vr+He;if(ke=ke&&this.isOffscreen(Ui,pn,Vi,lr),pt=pt||this.isInsideGrid(Ui,pn,Vi,lr),!d&&this.grid.hitTestCircle(Qi,Vr,He,j)&&(Ge=!0,!N))return{circles:[],offscreen:!1,collisionDetected:Ge,occluded:!1}}}}return{circles:!N&&Ge||!pt?[]:K,offscreen:ke,collisionDetected:Ge,occluded:we.occluded}}queryRenderedSymbols(a){if(a.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const d=[];let g=1/0,x=1/0,w=-1/0,S=-1/0;for(const N of a){const B=new l.P(N.x+ho,N.y+ho);g=Math.min(g,B.x),x=Math.min(x,B.y),w=Math.max(w,B.x),S=Math.max(S,B.y),d.push(B)}const C=this.grid.query(g,x,w,S).concat(this.ignoredGrid.query(g,x,w,S)),R={},D={};for(const N of C){const B=N.key;if(R[B.bucketInstanceId]===void 0&&(R[B.bucketInstanceId]={}),R[B.bucketInstanceId][B.featureIndex])continue;const j=[new l.P(N.x1,N.y1),new l.P(N.x2,N.y1),new l.P(N.x2,N.y2),new l.P(N.x1,N.y2)];l.bb(d,j)&&(R[B.bucketInstanceId][B.featureIndex]=!0,D[B.bucketInstanceId]===void 0&&(D[B.bucketInstanceId]=[]),D[B.bucketInstanceId].push(B.featureIndex))}return D}insertCollisionBox(a,d,g,x,w){(d?this.ignoredGrid:this.grid).insert({bucketInstanceId:g,featureIndex:x,collisionGroupID:w},a[0],a[1],a[2],a[3])}insertCollisionCircles(a,d,g,x,w){const S=d?this.ignoredGrid:this.grid,C={bucketInstanceId:g,featureIndex:x,collisionGroupID:w};for(let R=0;R<a.length;R+=4)S.insertCircle(C,a[R],a[R+1],a[R+2])}projectAndGetPerspectiveRatio(a,d,g,x,w,S,C){const R=[d,g,x,1];let D=!1;x||this.transform.pitch>0?(l.a7.transformMat4(R,R,a),this.fogState&&w&&C.name!=="globe"&&(D=function(j,$,Z,X,K,q){const ee=q.calculateFogTileMatrix(K),ae=[$,Z,X];return l.N.transformMat4(ae,ae,ee),zi(j,l.N.length(ae),q.pitch,q._fov)}(this.fogState,d,g,x,w.toUnwrapped(),this.transform)>.9)):qf(R,R,a);const N=R[3];return{point:new l.P((R[0]/N+1)/2*this.transform.width+ho,(-R[1]/N+1)/2*this.transform.height+ho),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(C)/N*.5,1.5),signedDistanceFromCamera:N,occluded:S&&R[2]>N||D}}isOffscreen(a,d,g,x){return g<ho||a>=this.screenRightBoundary||x<ho||d>this.screenBottomBoundary}isInsideGrid(a,d,g,x){return g>=0&&a<this.gridRightBoundary&&x>=0&&d<this.gridBottomBoundary}getViewportMatrix(){const a=l.a6.identity([]);return l.a6.translate(a,a,[-100,-100,0]),a}}function Nh(_,a,d){const g=a.createTileMatrix(_,_.worldSize,d.toUnwrapped());return l.a6.multiply(new Float32Array(16),_.projMatrix,g)}function Gf(_,a,d){if(a.projection.name===d.projection.name)return _.projMatrix;const g=d.clone();return g.setProjection(a.projection),Nh(g,a.getProjection(),_)}function iu(_,a,d){return a.name===d.projection.name?_.projMatrix:Nh(d,a,_)}class Xf{constructor(a,d,g,x){this.opacity=a?Math.max(0,Math.min(1,a.opacity+(a.placed?d:-d))):x&&g?1:0,this.placed=g}isHidden(){return this.opacity===0&&!this.placed}}class Ia{constructor(a,d,g,x,w,S=!1){this.text=new Xf(a?a.text:null,d,g,w),this.icon=new Xf(a?a.icon:null,d,x,w),this.clipped=S}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class wo{constructor(a,d,g,x=!1){this.text=a,this.icon=d,this.skipFade=g,this.clipped=x}}class Zf{constructor(){this.invProjMatrix=l.a6.create(),this.viewportMatrix=l.a6.create(),this.circles=[]}}class hl{constructor(a,d,g,x,w){this.bucketInstanceId=a,this.featureIndex=d,this.sourceLayerIndex=g,this.bucketIndex=x,this.tileID=w}}class Fh{constructor(a){this.crossSourceCollisions=a,this.maxGroupID=0,this.collisionGroups={}}get(a){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[a]){const d=++this.maxGroupID;this.collisionGroups[a]={ID:d,predicate:g=>g.collisionGroupID===d}}return this.collisionGroups[a]}}function dl(_,a,d,g,x){const{horizontalAlign:w,verticalAlign:S}=l.bf(_),C=-(w-.5)*a,R=-(S-.5)*d,D=l.bd(_,g);return new l.P(C+D[0]*x,R+D[1]*x)}function Yf(_,a,d,g,x){const w=new l.P(_,a);return d&&w._rotate(g?x:-x),w}class S1{constructor(a,d,g,x,w,S){this.transform=a.clone(),this.projection=a.projection.name,this.collisionIndex=new Bt(this.transform,w),this.buildingIndex=S,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=d,this.retainedQueryData={},this.collisionGroups=new Fh(g),this.collisionCircleArrays={},this.prevPlacement=x,x&&(x.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(a,d,g,x){const w=g.getBucket(d),S=g.latestFeatureIndex;if(!w||!S||d.fqid!==w.layerIds[0])return;const C=w.layers[0].layout,R=g.collisionBoxArray,D=Math.pow(2,this.transform.zoom-g.tileID.overscaledZ),N=g.tileSize/l.V,B=g.tileID.toUnwrapped();this.transform.setProjection(w.projection);const j=($=g.tileID,Z=w.getProjection(),X=this.transform,Z.name===this.projection?X.calculateProjMatrix($.toUnwrapped()):Nh(X,Z,$));var $,Z,X;const K=C.get("text-pitch-alignment")==="map",q=C.get("text-rotation-alignment")==="map";d.compileFilter();const ee=d.dynamicFilter(),ae=d.dynamicFilterNeedsFeature(),re=this.transform.calculatePixelsToTileUnitsMatrix(g),le=zf(j,g.tileID.canonical,K,q,this.transform,w.getProjection(),re);let Q=null;if(K){const we=Uf(j,g.tileID.canonical,K,q,this.transform,w.getProjection(),re);Q=l.a6.multiply([],this.transform.labelPlaneMatrix,we)}let ce=null;ee&&g.latestFeatureIndex&&(ce={unwrappedTileID:B,dynamicFilter:ee,dynamicFilterNeedsFeature:ae,featureIndex:g.latestFeatureIndex}),this.retainedQueryData[w.bucketInstanceId]=new hl(w.bucketInstanceId,S,w.sourceLayerIndex,w.index,g.tileID);const ve={bucket:w,layout:C,posMatrix:j,textLabelPlaneMatrix:le,labelToScreenMatrix:Q,clippingData:ce,scale:D,textPixelRatio:N,holdingForFade:g.holdingForFade(),collisionBoxArray:R,partiallyEvaluatedTextSize:l.b5(w.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:l.b5(w.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(w.sourceID)};if(x)for(const we of w.sortKeyRanges){const{sortKey:Ce,symbolInstanceStart:Ue,symbolInstanceEnd:Re}=we;a.push({sortKey:Ce,symbolInstanceStart:Ue,symbolInstanceEnd:Re,parameters:ve})}else a.push({symbolInstanceStart:0,symbolInstanceEnd:w.symbolInstances.length,parameters:ve})}attemptAnchorPlacement(a,d,g,x,w,S,C,R,D,N,B,j,$,Z,X,K,q,ee){const{textOffset0:ae,textOffset1:re,crossTileID:le}=j,Q=[ae,re],ce=dl(a,g,x,Q,w),ve=this.collisionIndex.placeCollisionBox(Z,w,d,Yf(ce.x,ce.y,S,C,this.transform.angle),B,R,D,N.predicate);if(K){const we=Z.getSymbolInstanceIconSize(ee,this.transform.zoom,j.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(Z,we,K,Yf(ce.x,ce.y,S,C,this.transform.angle),B,R,D,N.predicate).box.length===0)return}if(ve.box.length>0){let we;return this.prevPlacement&&this.prevPlacement.variableOffsets[le]&&this.prevPlacement.placements[le]&&this.prevPlacement.placements[le].text&&(we=this.prevPlacement.variableOffsets[le].anchor),this.variableOffsets[le]={textOffset:Q,width:g,height:x,anchor:a,textScale:w,prevAnchor:we},this.markUsedJustification(Z,a,j,X),Z.allowVerticalPlacement&&(this.markUsedOrientation(Z,X,j),this.placedOrientations[le]=X),{shift:ce,placedGlyphBoxes:ve}}}placeLayerBucketPart(a,d,g,x){const{bucket:w,layout:S,posMatrix:C,textLabelPlaneMatrix:R,labelToScreenMatrix:D,clippingData:N,textPixelRatio:B,holdingForFade:j,collisionBoxArray:$,partiallyEvaluatedTextSize:Z,partiallyEvaluatedIconSize:X,collisionGroup:K}=a.parameters,q=S.get("text-optional"),ee=S.get("icon-optional"),ae=S.get("text-allow-overlap"),re=S.get("icon-allow-overlap"),le=S.get("text-rotation-alignment")==="map",Q=S.get("text-pitch-alignment")==="map",ce=S.get("symbol-z-order")==="viewport-y",ve=S.get("symbol-z-elevate");this.transform.setProjection(w.projection);let we=ae&&(re||!w.hasIconData()||ee),Ce=re&&(ae||!w.hasTextData()||q);!w.collisionArrays&&$&&w.deserializeCollisionBoxes($),g&&x&&w.updateCollisionDebugBuffers(this.transform.zoom,$);const Ue=(Re,Ye,Ge)=>{const{crossTileID:pt,numVerticalGlyphVertices:ke}=Re;if(N){const Vi={zoom:this.transform.zoom,pitch:this.transform.pitch};let lr=null;if(N.dynamicFilterNeedsFeature){const ji=this.retainedQueryData[w.bucketInstanceId];lr=N.featureIndex.loadFeature({featureIndex:Re.featureIndex,bucketIndex:ji.bucketIndex,sourceLayerIndex:ji.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,N.dynamicFilter)(Vi,lr,this.retainedQueryData[w.bucketInstanceId].tileID.canonical,new l.P(Re.tileAnchorX,Re.tileAnchorY),this.transform.calculateDistanceTileData(N.unwrappedTileID)))return this.placements[pt]=new wo(!1,!1,!1,!0),void d.add(pt)}if(d.has(pt))return;if(j)return void(this.placements[pt]=new wo(!1,!1,!1));let He=!1,Me=!1,Ne=!0,mt=!1,Mt=!1,Tt=null,Lt={box:null,offscreen:null,occluded:null},Zt={box:null,offscreen:null,occluded:null},si=null,ei=null,ii=null,Ii=0,gi=0,Ti=0;Ge.textFeatureIndex?Ii=Ge.textFeatureIndex:Re.useRuntimeCollisionCircles&&(Ii=Re.featureIndex),Ge.verticalTextFeatureIndex&&(gi=Ge.verticalTextFeatureIndex);const wi=Vi=>{Vi.tileID=this.retainedQueryData[w.bucketInstanceId].tileID;const lr=this.transform.elevation;Vi.elevation=Re.zOffset+(lr?lr.getAtTileOffset(Vi.tileID,Vi.tileAnchorX,Vi.tileAnchorY):0)},Qi=Ge.textBox;if(Qi){wi(Qi);const Vi=ji=>{let sr=l.b6.horizontal;if(w.allowVerticalPlacement&&!ji&&this.prevPlacement){const Xr=this.prevPlacement.placedOrientations[pt];Xr&&(this.placedOrientations[pt]=Xr,sr=Xr,this.markUsedOrientation(w,sr,Re))}return sr},lr=(ji,sr)=>{if(w.allowVerticalPlacement&&ke>0&&Ge.verticalTextBox){for(const Xr of w.writingModes)if(Xr===l.b6.vertical?(Lt=sr(),Zt=Lt):Lt=ji(),Lt&&Lt.box&&Lt.box.length)break}else Lt=ji()};if(S.get("text-variable-anchor")){let ji=S.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[pt]){const gr=this.prevPlacement.variableOffsets[pt];ji.indexOf(gr.anchor)>0&&(ji=ji.filter(as=>as!==gr.anchor),ji.unshift(gr.anchor))}const sr=(gr,as,vs)=>{const Hs=w.getSymbolInstanceTextSize(Z,Re,this.transform.zoom,Ye),Uo=(gr.x2-gr.x1)*Hs+2*gr.padding,qs=(gr.y2-gr.y1)*Hs+2*gr.padding,ls=Re.hasIconTextFit&&!re?as:null;ls&&wi(ls);let Xn={box:[],offscreen:!1,occluded:!1};const Is=ae?2*ji.length:ji.length;for(let Ns=0;Ns<Is;++Ns){const Gs=this.attemptAnchorPlacement(ji[Ns%ji.length],gr,Uo,qs,Hs,le,Q,B,C,K,Ns>=ji.length,Re,Ye,w,vs,ls,Z,X);if(Gs&&(Xn=Gs.placedGlyphBoxes,Xn&&Xn.box&&Xn.box.length)){He=!0,Tt=Gs.shift;break}}return Xn};lr(()=>sr(Qi,Ge.iconBox,l.b6.horizontal),()=>{const gr=Ge.verticalTextBox;return gr&&wi(gr),w.allowVerticalPlacement&&!(Lt&&Lt.box&&Lt.box.length)&&ke>0&&gr?sr(gr,Ge.verticalIconBox,l.b6.vertical):{box:null,offscreen:null,occluded:null}}),Lt&&(He=Lt.box,Ne=Lt.offscreen,mt=Lt.occluded);const Xr=Vi(!(!Lt||!Lt.box));if(!He&&this.prevPlacement){const gr=this.prevPlacement.variableOffsets[pt];gr&&(this.variableOffsets[pt]=gr,this.markUsedJustification(w,gr.anchor,Re,Xr))}}else{const ji=(sr,Xr)=>{const gr=w.getSymbolInstanceTextSize(Z,Re,this.transform.zoom,Ye),as=this.collisionIndex.placeCollisionBox(w,gr,sr,new l.P(0,0),ae,B,C,K.predicate);return as&&as.box&&as.box.length&&(this.markUsedOrientation(w,Xr,Re),this.placedOrientations[pt]=Xr),as};lr(()=>ji(Qi,l.b6.horizontal),()=>{const sr=Ge.verticalTextBox;return w.allowVerticalPlacement&&ke>0&&sr?(wi(sr),ji(sr,l.b6.vertical)):{box:null,offscreen:null,occluded:null}}),Vi(!!(Lt&&Lt.box&&Lt.box.length))}}if(si=Lt,He=si&&si.box&&si.box.length>0,Ne=si&&si.offscreen,mt=si&&si.occluded,Re.useRuntimeCollisionCircles){const Vi=w.text.placedSymbolArray.get(Re.centerJustifiedTextSymbolIndex>=0?Re.centerJustifiedTextSymbolIndex:Re.verticalPlacedTextSymbolIndex),lr=l.b7(w.textSizeData,Z,Vi),ji=S.get("text-padding");ei=this.collisionIndex.placeCollisionCircles(w,ae,Vi,w.lineVertexArray,w.glyphOffsetArray,lr,C,R,D,g,Q,K.predicate,Re.collisionCircleDiameter*lr/l.bc,ji,this.retainedQueryData[w.bucketInstanceId].tileID),He=ae||ei.circles.length>0&&!ei.collisionDetected,Ne=Ne&&ei.offscreen,mt=ei.occluded}if(Ge.iconFeatureIndex&&(Ti=Ge.iconFeatureIndex),Ge.iconBox){const Vi=lr=>{wi(lr);const ji=Re.hasIconTextFit&&Tt?Yf(Tt.x,Tt.y,le,Q,this.transform.angle):new l.P(0,0),sr=w.getSymbolInstanceIconSize(X,this.transform.zoom,Re.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(w,sr,lr,ji,re,B,C,K.predicate)};Zt&&Zt.box&&Zt.box.length&&Ge.verticalIconBox?(ii=Vi(Ge.verticalIconBox),Me=ii.box.length>0):(ii=Vi(Ge.iconBox),Me=ii.box.length>0),Ne=Ne&&ii.offscreen,Mt=ii.occluded}const Vr=q||Re.numHorizontalGlyphVertices===0&&ke===0,Ui=ee||Re.numIconVertices===0;if(Vr||Ui?Ui?Vr||(Me=Me&&He):He=Me&&He:Me=He=Me&&He,He&&si&&si.box&&this.collisionIndex.insertCollisionBox(si.box,S.get("text-ignore-placement"),w.bucketInstanceId,Zt&&Zt.box&&gi?gi:Ii,K.ID),Me&&ii&&this.collisionIndex.insertCollisionBox(ii.box,S.get("icon-ignore-placement"),w.bucketInstanceId,Ti,K.ID),ei&&(He&&this.collisionIndex.insertCollisionCircles(ei.circles,S.get("text-ignore-placement"),w.bucketInstanceId,Ii,K.ID),g)){const Vi=w.bucketInstanceId;let lr=this.collisionCircleArrays[Vi];lr===void 0&&(lr=this.collisionCircleArrays[Vi]=new Zf);for(let ji=0;ji<ei.circles.length;ji+=4)lr.circles.push(ei.circles[ji+0]),lr.circles.push(ei.circles[ji+1]),lr.circles.push(ei.circles[ji+2]),lr.circles.push(ei.collisionDetected?1:0)}const pn=w.projection.name!=="globe";we=we&&(pn||!mt),Ce=Ce&&(pn||!Mt),this.placements[pt]=new wo(He||we,Me||Ce,Ne||w.justReloaded),d.add(pt)};if(ve&&this.buildingIndex&&(this.buildingIndex.updateZOffset(w,this.retainedQueryData[w.bucketInstanceId].tileID),w.updateZOffset()),ce){const Re=w.getSortedSymbolIndexes(this.transform.angle);for(let Ye=Re.length-1;Ye>=0;--Ye){const Ge=Re[Ye];Ue(w.symbolInstances.get(Ge),Ge,w.collisionArrays[Ge])}w.hasAnyZOffset&&l.w(`${w.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(w.hasAnyZOffset){const Re=w.getSortedIndexesByZOffset();for(let Ye=0;Ye<Re.length;++Ye){const Ge=Re[Ye];Ue(w.symbolInstances.get(Ge),Ge,w.collisionArrays[Ge])}}else for(let Re=a.symbolInstanceStart;Re<a.symbolInstanceEnd;Re++)Ue(w.symbolInstances.get(Re),Re,w.collisionArrays[Re]);if(g&&w.bucketInstanceId in this.collisionCircleArrays){const Re=this.collisionCircleArrays[w.bucketInstanceId];l.a6.invert(Re.invProjMatrix,C),Re.viewportMatrix=this.collisionIndex.getViewportMatrix()}w.justReloaded=!1}markUsedJustification(a,d,g,x){const{leftJustifiedTextSymbolIndex:w,centerJustifiedTextSymbolIndex:S,rightJustifiedTextSymbolIndex:C,verticalPlacedTextSymbolIndex:R,crossTileID:D}=g,N=l.be(d),B=x===l.b6.vertical?R:N==="left"?w:N==="center"?S:N==="right"?C:-1;w>=0&&(a.text.placedSymbolArray.get(w).crossTileID=B>=0&&w!==B?0:D),S>=0&&(a.text.placedSymbolArray.get(S).crossTileID=B>=0&&S!==B?0:D),C>=0&&(a.text.placedSymbolArray.get(C).crossTileID=B>=0&&C!==B?0:D),R>=0&&(a.text.placedSymbolArray.get(R).crossTileID=B>=0&&R!==B?0:D)}markUsedOrientation(a,d,g){const x=d===l.b6.horizontal||d===l.b6.horizontalOnly?d:0,w=d===l.b6.vertical?d:0,{leftJustifiedTextSymbolIndex:S,centerJustifiedTextSymbolIndex:C,rightJustifiedTextSymbolIndex:R,verticalPlacedTextSymbolIndex:D}=g,N=a.text.placedSymbolArray;S>=0&&(N.get(S).placedOrientation=x),C>=0&&(N.get(C).placedOrientation=x),R>=0&&(N.get(R).placedOrientation=x),D>=0&&(N.get(D).placedOrientation=w)}commit(a){this.commitTime=a,this.zoomAtLastRecencyCheck=this.transform.zoom;const d=this.prevPlacement;let g=!1;this.prevZoomAdjustment=d?d.zoomAdjustment(this.transform.zoom):0;const x=d?d.symbolFadeChange(a):1,w=d?d.opacities:{},S=d?d.variableOffsets:{},C=d?d.placedOrientations:{};for(const R in this.placements){const D=this.placements[R],N=w[R];N?(this.opacities[R]=new Ia(N,x,D.text,D.icon,null,D.clipped),g=g||D.text!==N.text.placed||D.icon!==N.icon.placed):(this.opacities[R]=new Ia(null,x,D.text,D.icon,D.skipFade,D.clipped),g=g||D.text||D.icon)}for(const R in w){const D=w[R];if(!this.opacities[R]){const N=new Ia(D,x,!1,!1);N.isHidden()||(this.opacities[R]=N,g=g||D.text.placed||D.icon.placed)}}for(const R in S)this.variableOffsets[R]||!this.opacities[R]||this.opacities[R].isHidden()||(this.variableOffsets[R]=S[R]);for(const R in C)this.placedOrientations[R]||!this.opacities[R]||this.opacities[R].isHidden()||(this.placedOrientations[R]=C[R]);g?this.lastPlacementChangeTime=a:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=d?d.lastPlacementChangeTime:a)}updateLayerOpacities(a,d){const g=new Set;for(const x of d){const w=x.getBucket(a);w&&x.latestFeatureIndex&&a.fqid===w.layerIds[0]&&(this.updateBucketOpacities(w,g,x.collisionBoxArray),w.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(w,x.tileID),w.updateZOffset()))}}updateBucketOpacities(a,d,g){a.hasTextData()&&a.text.opacityVertexArray.clear(),a.hasIconData()&&a.icon.opacityVertexArray.clear(),a.hasIconCollisionBoxData()&&a.iconCollisionBox.collisionVertexArray.clear(),a.hasTextCollisionBoxData()&&a.textCollisionBox.collisionVertexArray.clear();const x=a.layers[0].layout,w=!!a.layers[0].dynamicFilter(),S=new Ia(null,0,!1,!1,!0),C=x.get("text-allow-overlap"),R=x.get("icon-allow-overlap"),D=x.get("text-variable-anchor"),N=x.get("text-rotation-alignment")==="map",B=x.get("text-pitch-alignment")==="map",j=new Ia(null,0,C&&(R||!a.hasIconData()||x.get("icon-optional")),R&&(C||!a.hasTextData()||x.get("text-optional")),!0);!a.collisionArrays&&g&&(a.hasIconCollisionBoxData()||a.hasTextCollisionBoxData())&&a.deserializeCollisionBoxes(g);const $=(X,K,q)=>{for(let ee=0;ee<K/4;ee++)X.opacityVertexArray.emplaceBack(q)};let Z=0;for(let X=0;X<a.symbolInstances.length;X++){const K=a.symbolInstances.get(X),{numHorizontalGlyphVertices:q,numVerticalGlyphVertices:ee,crossTileID:ae,numIconVertices:re}=K,le=d.has(ae);let Q=this.opacities[ae];le?Q=S:Q||(Q=j,this.opacities[ae]=Q),d.add(ae);const ce=q>0||ee>0,ve=re>0,we=this.placedOrientations[ae],Ce=we===l.b6.vertical,Ue=we===l.b6.horizontal||we===l.b6.horizontalOnly;if(!ce&&!ve||Q.isHidden()||Z++,ce){const Re=K_(Q.text);$(a.text,q,Ce?ru:Re),$(a.text,ee,Ue?ru:Re);const Ye=Q.text.isHidden(),{leftJustifiedTextSymbolIndex:Ge,centerJustifiedTextSymbolIndex:pt,rightJustifiedTextSymbolIndex:ke,verticalPlacedTextSymbolIndex:He}=K,Me=a.text.placedSymbolArray,Ne=Ye||Ce?1:0;Ge>=0&&(Me.get(Ge).hidden=Ne),pt>=0&&(Me.get(pt).hidden=Ne),ke>=0&&(Me.get(ke).hidden=Ne),He>=0&&(Me.get(He).hidden=Ye||Ue?1:0);const mt=this.variableOffsets[ae];mt&&this.markUsedJustification(a,mt.anchor,K,we);const Mt=this.placedOrientations[ae];Mt&&(this.markUsedJustification(a,"left",K,Mt),this.markUsedOrientation(a,Mt,K))}if(ve){const Re=K_(Q.icon),{placedIconSymbolIndex:Ye,verticalPlacedIconSymbolIndex:Ge}=K,pt=a.icon.placedSymbolArray,ke=Q.icon.isHidden()?1:0;Ye>=0&&($(a.icon,re,Ce?ru:Re),pt.get(Ye).hidden=ke),Ge>=0&&($(a.icon,K.numVerticalIconVertices,Ue?ru:Re),pt.get(Ge).hidden=ke)}if(a.hasIconCollisionBoxData()||a.hasTextCollisionBoxData()){const Re=a.collisionArrays[X];if(Re){let Ye=new l.P(0,0),Ge=!0;if(Re.textBox||Re.verticalTextBox){if(D){const ke=this.variableOffsets[ae];ke?(Ye=dl(ke.anchor,ke.width,ke.height,ke.textOffset,ke.textScale),N&&Ye._rotate(B?this.transform.angle:-this.transform.angle)):Ge=!1}w&&(Ge=!Q.clipped),Re.textBox&&Hl(a.textCollisionBox.collisionVertexArray,Q.text.placed,!Ge||Ce,Ye.x,Ye.y),Re.verticalTextBox&&Hl(a.textCollisionBox.collisionVertexArray,Q.text.placed,!Ge||Ue,Ye.x,Ye.y)}const pt=Ge&&!!(!Ue&&Re.verticalIconBox);Re.iconBox&&Hl(a.iconCollisionBox.collisionVertexArray,Q.icon.placed,pt,K.hasIconTextFit?Ye.x:0,K.hasIconTextFit?Ye.y:0),Re.verticalIconBox&&Hl(a.iconCollisionBox.collisionVertexArray,Q.icon.placed,!pt,K.hasIconTextFit?Ye.x:0,K.hasIconTextFit?Ye.y:0)}}}if(a.fullyClipped=Z===0,a.sortFeatures(this.transform.angle),this.retainedQueryData[a.bucketInstanceId]&&(this.retainedQueryData[a.bucketInstanceId].featureSortOrder=a.featureSortOrder),a.hasTextData()&&a.text.opacityVertexBuffer&&a.text.opacityVertexBuffer.updateData(a.text.opacityVertexArray),a.hasIconData()&&a.icon.opacityVertexBuffer&&a.icon.opacityVertexBuffer.updateData(a.icon.opacityVertexArray),a.hasIconCollisionBoxData()&&a.iconCollisionBox.collisionVertexBuffer&&a.iconCollisionBox.collisionVertexBuffer.updateData(a.iconCollisionBox.collisionVertexArray),a.hasTextCollisionBoxData()&&a.textCollisionBox.collisionVertexBuffer&&a.textCollisionBox.collisionVertexBuffer.updateData(a.textCollisionBox.collisionVertexArray),a.bucketInstanceId in this.collisionCircleArrays){const X=this.collisionCircleArrays[a.bucketInstanceId];a.placementInvProjMatrix=X.invProjMatrix,a.placementViewportMatrix=X.viewportMatrix,a.collisionCircleArray=X.circles,delete this.collisionCircleArrays[a.bucketInstanceId]}}symbolFadeChange(a){return this.fadeDuration===0?1:(a-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(a){return Math.max(0,(this.transform.zoom-a)/1.5)}hasTransitions(a){return this.stale||a-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(a,d){const g=this.zoomAtLastRecencyCheck===d?1-this.zoomAdjustment(d):1;return this.zoomAtLastRecencyCheck=d,this.commitTime+this.fadeDuration*g>a}setStale(){this.stale=!0}}function Hl(_,a,d,g,x){_.emplaceBack(a?1:0,d?1:0,g||0,x||0),_.emplaceBack(a?1:0,d?1:0,g||0,x||0),_.emplaceBack(a?1:0,d?1:0,g||0,x||0),_.emplaceBack(a?1:0,d?1:0,g||0,x||0)}const A1=Math.pow(2,25),Z_=Math.pow(2,24),Y_=Math.pow(2,17),Kf=Math.pow(2,16),M1=Math.pow(2,9),C1=Math.pow(2,8),P1=Math.pow(2,1);function K_(_){if(_.opacity===0&&!_.placed)return 0;if(_.opacity===1&&_.placed)return 4294967295;const a=_.placed?1:0,d=Math.floor(127*_.opacity);return d*A1+a*Z_+d*Y_+a*Kf+d*M1+a*C1+d*P1+a}const ru=0;class I1{constructor(a){this._sortAcrossTiles=a.layout.get("symbol-z-order")!=="viewport-y"&&a.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(a,d,g,x,w){const S=this._bucketParts;for(;this._currentTileIndex<a.length;)if(d.getBucketParts(S,x,a[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,w())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,S.sort((C,R)=>C.sortKey-R.sortKey));this._currentPartIndex<S.length;){const C=S[this._currentPartIndex];if(d.placeLayerBucketPart(C,this._seenCrossTileIDs,g,C.symbolInstanceStart===0),this._currentPartIndex++,w())return!0}return!1}}class Bh{constructor(a,d,g,x,w,S,C,R,D){this.placement=new S1(a,w,S,C,R,D),this._currentPlacementIndex=d.length-1,this._forceFullPlacement=g,this._showCollisionBoxes=x,this._done=!1}isDone(){return this._done}continuePlacement(a,d,g,x){const w=l.f.now(),S=()=>{const C=l.f.now()-w;return!this._forceFullPlacement&&C>2};for(;this._currentPlacementIndex>=0;){const C=d[a[this._currentPlacementIndex]],R=this.placement.collisionIndex.transform.zoom;if(C.type==="symbol"&&(!C.minzoom||C.minzoom<=R)&&(!C.maxzoom||C.maxzoom>R)){const D=C,N=D.layout.get("symbol-z-elevate"),B=this._inProgressLayer=this._inProgressLayer||new I1(D),j=l.ag(C.source,C.scope);if(B.continuePlacement(N?x[j]:g[j],this.placement,this._showCollisionBoxes,C,S))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(a){return this.placement.commit(a),this.placement}}const Jf=512/l.V/2;class J_{constructor(a,d,g){this.tileID=a,this.bucketInstanceId=g,this.index=new l.bg(d.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const x=a.canonical.x*l.V,w=a.canonical.y*l.V;for(let S=0;S<d.length;S++){const{key:C,crossTileID:R,tileAnchorX:D,tileAnchorY:N}=d.get(S),B=Math.floor((x+D)*Jf),j=Math.floor((w+N)*Jf);this.index.add(B,j),this.keys.push(C),this.crossTileIDs.push(R)}this.index.finish()}findMatches(a,d,g){const x=this.tileID.canonical.z<d.canonical.z?1:Math.pow(2,this.tileID.canonical.z-d.canonical.z),w=Jf/Math.pow(2,d.canonical.z-this.tileID.canonical.z),S=d.canonical.x*l.V,C=d.canonical.y*l.V;for(let R=0;R<a.length;R++){const D=a.get(R);if(D.crossTileID)continue;const{key:N,tileAnchorX:B,tileAnchorY:j}=D,$=Math.floor((S+B)*w),Z=Math.floor((C+j)*w),X=this.index.range($-x,Z-x,$+x,Z+x);for(const K of X){const q=this.crossTileIDs[K];if(this.keys[K]===N&&!g.has(q)){g.add(q),D.crossTileID=q;break}}}}}class Qf{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class zh{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(a){const d=Math.round((a-this.lng)/360);if(d!==0)for(const g in this.indexes){const x=this.indexes[g],w={};for(const S in x){const C=x[S];C.tileID=C.tileID.unwrapTo(C.tileID.wrap+d),w[C.tileID.key]=C}this.indexes[g]=w}this.lng=a}addBucket(a,d,g){if(this.indexes[a.overscaledZ]&&this.indexes[a.overscaledZ][a.key]){if(this.indexes[a.overscaledZ][a.key].bucketInstanceId===d.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(a.overscaledZ,this.indexes[a.overscaledZ][a.key])}for(let w=0;w<d.symbolInstances.length;w++)d.symbolInstances.get(w).crossTileID=0;this.usedCrossTileIDs[a.overscaledZ]||(this.usedCrossTileIDs[a.overscaledZ]=new Set);const x=this.usedCrossTileIDs[a.overscaledZ];for(const w in this.indexes){const S=this.indexes[w];if(Number(w)>a.overscaledZ)for(const C in S){const R=S[C];R.tileID.isChildOf(a)&&R.findMatches(d.symbolInstances,a,x)}else{const C=S[a.scaledTo(Number(w)).key];C&&C.findMatches(d.symbolInstances,a,x)}}for(let w=0;w<d.symbolInstances.length;w++){const S=d.symbolInstances.get(w);S.crossTileID||(S.crossTileID=g.generate(),x.add(S.crossTileID))}return this.indexes[a.overscaledZ]===void 0&&(this.indexes[a.overscaledZ]={}),this.indexes[a.overscaledZ][a.key]=new J_(a,d.symbolInstances,d.bucketInstanceId),!0}removeBucketCrossTileIDs(a,d){for(const g of d.crossTileIDs)this.usedCrossTileIDs[a].delete(g)}removeStaleBuckets(a){let d=!1;for(const g in this.indexes){const x=this.indexes[g];for(const w in x)a[x[w].bucketInstanceId]||(this.removeBucketCrossTileIDs(g,x[w]),delete x[w],d=!0)}return d}}class ep{constructor(){this.layerIndexes={},this.crossTileIDs=new Qf,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(a,d,g,x){let w=this.layerIndexes[a.fqid];w===void 0&&(w=this.layerIndexes[a.fqid]=new zh);let S=!1;const C={};x.name!=="globe"&&w.handleWrapJump(g);for(const R of d){const D=R.getBucket(a);D&&a.fqid===D.layerIds[0]&&(D.bucketInstanceId||(D.bucketInstanceId=++this.maxBucketInstanceId),w.addBucket(R.tileID,D,this.crossTileIDs)&&(S=!0),C[D.bucketInstanceId]=!0)}return w.removeStaleBuckets(C)&&(S=!0),S}pruneUnusedLayers(a){const d={};a.forEach(g=>{d[g]=!0});for(const g in this.layerIndexes)d[g]||delete this.layerIndexes[g]}}class fl{constructor(a=0,d=0,g=0,x=0){if(isNaN(a)||a<0||isNaN(d)||d<0||isNaN(g)||g<0||isNaN(x)||x<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=a,this.bottom=d,this.left=g,this.right=x}interpolate(a,d,g){return d.top!=null&&a.top!=null&&(this.top=l.U(a.top,d.top,g)),d.bottom!=null&&a.bottom!=null&&(this.bottom=l.U(a.bottom,d.bottom,g)),d.left!=null&&a.left!=null&&(this.left=l.U(a.left,d.left,g)),d.right!=null&&a.right!=null&&(this.right=l.U(a.right,d.right,g)),this}getCenter(a,d){const g=l.aa((this.left+a-this.right)/2,0,a),x=l.aa((this.top+d-this.bottom)/2,0,d);return new l.P(g,x)}equals(a){return this.top===a.top&&this.bottom===a.bottom&&this.left===a.left&&this.right===a.right}clone(){return new fl(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Uh(_,a){const d=l.bk(_,3);l.a6.fromQuat(_,a),l.bm(_,3,d)}function nu(_,a){const d=l.bi.identity([]);return l.bi.rotateZ(d,d,-a),l.bi.rotateX(d,d,-_),d}function tp(_,a){const d=[_[0],_[1],0],g=[a[0],a[1],0];if(l.N.length(d)>=1e-15){const S=l.N.normalize([],d);l.N.scale(g,S,l.N.dot(g,S)),a[0]=g[0],a[1]=g[1]}const x=l.N.cross([],a,_);if(l.N.len(x)<1e-15)return null;const w=Math.atan2(-x[1],x[0]);return nu(Math.atan2(Math.sqrt(_[0]*_[0]+_[1]*_[1]),-_[2]),w)}class su{constructor(a,d){this.position=a,this.orientation=d}get position(){return this._position}set position(a){if(a){const d=a instanceof l.L?a:new l.L(a[0],a[1],a[2]);this._renderWorldCopies&&(d.x=l.bh(d.x,0,1)),this._position=d}else this._position=null}lookAtPoint(a,d){if(this.orientation=null,!this.position)return;const g=this.position,x=this._elevation?this._elevation.getAtPointOrZero(l.L.fromLngLat(a)):0,w=l.L.fromLngLat(a,x),S=[w.x-g.x,w.y-g.y,w.z-g.z];d||(d=[0,0,1]),d[2]=Math.abs(d[2]),this.orientation=tp(S,d)}setPitchBearing(a,d){this.orientation=nu(l.bj(a),l.bj(-d))}}class ql{constructor(a,d){this._transform=l.a6.identity([]),this.orientation=d,this.position=a}get mercatorPosition(){const a=this.position;return new l.L(a[0],a[1],a[2])}get position(){const a=l.bk(this._transform,3);return[a[0],a[1],a[2]]}set position(a){var d;a&&l.bm(this._transform,3,[(d=a)[0],d[1],d[2],1])}get orientation(){return this._orientation}set orientation(a){this._orientation=a||l.bi.identity([]),a&&Uh(this._transform,this._orientation)}getPitchBearing(){const a=this.forward(),d=this.right();return{bearing:Math.atan2(-d[1],d[0]),pitch:Math.atan2(Math.sqrt(a[0]*a[0]+a[1]*a[1]),-a[2])}}setPitchBearing(a,d){this._orientation=nu(a,d),Uh(this._transform,this._orientation)}forward(){const a=l.bk(this._transform,2);return[-a[0],-a[1],-a[2]]}up(){const a=l.bk(this._transform,1);return[-a[0],-a[1],-a[2]]}right(){const a=l.bk(this._transform,0);return[a[0],a[1],a[2]]}getCameraToWorld(a,d){const g=new Float64Array(16);return l.a6.invert(g,this.getWorldToCamera(a,d)),g}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(a,d,g){const x=this.position;l.N.scale(x,x,-a);const w=new Float64Array(16);return l.a6.fromScaling(w,[g,g,g]),l.a6.translate(w,w,x),w[10]*=d,w}getWorldToCamera(a,d){const g=new Float64Array(16),x=new Float64Array(4),w=this.position;return l.bi.conjugate(x,this._orientation),l.N.scale(w,w,-a),l.a6.fromQuat(g,x),l.a6.translate(g,g,w),g[1]*=-1,g[5]*=-1,g[9]*=-1,g[13]*=-1,g[8]*=d,g[9]*=d,g[10]*=d,g[11]*=d,g}getCameraToClipPerspective(a,d,g,x){const w=new Float64Array(16);return l.a6.perspective(w,a,d,g,x),w}getCameraToClipOrthographic(a,d,g,x,w,S){const C=new Float64Array(16);return l.a6.ortho(C,a,d,g,x,w,S),C}getDistanceToElevation(a,d=!1){const g=a===0?0:l.bl(a,d?l.au(this.position[1]):this.position[1]),x=this.forward();return(g-this.position[2])/x[2]}clone(){return new ql([...this.position],[...this.orientation])}}const Gl=(_,a,d)=>(1-d)*_+d*a,ou=_=>_*_*_*_*_;class au{constructor(a,d,g,x,w,S,C){this.tileSize=512,this._renderWorldCopies=w===void 0||w,this._minZoom=a||0,this._maxZoom=d||22,this._minPitch=g??0,this._maxPitch=x??60,this.setProjection(S),this.setMaxBounds(C),this.width=0,this.height=0,this._center=new l.bn(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new fl,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new ql,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const a=new au(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return a._elevation=this._elevation,a._centerAltitude=this._centerAltitude,a._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,a.tileSize=this.tileSize,a.mercatorFromTransition=this.mercatorFromTransition,a.width=this.width,a.height=this.height,a.cameraElevationReference=this.cameraElevationReference,a._center=this._center,a._setZoom(this.zoom),a._seaLevelZoom=this._seaLevelZoom,a.angle=this.angle,a._fov=this._fov,a._pitch=this._pitch,a._nearZ=this._nearZ,a._farZ=this._farZ,a._averageElevation=this._averageElevation,a._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,a._unmodified=this._unmodified,a._edgeInsets=this._edgeInsets.clone(),a._camera=this._camera.clone(),a._calcMatrices(),a.freezeTileCoverage=this.freezeTileCoverage,a.frustumCorners=this.frustumCorners,a}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(a){this._elevation!==a&&(this._elevation=a,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(a,d=!1){const g=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||g)&&this._updateCameraOnTerrain(),(a||g)&&this._constrainCamera(d),this._calcMatrices()}getProjection(){return l.ac(this.projection,["name","center","parallels"])}setProjection(a){this.projectionOptions=a||{name:"mercator"};const d=this.projection?this.getProjection():void 0;this.projection=l.bo(this.projectionOptions);const g=!A(d,this.getProjection());return g&&this._calcMatrices(),this.mercatorFromTransition=!1,g}setOrthographicProjectionAtLowPitch(a){return this._orthographicProjectionAtLowPitch!==a&&(this._orthographicProjectionAtLowPitch=a,this._calcMatrices(),!0)}setMercatorFromTransition(){const a=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=l.bo({name:"mercator"});const d=a!==this.projection.name;return d&&this._calcMatrices(),d}get minZoom(){return this._minZoom}set minZoom(a){this._minZoom!==a&&(this._minZoom=a,this.zoom=Math.max(this.zoom,a))}get maxZoom(){return this._maxZoom}set maxZoom(a){this._maxZoom!==a&&(this._maxZoom=a,this.zoom=Math.min(this.zoom,a))}get minPitch(){return this._minPitch}set minPitch(a){this._minPitch!==a&&(this._minPitch=a,this.pitch=Math.max(this.pitch,a))}get maxPitch(){return this._maxPitch}set maxPitch(a){this._maxPitch!==a&&(this._maxPitch=a,this.pitch=Math.min(this.pitch,a))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(a){a===void 0?a=!0:a===null&&(a=!1),this._renderWorldCopies=a}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const a=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(a))}get cameraWorldSize(){const a=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(a))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return l.bl(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new l.P(this.width,this.height)}get bearing(){return l.bh(this.rotation,-180,180)}set bearing(a){this.rotation=a}get rotation(){return-this.angle/Math.PI*180}set rotation(a){const d=-a*Math.PI/180;this.angle!==d&&(this._unmodified=!1,this.angle=d,this._calcMatrices(),this.rotationMatrix=l.b4.create(),l.b4.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(a){const d=l.aa(a,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==d&&(this._unmodified=!1,this._pitch=d,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const a=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/a)}set fov(a){a=Math.max(.01,Math.min(60,a)),this._fov!==a&&(this._unmodified=!1,this._fov=l.bj(a),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(a){this._averageElevation=a,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(a){const d=Math.min(Math.max(a,this.minZoom),this.maxZoom);this._zoom!==d&&(this._unmodified=!1,this._setZoom(d),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(a){this._zoom=a,this.scale=this.zoomScale(a),this.tileZoom=Math.floor(a),this.zoomFraction=a-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(a){this._tileCoverLift!==a&&(this._tileCoverLift=a)}_updateCameraOnTerrain(){const a=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,d=this.elevation&&a===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||a===Number.NEGATIVE_INFINITY&&(!d||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const g=this._elevation;d||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&g.exaggeration()&&this._centerAltitudeValidForExaggeration!==g.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*g.exaggeration(),this._centerAltitudeValidForExaggeration=g.exaggeration()):(this._centerAltitude=a||0,this._centerAltitudeValidForExaggeration=g.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const a=this._elevation,d=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],g=this.horizonLineFromTop();let x=0,w=0;for(let S=0;S<d.length;S++){const C=new l.P(d[S][0]*this.width,g+d[S][1]*(this.height-g)),R=a.pointCoordinate(C);if(!R)continue;const D=1/Math.hypot(R[0]-this._camera.position[0],R[1]-this._camera.position[1]);x+=R[3]*D,w+=D}return w===0?NaN:x/w}get center(){return this._center}set center(a){a.lat===this._center.lat&&a.lng===this._center.lng||(this._unmodified=!1,this._center=a,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const a=this._seaLevelZoom,d=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),g=this.pixelsPerMeter/this.worldSize*d,x=this._mercatorZfromZoom(a),w=this._mercatorZfromZoom(this._maxZoom),S=Math.max(x-g,w);this._setZoom(this._zoomFromMercatorZ(S))}get padding(){return this._edgeInsets.toJSON()}set padding(a){this._edgeInsets.equals(a)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,a,1),this._calcMatrices())}computeZoomRelativeTo(a){const d=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,a.toAltitude()));let g;g=a.z<this._camera.position[2]?[d.x,d.y,d.z]:[a.x,a.y,a.z];const x=l.N.length(l.N.sub([],this._camera.position,g));return l.aa(this._zoomFromMercatorZ(x),this._minZoom,this._maxZoom)}setFreeCameraOptions(a){if(!this.height||!a.position&&!a.orientation)return;this._updateCameraState();let d=!1;if(a.orientation&&!l.bi.exactEquals(a.orientation,this._camera.orientation)&&(d=this._setCameraOrientation(a.orientation)),a.position){const g=[a.position.x,a.position.y,a.position.z];l.N.exactEquals(g,this._camera.position)||(this._setCameraPosition(g),d=!0)}d&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const a=this._camera.position,d=new su;return d.position=new l.L(a[0],a[1],a[2]),d.orientation=this._camera.orientation,d._elevation=this.elevation,d._renderWorldCopies=this.renderWorldCopies,d}_setCameraOrientation(a){if(!l.bi.length(a))return!1;l.bi.normalize(a,a);const d=l.N.transformQuat([],[0,0,-1],a),g=l.N.transformQuat([],[0,-1,0],a);if(g[2]<0)return!1;const x=tp(d,g);return!!x&&(this._camera.orientation=x,!0)}_setCameraPosition(a){const d=this.zoomScale(this.minZoom)*this.tileSize,g=this.zoomScale(this.maxZoom)*this.tileSize,x=this.cameraToCenterDistance;a[2]=l.aa(a[2],x/g,x/d),this._camera.position=a}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(a){return this._edgeInsets.equals(a)}interpolatePadding(a,d,g){this._unmodified=!1,this._edgeInsets.interpolate(a,d,g),this._constrain(),this._calcMatrices()}coveringZoomLevel(a){const d=(a.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/a.tileSize));return Math.max(0,d)}getVisibleUnwrappedCoordinates(a){const d=[new l.bp(0,a)];if(this.renderWorldCopies){const g=this.pointCoordinate(new l.P(0,0)),x=this.pointCoordinate(new l.P(this.width,0)),w=this.pointCoordinate(new l.P(this.width,this.height)),S=this.pointCoordinate(new l.P(0,this.height)),C=Math.floor(Math.min(g.x,x.x,w.x,S.x)),R=Math.floor(Math.max(g.x,x.x,w.x,S.x)),D=1;for(let N=C-D;N<=R+D;N++)N!==0&&d.push(new l.bp(N,a))}return d}isLODDisabled(a){return(!a||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCoverForShadows(a,d,g){let x=[];if(d[0]===0&&d[1]===0)return x;for(const S of a){const C=S.canonical,R=S.overscaledZ,D=S.wrap,N=1<<C.z,B=C.x+1<N,j=C.x>0,$=C.y+1<N,Z=C.y>0,X=S.wrap-(j?0:1),K=S.wrap+(B?0:1),q=j?C.x-1:N-1,ee=B?C.x+1:0;d[0]<0?(x.push(new l.am(R,K,C.z,ee,C.y)),d[1]<0&&$&&(x.push(new l.am(R,D,C.z,C.x,C.y+1)),x.push(new l.am(R,K,C.z,ee,C.y+1))),d[1]>0&&Z&&(x.push(new l.am(R,D,C.z,C.x,C.y-1)),x.push(new l.am(R,K,C.z,ee,C.y-1)))):d[0]>0?(x.push(new l.am(R,X,C.z,q,C.y)),d[1]<0&&$&&(x.push(new l.am(R,D,C.z,C.x,C.y+1)),x.push(new l.am(R,X,C.z,q,C.y+1))),d[1]>0&&Z&&(x.push(new l.am(R,D,C.z,C.x,C.y-1)),x.push(new l.am(R,X,C.z,q,C.y-1)))):d[1]<0&&$?x.push(new l.am(R,D,C.z,C.x,C.y+1)):Z&&x.push(new l.am(R,D,C.z,C.x,C.y-1))}if(x.length>1){x.sort((R,D)=>R.overscaledZ-D.overscaledZ||R.wrap-D.wrap||R.canonical.z-D.canonical.z||R.canonical.x-D.canonical.x||R.canonical.y-D.canonical.y);let S=0,C=0;for(;C<x.length;)x[C].equals(x[S])?++C:x[++S]=x[C++];x.length=S+1}const w=[];for(const S of x)x.some(C=>S.isChildOf(C))||w.push(S);return x=w.filter(S=>!a.some(C=>!!(S.overscaledZ<g&&C.isChildOf(S))||S.equals(C)||S.isChildOf(C))),x}coveringTiles(a){let d=this.coveringZoomLevel(a);const g=d,x=this.elevation&&this.elevation.exaggeration(),w=x&&!a.isTerrainDEM,S=this.projection.name==="mercator";if(a.minzoom!==void 0&&d<a.minzoom)return[];a.maxzoom!==void 0&&d>a.maxzoom&&(d=a.maxzoom);const C=this.locationCoordinate(this.center),R=this.center.lat,D=1<<d,N=[D*C.x,D*C.y,0],B=this.projection.name==="globe",j=!B,$=l.bq.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,d,j),Z=B?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),X=D*l.bl(1,this.center.lat),K=this._camera.position[2]/l.bl(1,this.center.lat),q=[D*Z.x,D*Z.y,K*(j?1:X)],ee=B||x,ae=this.cameraToCenterDistance/a.tileSize*(a.roundZoom?1:.502),re=this.isLODDisabled(!0)?d:0;let le;if(this._elevation&&a.isTerrainDEM)le=1e4*this._elevation.exaggeration();else if(this._elevation){const Me=this._elevation.getMinMaxForVisibleTiles();le=Me?Me.max:this._centerAltitude}else le=this._centerAltitude;const Q=a.isTerrainDEM?-le:this._elevation?this._elevation.getMinElevationBelowMSL():0,ce=this.projection.isReprojectedInTileSpace?l.br(this):1,ve=Me=>{const mt=new l.L(Me.x+25e-6,Me.y,Me.z),Mt=new l.L(Me.x,Me.y+25e-6,Me.z),Tt=Me.toLngLat(),Lt=mt.toLngLat(),Zt=Mt.toLngLat(),si=this.locationCoordinate(Tt),ei=this.locationCoordinate(Lt),ii=this.locationCoordinate(Zt),Ii=Math.hypot(ei.x-si.x,ei.y-si.y),gi=Math.hypot(ii.x-si.x,ii.y-si.y);return Math.sqrt(Ii*gi)*ce/25e-6},we=Me=>{const Ne=le,mt=Q;return{aabb:l.bu(this,D,0,0,0,Me,mt,Ne,this.projection),zoom:0,x:0,y:0,minZ:mt,maxZ:Ne,wrap:Me,fullyVisible:!1}},Ce=[];let Ue=[];const Re=d,Ye=a.reparseOverscaled?g:d,Ge=Me=>Me*Me,pt=Ge((K-this._centerAltitude)*X),ke=Me=>{if(!this._elevation||!Me.tileID||!S)return;const Ne=this._elevation.getMinMaxForTile(Me.tileID),mt=Me.aabb;Ne?(mt.min[2]=Ne.min,mt.max[2]=Ne.max,mt.center[2]=(mt.min[2]+mt.max[2])/2):(Me.shouldSplit=He(Me),Me.shouldSplit||(mt.min[2]=mt.max[2]=mt.center[2]=this._centerAltitude))},He=Me=>{if(Me.zoom<re)return!0;if(Me.zoom===Re)return!1;if(Me.shouldSplit!=null)return Me.shouldSplit;const Ne=Me.aabb.distanceX(q),mt=Me.aabb.distanceY(q);let Mt=pt,Tt=1;if(B){Mt=Ge(Me.aabb.distanceZ(q));const si=Math.pow(2,Me.zoom),ei=l.au((Me.y+1)/si),ii=l.au(Me.y/si),Ii=Math.min(Math.max(R,ei),ii),gi=l.bJ(Ii)/l.bJ(R);if(Tt=Ii===R?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,gi/this._mercatorScaleRatio),this.zoom<=l.bG&&Me.zoom===Re-1&&gi>=.9)return!0}else if(w&&(Mt=Ge(Me.aabb.distanceZ(q)*X)),this.projection.isReprojectedInTileSpace&&g<=5){const si=Math.pow(2,Me.zoom),ei=ve(new l.L((Me.x+.5)/si,(Me.y+.5)/si));Tt=ei>.85?1:ei}const Lt=Ne*Ne+mt*mt+Mt,Zt=Ge((1<<Re-Me.zoom)*ae*Tt*((si,ei)=>{if(ei*Ge(.707)<si)return 1;const ii=Math.sqrt(ei/si);return ii/(1.4144271570014144+(Math.pow(1.1,ii-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(Mt,pt),Lt));return Lt<Zt};if(this.renderWorldCopies)for(let Me=1;Me<=3;Me++)Ce.push(we(-Me)),Ce.push(we(Me));for(Ce.push(we(0));Ce.length>0;){const Me=Ce.pop(),Ne=Me.x,mt=Me.y;let Mt=Me.fullyVisible;const Tt=()=>this.projection.name==="globe"&&(Me.y===0||Me.y===(1<<Me.zoom)-1);if(!Mt){let Lt=ee?Me.aabb.intersects($):Me.aabb.intersectsFlat($);if(Lt===0&&Tt()){const Zt=new l.bs(Me.zoom,Ne,mt);Lt=l.bt(this,D,Zt,!0).intersects($)}if(Lt===0)continue;Mt=Lt===2}if(Me.zoom!==Re&&He(Me))for(let Lt=0;Lt<4;Lt++){const Zt=(Ne<<1)+Lt%2,si=(mt<<1)+(Lt>>1),ei={aabb:S?Me.aabb.quadrant(Lt):l.bu(this,D,Me.zoom+1,Zt,si,Me.wrap,Me.minZ,Me.maxZ,this.projection),zoom:Me.zoom+1,x:Zt,y:si,wrap:Me.wrap,fullyVisible:Mt,tileID:void 0,shouldSplit:void 0,minZ:Me.minZ,maxZ:Me.maxZ};w&&!B&&(ei.tileID=new l.am(Me.zoom+1===Re?Ye:Me.zoom+1,Me.wrap,Me.zoom+1,Zt,si),ke(ei)),Ce.push(ei)}else{const Lt=Me.zoom===Re?Ye:Me.zoom;if(a.minzoom&&a.minzoom>Lt)continue;if(!Mt){let ii=ee?Me.aabb.intersectsPrecise($):Me.aabb.intersectsPreciseFlat($);if(ii===0&&Tt()){const Ii=new l.bs(Me.zoom,Ne,mt);ii=l.bt(this,D,Ii,!0).intersectsPrecise($)}if(ii===0)continue}const Zt=N[0]-(.5+Ne+(Me.wrap<<Me.zoom))*(1<<d-Me.zoom),si=N[1]-.5-mt,ei=Me.tileID?Me.tileID:new l.am(Lt,Me.wrap,Me.zoom,Ne,mt);Ue.push({tileID:ei,distanceSq:Zt*Zt+si*si})}}if(this.fogCullDistSq){const Me=this.fogCullDistSq,Ne=this.horizonLineFromTop();Ue=Ue.filter(mt=>{const Mt=[0,0,0,1],Tt=[l.V,l.V,0,1],Lt=this.calculateFogTileMatrix(mt.tileID.toUnwrapped());l.a7.transformMat4(Mt,Mt,Lt),l.a7.transformMat4(Tt,Tt,Lt);const Zt=l.a7.min([],Mt,Tt),si=l.a7.max([],Mt,Tt),ei=l.bv(Zt,si);if(ei===0)return!0;let ii=!1;const Ii=this._elevation;if(Ii&&ei>Me&&Ne!==0){const gi=this.calculateProjMatrix(mt.tileID.toUnwrapped());let Ti;a.isTerrainDEM||(Ti=Ii.getMinMaxForTile(mt.tileID)),Ti||(Ti={min:Q,max:le});const wi=l.bH(this.rotation),Qi=[wi[0]*l.V,wi[1]*l.V,Ti.max];l.N.transformMat4(Qi,Qi,gi),ii=(1-Qi[1])*this.height*.5<Ne}return ei<Me||ii})}return Ue.sort((Me,Ne)=>Me.distanceSq-Ne.distanceSq).map(Me=>Me.tileID)}resize(a,d){this.width=a,this.height=d,this.pixelsToGLUnits=[2/a,-2/d],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(a){return Math.pow(2,a)}scaleZoom(a){return Math.log(a)/Math.LN2}project(a){const d=l.aa(a.lat,-l.bw,l.bw),g=this.projection.project(a.lng,d);return new l.P(g.x*this.worldSize,g.y*this.worldSize)}unproject(a){return this.projection.unproject(a.x/this.worldSize,a.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/l.bl(1,this.center.lat)/this.worldSize}setLocationAtPoint(a,d){let g,x;const w=this.centerPoint;if(this.projection.name==="globe"){const C=this.worldSize;g=(d.x-w.x)/C,x=(d.y-w.y)/C}else{const C=this.pointCoordinate(d),R=this.pointCoordinate(w);g=C.x-R.x,x=C.y-R.y}const S=this.locationCoordinate(a);this.setLocation(new l.L(S.x-g,S.y-x))}setLocation(a){this.center=this.coordinateLocation(a),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(a){return this.projection.locationPoint(this,a)}locationPoint3D(a){return this.projection.locationPoint(this,a,!0)}pointLocation(a){return this.coordinateLocation(this.pointCoordinate(a))}pointLocation3D(a){return this.coordinateLocation(this.pointCoordinate3D(a))}locationCoordinate(a,d){const g=d?l.bl(d,a.lat):void 0,x=this.projection.project(a.lng,a.lat);return new l.L(x.x,x.y,g)}coordinateLocation(a){return this.projection.unproject(a.x,a.y)}pointRayIntersection(a,d){const g=d??this._centerAltitude,x=[a.x,a.y,0,1],w=[a.x,a.y,1,1];l.a7.transformMat4(x,x,this.pixelMatrixInverse),l.a7.transformMat4(w,w,this.pixelMatrixInverse);const S=w[3];l.a7.scale(x,x,1/x[3]),l.a7.scale(w,w,1/S);const C=x[2],R=w[2];return{p0:x,p1:w,t:C===R?0:(g-C)/(R-C)}}screenPointToMercatorRay(a){const d=[a.x,a.y,0,1],g=[a.x,a.y,1,1];return l.a7.transformMat4(d,d,this.pixelMatrixInverse),l.a7.transformMat4(g,g,this.pixelMatrixInverse),l.a7.scale(d,d,1/d[3]),l.a7.scale(g,g,1/g[3]),d[2]=l.bl(d[2],this._center.lat)*this.worldSize,g[2]=l.bl(g[2],this._center.lat)*this.worldSize,l.a7.scale(d,d,1/this.worldSize),l.a7.scale(g,g,1/this.worldSize),new l.a2([d[0],d[1],d[2]],l.N.normalize([],l.N.sub([],g,d)))}rayIntersectionCoordinate(a){const{p0:d,p1:g,t:x}=a,w=l.bl(d[2],this._center.lat),S=l.bl(g[2],this._center.lat);return new l.L(l.U(d[0],g[0],x)/this.worldSize,l.U(d[1],g[1],x)/this.worldSize,l.U(w,S,x))}pointCoordinate(a,d=this._centerAltitude){return this.projection.pointCoordinate(this,a.x,a.y,d)}pointCoordinate3D(a){if(!this.elevation)return this.pointCoordinate(a);let d=this.projection.pointCoordinate3D(this,a.x,a.y);if(d)return new l.L(d[0],d[1],d[2]);let g=0,x=this.horizonLineFromTop();if(a.y>x)return this.pointCoordinate(a);const w=.02*x,S=a.clone();for(let C=0;C<10&&x-g>w;C++){S.y=l.U(g,x,.66);const R=this.projection.pointCoordinate3D(this,S.x,S.y);R?(x=S.y,d=R):g=S.y}return d?new l.L(d[0],d[1],d[2]):this.pointCoordinate(a)}isPointAboveHorizon(a){return this.projection.isPointAboveHorizon(this,a)}isPointOnSurface(a){if(a.y<0||a.y>this.height||a.x<0||a.x>this.width)return!1;if(this.elevation||this.zoom>=l.bx)return!this.isPointAboveHorizon(a);const d=this.pointCoordinate(a);return d.y>=0&&d.y<=1}_coordinatePoint(a,d){const g=d&&this.elevation?this.elevation.getAtPointOrZero(a,this._centerAltitude):this._centerAltitude,x=[a.x*this.worldSize,a.y*this.worldSize,g+a.toAltitude(),1];return l.a7.transformMat4(x,x,this.pixelMatrix),x[3]>0?new l.P(x[0]/x[3],x[1]/x[3]):new l.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:a,left:d}=this._edgeInsets,g=this.height-this._edgeInsets.bottom,x=this.width-this._edgeInsets.right,w=this.pointLocation3D(new l.P(d,a)),S=this.pointLocation3D(new l.P(x,a)),C=this.pointLocation3D(new l.P(x,g)),R=this.pointLocation3D(new l.P(d,g));let D=Math.min(w.lng,S.lng,C.lng,R.lng),N=Math.max(w.lng,S.lng,C.lng,R.lng),B=Math.min(w.lat,S.lat,C.lat,R.lat),j=Math.max(w.lat,S.lat,C.lat,R.lat);const $=Math.pow(2,-this.zoom)/16*270,Z=this.projection.name==="globe"?1:4,X=(K,q,ee,ae,re)=>{const le=(K+ee)/2,Q=(q+ae)/2,ce=new l.P(le,Q),{lng:ve,lat:we}=this.pointLocation3D(ce),Ce=Math.max(0,D-ve,B-we,ve-N,we-j);D=Math.min(D,ve),N=Math.max(N,ve),B=Math.min(B,we),j=Math.max(j,we),(re<Z||Ce>$)&&(X(K,q,le,Q,re+1),X(le,Q,ee,ae,re+1))};if(X(d,a,x,a,1),X(x,a,x,g,1),X(x,g,d,g,1),X(d,g,d,a,1),this.projection.name==="globe"){const[K,q]=l.by(this);K?(j=90,N=180,D=-180):q&&(B=-90,N=180,D=-180)}return new l.ad(new l.bn(D,B),new l.bn(N,j))}_getBoundsRectangular(a,d){const{top:g,left:x}=this._edgeInsets,w=this.height-this._edgeInsets.bottom,S=this.width-this._edgeInsets.right,C=new l.P(x,g),R=new l.P(S,g),D=new l.P(S,w),N=new l.P(x,w);let B=this.pointCoordinate(C,a),j=this.pointCoordinate(R,a);const $=this.pointCoordinate(D,d),Z=this.pointCoordinate(N,d),X=(K,q)=>(q.y-K.y)/(q.x-K.x);return B.y>1&&j.y>=0?B=new l.L((1-Z.y)/X(Z,B)+Z.x,1):B.y<0&&j.y<=1&&(B=new l.L(-Z.y/X(Z,B)+Z.x,0)),j.y>1&&B.y>=0?j=new l.L((1-$.y)/X($,j)+$.x,1):j.y<0&&B.y<=1&&(j=new l.L(-$.y/X($,j)+$.x,0)),new l.ad().extend(this.coordinateLocation(B)).extend(this.coordinateLocation(j)).extend(this.coordinateLocation(Z)).extend(this.coordinateLocation($))}_getBoundsRectangularTerrain(){const a=this.elevation;if(!a.visibleDemTiles.length||a.isUsingMockSource())return this._getBoundsRectangular(0,0);const d=a.visibleDemTiles.reduce((g,x)=>{if(x.dem){const w=x.dem.tree;g.min=Math.min(g.min,w.minimums[0]),g.max=Math.max(g.max,w.maximums[0])}return g},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(d.min*a.exaggeration(),d.max*a.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(a=!0){const d=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,g=this.height/2-d*(1-this._horizonShift);return a?Math.max(0,g):g}getMaxBounds(){return this.maxBounds}setMaxBounds(a){this.maxBounds=a,this.minLat=-l.bw,this.maxLat=l.bw,this.minLng=-180,this.maxLng=180,a&&(this.minLat=a.getSouth(),this.maxLat=a.getNorth(),this.minLng=a.getWest(),this.maxLng=a.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=l.a5(this.minLng)*this.tileSize,this.worldMaxX=l.a5(this.maxLng)*this.tileSize,this.worldMinY=l.ae(this.maxLat)*this.tileSize,this.worldMaxY=l.ae(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(a,d){return this.projection.createTileMatrix(this,d,a)}calculateDistanceTileData(a){const d=a.key,g=this._distanceTileDataCache;if(g[d])return g[d];const x=a.canonical,w=1/this.height,S=this.cameraWorldSize,C=S/this.zoomScale(x.z),R=(x.x+Math.pow(2,x.z)*a.wrap)*C,D=x.y*C,N=this.point;N.x*=S/this.worldSize,N.y*=S/this.worldSize;const B=this.angle,j=Math.sin(-B),$=-Math.cos(-B);return g[d]={bearing:[j,$],center:[(N.x-R)*w,(N.y-D)*w],scale:C/l.V*w},g[d]}calculateFogTileMatrix(a){const d=a.key,g=this._fogTileMatrixCache;if(g[d])return g[d];const x=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,a);return l.a6.multiply(x,this.worldToFogMatrix,x),g[d]=new Float32Array(x),g[d]}calculateProjMatrix(a,d=!1,g=!1){const x=a.key;let w;if(w=g?this._expandedProjMatrixCache:d?this._alignedProjMatrixCache:this._projMatrixCache,w[x])return w[x];const S=this.calculatePosMatrix(a,this.worldSize);let C;return C=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:g?this.expandedFarZProjMatrix:d?this.alignedProjMatrix:this.projMatrix,l.a6.multiply(S,C,S),w[x]=new Float32Array(S),w[x]}calculatePixelsToTileUnitsMatrix(a){const d=a.tileID.key,g=this._pixelsToTileUnitsCache;if(g[d])return g[d];const x=l.bz(a,this);return g[d]=x,g[d]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const a=1/this.worldSize,d=l.a6.fromScaling([],[a,a,a]);return l.a6.multiply(d,d,this.globeMatrix),d}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const a=this._elevation;this._updateCameraState();const d=l.bl(1,this._center.lat)*this.worldSize,g=this._computeCameraPosition(d),x=this._camera.forward(),w=l.bl(1,this._center.lat);g[2]/=w,x[2]/=w,l.N.normalize(x,x);const S=a.raycast(g,x,a.exaggeration());if(S){const C=l.N.scaleAndAdd([],g,x,S),R=new l.L(C[0],C[1],l.bl(C[2],l.au(C[1]))),D=(R.z+l.N.length([R.x-g[0],R.y-g[1],R.z-g[2]*w]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(D),this._centerAltitude=R.toAltitude(),this._center=this.coordinateLocation(R),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(a=!1){if(!this._elevation)return;const d=this._elevation,g=l.bl(1,this._center.lat)*this.worldSize,x=this._computeCameraPosition(g),w=d.getAtPointOrZero(new l.L(...x)),S=this.pixelsPerMeter/this.worldSize*w,C=this._minimumHeightOverTerrain(),R=x[2]-S;if(R<=C)if(R<0||a){const D=this.locationCoordinate(this._center,this._centerAltitude),N=[x[0],x[1],D.z-x[2]],B=l.N.length(N);N[2]-=(C-R)/this._pixelsPerMercatorPixel;const j=l.N.length(N);if(j===0)return;l.N.scale(N,N,B/j*this._pixelsPerMercatorPixel),this._camera.position=[x[0],x[1],D.z*this._pixelsPerMercatorPixel-N[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const a=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||a){const j=this.center;return j.lat=l.aa(j.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!a)&&(j.lng=l.aa(j.lng,this.minLng,this.maxLng)),this.center=j,void(this._constraining=!1)}const d=this._unmodified,{x:g,y:x}=this.point;let w=0,S=g,C=x;const R=this.width/2,D=this.height/2,N=this.worldMinY*this.scale,B=this.worldMaxY*this.scale;if(x-D<N&&(C=N+D),x+D>B&&(C=B-D),B-N<this.height&&(w=Math.max(w,this.height/(B-N)),C=(B+N)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const j=this.worldMinX*this.scale,$=this.worldMaxX*this.scale,Z=this.worldSize/2-(j+$)/2;S=(g+Z+this.worldSize)%this.worldSize-Z,S-R<j&&(S=j+R),S+R>$&&(S=$-R),$-j<this.width&&(w=Math.max(w,this.width/($-j)),S=($+j)/2)}S===g&&C===x||(this.center=this.unproject(new l.P(S,C))),w&&(this.zoom+=this.scaleZoom(w)),this._constrainCamera(),this._unmodified=d,this._constraining=!1}_minZoomForBounds(){let a=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(a=Math.max(a,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),a}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const a=this.centerOffset,d=this.projection.name==="globe",g=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=l.bl(1,this.center.lat)/l.bl(1,l.bI));const x=l.bA(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,x),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const w=this.projection.zAxisUnit==="meters"?g:1,S=this._camera.getWorldToCamera(this.worldSize,w);let C;const R=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(R[8]=2*-a.x/this.width,R[9]=2*a.y/this.height,this.isOrthographic){let we=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),Ce=we*this.aspect,Ue=-Ce,Re=-we;Ce-=a.x,Ue-=a.x,we+=a.y,Re+=a.y,C=this._camera.getCameraToClipOrthographic(Ue,Ce,Re,we,this._nearZ,this._farZ),((Ye,Ge,pt,ke)=>{for(let He=0;He<16;He++)Ye[He]=Gl(Ge[He],pt[He],ke)})(C,C,R,ou(this.pitch>=15?1:this.pitch/15))}else C=R;const D=l.a6.mul([],R,S);let N=l.a6.mul([],C,S);if(this.projection.isReprojectedInTileSpace){const we=this.locationCoordinate(this.center),Ce=l.a6.identity([]);l.a6.translate(Ce,Ce,[we.x*this.worldSize,we.y*this.worldSize,0]),l.a6.multiply(Ce,Ce,l.bB(this)),l.a6.translate(Ce,Ce,[-we.x*this.worldSize,-we.y*this.worldSize,0]),l.a6.multiply(N,N,Ce),l.a6.multiply(D,D,Ce),this.inverseAdjustmentMatrix=l.bC(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=l.a6.scale([],N,[this.worldSize,this.worldSize,this.worldSize/w,1]),this.projMatrix=N,this.invProjMatrix=l.a6.invert(new Float64Array(16),this.projMatrix),d){const we=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);we[8]=2*-a.x/this.width,we[9]=2*a.y/this.height,this.expandedFarZProjMatrix=l.a6.mul([],we,S)}else this.expandedFarZProjMatrix=this.projMatrix;const B=l.a6.invert([],C);this.frustumCorners=l.bD.fromInvProjectionMatrix(B,this.horizonLineFromTop(),this.height),this.cameraFrustum=l.bq.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!d);const j=new Float32Array(16);l.a6.identity(j),l.a6.scale(j,j,[1,-1,1]),l.a6.rotateX(j,j,this._pitch),l.a6.rotateZ(j,j,this.angle);const $=l.a6.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=l.a6.clone($);const Z=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;$[8]=2*-a.x/this.width,$[9]=2*(a.y+Z)/this.height,this.skyboxMatrix=l.a6.multiply(j,$,j);const X=this.point,K=X.x,q=X.y,ee=this.width%2/2,ae=this.height%2/2,re=Math.cos(this.angle),le=Math.sin(this.angle),Q=K-Math.round(K)+re*ee+le*ae,ce=q-Math.round(q)+re*ae+le*ee,ve=new Float64Array(N);if(l.a6.translate(ve,ve,[Q>.5?Q-1:Q,ce>.5?ce-1:ce,0]),this.alignedProjMatrix=ve,N=l.a6.create(),l.a6.scale(N,N,[this.width/2,-this.height/2,1]),l.a6.translate(N,N,[1,-1,0]),this.labelPlaneMatrix=N,N=l.a6.create(),l.a6.scale(N,N,[1,-1,1]),l.a6.translate(N,N,[-1,-1,0]),l.a6.scale(N,N,[2/this.width,2/this.height,1]),this.glCoordMatrix=N,this.pixelMatrix=l.a6.multiply(new Float64Array(16),this.labelPlaneMatrix,D),this._calcFogMatrices(),this._distanceTileDataCache={},N=l.a6.invert(new Float64Array(16),this.pixelMatrix),!N)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=N,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=l.bE(this);const we=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=l.N.transformMat4(we,we,S),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=N;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const a=this.cameraWorldSizeForFog,d=this.cameraPixelsPerMeter,g=this._camera.position,x=1/this.height/this._pixelsPerMercatorPixel,w=[a,a,d];l.N.scale(w,w,x),l.N.scale(g,g,-1),l.N.multiply(g,g,w);const S=l.a6.create();l.a6.translate(S,S,g),l.a6.scale(S,S,w),this.mercatorFogMatrix=S,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(a,d,x)}_computeCameraPosition(a){const d=(a=a||this.pixelsPerMeter)/this.pixelsPerMeter,g=this._camera.forward(),x=this.point,w=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*d-a/this.worldSize*this._centerAltitude;return[x.x/this.worldSize-g[0]*w,x.y/this.worldSize-g[1]*w,a/this.worldSize*this._centerAltitude-g[2]*w]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(a){const d=this._maxCameraBoundsDistance()*Math.cos(this._pitch),g=this._camera.position[2],x=a[2];let w=1;this.projection.wrap&&(this.center=this.center.wrap()),x>0&&(w=Math.min((d-g)/x,1)),this._camera.position=l.N.scaleAndAdd([],this._camera.position,a,w),this._updateStateFromCamera()}_updateStateFromCamera(){const a=this._camera.position,d=this._camera.forward(),{pitch:g,bearing:x}=this._camera.getPitchBearing(),w=l.bl(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,S=this._mercatorZfromZoom(this._maxZoom)*Math.cos(l.bj(this._maxPitch)),C=Math.max((a[2]-w)/Math.cos(g),S),R=this._zoomFromMercatorZ(C);l.N.scaleAndAdd(a,a,d,C),this._pitch=l.aa(g,l.bj(this.minPitch),l.bj(this.maxPitch)),this.angle=l.bh(x,-Math.PI,Math.PI),this._setZoom(l.aa(R,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new l.L(a[0],a[1],a[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(a){return Math.pow(2,a)*this.tileSize}_mercatorZfromZoom(a){return this.cameraToCenterDistance/this._worldSizeFromZoom(a)}_minimumHeightOverTerrain(){const a=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(a)}_zoomFromMercatorZ(a){return this.scaleZoom(this.cameraToCenterDistance/(a*this.tileSize))}zoomFromMercatorZAdjusted(a){let d=0,g=l.bx,x=0,w=1/0;for(;g-d>1e-6&&g>d;){const S=d+.5*(g-d),C=this.tileSize*Math.pow(2,S),R=this.getCameraToCenterDistance(this.projection,S,C),D=this.scaleZoom(R/(a*this.tileSize)),N=Math.abs(S-D);N<w&&(w=N,x=S),S<D?d=S:g=S}return x}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(l.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(a,d){const g=Math.min(a.x,d.x),x=Math.max(a.x,d.x),w=Math.min(a.y,d.y),S=Math.max(a.y,d.y);if(w<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const C=[new l.P(g,w),new l.P(x,S),new l.P(g,S),new l.P(x,w)],R=this.renderWorldCopies?-3:0,D=this.renderWorldCopies?4:1;for(const N of C){const B=this.pointRayIntersection(N);if(B.t<0)return!0;const j=this.rayIntersectionCoordinate(B);if(j.x<R||j.y<0||j.x>D||j.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+l.bF(this.fovAboveCenter)>88||this.anyCornerOffEdge(new l.P(0,0),new l.P(this.width,this.height))}zoomDeltaToMovement(a,d){const g=l.N.length(l.N.sub([],this._camera.position,a)),x=this._zoomFromMercatorZ(g)+d;return g-this._mercatorZfromZoom(x)}getCameraPoint(){if(this.projection.name==="globe"){const a=function([d,g,x],w){const S=[d,g,x,1];l.a7.transformMat4(S,S,w);const C=S[3]=Math.max(S[3],1e-6);return S[0]/=C,S[1]/=C,S[2]/=C,S}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new l.P(a[0],a[1])}{const a=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new l.P(0,a))}}getCameraToCenterDistance(a,d=this.zoom,g=this.worldSize){const x=l.bA(a,d,this.width,this.height,1024),w=a.pixelSpaceConversion(this.center.lat,g,x);let S=.5/Math.tan(.5*this._fov)*this.height*w;return this.isOrthographic&&(S=Gl(1,S,ou(this.pitch>=15?1:this.pitch/15))),S}getWorldToCameraMatrix(){const a=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&l.a6.multiply(a,a,this.globeMatrix),a}getFrustum(a){return l.bq.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,a,this.projection.zAxisUnit==="meters")}}const ys={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,ShadowMap0:10},Ra=(_,a)=>{if(a>0&&_.terrain&&l.w("Cutoff is currently disabled on terrain"),a<=0||_.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const d=_.transform,g=Math.max(Math.abs(d._zoom-(_.minCutoffZoom-1)),1),x=d.isLODDisabled(!1)?l.O(60,45,d.pitch):l.O(30,15,d.pitch),w=d._farZ-d._nearZ,S=a*d.height,C=((1-(R=x))*d.cameraToCenterDistance+R*(d._farZ+S))*g;var R;return{shouldRenderCutoff:x<1,uniformValues:{u_cutoff_params:[d._nearZ,d._farZ,(C-d._nearZ)/w,(C-S-d._nearZ)/w]}}},Ds={cascadeCount:2,shadowMapResolution:2048};class ip{constructor(a,d){this.aabb=a,this.lastCascade=d}}class Q_{add(a,d){const g=this.receivers[a.key];g!==void 0?(g.aabb.min[0]=Math.min(g.aabb.min[0],d.min[0]),g.aabb.min[1]=Math.min(g.aabb.min[1],d.min[1]),g.aabb.min[2]=Math.min(g.aabb.min[2],d.min[2]),g.aabb.max[0]=Math.max(g.aabb.max[0],d.max[0]),g.aabb.max[1]=Math.max(g.aabb.max[1],d.max[1]),g.aabb.max[2]=Math.max(g.aabb.max[2],d.max[2])):this.receivers[a.key]=new ip(d,null)}clear(){this.receivers={}}get(a){return this.receivers[a.key]}computeRequiredCascades(a,d,g){const x=l.bS.fromPoints(a.points);let w=0;for(const S in this.receivers){const C=this.receivers[S];if(!C||!x.intersectsAabb(C.aabb))continue;C.aabb.min=x.closestPoint(C.aabb.min),C.aabb.max=x.closestPoint(C.aabb.max);const R=C.aabb.getCorners();for(let D=0;D<g.length;D++){let N=!0;for(const B of R){const j=[B[0]*d,B[1]*d,B[2]];if(l.N.transformMat4(j,j,g[D].matrix),j[0]<-1||j[0]>1||j[1]<-1||j[1]>1){N=!1;break}}if(C.lastCascade=D,w=Math.max(w,D),N)break}}return w+1}}class rp{constructor(a){this.painter=a,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new Q_,this._depthMode=new li(a.context.gl.LEQUAL,li.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this.useNormalOffset=!1,a.tp.registerParameter(Ds,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),a.tp.registerParameter(Ds,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32})}destroy(){for(const a of this._cascades)a.texture.destroy(),a.framebuffer.destroy();this._cascades=[]}updateShadowParameters(a,d){const g=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!d||!d.properties)return;const x=d.properties.get("shadow-intensity");if(!d.shadowsEnabled()||x<=0||(this._shadowLayerCount=g.style.order.reduce((Z,X)=>{const K=g.style._mergedLayers[X];return Z+(K.hasShadowPass()&&!K.isHidden(a.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this._enabled))return;const w=g.context,S=Ds.shadowMapResolution,C=Ds.shadowMapResolution;if(this._cascades.length===0||Ds.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let Z=0;Z<Ds.cascadeCount;++Z){const X=g._shadowMapDebug,K=w.gl,q=w.createFramebuffer(S,C,X,"texture"),ee=new l.T(w,{width:S,height:C,data:null},K.DEPTH_COMPONENT);if(q.depthAttachment.set(ee.texture),X){const ae=new l.T(w,{width:S,height:C,data:null},K.RGBA);q.colorAttachment.set(ae.texture)}this._cascades.push({framebuffer:q,texture:ee,matrix:[],far:0,boundingSphereRadius:0,frustum:new l.bq,scale:0})}}this.shadowDirection=Vh(d);let R=0;if(a.elevation){const Z=a.elevation,X=[1e4,-1e4];Z.visibleDemTiles.filter(K=>K.dem).forEach(K=>{const q=K.dem.tree;X[0]=Math.min(X[0],q.minimums[0]),X[1]=Math.max(X[1],q.maximums[0])}),X[0]!==1e4&&(R=(X[1]-X[0])*Z.exaggeration())}const D=1.5*a.cameraToCenterDistance,N=3*D,B=new Float64Array(16);for(let Z=0;Z<this._cascades.length;++Z){const X=this._cascades[Z];let K=a.height/50,q=1;Ds.cascadeCount===1?q=N:Z===0?q=D:(K=D,q=N);const[ee,ae]=eg(a,this.shadowDirection,K,q,Ds.shadowMapResolution,R);X.scale=a.scale,X.matrix=ee,X.boundingSphereRadius=ae,l.a6.invert(B,X.matrix),X.frustum=l.bq.fromInvProjectionMatrix(B,1,0,!0),X.far=q}const j=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[j].far,this._cascades[j].far],this._uniformValues.u_shadow_intensity=x,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Ds.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Ds.shadowMapResolution,this._uniformValues.u_shadowmap_0=ys.ShadowMap0,this._uniformValues.u_shadowmap_1=ys.ShadowMap0+1,this._groundShadowTiles=g.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const $=g.transform.elevation;for(const Z of this._groundShadowTiles){let X={min:0,max:0};if($){const K=$.getMinMaxForTile(Z);K&&(X=K)}this.addShadowReceiver(Z.toUnwrapped(),X.min,X.max)}}get enabled(){return this._enabled}set enabled(a){this._enabled=a}drawShadowPass(a,d){if(!this._enabled)return;const g=this.painter,x=g.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(g.transform.getFrustum(0),g.transform.worldSize,this._cascades),x.viewport.set([0,0,Ds.shadowMapResolution,Ds.shadowMapResolution]);for(let w=0;w<this._numCascadesToRender;++w){g.currentShadowCascade=w,x.bindFramebuffer.set(this._cascades[w].framebuffer.framebuffer),x.clear({color:l.ax.white,depth:1});for(const S of a.order){const C=a._mergedLayers[S];if(!C.hasShadowPass()||C.isHidden(g.transform.zoom))continue;const R=a.getLayerSourceCache(C),D=R?d[R.id]:void 0;(C.type==="model"||D&&D.length)&&g.renderLayer(g,R,C,D)}}g.currentShadowCascade=0}drawGroundShadows(){if(!this._enabled)return;const a=this.painter,d=a.style,g=a.context,x=d.directionalLight,w=d.ambientLight;if(!x||!w)return;const S=[],C=Ra(a,a.longestCutoffRange);C.shouldRenderCutoff&&S.push("RENDER_CUTOFF");const R=lu(x,w),D=new li(g.gl.LEQUAL,li.ReadOnly,a.depthRangeFor3D);for(const N of this._groundShadowTiles){const B=N.toUnwrapped(),j=a.isTileAffectedByFog(N),$=a.getOrCreateProgram("groundShadow",{defines:S,overrideFog:j});this.setupShadows(B,$),a.uploadCommonUniforms(g,$,B,null,C);const Z={u_matrix:a.transform.calculateProjMatrix(B),u_ground_shadow_factor:R};$.draw(a,g.gl.TRIANGLES,D,vi.disabled,Fi.multiply,ci.disabled,Z,"ground_shadow",a.tileExtentBuffer,a.quadTriangleIndexBuffer,a.tileExtentSegments,{},a.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?Fi.unblended:Fi.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(a){const d=this.painter.transform,g=d.calculatePosMatrix(a,d.worldSize);return l.a6.multiply(g,this._cascades[this.painter.currentShadowCascade].matrix,g),Float32Array.from(g)}calculateShadowPassMatrixFromMatrix(a){return l.a6.multiply(a,this._cascades[this.painter.currentShadowCascade].matrix,a),Float32Array.from(a)}setupShadows(a,d,g,x=0){if(!this._enabled)return;const w=this.painter.transform,S=this.painter.context,C=S.gl,R=this._uniformValues,D=new Float64Array(16),N=w.calculatePosMatrix(a,w.worldSize);for(let B=0;B<this._cascades.length;B++)l.a6.multiply(D,this._cascades[B].matrix,N),R[B===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(D),S.activeTexture.set(C.TEXTURE0+ys.ShadowMap0+B),this._cascades[B].texture.bind(C.NEAREST,C.CLAMP_TO_EDGE);if(this.useNormalOffset=!!g,this.useNormalOffset){const B=l.bR(a.canonical),j=2/w.tileSize*l.V/Ds.shadowMapResolution,$=j*this._cascades[0].boundingSphereRadius,Z=j*this._cascades[this._cascades.length-1].boundingSphereRadius,X=(g==="vector-tile"?1:3)/Math.pow(2,x-a.canonical.z-(1-w.zoom+Math.floor(w.zoom)));R.u_shadow_normal_offset=[B,$*X,Z*X],R.u_shadow_bias=[6e-5,.0012,.012]}else R.u_shadow_bias=[36e-5,.0012,.012];d.setShadowUniformValues(S,R)}setupShadowsFromMatrix(a,d,g=!1){if(!this._enabled)return;const x=this.painter.context,w=x.gl,S=this._uniformValues,C=new Float64Array(16);for(let R=0;R<Ds.cascadeCount;R++)l.a6.multiply(C,this._cascades[R].matrix,a),S[R===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(C),x.activeTexture.set(w.TEXTURE0+ys.ShadowMap0+R),this._cascades[R].texture.bind(w.NEAREST,w.CLAMP_TO_EDGE);this.useNormalOffset=g,g?(S.u_shadow_normal_offset=[1,5,5],S.u_shadow_bias=[6e-5,.0012,.012]):S.u_shadow_bias=[36e-5,.0012,.012],d.setShadowUniformValues(x,S)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(a,d,g,x){if(x[2]>=0)return{};const w=function(R,D,N){const B=N/(1<<R.canonical.z);return new l.bS([R.canonical.x*B+R.wrap*N,R.canonical.y*B+R.wrap*N,0],[(R.canonical.x+1)*B+R.wrap*N,(R.canonical.y+1)*B+R.wrap*N,D])}(a,d,g).getCorners(),S=d/-x[2];x[0]<0?(l.N.add(w[0],w[0],[x[0]*S,0,0]),l.N.add(w[3],w[3],[x[0]*S,0,0])):x[0]>0&&(l.N.add(w[1],w[1],[x[0]*S,0,0]),l.N.add(w[2],w[2],[x[0]*S,0,0])),x[1]<0?(l.N.add(w[0],w[0],[0,x[1]*S,0]),l.N.add(w[1],w[1],[0,x[1]*S,0])):x[1]>0&&(l.N.add(w[2],w[2],[0,x[1]*S,0]),l.N.add(w[3],w[3],[0,x[1]*S,0]));const C={};return C.vertices=w,C.planes=[pl(w[1],w[0],w[4]),pl(w[2],w[1],w[5]),pl(w[3],w[2],w[6]),pl(w[0],w[3],w[7])],C}addShadowReceiver(a,d,g){this._receivers.add(a,l.bS.fromTileIdAndHeight(a,d,g))}getMaxCascadeForTile(a){const d=this._receivers.get(a);return d&&d.lastCascade?d.lastCascade:0}}function pl(_,a,d){const g=l.N.sub([],d,a),x=l.N.sub([],_,a),w=l.N.cross([],g,x),S=l.N.length(w);return S===0?[0,0,1,0]:(l.N.scale(w,w,1/S),[w[0],w[1],w[2],-l.N.dot(w,a)])}function Vh(_){const a=_.properties.get("direction"),d=l.bQ(a.x,a.y,a.z);d[2]=l.aa(d[2],0,75);const g=l.bT([d[0],d[1],d[2]]);return l.N.fromValues(g.x,g.y,g.z)}function lu(_,a){const d=_.properties.get("color"),g=_.properties.get("intensity"),x=_.properties.get("direction"),w=[x.x,x.y,x.z],S=a.properties.get("color"),C=a.properties.get("intensity"),R=Math.max(l.N.dot([0,0,1],w),0),D=[0,0,0];l.N.scale(D,S.toArray01Linear().slice(0,3),C);const N=[0,0,0];return l.N.scale(N,d.toArray01Linear().slice(0,3),R*g),l.bU([D[0]>0?D[0]/(D[0]+N[0]):0,D[1]>0?D[1]/(D[1]+N[1]):0,D[2]>0?D[2]/(D[2]+N[2]):0])}function eg(_,a,d,g,x,w){const S=_.zoom,C=_.scale,R=_.worldSize,D=1/R,N=_.aspect,B=Math.sqrt(1+N*N)*Math.tan(.5*_.fovX),j=B*B,$=g-d,Z=g+d;let X,K;j>$/Z?(X=g,K=g*B):(X=.5*Z*(1+j),K=.5*Math.sqrt($*$+2*(g*g+d*d)*j+Z*Z*j*j));const q=_.projection.pixelsPerMeter(_.center.lat,R),ee=_._camera.getCameraToWorldMercator(),ae=[0,0,-X*D];l.N.transformMat4(ae,ae,ee);let re=K*D;const le=_._edgeInsets;if(!(le.left===0&&le.top===0&&le.right===0&&le.bottom===0||le.left===le.right&&le.top===le.bottom)){const Mt=_._camera.getWorldToCamera(_.worldSize,_.projection.zAxisUnit==="meters"?q:1),Tt=_._camera.getCameraToClipPerspective(_._fov,_.width/_.height,d,g);Tt[8]=2*-_.centerOffset.x/_.width,Tt[9]=2*_.centerOffset.y/_.height;const Lt=new Float64Array(16);l.a6.mul(Lt,Tt,Mt);const Zt=new Float64Array(16);l.a6.invert(Zt,Lt);const si=l.bq.fromInvProjectionMatrix(Zt,R,S,!0);for(const ei of si.points){const ii=((Q=ei)[0]/=C,Q[1]/=C,Q[2]=l.bl(Q[2],_._center.lat),Q);re=Math.max(re,l.N.len(l.N.subtract([],ae,ii)))}}var Q;re*=x/(x-1);const ce=Math.acos(a[2]),ve=Math.atan2(-a[0],-a[1]),we=new ql;we.position=ae,we.setPitchBearing(ce,ve);const Ce=we.getWorldToCamera(R,q),Ue=re*R,Re=Math.min(_._mercatorZfromZoom(17)*R*-2,-2*Ue),Ye=we.getCameraToClipOrthographic(-Ue,Ue,-Ue,Ue,Re,(Ue+w*q)/a[2]),Ge=new Float64Array(16);l.a6.multiply(Ge,Ye,Ce);const pt=l.N.fromValues(Math.floor(1e6*ae[0])/1e6*R,Math.floor(1e6*ae[1])/1e6*R,0),ke=.5*x,He=[0,0,0];l.N.transformMat4(He,pt,Ge),l.N.scale(He,He,ke);const Me=[Math.floor(He[0]),Math.floor(He[1]),Math.floor(He[2])],Ne=[0,0,0];l.N.sub(Ne,He,Me),l.N.scale(Ne,Ne,-1/ke);const mt=new Float64Array(16);return l.a6.identity(mt),l.a6.translate(mt,mt,Ne),l.a6.multiply(Ge,mt,Ge),[Ge,Ue]}const Oa=(_,a)=>ot(_,a&&a.filter(d=>d.identifier!=="source.canvas")),tg=l.ac(Ji,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection","setCamera","addImport","removeImport","updateImport"]),Xl=l.ac(Ji,["setCenter","setZoom","setBearing","setPitch"]),np={version:8,layers:[],sources:{}},ig={duration:300,delay:0},R1=new Set(["fill","line","background","hillshade","raster"]);class To extends l.E{constructor(a,d={}){super(),this.map=a,this.scope=d.scope||"",this.fragments=[],this.importDepth=d.importDepth||0,this.importsCache=d.importsCache||new Map,this.resolvedImports=d.resolvedImports||new Set,this.transition=l.e({},ig),this._buildingIndex=new q_(this),this.crossTileSymbolIndex=new ep,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=d.styleChanges||new it,this.dispatcher=d.dispatcher?d.dispatcher:new l.bW(l.bX(),this),d.imageManager?this.imageManager=d.imageManager:(this.imageManager=new Kt,this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=d.glyphManager?d.glyphManager:new l.bY(a._requestManager,d.localFontFamily?l.bZ.all:d.localIdeographFontFamily?l.bZ.ideographs:l.bZ.none,d.localFontFamily||d.localIdeographFontFamily),d.modelManager?this.modelManager=d.modelManager:(this.modelManager=new Be(a._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=d.configOptions?d.configOptions:new Map,this._configDependentLayers=d.configDependentLayers?d.configDependentLayers:new Set,this._config=d.config,this.dispatcher.broadcast("setReferrer",l.b_());const g=this;this._rtlTextPluginCallback=To.registerForPluginStateChange(x=>{g.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:x.pluginStatus,pluginURL:x.pluginURL},(w,S)=>{if(l.b$(w),S&&S.every(C=>C))for(const C in g._sourceCaches){const R=g._sourceCaches[C],D=R.getSource().type;D!=="vector"&&D!=="geojson"||R.reload()}})}),this.on("data",x=>{if(x.dataType!=="source"||x.sourceDataType!=="metadata")return;const w=this.getOwnSource(x.sourceId);if(w&&w.vectorLayerIds)for(const S in this._layers){const C=this._layers[S];C.source===w.id&&this._validateLayer(C)}})}loadURL(a,d={}){this.fire(new l.b("dataloading",{dataType:"style"}));const g=typeof d.validate=="boolean"?d.validate:!l.c0(a);a=this.map._requestManager.normalizeStyleURL(a,d.accessToken),this.resolvedImports.add(a);const x=this.importsCache.get(a);if(x)return this._load(x,g);const w=this.map._requestManager.transformRequest(a,l.R.Style);this._request=l.g(w,(S,C)=>{if(this._request=null,S)this.fire(new l.a(S));else if(C)return this.importsCache.set(a,C),this._load(C,g)})}loadJSON(a,d={}){this.fire(new l.b("dataloading",{dataType:"style"})),this._request=l.f.frame(()=>{this._request=null,this._load(a,d.validate!==!1)})}loadEmpty(){this.fire(new l.b("dataloading",{dataType:"style"})),this._load(np,!1)}_loadImports(a,d,g){if(this.importDepth>=4)return l.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const x=[];for(const w of a){const S=this._createFragmentStyle(w),C=new Promise(N=>{S.once("style.import.load",N),S.once("error",N)}).then(()=>this.mergeAll());if(x.push(C),this.resolvedImports.has(w.url)){S.loadEmpty();continue}const R=w.data||this.importsCache.get(w.url);R?S.loadJSON(R,{validate:d}):w.url?S.loadURL(w.url,{validate:d}):S.loadEmpty();const D={style:S,id:w.id,config:w.config};if(g){const N=this.fragments.findIndex(({id:B})=>B===g);this.fragments=this.fragments.slice(0,N).concat(D).concat(this.fragments.slice(N))}else this.fragments.push(D)}return Promise.allSettled(x)}_createFragmentStyle(a){const d=this.scope?l.ag(a.id,this.scope):a.id,g=new To(this.map,{scope:d,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:a.config,configOptions:this.options,configDependentLayers:this._configDependentLayers});return g.setEventedParent(this.map,{style:g}),g}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options});const a=this.isRootStyle();this._shouldPrecompile=a,this.fire(new l.b(a?"style.load":"style.import.load"))}_load(a,d){const g=a.schema;if(this.isRootStyle()&&(a.fragment||g&&a.fragment!==!1)){const S=l.e({},np,{imports:[{id:"basemap",data:a,url:""}]});return void this._load(S,d)}if(this.setConfig(this._config,g),d&&Oa(this,Cr(a)))return;this._loaded=!0,this.stylesheet=l.c1(a);for(const S in a.sources)this.addSource(S,a.sources[S],{validate:!1,isInitialLoad:!0});a.sprite?this._loadSprite(a.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(a.glyphs,this.scope);const x=G_(this.stylesheet.layers);if(this._order=x.map(S=>S.id),this.stylesheet.light&&l.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const S=this.stylesheet.lights[0];this.light=new $t(S.properties,S.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new $t(this.stylesheet.light)),this._layers={},this._serializedLayers={};for(const S of x){const C=l.c2(S,this.scope,this.options);C.isConfigDependent&&this._configDependentLayers.add(C.fqid),C.setEventedParent(this,{layer:{id:C.id}}),this._layers[C.id]=C,this._serializedLayers[C.id]=C.serialize();const R=this.getOwnLayerSourceCache(C),D=!!this.directionalLight&&this.directionalLight.shadowsEnabled();R&&C.canCastShadows()&&D&&(R.castsShadows=!0)}this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const w=this.stylesheet.terrain;w&&(this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=l.f.hasCanvasFingerprintNoise()),this.disableElevatedTerrain?l.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."):this.terrainSetForDrapingOnly()||this._createTerrain(w,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new l.b("data",{dataType:"style"})),a.imports?this._loadImports(a.imports,d).then(()=>this._reloadImports()):this._reloadImports()}isRootStyle(){return this.importDepth===0}mergeAll(){let a,d,g,x,w,S,C,R;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(D=>{if(D.stylesheet){if(D.light!=null&&(a=D.light),D.stylesheet.lights)for(const N of D.stylesheet.lights)N.type==="ambient"&&D.ambientLight!=null&&(d=D.ambientLight),N.type==="directional"&&D.directionalLight!=null&&(g=D.directionalLight);x=this._prioritizeTerrain(x,D.terrain,D.stylesheet.terrain),D.stylesheet.fog&&D.fog!=null&&(w=D.fog),D.stylesheet.camera!=null&&(R=D.stylesheet.camera),D.stylesheet.projection!=null&&(S=D.stylesheet.projection),D.stylesheet.transition!=null&&(C=D.stylesheet.transition)}}),this.light=a,this.ambientLight=d,this.directionalLight=g,this.fog=w,x===null?delete this.terrain:this.terrain=x,this.camera=R||{"camera-projection":"perspective"},this.projection=S||{name:"mercator"},this.transition=l.e({},ig,C),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(a){const d=g=>{for(const x of g.fragments)d(x.style);a(g)};d(this)}_prioritizeTerrain(a,d,g){const x=a&&a.drapeRenderMode===0;return g===null?d&&d.drapeRenderMode===0?d:x?a:null:d!=null&&(!a||x||d&&d.drapeRenderMode===1)?d:a}mergeTerrain(){let a;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(d=>{a=this._prioritizeTerrain(a,d.terrain,d.stylesheet.terrain)}),a===null?delete this.terrain:this.terrain=a}mergeProjection(){let a;this.forEachFragmentStyle(d=>{d.stylesheet.projection!=null&&(a=d.stylesheet.projection)}),this.projection=a||{name:"mercator"}}mergeSources(){const a={},d={},g={};this.forEachFragmentStyle(x=>{for(const w in x._sourceCaches){const S=l.ag(w,x.scope);a[S]=x._sourceCaches[w]}for(const w in x._otherSourceCaches){const S=l.ag(w,x.scope);d[S]=x._otherSourceCaches[w]}for(const w in x._symbolSourceCaches){const S=l.ag(w,x.scope);g[S]=x._symbolSourceCaches[w]}}),this._mergedSourceCaches=a,this._mergedOtherSourceCaches=d,this._mergedSymbolSourceCaches=g}mergeLayers(){const a={},d=[],g={};this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(w=>{for(const S of w._order){const C=w._layers[S];if(C.type==="slot"){const R=l.c3(S);if(a[R])continue;a[R]=[]}C.slot&&a[C.slot]?a[C.slot].push(C):d.push(C)}}),this._mergedOrder=[];const x=(w=[])=>{for(const S of w)if(S.type==="slot"){const C=l.c3(S.id);a[C]&&x(a[C])}else{const C=l.ag(S.id,S.scope);this._mergedOrder.push(C),g[C]=S,S.is3D()&&(this._has3DLayers=!0),S.type==="circle"&&(this._hasCircleLayers=!0),S.type==="symbol"&&(this._hasSymbolLayers=!0)}};x(d),this._mergedLayers=g,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(a){return this.stylesheet.camera=l.e({},this.stylesheet.camera,a),this.camera=this.stylesheet.camera,this}setProjection(a){a?this.stylesheet.projection=a:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(a){this._spriteRequest=function(d,g,x){let w,S,C;const R=l.f.devicePixelRatio>1?"@2x":"";let D=l.g(g.transformRequest(g.normalizeSpriteURL(d,R,".json"),l.R.SpriteJSON),(j,$)=>{D=null,C||(C=j,w=$,B())}),N=l.d(g.transformRequest(g.normalizeSpriteURL(d,R,".png"),l.R.SpriteImage),(j,$)=>{N=null,C||(C=j,S=$,B())});function B(){if(C)x(C);else if(w&&S){const j=l.f.getImageData(S),$={};for(const Z in w){const{width:X,height:K,x:q,y:ee,sdf:ae,pixelRatio:re,stretchX:le,stretchY:Q,content:ce}=w[Z],ve=new l.h({width:X,height:K});l.h.copy(j,ve,{x:q,y:ee},{x:0,y:0},{width:X,height:K}),$[Z]={data:ve,pixelRatio:re,sdf:ae,stretchX:le,stretchY:Q,content:ce}}x(null,$)}}return{cancel(){D&&(D.cancel(),D=null),N&&(N.cancel(),N=null)}}}(a,this.map._requestManager,(d,g)=>{if(this._spriteRequest=null,d)this.fire(new l.a(d));else if(g)for(const x in g)this.imageManager.addImage(x,this.scope,g[x]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new l.b("data",{dataType:"style"}))})}_validateLayer(a){const d=this.getOwnSource(a.source);if(!d)return;const g=a.sourceLayer;g&&(d.type==="geojson"||d.vectorLayerIds&&d.vectorLayerIds.indexOf(g)===-1)&&this.fire(new l.a(new Error(`Source layer "${g}" does not exist on source "${d.id}" as specified by style layer "${a.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const a in this._sourceCaches)if(!this._sourceCaches[a].loaded())return!1;if(!this.imageManager.isLoaded()||!this.modelManager.isLoaded())return!1;for(const{style:a}of this.fragments)if(!a.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((a,d)=>{const g=this.fragments[d];return g&&g.style&&(a.data=g.style.serialize()),a})}_serializeSources(){const a={};for(const d in this._sourceCaches){const g=this._sourceCaches[d].getSource();a[g.id]||(a[g.id]=g.serialize())}return a}_serializeLayers(a){const d=[];for(const g of a){const x=this._layers[g];x&&x.type!=="custom"&&d.push(x.serialize())}return d}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition())return!0;for(const a in this._sourceCaches)if(this._sourceCaches[a].hasTransition())return!0;for(const a in this._layers)if(this._layers[a].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}isLayerDraped(a){return!!this.terrain&&(typeof a.isLayerDraped=="function"?a.isLayerDraped(this.getLayerSourceCache(a)):R1.has(a.type))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(a){const d=this.getOwnLayer(a);if(d)return d;this.fire(new l.a(new Error(`The layer '${a}' does not exist in the map's style.`)))}_checkSource(a){const d=this.getOwnSource(a);if(d)return d;this.fire(new l.a(new Error(`The source '${a}' does not exist in the map's style.`)))}update(a){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(a),this.directionalLight&&this.directionalLight.recalculate(a);const d=this.calculateLightsBrightness();a.brightness=d||0,d!==this._brightness&&(this._brightness=d,this.dispatcher.broadcast("setBrightness",d));const g=this._changes.isDirty();if(this._changes.isDirty()){const w=this._changes.getLayerUpdatesByScope();for(const S in w){const{updatedIds:C,removedIds:R}=w[S];(C||R)&&this._updateWorkerLayers(S,C,R)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(a),this.light&&this.light.updateTransitions(a),this.ambientLight&&this.ambientLight.updateTransitions(a),this.directionalLight&&this.directionalLight.updateTransitions(a),this.fog&&this.fog.updateTransitions(a),this._changes.reset()}const x={};for(const w in this._mergedSourceCaches){const S=this._mergedSourceCaches[w];x[w]=S.used,S.used=!1,S.tileCoverLift=0}for(const w of this._mergedOrder){const S=this._mergedLayers[w];if(S.recalculate(a,this._availableImages),!S.isHidden(a.zoom)){const C=this.getLayerSourceCache(S);C&&(C.used=!0,C.tileCoverLift=Math.max(C.tileCoverLift,S.tileCoverLift()))}if(!this._precompileDone&&this._shouldPrecompile)for(let C=S.minzoom||0;C<(S.maxzoom||25.5);C++){const R=this.map.painter;if(R){const D=S.getProgramIds();if(!D)continue;for(const N of D){const B=S.getDefaultProgramParams(N,a.zoom);B&&(R.style=this,this.fog&&(R._fogVisible=!0,B.overrideFog=!0,R.getOrCreateProgram(N,B)),R._fogVisible=!1,B.overrideFog=!1,R.getOrCreateProgram(N,B),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(B.overrideRtt=!0,R.getOrCreateProgram(N,B)))}}}}this._shouldPrecompile&&(this._precompileDone=!0);for(const w in x){const S=this._mergedSourceCaches[w];x[w]!==S.used&&S.getSource().fire(new l.b("data",{sourceDataType:"visibility",dataType:"source",sourceId:S.getSource().id}))}this.light&&this.light.recalculate(a),this.terrain&&this.terrain.recalculate(a),this.fog&&this.fog.recalculate(a),this.z=a.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),g&&this.fire(new l.b("data",{dataType:"style"}))}_updateTilesForChangedImages(){const a=this._changes.getUpdatedImages();if(a.length){for(const d in this._sourceCaches)this._sourceCaches[d].reloadTilesForDependencies(["icons","patterns"],a);this._changes.resetUpdatedImages()}}_updateWorkerLayers(a,d,g){const x=this.getFragmentStyle(a);x&&this.dispatcher.broadcast("updateLayers",{layers:d?x._serializeLayers(d):[],scope:a,removedIds:g||[],options:x.options})}setState(a){if(this._checkLoaded(),Oa(this,Cr(a)))return!1;(a=l.c1(a)).layers=G_(a.layers);const d=function(x,w){if(!x)return[{command:Ji.setStyle,args:[w]}];let S=[];try{if(!A(x.version,w.version))return[{command:Ji.setStyle,args:[w]}];A(x.center,w.center)||S.push({command:Ji.setCenter,args:[w.center]}),A(x.zoom,w.zoom)||S.push({command:Ji.setZoom,args:[w.zoom]}),A(x.bearing,w.bearing)||S.push({command:Ji.setBearing,args:[w.bearing]}),A(x.pitch,w.pitch)||S.push({command:Ji.setPitch,args:[w.pitch]}),A(x.sprite,w.sprite)||S.push({command:Ji.setSprite,args:[w.sprite]}),A(x.glyphs,w.glyphs)||S.push({command:Ji.setGlyphs,args:[w.glyphs]}),A(x.imports,w.imports)||function(B=[],j=[],$){j=j||[];const Z=(B=B||[]).map(Ma),X=j.map(Ma),K=B.reduce(Dh,{}),q=j.reduce(Dh,{}),ee=Z.slice();let ae,re,le,Q;for(ae=0,re=0;ae<Z.length;ae++)le=Z[ae],q.hasOwnProperty(le)?re++:($.push({command:Ji.removeImport,args:[le]}),ee.splice(ee.indexOf(le,re),1));for(ae=0,re=0;ae<X.length;ae++)le=X[X.length-1-ae],ee[ee.length-1-ae]!==le&&(K.hasOwnProperty(le)?($.push({command:Ji.removeImport,args:[le]}),ee.splice(ee.lastIndexOf(le,ee.length-re),1)):re++,Q=ee[ee.length-ae],$.push({command:Ji.addImport,args:[q[le],Q]}),ee.splice(ee.length-ae,0,le));for(const ce of j){const ve=K[ce.id];ve&&!A(ve,ce)&&$.push({command:Ji.updateImport,args:[ce.id,ce]})}}(x.imports,w.imports,S),A(x.transition,w.transition)||S.push({command:Ji.setTransition,args:[w.transition]}),A(x.light,w.light)||S.push({command:Ji.setLight,args:[w.light]}),A(x.fog,w.fog)||S.push({command:Ji.setFog,args:[w.fog]}),A(x.projection,w.projection)||S.push({command:Ji.setProjection,args:[w.projection]}),A(x.lights,w.lights)||S.push({command:Ji.setLights,args:[w.lights]}),A(x.camera,w.camera)||S.push({command:Ji.setCamera,args:[w.camera]});const C={},R=[];(function(B,j,$,Z){let X;for(X in j=j||{},B=B||{})B.hasOwnProperty(X)&&(j.hasOwnProperty(X)||Ff(X,$,Z));for(X in j){if(!j.hasOwnProperty(X))continue;const K=j[X];B.hasOwnProperty(X)?A(B[X],K)||(B[X].type==="geojson"&&K.type==="geojson"&&E1(B,j,X)?$.push({command:Ji.setGeoJSONSourceData,args:[X,K.data]}):T1(X,j,$,Z)):Qc(X,j,$)}})(x.sources,w.sources,R,C);const D=[];x.layers&&x.layers.forEach(B=>{B.source&&C[B.source]?S.push({command:Ji.removeLayer,args:[B.id]}):D.push(B)});let N=x.terrain;N&&C[N.source]&&(S.push({command:Ji.setTerrain,args:[void 0]}),N=void 0),S=S.concat(R),A(N,w.terrain)||S.push({command:Ji.setTerrain,args:[w.terrain]}),function(B,j,$){j=j||[];const Z=(B=B||[]).map(Ma),X=j.map(Ma),K=B.reduce(Dh,{}),q=j.reduce(Dh,{}),ee=Z.slice(),ae=Object.create(null);let re,le,Q,ce,ve,we,Ce;for(re=0,le=0;re<Z.length;re++)Q=Z[re],q.hasOwnProperty(Q)?le++:($.push({command:Ji.removeLayer,args:[Q]}),ee.splice(ee.indexOf(Q,le),1));for(re=0,le=0;re<X.length;re++)Q=X[X.length-1-re],ee[ee.length-1-re]!==Q&&(K.hasOwnProperty(Q)?($.push({command:Ji.removeLayer,args:[Q]}),ee.splice(ee.lastIndexOf(Q,ee.length-le),1)):le++,we=ee[ee.length-re],$.push({command:Ji.addLayer,args:[q[Q],we]}),ee.splice(ee.length-re,0,Q),ae[Q]=!0);for(re=0;re<X.length;re++)if(Q=X[re],ce=K[Q],ve=q[Q],!ae[Q]&&!A(ce,ve))if(A(ce.source,ve.source)&&A(ce["source-layer"],ve["source-layer"])&&A(ce.type,ve.type)){for(Ce in Aa(ce.layout,ve.layout,$,Q,null,Ji.setLayoutProperty),Aa(ce.paint,ve.paint,$,Q,null,Ji.setPaintProperty),A(ce.slot,ve.slot)||$.push({command:Ji.setSlot,args:[Q,ve.slot]}),A(ce.filter,ve.filter)||$.push({command:Ji.setFilter,args:[Q,ve.filter]}),A(ce.minzoom,ve.minzoom)&&A(ce.maxzoom,ve.maxzoom)||$.push({command:Ji.setLayerZoomRange,args:[Q,ve.minzoom,ve.maxzoom]}),ce)ce.hasOwnProperty(Ce)&&Ce!=="layout"&&Ce!=="paint"&&Ce!=="filter"&&Ce!=="metadata"&&Ce!=="minzoom"&&Ce!=="maxzoom"&&Ce!=="slot"&&(Ce.indexOf("paint.")===0?Aa(ce[Ce],ve[Ce],$,Q,Ce.slice(6),Ji.setPaintProperty):A(ce[Ce],ve[Ce])||$.push({command:Ji.setLayerProperty,args:[Q,Ce,ve[Ce]]}));for(Ce in ve)ve.hasOwnProperty(Ce)&&!ce.hasOwnProperty(Ce)&&Ce!=="layout"&&Ce!=="paint"&&Ce!=="filter"&&Ce!=="metadata"&&Ce!=="minzoom"&&Ce!=="maxzoom"&&Ce!=="slot"&&(Ce.indexOf("paint.")===0?Aa(ce[Ce],ve[Ce],$,Q,Ce.slice(6),Ji.setPaintProperty):A(ce[Ce],ve[Ce])||$.push({command:Ji.setLayerProperty,args:[Q,Ce,ve[Ce]]}))}else $.push({command:Ji.removeLayer,args:[Q]}),we=ee[ee.lastIndexOf(Q)+1],$.push({command:Ji.addLayer,args:[ve,we]})}(D,w.layers,S)}catch(C){console.warn("Unable to compute style diff:",C),S=[{command:Ji.setStyle,args:[w]}]}return S}(this.serialize(),a).filter(x=>!(x.command in Xl));if(d.length===0)return!1;const g=d.filter(x=>!(x.command in tg));if(g.length>0)throw new Error(`Unimplemented: ${g.map(x=>x.command).join(", ")}.`);return d.forEach(x=>{this[x.command].apply(this,x.args)}),this.stylesheet=a,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(a,d){return this.getImage(a)?this.fire(new l.a(new Error("An image with this name already exists."))):(this.imageManager.addImage(a,this.scope,d),this._afterImageUpdated(a),this)}updateImage(a,d){this.imageManager.updateImage(a,this.scope,d)}getImage(a){return this.imageManager.getImage(a,this.scope)}removeImage(a){return this.getImage(a)?(this.imageManager.removeImage(a,this.scope),this._afterImageUpdated(a),this):this.fire(new l.a(new Error("No image with this name exists.")))}_afterImageUpdated(a){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(a),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new l.b("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(a,d,g={}){return this._checkLoaded(),this._validate(It,`models.${a}`,d,null,g)||(this.modelManager.addModel(a,d,this.scope),this._changes.setDirty()),this}hasModel(a){return this.modelManager.hasModel(a,this.scope)}removeModel(a){return this.hasModel(a)?(this.modelManager.removeModel(a,this.scope),this):this.fire(new l.a(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(a,d,g={}){if(this._checkLoaded(),this.getOwnSource(a)!==void 0)throw new Error(`There is already a source with ID "${a}".`);if(!d.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(d).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(d.type)>=0&&this._validate(Oi,`sources.${a}`,d,null,g))return;this.map&&this.map._collectResourceTiming&&(d.collectResourceTiming=!0);const x=Gn(a,d,this.dispatcher,this);x.scope=this.scope,x.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(x.id),source:x.serialize(),sourceId:x.id}));const w=S=>{const C=(S?"symbol:":"other:")+x.id,R=l.ag(C,this.scope),D=this._sourceCaches[C]=new bo(R,x,S);(S?this._symbolSourceCaches:this._otherSourceCaches)[x.id]=D,D.onAdd(this.map)};w(!1),d.type!=="vector"&&d.type!=="geojson"||w(!0),x.onAdd&&x.onAdd(this.map),g.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(a){this._checkLoaded();const d=this.getOwnSource(a);if(!d)throw new Error("There is no source with this ID");for(const x in this._layers)if(this._layers[x].source===a)return this.fire(new l.a(new Error(`Source "${a}" cannot be removed while layer "${x}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===a)return this.fire(new l.a(new Error(`Source "${a}" cannot be removed while terrain is using it.`)));const g=this.getOwnSourceCaches(a);for(const x of g){const w=l.c3(x.id);delete this._sourceCaches[w],this._changes.discardSourceCacheUpdate(x.id),x.fire(new l.b("data",{sourceDataType:"metadata",dataType:"source",sourceId:x.getSource().id})),x.setEventedParent(null),x.clearTiles()}return delete this._otherSourceCaches[a],delete this._symbolSourceCaches[a],this.mergeSources(),d.setEventedParent(null),d.onRemove&&d.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(a,d){this._checkLoaded(),this.getOwnSource(a).setData(d),this._changes.setDirty()}getOwnSource(a){const d=this.getOwnSourceCache(a);return d&&d.getSource()}getOwnSources(){const a=[];for(const d in this._otherSourceCaches){const g=this.getOwnSourceCache(d);g&&a.push(g.getSource())}return a}areTilesLoaded(){const a=this._mergedSourceCaches;for(const d in a){const g=a[d]._tiles;for(const x in g){const w=g[x];if(w.state!=="loaded"&&w.state!=="errored")return!1}}return!0}setLights(a){if(this._checkLoaded(),!a)return delete this.ambientLight,void delete this.directionalLight;const d=this._getTransitionParameters();for(const x of a){if(this._validate(Ke,"lights",x))return;switch(x.type){case"ambient":if(this.ambientLight){const w=this.ambientLight;w.set(x),w.updateTransitions(d)}else this.ambientLight=new rs(x,ns,this.scope,this.options);break;case"directional":if(this.directionalLight){const w=this.directionalLight;w.set(x),w.updateTransitions(d)}else this.directionalLight=new rs(x,Yr,this.scope,this.options)}}const g=new l.K(this.z||0,d);this.ambientLight&&this.ambientLight.recalculate(g),this.directionalLight&&this.directionalLight.recalculate(g),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const a=this.directionalLight,d=this.ambientLight;if(!a||!d)return;const g=B=>.2126*(B[0]<=.03928?B[0]/12.92:Math.pow((B[0]+.055)/1.055,2.4))+.7152*(B[1]<=.03928?B[1]/12.92:Math.pow((B[1]+.055)/1.055,2.4))+.0722*(B[2]<=.03928?B[2]/12.92:Math.pow((B[2]+.055)/1.055,2.4)),x=a.properties.get("color").toArray01(),w=a.properties.get("intensity"),S=a.properties.get("direction"),C=1-l.bQ(S.x,S.y,S.z)[2]/90,R=g(x)*w*C,D=d.properties.get("color").toArray01(),N=d.properties.get("intensity");return(R+g(D)*N)/2}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const a=[];return this.directionalLight&&a.push(this.directionalLight.get()),this.ambientLight&&a.push(this.ambientLight.get()),a}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(a){if(!a)return this;if(l.c4(a)){const d=l.c5(a),g=this.fragments.find(({id:w})=>w===d);if(!g)throw new Error(`Style import not found: ${a}`);const x=l.c3(a);return g.style.getFragmentStyle(x)}{const d=this.fragments.find(({id:g})=>g===a);if(!d)throw new Error(`Style import not found: ${a}`);return d.style}}getConfigProperty(a,d){const g=this.getFragmentStyle(a);if(!g)return null;const x=l.ag(d,g.scope),w=g.options.get(x),S=w?w.value||w.default:null;return S?S.serialize():null}setConfigProperty(a,d,g){const x=l.r(g);if(x.result!=="success")return void Oa(this,x.value);const w=x.value.expression,S=this.getFragmentStyle(a);if(!S)return;const C=l.ag(d,S.scope),R=S.options.get(C);R&&(this.options.set(C,{...R,value:w}),this.updateConfigDependencies())}setConfig(a,d){if(this._config=a,a||d)if(d)for(const g in d){let x,w;const S=l.r(d[g].default);if(S.result==="success"&&(x=S.value.expression),a&&a[g]!==void 0){const j=l.r(a[g]);j.result==="success"&&(w=j.value.expression)}const{minValue:C,maxValue:R,stepValue:D,type:N,values:B}=d[g];if(x){const j=l.ag(g,this.scope);this.options.set(j,{default:x,value:w,minValue:C,maxValue:R,stepValue:D,type:N,values:B})}else this.fire(new l.a(new Error(`No schema defined for config option "${g}".`)))}else this.fire(new l.a(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(){for(const a of this._configDependentLayers){const d=this.getLayer(a);d&&(d.possiblyEvaluateVisibility(),this._updateLayer(d))}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this._changes.setDirty()}addLayer(a,d,g={}){this._checkLoaded();const x=a.id;if(this._layers[x])return void this.fire(new l.a(new Error(`Layer with id "${x}" already exists on this map`)));let w;if(a.type==="custom"){if(Oa(this,l.c6(a)))return;w=l.c2(a,this.scope,this.options)}else{if(typeof a.source=="object"&&(this.addSource(x,a.source),a=l.c1(a),a=l.e(a,{source:x})),this._validate(Te,`layers.${x}`,a,{arrayIndex:-1},g))return;w=l.c2(a,this.scope,this.options),this._validateLayer(w),w.setEventedParent(this,{layer:{id:x}}),this._serializedLayers[w.id]=w.serialize()}w.isConfigDependent&&this._configDependentLayers.add(w.fqid);let S=this._order.length;if(d){const N=this._order.indexOf(d);if(N===-1)return void this.fire(new l.a(new Error(`Layer with id "${d}" does not exist on this map.`)));w.slot===this._layers[d].slot?S=N:l.w(`Layer with id "${d}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(S,0,x),this._layerOrderChanged=!0,this._layers[x]=w;const C=this.getOwnLayerSourceCache(w),R=!!this.directionalLight&&this.directionalLight.shadowsEnabled();C&&w.canCastShadows()&&R&&(C.castsShadows=!0);const D=this._changes.getRemovedLayer(w);if(D&&w.source&&C&&w.type!=="custom"){this._changes.discardLayerRemoval(w);const N=l.ag(w.source,w.scope);D.type!==w.type?this._changes.updateSourceCache(N,"clear"):(this._changes.updateSourceCache(N,"reload"),C.pause())}this._updateLayer(w),w.onAdd&&w.onAdd(this.map),w.scope=this.scope,this.mergeLayers()}moveLayer(a,d){this._checkLoaded();const g=this._checkLayer(a);if(!g||a===d)return;const x=this._order.indexOf(a);this._order.splice(x,1);let w=this._order.length;if(d){const S=this._order.indexOf(d);if(S===-1)return void this.fire(new l.a(new Error(`Layer with id "${d}" does not exist on this map.`)));g.slot===this._layers[d].slot?w=S:l.w(`Layer with id "${d}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(w,0,a),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(a){this._checkLoaded();const d=this._checkLayer(a);if(!d)return;d.setEventedParent(null);const g=this._order.indexOf(a);this._order.splice(g,1),delete this._layers[a],delete this._serializedLayers[a],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(d.fqid),this._changes.removeLayer(d);const x=this.getOwnLayerSourceCache(d);if(x&&x.castsShadows){let w=!1;for(const S in this._layers)if(this._layers[S].source===d.source&&this._layers[S].canCastShadows()){w=!0;break}x.castsShadows=w}d.onRemove&&d.onRemove(this.map),this.mergeLayers()}getOwnLayer(a){return this._layers[a]}hasLayer(a){return a in this._mergedLayers}hasLayerType(a){for(const d in this._layers)if(this._layers[d].type===a)return!0;return!1}setLayerZoomRange(a,d,g){this._checkLoaded();const x=this._checkLayer(a);x&&(x.minzoom===d&&x.maxzoom===g||(d!=null&&(x.minzoom=d),g!=null&&(x.maxzoom=g),this._updateLayer(x)))}setSlot(a,d){this._checkLoaded();const g=this._checkLayer(a);g&&g.slot!==d&&(g.slot=d,this._updateLayer(g))}setFilter(a,d,g={}){this._checkLoaded();const x=this._checkLayer(a);if(x&&!A(x.filter,d))return d==null?(x.filter=void 0,void this._updateLayer(x)):void(this._validate(Xe,`layers.${x.id}.filter`,d,{layerType:x.type},g)||(x.filter=l.c1(d),this._updateLayer(x)))}getFilter(a){const d=this._checkLayer(a);if(d)return l.c1(d.filter)}setLayoutProperty(a,d,g,x={}){this._checkLoaded();const w=this._checkLayer(a);if(w&&!A(w.getLayoutProperty(d),g)){if(g!=null&&(!x||x.validate!==!1)&&Oa(w,lt.call(Cr,{key:`layers.${a}.layout.${d}`,layerType:w.type,objectKey:d,value:g,styleSpec:l.D,style:{glyphs:!0,sprite:!0}})))return;w.setLayoutProperty(d,g),w.isConfigDependent&&this._configDependentLayers.add(w.fqid),this._updateLayer(w)}}getLayoutProperty(a,d){const g=this._checkLayer(a);if(g)return g.getLayoutProperty(d)}setPaintProperty(a,d,g,x={}){this._checkLoaded();const w=this._checkLayer(a);if(!w||A(w.getPaintProperty(d),g)||g!=null&&(!x||x.validate!==!1)&&Oa(w,Je.call(Cr,{key:`layers.${a}.paint.${d}`,layerType:w.type,objectKey:d,value:g,styleSpec:l.D})))return;const S=w.setPaintProperty(d,g);w.isConfigDependent&&this._configDependentLayers.add(w.fqid),S&&this._updateLayer(w),this._changes.updatePaintProperties(w)}getPaintProperty(a,d){const g=this._checkLayer(a);if(g)return g.getPaintProperty(d)}setFeatureState(a,d){this._checkLoaded();const g=a.source,x=a.sourceLayer,w=this._checkSource(g);if(!w)return;const S=w.type;if(S==="geojson"&&x)return void this.fire(new l.a(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(S==="vector"&&!x)return void this.fire(new l.a(new Error("The sourceLayer parameter must be provided for vector source types.")));a.id===void 0&&this.fire(new l.a(new Error("The feature id parameter must be provided.")));const C=this.getOwnSourceCaches(g);for(const R of C)R.setFeatureState(x,a.id,d)}removeFeatureState(a,d){this._checkLoaded();const g=a.source,x=this._checkSource(g);if(!x)return;const w=x.type,S=w==="vector"?a.sourceLayer:void 0;if(w==="vector"&&!S)return void this.fire(new l.a(new Error("The sourceLayer parameter must be provided for vector source types.")));if(d&&typeof a.id!="string"&&typeof a.id!="number")return void this.fire(new l.a(new Error("A feature id is required to remove its specific state property.")));const C=this.getOwnSourceCaches(g);for(const R of C)R.removeFeatureState(S,a.id,d)}getFeatureState(a){this._checkLoaded();const d=a.source,g=a.sourceLayer,x=this._checkSource(d);if(x){if(x.type!=="vector"||g)return a.id===void 0&&this.fire(new l.a(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(d)[0].getFeatureState(g,a.id);this.fire(new l.a(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(a){return this.stylesheet.transition=l.e({},this.stylesheet.transition,a),this.transition=this.stylesheet.transition,this}getTransition(){return l.e({},this.stylesheet.transition)}serialize(){this._checkLoaded();const a=this.getTerrain(),d=a&&this.terrain&&this.terrain.scope===this.scope?a:this.stylesheet.terrain;return l.c7({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:d,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},g=>g!==void 0)}_updateLayer(a){this._changes.updateLayer(a);const d=this.getLayerSourceCache(a),g=l.ag(a.source,a.scope),x=this._changes.getUpdatedSourceCaches();a.source&&!x[g]&&d&&d.getSource().type!=="raster"&&(this._changes.updateSourceCache(g,"reload"),d.pause()),a.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(a){const d=C=>this._mergedLayers[C].type==="fill-extrusion"||this._mergedLayers[C].type==="model",g=this.order,x={},w=[];for(let C=g.length-1;C>=0;C--){const R=g[C];if(d(R)){x[R]=C;for(const D of a){const N=D[R];if(N)for(const B of N)w.push(B)}}}w.sort((C,R)=>R.intersectionZ-C.intersectionZ);const S=[];for(let C=g.length-1;C>=0;C--){const R=g[C];if(d(R))for(let D=w.length-1;D>=0;D--){const N=w[D].feature;if(x[N.layer.id]<C)break;S.push(N),w.pop()}else for(const D of a){const N=D[R];if(N)for(const B of N)S.push(B.feature)}}return S}queryRenderedFeatures(a,d,g){d&&d.filter&&this._validate(Xe,"queryRenderedFeatures.filter",d.filter,null,d),d.scope=this.scope,d.availableImages=this._availableImages,d.serializedLayers=this._serializedLayers;const x={};if(d&&d.layers){if(!Array.isArray(d.layers))return this.fire(new l.a(new Error("parameters.layers must be an Array."))),[];for(const D of d.layers){const N=this._mergedLayers[D];if(!N)return this.fire(new l.a(new Error(`The layer '${D}' does not exist in the map's style and cannot be queried for features.`))),[];x[N.source]=!0}}const w=[],S=d.serializedLayers||{},C=d&&d.layers?d.layers.some(D=>{const N=this.getLayer(D);return N&&N.is3D()}):this.has3DLayers(),R=un.createFromScreenPoints(a,g);for(const D in this._mergedSourceCaches){const N=this._mergedSourceCaches[D].getSource();if(!N||N.scope!==d.scope)continue;const B=this._mergedSourceCaches[D].getSource().id;d.layers&&!x[B]||w.push(Nf(this._mergedSourceCaches[D],this._mergedLayers,S,R,d,g,C,!!this.map._showQueryGeometry))}return this.placement&&w.push(function(D,N,B,j,$,Z,X){const K={},q=Z.queryRenderedSymbols(j),ee=[];for(const ae of Object.keys(q).map(Number))ee.push(X[ae]);ee.sort(Vl);for(const ae of ee){const re=ae.featureIndex.lookupSymbolFeatures(q[ae.bucketInstanceId],N,ae.bucketIndex,ae.sourceLayerIndex,$.filter,$.layers,$.availableImages,D);for(const le in re){const Q=K[le]=K[le]||[],ce=re[le];ce.sort((ve,we)=>{const Ce=ae.featureSortOrder;if(Ce){const Ue=Ce.indexOf(ve.featureIndex);return Ce.indexOf(we.featureIndex)-Ue}return we.featureIndex-ve.featureIndex});for(const ve of ce)Q.push(ve)}}for(const ae in K)K[ae].forEach(re=>{const le=re.feature,Q=B(D[ae]);if(!Q)return;const ce=Q.getFeatureState(le.layer["source-layer"],le.id);le.source=le.layer.source,le.layer["source-layer"]&&(le.sourceLayer=le.layer["source-layer"]),le.state=ce});return K}(this._mergedLayers,S,this.getLayerSourceCache.bind(this),R.screenGeometry,d,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(w)}querySourceFeatures(a,d){d&&d.filter&&this._validate(Xe,"querySourceFeatures.filter",d.filter,null,d);const g=this.getOwnSourceCaches(a);let x=[];for(const w of g)x=x.concat(Qo(w,d));return x}addSourceType(a,d,g){return To.getSourceType(a)?g(new Error(`A source type called "${a}" already exists.`)):(To.setSourceType(a,d),d.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:a,url:d.workerSourceURL},g):g(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(a,d,g={}){this._checkLoaded();const x=this.light.getLight();let w=!1;for(const C in a)if(!A(a[C],x[C])){w=!0;break}if(!w)return;const S=this._getTransitionParameters();this.light.setLight(a,d,g),this.light.updateTransitions(S)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(a,d=1){if(this._checkLoaded(),!a)return this.terrainSetForDrapingOnly()&&d!==0||delete this.terrain,a===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);let g=a;const x=a.source==null;if(d===1){if(typeof g.source=="object"){const C="terrain-dem-src";this.addSource(C,g.source),g=l.c1(g),g=l.e(g,{source:C})}const w=l.e({},g),S={};if(this.terrain&&x){w.source=this.terrain.get().source;const C=this.terrain?this.getFragmentStyle(this.terrain.scope):null;C&&(S.style=C.serialize())}if(this._validate(ie,"terrain",w,S))return}if(!this.terrain||this.terrain.scope!==this.scope&&!x||this.terrain&&d!==this.terrain.drapeRenderMode){if(!g)return;this._createTerrain(g,d),this.fire(new l.b("data",{dataType:"style"}))}else{const w=this.terrain,S=w.get();for(const C of Object.keys(l.D.terrain))!g.hasOwnProperty(C)&&l.D.terrain[C].default&&(g[C]=l.D.terrain[C].default);for(const C in a)if(!A(a[C],S[C])){w.set(a,this.options),this.stylesheet.terrain=a;const R=this._getTransitionParameters({duration:0});w.updateTransitions(R),this.fire(new l.b("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(a){const d=this.fog=new Ln(a,this.map.transform,this.scope,this.options);this.stylesheet.fog=d.get();const g=this._getTransitionParameters({duration:0});d.updateTransitions(g)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const a of this.map._markers)a._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(a){if(this._checkLoaded(),!a)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const d=this.fog;if(!A(d.get(),a)){d.set(a,this.options),this.stylesheet.fog=d.get();const g=this._getTransitionParameters({duration:0});d.updateTransitions(g)}}else this._createFog(a);this._markersNeedUpdate=!0}_getTransitionParameters(a){return{now:l.f.now(),transition:l.e(this.transition,a)}}updateDrapeFirstLayers(){if(!this.terrain)return;const a=[],d=[];for(const g in this._mergedLayers)this.isLayerDraped(this._mergedLayers[g])?a.push(g):d.push(g);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...a),this._drapedFirstOrder.push(...d)}_createTerrain(a,d){const g=this.terrain=new Wi(a,d,this.scope,this.options);d===1&&(this.stylesheet.terrain=a),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const x=this._getTransitionParameters({duration:0});g.updateTransitions(x)}_force3DLayerUpdate(){for(const a in this._layers){const d=this._layers[a];d.type==="fill-extrusion"&&this._updateLayer(d)}}_forceSymbolLayerUpdate(){for(const a in this._layers){const d=this._layers[a];d.type==="symbol"&&this._updateLayer(d)}}_validate(a,d,g,x,w={}){if(w&&w.validate===!1)return!1;const S=l.e({},this.serialize());return Oa(this,a.call(Cr,l.e({key:d,style:S,value:g,styleSpec:l.D},x)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),l.c8.off("pluginStateChange",this._rtlTextPluginCallback);for(const a in this._mergedLayers)this._mergedLayers[a].setEventedParent(null);for(const a in this._mergedSourceCaches)this._mergedSourceCaches[a].clearTiles(),this._mergedSourceCaches[a].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(a){const d=this.getSourceCaches(a);for(const g of d)g.clearTiles()}clearSources(){for(const a in this._mergedSourceCaches)this._mergedSourceCaches[a].clearTiles()}reloadSource(a){const d=this.getSourceCaches(a);for(const g of d)g.resume(),g.reload()}reloadSources(){for(const a of this.getSources())a.reload&&a.reload()}updateSources(a){let d;this.directionalLight&&(d=Vh(this.directionalLight));for(const g in this._mergedSourceCaches)this._mergedSourceCaches[g].update(a,void 0,void 0,d)}_generateCollisionBoxes(){for(const a in this._sourceCaches){const d=this._sourceCaches[a];d.resume(),d.reload()}}_updatePlacement(a,d,g,x,w=!1){let S=!1,C=!1;const R={},D={};for(const N of this._mergedOrder){const B=this._mergedLayers[N];if(B.type!=="symbol")continue;const j=l.ag(B.source,B.scope);let $=R[j];if(!$){const X=this.getLayerSourceCache(B);if(!X)continue;const K=X.getRenderableIds(!0).map(q=>X.getTileByID(q));D[j]=K.slice(),$=R[j]=K.sort((q,ee)=>ee.tileID.overscaledZ-q.tileID.overscaledZ||(q.tileID.isLessThan(ee.tileID)?-1:1))}const Z=this.crossTileSymbolIndex.addLayer(B,$,a.center.lng,a.projection);S=S||Z}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),w=w||this._layerOrderChanged||g===0,this._layerOrderChanged&&this.fire(new l.b("neworder")),(w||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(l.f.now(),a.zoom))&&(this.pauseablePlacement=new Bh(a,this._mergedOrder,w,d,g,x,this.placement,this.fog&&a.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,R,D),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(l.f.now()),C=!0),S&&this.pauseablePlacement.placement.setStale()),C||S){this._buildingIndex.onNewFrame(a.zoom);for(const N of this._mergedOrder){const B=this._mergedLayers[N];B.type==="symbol"&&this.placement.updateLayerOpacities(B,R[l.ag(B.source,B.scope)])}}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(l.f.now())}_releaseSymbolFadeTiles(){for(const a in this._sourceCaches)this._sourceCaches[a].releaseSymbolFadeTiles()}addImport(a,d){this._checkLoaded();const g=this.stylesheet.imports=this.stylesheet.imports||[];if(g.findIndex(({id:w})=>w===a.id)!==-1)return this.fire(new l.a(new Error(`Import with id '${a.id}' already exists in the map's style.`)));if(!d)return g.push(a),this._loadImports([a],!0),this;const x=g.findIndex(({id:w})=>w===d);return x===-1?this.fire(new l.a(new Error(`Import with id "${d}" does not exist on this map.`))):(this.stylesheet.imports=g.slice(0,x).concat(a).concat(g.slice(x)),this._loadImports([a],!0,d),this)}updateImport(a,d){this._checkLoaded();const g=this.stylesheet.imports||[],x=this.getImportIndex(a);return x===-1?this:typeof d=="string"?(this.setImportUrl(a,d),this):(d.url&&d.url!==g[x].url&&this.setImportUrl(a,d.url),A(d.config,g[x].config)||this.setImportConfig(a,d.config),A(d.data,g[x].data)||this.setImportData(a,d.data),this)}moveImport(a,d){this._checkLoaded();let g=this.stylesheet.imports||[];const x=this.getImportIndex(a);if(x===-1)return this;const w=this.getImportIndex(d);if(w===-1)return this;const S=g[x],C=this.fragments[x];return g=g.filter(({id:R})=>R!==a),this.fragments=this.fragments.filter(({id:R})=>R!==a),this.stylesheet.imports=g.slice(0,w).concat(S).concat(g.slice(w)),this.fragments=this.fragments.slice(0,w).concat(C).concat(this.fragments.slice(w)),this.mergeLayers(),this}setImportUrl(a,d){this._checkLoaded();const g=this.stylesheet.imports||[],x=this.getImportIndex(a);if(x===-1)return this;g[x].url=d;const w=this.fragments[x];return w.style=this._createFragmentStyle(g[x]),w.style.on("style.import.load",()=>this.mergeAll()),w.style.loadURL(d),this}setImportData(a,d){this._checkLoaded();const g=this.getImportIndex(a),x=this.stylesheet.imports||[];return g===-1?this:d?(this.fragments[g].style.setState(d),this._reloadImports(),this):(delete x[g].data,this.setImportUrl(a,x[g].url))}setImportConfig(a,d){this._checkLoaded();const g=this.getImportIndex(a),x=this.stylesheet.imports||[];if(g===-1)return this;d?x[g].config=d:delete x[g].config;const w=this.fragments[g],S=w.style.stylesheet&&w.style.stylesheet.schema;return w.config=d,w.style.setConfig(d,S),this.updateConfigDependencies(),this}removeImport(a){this._checkLoaded();const d=this.stylesheet.imports||[],g=this.getImportIndex(a);return g===-1||(d.splice(g,1),this.fragments[g].style._remove(),this.fragments.splice(g,1),this._reloadImports()),this}getImportIndex(a){const d=(this.stylesheet.imports||[]).findIndex(g=>g.id===a);return d===-1&&this.fire(new l.a(new Error(`Import '${a}' does not exist in the map's style and cannot be updated.`))),d}getLayer(a){return this._mergedLayers[a]}getSources(){const a=[];for(const d in this._mergedOtherSourceCaches){const g=this._mergedOtherSourceCaches[d];g&&a.push(g.getSource())}return a}getSource(a,d){const g=this.getSourceCache(a,d);return g&&g.getSource()}getLayerSource(a){const d=this.getLayerSourceCache(a);return d&&d.getSource()}getSourceCache(a,d){const g=l.ag(a,d);return this._mergedOtherSourceCaches[g]}getLayerSourceCache(a){const d=l.ag(a.source,a.scope);return a.type==="symbol"?this._mergedSymbolSourceCaches[d]:this._mergedOtherSourceCaches[d]}getSourceCaches(a){const d=[];return this._mergedOtherSourceCaches[a]&&d.push(this._mergedOtherSourceCaches[a]),this._mergedSymbolSourceCaches[a]&&d.push(this._mergedSymbolSourceCaches[a]),d}updateSourceCaches(){const a=this._changes.getUpdatedSourceCaches();for(const d in a){const g=a[d];g==="reload"?this.reloadSource(d):g==="clear"&&this.clearSource(d)}}updateLayers(a){const d=this._changes.getUpdatedPaintProperties();for(const g of d){const x=this.getLayer(g);x&&x.updateTransitions(a)}}getImages(a,d,g){this.imageManager.getImages(d.icons,d.scope,g),this._updateTilesForChangedImages();const x=w=>{w&&w.setDependencies(d.tileID.key,d.type,d.icons)};x(this._otherSourceCaches[d.source]),x(this._symbolSourceCaches[d.source])}getGlyphs(a,d,g){this.glyphManager.getGlyphs(d.stacks,d.scope,g)}getResource(a,d,g){return l.c9(d,g)}getOwnSourceCache(a){return this._otherSourceCaches[a]}getOwnLayerSourceCache(a){return a.type==="symbol"?this._symbolSourceCaches[a.source]:this._otherSourceCaches[a.source]}getOwnSourceCaches(a){const d=[];return this._otherSourceCaches[a]&&d.push(this._otherSourceCaches[a]),this._symbolSourceCaches[a]&&d.push(this._symbolSourceCaches[a]),d}_isSourceCacheLoaded(a){const d=this.getOwnSourceCaches(a);return d.length===0?(this.fire(new l.a(new Error(`There is no source with ID '${a}'`))),!1):d.every(g=>g.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(a=>{a.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}To.getSourceType=function(_){return Jo[_]},To.setSourceType=function(_,a){Jo[_]=a},To.registerForPluginStateChange=l.bV;var jh=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,$h=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec2 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color) {
#ifdef INDICATOR_CUTOUT
float holeMinOpacity=u_indicator_cutout_params.x;float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,vec2 pos,vec2 lod_coord) {vec2 size=vec2(textureSize(image,0));vec2 dx=dFdx(lod_coord.xy*size);vec2 dy=dFdy(lod_coord.xy*size);float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}`,Wh=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,Hh="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",sp=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(
unpack_depth(texture(u_depth,uv-df.xz)),unpack_depth(texture(u_depth,uv+df.xz)),unpack_depth(texture(u_depth,uv-df.zy)),unpack_depth(texture(u_depth,uv+df.zy))
);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }
#endif`,op=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,rg=`highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}
#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {
#ifdef FOG_DITHERING
vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);
#else
return color;
#endif
}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,Zl=`#ifdef RASTER_ARRAY
uniform sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Yl=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform vec2 u_velocity_res;uniform float u_max_speed;const vec2 INVALID_VELOCITY=vec2(-1);uniform vec2 u_texture_offset;uniform float u_data_offset;uniform vec4 u_data_scale;vec2 lookup_velocity(vec2 uv) {uv=u_texture_offset.x+u_texture_offset.y*uv;vec2 fxy;ivec4 c=_raTexLinearCoord(uv,u_velocity_res,fxy);vec4 tl=texelFetch(u_velocity,c.yz,0);vec4 tr=texelFetch(u_velocity,c.xz,0);vec4 bl=texelFetch(u_velocity,c.yw,0);vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NODATA) {return INVALID_VELOCITY;}if (tr==NODATA) {return INVALID_VELOCITY;}if (bl==NODATA) {return INVALID_VELOCITY;}if (br==NODATA) {return INVALID_VELOCITY;}vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);
#ifdef DATA_FORMAT_UINT32
vec2 velocity=vec2(u_data_offset+dot(t,u_data_scale),0);return velocity;
#else
vec2 velocity=vec2(u_data_offset+dot(t.rg,u_data_scale.yx),-(u_data_offset+dot(t.ba,u_data_scale.yx)));
#endif
return velocity/max(u_max_speed,length(velocity));}
#endif`,ap=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,cu=`#ifdef RENDER_SHADOWS
#ifdef DEPTH_TEXTURE
uniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;
#else
uniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;
#endif
uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_1,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_0,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;
#ifdef NATIVE
highp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));
#else
highp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(
shadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)
);
#endif
vec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {
#ifdef SHADOWS_SINGLE_CASCADE
light_view_pos0.xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);
#else
light_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const Kl=[];ka(jh,Kl),ka(Wh,Kl),ka($h,Kl);const to={"_prelude_fog.vertex.glsl":op,"_prelude_terrain.vertex.glsl":sp,"_prelude_shadow.vertex.glsl":ap,"_prelude_fog.fragment.glsl":rg,"_prelude_shadow.fragment.glsl":cu,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":Zl,"_prelude_raster_particle.glsl":Yl},Jl={};nr("",sp),nr(rg,op),nr(cu,ap),nr(Zl,""),nr(Yl,"");const lp=nr($h,Wh),qh=jh;var cp={background:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:nr("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:nr(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:nr(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:nr("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in float a_size_scale;in vec2 a_padding;in float a_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(a_z_offset+elevation(a_anchor_pos)),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:nr("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:nr("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
in vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;in vec2 v_pos;uniform float u_emissive_strength;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
uniform float u_emissive_strength;in float v_height;void main() {
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,u_emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=max(0.01,cutoff_opacity(u_cutoff_params,ground.z));if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff < 0.01 && centroid_pos.x !=0.0));gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);v_flat=vec4(linearProduct(color.rgb,vec3(calculate_NdotL(normal))),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:nr(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_vertical_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base);pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
out vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif 
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:nr(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0)).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:nr(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(1.0,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:nr(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trimmed=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {out_color=vec4(0,0,0,0);trimmed=0.0;}}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=(border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {    
float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color.rgb=mix(border_color.rgb*border_color.a*trimmed,out_color.rgb,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec4 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);
#else
v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec4 v_uv;
#endif
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;vec2 pattern_size=vec2(display_size.x/u_tile_units_to_pixels,display_size.y);float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float pattern_x=v_linesofar/pattern_size.x*aspect;float x=mod(pattern_x,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {color=vec4(0,0,0,0);}}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_ground(color);
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
color=applyCutout(color);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec4 a_packed;
#endif
in float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec4 v_uv;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
float a_uv_x=a_packed[0];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;vec2 uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
vec2 uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:nr("precision highp float;uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`precision highp float;
#include "_prelude_raster_array.glsl"
#include "_prelude_raster_particle.glsl"
in vec3 a_pos;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {vec2 pos=a_pos.xy+u_tile_offset;vec2 tex_coords=fract(pos);gl_PointSize=1.0;vec2 velocity=lookup_velocity(tex_coords);if (velocity==INVALID_VELOCITY) {v_particle_speed=0.0;gl_Position=vec4(2.0,2.0,2.0,1.0);} else {v_particle_speed=length(velocity);gl_Position=vec4(2.0*pos-vec2(1.0),0.0,1.0);}}`),rasterParticleTexture:nr("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {v_tex_pos=0.5*a_pos+vec2(0.5);gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:nr("void main() {}",`#include "_prelude_raster_array.glsl"
#include "_prelude_raster_particle.glsl"
in vec3 a_pos;uniform float u_speed_factor;uniform float u_lifetime_delta;uniform float u_rand_seed;out vec3 v_new_particle;const vec3 rand_constants=vec3(12.9898,78.233,4375.85453);float rand(const vec2 co) {float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {float lifetime=a_pos.z;vec2 pos=a_pos.xy;vec2 uv=clamp(pos,vec2(0.0),vec2(1.0));vec2 velocity=lookup_velocity(uv);float next_lifetime=lifetime-u_lifetime_delta;float t=step(0.0,next_lifetime);
#ifdef DATA_FORMAT_UINT32
vec2 dp=vec2(0);
#else
vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;
#endif
vec2 seed=pos*u_rand_seed;vec2 next_pos=pos+dp;vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));v_new_particle=vec3(
vec2(mix(random_pos,next_pos,t)),mix(1.0,next_lifetime,t)
);}`),symbolIcon:nr(`#include "_prelude_lighting.glsl"
uniform sampler2D u_texture;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
in float v_fade_opacity;in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
uniform mediump float u_icon_saturation;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float emissive_strength
lowp float alpha=opacity*v_fade_opacity;vec4 out_color;
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b)*alpha;
#else
out_color=texture(u_texture,v_tex_a)*alpha;
#endif
#ifdef SATURATION
vec3 luma=vec3(dot(out_color.rgb,vec3(0.2126,0.7152,0.0722)));out_color.rgb=mix(luma,out_color.rgb,u_icon_saturation);
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_fade_opacity;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
v_tex_a=a_tex/u_texsize;
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
v_fade_opacity=out_fade_opacity;}`),symbolSDF:nr(`#include "_prelude_lighting.glsl"
#define SDF_PX 8.0
uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;in float v_draw_halo;in vec2 v_data0;in vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out float v_draw_halo;out vec2 v_data0;out vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,out_fade_opacity);}`),symbolTextAndIcon:nr(`#include "_prelude_lighting.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_halo;in float v_draw_halo;in vec4 v_data0;in vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out float v_draw_halo;out vec4 v_data0;out vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,out_fade_opacity,is_sdf);}`),terrainRaster:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:nr("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:nr(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Hh),skyboxGradient:nr(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Hh),skyboxCapture:nr(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:nr(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;
#ifndef NATIVE
c=dither(c,gl_FragCoord.xy+u_temporal_offset);
#endif
glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:nr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform sampler2D u_depthTexture;uniform vec2 u_inv_depth_size;bool isOccluded() {vec2 coord=gl_FragCoord.xy*u_inv_depth_size;highp float depth=unpack_depth(texture(u_depthTexture,coord));return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
return vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);color=mix(color,v_color_mix.rgb,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=u_matrix*pos;pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=local_pos;
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normalize(normal_3f));shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1);v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:nr(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=u_matrix*pos;
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:nr(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`)};function ka(_,a){const d=_.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let g of d)if(g=g.trim(),g[0]==="#"&&g.includes("if")&&!g.includes("endif")){g=g.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const x=g.split(" ");for(const w of x)a.includes(w)||a.push(w)}}function nr(_,a){const d=/#include\s+"([^"]+)"/g,g=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let x=a.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);x&&(x=x.map(D=>{const N=D.split(" ");return N[N.length-1]}),x=[...new Set(x)]);const w={},S=[],C=[];if(_=_.replace(d,(D,N)=>(C.push(N),"")),(a=a.replace(d,(D,N)=>(S.push(N),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let R=[...Kl];ka(_,R),ka(a,R);for(const D of[...S,...C])to[D]||console.error(`Undefined include: ${D}`),Jl[D]||(Jl[D]=[],ka(to[D],Jl[D])),R=[...R,...Jl[D]];return{fragmentSource:_=_.replace(g,(D,N,B,j,$)=>(w[$]=!0,N==="define"?`
#ifndef HAS_UNIFORM_u_${$}
in ${B} ${j} ${$};
#else
uniform ${B} ${j} u_${$};
#endif
`:N==="initialize"?`
#ifdef HAS_UNIFORM_u_${$}
    ${B} ${j} ${$} = u_${$};
#endif
`:N==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${$}
    in ${B} ${j} ${$};
#endif
`:N==="initialize-attribute"?"":void 0)),vertexSource:a=a.replace(g,(D,N,B,j,$)=>{const Z=j==="float"?"vec2":j,X=$.match(/color/)?"color":Z;return N==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${$}
in ${B} ${j} a_${$};
#endif
`:w[$]?N==="define"?`
#ifndef HAS_UNIFORM_u_${$}
uniform lowp float u_${$}_t;
in ${B} ${Z} a_${$};
out ${B} ${j} ${$};
#else
uniform ${B} ${j} u_${$};
#endif
`:N==="initialize"?X==="vec4"?`
#ifndef HAS_UNIFORM_u_${$}
    ${$} = a_${$};
#else
    ${B} ${j} ${$} = u_${$};
#endif
`:`
#ifndef HAS_UNIFORM_u_${$}
    ${$} = unpack_mix_${X}(a_${$}, u_${$}_t);
#else
    ${B} ${j} ${$} = u_${$};
#endif
`:N==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${$}
    in ${B} ${j} a_${$};
    out ${B} ${j} ${$};
#endif
`:N==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${$}
    ${$} = a_${$};
#endif
`:void 0:N==="define"?`
#ifndef HAS_UNIFORM_u_${$}
uniform lowp float u_${$}_t;
in ${B} ${Z} a_${$};
#else
uniform ${B} ${j} u_${$};
#endif
`:N==="define-instanced"?X==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${$}0;
in vec4 a_${$}1;
in vec4 a_${$}2;
in vec4 a_${$}3;
#else
uniform ${B} ${j} u_${$};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${B} ${Z} a_${$};
#else
uniform ${B} ${j} u_${$};
#endif
`:N==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${$}
    ${B} ${j} ${$} = a_${$};
#endif
`:X==="vec4"?`
#ifndef HAS_UNIFORM_u_${$}
    ${B} ${j} ${$} = a_${$};
#else
    ${B} ${j} ${$} = u_${$};
#endif
`:`
#ifndef HAS_UNIFORM_u_${$}
    ${B} ${j} ${$} = unpack_mix_${X}(a_${$}, u_${$}_t);
#else
    ${B} ${j} ${$} = u_${$};
#endif
`}),staticAttributes:x,usedDefines:R,vertexIncludes:S,fragmentIncludes:C}}class up{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(a,d,g,x,w,S,C,R){this.context=a;let D=this.boundPaintVertexBuffers.length!==x.length;for(let B=0;!D&&B<x.length;B++)this.boundPaintVertexBuffers[B]!==x[B]&&(D=!0);let N=this.boundDynamicVertexBuffers.length!==C.length;for(let B=0;!N&&B<C.length;B++)this.boundDynamicVertexBuffers[B]!==C[B]&&(N=!0);if(!this.vao||this.boundProgram!==d||this.boundLayoutVertexBuffer!==g||D||N||this.boundIndexBuffer!==w||this.boundVertexOffset!==S)this.freshBind(d,g,x,w,S,C,R);else{a.bindVertexArrayOES.set(this.vao);for(const B of C)B&&(B.bind(),R&&B.instanceCount&&B.setVertexAttribDivisor(a.gl,d,R));w&&w.dynamicDraw&&w.bind()}}freshBind(a,d,g,x,w,S,C){const R=a.numAttributes,D=this.context,N=D.gl;this.vao&&this.destroy(),this.vao=D.gl.createVertexArray(),D.bindVertexArrayOES.set(this.vao),this.boundProgram=a,this.boundLayoutVertexBuffer=d,this.boundPaintVertexBuffers=g,this.boundIndexBuffer=x,this.boundVertexOffset=w,this.boundDynamicVertexBuffers=S,d.enableAttributes(N,a),d.bind(),d.setVertexAttribPointers(N,a,w);for(const B of g)B.enableAttributes(N,a),B.bind(),B.setVertexAttribPointers(N,a,w);for(const B of S)B&&(B.enableAttributes(N,a),B.bind(),B.setVertexAttribPointers(N,a,w),C&&B.instanceCount&&B.setVertexAttribDivisor(N,a,C));x&&x.bind(),D.currentNumAttributes=R}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function O1(_,a){const d=Math.pow(2,a.canonical.z),g=a.canonical.y;return[new l.L(0,g/d).toLngLat().lat,new l.L(0,(g+1)/d).toLngLat().lat]}function Gh(_,a,d,g,x,w,S){const C=_.context,R=C.gl,D=d.hillshadeFBO;if(!D)return;_.prepareDrawTile();const N=_.isTileAffectedByFog(a),B=_.getOrCreateProgram("hillshade",{overrideFog:N});C.activeTexture.set(R.TEXTURE0),R.bindTexture(R.TEXTURE_2D,D.colorAttachment.get());const j=((K,q,ee,ae)=>{const re=ee.paint.get("hillshade-shadow-color"),le=ee.paint.get("hillshade-highlight-color"),Q=ee.paint.get("hillshade-accent-color"),ce=ee.paint.get("hillshade-emissive-strength");let ve=l.bj(ee.paint.get("hillshade-illumination-direction"));if(ee.paint.get("hillshade-illumination-anchor")==="viewport")ve-=K.transform.angle;else if(K.style&&K.style.enable3dLights()&&K.style.directionalLight){const Ce=K.style.directionalLight.properties.get("direction"),Ue=l.bQ(Ce.x,Ce.y,Ce.z);ve=l.bj(Ue[1])}const we=!K.options.moving;return{u_matrix:ae||K.transform.calculateProjMatrix(q.tileID.toUnwrapped(),we),u_image:0,u_latrange:O1(0,q.tileID),u_light:[ee.paint.get("hillshade-exaggeration"),ve],u_shadow:re,u_highlight:le,u_emissive_strength:ce,u_accent:Q}})(_,d,g,_.terrain?a.projMatrix:null);_.uploadCommonUniforms(C,B,a.toUnwrapped());const{tileBoundsBuffer:$,tileBoundsIndexBuffer:Z,tileBoundsSegments:X}=_.getTileBoundsBuffers(d);B.draw(_,R.TRIANGLES,x,w,S,ci.disabled,j,g.id,$,Z,X)}function ng(_,a,d){if(!a.needsDEMTextureUpload)return;const g=_.context,x=g.gl;g.pixelStoreUnpackPremultiplyAlpha.set(!1),a.demTexture=a.demTexture||_.getTileTexture(d.stride);const w=d.getPixels();a.demTexture?a.demTexture.update(w,{premultiply:!1}):a.demTexture=new l.T(g,w,x.R32F,{premultiply:!1}),a.needsDEMTextureUpload=!1}function hp(_,a,d){const g=_.context,x=g.gl;if(!a.dem)return;const w=a.dem;if(g.activeTexture.set(x.TEXTURE1),ng(_,a,w),!a.demTexture)return;a.demTexture.bind(x.NEAREST,x.CLAMP_TO_EDGE);const S=w.dim;g.activeTexture.set(x.TEXTURE0);let C=a.hillshadeFBO;if(!C){const j=new l.T(g,{width:S,height:S,data:null},x.RGBA);j.bind(x.LINEAR,x.CLAMP_TO_EDGE),C=a.hillshadeFBO=g.createFramebuffer(S,S,!0,"renderbuffer"),C.colorAttachment.set(j.texture)}g.bindFramebuffer.set(C.framebuffer),g.viewport.set([0,0,S,S]);const{tileBoundsBuffer:R,tileBoundsIndexBuffer:D,tileBoundsSegments:N}=_.getMercatorTileBoundsBuffers(),B=[];_.linearFloatFilteringSupported()&&B.push("TERRAIN_DEM_FLOAT_FORMAT"),_.getOrCreateProgram("hillshadePrepare",{defines:B}).draw(_,x.TRIANGLES,li.disabled,vi.disabled,Fi.unblended,ci.disabled,((j,$)=>{const Z=$.stride,X=l.a6.create();return l.a6.ortho(X,0,l.V,-l.V,0,0,1),l.a6.translate(X,X,[0,-l.V,0]),{u_matrix:X,u_image:1,u_dimension:[Z,Z],u_zoom:j.overscaledZ}})(a.tileID,w),d.id,R,D,N),a.needsHillshadePrepare=!1}const sg=_=>({u_matrix:new l.bK(_),u_image0:new l.bO(_),u_skirt_height:new l.bN(_),u_ground_shadow_factor:new l.bM(_)}),Xh=(_,a,d)=>({u_matrix:_,u_image0:0,u_skirt_height:a,u_ground_shadow_factor:d}),og=(_,a,d,g,x,w,S,C,R,D,N,B,j,$,Z,X)=>({u_proj_matrix:Float32Array.from(_),u_globe_matrix:a,u_normalize_matrix:Float32Array.from(g),u_merc_matrix:d,u_zoom_transition:x,u_merc_center:w,u_image0:0,u_frustum_tl:S,u_frustum_tr:C,u_frustum_br:R,u_frustum_bl:D,u_globe_pos:N,u_globe_radius:B,u_viewport:j,u_grid_matrix:X?Float32Array.from(X):new Float32Array(9),u_skirt_height:$,u_far_z_cutoff:Z});function uu(_,a){return _!=null&&a!=null&&!(!_.hasData()||!a.hasData())&&_.demTexture!=null&&a.demTexture!=null&&_.tileID.key!==a.tileID.key}const Ql=new class{constructor(){this.operations={}}newMorphing(_,a,d,g,x){if(_ in this.operations){const w=this.operations[_];w.to.tileID.key!==d.tileID.key&&(w.queued=d)}else this.operations[_]={startTime:g,phase:0,duration:x,from:a,to:d,queued:null}}getMorphValuesForProxy(_){if(!(_ in this.operations))return null;const a=this.operations[_];return{from:a.from,to:a.to,phase:a.phase}}update(_){for(const a in this.operations){const d=this.operations[a];for(d.phase=(_-d.startTime)/d.duration;d.phase>=1||!this._validOp(d);)if(!this._nextOp(d,_)){delete this.operations[a];break}}}_nextOp(_,a){return!!_.queued&&(_.from=_.to,_.to=_.queued,_.queued=null,_.phase=0,_.startTime=a,!0)}_validOp(_){return _.from.hasData()&&_.to.hasData()}},dp={0:null,1:"TERRAIN_VERTEX_MORPHING"};function fp(_,a,d){if(a===0)return 0;const g=a<1&&d===514?.25/a:1;return 6*Math.pow(1.5,22-_)*Math.max(a,1)*g}function ec(_,a){const d=1<<_.z;return!a&&(_.x===0||_.x===d-1)||_.y===0||_.y===d-1}const pp=_=>({u_matrix:_});function mp(_,a,d,g,x){if(x>0){const w=l.f.now(),S=(w-_.timeAdded)/x,C=a?(w-a.timeAdded)/x:-1,R=d.getSource(),D=g.coveringZoomLevel({tileSize:R.tileSize,roundZoom:R.roundZoom}),N=!a||Math.abs(a.tileID.overscaledZ-D)>Math.abs(_.tileID.overscaledZ-D),B=N&&_.refreshedUponExpiration?1:l.aa(N?S:1-C,0,1);return _.refreshedUponExpiration&&S>=1&&(_.refreshedUponExpiration=!1),a?{opacity:1,mix:1-B}:{opacity:B,mix:0}}return{opacity:1,mix:0}}class k1 extends bo{constructor(a){const d={type:"raster-dem",maxzoom:a.transform.maxZoom},g=new l.bW(l.bX(),null),x=Gn("mock-dem",d,g,a.style);super("mock-dem",x,!1),x.setEventedParent(this),this._sourceLoaded=!0}_loadTile(a,d){a.state="loaded",d(null)}}class D1 extends bo{constructor(a){const d=Gn("proxy",{type:"geojson",maxzoom:a.transform.maxZoom},new l.bW(l.bX(),null),a.style);super("proxy",d,!1),d.setEventedParent(this),this.map=this.getSource().map=a,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(a,d,g){if(a.freezeTileCoverage)return;this.transform=a;const x=a.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((w,S)=>{if(w[S.key]="",!this._tiles[S.key]){const C=new Sa(S,this._source.tileSize*S.overscaleFactor(),a.tileZoom);C.state="loaded",this._tiles[S.key]=C}return w},{});for(const w in this._tiles)w in x||(this.freeFBO(w),this._tiles[w].unloadVectorData(),delete this._tiles[w])}freeFBO(a){const d=this.proxyCachedFBO[a];if(d!==void 0){const g=Object.values(d);this.renderCachePool.push(...g),delete this.proxyCachedFBO[a]}}deallocRenderCache(){this.renderCache.forEach(a=>a.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class ag extends l.am{constructor(a,d,g){super(a.overscaledZ,a.wrap,a.canonical.z,a.canonical.x,a.canonical.y),this.proxyTileKey=d,this.projMatrix=g}}class L1 extends l.ck{constructor(a,d){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},a.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),a.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),a.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=a,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[g,x,w]=function(R){const D=new l.aN,N=new l.aw,B=131;D.reserve(17161),N.reserve(33800);const j=l.V/128,$=l.V+j/2,Z=$+j;for(let K=-j;K<Z;K+=j)for(let q=-j;q<Z;q+=j){const ee=q<0||q>$||K<0||K>$?24575:0,ae=l.aa(Math.round(q),0,l.V),re=l.aa(Math.round(K),0,l.V);D.emplaceBack(ae+ee,re)}const X=(K,q)=>{const ee=q*B+K;N.emplaceBack(ee+1,ee,ee+B),N.emplaceBack(ee+B,ee+B+1,ee+1)};for(let K=1;K<129;K++)for(let q=1;q<129;q++)X(q,K);return[0,129].forEach(K=>{for(let q=0;q<130;q++)X(q,K),X(K,q)}),[D,N,32768]}(),S=a.context;this.gridBuffer=S.createVertexBuffer(g,l.aP.members),this.gridIndexBuffer=S.createIndexBuffer(x),this.gridSegments=l.aB.simpleSegment(0,0,g.length,x.length),this.gridNoSkirtSegments=l.aB.simpleSegment(0,0,g.length,w),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new D1(d.map),this.orthoMatrix=l.a6.create(),l.a6.ortho(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,l.V,0,l.V,0,1);const C=S.gl;this._overlapStencilMode=new vi({func:C.GEQUAL,mask:255},0,255,C.KEEP,C.KEEP,C.REPLACE),this._previousZoom=a.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=d,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new k1(d.map),this._pendingGroundEffectLayers=[]}set style(a){a.on("data",this._onStyleDataEvent.bind(this)),this._style=a,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(a,d,g){if(a&&a.terrain){this._style!==a&&(this.style=a,this._evaluationZoom=void 0);const x=a.terrain.properties,w=a.terrain.drapeRenderMode===0,S=a.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=l.f.now();const C=a.terrain&&a.terrain.scope,R=x.get("source"),D=w?this._mockSourceCache:a.getSourceCache(R,C);if(!D)return void l.w(`Couldn't find terrain source "${R}".`);if(this.sourceCache=D,this._exaggeration=S?this.calculateExaggeration(d):x.get("exaggeration"),!d.projection.requiresDraping&&S&&this._exaggeration===0)return void this._disable();this.enabled=!0;const N=()=>{this.sourceCache.used&&l.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const B=this.getScaledDemTileSize();this.sourceCache.update(d,B,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,N(),this._initializing=!0),N(),d.updateElevation(!0,g),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(d),this._emptyDEMTextureDirty=!0,this._previousZoom=d.zoom}else this._disable()}calculateExaggeration(a){const d=this._previousCameraAltitude,g=a.getFreeCameraOptions().position.z/a.pixelsPerMeter*a.worldSize;this._previousCameraAltitude=g;const x=d!=null?g-d:Number.MAX_VALUE;if(Math.abs(x)<2)return this._exaggeration;const w=a.zoom,S=this._style.terrain;if(!this._previousUpdateTimestamp)return S.getExaggeration(w);let C=w-this._previousZoom;const R=this._previousUpdateTimestamp;let D=w;this._evaluationZoom!=null&&(D=this._evaluationZoom,Math.abs(w-D)>.5&&(C=.5*(w-D+C)),C*x<0&&(D+=C)),this._evaluationZoom=D;const N=S.getExaggeration(D),B=N===S.getExaggeration(Math.max(0,D-.1));if(B&&Math.abs(N-this._exaggeration)<.01)return N;let j=Math.min(.1,.00375*(this._updateTimestamp-R));return(B||N<.1||Math.abs(C)<1e-4)&&(j=Math.min(.2,4*j)),l.U(this._exaggeration,N,j)}resetTileLookupCache(a){this._findCoveringTileCache[a]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(a){a.coord&&a.dataType==="source"?this._clearRenderCacheForTile(a.sourceCacheId,a.coord):a.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const a in this._style._mergedSourceCaches)this._style._mergedSourceCaches[a].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(a=>a.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const a=2*this.proxySourceCache.getSource().tileSize;return[a,a]}set useVertexMorphing(a){this._useVertexMorphing=a}updateTileBinding(a){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const d=this.proxySourceCache,g=this.painter.transform;this._initializing&&(this._initializing=g._centerAltitude===0&&this.getAtPointOrZero(l.L.fromLngLat(g.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const x=this.proxyCoords=d.getIds().map(R=>{const D=d.getTileByID(R).tileID;return D.projMatrix=g.calculateProjMatrix(D.toUnwrapped()),D});(function(R,D){const N=D.transform.pointCoordinate(D.transform.getCameraPoint()),B=new l.P(N.x,N.y);R.sort((j,$)=>{if($.overscaledZ-j.overscaledZ)return $.overscaledZ-j.overscaledZ;const Z=new l.P(j.canonical.x+(1<<j.canonical.z)*j.wrap,j.canonical.y),X=new l.P($.canonical.x+(1<<$.canonical.z)*$.wrap,$.canonical.y),K=B.mult(1<<j.canonical.z);return K.x-=.5,K.y-=.5,K.distSqr(Z)-K.distSqr(X)})})(x,this.painter);const w=this.proxyToSource||{};this.proxyToSource={},x.forEach(R=>{this.proxyToSource[R.key]={}}),this.terrainTileForTile={};const S=this._style._mergedSourceCaches;for(const R in S){const D=S[R];if(!D.used||(D!==this.sourceCache&&this.resetTileLookupCache(D.id),this._setupProxiedCoordsForOrtho(D,a[R],w),D.usedForTerrain))continue;const N=a[R];D.getSource().reparseOverscaled&&this._assignTerrainTiles(N)}this.proxiedCoords[d.id]=x.map(R=>new ag(R,R.key,this.orthoMatrix)),this._assignTerrainTiles(x),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(w),this.renderingToTexture=!1;const C={};this._visibleDemTiles=[];for(const R of this.proxyCoords){const D=this.terrainTileForTile[R.key];if(!D)continue;const N=D.tileID.key;N in C||(this._visibleDemTiles.push(D),C[N]=N)}}_assignTerrainTiles(a){this._initializing||a.forEach(d=>{if(this.terrainTileForTile[d.key])return;const g=this._findTileCoveringTileID(d,this.sourceCache);g&&(this.terrainTileForTile[d.key]=g)})}_prepareDEMTextures(){const a=this.painter.context,d=a.gl;for(const g in this.terrainTileForTile){const x=this.terrainTileForTile[g],w=x.dem;!w||x.demTexture&&!x.needsDEMTextureUpload||(a.activeTexture.set(d.TEXTURE1),ng(this.painter,x,w))}}_prepareDemTileUniforms(a,d,g,x){if(!d||d.demTexture==null)return!1;const w=a.tileID.canonical,S=Math.pow(2,d.tileID.canonical.z-w.z),C=x||"";return g[`u_dem_tl${C}`]=[w.x*S%1,w.y*S%1],g[`u_dem_scale${C}`]=S,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const a=this.painter.context,d=a.gl;if(!this._emptyDepthBufferTexture){const g=new l.h({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new l.T(a,g,d.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let a=0;const d=this._visibleDemTiles.reduce((g,x)=>{if(!x.dem)return g;const w=x.dem.tree.minimums[0];return w>0&&a++,g+w},0);return a?d/a:0}_updateEmptyDEMTexture(){const a=this.painter.context,d=a.gl;a.activeTexture.set(d.TEXTURE2);const g=this._getLoadedAreaMinimum(),[x,w]=(()=>{const C=new l.cm({width:1,height:1},new Float32Array([g]));return[d.R32F,C]})();this._emptyDEMTextureDirty=!1;let S=this._emptyDEMTexture;return S?S.update(w,{premultiply:!1}):S=this._emptyDEMTexture=new l.T(a,w,x,{premultiply:!1}),S}setupElevationDraw(a,d,g){const x=this.painter.context,w=x.gl,S={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0};S.u_exaggeration=this.exaggeration();let C=null,R=null,D=1;if(g&&g.morphing&&this._useVertexMorphing){const j=g.morphing.srcDemTile,$=g.morphing.dstDemTile;D=g.morphing.phase,j&&$&&(this._prepareDemTileUniforms(a,j,S,"_prev")&&(R=j),this._prepareDemTileUniforms(a,$,S)&&(C=$))}const N=j=>j&&j.demTexture&&this.painter.linearFloatFilteringSupported()?w.LINEAR:w.NEAREST,B=j=>{S.u_dem_size=j.size[0]===1?1:j.size[0]-2};if(R&&C)x.activeTexture.set(w.TEXTURE2),C.demTexture.bind(N(C),w.CLAMP_TO_EDGE),x.activeTexture.set(w.TEXTURE4),R.demTexture.bind(N(R),w.CLAMP_TO_EDGE),C.demTexture&&B(C.demTexture),S.u_dem_lerp=D;else{C=this.terrainTileForTile[a.tileID.key],x.activeTexture.set(w.TEXTURE2);const j=this._prepareDemTileUniforms(a,C,S)?C.demTexture:this.emptyDEMTexture;j.bind(N(C),w.CLAMP_TO_EDGE),B(j)}if(x.activeTexture.set(w.TEXTURE3),g&&g.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(w.NEAREST,w.CLAMP_TO_EDGE),this._depthFBO&&(S.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(w.NEAREST,w.CLAMP_TO_EDGE),S.u_depth_size_inv=[1,1]),g&&g.useMeterToDem&&C){const j=(1<<C.tileID.canonical.z)*l.bl(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;S.u_meter_to_dem=j}if(g&&g.labelPlaneMatrixInv&&(S.u_label_plane_matrix_inv=g.labelPlaneMatrixInv),d.setTerrainUniformValues(x,S),this.painter.transform.projection.name==="globe"){const j=this.globeUniformValues(this.painter.transform,a.tileID.canonical,g&&g.useDenormalizedUpVectorScale);d.setGlobeUniformValues(x,j)}}globeUniformValues(a,d,g){const x=a.projection;return{u_tile_tl_up:x.upVector(d,0,0),u_tile_tr_up:x.upVector(d,l.V,0),u_tile_br_up:x.upVector(d,l.V,l.V),u_tile_bl_up:x.upVector(d,0,l.V),u_tile_up_scale:g?l.cl(1):x.upVectorScale(d,a.center.lat,a.worldSize).metersToTile}}renderToBackBuffer(a){const d=this.painter,g=this.painter.context;a.length!==0&&(g.bindFramebuffer.set(null),g.viewport.set([0,0,d.width,d.height]),d.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(x,w,S,C,R){if(x.transform.projection.name==="globe")(function(D,N,B,j,$){const Z=D.context,X=Z.gl;let K,q;const ee=D.transform,ae=l.cd(D,Z,ee),re=(Ye,Ge)=>{if(q===Ge)return;const pt=[dp[Ge],"PROJECTION_GLOBE_VIEW"];ae&&pt.push("CUSTOM_ANTIALIASING");const ke=D.isTileAffectedByFog(Ye);K=D.getOrCreateProgram("globeRaster",{defines:pt,overrideFog:ke}),q=Ge},le=D.colorModeForRenderPass(),Q=new li(X.LEQUAL,li.ReadWrite,D.depthRangeFor3D);Ql.update($);const ce=l.ce(ee),ve=[l.a5(ee.center.lng),l.ae(ee.center.lat)],we=D.globeSharedBuffers,Ce=[ee.width*l.f.devicePixelRatio,ee.height*l.f.devicePixelRatio],Ue=Float32Array.from(ee.globeMatrix),Re={useDenormalizedUpVectorScale:!0};{const Ye=D.transform,Ge=fp(Ye.zoom,N.exaggeration(),N.sourceCache._source.tileSize);q=-1;const pt=X.TRIANGLES;for(const ke of j){const He=B.getTile(ke),Me=vi.disabled,Ne=N.prevTerrainTileForTile[ke.key],mt=N.terrainTileForTile[ke.key];uu(Ne,mt)&&Ql.newMorphing(ke.key,Ne,mt,$,250),Z.activeTexture.set(X.TEXTURE0),He.texture&&He.texture.bind(X.LINEAR,X.CLAMP_TO_EDGE);const Mt=Ql.getMorphValuesForProxy(ke.key),Tt=Mt?1:0;Mt&&l.j(Re,{morphing:{srcDemTile:Mt.from,dstDemTile:Mt.to,phase:l.cc(Mt.phase)}});const Lt=l.cf(ke.canonical),Zt=l.cg(Lt.getCenter().lat),si=l.ch(ke.canonical,Lt,Zt,Ye.worldSize/Ye._pixelsPerMercatorPixel),ei=l.aT(l.ci(ke.canonical)),ii=og(Ye.expandedFarZProjMatrix,Ue,ce,ei,l.S(Ye.zoom),ve,Ye.frustumCorners.TL,Ye.frustumCorners.TR,Ye.frustumCorners.BR,Ye.frustumCorners.BL,Ye.globeCenterInViewSpace,Ye.globeRadius,Ce,Ge,Ye._farZ,si);if(re(ke,Tt),K&&(N.setupElevationDraw(He,K,Re),D.uploadCommonUniforms(Z,K,ke.toUnwrapped()),we)){const[Ii,gi,Ti]=we.getGridBuffers(Zt,Ge!==0);K.draw(D,pt,Q,Me,le,ci.backCCW,ii,"globe_raster",Ii,gi,Ti)}}}if(we&&(D.renderDefaultNorthPole||D.renderDefaultSouthPole)){const Ye=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];ae&&Ye.push("CUSTOM_ANTIALIASING"),K=D.getOrCreateProgram("globeRaster",{defines:Ye});for(const Ge of j){const{x:pt,y:ke,z:He}=Ge.canonical,Me=ke===0,Ne=ke===(1<<He)-1,[mt,Mt,Tt,Lt]=we.getPoleBuffers(He,!1);if(Lt&&(Me||Ne)){const Zt=B.getTile(Ge);Z.activeTexture.set(X.TEXTURE0),Zt.texture&&Zt.texture.bind(X.LINEAR,X.CLAMP_TO_EDGE);let si=l.cj(He,pt,ee);const ei=l.aT(l.ci(Ge.canonical)),ii=(Ii,gi)=>Ii.draw(D,X.TRIANGLES,Q,vi.disabled,le,ci.disabled,og(ee.expandedFarZProjMatrix,si,si,ei,0,ve,ee.frustumCorners.TL,ee.frustumCorners.TR,ee.frustumCorners.BR,ee.frustumCorners.BL,ee.globeCenterInViewSpace,ee.globeRadius,Ce,0,ee._farZ),"globe_pole_raster",gi,Tt,Lt);N.setupElevationDraw(Zt,K,Re),D.uploadCommonUniforms(Z,K,Ge.toUnwrapped()),Me&&D.renderDefaultNorthPole&&ii(K,mt),Ne&&D.renderDefaultSouthPole&&(si=l.a6.scale(l.a6.create(),si,[1,-1,1]),ii(K,Mt))}}}})(x,w,S,C,R);else{const D=x.context,N=D.gl;let B,j;const $=x.shadowRenderer,Z=Ra(x,x.longestCutoffRange),X=le=>{if(j===le)return;const Q=[];Q.push(dp[le]),Z.shouldRenderCutoff&&Q.push("RENDER_CUTOFF"),B=x.getOrCreateProgram("terrainRaster",{defines:Q}),j=le},K=x.colorModeForRenderPass(),q=new li(N.LEQUAL,li.ReadWrite,x.depthRangeFor3D);Ql.update(R);const ee=x.transform,ae=fp(ee.zoom,w.exaggeration(),w.sourceCache._source.tileSize);let re=[0,0,0];if($){const le=x.style.directionalLight,Q=x.style.ambientLight;le&&Q&&(re=lu(le,Q))}{j=-1;const le=N.TRIANGLES,[Q,ce]=[w.gridIndexBuffer,w.gridSegments];for(const ve of C){const we=S.getTile(ve),Ce=vi.disabled,Ue=w.prevTerrainTileForTile[ve.key],Re=w.terrainTileForTile[ve.key];uu(Ue,Re)&&Ql.newMorphing(ve.key,Ue,Re,R,250),D.activeTexture.set(N.TEXTURE0),we.texture&&we.texture.bind(N.LINEAR,N.CLAMP_TO_EDGE);const Ye=Ql.getMorphValuesForProxy(ve.key),Ge=Ye?1:0;let pt;Ye&&(pt={morphing:{srcDemTile:Ye.from,dstDemTile:Ye.to,phase:l.cc(Ye.phase)}});const ke=Xh(ve.projMatrix,ec(ve.canonical,ee.renderWorldCopies)?ae/10:ae,re);if(X(Ge),!B)continue;w.setupElevationDraw(we,B,pt);const He=ve.toUnwrapped();$&&$.setupShadows(He,B),x.uploadCommonUniforms(D,B,He,null,Z),B.draw(x,le,q,Ce,K,ci.backCCW,ke,"terrain_raster",w.gridBuffer,Q,ce)}}}}(d,this,this.proxySourceCache,a,this._updateTimestamp),this.renderingToTexture=!0,d.gpuTimingDeferredRenderEnd(),a.splice(0,a.length))}renderBatch(a){if(this._drapedRenderBatches.length===0)return a+1;this.renderingToTexture=!0;const d=this.painter,g=this.painter.context,x=this.proxySourceCache,w=this.proxiedCoords[x.id],S=this._drapedRenderBatches.shift(),C=d.style.order,R=[];let D=0;for(const N of w){const B=x.getTileByID(N.proxyTileKey),j=x.proxyCachedFBO[N.key]?x.proxyCachedFBO[N.key][a]:void 0,$=j!==void 0?x.renderCache[j]:this.pool[D++],Z=j!==void 0;if(B.texture=$.tex,Z&&!$.dirty){R.push(B.tileID);continue}let X;g.bindFramebuffer.set($.fb.framebuffer),this.renderedToTile=!1,$.dirty&&(g.clear({color:l.ax.transparent,stencil:0}),$.dirty=!1);for(let K=S.start;K<=S.end;++K){const q=d.style._mergedLayers[C[K]];if(q.isHidden(d.transform.zoom))continue;const ee=d.style.getLayerSourceCache(q),ae=ee?this.proxyToSource[N.key][ee.id]:[N];if(!ae)continue;const re=ae;g.viewport.set([0,0,$.fb.width,$.fb.height]),X!==(ee?ee.id:null)&&(this._setupStencil($,ae,q,ee),X=ee?ee.id:null),d.renderLayer(d,ee,q,re)}if(this._drapedRenderBatches.length===0)for(const K of this._pendingGroundEffectLayers){const q=d.style._mergedLayers[C[K]];if(q.isHidden(d.transform.zoom))continue;const ee=d.style.getLayerSourceCache(q),ae=ee?this.proxyToSource[N.key][ee.id]:[N];if(!ae)continue;const re=ae;g.viewport.set([0,0,$.fb.width,$.fb.height]),X!==(ee?ee.id:null)&&(this._setupStencil($,ae,q,ee),X=ee?ee.id:null),d.renderLayer(d,ee,q,re)}this.renderedToTile?($.dirty=!0,R.push(B.tileID)):Z||--D,D===5&&(D=0,this.renderToBackBuffer(R))}return this.renderToBackBuffer(R),this.renderingToTexture=!1,g.bindFramebuffer.set(null),g.viewport.set([0,0,d.width,d.height]),S.end+1}postRender(){}isLayerOrderingCorrect(a){const d=a.order.length;let g=-1,x=d;for(let w=0;w<d;++w)this._style.isLayerDraped(a._mergedLayers[a.order[w]])?g=Math.max(g,w):x=Math.min(x,w);return x>g}getMinElevationBelowMSL(){let a=0;return this._visibleDemTiles.filter(d=>d.dem).forEach(d=>{a=Math.min(a,d.dem.tree.minimums[0])}),a===0?a:(a-30)*this._exaggeration}raycast(a,d,g){if(!this._visibleDemTiles)return null;const x=this._visibleDemTiles.filter(w=>w.dem).map(w=>{const S=w.tileID,C=1<<S.overscaledZ,{x:R,y:D}=S.canonical,N=R/C,B=(R+1)/C,j=D/C,$=(D+1)/C;return{minx:N,miny:j,maxx:B,maxy:$,t:w.dem.tree.raycastRoot(N,j,B,$,a,d,g),tile:w}});x.sort((w,S)=>(w.t!==null?w.t:Number.MAX_VALUE)-(S.t!==null?S.t:Number.MAX_VALUE));for(const w of x){if(w.t==null)return null;const S=w.tile.dem.tree.raycast(w.minx,w.miny,w.maxx,w.maxy,a,d,g);if(S!=null)return S}return null}_createFBO(){const a=this.painter.context,d=a.gl,g=this.drapeBufferSize;a.activeTexture.set(d.TEXTURE0);const x=new l.T(a,{width:g[0],height:g[1],data:null},d.RGBA);x.bind(d.LINEAR,d.CLAMP_TO_EDGE);const w=a.createFramebuffer(g[0],g[1],!0,null);return w.colorAttachment.set(x.texture),w.depthAttachment=new js(a,w.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=a.createRenderbuffer(a.gl.DEPTH_STENCIL,g[0],g[1]),this._stencilRef=0,w.depthAttachment.set(this._sharedDepthStencil),a.clear({stencil:0})):w.depthAttachment.set(this._sharedDepthStencil),a.extTextureFilterAnisotropic&&d.texParameterf(d.TEXTURE_2D,a.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,a.extTextureFilterAnisotropicMax),{fb:w,tex:x,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const a in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[a].hasTransition())return!0;return this._style.order.some(a=>{const d=this._style._mergedLayers[a],g=d.isHidden(this.painter.transform.zoom);return d.type==="custom"?!g&&d.shouldRedrape():!g&&d.hasTransition()})}_clearLineLayersFromRenderCache(){let a=!1;for(const g of this._style.getSources())if(g instanceof Dt){a=!0;break}if(!a)return;const d={};for(let g=0;g<this._style.order.length;++g){const x=this._style._mergedLayers[this._style.order[g]],w=this._style.getLayerSourceCache(x);if(w&&!d[w.id]&&!x.isHidden(this.painter.transform.zoom)&&x.type==="line"&&x.widthExpression()instanceof l.Z){d[w.id]=!0;for(const S of this.proxyCoords){const C=this.proxyToSource[S.key][w.id];if(C)for(const R of C)this._clearRenderCacheForTile(w.id,R)}}}}_clearRasterLayersFromRenderCache(){let a=!1;for(const g in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[g]._source instanceof kt){a=!0;break}if(!a)return;const d={};for(let g=0;g<this._style.order.length;++g){const x=this._style._mergedLayers[this._style.order[g]],w=this._style.getLayerSourceCache(x);if(!w||d[w.id]||x.isHidden(this.painter.transform.zoom)||x.type!=="raster")continue;const S=x.paint.get("raster-fade-duration");for(const C of this.proxyCoords){const R=this.proxyToSource[C.key][w.id];if(R)for(const D of R){const N=mp(w.getTile(D),w.findLoadedParent(D,0),w,this.painter.transform,S);(N.opacity!==1||N.mix!==0)&&this._clearRenderCacheForTile(w.id,D)}}}}_setupDrapedRenderBatches(){const a=this._style.order,d=a.length;if(d===0)return;const g=[];this._pendingGroundEffectLayers=[];let x,w=0,S=this._style._mergedLayers[a[w]];for(;!this._style.isLayerDraped(S)&&S.isHidden(this.painter.transform.zoom)&&++w<d;)S=this._style._mergedLayers[a[w]];for(;w<d;++w){const C=this._style._mergedLayers[a[w]];C.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(C)?x===void 0&&(x=w):(C.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(w),x!==void 0&&(g.push({start:x,end:w-1}),x=void 0)))}if(x!==void 0&&g.push({start:x,end:w-1}),g.length!==0){const C=g[g.length-1];this._pendingGroundEffectLayers.every(R=>R>C.end)||l.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=g}_setupRenderCache(a){const d=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,d.renderCache.length>d.renderCachePool.length){const S=Object.values(d.proxyCachedFBO);d.proxyCachedFBO={};for(let C=0;C<S.length;++C){const R=Object.values(S[C]);d.renderCachePool.push(...R)}}return}this._clearRasterLayersFromRenderCache();const g=this.proxyCoords,x=this._tilesDirty;for(let S=g.length-1;S>=0;S--){const C=g[S];if(d.getTileByID(C.key),d.proxyCachedFBO[C.key]!==void 0){const R=a[C.key],D=this.proxyToSource[C.key];let N=0;for(const B in D){const j=D[B],$=R[B];if(!$||$.length!==j.length||j.some((Z,X)=>Z!==$[X]||x[B]&&x[B].hasOwnProperty(Z.key))){N=-1;break}++N}for(const B in d.proxyCachedFBO[C.key])d.renderCache[d.proxyCachedFBO[C.key][B]].dirty=N<0||N!==Object.values(R).length}}const w=[...this._drapedRenderBatches];w.sort((S,C)=>C.end-C.start-(S.end-S.start));for(const S of w)for(const C of g){if(d.proxyCachedFBO[C.key])continue;let R=d.renderCachePool.pop();R===void 0&&d.renderCache.length<50&&(R=d.renderCache.length,d.renderCache.push(this._createFBO())),R!==void 0&&(d.proxyCachedFBO[C.key]={},d.proxyCachedFBO[C.key][S.start]=R,d.renderCache[R].dirty=!0)}this._tilesDirty={}}_setupStencil(a,d,g,x){if(!x||!this._sourceTilesOverlap[x.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const w=this.painter.context,S=w.gl;if(d.length<=1)return void(this._overlapStencilType=!1);let C;if(g.isTileClipped())C=d.length,this._overlapStencilMode.test={func:S.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(d[0].overscaledZ>d[d.length-1].overscaledZ))return void(this._overlapStencilType=!1);C=1,this._overlapStencilMode.test={func:S.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+C>255&&(w.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=C,this._overlapStencilMode.ref=this._stencilRef,g.isTileClipped()&&this._renderTileClippingMasks(d,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(a){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[a.key]),this._overlapStencilMode):vi.disabled}_renderTileClippingMasks(a,d){const g=this.painter,x=this.painter.context,w=x.gl;g._tileClippingMaskIDs={},x.setColorMode(Fi.disabled),x.setDepthMode(li.disabled);const S=g.getOrCreateProgram("clippingMask");for(const C of a){const R=g._tileClippingMaskIDs[C.key]=--d;S.draw(g,w.TRIANGLES,li.disabled,new vi({func:w.ALWAYS,mask:0},R,255,w.KEEP,w.KEEP,w.REPLACE),Fi.disabled,ci.disabled,pp(C.projMatrix),"$clipping",g.tileExtentBuffer,g.quadTriangleIndexBuffer,g.tileExtentSegments)}}pointCoordinate(a){const d=this.painter.transform;if(a.x<0||a.x>d.width||a.y<0||a.y>d.height)return null;const g=[a.x,a.y,1,1];l.a7.transformMat4(g,g,d.pixelMatrixInverse),l.a7.scale(g,g,1/g[3]),g[0]/=d.worldSize,g[1]/=d.worldSize;const x=d._camera.position,w=l.bl(1,d.center.lat),S=[x[0],x[1],x[2]/w,0],C=l.N.subtract([],g.slice(0,3),S);l.N.normalize(C,C);const R=this.raycast(S,C,this._exaggeration);return R!==null&&R?(l.N.scaleAndAdd(S,S,C,R),S[3]=S[2],S[2]*=w,S):null}drawDepth(){const a=this.painter,d=a.context,g=this.proxySourceCache,x=Math.ceil(a.width),w=Math.ceil(a.height);if(!this._depthFBO||this._depthFBO.width===x&&this._depthFBO.height===w||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const S=d.gl,C=d.createFramebuffer(x,w,!0,"renderbuffer");d.activeTexture.set(S.TEXTURE0);const R=new l.T(d,{width:x,height:w,data:null},S.RGBA);R.bind(S.NEAREST,S.CLAMP_TO_EDGE),C.colorAttachment.set(R.texture);const D=d.createRenderbuffer(d.gl.DEPTH_COMPONENT16,x,w);C.depthAttachment.set(D),this._depthFBO=C,this._depthTexture=R}d.bindFramebuffer.set(this._depthFBO.framebuffer),d.viewport.set([0,0,x,w]),function(S,C,R,D){if(S.transform.projection.name==="globe")return;const N=S.context,B=N.gl;N.clear({depth:1});const j=S.getOrCreateProgram("terrainDepth"),$=new li(B.LESS,li.ReadWrite,S.depthRangeFor3D);for(const Z of D){const X=R.getTile(Z),K=Xh(Z.projMatrix,0,[0,0,0]);C.setupElevationDraw(X,j),j.draw(S,B.TRIANGLES,$,vi.disabled,Fi.unblended,ci.backCCW,K,"terrain_depth",C.gridBuffer,C.gridIndexBuffer,C.gridNoSkirtSegments)}}(a,this,g,this.proxyCoords)}_setupProxiedCoordsForOrtho(a,d,g){if(a.getSource()instanceof l.ap)return this._setupProxiedCoordsForImageSource(a,d,g);this._findCoveringTileCache[a.id]=this._findCoveringTileCache[a.id]||{};const x=this.proxiedCoords[a.id]=[],w=this.proxyCoords;for(let R=0;R<w.length;R++){const D=w[R],N=this._findTileCoveringTileID(D,a);if(N){const B=this._createProxiedId(D,N,g[D.key]&&g[D.key][a.id]);x.push(B),this.proxyToSource[D.key][a.id]=[B]}}let S=!1;const C=new Set;for(let R=0;R<d.length;R++){const D=a.getTile(d[R]);if(!D||!D.hasData())continue;const N=this._findTileCoveringTileID(D.tileID,this.proxySourceCache);if(N&&N.tileID.canonical.z!==D.tileID.canonical.z){const B=this.proxyToSource[N.tileID.key][a.id],j=this._createProxiedId(N.tileID,D,g[N.tileID.key]&&g[N.tileID.key][a.id]);B?B.splice(B.length-1,0,j):this.proxyToSource[N.tileID.key][a.id]=[j];const $=this.proxyToSource[N.tileID.key][a.id];C.has($)||C.add($),x.push(j),S=!0}}if(this._sourceTilesOverlap[a.id]=S,S&&this._debugParams.sortTilesHiZFirst)for(const R of C)R.sort((D,N)=>N.overscaledZ-D.overscaledZ)}_setupProxiedCoordsForImageSource(a,d,g){if(!a.getSource().loaded())return;const x=this.proxiedCoords[a.id]=[],w=this.proxyCoords,S=a.getSource(),C=S.tileID;if(!C)return;const R=new l.P(C.x,C.y)._div(1<<C.z),D=S.coordinates.map(l.L.fromLngLat).reduce((B,j)=>(B.min.x=Math.min(B.min.x,j.x-R.x),B.min.y=Math.min(B.min.y,j.y-R.y),B.max.x=Math.max(B.max.x,j.x-R.x),B.max.y=Math.max(B.max.y,j.y-R.y),B),{min:new l.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new l.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),N=(B,j)=>{const $=B.wrap+B.canonical.x/(1<<B.canonical.z),Z=B.canonical.y/(1<<B.canonical.z),X=l.V/(1<<B.canonical.z),K=j.wrap+j.canonical.x/(1<<j.canonical.z),q=j.canonical.y/(1<<j.canonical.z);return $+X<K+D.min.x||$>K+D.max.x||Z+X<q+D.min.y||Z>q+D.max.y};for(let B=0;B<w.length;B++){const j=w[B];for(let $=0;$<d.length;$++){const Z=a.getTile(d[$]);if(!Z||!Z.hasData()||N(j,Z.tileID))continue;const X=this._createProxiedId(j,Z,g[j.key]&&g[j.key][a.id]),K=this.proxyToSource[j.key][a.id];K?K.push(X):this.proxyToSource[j.key][a.id]=[X],x.push(X)}}}_createProxiedId(a,d,g){let x=this.orthoMatrix;if(g){const w=g.find(S=>S.key===d.tileID.key);if(w)return w}if(d.tileID.key!==a.key){const w=a.canonical.z-d.tileID.canonical.z;let S,C,R;x=l.a6.create();const D=d.tileID.wrap-a.wrap<<a.overscaledZ;w>0?(S=l.V>>w,C=S*((d.tileID.canonical.x<<w)-a.canonical.x+D),R=S*((d.tileID.canonical.y<<w)-a.canonical.y)):(S=l.V<<-w,C=l.V*(d.tileID.canonical.x-(a.canonical.x+D<<-w)),R=l.V*(d.tileID.canonical.y-(a.canonical.y<<-w))),l.a6.ortho(x,0,S,0,S,0,1),l.a6.translate(x,x,[C,R,0])}return new ag(d.tileID,a.key,x)}_findTileCoveringTileID(a,d){let g=d.getTile(a);if(g&&g.hasData())return g;const x=this._findCoveringTileCache[d.id],w=x[a.key];if(g=w?d.getTileByID(w):null,g&&g.hasData()||w===null)return g;let S=g?g.tileID:a,C=S.overscaledZ;const R=d.getSource().minzoom,D=[];if(!w){const B=d.getSource().maxzoom;if(a.canonical.z>=B){const j=a.canonical.z-B;d.getSource().reparseOverscaled?(C=Math.max(a.canonical.z+2,d.transform.tileZoom),S=new l.am(C,a.wrap,B,a.canonical.x>>j,a.canonical.y>>j)):j!==0&&(C=B,S=new l.am(C,a.wrap,B,a.canonical.x>>j,a.canonical.y>>j))}S.key!==a.key&&(D.push(S.key),g=d.getTile(S))}const N=B=>{D.forEach(j=>{x[j]=B}),D.length=0};for(C-=1;C>=R&&(!g||!g.hasData());C--){g&&N(g.tileID.key);const B=S.calculateScaledKey(C);if(g=d.getTileByID(B),g&&g.hasData())break;const j=x[B];if(j===null)break;j===void 0?D.push(B):g=d.getTileByID(j)}return N(g?g.tileID.key:null),g&&g.hasData()?g:null}findDEMTileFor(a){return this.enabled?this._findTileCoveringTileID(a,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(a,d){let g=this._tilesDirty[a];g||(g=this._tilesDirty[a]={}),g[d.key]=!0}}function _p(_,a,d){const g=function(C,R,D){const N=l.N.dot(R,C),B=l.N.dot(D,[.2126,.7152,.0722]),j=(Z,X,K)=>(1-K)*Z+K*X,$=j(1-.3*Math.min(B,1),1,Math.min(N+1,1));return j(.92,1,Math.asin(l.aa(R[2],-1,1))/Math.PI+.5)*$}(_,[0,0,1],a),x=[0,0,0];l.N.scale(x,d.slice(0,3),g);const w=[0,0,0];l.N.scale(w,a.slice(0,3),_[2]);const S=[0,0,0];return l.N.add(S,x,w),l.bU(S)}const gp=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],lg=["stars","fillExtrusion","fillExtrusionGroundEffect","model","symbolSDF","symbolIcon","symbolTextAndIcon"];class yp{static cacheKey(a,d,g,x){let w=`${d}${x?x.cacheKey:""}`;for(const S of g)a.usedDefines.includes(S)&&(w+=`/${S}`);return w}constructor(a,d,g,x,w,S,C){const R=a.gl;this.program=R.createProgram(),this.configuration=x,this.name=d,this.fixedDefines=[...S];const D=x?x.getBinderAttributes():[],N=(g.staticAttributes||[]).concat(D);let B=x?x.defines():[];B=B.concat(S.map(q=>`#define ${q}`));const j=`#version 300 es
`;let $=j+B.concat("precision mediump float;",qh,lp.fragmentSource).join(`
`);for(const q of g.fragmentIncludes)$+=`
${to[q]}`;$+=`
${g.fragmentSource}`;let Z=j+B.concat("precision highp float;",qh,lp.vertexSource).join(`
`);for(const q of g.vertexIncludes)Z+=`
${to[q]}`;Z+=`
${g.vertexSource}`;const X=R.createShader(R.FRAGMENT_SHADER);if(R.isContextLost())return void(this.failedToCreate=!0);R.shaderSource(X,$),R.compileShader(X),R.attachShader(this.program,X);const K=R.createShader(R.VERTEX_SHADER);if(R.isContextLost())this.failedToCreate=!0;else{R.shaderSource(K,Z),R.compileShader(K),R.attachShader(this.program,K),this.attributes={},this.numAttributes=N.length;for(let q=0;q<this.numAttributes;q++)if(N[q]){const ee=N[q].startsWith("a_")?N[q]:`a_${N[q]}`;R.bindAttribLocation(this.program,q,ee),this.attributes[ee]=q}C&&C.shaderVaryings.length>0&&R.transformFeedbackVaryings(this.program,C.shaderVaryings,C.bufferMode),R.linkProgram(this.program),R.deleteShader(K),R.deleteShader(X),this.fixedUniforms=w(a),this.binderUniforms=x?x.getUniforms(a):[],S.includes("TERRAIN")&&(this.terrainUniforms=(q=>({u_dem:new l.bO(q),u_dem_prev:new l.bO(q),u_dem_tl:new l.bL(q),u_dem_scale:new l.bN(q),u_dem_tl_prev:new l.bL(q),u_dem_scale_prev:new l.bN(q),u_dem_size:new l.bN(q),u_dem_lerp:new l.bN(q),u_exaggeration:new l.bN(q),u_depth:new l.bO(q),u_depth_size_inv:new l.bL(q),u_meter_to_dem:new l.bN(q),u_label_plane_matrix_inv:new l.bK(q)}))(a)),S.includes("GLOBE")&&(this.globeUniforms=(q=>({u_tile_tl_up:new l.bM(q),u_tile_tr_up:new l.bM(q),u_tile_br_up:new l.bM(q),u_tile_bl_up:new l.bM(q),u_tile_up_scale:new l.bN(q)}))(a)),S.includes("FOG")&&(this.fogUniforms=(q=>({u_fog_matrix:new l.bK(q),u_fog_range:new l.bL(q),u_fog_color:new l.bP(q),u_fog_horizon_blend:new l.bN(q),u_fog_vertical_limit:new l.bL(q),u_fog_temporal_offset:new l.bN(q),u_frustum_tl:new l.bM(q),u_frustum_tr:new l.bM(q),u_frustum_br:new l.bM(q),u_frustum_bl:new l.bM(q),u_globe_pos:new l.bM(q),u_globe_radius:new l.bN(q),u_globe_transition:new l.bN(q),u_is_globe:new l.bO(q),u_viewport:new l.bL(q)}))(a)),S.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(q=>({u_cutoff_params:new l.bP(q)}))(a)),S.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(q=>({u_lighting_ambient_color:new l.bM(q),u_lighting_directional_dir:new l.bM(q),u_lighting_directional_color:new l.bM(q),u_ground_radiance:new l.bM(q)}))(a)),S.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(q=>({u_light_matrix_0:new l.bK(q),u_light_matrix_1:new l.bK(q),u_fade_range:new l.bL(q),u_shadow_normal_offset:new l.bM(q),u_shadow_intensity:new l.bN(q),u_shadow_texel_size:new l.bN(q),u_shadow_map_resolution:new l.bN(q),u_shadow_direction:new l.bM(q),u_shadow_bias:new l.bM(q),u_shadowmap_0:new l.bO(q),u_shadowmap_1:new l.bO(q)}))(a))}}setTerrainUniformValues(a,d){if(!this.terrainUniforms)return;const g=this.terrainUniforms;if(!this.failedToCreate){a.program.set(this.program);for(const x in d)g[x]&&g[x].set(this.program,x,d[x])}}setGlobeUniformValues(a,d){if(!this.globeUniforms)return;const g=this.globeUniforms;if(!this.failedToCreate){a.program.set(this.program);for(const x in d)g[x]&&g[x].set(this.program,x,d[x])}}setFogUniformValues(a,d){if(!this.fogUniforms)return;const g=this.fogUniforms;if(!this.failedToCreate){a.program.set(this.program);for(const x in d)g[x].set(this.program,x,d[x])}}setCutoffUniformValues(a,d){if(!this.cutoffUniforms)return;const g=this.cutoffUniforms;if(!this.failedToCreate){a.program.set(this.program);for(const x in d)g[x].set(this.program,x,d[x])}}setLightsUniformValues(a,d){if(!this.lightsUniforms)return;const g=this.lightsUniforms;if(!this.failedToCreate){a.program.set(this.program);for(const x in d)g[x].set(this.program,x,d[x])}}setShadowUniformValues(a,d){if(this.failedToCreate||!this.shadowUniforms)return;const g=this.shadowUniforms;a.program.set(this.program);for(const x in d)g[x].set(this.program,x,d[x])}_drawDebugWireframe(a,d,g,x,w,S,C,R,D,N){const B=a.options.wireframe;if(B.terrain===!1&&B.layers2D===!1&&B.layers3D===!1)return;const j=a.context;if(!(!(!B.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!B.layers2D||a._terrain&&a._terrain.renderingToTexture||!gp.includes(this.name))||!(!B.layers3D||!lg.includes(this.name))))return;const $=j.gl,Z=a.wireframeDebugCache.getLinesFromTrianglesBuffer(a.frameCounter,w,j);if(!Z)return;const X=[...this.fixedDefines];X.push("DEBUG_WIREFRAME");const K=a.getOrCreateProgram(this.name,{config:this.configuration,defines:X});j.program.set(K.program);const q=(re,le,Q)=>{if(le[re]&&Q[re])for(const ce in le[re])Q[re][ce]&&Q[re][ce].set(Q.program,ce,le[re][ce].current)};D&&D.setUniforms(K.program,j,K.binderUniforms,C,{zoom:R}),q("fixedUniforms",this,K),q("terrainUniforms",this,K),q("globeUniforms",this,K),q("fogUniforms",this,K),q("lightsUniforms",this,K),q("shadowUniforms",this,K),Z.bind(),j.setColorMode(new Fi([$.ONE,$.ONE_MINUS_SRC_ALPHA,$.ZERO,$.ONE],l.ax.transparent,[!0,!0,!0,!1])),j.setDepthMode(new li(d.func===$.LESS?$.LEQUAL:d.func,li.ReadOnly,d.range)),j.setStencilMode(vi.disabled);const ee=3*S.primitiveLength*2,ae=3*S.primitiveOffset*2*2;N&&N>1?$.drawElementsInstanced($.LINES,ee,$.UNSIGNED_SHORT,ae,N):$.drawElements($.LINES,ee,$.UNSIGNED_SHORT,ae),w.bind(),j.program.set(this.program),j.setDepthMode(d),j.setStencilMode(g),j.setColorMode(x)}draw(a,d,g,x,w,S,C,R,D,N,B,j,$,Z,X,K,q){const ee=a.context,ae=ee.gl;if(this.failedToCreate)return;ee.program.set(this.program),ee.setDepthMode(g),ee.setStencilMode(x),ee.setColorMode(w),ee.setCullFace(S);for(const ce of Object.keys(this.fixedUniforms))this.fixedUniforms[ce].set(this.program,ce,C[ce]);Z&&Z.setUniforms(this.program,ee,this.binderUniforms,j,{zoom:$});const re={[ae.POINTS]:1,[ae.LINES]:2,[ae.TRIANGLES]:3,[ae.LINE_STRIP]:1}[d],le=q&&q.length>0;if(le){for(const ce of q)ae.bindBufferBase(ae.TRANSFORM_FEEDBACK_BUFFER,ce.targetIndex,ce.buffer.buffer);ae.beginTransformFeedback(d)}const Q=K&&K>0?1:void 0;for(const ce of B.get()){const ve=ce.vaos||(ce.vaos={});(ve[R]||(ve[R]=new up)).bind(ee,this,D,Z?Z.getPaintVertexBuffers():[],N,ce.vertexOffset,X||[],Q),K&&K>1?ae.drawElementsInstanced(d,ce.primitiveLength*re,ae.UNSIGNED_SHORT,ce.primitiveOffset*re*2,K):N?ae.drawElements(d,ce.primitiveLength*re,ae.UNSIGNED_SHORT,ce.primitiveOffset*re*2):ae.drawArrays(d,ce.vertexOffset,ce.vertexLength),d===ae.TRIANGLES&&N&&this._drawDebugWireframe(a,g,x,w,N,ce,j,$,Z,K)}le&&ae.endTransformFeedback()}}function vp(_,a){const d=Math.pow(2,a.tileID.overscaledZ),g=a.tileSize*Math.pow(2,_.transform.tileZoom)/d,x=g*(a.tileID.canonical.x+a.tileID.wrap*d),w=g*a.tileID.canonical.y;return{u_image:0,u_texsize:a.imageAtlasTexture?a.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/l.a3(a,1,_.transform.tileZoom),u_pixel_coord_upper:[x>>16,w>>16],u_pixel_coord_lower:[65535&x,65535&w]}}const cg=l.a6.create(),xp=(_,a,d,g,x,w,S,C,R,D,N,B,j,$,Z,X)=>{const K=a.style.light,q=K.properties.get("position"),ee=[q.x,q.y,q.z],ae=l.co.create();K.properties.get("anchor")==="viewport"&&(l.co.fromRotation(ae,-a.transform.angle),l.N.transformMat3(ee,ee,ae));const re=K.properties.get("color"),le=a.transform,Q={u_matrix:_,u_lightpos:ee,u_lightintensity:K.properties.get("intensity"),u_lightcolor:[re.r,re.g,re.b],u_vertical_gradient:+d,u_opacity:g,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:cg,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:x,u_edge_radius:w,u_flood_light_color:B,u_vertical_scale:j,u_flood_light_intensity:$,u_ground_shadow_factor:Z,u_emissive_strength:X};return le.projection.name==="globe"&&(Q.u_tile_id=[S.canonical.x,S.canonical.y,1<<S.canonical.z],Q.u_zoom_transition=R,Q.u_inv_rot_matrix=N,Q.u_merc_center=D,Q.u_up_dir=le.projection.upVector(new l.bs(0,0,0),D[0]*l.V,D[1]*l.V),Q.u_height_lift=C),Q},bp=(_,a,d)=>({u_matrix:_,u_edge_radius:a,u_vertical_scale:d}),ml=(_,a,d,g,x,w,S,C,R,D,N,B,j,$)=>{const Z=xp(_,a,d,g,x,w,S,R,D,N,B,j,$,1,[0,0,0],0),X={u_height_factor:-Math.pow(2,S.overscaledZ)/C.tileSize/8};return l.e(Z,vp(a,C),X)},tc=(_,a)=>({u_matrix:_,u_emissive_strength:a}),wp=(_,a,d,g)=>l.e(tc(_,a),vp(d,g)),_l=(_,a,d)=>({u_matrix:_,u_world:d,u_emissive_strength:a}),ug=(_,a,d,g,x)=>l.e(wp(_,a,d,g),{u_world:x}),Zh=(_,a,d,g)=>{const x=l.V/d.tileSize;return{u_matrix:_,u_camera_to_center_distance:a.getCameraToCenterDistance(g),u_extrude_scale:[a.pixelsToGLUnits[0]/x,a.pixelsToGLUnits[1]/x]}},Tp=(_,a,d=1)=>({u_matrix:_,u_color:a,u_overlay:0,u_overlay_scale:d}),hg=l.a6.create(),Ep=(_,a,d,g,x,w,S)=>{const C=_.transform,R=C.projection.name==="globe",D=R?l.cp(C.zoom,a.canonical)*C._pixelsPerMercatorPixel:l.a3(d,1,w),N={u_matrix:a.projMatrix,u_extrude_scale:D,u_intensity:S,u_inv_rot_matrix:hg,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(R){N.u_inv_rot_matrix=g,N.u_merc_center=x,N.u_tile_id=[a.canonical.x,a.canonical.y,1<<a.canonical.z],N.u_zoom_transition=l.S(C.zoom);const B=x[0]*l.V,j=x[1]*l.V;N.u_up_dir=C.projection.upVector(new l.bs(0,0,0),B,j)}return N};function Yh(_,[a,d,g,x],[w,S]){if(w===S)return[0,0,0,0];const C=255*(_-1)/(_*(S-w));return[a*C,d*C,g*C,x*C]}function dg(_,a,[d,g]){return d===g?0:.5/_+(a-d)*(_-1)/(_*(g-d))}const Sp=(_,a,d,g,x,w,S,C,R,D,N,B,j,$,Z,X,K,q,ee,ae,re)=>{return{u_matrix:_,u_normalize_matrix:a,u_globe_matrix:d,u_merc_matrix:g,u_grid_matrix:x,u_tl_parent:w,u_scale_parent:D,u_fade_t:N.mix,u_opacity:N.opacity*B.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:B.paint.get("raster-brightness-min"),u_brightness_high:B.paint.get("raster-brightness-max"),u_saturation_factor:(Q=B.paint.get("raster-saturation"),Q>0?1-1/(1.001-Q):-Q),u_contrast_factor:(le=B.paint.get("raster-contrast"),le>0?1/(1-le):1+le),u_spin_weights:hu(B.paint.get("raster-hue-rotate")),u_perspective_transform:j,u_raster_elevation:$,u_zoom_transition:S,u_merc_center:C,u_cutoff_params:R,u_colorization_mix:Yh(l.cq,X,q),u_colorization_offset:dg(l.cq,K,q),u_color_ramp:Z,u_texture_offset:[ae/(ee+2*ae),ee/(ee+2*ae)],u_texture_res:[ee+2*ae,ee+2*ae],u_emissive_strength:re};var le,Q};function hu(_){_*=Math.PI/180;const a=Math.sin(_),d=Math.cos(_);return[(2*d+1)/3,(-Math.sqrt(3)*a-d+1)/3,(Math.sqrt(3)*a-d+1)/3]}const N1=(_,a,d,g,x,w,S,C,R,D,N,B)=>({u_matrix:_,u_normalize_matrix:a,u_globe_matrix:d,u_merc_matrix:g,u_grid_matrix:x,u_tl_parent:w,u_scale_parent:D,u_fade_t:N.mix,u_opacity:N.opacity,u_image0:0,u_image1:1,u_raster_elevation:B,u_zoom_transition:S,u_merc_center:C,u_cutoff_params:R}),F1=(_,a,d,g,x,w,S,C)=>({u_tile_offset:_,u_velocity:a,u_color_ramp:g,u_velocity_res:d,u_max_speed:x,u_texture_offset:w,u_data_scale:S,u_data_offset:C}),fg=(_,a,d,g,x,w,S,C)=>({u_velocity:_,u_velocity_res:a,u_max_speed:d,u_speed_factor:g,u_lifetime_delta:x,u_rand_seed:Math.random(),u_texture_offset:w,u_data_scale:S,u_data_offset:C}),pg=l.a6.create(),Kh=(_,a,d,g,x,w,S,C,R,D,N,B,j,$,Z,X,K,q)=>{const ee=x.transform,ae={u_is_size_zoom_constant:+(_==="constant"||_==="source"),u_is_size_feature_constant:+(_==="constant"||_==="camera"),u_size_t:a?a.uSizeT:0,u_size:a?a.uSize:0,u_camera_to_center_distance:ee.getCameraToCenterDistance(X),u_rotate_symbol:+d,u_aspect_ratio:ee.width/ee.height,u_fade_change:x.options.fadeDuration?x.symbolFadeChange:1,u_matrix:w,u_label_plane_matrix:S,u_coord_matrix:C,u_is_text:+R,u_pitch_with_map:+g,u_texsize:D,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:pg,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:pg,u_up_vector:[0,-1,0],u_icon_transition:q||0,u_icon_saturation:K};return X.name==="globe"&&(ae.u_tile_id=[N.canonical.x,N.canonical.y,1<<N.canonical.z],ae.u_zoom_transition=B,ae.u_inv_rot_matrix=$,ae.u_merc_center=j,ae.u_camera_forward=ee._camera.forward(),ae.u_ecef_origin=l.cr(ee.globeMatrix,N.toUnwrapped()),ae.u_tile_matrix=Float32Array.from(ee.globeMatrix),ae.u_up_vector=Z),ae},du=(_,a,d,g,x,w,S,C,R,D,N,B,j,$,Z,X,K)=>l.e(Kh(_,a,d,g,x,w,S,C,R,D,B,j,$,Z,X,K,1),{u_gamma_scale:g?x.transform.getCameraToCenterDistance(K)*Math.cos(x.terrain?0:x.transform._pitch):1,u_device_pixel_ratio:l.f.devicePixelRatio,u_is_halo:+N,undefined:void 0}),Jh=(_,a,d,g,x,w,S,C,R,D,N,B,j,$,Z,X)=>l.e(du(_,a,d,g,x,w,S,C,!0,R,!0,N,B,j,$,Z,X),{u_texsize_icon:D,u_texture_icon:1}),Ap=(_,a,d,g)=>({u_matrix:_,u_emissive_strength:a,u_opacity:d,u_color:g}),fu=(_,a,d,g,x,w,S)=>l.e(function(C,R,D,N){const B=D.imageManager.getPattern(C.toString(),R),{width:j,height:$}=D.imageManager.getPixelSize(R),Z=Math.pow(2,N.tileID.overscaledZ),X=N.tileSize*Math.pow(2,D.transform.tileZoom)/Z,K=X*(N.tileID.canonical.x+N.tileID.wrap*Z),q=X*N.tileID.canonical.y;return{u_image:0,u_pattern_tl:B.tl,u_pattern_br:B.br,u_texsize:[j,$],u_pattern_size:B.displaySize,u_tile_units_to_pixels:1/l.a3(N,1,D.transform.tileZoom),u_pixel_coord_upper:[K>>16,q>>16],u_pixel_coord_lower:[65535&K,65535&q]}}(x,w,g,S),{u_matrix:_,u_emissive_strength:a,u_opacity:d}),Qh=(_,a,d,g,x,w,S,C,R,D,N,B,j=[0,0,0],$)=>{const Z=g.style.light,X=Z.properties.get("position"),K=[-X.x,-X.y,X.z],q=l.co.create();Z.properties.get("anchor")==="viewport"&&(l.co.fromRotation(q,-g.transform.angle),l.N.transformMat3(K,K,q));const ee=D.alphaMode==="MASK",ae=Z.properties.get("color"),re=B.paint.get("model-ambient-occlusion-intensity"),le=B.paint.get("model-color").constantOr(l.ax.white),Q=B.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:_,u_lighting_matrix:a,u_normal_matrix:d,u_lightpos:K,u_lightintensity:Z.properties.get("intensity"),u_lightcolor:[ae.r,ae.g,ae.b],u_camera_pos:j,u_opacity:x,u_baseTextureIsAlpha:0,u_alphaMask:+ee,u_alphaCutoff:D.alphaCutoff,u_baseColorFactor:[w.r,w.g,w.b,w.a],u_emissiveFactor:[S[0],S[1],S[2],1],u_metallicFactor:C,u_roughnessFactor:R,u_baseColorTexture:ys.BaseColor,u_metallicRoughnessTexture:ys.MetallicRoughness,u_normalTexture:ys.Normal,u_occlusionTexture:ys.Occlusion,u_emissionTexture:ys.Emission,u_color_mix:[le.r,le.g,le.b,Q],u_aoIntensity:re,u_emissive_strength:N,u_occlusionTextureTransform:$||[0,0,0,0]}},pu=new Float32Array(16),mu=(_,a=pu,d=pu)=>({u_matrix:_,u_instance:a,u_node_matrix:d}),B1={fillExtrusion:_=>({u_matrix:new l.bK(_),u_lightpos:new l.bM(_),u_lightintensity:new l.bN(_),u_lightcolor:new l.bM(_),u_vertical_gradient:new l.bN(_),u_opacity:new l.bN(_),u_edge_radius:new l.bN(_),u_ao:new l.bL(_),u_tile_id:new l.bM(_),u_zoom_transition:new l.bN(_),u_inv_rot_matrix:new l.bK(_),u_merc_center:new l.bL(_),u_up_dir:new l.bM(_),u_height_lift:new l.bN(_),u_flood_light_color:new l.bM(_),u_vertical_scale:new l.bN(_),u_flood_light_intensity:new l.bN(_),u_ground_shadow_factor:new l.bM(_),u_emissive_strength:new l.bN(_)}),fillExtrusionDepth:_=>({u_matrix:new l.bK(_),u_edge_radius:new l.bN(_),u_vertical_scale:new l.bN(_)}),fillExtrusionPattern:_=>({u_matrix:new l.bK(_),u_lightpos:new l.bM(_),u_lightintensity:new l.bN(_),u_lightcolor:new l.bM(_),u_vertical_gradient:new l.bN(_),u_height_factor:new l.bN(_),u_edge_radius:new l.bN(_),u_ao:new l.bL(_),u_tile_id:new l.bM(_),u_zoom_transition:new l.bN(_),u_inv_rot_matrix:new l.bK(_),u_merc_center:new l.bL(_),u_up_dir:new l.bM(_),u_height_lift:new l.bN(_),u_image:new l.bO(_),u_texsize:new l.bL(_),u_pixel_coord_upper:new l.bL(_),u_pixel_coord_lower:new l.bL(_),u_tile_units_to_pixels:new l.bN(_),u_opacity:new l.bN(_)}),fillExtrusionGroundEffect:_=>({u_matrix:new l.bK(_),u_opacity:new l.bN(_),u_ao_pass:new l.bN(_),u_meter_to_tile:new l.bN(_),u_ao:new l.bL(_),u_flood_light_intensity:new l.bN(_),u_flood_light_color:new l.bM(_),u_attenuation:new l.bN(_),u_edge_radius:new l.bN(_),u_fb:new l.bO(_),u_fb_size:new l.bN(_)}),fill:_=>({u_matrix:new l.bK(_),u_emissive_strength:new l.bN(_)}),fillPattern:_=>({u_matrix:new l.bK(_),u_emissive_strength:new l.bN(_),u_image:new l.bO(_),u_texsize:new l.bL(_),u_pixel_coord_upper:new l.bL(_),u_pixel_coord_lower:new l.bL(_),u_tile_units_to_pixels:new l.bN(_)}),fillOutline:_=>({u_matrix:new l.bK(_),u_emissive_strength:new l.bN(_),u_world:new l.bL(_)}),fillOutlinePattern:_=>({u_matrix:new l.bK(_),u_emissive_strength:new l.bN(_),u_world:new l.bL(_),u_image:new l.bO(_),u_texsize:new l.bL(_),u_pixel_coord_upper:new l.bL(_),u_pixel_coord_lower:new l.bL(_),u_tile_units_to_pixels:new l.bN(_)}),circle:l.cs,collisionBox:_=>({u_matrix:new l.bK(_),u_camera_to_center_distance:new l.bN(_),u_extrude_scale:new l.bL(_)}),collisionCircle:_=>({u_matrix:new l.bK(_),u_inv_matrix:new l.bK(_),u_camera_to_center_distance:new l.bN(_),u_viewport_size:new l.bL(_)}),debug:_=>({u_color:new l.ca(_),u_matrix:new l.bK(_),u_overlay:new l.bO(_),u_overlay_scale:new l.bN(_)}),clippingMask:_=>({u_matrix:new l.bK(_)}),heatmap:_=>({u_extrude_scale:new l.bN(_),u_intensity:new l.bN(_),u_matrix:new l.bK(_),u_inv_rot_matrix:new l.bK(_),u_merc_center:new l.bL(_),u_tile_id:new l.bM(_),u_zoom_transition:new l.bN(_),u_up_dir:new l.bM(_)}),heatmapTexture:_=>({u_image:new l.bO(_),u_color_ramp:new l.bO(_),u_opacity:new l.bN(_)}),hillshade:_=>({u_matrix:new l.bK(_),u_image:new l.bO(_),u_latrange:new l.bL(_),u_light:new l.bL(_),u_shadow:new l.ca(_),u_highlight:new l.ca(_),u_emissive_strength:new l.bN(_),u_accent:new l.ca(_)}),hillshadePrepare:_=>({u_matrix:new l.bK(_),u_image:new l.bO(_),u_dimension:new l.bL(_),u_zoom:new l.bN(_)}),line:l.ct,linePattern:l.cu,raster:_=>({u_matrix:new l.bK(_),u_normalize_matrix:new l.bK(_),u_globe_matrix:new l.bK(_),u_merc_matrix:new l.bK(_),u_grid_matrix:new l.cb(_),u_tl_parent:new l.bL(_),u_scale_parent:new l.bN(_),u_fade_t:new l.bN(_),u_opacity:new l.bN(_),u_image0:new l.bO(_),u_image1:new l.bO(_),u_brightness_low:new l.bN(_),u_brightness_high:new l.bN(_),u_saturation_factor:new l.bN(_),u_contrast_factor:new l.bN(_),u_spin_weights:new l.bM(_),u_perspective_transform:new l.bL(_),u_raster_elevation:new l.bN(_),u_zoom_transition:new l.bN(_),u_merc_center:new l.bL(_),u_cutoff_params:new l.bP(_),u_colorization_mix:new l.bP(_),u_colorization_offset:new l.bN(_),u_color_ramp:new l.bO(_),u_texture_offset:new l.bL(_),u_texture_res:new l.bL(_),u_emissive_strength:new l.bN(_)}),rasterParticle:_=>({u_matrix:new l.bK(_),u_normalize_matrix:new l.bK(_),u_globe_matrix:new l.bK(_),u_merc_matrix:new l.bK(_),u_grid_matrix:new l.cb(_),u_tl_parent:new l.bL(_),u_scale_parent:new l.bN(_),u_fade_t:new l.bN(_),u_opacity:new l.bN(_),u_image0:new l.bO(_),u_image1:new l.bO(_),u_raster_elevation:new l.bN(_),u_zoom_transition:new l.bN(_),u_merc_center:new l.bL(_),u_cutoff_params:new l.bP(_)}),rasterParticleTexture:_=>({u_texture:new l.bO(_),u_opacity:new l.bN(_)}),rasterParticleDraw:_=>({u_tile_offset:new l.bL(_),u_velocity:new l.bO(_),u_color_ramp:new l.bO(_),u_velocity_res:new l.bL(_),u_max_speed:new l.bN(_),u_texture_offset:new l.bL(_),u_data_scale:new l.bP(_),u_data_offset:new l.bN(_)}),rasterParticleUpdate:_=>({u_velocity:new l.bO(_),u_velocity_res:new l.bL(_),u_max_speed:new l.bN(_),u_speed_factor:new l.bN(_),u_lifetime_delta:new l.bN(_),u_rand_seed:new l.bN(_),u_texture_offset:new l.bL(_),u_data_scale:new l.bP(_),u_data_offset:new l.bN(_)}),symbolIcon:_=>({u_is_size_zoom_constant:new l.bO(_),u_is_size_feature_constant:new l.bO(_),u_size_t:new l.bN(_),u_size:new l.bN(_),u_camera_to_center_distance:new l.bN(_),u_rotate_symbol:new l.bO(_),u_aspect_ratio:new l.bN(_),u_fade_change:new l.bN(_),u_matrix:new l.bK(_),u_label_plane_matrix:new l.bK(_),u_coord_matrix:new l.bK(_),u_is_text:new l.bO(_),u_pitch_with_map:new l.bO(_),u_texsize:new l.bL(_),u_tile_id:new l.bM(_),u_zoom_transition:new l.bN(_),u_inv_rot_matrix:new l.bK(_),u_merc_center:new l.bL(_),u_camera_forward:new l.bM(_),u_tile_matrix:new l.bK(_),u_up_vector:new l.bM(_),u_ecef_origin:new l.bM(_),u_texture:new l.bO(_),u_icon_transition:new l.bN(_),u_icon_saturation:new l.bN(_)}),symbolSDF:_=>({u_is_size_zoom_constant:new l.bO(_),u_is_size_feature_constant:new l.bO(_),u_size_t:new l.bN(_),u_size:new l.bN(_),u_camera_to_center_distance:new l.bN(_),u_rotate_symbol:new l.bO(_),u_aspect_ratio:new l.bN(_),u_fade_change:new l.bN(_),u_matrix:new l.bK(_),u_label_plane_matrix:new l.bK(_),u_coord_matrix:new l.bK(_),u_is_text:new l.bO(_),u_pitch_with_map:new l.bO(_),u_texsize:new l.bL(_),u_texture:new l.bO(_),u_gamma_scale:new l.bN(_),u_device_pixel_ratio:new l.bN(_),u_tile_id:new l.bM(_),u_zoom_transition:new l.bN(_),u_inv_rot_matrix:new l.bK(_),u_merc_center:new l.bL(_),u_camera_forward:new l.bM(_),u_tile_matrix:new l.bK(_),u_up_vector:new l.bM(_),u_ecef_origin:new l.bM(_),u_is_halo:new l.bO(_)}),symbolTextAndIcon:_=>({u_is_size_zoom_constant:new l.bO(_),u_is_size_feature_constant:new l.bO(_),u_size_t:new l.bN(_),u_size:new l.bN(_),u_camera_to_center_distance:new l.bN(_),u_rotate_symbol:new l.bO(_),u_aspect_ratio:new l.bN(_),u_fade_change:new l.bN(_),u_matrix:new l.bK(_),u_label_plane_matrix:new l.bK(_),u_coord_matrix:new l.bK(_),u_is_text:new l.bO(_),u_pitch_with_map:new l.bO(_),u_texsize:new l.bL(_),u_texsize_icon:new l.bL(_),u_texture:new l.bO(_),u_texture_icon:new l.bO(_),u_gamma_scale:new l.bN(_),u_device_pixel_ratio:new l.bN(_),u_is_halo:new l.bO(_)}),background:_=>({u_matrix:new l.bK(_),u_emissive_strength:new l.bN(_),u_opacity:new l.bN(_),u_color:new l.ca(_)}),backgroundPattern:_=>({u_matrix:new l.bK(_),u_emissive_strength:new l.bN(_),u_opacity:new l.bN(_),u_image:new l.bO(_),u_pattern_tl:new l.bL(_),u_pattern_br:new l.bL(_),u_texsize:new l.bL(_),u_pattern_size:new l.bL(_),u_pixel_coord_upper:new l.bL(_),u_pixel_coord_lower:new l.bL(_),u_tile_units_to_pixels:new l.bN(_)}),terrainRaster:sg,terrainDepth:sg,skybox:_=>({u_matrix:new l.bK(_),u_sun_direction:new l.bM(_),u_cubemap:new l.bO(_),u_opacity:new l.bN(_),u_temporal_offset:new l.bN(_)}),skyboxGradient:_=>({u_matrix:new l.bK(_),u_color_ramp:new l.bO(_),u_center_direction:new l.bM(_),u_radius:new l.bN(_),u_opacity:new l.bN(_),u_temporal_offset:new l.bN(_)}),skyboxCapture:_=>({u_matrix_3f:new l.cb(_),u_sun_direction:new l.bM(_),u_sun_intensity:new l.bN(_),u_color_tint_r:new l.bP(_),u_color_tint_m:new l.bP(_),u_luminance:new l.bN(_)}),globeRaster:_=>({u_proj_matrix:new l.bK(_),u_globe_matrix:new l.bK(_),u_normalize_matrix:new l.bK(_),u_merc_matrix:new l.bK(_),u_zoom_transition:new l.bN(_),u_merc_center:new l.bL(_),u_image0:new l.bO(_),u_grid_matrix:new l.cb(_),u_skirt_height:new l.bN(_),u_far_z_cutoff:new l.bN(_),u_frustum_tl:new l.bM(_),u_frustum_tr:new l.bM(_),u_frustum_br:new l.bM(_),u_frustum_bl:new l.bM(_),u_globe_pos:new l.bM(_),u_globe_radius:new l.bN(_),u_viewport:new l.bL(_)}),globeAtmosphere:_=>({u_frustum_tl:new l.bM(_),u_frustum_tr:new l.bM(_),u_frustum_br:new l.bM(_),u_frustum_bl:new l.bM(_),u_horizon:new l.bN(_),u_transition:new l.bN(_),u_fadeout_range:new l.bN(_),u_color:new l.bP(_),u_high_color:new l.bP(_),u_space_color:new l.bP(_),u_temporal_offset:new l.bN(_),u_horizon_angle:new l.bN(_)}),model:_=>({u_matrix:new l.bK(_),u_lighting_matrix:new l.bK(_),u_normal_matrix:new l.bK(_),u_lightpos:new l.bM(_),u_lightintensity:new l.bN(_),u_lightcolor:new l.bM(_),u_camera_pos:new l.bM(_),u_opacity:new l.bN(_),u_baseColorFactor:new l.bP(_),u_emissiveFactor:new l.bP(_),u_metallicFactor:new l.bN(_),u_roughnessFactor:new l.bN(_),u_baseTextureIsAlpha:new l.bO(_),u_alphaMask:new l.bO(_),u_alphaCutoff:new l.bN(_),u_baseColorTexture:new l.bO(_),u_metallicRoughnessTexture:new l.bO(_),u_normalTexture:new l.bO(_),u_occlusionTexture:new l.bO(_),u_emissionTexture:new l.bO(_),u_color_mix:new l.bP(_),u_aoIntensity:new l.bN(_),u_emissive_strength:new l.bN(_),u_occlusionTextureTransform:new l.bP(_)}),modelDepth:_=>({u_matrix:new l.bK(_),u_instance:new l.bK(_),u_node_matrix:new l.bK(_)}),groundShadow:_=>({u_matrix:new l.bK(_),u_ground_shadow_factor:new l.bM(_)}),stars:_=>({u_matrix:new l.bK(_),u_up:new l.bM(_),u_right:new l.bM(_),u_intensity_multiplier:new l.bN(_)})};let Eo;function So(_,a,d,g,x,w,S){const C=_.context,R=C.gl,D=_.transform,N=_.getOrCreateProgram("collisionBox"),B=[];let j=0,$=0;for(let re=0;re<g.length;re++){const le=g[re],Q=a.getTile(le),ce=Q.getBucket(d);if(!ce)continue;const ve=Gf(le,ce,D);let we=ve;x[0]===0&&x[1]===0||(we=_.translatePosMatrix(ve,Q,x,w));const Ce=S?ce.textCollisionBox:ce.iconCollisionBox,Ue=ce.collisionCircleArray;if(Ue.length>0){const Re=l.a6.create(),Ye=we;l.a6.mul(Re,ce.placementInvProjMatrix,D.glCoordMatrix),l.a6.mul(Re,Re,ce.placementViewportMatrix),B.push({circleArray:Ue,circleOffset:$,transform:Ye,invTransform:Re,projection:ce.getProjection()}),j+=Ue.length/4,$=j}Ce&&(_.terrain&&_.terrain.setupElevationDraw(Q,N),N.draw(_,R.LINES,li.disabled,vi.disabled,_.colorModeForRenderPass(),ci.disabled,Zh(we,D,Q,ce.getProjection()),d.id,Ce.layoutVertexBuffer,Ce.indexBuffer,Ce.segments,null,D.zoom,null,[Ce.collisionVertexBuffer,Ce.collisionVertexBufferExt]))}if(!S||!B.length)return;const Z=_.getOrCreateProgram("collisionCircle"),X=new l.cv;X.resize(4*j),X._trim();let K=0;for(const re of B)for(let le=0;le<re.circleArray.length/4;le++){const Q=4*le,ce=re.circleArray[Q+0],ve=re.circleArray[Q+1],we=re.circleArray[Q+2],Ce=re.circleArray[Q+3];X.emplace(K++,ce,ve,we,Ce,0),X.emplace(K++,ce,ve,we,Ce,1),X.emplace(K++,ce,ve,we,Ce,2),X.emplace(K++,ce,ve,we,Ce,3)}(!Eo||Eo.length<2*j)&&(Eo=function(re){const le=2*re,Q=new l.aw;Q.resize(le),Q._trim();for(let ce=0;ce<le;ce++){const ve=6*ce;Q.uint16[ve+0]=4*ce+0,Q.uint16[ve+1]=4*ce+1,Q.uint16[ve+2]=4*ce+2,Q.uint16[ve+3]=4*ce+2,Q.uint16[ve+4]=4*ce+3,Q.uint16[ve+5]=4*ce+0}return Q}(j));const q=C.createIndexBuffer(Eo,!0),ee=C.createVertexBuffer(X,l.cw.members,!0);for(const re of B){const le={u_matrix:re.transform,u_inv_matrix:re.invTransform,u_camera_to_center_distance:(ae=D).getCameraToCenterDistance(re.projection),u_viewport_size:[ae.width,ae.height]};Z.draw(_,R.TRIANGLES,li.disabled,vi.disabled,_.colorModeForRenderPass(),ci.disabled,le,d.id,ee,q,l.aB.simpleSegment(0,2*re.circleOffset,re.circleArray.length,re.circleArray.length/2),null,D.zoom)}var ae;ee.destroy(),q.destroy()}const ia=l.a6.create();function _u(_){const a=_._camera.getWorldToCamera(_.worldSize,1),d=l.a6.multiply([],a,_.globeMatrix);l.a6.invert(d,d);const g=[0,0,0],x=[0,1,0,0];return l.a7.transformMat4(x,x,d),g[0]=x[0],g[1]=x[1],g[2]=x[2],l.N.normalize(g,g),g}function Ht({width:_,height:a,anchor:d,textOffset:g,textScale:x},w){const{horizontalAlign:S,verticalAlign:C}=l.bf(d),R=-(S-.5)*_,D=-(C-.5)*a,N=l.bd(d,g);return new l.P((R/x+N[0])*w,(D/x+N[1])*w)}function mg(_,a,d,g,x,w,S,C,R,D,N){const B=_.text.placedSymbolArray,j=_.text.dynamicLayoutVertexArray,$=_.icon.dynamicLayoutVertexArray,Z={},X=_.getProjection(),K=iu(C,X,w),q=w.elevation,ee=X.upVectorScale(C.canonical,w.center.lat,w.worldSize).metersToTile;j.clear();for(let ae=0;ae<B.length;ae++){const re=B.get(ae),{tileAnchorX:le,tileAnchorY:Q,numGlyphs:ce}=re,ve=re.hidden||!re.crossTileID||_.allowVerticalPlacement&&!re.placedOrientation?null:g[re.crossTileID];if(ve){let we=0,Ce=0,Ue=0;if(q){const mt=q?q.getAtTileOffset(C,le,Q):0,[Mt,Tt,Lt]=X.upVector(C.canonical,le,Q);we=mt*Mt*ee,Ce=mt*Tt*ee,Ue=mt*Lt*ee}let[Re,Ye,Ge,pt]=uo(re.projectedAnchorX+we,re.projectedAnchorY+Ce,re.projectedAnchorZ+Ue,d?K:S);const ke=X_(w.getCameraToCenterDistance(X),pt);let He=x.evaluateSizeForFeature(_.textSizeData,D,re)*ke/l.bc;d&&(He*=_.tilePixelRatio/R);const Me=Ht(ve,He);d?({x:Re,y:Ye,z:Ge}=X.projectTilePoint(le+Me.x,Q+Me.y,C.canonical),[Re,Ye,Ge]=uo(Re+we,Ye+Ce,Ge+Ue,S)):(a&&Me._rotate(-w.angle),Re+=Me.x,Ye+=Me.y,Ge=0);const Ne=_.allowVerticalPlacement&&re.placedOrientation===l.b6.vertical?Math.PI/2:0;for(let mt=0;mt<ce;mt++)l.b9(j,Re,Ye,Ge,Ne);N&&re.associatedIconIndex>=0&&(Z[re.associatedIconIndex]={x:Re,y:Ye,z:Ge,angle:Ne})}else Pa(ce,j)}if(N){$.clear();const ae=_.icon.placedSymbolArray;for(let re=0;re<ae.length;re++){const le=ae.get(re),{numGlyphs:Q}=le,ce=Z[re];if(le.hidden||!ce)Pa(Q,$);else{const{x:ve,y:we,z:Ce,angle:Ue}=ce;for(let Re=0;Re<Q;Re++)l.b9($,ve,we,Ce,Ue)}}_.icon.dynamicLayoutVertexBuffer.updateData($)}_.text.dynamicLayoutVertexBuffer.updateData(j)}function ed(_,a,d,g,x,w,S={}){const C=d.paint.get("icon-translate"),R=d.paint.get("text-translate"),D=d.paint.get("icon-translate-anchor"),N=d.paint.get("text-translate-anchor"),B=d.layout.get("icon-rotation-alignment"),j=d.layout.get("text-rotation-alignment"),$=d.layout.get("icon-pitch-alignment"),Z=d.layout.get("text-pitch-alignment"),X=d.layout.get("icon-keep-upright"),K=d.layout.get("text-keep-upright"),q=d.paint.get("icon-color-saturation"),ee=_.context,ae=ee.gl,re=_.transform,le=B==="map",Q=j==="map",ce=$==="map",ve=Z==="map",we=d.layout.get("symbol-sort-key").constantOr(1)!==void 0;let Ce=!1;const Ue=_.depthModeForSublayer(0,li.ReadOnly),Re=[l.a5(re.center.lng),l.ae(re.center.lat)],Ye=d.layout.get("text-variable-anchor"),Ge=re.projection.name==="globe",pt=[],ke=[0,-1,0];for(const He of g){const Me=a.getTile(He),Ne=Me.getBucket(d);if(!Ne||Ne.projection.name==="mercator"&&Ge||Ne.fullyClipped)continue;const mt=Ne.projection.name==="globe",Mt=mt?l.S(re.zoom):0,Tt=iu(He,Ne.getProjection(),re),Lt=re.calculatePixelsToTileUnitsMatrix(Me),Zt=Ye&&Ne.hasTextData(),si=Ne.hasIconTextFit()&&Zt&&Ne.hasIconData(),ei=Ne.getProjection().createInversionMatrix(re,He.canonical),ii=()=>{const pn=le&&d.layout.get("symbol-placement")!=="point",Vi=[],lr=pn||si,ji=d.paint.get("icon-image-cross-fade").constantOr(0);_.terrainRenderModeElevated()&&ce&&Vi.push("PITCH_WITH_MAP_TERRAIN"),mt&&(Vi.push("PROJECTION_GLOBE_VIEW"),lr&&Vi.push("PROJECTED_POS_ON_VIEWPORT")),ji>0&&Vi.push("ICON_TRANSITION"),Ne.icon.zOffsetVertexBuffer&&Vi.push("Z_OFFSET"),q<1&&Vi.push("SATURATION");const sr=Ne.icon.programConfigurations.get(d.id),Xr=_.getOrCreateProgram(Ne.sdfIcons?"symbolSDF":"symbolIcon",{config:sr,defines:Vi});let gr;const as=Me.imageAtlasTexture?Me.imageAtlasTexture.size:[0,0],vs=Ne.iconSizeData,Hs=l.b5(vs,re.zoom),Uo=ce||re.pitch!==0,qs=eu(Tt,Me.tileID.canonical,ce,le,re,Ne.getProjection(),Lt),ls=Uf(Tt,Me.tileID.canonical,ce,le,re,Ne.getProjection(),Lt),Xn=_.translatePosMatrix(ls,Me,C,D,!0),Is=_.translatePosMatrix(Tt,Me,C,D),Ns=lr?ia:qs,Gs=le&&!ce&&!pn;let Vo=ke;!Ge&&!re.mercatorFromTransition||le||(Vo=_u(re));const ja=mt?Vo:ke;gr=Ne.sdfIcons&&!Ne.iconsInText?du(vs.kind,Hs,Gs,ce,_,Is,Ns,Xn,!1,as,!0,He,Mt,Re,ei,ja,Ne.getProjection()):Kh(vs.kind,Hs,Gs,ce,_,Is,Ns,Xn,!1,as,He,Mt,Re,ei,ja,Ne.getProjection(),q,ji);const bl=Me.imageAtlasTexture?Me.imageAtlasTexture:null,Lu=d.layout.get("icon-size").constantOr(0)!==1||Ne.iconsNeedLinear,Nu=Ne.sdfIcons||_.options.rotating||_.options.zooming||Lu||Uo?ae.LINEAR:ae.NEAREST,im=Ne.sdfIcons&&d.paint.get("icon-halo-width").constantOr(1)!==0,Fu=_.terrain&&ce&&pn?l.a6.invert(l.a6.create(),qs):ia;if(pn&&Ne.icon){const oc=re.elevation,ud=oc?oc.getAtTileOffsetFunc(He,re.center.lat,re.worldSize,Ne.getProjection()):null,oa=zf(Tt,Me.tileID.canonical,ce,le,re,Ne.getProjection(),Lt);jf(Ne,Tt,_,!1,oa,ls,ce,X,ud,He)}return{program:Xr,buffers:Ne.icon,uniformValues:gr,atlasTexture:bl,atlasTextureIcon:null,atlasInterpolation:Nu,atlasInterpolationIcon:null,isSDF:Ne.sdfIcons,hasHalo:im,tile:Me,labelPlaneMatrixInv:Fu}},Ii=()=>{const pn=Q&&d.layout.get("symbol-placement")!=="point",Vi=[],lr=pn||Ye||si;_.terrainRenderModeElevated()&&ve&&Vi.push("PITCH_WITH_MAP_TERRAIN"),mt&&(Vi.push("PROJECTION_GLOBE_VIEW"),lr&&Vi.push("PROJECTED_POS_ON_VIEWPORT")),Ne.text.zOffsetVertexBuffer&&Vi.push("Z_OFFSET");const ji=Ne.text.programConfigurations.get(d.id),sr=_.getOrCreateProgram(Ne.iconsInText?"symbolTextAndIcon":"symbolSDF",{config:ji,defines:Vi});let Xr,gr=[0,0],as=null;const vs=Ne.textSizeData;Ne.iconsInText&&(gr=Me.imageAtlasTexture?Me.imageAtlasTexture.size:[0,0],as=Me.imageAtlasTexture?Me.imageAtlasTexture:null,Xr=ve||re.pitch!==0||_.options.rotating||_.options.zooming||vs.kind==="composite"||vs.kind==="camera"?ae.LINEAR:ae.NEAREST);const Hs=Me.glyphAtlasTexture?Me.glyphAtlasTexture.size:[0,0],Uo=l.b5(vs,re.zoom),qs=eu(Tt,Me.tileID.canonical,ve,Q,re,Ne.getProjection(),Lt),ls=Uf(Tt,Me.tileID.canonical,ve,Q,re,Ne.getProjection(),Lt),Xn=_.translatePosMatrix(ls,Me,R,N,!0),Is=_.translatePosMatrix(Tt,Me,R,N),Ns=lr?ia:qs,Gs=Q&&!ve&&!pn;let Vo=ke;!Ge&&!re.mercatorFromTransition||Q||(Vo=_u(re));const ja=mt?Vo:ke;let bl;bl=Ne.iconsInText?Jh(vs.kind,Uo,Gs,ve,_,Is,Ns,Xn,Hs,gr,He,Mt,Re,ei,ja,Ne.getProjection()):du(vs.kind,Uo,Gs,ve,_,Is,Ns,Xn,!0,Hs,!0,He,Mt,Re,ei,ja,Ne.getProjection());const Lu=Me.glyphAtlasTexture?Me.glyphAtlasTexture:null,Nu=ae.LINEAR,im=d.paint.get("text-halo-width").constantOr(1)!==0,Fu=_.terrain&&ve&&pn?l.a6.invert(l.a6.create(),qs):ia;if(pn&&Ne.text){const oc=re.elevation,ud=oc?oc.getAtTileOffsetFunc(He,re.center.lat,re.worldSize,Ne.getProjection()):null,oa=zf(Tt,Me.tileID.canonical,ve,Q,re,Ne.getProjection(),Lt);jf(Ne,Tt,_,!0,oa,ls,ve,K,ud,He)}return{program:sr,buffers:Ne.text,uniformValues:bl,atlasTexture:Lu,atlasTextureIcon:as,atlasInterpolation:Nu,atlasInterpolationIcon:Xr,isSDF:!0,hasHalo:im,tile:Me,labelPlaneMatrixInv:Fu}},gi=Ne.icon.segments.get().length,Ti=Ne.text.segments.get().length,wi=gi&&!S.onlyText?ii():null,Qi=Ti&&!S.onlyIcons?Ii():null,Vr=d.paint.get("icon-opacity").constantOr(1),Ui=d.paint.get("text-opacity").constantOr(1);if(we&&Ne.canOverlap){Ce=!0;const pn=Vr&&!S.onlyText?Ne.icon.segments.get():[],Vi=Ui&&!S.onlyIcons?Ne.text.segments.get():[];for(const lr of pn)pt.push({segments:new l.aB([lr]),sortKey:lr.sortKey,state:wi});for(const lr of Vi)pt.push({segments:new l.aB([lr]),sortKey:lr.sortKey,state:Qi})}else S.onlyText||pt.push({segments:Vr?Ne.icon.segments:new l.aB([]),sortKey:0,state:wi}),S.onlyIcons||pt.push({segments:Ui?Ne.text.segments:new l.aB([]),sortKey:0,state:Qi})}Ce&&pt.sort((He,Me)=>He.sortKey-Me.sortKey);for(const He of pt){const Me=He.state;if(Me)if(_.terrain&&_.terrain.setupElevationDraw(Me.tile,Me.program,{useDepthForOcclusion:re.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:Me.labelPlaneMatrixInv}),ee.activeTexture.set(ae.TEXTURE0),Me.atlasTexture&&Me.atlasTexture.bind(Me.atlasInterpolation,ae.CLAMP_TO_EDGE,!0),Me.atlasTextureIcon&&(ee.activeTexture.set(ae.TEXTURE1),Me.atlasTextureIcon&&Me.atlasTextureIcon.bind(Me.atlasInterpolationIcon,ae.CLAMP_TO_EDGE,!0)),_.uploadCommonLightUniforms(_.context,Me.program),Me.hasHalo){const Ne=Me.uniformValues;Ne.u_is_halo=1,Da(Me.buffers,He.segments,d,_,Me.program,Ue,x,w,Ne,2),Ne.u_is_halo=0}else{if(Me.isSDF){const Ne=Me.uniformValues;Me.hasHalo&&(Ne.u_is_halo=1,Da(Me.buffers,He.segments,d,_,Me.program,Ue,x,w,Ne,1)),Ne.u_is_halo=0}Da(Me.buffers,He.segments,d,_,Me.program,Ue,x,w,Me.uniformValues,1)}}}function Da(_,a,d,g,x,w,S,C,R,D){const N=[_.dynamicLayoutVertexBuffer,_.opacityVertexBuffer,_.iconTransitioningVertexBuffer,_.globeExtVertexBuffer,_.zOffsetVertexBuffer];x.draw(g,g.context.gl.TRIANGLES,w,S,C,ci.disabled,R,d.id,_.layoutVertexBuffer,_.indexBuffer,a,d.paint,g.transform.zoom,_.programConfigurations.get(d.id),N,D)}function gl(_,a,d,g,x,w,S){const C=_.context.gl,R=d.paint.get("fill-pattern"),D=R&&R.constantOr(1);let N,B,j,$,Z;S?(B=D&&!d.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",N=C.LINES):(B=D?"fillPattern":"fill",N=C.TRIANGLES);for(const X of g){const K=a.getTile(X);if(D&&!K.patternsLoaded())continue;const q=K.getBucket(d);if(!q)continue;_.prepareDrawTile();const ee=q.programConfigurations.get(d.id),ae=_.isTileAffectedByFog(X),re=_.getOrCreateProgram(B,{config:ee,overrideFog:ae});D&&(_.context.activeTexture.set(C.TEXTURE0),K.imageAtlasTexture&&K.imageAtlasTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),ee.updatePaintBuffers());const le=R.constantOr(null);if(le&&K.imageAtlas){const ve=K.imageAtlas.patternPositions[le.toString()];ve&&ee.setConstantPatternPositions(ve)}const Q=_.translatePosMatrix(X.projMatrix,K,d.paint.get("fill-translate"),d.paint.get("fill-translate-anchor")),ce=d.paint.get("fill-emissive-strength");if(S){$=q.indexBuffer2,Z=q.segments2;const ve=_.terrain&&_.terrain.renderingToTexture?_.terrain.drapeBufferSize:[C.drawingBufferWidth,C.drawingBufferHeight];j=B==="fillOutlinePattern"&&D?ug(Q,ce,_,K,ve):_l(Q,ce,ve)}else $=q.indexBuffer,Z=q.segments,j=D?wp(Q,ce,_,K):tc(Q,ce);_.uploadCommonUniforms(_.context,re,X.toUnwrapped()),re.draw(_,N,x,_.stencilModeForClipping(X),w,ci.disabled,j,d.id,q.layoutVertexBuffer,$,Z,d.paint,_.transform.zoom,ee,void 0)}}function Yt(_,a,d,g,x,w,S,C){d.resetLayerRenderingStats(_);const R=_.context,D=R.gl,N=_.transform,B=d.paint.get("fill-extrusion-pattern"),j=B.constantOr(1),$=d.paint.get("fill-extrusion-opacity"),Z=_.style.enable3dLights(),X=d.paint.get(Z&&!j?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),K=[d.paint.get("fill-extrusion-ambient-occlusion-intensity"),X],q=d.layout.get("fill-extrusion-edge-radius"),ee=q>0&&!d.paint.get("fill-extrusion-rounded-roof"),ae=ee?0:q,re=N.projection.name==="globe"?l.cF():0,le=N.projection.name==="globe",Q=le?l.S(N.zoom):0,ce=[l.a5(N.center.lng),l.ae(N.center.lat)],ve=d.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),we=d.paint.get("fill-extrusion-flood-light-intensity"),Ce=d.paint.get("fill-extrusion-vertical-scale"),Ue=Ra(_,d.paint.get("fill-extrusion-cutoff-fade-range")),Re=d.paint.get("fill-extrusion-emissive-strength"),Ye=[];let Ge;le&&Ye.push("PROJECTION_GLOBE_VIEW"),K[0]>0&&Ye.push("FAUX_AO"),ee&&Ye.push("ZERO_ROOF_RADIUS"),C&&Ye.push("HAS_CENTROID"),we>0&&Ye.push("FLOOD_LIGHT"),Ue.shouldRenderCutoff&&Ye.push("RENDER_CUTOFF");const pt=_.renderPass==="shadow",ke=_.shadowRenderer,He=pt&&!!ke;_.shadowRenderer&&(_.shadowRenderer.useNormalOffset=!0);let Me=[0,0,0];if(ke){const Mt=_.style.directionalLight,Tt=_.style.ambientLight;Mt&&Tt&&(Me=lu(Mt,Tt)),Ge=Ye.concat(["SHADOWS_SINGLE_CASCADE"])}const Ne=He?"fillExtrusionDepth":j?"fillExtrusionPattern":"fillExtrusion",mt=d.getLayerRenderingStats();for(const Mt of g){const Tt=a.getTile(Mt),Lt=Tt.getBucket(d);if(!Lt||Lt.projection.name!==N.projection.name)continue;let Zt=!1;ke&&(Zt=ke.getMaxCascadeForTile(Mt.toUnwrapped())===0);const si=_.isTileAffectedByFog(Mt),ei=Lt.programConfigurations.get(d.id),ii=_.getOrCreateProgram(Ne,{config:ei,defines:Zt?Ge:Ye,overrideFog:si});if(_.terrain&&_.terrain.setupElevationDraw(Tt,ii,{useMeterToDem:!0}),!Lt.centroidVertexBuffer){const Vr=ii.attributes.a_centroid_pos;Vr!==void 0&&D.vertexAttrib2f(Vr,0,0)}!pt&&ke&&ke.setupShadows(Tt.tileID.toUnwrapped(),ii,"vector-tile",Tt.tileID.overscaledZ),j&&(_.context.activeTexture.set(D.TEXTURE0),Tt.imageAtlasTexture&&Tt.imageAtlasTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),ei.updatePaintBuffers());const Ii=B.constantOr(null);if(Ii&&Tt.imageAtlas){const Vr=Tt.imageAtlas.patternPositions[Ii.toString()];Vr&&ei.setConstantPatternPositions(Vr)}const gi=d.paint.get("fill-extrusion-vertical-gradient");let Ti;if(pt&&ke){if(gg(Tt.tileID,Lt,_))continue;const Vr=ke.calculateShadowPassMatrixFromTile(Tt.tileID.toUnwrapped());Ti=bp(Vr,ae,Ce)}else{const Vr=_.translatePosMatrix(Mt.expandedProjMatrix,Tt,d.paint.get("fill-extrusion-translate"),d.paint.get("fill-extrusion-translate-anchor")),Ui=N.projection.createInversionMatrix(N,Mt.canonical);Ti=j?ml(Vr,_,gi,$,K,ae,Mt,Tt,re,Q,ce,Ui,ve,Ce):xp(Vr,_,gi,$,K,ae,Mt,re,Q,ce,Ui,ve,Ce,we,Me,Re)}_.uploadCommonUniforms(R,ii,Mt.toUnwrapped(),null,Ue);let wi=Lt.segments;if(N.projection.name==="mercator"&&!pt&&(wi=Lt.getVisibleSegments(Tt.tileID,_.terrain,_.transform.getFrustum(0)),!wi.get().length))continue;if(mt)if(pt)for(const Vr of wi.get())mt.numRenderedVerticesInShadowPass+=Vr.primitiveLength;else for(const Vr of wi.get())mt.numRenderedVerticesInTransparentPass+=Vr.primitiveLength;const Qi=[];(_.terrain||C)&&Qi.push(Lt.centroidVertexBuffer),le&&Qi.push(Lt.layoutVertexExtBuffer),ii.draw(_,R.gl.TRIANGLES,x,w,S,ci.backCCW,Ti,d.id,Lt.layoutVertexBuffer,Lt.indexBuffer,wi,d.paint,_.transform.zoom,ei,Qi)}_.shadowRenderer&&(_.shadowRenderer.useNormalOffset=!1)}function La(_,a,d,g,x,w,S,C,R,D,N,B,j,$,Z,X,K,q,ee){const ae=_.context,re=ae.gl,le=_.transform,Q=_.transform.zoom,ce=[],ve=Ra(_,d.paint.get("fill-extrusion-cutoff-fade-range"));D==="clear"?(ce.push("CLEAR_SUBPASS"),ee&&(ce.push("CLEAR_FROM_TEXTURE"),ae.activeTexture.set(re.TEXTURE0),ee.bind(re.LINEAR,re.CLAMP_TO_EDGE))):D==="sdf"&&ce.push("SDF_SUBPASS"),K&&ce.push("HAS_CENTROID"),ve.shouldRenderCutoff&&ce.push("RENDER_CUTOFF");const we=d.layout.get("fill-extrusion-edge-radius"),Ce=(Ue,Re,Ye,Ge,pt)=>{const ke=Re.programConfigurations.get(d.id),He=_.isTileAffectedByFog(Ue),Me=_.getOrCreateProgram("fillExtrusionGroundEffect",{config:ke,defines:ce,overrideFog:He}),Ne=((Mt,Tt,Lt,Zt,si,ei,ii,Ii,gi,Ti,wi)=>({u_matrix:Tt,u_opacity:Lt,u_ao_pass:Zt?1:0,u_meter_to_tile:si,u_ao:ei,u_flood_light_intensity:ii,u_flood_light_color:Ii,u_attenuation:gi,u_edge_radius:Ti,u_fb:0,u_fb_size:wi}))(0,Ge,N,R,pt,[B,j*pt],$,Z,X,Q>=17?0:we*pt,ee?ee.size[0]:0),mt=[];K&&mt.push(Re.hiddenByLandmarkVertexBuffer),_.uploadCommonUniforms(ae,Me,Ue.toUnwrapped(),null,ve),Me.draw(_,ae.gl.TRIANGLES,x,w,S,C,Ne,d.id,Re.vertexBuffer,Re.indexBuffer,Ye,d.paint,Q,ke,mt)};for(const Ue of g){const Re=a.getTile(Ue),Ye=Re.getBucket(d);if(!Ye||Ye.projection.name!==le.projection.name||!Ye.groundEffect||Ye.groundEffect&&!Ye.groundEffect.hasData())continue;const Ge=Ye.groundEffect,pt=1/Ye.tileToMeter;{const ke=_.translatePosMatrix(Ue.projMatrix,Re,d.paint.get("fill-extrusion-translate"),d.paint.get("fill-extrusion-translate-anchor")),He=Ge.getDefaultSegment();Ce(Ue,Ge,He,ke,pt)}if(q)for(let ke=0;ke<4;ke++){const He=l.cG[ke](Ue),Me=a.getTile(He);if(!Me)continue;const Ne=Me.getBucket(d);if(!Ne||Ne.projection.name!==le.projection.name||!Ne.groundEffect||Ne.groundEffect&&!Ne.groundEffect.hasData())continue;const mt=Ne.groundEffect;let Mt,Tt;ke===0?(Mt=[-l.V,0,0],Tt=1):ke===1?(Mt=[l.V,0,0],Tt=0):ke===2?(Mt=[0,-l.V,0],Tt=3):(Mt=[0,l.V,0],Tt=2);const Lt=mt.regionSegments[Tt];if(!Lt)continue;const Zt=new Float32Array(16);l.a6.translate(Zt,Ue.projMatrix,Mt),Ce(Ue,mt,Lt,_.translatePosMatrix(Zt,Re,d.paint.get("fill-extrusion-translate"),d.paint.get("fill-extrusion-translate-anchor")),pt)}}}function z1(_,a,d,g,x,w,S){g.centroidVertexArray.length===0&&g.createCentroidsBuffer();const C=w?w.findDEMTileFor(d):null;if(!(C&&C.dem||S))return;const R=q=>new l.P(Math.ceil((q+l.cJ)*l.cK),0),D=q=>{const ee=a.getSource().minzoom,ae=le=>{const Q=a.getTileByID(le);if(Q&&Q.hasData())return Q.getBucket(x)},re=[0,-1,1];for(const le of re){if(q.overscaledZ+le<ee)continue;const Q=ae(q.calculateScaledKey(q.overscaledZ+le));if(Q)return Q}},N=[0,0,0],B=(q,ee)=>(N[0]=Math.min(q.min.y,ee.min.y),N[1]=Math.max(q.max.y,ee.max.y),N[2]=l.V-ee.min.x>q.max.x?ee.min.x-l.V:q.max.x,N),j=(q,ee)=>(N[0]=Math.min(q.min.x,ee.min.x),N[1]=Math.max(q.max.x,ee.max.x),N[2]=l.V-ee.min.y>q.max.y?ee.min.y-l.V:q.max.y,N),$=[(q,ee)=>B(q,ee),(q,ee)=>B(ee,q),(q,ee)=>j(q,ee),(q,ee)=>j(ee,q)],Z=(q,ee,ae,re,le,Q,ce)=>{if(!w)return 0;const ve=[[Q?ae:q,Q?q:ae,0],[Q?ae:ee,Q?ee:ae,0]],we=ce<0?l.V+ce:ce,Ce=[Q?we:(q+ee)/2,Q?(q+ee)/2:we,0];return ae===0&&ce<0||ae!==0&&ce>0?w.getForTilePoints(le,[Ce],!0,re):ve.push(Ce),w.getForTilePoints(d,ve,!0,C),Math.max(ve[0][2],ve[1][2],Ce[2])/w.exaggeration()};for(let q=0;q<4;q++){const ee=g.borderFeatureIndices[q];if(ee.length===0)continue;const ae=l.cG[q](d),re=D(ae);if(!(re&&re instanceof l.cH)||g.borderDoneWithNeighborZ[q]===re.canonical.z)continue;re.centroidVertexArray.length===0&&re.createCentroidsBuffer();const le=w?w.findDEMTileFor(ae):null;if(!(le&&le.dem||S))continue;const Q=(q<2?1:5)-q,ce=re.borderDoneWithNeighborZ[Q]!==g.canonical.z,ve=re.borderFeatureIndices[Q];let we=0;if(g.canonical.z!==re.canonical.z){for(const Ce of ee)g.showCentroid(g.featuresOnBorder[Ce]);if(ce)for(const Ce of ve)re.showCentroid(re.featuresOnBorder[Ce]);g.borderDoneWithNeighborZ[q]=re.canonical.z,re.borderDoneWithNeighborZ[Q]=g.canonical.z}for(const Ce of ee){const Ue=g.featuresOnBorder[Ce],Re=g.centroidData[Ue.centroidDataIndex],Ye=Ue.borders[q];let Ge;for(;we<ve.length;){Ge=re.featuresOnBorder[ve[we]];const pt=Ge.borders[Q];if(pt[1]>Ye[0]+3||pt[0]>Ye[0]-3)break;re.showCentroid(Ge),we++}if(Ge&&we<ve.length){const pt=we;let ke=0;for(;!(Ge.borders[Q][0]>Ye[1]-3)&&(ke++,++we!==ve.length);)Ge=re.featuresOnBorder[ve[we]];if(Ge=re.featuresOnBorder[ve[pt]],ke>1){const Ne=Ge.borders[Q];Math.abs(Ye[0]-Ne[0])<3&&Math.abs(Ye[1]-Ne[1])<3&&(ke=1,we=pt+1)}else if(ke===0){g.showCentroid(Ue);continue}const He=re.centroidData[Ge.centroidDataIndex];S&&ke===1&&(((X=Re).flags|(K=He).flags)&l.cI?(X.flags|=l.cI,K.flags|=l.cI):(X.flags&=~l.cI,K.flags&=~l.cI));const Me=Ue.intersectsCount()>1||Ge.intersectsCount()>1;if(ke>1)we=pt,Re.centroidXY=He.centroidXY=new l.P(0,0);else if(le&&le.dem&&!Me){const Ne=$[q](Re,He),mt=q%2?l.V-1:0,Mt=Z(Ne[0],Math.min(l.V-1,Ne[1]),mt,le,ae,q<2,Ne[2]);Re.centroidXY=He.centroidXY=R(Mt)}else Me?Re.centroidXY=He.centroidXY=new l.P(0,0):(Re.centroidXY=g.encodeBorderCentroid(Ue),He.centroidXY=re.encodeBorderCentroid(Ge));g.writeCentroidToBuffer(Re),re.writeCentroidToBuffer(He)}else g.showCentroid(Ue)}g.borderDoneWithNeighborZ[q]=re.canonical.z,re.borderDoneWithNeighborZ[Q]=g.canonical.z}var X,K;(g.needsCentroidUpdate||!g.centroidVertexBuffer&&g.centroidVertexArray.length!==0)&&g.uploadCentroid(_)}const U1=[1,0,0],Mp=[0,1,0],_g=[0,0,1];function gg(_,a,d){const g=d.transform,x=d.shadowRenderer;if(!x)return!0;const w=_.toUnwrapped(),S=g.tileSize*x._cascades[d.currentShadowCascade].scale;let C=a.maxHeight;if(g.elevation){const X=g.elevation.getMinMaxForTile(_);X&&(C+=X.max)}const R=[...x.shadowDirection];R[2]=-R[2];const D=x.computeSimplifiedTileShadowVolume(w,C,S,R);if(!D)return!1;const N=[U1,Mp,_g,R,[R[0],0,R[2]],[0,R[1],R[2]]],B=g.projection.name==="globe",j=g.scaleZoom(S),$=l.bq.fromInvProjectionMatrix(g.invProjMatrix,g.worldSize,j,!B),Z=x.getCurrentCascadeFrustum();return $.intersectsPrecise(D.vertices,D.planes,N)===0||Z.intersectsPrecise(D.vertices,D.planes,N)===0}function yg(_){return[_[0]*l.cL,_[1]*l.cL,_[2]*l.cL,0]}function Cp(_,a,d,g,x,w,S,C,R){const D=g.getSource(),N=d.globeSharedBuffers;if(!N)return;let B,j,$;if(a&&(B=g.getTile(a)),D instanceof l.ap?(j=D.texture,$=l.cj(0,0,d.transform)):B&&a&&(j=B.texture,$=l.cj(a.canonical.z,a.canonical.x,d.transform)),!j||!$)return;_||($=l.a6.scale(l.a6.create(),$,[1,-1,1]));const Z=d.context,X=Z.gl,K=x.paint.get("raster-resampling")==="nearest"?X.NEAREST:X.LINEAR,q=d.colorModeForDrapableLayerRenderPass(w),ee=S.defines;ee.push("GLOBE_POLES");const ae=new li(X.LEQUAL,li.ReadWrite,d.depthRangeFor3D),re=Float32Array.from(d.transform.expandedFarZProjMatrix),le=Float32Array.from(l.aT(l.ci(new l.bs(0,0,0))));d.terrain&&d.terrain.prepareDrawTile(),Z.activeTexture.set(X.TEXTURE0),j.bind(K,X.CLAMP_TO_EDGE),Z.activeTexture.set(X.TEXTURE1),j.bind(K,X.CLAMP_TO_EDGE),j.useMipmap&&Z.extTextureFilterAnisotropic&&d.transform.pitch>20&&X.texParameterf(X.TEXTURE_2D,Z.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Z.extTextureFilterAnisotropicMax);const[Q,ce,ve,we]=a?N.getPoleBuffers(a.canonical.z,!1):N.getPoleBuffers(0,!0),Ce=x.paint.get("raster-elevation");let Ue;_?(Ue=Q,d.renderDefaultNorthPole=Ce!==0):(Ue=ce,d.renderDefaultSouthPole=Ce!==0);const Re=yg(S.mix),Ye=((pt,ke,He,Me,Ne,mt,Mt,Tt,Lt,Zt,si,ei,ii)=>Sp(pt,ke,He,new Float32Array(16),new Float32Array(9),[0,0],Me,[0,0],[0,0,0,0],1,{opacity:1,mix:0},mt,[0,0],Tt,2,Zt,si,ei,1,0,ii))(re,le,$,l.S(d.transform.zoom),0,x,0,Ce,0,Re,S.offset,S.range,w),Ge=d.getOrCreateProgram("raster",{defines:ee});d.uploadCommonUniforms(Z,Ge,null),Ge.draw(d,X.TRIANGLES,ae,R,q,C,Ye,x.id,Ue,ve,we)}function Pp(_){const a=_._nearZ,d=_.projection.farthestPixelDistance(_),g=d-a,x=.2*_.height,w=a+x;return[a,d,(w-x-a)/g,(w-a)/g]}function Ip(_,a,d,g){if(_)return a instanceof vt&&_ instanceof cl?a.getTextureDescriptor(_,d,!0):{texture:_.texture,mix:yg(g.mix),offset:g.offset,buffer:0,tileSize:1}}function Rp(_,a,d){if(!_)return null;const g=a.getTextureDescriptor(_,d,!0);if(!g)return null;let{texture:x,mix:w,offset:S,tileSize:C,buffer:R,format:D}=g;if(!x||!D)return null;let N=!1;return D==="uint32"&&(N=!0,w[3]=0,w=Yh(l.cM,w,[0,d.paint.get("raster-particle-max-speed")]),S=dg(l.cM,S,[0,d.paint.get("raster-particle-max-speed")])),{texture:x,textureOffset:[R/(C+2*R),C/(C+2*R)],tileSize:C,scalarData:N,scale:w,offset:S,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[D]]}}function Op(_){const a=_._nearZ,d=_.projection.farthestPixelDistance(_),g=d-a,x=.2*_.height,w=a+x;return[a,d,(w-x-a)/g,(w-a)/g]}const $s=new l.ax(1,0,0,1),Na=new l.ax(0,1,0,1),vg=new l.ax(0,0,1,1),kp=new l.ax(1,0,1,1),Dp=new l.ax(0,1,1,1);function Fa(_,a,d,g,x,w,S){const C=_.context,R=_.transform,D=C.gl,N=R.projection.name==="globe",B=N?["PROJECTION_GLOBE_VIEW"]:[];let j=l.a6.clone(d.projMatrix);if(N&&l.S(R.zoom)>0){const Re=l.aS(d.canonical,R),Ye=l.cN(Re);j=l.a6.multiply(new Float32Array(16),R.globeMatrix,Ye),l.a6.multiply(j,R.projMatrix,j)}const $=l.a6.create();$[12]+=2*x/(l.f.devicePixelRatio*R.width),$[13]+=2*w/(l.f.devicePixelRatio*R.height),l.a6.multiply(j,$,j);const Z=_.getOrCreateProgram("debug",{defines:B}),X=a.getTileByID(d.key);_.terrain&&_.terrain.setupElevationDraw(X,Z);const K=li.disabled,q=vi.disabled,ee=_.colorModeForRenderPass(),ae="$debug";C.activeTexture.set(D.TEXTURE0),_.emptyTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),N?X._makeGlobeTileDebugBuffers(_.context,R):X._makeDebugTileBoundsBuffers(_.context,R.projection);const re=X._tileDebugBuffer||_.debugBuffer,le=X._tileDebugIndexBuffer||_.debugIndexBuffer,Q=X._tileDebugSegments||_.debugSegments;if(Z.draw(_,D.LINE_STRIP,K,q,ee,ci.disabled,Tp(j,g),ae,re,le,Q,null,null,null,[X._globeTileDebugBorderBuffer]),S){const Re=X.latestRawTileData,Ye=Math.floor((Re&&Re.byteLength||0)/1024);let Ge=d.canonical.toString();d.overscaledZ!==d.canonical.z&&(Ge+=` => ${d.overscaledZ}`),Ge+=` ${X.state}`,Ge+=` ${Ye}kb`,function(pt,ke){pt.initDebugOverlayCanvas();const He=pt.debugOverlayCanvas,Me=pt.context.gl,Ne=pt.debugOverlayCanvas.getContext("2d");Ne.clearRect(0,0,He.width,He.height),Ne.shadowColor="white",Ne.shadowBlur=2,Ne.lineWidth=1.5,Ne.strokeStyle="white",Ne.textBaseline="top",Ne.font="bold 36px Open Sans, sans-serif",Ne.fillText(ke,5,5),Ne.strokeText(ke,5,5),pt.debugOverlayTexture.update(He),pt.debugOverlayTexture.bind(Me.LINEAR,Me.CLAMP_TO_EDGE)}(_,Ge)}const ce=a.getTile(d).tileSize,ve=512/Math.min(ce,512)*(d.overscaledZ/R.zoom)*.5,we=X._tileDebugTextBuffer||_.debugBuffer,Ce=X._tileDebugTextIndexBuffer||_.quadTriangleIndexBuffer,Ue=X._tileDebugTextSegments||_.debugSegments;Z.draw(_,D.TRIANGLES,K,q,Fi.alphaBlended,ci.disabled,Tp(j,l.ax.transparent,ve),ae,we,Ce,Ue,null,null,null,[X._globeTileDebugTextBuffer])}function Lp(_,a,d,g){dn(_,0,a+d/2,_.transform.width,d,g)}function io(_,a,d,g){dn(_,a-d/2,0,d,_.transform.height,g)}function dn(_,a,d,g,x,w){const S=_.context,C=S.gl;C.enable(C.SCISSOR_TEST),C.scissor(a*l.f.devicePixelRatio,d*l.f.devicePixelRatio,g*l.f.devicePixelRatio,x*l.f.devicePixelRatio),S.clear({color:w}),C.disable(C.SCISSOR_TEST)}const td=l.ay([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:Np}=td;function ra(_,a,d,g){_.emplaceBack(a,d,g)}class Fp{constructor(a){this.vertexArray=new l.az,this.indices=new l.aw,ra(this.vertexArray,-1,-1,1),ra(this.vertexArray,1,-1,1),ra(this.vertexArray,-1,1,1),ra(this.vertexArray,1,1,1),ra(this.vertexArray,-1,-1,-1),ra(this.vertexArray,1,-1,-1),ra(this.vertexArray,-1,1,-1),ra(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=a.createVertexBuffer(this.vertexArray,Np),this.indexBuffer=a.createIndexBuffer(this.indices),this.segment=l.aB.simpleSegment(0,0,36,12)}}function yl(_,a,d,g,x,w){const S=_.context.gl,C=a.paint.get("sky-atmosphere-color"),R=a.paint.get("sky-atmosphere-halo-color"),D=a.paint.get("sky-atmosphere-sun-intensity"),N=((B,j,$,Z,X)=>({u_matrix_3f:B,u_sun_direction:j,u_sun_intensity:$,u_color_tint_r:[Z.r,Z.g,Z.b,Z.a],u_color_tint_m:[X.r,X.g,X.b,X.a],u_luminance:5e-5}))(l.co.fromMat4(l.co.create(),g),x,D,C,R);S.framebufferTexture2D(S.FRAMEBUFFER,S.COLOR_ATTACHMENT0,S.TEXTURE_CUBE_MAP_POSITIVE_X+w,a.skyboxTexture,0),d.draw(_,S.TRIANGLES,li.disabled,vi.disabled,Fi.unblended,ci.frontCW,N,"skyboxCapture",a.skyboxGeometry.vertexBuffer,a.skyboxGeometry.indexBuffer,a.skyboxGeometry.segment)}const V1=l.ay([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class ic{constructor(a){const d=new l.cO;d.emplaceBack(-1,1,1,0,0),d.emplaceBack(1,1,1,1,0),d.emplaceBack(1,-1,1,1,1),d.emplaceBack(-1,-1,1,0,1);const g=new l.aw;g.emplaceBack(0,1,2),g.emplaceBack(2,3,0),this.vertexBuffer=a.createVertexBuffer(d,V1.members),this.indexBuffer=a.createIndexBuffer(g),this.segments=l.aB.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const gu=l.ay([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Pt{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class oi{constructor(a){this.colorModeAlphaBlendedWriteRGB=new Fi([1,Ea,1,Ea],l.ax.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new Fi([1,0,1,0],l.ax.transparent,[!1,!1,!1,!0]),this.params=new Pt,this.updateNeeded=!0,a.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),a.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),a.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),a.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(a){const d=a.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new ic(d);const g=this.params.sizeRange,x=this.params.intensityRange,w=function(N){const B=l.aA(30),j=[];for(let $=0;$<N;++$){const Z=2*Math.PI*B(),X=Math.acos(1-2*B())-.5*Math.PI;j.push(l.N.fromValues(Math.cos(X)*Math.cos(Z),Math.cos(X)*Math.sin(Z),Math.sin(X)))}return j}(this.params.starsCount),S=l.aA(300),C=new l.cP,R=new l.aw;let D=0;for(let N=0;N<w.length;++N){const B=l.N.scale([],w[N],200),j=Math.max(0,1+.01*g*(1*S()-.5)),$=Math.max(0,1+.01*x*(1*S()-.5));C.emplaceBack(B[0],B[1],B[2],-1,-1,j,$),C.emplaceBack(B[0],B[1],B[2],1,-1,j,$),C.emplaceBack(B[0],B[1],B[2],1,1,j,$),C.emplaceBack(B[0],B[1],B[2],-1,1,j,$),R.emplaceBack(D+0,D+1,D+2),R.emplaceBack(D+0,D+2,D+3),D+=4}this.starsVx=d.createVertexBuffer(C,gu.members),this.starsIdx=d.createIndexBuffer(R),this.starsSegments=l.aB.simpleSegment(0,0,C.length,R.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(a,d){const g=a.context,x=g.gl,w=a.transform,S=new li(x.LEQUAL,li.ReadOnly,[0,1]),C=l.S(w.zoom),R=d.properties.get("color").toArray01(),D=d.properties.get("high-color").toArray01(),N=d.properties.get("space-color").toArray01PremultipliedAlpha(),B=5e-4,j=l.cQ(d.properties.get("horizon-blend"),0,1,B,.25),$=l.cd(a,g,w)&&j===B?w.worldSize/(2*Math.PI*1.025)-1:w.globeRadius,Z=a.frameCounter/1e3%1,X=l.N.length(w.globeCenterInViewSpace),K=Math.sqrt(Math.pow(X,2)-Math.pow($,2)),q=Math.acos(K/X),ee=ae=>{const re=w.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];ae&&re.push("ALPHA_PASS");const le=a.getOrCreateProgram("globeAtmosphere",{defines:re}),Q=((ve,we,Ce,Ue,Re,Ye,Ge,pt,ke,He,Me,Ne)=>({u_frustum_tl:ve,u_frustum_tr:we,u_frustum_br:Ce,u_frustum_bl:Ue,u_horizon:Re,u_transition:Ye,u_fadeout_range:Ge,u_color:pt,u_high_color:ke,u_space_color:He,u_temporal_offset:Me,u_horizon_angle:Ne}))(w.frustumCorners.TL,w.frustumCorners.TR,w.frustumCorners.BR,w.frustumCorners.BL,w.frustumCorners.horizon,C,j,R,D,N,Z,q);a.uploadCommonUniforms(g,le);const ce=this.atmosphereBuffer;ce&&le.draw(a,x.TRIANGLES,S,vi.disabled,ae?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,ci.backCW,Q,ae?"atmosphere_glow_alpha":"atmosphere_glow",ce.vertexBuffer,ce.indexBuffer,ce.segments)};ee(!1),ee(!0)}drawStars(a,d){const g=l.aa(d.properties.get("star-intensity"),0,1);if(g===0)return;const x=a.context,w=x.gl,S=a.transform,C=a.getOrCreateProgram("stars"),R=l.bi.identity([]);l.bi.rotateX(R,R,-S._pitch),l.bi.rotateZ(R,R,-S.angle),l.bi.rotateX(R,R,l.bj(S._center.lat)),l.bi.rotateY(R,R,-l.bj(S._center.lng));const D=l.a6.fromQuat(new Float32Array(16),R),N=l.a6.multiply([],S.starsProjMatrix,D),B=l.co.fromMat4([],D),j=l.co.invert([],B),$=[0,1,0];l.N.transformMat3($,$,j),l.N.scale($,$,this.params.sizeMultiplier);const Z=[1,0,0];l.N.transformMat3(Z,Z,j),l.N.scale(Z,Z,this.params.sizeMultiplier);const X=(K=$,q=Z,ee=g,{u_matrix:Float32Array.from(N),u_up:K,u_right:q,u_intensity_multiplier:ee});var K,q,ee;a.uploadCommonUniforms(x,C),this.starsVx&&this.starsIdx&&C.draw(a,w.TRIANGLES,li.disabled,vi.disabled,this.colorModeAlphaBlendedWriteRGB,ci.disabled,X,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function vl(_,a){const d=[..._],g=a.cameraWorldSizeForFog/a.worldSize,x=l.a6.identity([]);return l.a6.scale(x,x,[g,g,1]),l.a6.multiply(d,x,d),l.a6.multiply(d,a.worldToFogMatrix,d),d}function fn(_,a,d,g){const x=d.material,w=g.context,{baseColorTexture:S,metallicRoughnessTexture:C}=x.pbrMetallicRoughness,{normalTexture:R,occlusionTexture:D,emissionTexture:N}=x;function B(j,$,Z){if(j&&(_.push($),w.activeTexture.set(w.gl.TEXTURE0+Z),j.gfxTexture)){const{minFilter:X,magFilter:K,wrapS:q,wrapT:ee}=j.sampler;j.gfxTexture.bindExtraParam(X,K,q,ee)}}B(S,"HAS_TEXTURE_u_baseColorTexture",ys.BaseColor),B(C,"HAS_TEXTURE_u_metallicRoughnessTexture",ys.MetallicRoughness),B(R,"HAS_TEXTURE_u_normalTexture",ys.Normal),B(D,"HAS_TEXTURE_u_occlusionTexture",ys.Occlusion),B(N,"HAS_TEXTURE_u_emissionTexture",ys.Emission),d.texcoordBuffer&&(_.push("HAS_ATTRIBUTE_a_uv_2f"),a.push(d.texcoordBuffer)),d.colorBuffer&&(_.push(d.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),a.push(d.colorBuffer)),d.normalBuffer&&(_.push("HAS_ATTRIBUTE_a_normal_3f"),a.push(d.normalBuffer)),d.pbrBuffer&&(_.push("HAS_ATTRIBUTE_a_pbr"),_.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),a.push(d.pbrBuffer)),x.alphaMode!=="OPAQUE"&&x.alphaMode!=="MASK"||_.push("UNPREMULT_TEXTURE_IN_SHADER"),x.defined||_.push("DIFFUSE_SHADED"),_.push("USE_STANDARD_DERIVATIVES")}function yu(_,a,d,g,x,w){const S=d.paint.get("model-opacity"),C=a.context,R=new li(a.context.gl.LEQUAL,li.ReadWrite,a.depthRangeFor3D),D=a.transform,N=_.mesh,B=N.material,j=B.pbrMetallicRoughness,$=a.style.fog;let Z;Z=a.transform.projection.zAxisUnit==="pixels"?[..._.nodeModelMatrix]:l.a6.multiply([],g.zScaleMatrix,_.nodeModelMatrix),l.a6.multiply(Z,g.negCameraPosMatrix,Z);const X=l.a6.invert([],Z);l.a6.transpose(X,X);const K=d.paint.get("model-emissive-strength").constantOr(0),q=Qh(new Float32Array(_.worldViewProjection),new Float32Array(Z),new Float32Array(X),a,S,j.baseColorFactor,B.emissiveFactor,j.metallicFactor,j.roughnessFactor,B,K,d),ee={defines:[]},ae=[];fn(ee.defines,ae,N,a);const re=a.shadowRenderer;re&&(re.useNormalOffset=!1);let le=null;if($){const ve=vl(_.nodeModelMatrix,a.transform);if(le=new Float32Array(ve),D.projection.name!=="globe"){const we=N.aabb.min,Ce=N.aabb.max,[Ue,Re]=$.getOpacityForBounds(ve,we[0],we[1],Ce[0],Ce[1]);ee.overrideFog=Ue>=Ci||Re>=Ci}}const Q=Ra(a,d.paint.get("model-cutoff-fade-range"));Q.shouldRenderCutoff&&ee.defines.push("RENDER_CUTOFF");const ce=a.getOrCreateProgram("model",ee);a.uploadCommonUniforms(C,ce,null,le,Q),a.renderPass!=="shadow"&&re&&re.setupShadowsFromMatrix(_.nodeModelMatrix,ce),ce.draw(a,C.gl.TRIANGLES,R,x,w,N.material.doubleSided?ci.disabled:ci.backCCW,q,d.id,N.vertexBuffer,N.indexBuffer,N.segments,d.paint,a.transform.zoom,void 0,ae)}function vu(_,a,d,g,x,w,S){let C;C=_.projection.name==="globe"?l.cS(d,_):[...d],l.a6.multiply(C,C,a.matrix);const R=l.a6.multiply([],g,C);if(a.meshes)for(const D of a.meshes){if(D.material.alphaMode!=="BLEND"){S.push({mesh:D,depth:0,modelIndex:x,worldViewProjection:R,nodeModelMatrix:C});continue}const N=l.N.transformMat4([],D.centroid,R);N[2]>0&&w.push({mesh:D,depth:N[2],modelIndex:x,worldViewProjection:R,nodeModelMatrix:C})}if(a.children)for(const D of a.children)vu(_,D,d,g,x,w,S)}function Fe(_,a,d,g){const x=d.shadowRenderer;if(!x)return;const w=x.getShadowPassDepthMode(),S=x.getShadowPassColorMode(),C=x.calculateShadowPassMatrixFromMatrix(a),R=mu(C);d.getOrCreateProgram("modelDepth",{defines:d._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(d,d.context.gl.TRIANGLES,w,vi.disabled,S,ci.backCCW,R,g.id,_.vertexBuffer,_.indexBuffer,_.segments,g.paint,d.transform.zoom,void 0,void 0)}function Bp(_,a,d){const g=a.updateZoomBasedPaintProperties(),x=function(w,S,C){let R,D,N,B=w.terrain?w.terrain.exaggeration():0;if(w.terrain&&B>0){const j=w.terrain,$=j.findDEMTileFor(C);$&&$.dem?R=l.cU.create(j,C,$):B=0}if(B===0&&(S.terrainElevationMin=0,S.terrainElevationMax=0),B===S.validForExaggeration&&(B===0||R&&R._demTile&&R._demTile.tileID===S.validForDEMTile.id&&R._dem._timestamp===S.validForDEMTile.timestamp))return!1;for(const j in S.instancesPerModel){const $=S.instancesPerModel[j];for(let Z=0;Z<$.instancedDataArray.length;++Z){const X=(R?B*R.getElevationAt(0|$.instancedDataArray.float32[16*Z],0|$.instancedDataArray.float32[16*Z+1],!0,!0):0)+$.instancesEvaluatedElevation[Z];$.instancedDataArray.float32[16*Z+6]=X,D=D?Math.min(S.terrainElevationMin,X):X,N=N?Math.max(S.terrainElevationMax,X):X}}return S.terrainElevationMin=D||0,S.terrainElevationMax=N||0,S.validForExaggeration=B,S.validForDEMTile=R&&R._demTile?{id:R._demTile.tileID,timestamp:R._dem._timestamp}:{id:void 0,timestamp:0},!0}(_,a,d);(g||x)&&(a.uploaded=!1,a.upload(_.context))}const ro={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new l.bS([0,0,0],[l.V,l.V,0])};function xg(_,a){const d=1<<_.canonical.z,g=a.getFreeCameraOptions().position,x=a.elevation,w=_.canonical.x/d,S=(_.canonical.x+1)/d,C=_.canonical.y/d,R=(_.canonical.y+1)/d;let D=a._centerAltitude;if(x){const $=x.getMinMaxForTile(_);$&&$.max>D&&(D=$.max)}const N=l.aa(g.x,w,S)-g.x,B=l.aa(g.y,C,R)-g.y,j=l.bl(D,a.center.lat)-g.z;return a._zoomFromMercatorZ(Math.sqrt(N*N+B*B+j*j))}function zp(_,a,d,g,x,w,S){const C=_.context,R=_.renderPass==="shadow",D=_.shadowRenderer,N=R&&D?D.getShadowPassDepthMode():new li(C.gl.LEQUAL,li.ReadWrite,_.depthRangeFor3D),B=_.isTileAffectedByFog(w);if(d.meshes)for(const j of d.meshes){const $=["MODEL_POSITION_ON_GPU"],Z=[];let X,K,q;g.instancedDataArray.length>20&&$.push("INSTANCED_ARRAYS");const ee=Ra(_,a.paint.get("model-cutoff-fade-range"));if(ee.shouldRenderCutoff&&$.push("RENDER_CUTOFF"),R&&D)X=_.getOrCreateProgram("modelDepth",{defines:$}),K=mu(S.shadowTileMatrix,S.shadowTileMatrix,Float32Array.from(d.matrix)),q=D.getShadowPassColorMode();else{fn($,Z,j,_),X=_.getOrCreateProgram("model",{defines:$,overrideFog:B});const re=j.material,le=re.pbrMetallicRoughness,Q=a.paint.get("model-opacity"),ce=a.paint.get("model-emissive-strength").constantOr(0);K=Qh(w.expandedProjMatrix,Float32Array.from(d.matrix),new Float32Array(16),_,Q,le.baseColorFactor,re.emissiveFactor,le.metallicFactor,le.roughnessFactor,re,ce,a,x),D&&(S.shadowUniformsInitialized?X.setShadowUniformValues(C,D.getShadowUniformValues()):(D.setupShadows(w.toUnwrapped(),X,"model-tile",w.overscaledZ),S.shadowUniformsInitialized=!0)),q=ee.shouldRenderCutoff||Q<1||re.alphaMode!=="OPAQUE"?Fi.alphaBlended:Fi.unblended}_.uploadCommonUniforms(C,X,w.toUnwrapped(),null,ee);const ae=j.material.doubleSided?ci.disabled:ci.backCCW;if(g.instancedDataArray.length>20)Z.push(g.instancedDataBuffer),X.draw(_,C.gl.TRIANGLES,N,vi.disabled,q,ae,K,a.id,j.vertexBuffer,j.indexBuffer,j.segments,a.paint,_.transform.zoom,void 0,Z,g.instancedDataArray.length);else{const re=R?"u_instance":"u_normal_matrix";for(let le=0;le<g.instancedDataArray.length;++le)K[re]=new Float32Array(g.instancedDataArray.arrayBuffer,64*le,16),X.draw(_,C.gl.TRIANGLES,N,vi.disabled,q,ae,K,a.id,j.vertexBuffer,j.indexBuffer,j.segments,a.paint,_.transform.zoom,void 0,Z)}}if(d.children)for(const j of d.children)zp(_,a,j,g,x,w,S)}const rc=[1,-1,1];function j1(_,a,d,g){if(!d.modelManager)return!0;const x=d.modelManager;if(!d.shadowRenderer)return!0;const w=d.shadowRenderer,S=a.aabb;let C=!0,R=_.maxHeight;if(R===0){let N=0;for(const B in _.instancesPerModel){const j=x.getModel(B,g);j?N=Math.max(N,Math.max(Math.max(j.aabb.max[0],j.aabb.max[1]),j.aabb.max[2])):C=!1}R=_.maxScale*N*1.41+_.maxVerticalOffset,C&&(_.maxHeight=R)}S.max[2]=R,S.min[2]+=_.terrainElevationMin,S.max[2]+=_.terrainElevationMax,l.N.transformMat4(S.min,S.min,a.tileMatrix),l.N.transformMat4(S.max,S.max,a.tileMatrix);const D=S.intersects(w.getCurrentCascadeFrustum());return d.currentShadowCascade===0&&(_.isInsideFirstShadowMapFrustum=D===2),D===0}class $1{}class bg{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(a,d,g){{const B=this._storage.get(d.id);if(B)return B.lastUsedFrameIdx=a,B.buf}const x=g.gl,w=x.getBufferParameter(x.ELEMENT_ARRAY_BUFFER,x.BUFFER_SIZE),S=new ArrayBuffer(w),C=new Int16Array(S);x.getBufferSubData(x.ELEMENT_ARRAY_BUFFER,0,new Int16Array(S));const R=new l.cW;for(let B=0;B<w/2;B+=3){const j=C[B],$=C[B+1],Z=C[B+2];R.emplaceBack(j,$),R.emplaceBack($,Z),R.emplaceBack(Z,j)}const D=g.bindVertexArrayOES.current,N=new $1;return N.buf=new Pr(g,R),N.lastUsedFrameIdx=a,this._storage.set(d.id,N),g.bindVertexArrayOES.set(D),N.buf}update(a){for(const[d,g]of this._storage)a-g.lastUsedFrameIdx>30&&(g.buf.destroy(),this._storage.delete(d))}destroy(){for(const[a,d]of this._storage)d.buf.destroy(),this._storage.delete(a)}}class xu{registerParameter(a,d,g,x,w){}registerButton(a,d,g){}}const bu={symbol:function(_,a,d,g,x){if(_.renderPass!=="translucent")return;const w=vi.disabled,S=_.colorModeForRenderPass();d.layout.get("text-variable-anchor")&&function(D,N,B,j,$,Z,X){const K=N.transform,q=$==="map",ee=Z==="map";for(const ae of D){const re=j.getTile(ae),le=re.getBucket(B);if(!le||!le.text||!le.text.segments.get().length)continue;const Q=l.b5(le.textSizeData,K.zoom),ce=iu(ae,le.getProjection(),K),ve=K.calculatePixelsToTileUnitsMatrix(re),we=eu(ce,re.tileID.canonical,ee,q,K,le.getProjection(),ve),Ce=le.hasIconTextFit()&&le.hasIconData();if(Q){const Ue=Math.pow(2,K.zoom-re.tileID.overscaledZ);mg(le,q,ee,X,l.cx,K,we,ae,Ue,Q,Ce)}}}(g,_,d,a,d.layout.get("text-rotation-alignment"),d.layout.get("text-pitch-alignment"),x);const C=d.paint.get("icon-opacity").constantOr(1)!==0,R=d.paint.get("text-opacity").constantOr(1)!==0;d.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(C||R)?ed(_,a,d,g,w,S):(C&&ed(_,a,d,g,w,S,{onlyIcons:!0}),R&&ed(_,a,d,g,w,S,{onlyText:!0})),a.map.showCollisionBoxes&&(So(_,a,d,g,d.paint.get("text-translate"),d.paint.get("text-translate-anchor"),!0),So(_,a,d,g,d.paint.get("icon-translate"),d.paint.get("icon-translate-anchor"),!1))},circle:function(_,a,d,g){if(_.renderPass!=="translucent")return;const x=d.paint.get("circle-opacity"),w=d.paint.get("circle-stroke-width"),S=d.paint.get("circle-stroke-opacity"),C=d.layout.get("circle-sort-key").constantOr(1)!==void 0,R=d.paint.get("circle-emissive-strength");if(x.constantOr(1)===0&&(w.constantOr(1)===0||S.constantOr(1)===0))return;const D=_.context,N=D.gl,B=_.transform,j=_.depthModeForSublayer(0,li.ReadOnly),$=vi.disabled,Z=_.colorModeForDrapableLayerRenderPass(R),X=B.projection.name==="globe",K=[l.a5(B.center.lng),l.ae(B.center.lat)],q=[];for(let ae=0;ae<g.length;ae++){const re=g[ae],le=a.getTile(re),Q=le.getBucket(d);if(!Q||Q.projection.name!==B.projection.name)continue;const ce=Q.programConfigurations.get(d.id),ve=l.cy(d),we=_.isTileAffectedByFog(re);X&&ve.push("PROJECTION_GLOBE_VIEW");const Ce=_.getOrCreateProgram("circle",{config:ce,defines:ve,overrideFog:we}),Ue=Q.layoutVertexBuffer,Re=Q.globeExtVertexBuffer,Ye=Q.indexBuffer,Ge=B.projection.createInversionMatrix(B,re.canonical),pt={programConfiguration:ce,program:Ce,layoutVertexBuffer:Ue,globeExtVertexBuffer:Re,indexBuffer:Ye,uniformValues:l.cz(_,re,le,Ge,K,d),tile:le};if(C){const ke=Q.segments.get();for(const He of ke)q.push({segments:new l.aB([He]),sortKey:He.sortKey,state:pt})}else q.push({segments:Q.segments,sortKey:0,state:pt})}C&&q.sort((ae,re)=>ae.sortKey-re.sortKey);const ee={useDepthForOcclusion:B.depthOcclusionForSymbolsAndCircles};for(const ae of q){const{programConfiguration:re,program:le,layoutVertexBuffer:Q,globeExtVertexBuffer:ce,indexBuffer:ve,uniformValues:we,tile:Ce}=ae.state,Ue=ae.segments;_.terrain&&_.terrain.setupElevationDraw(Ce,le,ee),_.uploadCommonUniforms(D,le,Ce.tileID.toUnwrapped()),le.draw(_,N.TRIANGLES,j,$,Z,ci.disabled,we,d.id,Q,ve,Ue,d.paint,B.zoom,re,[ce])}},heatmap:function(_,a,d,g){if(d.paint.get("heatmap-opacity")!==0)if(_.renderPass==="offscreen"){const x=_.context,w=x.gl,S=vi.disabled,C=new Fi([w.ONE,w.ONE,w.ONE,w.ONE],l.ax.transparent,[!0,!0,!0,!0]);(function($,Z,X,K){const q=$.gl,ee=Z.width*K,ae=Z.height*K;$.activeTexture.set(q.TEXTURE1),$.viewport.set([0,0,ee,ae]);let re=X.heatmapFbo;if(!re||re&&(re.width!==ee||re.height!==ae)){re&&re.destroy();const le=q.createTexture();q.bindTexture(q.TEXTURE_2D,le),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_WRAP_S,q.CLAMP_TO_EDGE),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_WRAP_T,q.CLAMP_TO_EDGE),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MIN_FILTER,q.LINEAR),q.texParameteri(q.TEXTURE_2D,q.TEXTURE_MAG_FILTER,q.LINEAR),re=X.heatmapFbo=$.createFramebuffer(ee,ae,!0,null),function(Q,ce,ve,we,Ce,Ue){const Re=Q.gl;Re.texImage2D(Re.TEXTURE_2D,0,Q.extRenderToTextureHalfFloat?Re.RGBA16F:Re.RGBA,Ce,Ue,0,Re.RGBA,Q.extRenderToTextureHalfFloat?Re.HALF_FLOAT:Re.UNSIGNED_BYTE,null),we.colorAttachment.set(ve)}($,0,le,re,ee,ae)}else q.bindTexture(q.TEXTURE_2D,re.colorAttachment.get()),$.bindFramebuffer.set(re.framebuffer)})(x,_,d,_.transform.projection.name==="globe"?.5:.25),x.clear({color:l.ax.transparent});const R=_.transform,D=R.projection.name==="globe",N=D?["PROJECTION_GLOBE_VIEW"]:[],B=D?ci.frontCCW:ci.disabled,j=[l.a5(R.center.lng),l.ae(R.center.lat)];for(let $=0;$<g.length;$++){const Z=g[$];if(a.hasRenderableParent(Z))continue;const X=a.getTile(Z),K=X.getBucket(d);if(!K||K.projection.name!==R.projection.name)continue;const q=_.isTileAffectedByFog(Z),ee=K.programConfigurations.get(d.id),ae=_.getOrCreateProgram("heatmap",{config:ee,defines:N,overrideFog:q}),{zoom:re}=_.transform;_.terrain&&_.terrain.setupElevationDraw(X,ae),_.uploadCommonUniforms(x,ae,Z.toUnwrapped());const le=R.projection.createInversionMatrix(R,Z.canonical);ae.draw(_,w.TRIANGLES,li.disabled,S,C,B,Ep(_,Z,X,le,j,re,d.paint.get("heatmap-intensity")),d.id,K.layoutVertexBuffer,K.indexBuffer,K.segments,d.paint,_.transform.zoom,ee,D?[K.globeExtVertexBuffer]:null)}x.viewport.set([0,0,_.width,_.height])}else _.renderPass==="translucent"&&(_.context.setColorMode(_.colorModeForRenderPass()),function(x,w){const S=x.context,C=S.gl,R=w.heatmapFbo;if(!R)return;S.activeTexture.set(C.TEXTURE0),C.bindTexture(C.TEXTURE_2D,R.colorAttachment.get()),S.activeTexture.set(C.TEXTURE1);let D=w.colorRampTexture;D||(D=w.colorRampTexture=new l.T(S,w.colorRamp,C.RGBA)),D.bind(C.LINEAR,C.CLAMP_TO_EDGE),x.getOrCreateProgram("heatmapTexture").draw(x,C.TRIANGLES,li.disabled,vi.disabled,x.colorModeForRenderPass(),ci.disabled,((N,B,j,$)=>({u_image:0,u_color_ramp:1,u_opacity:B.paint.get("heatmap-opacity")}))(0,w),w.id,x.viewportBuffer,x.quadTriangleIndexBuffer,x.viewportSegments,w.paint,x.transform.zoom)}(_,d))},line:function(_,a,d,g){if(_.renderPass!=="translucent")return;const x=d.paint.get("line-opacity"),w=d.paint.get("line-width");if(x.constantOr(1)===0||w.constantOr(1)===0)return;const S=d.paint.get("line-emissive-strength"),C=_.depthModeForSublayer(0,li.ReadOnly),R=_.colorModeForDrapableLayerRenderPass(S),D=_.terrain&&_.terrain.renderingToTexture?1:l.f.devicePixelRatio,N=d.paint.get("line-dasharray"),B=N.constantOr(1),j=d.layout.get("line-cap"),$=d.paint.get("line-pattern"),Z=$.constantOr(1),X=d.paint.get("line-pattern").constantOr(1),K=d.paint.get("line-opacity").constantOr(1)!==1;let q=!X&&K;const ee=d.paint.get("line-gradient"),ae=Z?"linePattern":"line",re=_.context,le=re.gl,Q=l.cA(d);_.terrain&&_.terrain.clipOrMaskOverlapStencilType()&&(q=!1);for(const ce of g){const ve=a.getTile(ce);if(Z&&!ve.patternsLoaded())continue;const we=ve.getBucket(d);if(!we)continue;_.prepareDrawTile();const Ce=we.programConfigurations.get(d.id),Ue=_.isTileAffectedByFog(ce),Re=_.getOrCreateProgram(ae,{config:Ce,defines:Q,overrideFog:Ue}),Ye=$.constantOr(null);if(Ye&&ve.imageAtlas){const Mt=ve.imageAtlas.patternPositions[Ye.toString()];Mt&&Ce.setConstantPatternPositions(Mt)}const Ge=N.constantOr(null),pt=j.constantOr(null);if(!Z&&Ge&&pt&&ve.lineAtlas){const Mt=ve.lineAtlas.getDash(Ge,pt);Mt&&Ce.setConstantPatternPositions(Mt)}let[ke,He]=d.paint.get("line-trim-offset");(pt==="round"||pt==="square")&&ke!==He&&(ke===0&&(ke-=1),He===1&&(He+=1));const Me=_.terrain?ce.projMatrix:null,Ne=Z?l.cB(_,ve,d,Me,D,[ke,He]):l.cC(_,ve,d,Me,we.lineClipsArray.length,D,[ke,He]);if(ee){const Mt=we.gradients[d.id];let Tt=Mt.texture;if(d.gradientVersion!==Mt.version){let Lt=256;if(d.stepInterpolant){const Zt=a.getSource().maxzoom,si=ce.canonical.z===Zt?Math.ceil(1<<_.transform.maxZoom-ce.canonical.z):1;Lt=l.aa(l.cD(we.maxLineLength/l.V*1024*si),256,re.maxTextureSize)}Mt.gradient=l.cE({expression:d.gradientExpression(),evaluationKey:"lineProgress",resolution:Lt,image:Mt.gradient||void 0,clips:we.lineClipsArray}),Mt.texture?Mt.texture.update(Mt.gradient):Mt.texture=new l.T(re,Mt.gradient,le.RGBA),Mt.version=d.gradientVersion,Tt=Mt.texture}re.activeTexture.set(le.TEXTURE1),Tt.bind(d.stepInterpolant?le.NEAREST:le.LINEAR,le.CLAMP_TO_EDGE)}B&&(re.activeTexture.set(le.TEXTURE0),ve.lineAtlasTexture&&ve.lineAtlasTexture.bind(le.LINEAR,le.REPEAT),Ce.updatePaintBuffers()),Z&&(re.activeTexture.set(le.TEXTURE0),ve.imageAtlasTexture&&ve.imageAtlasTexture.bind(le.LINEAR,le.CLAMP_TO_EDGE),Ce.updatePaintBuffers()),_.uploadCommonUniforms(re,Re,ce.toUnwrapped());const mt=Mt=>{Re.draw(_,le.TRIANGLES,C,Mt,R,ci.disabled,Ne,d.id,we.layoutVertexBuffer,we.indexBuffer,we.segments,d.paint,_.transform.zoom,Ce,[we.layoutVertexBuffer2])};if(q){const Mt=_.stencilModeForClipping(ce).ref;Mt===0&&_.terrain&&re.clear({stencil:0});const Tt={func:le.EQUAL,mask:255};Ne.u_alpha_discard_threshold=.8,mt(new vi(Tt,Mt,255,le.KEEP,le.KEEP,le.INVERT)),Ne.u_alpha_discard_threshold=0,mt(new vi(Tt,Mt,255,le.KEEP,le.KEEP,le.KEEP))}else mt(_.stencilModeForClipping(ce))}q&&(_.resetStencilClippingMasks(),_.terrain&&re.clear({stencil:0}))},fill:function(_,a,d,g){const x=d.paint.get("fill-color"),w=d.paint.get("fill-opacity");if(w.constantOr(1)===0)return;const S=d.paint.get("fill-emissive-strength"),C=_.colorModeForDrapableLayerRenderPass(S),R=d.paint.get("fill-pattern"),D=_.opaquePassEnabledForLayer()&&!R.constantOr(1)&&x.constantOr(l.ax.transparent).a===1&&w.constantOr(0)===1?"opaque":"translucent";if(_.renderPass===D){const N=_.depthModeForSublayer(1,_.renderPass==="opaque"?li.ReadWrite:li.ReadOnly);gl(_,a,d,g,N,C,!1)}if(_.renderPass==="translucent"&&d.paint.get("fill-antialias")){const N=_.depthModeForSublayer(d.getPaintProperty("fill-outline-color")?2:0,li.ReadOnly);gl(_,a,d,g,N,C,!0)}},"fill-extrusion":function(_,a,d,g){const x=d.paint.get("fill-extrusion-opacity"),w=_.context,S=w.gl,C=_.terrain,R=C&&C.renderingToTexture;if(x===0)return;const D=_.conflationActive&&_.layerUsedInConflation(d,a.getSource());if(D&&function(N,B,j,$){for(const Z of $){const X=B.getTile(Z).getBucket(j);X&&(X.updateReplacement(Z,N.replacementSource),X.uploadCentroid(N.context))}}(_,a,d,g),C||D)for(const N of g){const B=a.getTile(N).getBucket(d);B&&z1(_.context,a,N,B,d,C,D)}if(_.renderPass==="shadow"&&_.shadowRenderer){const N=_.shadowRenderer;if(C&&x<.65&&d._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof l.Z)return;const B=N.getShadowPassDepthMode(),j=N.getShadowPassColorMode();Yt(_,a,d,g,B,vi.disabled,j,D)}else if(_.renderPass==="translucent"){const N=!d.paint.get("fill-extrusion-pattern").constantOr(1),B=d.paint.get("fill-extrusion-color").constantOr(l.ax.white);if(!R&&B.a!==0){const j=new li(_.context.gl.LEQUAL,li.ReadWrite,_.depthRangeFor3D);x===1&&N?Yt(_,a,d,g,j,vi.disabled,Fi.unblended,D):(Yt(_,a,d,g,j,vi.disabled,Fi.disabled,D),Yt(_,a,d,g,j,_.stencilModeFor3D(),_.colorModeForRenderPass(),D),_.resetStencilClippingMasks())}if(_.style.enable3dLights()&&N&&(!C&&_.transform.projection.name!=="globe"||R)){const j=d.paint.get("fill-extrusion-opacity"),$=d.paint.get("fill-extrusion-ambient-occlusion-intensity"),Z=d.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),X=d.paint.get("fill-extrusion-flood-light-intensity"),K=d.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),q=$>0&&Z>0,ee=X>0,ae=(le,Q,ce)=>(1-ce)*le+ce*Q,re=le=>{const Q=_.depthModeForSublayer(1,li.ReadOnly,S.LEQUAL,!0),ce=d.paint.get(le?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ve=ae(.1,3,ce),we=_._showOverdrawInspector;if(!we){const Ce=new vi({func:S.ALWAYS,mask:255},255,255,S.KEEP,S.KEEP,S.REPLACE),Ue=new Fi([S.ONE,S.ONE,S.ONE,S.ONE],l.ax.transparent,[!1,!1,!1,!0],S.MIN);La(_,a,d,g,Q,Ce,Ue,ci.disabled,le,"sdf",j,$,Z,X,K,ve,D,!1)}{const Ce=we?vi.disabled:new vi({func:S.EQUAL,mask:255},255,255,S.KEEP,S.DECR,S.DECR),Ue=we?_.colorModeForRenderPass():new Fi([S.ONE_MINUS_DST_ALPHA,S.DST_ALPHA,S.ONE,S.ONE],l.ax.transparent,[!0,!0,!0,!0]);La(_,a,d,g,Q,Ce,Ue,ci.disabled,le,"color",j,$,Z,X,K,ve,D,!1)}};if(R){const le=(Q,ce,ve)=>{const we=_.depthModeForSublayer(1,li.ReadOnly,S.LEQUAL,!1),Ce=d.paint.get(Q?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Ue=ae(.1,3,Ce);{const Re=new Fi([S.ONE,S.ONE,S.ONE,S.ONE],l.ax.transparent,[!1,!1,!1,!0]);La(_,a,d,g,we,vi.disabled,Re,ci.disabled,Q,"clear",j,$,Z,X,K,Ue,D,ce)}{const Re=new vi({func:S.ALWAYS,mask:255},255,255,S.KEEP,S.KEEP,S.REPLACE),Ye=new Fi([S.ONE,S.ONE,S.ONE,S.ONE],l.ax.transparent,[!1,!1,!1,!0],S.MIN);La(_,a,d,g,we,Re,Ye,ci.disabled,Q,"sdf",j,$,Z,X,K,Ue,D,ce)}{const Re=Q?S.ZERO:S.ONE_MINUS_DST_ALPHA,Ye=new vi({func:S.EQUAL,mask:255},255,255,S.KEEP,S.DECR,S.DECR),Ge=new Fi([Re,S.DST_ALPHA,S.ONE_MINUS_DST_ALPHA,S.ZERO],l.ax.transparent,[!0,!0,!0,!0]);La(_,a,d,g,we,Ye,Ge,ci.disabled,Q,"color",j,$,Z,X,K,Ue,D,ce)}{const Re=new Fi([S.ONE,S.ONE,S.ONE,Q?S.ZERO:S.ONE],l.ax.transparent,[!1,!1,!1,!0],Q?S.FUNC_ADD:S.MAX);La(_,a,d,g,we,vi.disabled,Re,ci.disabled,Q,"clear",j,$,Z,X,K,Ue,D,ce,ve)}};if(q||ee){let Q;if(_.prepareDrawTile(),C){const ce=C.drapeBufferSize[0],ve=C.drapeBufferSize[1];Q=C.framebufferCopyTexture,Q&&(!Q||Q.size[0]===ce&&Q.size[1]===ve)||(Q&&Q.destroy(),Q=C.framebufferCopyTexture=new l.T(w,new l.h({width:ce,height:ve}),S.RGBA)),Q.bind(S.LINEAR,S.CLAMP_TO_EDGE),S.copyTexImage2D(S.TEXTURE_2D,0,S.RGBA,0,0,ce,ve,0)}q&&le(!0,!1,Q),ee&&le(!1,!0,Q)}}else q&&re(!0),ee&&re(!1)}}},hillshade:function(_,a,d,g){if(_.renderPass!=="offscreen"&&_.renderPass!=="translucent"||_.style.disableElevatedTerrain)return;const x=_.context,w=_.terrain&&_.terrain.renderingToTexture,[S,C]=_.renderPass!=="translucent"||w?[{},g]:_.stencilConfigForOverlap(g);for(const R of C){const D=a.getTile(R);if(D.needsHillshadePrepare&&_.renderPass==="offscreen")hp(_,D,d);else if(_.renderPass==="translucent"){const N=_.depthModeForSublayer(0,li.ReadOnly),B=d.paint.get("hillshade-emissive-strength"),j=_.colorModeForDrapableLayerRenderPass(B),$=w&&_.terrain?_.terrain.stencilModeForRTTOverlap(R):S[R.overscaledZ];Gh(_,R,D,d,N,$,j)}}x.viewport.set([0,0,_.width,_.height]),_.resetStencilClippingMasks()},raster:function(_,a,d,g,x,w){if(_.renderPass!=="translucent"||d.paint.get("raster-opacity")===0)return;const S=_.transform.projection.name==="globe",C=d.paint.get("raster-elevation")!==0,R=C&&S;if(_.renderElevatedRasterBackface&&!R)return;const D=_.context,N=D.gl,B=a.getSource(),j=function(Q,ce,ve,we){const Ce=ce.paint.get("raster-color"),Ue=Q.type==="raster-array",Re=[],Ye=ce.paint.get("raster-resampling"),Ge=ce.paint.get("raster-color-mix");let pt=ce.paint.get("raster-color-range");const ke=[Ge[0],Ge[1],Ge[2],0],He=Ge[3];let Me=Ye==="nearest"?we.NEAREST:we.LINEAR;if(Ue&&(Re.push("RASTER_ARRAY"),Ce||Re.push("RASTER_COLOR"),Ye==="linear"&&Re.push("RASTER_ARRAY_LINEAR"),Me=we.NEAREST,!pt&&Q.rasterLayers)){const Ne=Q.rasterLayers.find(({id:mt})=>mt===ce.sourceLayer);Ne&&Ne.fields&&Ne.fields.range&&(pt=Ne.fields.range)}if(pt=pt||[0,1],Ce){Re.push("RASTER_COLOR"),ve.activeTexture.set(we.TEXTURE2),ce.updateColorRamp(pt);let Ne=ce.colorRampTexture;Ne||(Ne=ce.colorRampTexture=new l.T(ve,ce.colorRamp,we.RGBA)),Ne.bind(we.LINEAR,we.CLAMP_TO_EDGE)}return{mix:ke,range:pt,offset:He,defines:Re,resampling:Me}}(B,d,D,N);if(B instanceof l.ap&&!g.length&&!S)return;const $=d.paint.get("raster-emissive-strength"),Z=_.colorModeForDrapableLayerRenderPass($),X=_.terrain&&_.terrain.renderingToTexture,K=!_.options.moving,q=d.paint.get("raster-resampling")==="nearest"?N.NEAREST:N.LINEAR;if(B instanceof l.ap&&!g.length&&(B.onNorthPole||B.onSouthPole)){const Q=C?_.stencilModeFor3D():vi.disabled;return void Cp(!!B.onNorthPole,null,_,a,d,$,j,ci.disabled,Q)}if(!g.length)return;const[ee,ae]=B instanceof l.ap||X?[{},g]:_.stencilConfigForOverlap(g),re=ae[ae.length-1].overscaledZ;R&&j.defines.push("PROJECTION_GLOBE_VIEW"),C&&j.defines.push("RENDER_CUTOFF");const le=(Q,ce,ve)=>{for(const we of Q){const Ce=we.toUnwrapped(),Ue=a.getTile(we);if(X&&(!Ue||!Ue.hasData()))continue;D.activeTexture.set(N.TEXTURE0);const Re=Ip(Ue,B,d,j);if(!Re||!Re.texture)continue;const{texture:Ye,mix:Ge,offset:pt,tileSize:ke,buffer:He}=Re;let Me,Ne;X?(Me=li.disabled,Ne=we.projMatrix):C?(Me=new li(N.LEQUAL,li.ReadWrite,_.depthRangeFor3D),Ne=S?Float32Array.from(_.transform.expandedFarZProjMatrix):_.transform.calculateProjMatrix(Ce,K)):(Me=_.depthModeForSublayer(we.overscaledZ-re,d.paint.get("raster-opacity")===1?li.ReadWrite:li.ReadOnly,N.LESS),Ne=_.transform.calculateProjMatrix(Ce,K));const mt=_.terrain&&X?_.terrain.stencilModeForRTTOverlap(we):ee[we.overscaledZ],Mt=w?0:d.paint.get("raster-fade-duration");Ue.registerFadeDuration(Mt);const Tt=a.findLoadedParent(we,0),Lt=mp(Ue,Tt,a,_.transform,Mt);let Zt,si;_.terrain&&_.terrain.prepareDrawTile(),D.activeTexture.set(N.TEXTURE0),Ye.bind(q,N.CLAMP_TO_EDGE),D.activeTexture.set(N.TEXTURE1),Tt?(Tt.texture&&Tt.texture.bind(q,N.CLAMP_TO_EDGE),Zt=Math.pow(2,Tt.tileID.overscaledZ-Ue.tileID.overscaledZ),si=[Ue.tileID.canonical.x*Zt%1,Ue.tileID.canonical.y*Zt%1]):Ye.bind(q,N.CLAMP_TO_EDGE),Ye.useMipmap&&D.extTextureFilterAnisotropic&&_.transform.pitch>20&&N.texParameterf(N.TEXTURE_2D,D.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,D.extTextureFilterAnisotropicMax);const ei=_.transform;let ii;const Ii=C?Pp(ei):[0,0,0,0];let gi,Ti,wi,Qi,Vr,Ui=0;if(R&&B instanceof l.ap&&B.coordinates.length>3)gi=Float32Array.from(l.aT(l.ci(new l.bs(0,0,0)))),Ti=Float32Array.from(ei.globeMatrix),wi=Float32Array.from(l.ce(ei)),Qi=[l.a5(ei.center.lng),l.ae(ei.center.lat)],ii=B.elevatedGlobePerspectiveTransform,Vr=B.elevatedGlobeGridMatrix||new Float32Array(9);else if(R){const ji=l.cf(we.canonical);Ui=l.cg(ji.getCenter().lat),gi=Float32Array.from(l.aT(l.ci(we.canonical))),Ti=Float32Array.from(ei.globeMatrix),wi=Float32Array.from(l.ce(ei)),Qi=[l.a5(ei.center.lng),l.ae(ei.center.lat)],ii=[0,0],Vr=Float32Array.from(l.ch(we.canonical,ji,Ui,ei.worldSize/ei._pixelsPerMercatorPixel))}else ii=B instanceof l.ap?B.perspectiveTransform:[0,0],gi=new Float32Array(16),Ti=new Float32Array(9),wi=new Float32Array(16),Qi=[0,0],Vr=new Float32Array(9);const pn=Sp(Ne,gi,Ti,wi,Vr,si||[0,0],l.S(_.transform.zoom),Qi,Ii,Zt||1,Lt,d,ii,C?d.paint.get("raster-elevation"):0,2,Ge,pt,j.range,ke,He,$),Vi=_.isTileAffectedByFog(we),lr=_.getOrCreateProgram("raster",{defines:j.defines,overrideFog:Vi});if(_.uploadCommonUniforms(D,lr,Ce),B instanceof l.ap){const ji=B.elevatedGlobeVertexBuffer,sr=B.elevatedGlobeIndexBuffer;if(X||!S)B.boundsBuffer&&B.boundsSegments&&lr.draw(_,N.TRIANGLES,Me,vi.disabled,Z,ci.disabled,pn,d.id,B.boundsBuffer,_.quadTriangleIndexBuffer,B.boundsSegments);else if(ji&&sr){const Xr=ei.zoom<=l.bG?B.elevatedGlobeSegments:B.getSegmentsForLongitude(ei.center.lng);Xr&&lr.draw(_,N.TRIANGLES,Me,vi.disabled,Z,ce,pn,d.id,ji,sr,Xr)}}else if(R){Me=new li(N.LEQUAL,li.ReadOnly,_.depthRangeFor3D);const ji=_.globeSharedBuffers;if(ji){const[sr,Xr,gr]=ji.getGridBuffers(Ui,!1);lr.draw(_,N.TRIANGLES,Me,ve||mt,_.colorModeForRenderPass(),ce,pn,d.id,sr,Xr,gr)}}else{const{tileBoundsBuffer:ji,tileBoundsIndexBuffer:sr,tileBoundsSegments:Xr}=_.getTileBoundsBuffers(Ue);lr.draw(_,N.TRIANGLES,Me,mt,Z,ci.disabled,pn,d.id,ji,sr,Xr)}}if(!(B instanceof l.ap)&&R)for(const we of Q){const Ce=we.canonical.y===(1<<we.canonical.z)-1;we.canonical.y===0&&Cp(!0,we,_,a,d,$,j,ce,ve||vi.disabled),Ce&&Cp(!1,we,_,a,d,$,j,ce===ci.frontCW?ci.backCW:ci.frontCW,ve||vi.disabled)}};R?le(ae,_.renderElevatedRasterBackface?ci.backCW:ci.frontCW,_.stencilModeFor3D()):le(ae,ci.disabled,void 0),_.resetStencilClippingMasks()},"raster-particle":function(_,a,d,g,x,w){_.renderPass==="offscreen"&&function(S,C,R,D){if(!D.length)return;const N=S.context,B=N.gl,j=C.getSource();if(!(j instanceof vt))return;const $=[];for(const K of D){const q=C.getTile(K);if(!(q instanceof cl))continue;const ee=Rp(q,j,R);if(!ee)continue;const ae=[ee.tileSize,ee.tileSize];let re=R.tileFramebuffer;re||(re=R.tileFramebuffer=N.createFramebuffer(ae[0],ae[1],!0,null));let le=q.rasterParticleState;const Q=R.paint.get("raster-particle-count");le||(le=q.rasterParticleState=new qn(N,K,ae,Q));const ce=le.update(R.lastInvalidatedAt);le.numParticles!==Q&&le.setNumParticles(K,Q);const ve=le.targetColorTexture;le.targetColorTexture=le.backgroundColorTexture,le.backgroundColorTexture=ve;const we=le.particleVertices0;le.particleVertices0=le.particleVertices1,le.particleVertices1=we,$.push([K,ee,le,ce])}if($.length===0)return;const Z=l.f.now(),X=R.previousDrawTimestamp?.001*(Z-R.previousDrawTimestamp):.0167;if(R.previousDrawTimestamp=Z,R.hasColorMap()){N.activeTexture.set(B.TEXTURE0+2);let K=R.colorRampTexture;K||(K=R.colorRampTexture=new l.T(N,R.colorRamp,B.RGBA)),K.bind(B.LINEAR,B.CLAMP_TO_EDGE)}N.bindFramebuffer.set(R.tileFramebuffer.framebuffer),N.activeTexture.set(B.TEXTURE0),function(K,q,ee){const ae=K.context,re=ae.gl,le=q.tileFramebuffer;ae.activeTexture.set(re.TEXTURE0);const Q={u_texture:0,u_opacity:1.05*(ve=q.paint.get("raster-particle-fade-opacity-factor"))/(ve+.05)},ce=K.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var ve;for(const we of ee){const[,,Ce,Ue]=we;le.colorAttachment.set(Ce.targetColorTexture.texture),ae.viewport.set([0,0,le.width,le.height]),ae.clear({color:l.ax.transparent}),Ue&&(Ce.backgroundColorTexture.bind(re.NEAREST,re.CLAMP_TO_EDGE),ce.draw(K,re.TRIANGLES,li.disabled,vi.disabled,Fi.alphaBlended,ci.disabled,Q,q.id,K.viewportBuffer,K.quadTriangleIndexBuffer,K.viewportSegments))}}(S,R,$),function(K,q,ee,ae){const re=K.context.gl,le=ee.tileFramebuffer,Q=K.transform.projection.name==="globe",ce=ee.paint.get("raster-particle-max-speed");for(const ve of ae){const[we,Ce,Ue]=ve;Ce.texture.bind(re.LINEAR,re.CLAMP_TO_EDGE),le.colorAttachment.set(Ue.targetColorTexture.texture);const Re=K.getOrCreateProgram("rasterParticleDraw",{defines:Ce.defines,overrideFog:!1}),Ye=Ce.scalarData?[]:[0,1,2,3].map(ke=>l.cG[ke](we));Ye.push(we);const Ge=we.canonical.x,pt=we.canonical.y;for(const ke of Ye){const He=q.getTile(Q?ke.wrapped():ke);if(!He)continue;const Me=He.rasterParticleState;if(!Me)continue;const Ne=F1([ke.canonical.x+(1<<ke.canonical.z)*(ke.wrap-we.wrap)-Ge,ke.canonical.y-pt],0,Ce.texture.size,2,ce,Ce.textureOffset,Ce.scale,Ce.offset);Re.draw(K,re.POINTS,li.disabled,vi.disabled,Fi.alphaBlended,ci.disabled,Ne,ee.id,Me.particleVertices0,void 0,Me.particleSegment)}}}(S,C,R,$),function(K,q,ee,ae){const re=K.context.gl;let le=q.transformFeedbackObject;le||(le=q.transformFeedbackObject=re.createTransformFeedback()),re.bindTransformFeedback(re.TRANSFORM_FEEDBACK,q.transformFeedbackObject);const Q=q.paint.get("raster-particle-max-speed"),ce=ae*q.paint.get("raster-particle-speed-factor")*.3,ve=(we=q.paint.get("raster-particle-reset-rate-factor"),Math.pow(we,6));var we;for(const Ce of ee){const[,Ue,Re]=Ce;Ue.texture.bind(re.LINEAR,re.CLAMP_TO_EDGE);const Ye=fg(0,Ue.texture.size,Q,ce,ve,Ue.textureOffset,Ue.scale,Ue.offset);K.getOrCreateProgram("rasterParticleUpdate",{defines:Ue.defines,transformFeedback:{bufferMode:re.SEPARATE_ATTRIBS,shaderVaryings:["v_new_particle"]}}).draw(K,re.POINTS,li.disabled,vi.disabled,Fi.disabled,ci.disabled,Ye,q.id,Re.particleVertices0,void 0,Re.particleSegment,{},void 0,void 0,void 0,void 0,[{buffer:Re.particleVertices1,targetIndex:0}])}re.bindTransformFeedback(re.TRANSFORM_FEEDBACK,null)}(S,R,$,X)}(_,a,d,g),_.renderPass==="translucent"&&(function(S,C,R,D,N){const B=S.context,j=B.gl,$=!S.options.moving,Z=S.transform.projection.name==="globe";if(!D.length)return;const[X,K]=S.stencilConfigForOverlap(D),q=[];Z&&q.push("PROJECTION_GLOBE_VIEW");for(const ee of K){const ae=ee.toUnwrapped(),re=C.getTile(ee);if(!re.rasterParticleState)continue;const le=re.rasterParticleState,Q=100;re.registerFadeDuration(Q);const ce=C.findLoadedParent(ee,0),ve=mp(re,ce,C,S.transform,Q);let we,Ce;S.terrain&&S.terrain.prepareDrawTile(),B.activeTexture.set(j.TEXTURE0),le.targetColorTexture.bind(j.LINEAR,j.CLAMP_TO_EDGE),B.activeTexture.set(j.TEXTURE1),ce&&ce.rasterParticleState?(ce.rasterParticleState.targetColorTexture.bind(j.LINEAR,j.CLAMP_TO_EDGE),we=Math.pow(2,ce.tileID.overscaledZ-re.tileID.overscaledZ),Ce=[re.tileID.canonical.x*we%1,re.tileID.canonical.y*we%1]):le.targetColorTexture.bind(j.LINEAR,j.CLAMP_TO_EDGE);const Ue=Z?Float32Array.from(S.transform.expandedFarZProjMatrix):S.transform.calculateProjMatrix(ae,$),Re=S.transform,Ye=Op(Re),Ge=l.cf(ee.canonical),pt=l.cg(Ge.getCenter().lat);let ke,He,Me,Ne,mt;Z?(ke=Float32Array.from(l.aT(l.ci(ee.canonical))),He=Float32Array.from(Re.globeMatrix),Me=Float32Array.from(l.ce(Re)),Ne=[l.a5(Re.center.lng),l.ae(Re.center.lat)],mt=Float32Array.from(l.ch(ee.canonical,Ge,pt,Re.worldSize/Re._pixelsPerMercatorPixel))):(ke=new Float32Array(16),He=new Float32Array(9),Me=new Float32Array(16),Ne=[0,0],mt=new Float32Array(9));const Mt=N1(Ue,ke,He,Me,mt,Ce||[0,0],l.S(S.transform.zoom),Ne,Ye,we||1,ve,250),Tt=S.isTileAffectedByFog(ee),Lt=S.getOrCreateProgram("rasterParticle",{defines:q,overrideFog:Tt});if(S.uploadCommonUniforms(B,Lt,ae),Z){const Zt=new li(j.LEQUAL,li.ReadWrite,S.depthRangeFor3D),si=0,ei=S.globeSharedBuffers;if(ei){const[ii,Ii,gi]=ei.getGridBuffers(pt,si!==0);Lt.draw(S,j.TRIANGLES,Zt,vi.disabled,Fi.alphaBlended,ci.backCCW,Mt,R.id,ii,Ii,gi)}}else{const Zt=S.depthModeForSublayer(0,li.ReadOnly),si=X[ee.overscaledZ],{tileBoundsBuffer:ei,tileBoundsIndexBuffer:ii,tileBoundsSegments:Ii}=S.getTileBoundsBuffers(re);Lt.draw(S,j.TRIANGLES,Zt,si,Fi.alphaBlended,ci.disabled,Mt,R.id,ei,ii,Ii)}}S.resetStencilClippingMasks()}(_,a,d,g),_.style.map.triggerRepaint())},background:function(_,a,d,g){const x=d.paint.get("background-color"),w=d.paint.get("background-opacity"),S=d.paint.get("background-emissive-strength");if(w===0)return;const C=_.context,R=C.gl,D=_.transform,N=D.tileSize,B=d.paint.get("background-pattern");if(_.isPatternMissing(B,d.scope))return;const j=!B&&x.a===1&&w===1&&_.opaquePassEnabledForLayer()?"opaque":"translucent";if(_.renderPass!==j)return;const $=vi.disabled,Z=_.depthModeForSublayer(0,j==="opaque"?li.ReadWrite:li.ReadOnly),X=_.colorModeForDrapableLayerRenderPass(S),K=B?"backgroundPattern":"background";let q,ee=g;ee||(q=_.getBackgroundTiles(),ee=Object.values(q).map(ae=>ae.tileID)),B&&(C.activeTexture.set(R.TEXTURE0),_.imageManager.bind(_.context,d.scope));for(const ae of ee){const re=_.isTileAffectedByFog(ae),le=_.getOrCreateProgram(K,{overrideFog:re}),Q=ae.toUnwrapped(),ce=g?ae.projMatrix:_.transform.calculateProjMatrix(Q);_.prepareDrawTile();const ve=a?a.getTile(ae):q?q[ae.key]:new Sa(ae,N,D.zoom,_),we=B?fu(ce,S,w,_,B,d.scope,{tileID:ae,tileSize:N}):Ap(ce,S,w,x);_.uploadCommonUniforms(C,le,Q);const{tileBoundsBuffer:Ce,tileBoundsIndexBuffer:Ue,tileBoundsSegments:Re}=_.getTileBoundsBuffers(ve);le.draw(_,R.TRIANGLES,Z,$,X,ci.disabled,we,d.id,Ce,Ue,Re)}},sky:function(_,a,d){const g=_._atmosphere?l.S(_.transform.zoom):1,x=d.paint.get("sky-opacity")*g;if(x===0)return;const w=_.context,S=d.paint.get("sky-type"),C=new li(w.gl.LEQUAL,li.ReadOnly,[0,1]),R=_.frameCounter/1e3%1;S==="atmosphere"?_.renderPass==="offscreen"?d.needsSkyboxCapture(_)&&(function(D,N,B,j){const $=D.context,Z=$.gl;let X=N.skyboxFbo;if(!X){X=N.skyboxFbo=$.createFramebuffer(32,32,!0,null),N.skyboxGeometry=new Fp($),N.skyboxTexture=$.gl.createTexture(),Z.bindTexture(Z.TEXTURE_CUBE_MAP,N.skyboxTexture),Z.texParameteri(Z.TEXTURE_CUBE_MAP,Z.TEXTURE_WRAP_S,Z.CLAMP_TO_EDGE),Z.texParameteri(Z.TEXTURE_CUBE_MAP,Z.TEXTURE_WRAP_T,Z.CLAMP_TO_EDGE),Z.texParameteri(Z.TEXTURE_CUBE_MAP,Z.TEXTURE_MIN_FILTER,Z.LINEAR),Z.texParameteri(Z.TEXTURE_CUBE_MAP,Z.TEXTURE_MAG_FILTER,Z.LINEAR);for(let ae=0;ae<6;++ae)Z.texImage2D(Z.TEXTURE_CUBE_MAP_POSITIVE_X+ae,0,Z.RGBA,32,32,0,Z.RGBA,Z.UNSIGNED_BYTE,null)}$.bindFramebuffer.set(X.framebuffer),$.viewport.set([0,0,32,32]);const K=N.getCenter(D,!0),q=D.getOrCreateProgram("skyboxCapture"),ee=new Float64Array(16);l.a6.identity(ee),l.a6.rotateY(ee,ee,.5*-Math.PI),yl(D,N,q,ee,K,0),l.a6.identity(ee),l.a6.rotateY(ee,ee,.5*Math.PI),yl(D,N,q,ee,K,1),l.a6.identity(ee),l.a6.rotateX(ee,ee,.5*-Math.PI),yl(D,N,q,ee,K,2),l.a6.identity(ee),l.a6.rotateX(ee,ee,.5*Math.PI),yl(D,N,q,ee,K,3),l.a6.identity(ee),yl(D,N,q,ee,K,4),l.a6.identity(ee),l.a6.rotateY(ee,ee,Math.PI),yl(D,N,q,ee,K,5),$.viewport.set([0,0,D.width,D.height])}(_,d),d.markSkyboxValid(_)):_.renderPass==="sky"&&function(D,N,B,j,$){const Z=D.context,X=Z.gl,K=D.transform,q=D.getOrCreateProgram("skybox");Z.activeTexture.set(X.TEXTURE0),X.bindTexture(X.TEXTURE_CUBE_MAP,N.skyboxTexture);const ee=((ae,re,le,Q,ce)=>({u_matrix:ae,u_sun_direction:re,u_cubemap:0,u_opacity:Q,u_temporal_offset:ce}))(K.skyboxMatrix,N.getCenter(D,!1),0,j,$);D.uploadCommonUniforms(Z,q),q.draw(D,X.TRIANGLES,B,vi.disabled,D.colorModeForRenderPass(),ci.backCW,ee,"skybox",N.skyboxGeometry.vertexBuffer,N.skyboxGeometry.indexBuffer,N.skyboxGeometry.segment)}(_,d,C,x,R):S==="gradient"&&_.renderPass==="sky"&&function(D,N,B,j,$){const Z=D.context,X=Z.gl,K=D.transform,q=D.getOrCreateProgram("skyboxGradient");N.skyboxGeometry||(N.skyboxGeometry=new Fp(Z)),Z.activeTexture.set(X.TEXTURE0);let ee=N.colorRampTexture;ee||(ee=N.colorRampTexture=new l.T(Z,N.colorRamp,X.RGBA)),ee.bind(X.LINEAR,X.CLAMP_TO_EDGE);const ae=((re,le,Q,ce,ve)=>({u_matrix:re,u_color_ramp:0,u_center_direction:le,u_radius:l.bj(Q),u_opacity:ce,u_temporal_offset:ve}))(K.skyboxMatrix,N.getCenter(D,!1),N.paint.get("sky-gradient-radius"),j,$);D.uploadCommonUniforms(Z,q),q.draw(D,X.TRIANGLES,B,vi.disabled,D.colorModeForRenderPass(),ci.backCW,ae,"skyboxGradient",N.skyboxGeometry.vertexBuffer,N.skyboxGeometry.indexBuffer,N.skyboxGeometry.segment)}(_,d,C,x,R)},debug:function(_,a,d,g,x,w){for(let S=0;S<d.length;S++)if(x){const D=new l.ax(g.r*.8,g.g*.8,g.b*.8,1);Fa(_,a,d[S],g,-1,-1,w),Fa(_,a,d[S],g,-1,1,w),Fa(_,a,d[S],g,1,1,w),Fa(_,a,d[S],g,1,-1,w),Fa(_,a,d[S],D,0,0,w)}else Fa(_,a,d[S],g,0,0,w)},custom:function(_,a,d,g){const x=_.context,w=d.implementation;if(!_.transform.projection.unsupportedLayers||!_.transform.projection.unsupportedLayers.includes("custom")||_.terrain&&(_.terrain.renderingToTexture||_.renderPass==="offscreen")&&d.isLayerDraped(a)){if(_.renderPass==="offscreen"){const S=w.prerender;if(S){if(_.setCustomLayerDefaults(),x.setColorMode(_.colorModeForRenderPass()),_.transform.projection.name==="globe"){const C=_.transform.pointMerc;S.call(w,x.gl,_.transform.customLayerMatrix(),_.transform.getProjection(),_.transform.globeToMercatorMatrix(),l.S(_.transform.zoom),[C.x,C.y],_.transform.pixelsPerMeterRatio)}else S.call(w,x.gl,_.transform.customLayerMatrix());x.setDirty(),_.setBaseState()}}else if(_.renderPass==="translucent"){if(_.terrain&&_.terrain.renderingToTexture){const C=w.renderToTile;if(C){const R=g[0].canonical,D=new l.L(R.x+g[0].wrap*(1<<R.z),R.y,R.z);x.setDepthMode(li.disabled),x.setStencilMode(vi.disabled),x.setColorMode(_.colorModeForRenderPass()),_.setCustomLayerDefaults(),C.call(w,x.gl,D),x.setDirty(),_.setBaseState()}return}_.setCustomLayerDefaults(),x.setColorMode(_.colorModeForRenderPass()),x.setStencilMode(vi.disabled);const S=w.renderingMode==="3d"?new li(_.context.gl.LEQUAL,li.ReadWrite,_.depthRangeFor3D):_.depthModeForSublayer(0,li.ReadOnly);if(x.setDepthMode(S),_.transform.projection.name==="globe"){const C=_.transform.pointMerc;w.render(x.gl,_.transform.customLayerMatrix(),_.transform.getProjection(),_.transform.globeToMercatorMatrix(),l.S(_.transform.zoom),[C.x,C.y],_.transform.pixelsPerMeterRatio)}else w.render(x.gl,_.transform.customLayerMatrix());x.setDirty(),_.setBaseState(),x.bindFramebuffer.set(null)}}else l.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(_,a,d,g){if(_.renderPass==="opaque")return;const x=d.paint.get("model-opacity");if(x===0)return;const w=d.paint.get("model-cast-shadows");if(_.renderPass==="shadow"&&(!w||_.terrain&&x<.65&&d._transitionablePaint._values["model-opacity"].value.expression instanceof l.Z))return;const S=_.shadowRenderer,C=d.paint.get("model-receive-shadows");S&&(S.useNormalOffset=!0,C||(S.enabled=!1));const R=()=>{S&&(S.useNormalOffset=!0,C||(S.enabled=!0))},D=a.getSource();if(_.renderPass==="light-beam"&&D.type!=="batched-model")return;if(D.type==="vector"||D.type==="geojson")return function(q,ee,ae,re){const le=q.transform;if(le.projection.name!=="mercator")return void l.w(`Drawing 3D models for ${le.projection.name} projection is not yet implemented`);const Q=le.getFreeCameraOptions().position;if(!q.modelManager)return;const ce=q.modelManager;ae.modelManager=ce;const ve=q.shadowRenderer;if(!ae._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const we=ae._unevaluatedLayout._values["model-id"],Ce={...ae.layout.get("model-id").parameters};for(const Ue of re){const Re=ee.getTile(Ue).getBucket(ae);if(!Re||Re.projection.name!==le.projection.name)continue;const Ye=xg(Ue,le);Ce.zoom=Ye;const Ge=we.possiblyEvaluate(Ce);if(Bp(q,Re,Ue),ro.shadowUniformsInitialized=!1,ro.useSingleShadowCascade=!!ve&&ve.getMaxCascadeForTile(Ue.toUnwrapped())===0,q.renderPass==="shadow"&&ve){if(q.currentShadowCascade===1&&Re.isInsideFirstShadowMapFrustum)continue;const He=le.calculatePosMatrix(Ue.toUnwrapped(),le.worldSize);if(ro.tileMatrix.set(He),ro.shadowTileMatrix=Float32Array.from(ve.calculateShadowPassMatrixFromMatrix(He)),ro.aabb.min.fill(0),ro.aabb.max[0]=ro.aabb.max[1]=l.V,ro.aabb.max[2]=0,j1(Re,ro,q,ae.scope))continue}const pt=1<<Ue.canonical.z,ke=[((Q.x-Ue.wrap)*pt-Ue.canonical.x)*l.V,(Q.y*pt-Ue.canonical.y)*l.V,Q.z*pt*l.V];for(let He in Re.instancesPerModel){const Me=Re.instancesPerModel[He];Me.features.length>0&&(He=Ge.evaluate(Me.features[0].feature,{}));const Ne=ce.getModel(He,ae.scope);if(Ne&&Ne.uploaded)for(const mt of Ne.nodes)zp(q,ae,mt,Me,ke,Ue,ro)}}}(_,a,d,g),void R();if(!D.loaded())return;if(D.type==="batched-model")return function(q,ee,ae,re){ae.resetLayerRenderingStats(q);const le=q.context,Q=q.transform,ce=q.style.fog,ve=q.shadowRenderer;if(Q.projection.name!=="mercator")return void l.w(`Drawing 3D landmark models for ${Q.projection.name} projection is not yet implemented`);const we=q.transform.getFreeCameraOptions().position,Ce=l.N.scale([],[we.x,we.y,we.z],q.transform.worldSize);l.N.negate(Ce,Ce);const Ue=l.a6.identity([]),Re=l.cR(Q.center.lat,Q.zoom),Ye=l.a6.fromScaling([],[1,1,1/Re]);l.a6.translate(Ue,Ue,Ce);const Ge=ae.paint.get("model-opacity"),pt=new li(le.gl.LEQUAL,li.ReadWrite,q.depthRangeFor3D),ke=new li(le.gl.LEQUAL,li.ReadOnly,q.depthRangeFor3D),He=new l.bS([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Me=q.renderPass==="shadow",Ne=Me&&ve?ve.getCurrentCascadeFrustum():Q.getFrustum(Q.scaleZoom(Q.worldSize)),mt=ae.getLayerRenderingStats(),Mt=function(Tt,Lt){for(const Zt of re){const si=ee.getTile(Zt).getBucket(ae);if(!si||!si.uploaded)continue;let ei=!1;ve&&(ei=ve.getMaxCascadeForTile(Zt.toUnwrapped())===0);const ii=Q.calculatePosMatrix(Zt.toUnwrapped(),Q.worldSize),Ii=si.modelTraits;for(const gi of si.getNodesInfo()){if(gi.hiddenByReplacement||!gi.node.meshes)continue;const Ti=gi.evaluatedScale,wi=gi.node;let Qi=0;if(q.terrain&&wi.elevation&&(Qi=wi.elevation*q.terrain.exaggeration()),Ti[0]<=1&&Ti[1]<=1&&Ti[2]<=1&&(()=>{const Xr=gi.getLocalBounds();return He.min=[...Xr.min],He.max=[...Xr.max],He.min[2]+=Qi,He.max[2]+=Qi,l.N.transformMat4(He.min,He.min,ii),l.N.transformMat4(He.max,He.max,ii),He})().intersects(Ne)===0)continue;const Vr=q.renderPass==="light-beam",Ui=[...ii];l.a6.translate(Ui,Ui,[(wi.anchor?wi.anchor[0]:0)*(Ti[0]-1),(wi.anchor?wi.anchor[1]:0)*(Ti[1]-1),Qi]),l.N.exactEquals(Ti,l.cT)||l.a6.scale(Ui,Ui,Ti),l.a6.multiply(Ui,Ui,wi.matrix);const pn=l.a6.multiply([],Ye,Ui);l.a6.multiply(pn,Ue,pn);const Vi=l.a6.invert([],pn);l.a6.transpose(Vi,Vi),l.a6.scale(Vi,Vi,rc);const lr=l.a6.multiply([],Q.expandedFarZProjMatrix,Ui),ji=Ii&l.cV.HasMapboxMeshFeatures,sr=ji?0:gi.evaluatedRMEA[0][2];for(let Xr=0;Xr<wi.meshes.length;++Xr){const gr=wi.meshes[Xr],as=Xr===wi.lightMeshIndex;if(as){if(!Vr&&!q.terrain&&q.shadowRenderer){q.currentLayer<q.firstLightBeamLayer&&(q.firstLightBeamLayer=q.currentLayer);continue}}else if(Vr)continue;const vs={defines:[]},Hs=[];if(fn(vs.defines,Hs,gr,q),ji||vs.defines.push("DIFFUSE_SHADED"),ei&&vs.defines.push("SHADOWS_SINGLE_CASCADE"),mt&&(Me?mt.numRenderedVerticesInShadowPass+=gr.vertexArray.length:mt.numRenderedVerticesInTransparentPass+=gr.vertexArray.length),Me){Fe(gr,Ui,q,ae);continue}let Uo=null;if(ce){const Gs=vl(Ui,q.transform);if(Uo=new Float32Array(Gs),Q.projection.name!=="globe"){const Vo=gr.aabb.min,ja=gr.aabb.max,[bl,Lu]=ce.getOpacityForBounds(Gs,Vo[0],Vo[1],ja[0],ja[1]);vs.overrideFog=bl>=Ci||Lu>=Ci}}const qs=gr.material;let ls;qs.occlusionTexture&&qs.occlusionTexture.offsetScale&&(ls=qs.occlusionTexture.offsetScale,vs.defines.push("OCCLUSION_TEXTURE_TRANSFORM")),!Me&&ve&&(ve.useNormalOffset=!!gr.normalBuffer);const Xn=q.getOrCreateProgram("model",vs);!Me&&ve&&ve.setupShadowsFromMatrix(Ui,Xn,ve.useNormalOffset),q.uploadCommonUniforms(le,Xn,Zt.toUnwrapped(),Uo);const Is=qs.pbrMetallicRoughness;Is.metallicFactor=.9,Is.roughnessFactor=.5;const Ns=Qh(new Float32Array(lr),new Float32Array(pn),new Float32Array(Vi),q,Ge,Is.baseColorFactor,qs.emissiveFactor,Is.metallicFactor,Is.roughnessFactor,qs,sr,ae,[0,0,0],ls);Xn.draw(q,le.gl.TRIANGLES,Lt&&!as?pt:ke,vi.disabled,Tt?as||Ge<1||gi.hasTranslucentParts?Fi.alphaBlended:Fi.unblended:Fi.disabled,ci.backCCW,Ns,ae.id,gr.vertexBuffer,gr.indexBuffer,gr.segments,ae.paint,q.transform.zoom,void 0,Hs)}}}};(function(Tt,Lt,Zt,si){const ei=Tt.terrain?Tt.terrain.exaggeration():0,ii=Tt.transform.zoom;for(const Ii of si){const gi=Lt.getTile(Ii).getBucket(Zt);gi&&(Tt.conflationActive&&gi.updateReplacement(Ii,Tt.replacementSource),gi.evaluateScale(Tt,Zt),Tt.terrain&&ei>0&&gi.elevationUpdate(Tt.terrain,ei,Ii,Zt.source),gi.needsReEvaluation(Tt,ii,Zt)&&gi.evaluate(Zt))}})(q,ee,ae,re),Ge===1?Mt(!0,!0):(Mt(!1,!0),Mt(!0,!1))}(_,a,d,g),void R();const N=D.getModels(),B=[],j=_.transform.getFreeCameraOptions().position,$=l.N.scale([],[j.x,j.y,j.z],_.transform.worldSize);l.N.negate($,$);const Z=[],X=[];let K=0;for(const q of N){const ee=d.paint.get("model-rotation").constantOr(null),ae=d.paint.get("model-scale").constantOr(null),re=d.paint.get("model-translation").constantOr(null);q.computeModelMatrix(_,ee,ae,re,!0,!0,!1);const le=l.a6.identity([]),Q=l.cR(q.position.lat,_.transform.zoom),ce=l.a6.fromScaling([],[1,1,1/Q]);l.a6.translate(le,le,$),B.push({zScaleMatrix:ce,negCameraPosMatrix:le});for(const ve of q.nodes)vu(_.transform,ve,q.matrix,_.transform.expandedFarZProjMatrix,K,Z,X);K++}if(Z.sort((q,ee)=>ee.depth-q.depth),_.renderPass!=="shadow"){if(x===1)for(const q of X)yu(q,_,d,B[q.modelIndex],vi.disabled,_.colorModeForRenderPass());else{for(const q of X)yu(q,_,d,B[q.modelIndex],vi.disabled,Fi.disabled);for(const q of X)yu(q,_,d,B[q.modelIndex],_.stencilModeFor3D(),_.colorModeForRenderPass());_.resetStencilClippingMasks()}for(const q of Z)yu(q,_,d,B[q.modelIndex],vi.disabled,_.colorModeForRenderPass());R()}else{for(const q of X)Fe(q.mesh,q.nodeModelMatrix,_,d);for(const q of Z)Fe(q.mesh,q.nodeModelMatrix,_,d);R()}}},Up={model:function(_,a,d){const g=_.scope,x=a.getSource();if(!x.loaded())return;if(x.type==="vector"||x.type==="geojson")return void(d.modelManager&&d.modelManager.upload(d,g));if(x.type==="batched-model")return;const w=x.getModels();for(const S of w)S.upload(d.context)},raster:function(_,a,d){const g=a.getSource();if(!(g instanceof vt&&g.loaded()))return;const x=_.sourceLayer||g.rasterLayerIds&&g.rasterLayerIds[0];if(!x)return;const w=_.paint.get("raster-array-band")||g.getInitialBand(x);if(w==null)return;const S=a.getIds().map(C=>a.getTileByID(C));for(const C of S)C.updateNeeded(x,w)&&g.prepareTile(C,x,w)},"raster-particle":function(_,a,d){const g=a.getSource();if(!(g instanceof vt&&g.loaded()))return;const x=_.sourceLayer||g.rasterLayerIds&&g.rasterLayerIds[0];if(!x)return;const w=_.paint.get("raster-particle-array-band")||g.getInitialBand(x);if(w==null)return;const S=a.getIds().map(C=>a.getTileByID(C));for(const C of S)C.updateNeeded(x,w)&&g.prepareTile(C,x,w)}};class wg{constructor(a,d,g,x){this.context=new H_(a,d),this.transform=g,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=x,this._debugParams={showTerrainProxyTiles:!1},x.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),this.setup(),this.numSublayers=bo.maxUnderzooming+bo.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new l.cX,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new rp(this),this._wireframeDebugCache=new bg,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0}updateTerrain(a,d){const g=!!a&&!!a.terrain&&this.transform.projection.supportsTerrain;if(!(g||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new L1(this,a));const x=this._terrain;this.transform.elevation=g?x:null,x.update(a,this.transform,d),this.transform.elevation&&!x.enabled&&(this.transform.elevation=null)}_updateFog(a){const d=a.fog;if(!d||this.transform.projection.name==="globe"||d.getOpacity(this.transform.pitch)<1||d.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[g,x]=d.getFovAdjustedRange(this.transform._fov);if(g>x)return void(this.transform.fogCullDistSq=null);const w=g+.78*(x-g);this.transform.fogCullDistSq=w*w}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(a,d){if(this.width=a*l.f.devicePixelRatio,this.height=d*l.f.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const g of this.style.order)this.style._mergedLayers[g].resize()}setup(){const a=this.context,d=new l.aN;d.emplaceBack(0,0),d.emplaceBack(l.V,0),d.emplaceBack(0,l.V),d.emplaceBack(l.V,l.V),this.tileExtentBuffer=a.createVertexBuffer(d,l.aP.members),this.tileExtentSegments=l.aB.simpleSegment(0,0,4,2);const g=new l.aN;g.emplaceBack(0,0),g.emplaceBack(l.V,0),g.emplaceBack(0,l.V),g.emplaceBack(l.V,l.V),this.debugBuffer=a.createVertexBuffer(g,l.aP.members),this.debugSegments=l.aB.simpleSegment(0,0,4,5);const x=new l.aN;x.emplaceBack(-1,-1),x.emplaceBack(1,-1),x.emplaceBack(-1,1),x.emplaceBack(1,1),this.viewportBuffer=a.createVertexBuffer(x,l.aP.members),this.viewportSegments=l.aB.simpleSegment(0,0,4,2);const w=new l.av;w.emplaceBack(0,0,0,0),w.emplaceBack(l.V,0,l.V,0),w.emplaceBack(0,l.V,0,l.V),w.emplaceBack(l.V,l.V,l.V,l.V),this.mercatorBoundsBuffer=a.createVertexBuffer(w,l.aR.members),this.mercatorBoundsSegments=l.aB.simpleSegment(0,0,4,2);const S=new l.aw;S.emplaceBack(0,1,2),S.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=a.createIndexBuffer(S);const C=new l.aO;for(const D of[0,1,3,2,0])C.emplaceBack(D);this.debugIndexBuffer=a.createIndexBuffer(C),this.emptyTexture=new l.T(a,new l.h({width:1,height:1},Uint8Array.of(0,0,0,0)),a.gl.RGBA),this.identityMat=l.a6.create();const R=this.context.gl;this.stencilClearMode=new vi({func:R.ALWAYS,mask:0},0,255,R.ZERO,R.ZERO,R.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(a){return a._makeTileBoundsBuffers(this.context,this.transform.projection),a._tileBoundsBuffer?{tileBoundsBuffer:a._tileBoundsBuffer,tileBoundsIndexBuffer:a._tileBoundsIndexBuffer,tileBoundsSegments:a._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const a=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,a.TRIANGLES,li.disabled,this.stencilClearMode,Fi.disabled,ci.disabled,pp(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(a,d,g){if(!d||this.currentStencilSource===d.id||!a.isTileClipped()||!g||g.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let C=!1;for(const R of g)if(this._tileClippingMaskIDs[R.key]===void 0){C=!0;break}if(!C)return}this.currentStencilSource=d.id;const x=this.context,w=x.gl;this.nextStencilID+g.length>256&&this.clearStencil(),x.setColorMode(Fi.disabled),x.setDepthMode(li.disabled);const S=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const C of g){const R=d.getTile(C),D=this._tileClippingMaskIDs[C.key]=this.nextStencilID++,{tileBoundsBuffer:N,tileBoundsIndexBuffer:B,tileBoundsSegments:j}=this.getTileBoundsBuffers(R);S.draw(this,w.TRIANGLES,li.disabled,new vi({func:w.ALWAYS,mask:0},D,255,w.KEEP,w.KEEP,w.REPLACE),Fi.disabled,ci.disabled,pp(C.projMatrix),"$clipping",N,B,j)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const a=this.nextStencilID++,d=this.context.gl;return new vi({func:d.NOTEQUAL,mask:255},a,255,d.KEEP,d.KEEP,d.REPLACE)}stencilModeForClipping(a){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(a);const d=this.context.gl;return new vi({func:d.EQUAL,mask:255},this._tileClippingMaskIDs[a.key],0,d.KEEP,d.KEEP,d.REPLACE)}stencilConfigForOverlap(a){const d=this.context.gl,g=a.sort((S,C)=>C.overscaledZ-S.overscaledZ),x=g[g.length-1].overscaledZ,w=g[0].overscaledZ-x+1;if(w>1){this.currentStencilSource=void 0,this.nextStencilID+w>256&&this.clearStencil();const S={};for(let C=0;C<w;C++)S[C+x]=new vi({func:d.GEQUAL,mask:255},C+this.nextStencilID,255,d.KEEP,d.KEEP,d.REPLACE);return this.nextStencilID+=w,[S,g]}return[{[x]:vi.disabled},g]}colorModeForRenderPass(){const a=this.context.gl;return this._showOverdrawInspector?new Fi([a.CONSTANT_COLOR,a.ONE,a.CONSTANT_COLOR,a.ONE],new l.ax(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Fi.unblended:Fi.alphaBlended}colorModeForDrapableLayerRenderPass(a){const d=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new Fi([d.ONE,d.ONE_MINUS_SRC_ALPHA,d.CONSTANT_ALPHA,d.ONE_MINUS_SRC_ALPHA],new l.ax(0,0,0,a===void 0?0:a),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(a,d,g,x=!1){if(!this.opaquePassEnabledForLayer()&&!x)return li.disabled;const w=1-((1+this.currentLayer)*this.numSublayers+a)*this.depthEpsilon;return new li(g||this.context.gl.LEQUAL,d,[w,w])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(a,d){this._wireframeDebugCache.update(this.frameCounter),this.style=a,this.options=d;const g=this.style._mergedLayers,x=this.style.order,w=x.map(Q=>g[Q]),S=this.style._mergedSourceCaches;this.imageManager=a.imageManager,this.modelManager=a.modelManager,this.symbolFadeChange=a.placement.symbolFadeChange(l.f.now()),this.imageManager.beginFrame();let C=0,R=!1;for(const Q in S){const ce=S[Q];ce.used&&(ce.prepare(this.context),ce.getSource().usedInConflation&&++C)}for(const Q of w)Q.isHidden(this.transform.zoom)||this.prepareLayer(Q);const D={},N={},B={},j={},$={};for(const Q in S){const ce=S[Q];D[Q]=ce.getVisibleCoordinates(),N[Q]=D[Q].slice().reverse(),B[Q]=ce.getVisibleCoordinates(!0).reverse(),j[Q]=ce.getShadowCasterCoordinates(),$[Q]=ce.sortCoordinatesByDistance(D[Q])}const Z=Q=>{const ce=this.style.getLayerSourceCache(Q);return ce&&ce.used?ce.getSource():null};if(C){const Q=[];for(const ce of w)this.layerUsedInConflation(ce,Z(ce))&&Q.push(ce);if(Q&&Q.length>1){const ce=[];for(const ve of Q){const we=this.style.getLayerSourceCache(ve);we&&we.used&&we.getSource().usedInConflation&&ce.push({layer:ve.fqid,cache:we})}this.replacementSource.setSources(ce),R=!0}}R||this.replacementSource.clear(),this.conflationActive=R,this.minCutoffZoom=0,this.longestCutoffRange=0;for(const Q of w){const ce=Q.cutoffRange();if(this.longestCutoffRange=Math.max(ce,this.longestCutoffRange),ce>0){const ve=Z(Q);ve&&(this.minCutoffZoom=Math.max(ve.minzoom,this.minCutoffZoom)),Q.minzoom&&(this.minCutoffZoom=Math.max(Q.minzoom,this.minCutoffZoom))}}this.opaquePassCutoff=1/0;for(let Q=0;Q<w.length;Q++)if(w[Q].is3D()){this.opaquePassCutoff=Q;break}const X=this.style&&this.style.fog;X?(this._fogVisible=X.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=X.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(B),this.opaquePassCutoff=0);const K=this._shadowRenderer;if(K){K.updateShadowParameters(this.transform,this.style.directionalLight);for(const Q in S)for(const ce of D[Q]){let ve={min:0,max:0};this.terrain&&(ve=this.terrain.getMinMaxForTile(ce)||ve),K.addShadowReceiver(ce.toUnwrapped(),ve.min,ve.max)}}if(this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new l.cY(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new oi(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),!l.cZ(this.context.gl))return;this.renderPass="offscreen";for(const Q of w){const ce=a.getLayerSourceCache(Q);if(!Q.hasOffscreenPass()||Q.isHidden(this.transform.zoom))continue;const ve=ce?N[ce.id]:void 0;(Q.type==="custom"||Q.type==="raster"||Q.type==="raster-particle"||Q.isSky()||ve&&ve.length)&&this.renderLayer(this,ce,Q,ve)}this.depthRangeFor3D=[0,1-(w.length+2)*this.numSublayers*this.depthEpsilon];const q=this.terrain;q&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&!this.transform.isOrthographic&&q.drawDepth(),this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,j)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const ee=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),ae=(()=>{if(d.showOverdrawInspector)return l.ax.black;if(this.style.fog&&this.transform.projection.supportsFog&&!ee){const Q=this.style.fog.properties.get("color").toArray01();return new l.ax(...Q)}if(this.style.fog&&this.transform.projection.supportsFog&&ee){const Q=this.style.fog.properties.get("space-color").toArray01();return new l.ax(...Q)}return l.ax.transparent})();if(this.context.clear({color:ae,depth:1}),this.clearStencil(),this._showOverdrawInspector=d.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ee&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=x.length-1;this.currentLayer>=0;this.currentLayer--){const Q=w[this.currentLayer],ce=a.getLayerSourceCache(Q);if(Q.isSky())continue;const ve=ce?(Q.is3D()?$:N)[ce.id]:void 0;this._renderTileClippingMasks(Q,ce,ve),this.renderLayer(this,ce,Q,ve)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ee&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||l.S(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<x.length;this.currentLayer++){const Q=w[this.currentLayer],ce=a.getLayerSourceCache(Q);Q.isSky()&&this.renderLayer(this,ce,Q,ce?N[ce.id]:void 0)}function re(Q,ce){let ve;return ce&&(ve=(Q.type==="symbol"?B:Q.is3D()?$:N)[ce.id]),ve}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<x.length;){const Q=w[this.currentLayer];if(Q.type==="raster"){const ce=a.getLayerSourceCache(Q);this.renderLayer(this,ce,Q,re(Q,ce))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let le=0;for(K&&(le=K.getShadowCastingLayerCount());this.currentLayer<x.length;){const Q=w[this.currentLayer],ce=a.getLayerSourceCache(Q);if(Q.isSky())++this.currentLayer;else if(q&&this.style.isLayerDraped(Q)){if(Q.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=q.renderBatch(this.currentLayer)}else{if(this._renderTileClippingMasks(Q,ce,ce?D[ce.id]:void 0),this.renderLayer(this,ce,Q,re(Q,ce)),!q&&K&&le>0&&Q.hasShadowPass()&&--le==0&&(K.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const ve=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=ve;this.currentLayer++){const we=w[this.currentLayer];if(!we.hasLightBeamPass())continue;const Ce=a.getLayerSourceCache(we);this.renderLayer(this,Ce,we,Ce?N[Ce.id]:void 0)}this.currentLayer=ve,this.renderPass="translucent"}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Q=null;w.forEach(ce=>{const ve=a.getLayerSourceCache(ce);ve&&!ce.isHidden(this.transform.zoom)&&ve.getVisibleCoordinates().length&&(!Q||Q.getSource().maxzoom<ve.getSource().maxzoom)&&(Q=ve)}),Q&&this.options.showTileBoundaries&&bu.debug(this,Q,Q.getVisibleCoordinates(),l.ax.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&bu.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new l.ax(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(Q){const ce=Q.transform.padding;Lp(Q,Q.transform.height-(ce.top||0),3,$s),Lp(Q,ce.bottom||0,3,Na),io(Q,ce.left||0,3,vg),io(Q,Q.transform.width-(ce.right||0),3,kp);const ve=Q.transform.centerPoint;(function(we,Ce,Ue,Re){dn(we,Ce-1,Ue-10,2,20,Re),dn(we,Ce-10,Ue-1,20,2,Re)})(Q,ve.x,Q.transform.height-ve.y,Dp)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),R||(this.conflationActive=!1)}prepareLayer(a){this.gpuTimingStart(a);const{unsupportedLayers:d}=this.transform.projection,g=!d||!d.includes(a.type);if(Up[a.type]&&(g||this.terrain&&a.type==="custom")){const x=this.style.getLayerSourceCache(a);Up[a.type](a,x,this)}this.gpuTimingEnd()}renderLayer(a,d,g,x){g.isHidden(this.transform.zoom)||(g.type==="background"||g.type==="sky"||g.type==="custom"||g.type==="model"||g.type==="raster"||g.type==="raster-particle"||x&&x.length)&&(this.id=g.id,this.gpuTimingStart(g),(!a.transform.projection.unsupportedLayers||!a.transform.projection.unsupportedLayers.includes(g.type)||a.terrain&&g.type==="custom")&&bu[g.type](a,d,g,x,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(a){if(!this.options.gpuTiming)return;const d=this.context.extTimerQuery,g=this.context.gl;let x=this.gpuTimers[a.id];x||(x=this.gpuTimers[a.id]={calls:0,cpuTime:0,query:g.createQuery()}),x.calls++,g.beginQuery(d.TIME_ELAPSED_EXT,x.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const a=this.context.extTimerQuery,d=this.context.gl,g=d.createQuery();this.deferredRenderGpuTimeQueries.push(g),d.beginQuery(a.TIME_ELAPSED_EXT,g)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const a=this.gpuTimers;return this.gpuTimers={},a}collectDeferredRenderGpuQueries(){const a=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],a}queryGpuTimers(a){const d={};for(const g in a){const x=a[g],w=this.context.extTimerQuery,S=w.getQueryParameter(x.query,this.context.gl.QUERY_RESULT)/1e6;w.deleteQueryEXT(x.query),d[g]=S}return d}queryGpuTimeDeferredRender(a){if(!this.options.gpuTimingDeferredRender)return 0;const d=this.context.extTimerQuery,g=this.context.gl;let x=0;for(const w of a)x+=d.getQueryParameter(w,g.QUERY_RESULT)/1e6,d.deleteQueryEXT(w);return x}translatePosMatrix(a,d,g,x,w){if(!g[0]&&!g[1])return a;const S=w?x==="map"?this.transform.angle:0:x==="viewport"?-this.transform.angle:0;if(S){const D=Math.sin(S),N=Math.cos(S);g=[g[0]*N-g[1]*D,g[0]*D+g[1]*N]}const C=[w?g[0]:l.a3(d,g[0],this.transform.zoom),w?g[1]:l.a3(d,g[1],this.transform.zoom),0],R=new Float32Array(16);return l.a6.translate(R,a,C),R}saveTileTexture(a){const d=a.size[0],g=this._tileTextures[d];g?g.push(a):this._tileTextures[d]=[a]}getTileTexture(a){const d=this._tileTextures[a];return d&&d.length>0?d.pop():null}isPatternMissing(a,d){return a===null||a!==void 0&&!this.imageManager.getPattern(a.toString(),d)}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(a,d,g){const x=g===void 0?this.terrain&&this.terrain.renderingToTexture:g,w=this.terrain&&this.terrain.exaggeration()===0,S=[];return this.style&&this.style.enable3dLights()&&(a==="globeRaster"||a==="terrainRaster"?(S.push("LIGHTING_3D_MODE"),S.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):x||S.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"?this._shadowMapDebug||S.push("DEPTH_TEXTURE"):this.shadowRenderer&&(this.shadowRenderer.useNormalOffset?S.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"):S.push("RENDER_SHADOWS","DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(S.push("TERRAIN"),this.linearFloatFilteringSupported()&&S.push("TERRAIN_DEM_FLOAT_FORMAT"),w&&S.push("ZERO_EXAGGERATION")),this.transform.projection.name==="globe"&&S.push("GLOBE"),!this._fogVisible||x||d!==void 0&&!d||S.push("FOG","FOG_DITHERING"),x&&S.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&S.push("OVERDRAW_INSPECTOR"),S}getOrCreateProgram(a,d){this.cache=this.cache||{};const g=d&&d.defines||[],x=d&&d.config,w=d&&d.transformFeedback,S=this.currentGlobalDefines(a,d&&d.overrideFog,d&&d.overrideRtt).concat(g),C=yp.cacheKey(cp[a],a,S,x);return this.cache[C]||(this.cache[C]=new yp(this.context,a,cp[a],x,B1[a],S,w)),this.cache[C]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const a=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(a.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new l.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(a,d){if(this.style.enable3dLights()){const g=this.style.directionalLight,x=this.style.ambientLight;if(g&&x){const w=((S,C)=>{const R=S.properties.get("direction"),D=S.properties.get("color").toArray01(),N=S.properties.get("intensity"),B=C.properties.get("color").toArray01(),j=C.properties.get("intensity"),$=[R.x,R.y,R.z],Z=l.cn(B,j),X=l.cn(D,N);return{u_lighting_ambient_color:Z,u_lighting_directional_dir:$,u_lighting_directional_color:X,u_ground_radiance:_p($,X,Z)}})(g,x);d.setLightsUniformValues(a,w)}}}uploadCommonUniforms(a,d,g,x,w){if(this.uploadCommonLightUniforms(a,d),this.terrain&&this.terrain.renderingToTexture)return;const S=this.style.fog;if(S){const C=S.getOpacity(this.transform.pitch),R=((D,N,B,j,$,Z,X,K,q,ee,ae,re)=>{const le=D.transform,Q=N.properties.get("color").toArray01();Q[3]=j;const ce=D.frameCounter/1e3%1,[ve,we]=N.properties.get("vertical-range");return{u_fog_matrix:B?le.calculateFogTileMatrix(B):re||D.identityMat,u_fog_range:N.getFovAdjustedRange(le._fov),u_fog_color:Q,u_fog_horizon_blend:N.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(ve,we),we],u_fog_temporal_offset:ce,u_frustum_tl:$,u_frustum_tr:Z,u_frustum_br:X,u_frustum_bl:K,u_globe_pos:q,u_globe_radius:ee,u_viewport:ae,u_globe_transition:l.S(le.zoom),u_is_globe:+(le.projection.name==="globe")}})(this,S,g,C,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*l.f.devicePixelRatio,this.transform.height*l.f.devicePixelRatio],x);d.setFogUniformValues(a,R)}w&&d.setCutoffUniformValues(a,w.uniformValues)}setTileLoadedFlag(a){this.tileLoaded=a}saveCanvasCopy(){const a=this.canvasCopy();a&&(this.frameCopies.push(a),this.tileLoaded=!1)}canvasCopy(){const a=this.context.gl,d=a.createTexture();return a.bindTexture(a.TEXTURE_2D,d),a.copyTexImage2D(a.TEXTURE_2D,0,a.RGBA,0,0,a.drawingBufferWidth,a.drawingBufferHeight,0),d}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const a=this.style&&this.style.fog;return!!a&&a.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const a=this._backgroundTiles,d=this._backgroundTiles={},g=this.transform.coveringTiles({tileSize:512});for(const x of g)d[x.key]=a[x.key]||new Sa(x,512,this.transform.tileZoom,this);return d}clearBackgroundTiles(){this._backgroundTiles={}}layerUsedInConflation(a,d){return!(!a.is3D()||a.minzoom&&a.minzoom>this.transform.zoom||a.sourceLayer!=="building"&&(!d||d.type!=="batched-model"))}isTileAffectedByFog(a){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let d=this._cachedTileFogOpacities[a.key];return d||(this._cachedTileFogOpacities[a.key]=d=this.style.fog.getOpacityForTile(a)),d[0]>=Ci||d[1]>=Ci}}function wu(_,a){let d=!1,g=null;const x=()=>{g=null,d&&(_(),g=setTimeout(x,a),d=!1)};return()=>(d=!0,g||x(),g)}class id{constructor(a){this._hashName=a&&encodeURIComponent(a),l.aY(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=wu(this._updateHashUnthrottled.bind(this),300)}addTo(a){return this._map=a,window.addEventListener("hashchange",this._onHashChange,!1),a.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const a=this._map;if(!a)return"";const d=Vp(a);if(this._hashName){const g=this._hashName;let x=!1;const w=location.hash.slice(1).split("&").map(S=>{const C=S.split("=")[0];return C===g?(x=!0,`${C}=${d}`):S}).filter(S=>S);return x||w.push(`${g}=${d}`),`#${w.join("&")}`}return`#${d}`}_getCurrentHash(){const a=location.hash.replace("#","");if(this._hashName){let d;return a.split("&").map(g=>g.split("=")).forEach(g=>{g[0]===this._hashName&&(d=g)}),(d&&d[1]||"").split("/")}return a.split("/")}_onHashChange(){const a=this._map;if(!a)return!1;const d=this._getCurrentHash();if(d.length>=3&&!d.some(g=>isNaN(g))){const g=a.dragRotate.isEnabled()&&a.touchZoomRotate.isEnabled()?+(d[3]||0):a.getBearing();return a.jumpTo({center:[+d[2],+d[1]],zoom:+d[0],bearing:g,pitch:+(d[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Vp(_,a){const d=_.getCenter(),g=Math.round(100*_.getZoom())/100,x=Math.ceil((g*Math.LN2+Math.log(512/360/.5))/Math.LN10),w=Math.pow(10,x),S=Math.round(d.lng*w)/w,C=Math.round(d.lat*w)/w,R=_.getBearing(),D=_.getPitch();let N=a?`/${S}/${C}/${g}`:`${g}/${C}/${S}`;return(R||D)&&(N+="/"+Math.round(10*R)/10),D&&(N+=`/${Math.round(D)}`),N}const Tu={linearity:.3,easing:l.c_(0,0,.3,1)},Ws=l.e({deceleration:2500,maxSpeed:1400},Tu),W1=l.e({deceleration:20,maxSpeed:1400},Tu),rd=l.e({deceleration:1e3,maxSpeed:360},Tu),en=l.e({deceleration:1e3,maxSpeed:90},Tu);class Mr{constructor(a){this._map=a,this.clear()}clear(){this._inertiaBuffer=[]}record(a){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:l.f.now(),settings:a})}_drainInertiaBuffer(){const a=this._inertiaBuffer,d=l.f.now();for(;a.length>0&&d-a[0].time>160;)a.shift()}_onMoveEnd(a){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const d={zoom:0,bearing:0,pitch:0,pan:new l.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:w}of this._inertiaBuffer)d.zoom+=w.zoomDelta||0,d.bearing+=w.bearingDelta||0,d.pitch+=w.pitchDelta||0,w.panDelta&&d.pan._add(w.panDelta),w.around&&(d.around=w.around),w.pinchAround&&(d.pinchAround=w.pinchAround);const g=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,x={};if(d.pan.mag()){const w=Ao(d.pan.mag(),g,l.e({},Ws,a||{}));x.offset=d.pan.mult(w.amount/d.pan.mag()),x.center=this._map.transform.center,Eu(x,w)}if(d.zoom){const w=Ao(d.zoom,g,W1);x.zoom=this._map.transform.zoom+w.amount,Eu(x,w)}if(d.bearing){const w=Ao(d.bearing,g,rd);x.bearing=this._map.transform.bearing+l.aa(w.amount,-179,179),Eu(x,w)}if(d.pitch){const w=Ao(d.pitch,g,en);x.pitch=this._map.transform.pitch+w.amount,Eu(x,w)}if(x.zoom||x.bearing){const w=d.pinchAround===void 0?d.around:d.pinchAround;x.around=w?this._map.unproject(w):this._map.getCenter()}return this.clear(),x.noMoveStart=!0,x}}function Eu(_,a){(!_.duration||_.duration<a.duration)&&(_.duration=a.duration,_.easing=a.easing)}function Ao(_,a,d){const{maxSpeed:g,linearity:x,deceleration:w}=d,S=l.aa(_*x/(a/1e3),-g,g),C=Math.abs(S)/(w*x);return{easing:d.easing,duration:1e3*C,amount:S*(C/2)}}class Ls extends l.b{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(a,d,g,x={}){const w=je(d.getCanvasContainer(),g),S=d.unproject(w);super(a,l.e({point:w,lngLat:S,originalEvent:g},x)),this._defaultPrevented=!1,this.target=d}}class na extends l.b{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(a,d,g){const x=a==="touchend"?g.changedTouches:g.touches,w=st(d.getCanvasContainer(),x),S=w.map(R=>d.unproject(R)),C=w.reduce((R,D,N,B)=>R.add(D.div(B.length)),new l.P(0,0));super(a,{points:w,point:C,lngLats:S,lngLat:d.unproject(C),originalEvent:g}),this._defaultPrevented=!1}}class jp extends l.b{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(a,d,g){super(a,{originalEvent:g}),this._defaultPrevented=!1}}class $p{constructor(a,d){this._map=a,this._clickTolerance=d.clickTolerance}reset(){this._mousedownPos=void 0}wheel(a){return this._firePreventable(new jp(a.type,this._map,a))}mousedown(a,d){return this._mousedownPos=d,this._firePreventable(new Ls(a.type,this._map,a))}mouseup(a){this._map.fire(new Ls(a.type,this._map,a))}preclick(a){const d=l.e({},a);d.type="preclick",this._map.fire(new Ls(d.type,this._map,d))}click(a,d){this._mousedownPos&&this._mousedownPos.dist(d)>=this._clickTolerance||(this.preclick(a),this._map.fire(new Ls(a.type,this._map,a)))}dblclick(a){return this._firePreventable(new Ls(a.type,this._map,a))}mouseover(a){this._map.fire(new Ls(a.type,this._map,a))}mouseout(a){this._map.fire(new Ls(a.type,this._map,a))}touchstart(a){return this._firePreventable(new na(a.type,this._map,a))}touchmove(a){this._map.fire(new na(a.type,this._map,a))}touchend(a){this._map.fire(new na(a.type,this._map,a))}touchcancel(a){this._map.fire(new na(a.type,this._map,a))}_firePreventable(a){if(this._map.fire(a),a.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Ba{constructor(a){this._map=a}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(a){this._map.fire(new Ls(a.type,this._map,a))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Ls("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(a){this._delayContextMenu?this._contextMenuEvent=a:this._map.fire(new Ls(a.type,this._map,a)),this._map.listens("contextmenu")&&a.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class za{constructor(a,d){this._map=a,this._el=a.getCanvasContainer(),this._container=a.getContainer(),this._clickTolerance=d.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(a,d){this.isEnabled()&&a.shiftKey&&a.button===0&&(me(),this._startPos=this._lastPos=d,this._active=!0)}mousemoveWindow(a,d){if(!this._active)return;const g=d,x=this._startPos,w=this._lastPos;if(!x||!w||w.equals(g)||!this._box&&g.dist(x)<this._clickTolerance)return;this._lastPos=g,this._box||(this._box=U("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",a));const S=Math.min(x.x,g.x),C=Math.max(x.x,g.x),R=Math.min(x.y,g.y),D=Math.max(x.y,g.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${S}px,${R}px)`,this._box.style.width=C-S+"px",this._box.style.height=D-R+"px")})}mouseupWindow(a,d){if(!this._active)return;const g=this._startPos,x=d;if(g&&a.button===0){if(this.reset(),Oe(),g.x!==x.x||g.y!==x.y)return this._map.fire(new l.b("boxzoomend",{originalEvent:a})),{cameraAnimation:w=>w.fitScreenCoordinates(g,x,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",a)}}keydown(a){this._active&&a.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",a))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),pe(),delete this._startPos,delete this._lastPos}_fireEvent(a,d){return this._map.fire(new l.b(a,{originalEvent:d}))}}function nc(_,a){const d={};for(let g=0;g<_.length;g++)d[_[g].identifier]=a[g];return d}class nd{constructor(a){this.reset(),this.numTouches=a.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(a,d,g){(this.centroid||g.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=a.timeStamp),g.length===this.numTouches&&(this.centroid=function(x){const w=new l.P(0,0);for(const S of x)w._add(S);return w.div(x.length)}(d),this.touches=nc(g,d)))}touchmove(a,d,g){if(this.aborted||!this.centroid)return;const x=nc(g,d);for(const w in this.touches){const S=x[w];(!S||S.dist(this.touches[w])>30)&&(this.aborted=!0)}}touchend(a,d,g){if((!this.centroid||a.timeStamp-this.startTime>500)&&(this.aborted=!0),g.length===0){const x=!this.aborted&&this.centroid;if(this.reset(),x)return x}}}class Su{constructor(a){this.singleTap=new nd(a),this.numTaps=a.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(a,d,g){this.singleTap.touchstart(a,d,g)}touchmove(a,d,g){this.singleTap.touchmove(a,d,g)}touchend(a,d,g){const x=this.singleTap.touchend(a,d,g);if(x){const w=a.timeStamp-this.lastTime<500,S=!this.lastTap||this.lastTap.dist(x)<30;if(w&&S||this.reset(),this.count++,this.lastTime=a.timeStamp,this.lastTap=x,this.count===this.numTaps)return this.reset(),x}}}class Wp{constructor(){this._zoomIn=new Su({numTouches:1,numTaps:2}),this._zoomOut=new Su({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(a,d,g){this._zoomIn.touchstart(a,d,g),this._zoomOut.touchstart(a,d,g)}touchmove(a,d,g){this._zoomIn.touchmove(a,d,g),this._zoomOut.touchmove(a,d,g)}touchend(a,d,g){const x=this._zoomIn.touchend(a,d,g),w=this._zoomOut.touchend(a,d,g);return x?(this._active=!0,a.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:S=>S.easeTo({duration:300,zoom:S.getZoom()+1,around:S.unproject(x)},{originalEvent:a})}):w?(this._active=!0,a.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:S=>S.easeTo({duration:300,zoom:S.getZoom()-1,around:S.unproject(w)},{originalEvent:a})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Hp={0:1,2:2};class zo{constructor(a){this.reset(),this._clickTolerance=a.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(a,d){return!1}_move(a,d){return{}}mousedown(a,d){if(this._lastPoint)return;const g=ut(a);this._correctButton(a,g)&&(this._lastPoint=d,this._eventButton=g)}mousemoveWindow(a,d){const g=this._lastPoint;if(g){if(a.preventDefault(),this._eventButton!=null&&function(x,w){const S=Hp[w];return x.buttons===void 0||(x.buttons&S)!==S}(a,this._eventButton))this.reset();else if(this._moved||!(d.dist(g)<this._clickTolerance))return this._moved=!0,this._lastPoint=d,this._move(g,d)}}mouseupWindow(a){this._lastPoint&&ut(a)===this._eventButton&&(this._moved&&Oe(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class qp extends zo{mousedown(a,d){super.mousedown(a,d),this._lastPoint&&(this._active=!0)}_correctButton(a,d){return d===0&&!a.ctrlKey}_move(a,d){return{around:d,panDelta:d.sub(a)}}}class Au extends zo{_correctButton(a,d){return d===0&&a.ctrlKey||d===2}_move(a,d){const g=.8*(d.x-a.x);if(g)return this._active=!0,{bearingDelta:g}}contextmenu(a){a.preventDefault()}}class sd extends zo{_correctButton(a,d){return d===0&&a.ctrlKey||d===2}_move(a,d){const g=-.5*(d.y-a.y);if(g)return this._active=!0,{pitchDelta:g}}contextmenu(a){a.preventDefault()}}class Gp{constructor(a,d){this._map=a,this._el=a.getCanvasContainer(),this._minTouches=1,this._clickTolerance=d.clickTolerance||1,this.reset(),l.aY(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new l.P(0,0)}touchstart(a,d,g){return this._calculateTransform(a,d,g)}touchmove(a,d,g){if(this._active&&!(g.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(g.length===1&&!l.c$())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return a.cancelable&&a.preventDefault(),this._calculateTransform(a,d,g)}}touchend(a,d,g){this._calculateTransform(a,d,g),this._active&&g.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(a,d,g){g.length>0&&(this._active=!0);const x=nc(g,d),w=new l.P(0,0),S=new l.P(0,0);let C=0;for(const D in x){const N=x[D],B=this._touches[D];B&&(w._add(N),S._add(N.sub(B)),C++,x[D]=N)}if(this._touches=x,C<this._minTouches||!S.mag())return;const R=S.div(C);return this._sum._add(R),this._sum.mag()<this._clickTolerance?void 0:{around:w.div(C),panDelta:R}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=U("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class os{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(a){}_move(a,d,g){return{}}touchstart(a,d,g){this._firstTwoTouches||g.length<2||(this._firstTwoTouches=[g[0].identifier,g[1].identifier],this._start([d[0],d[1]]))}touchmove(a,d,g){const x=this._firstTwoTouches;if(!x)return;a.preventDefault();const[w,S]=x,C=sc(g,d,w),R=sc(g,d,S);if(!C||!R)return;const D=this._aroundCenter?null:C.add(R).div(2);return this._move([C,R],D,a)}touchend(a,d,g){if(!this._firstTwoTouches)return;const[x,w]=this._firstTwoTouches,S=sc(g,d,x),C=sc(g,d,w);S&&C||(this._active&&Oe(),this.reset())}touchcancel(){this.reset()}enable(a){this._enabled=!0,this._aroundCenter=!!a&&a.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function sc(_,a,d){for(let g=0;g<_.length;g++)if(_[g].identifier===d)return a[g]}function od(_,a){return Math.log(_/a)/Math.LN2}class Mu extends os{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(a){this._startDistance=this._distance=a[0].dist(a[1])}_move(a,d){const g=this._distance;if(this._distance=a[0].dist(a[1]),this._active||!(Math.abs(od(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:od(this._distance,g),pinchAround:d}}}function Ua(_,a){return 180*_.angleWith(a)/Math.PI}class Xp extends os{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(a){this._startVector=this._vector=a[0].sub(a[1]),this._minDiameter=a[0].dist(a[1])}_move(a,d){const g=this._vector;if(this._vector=a[0].sub(a[1]),g&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Ua(this._vector,g),pinchAround:d}}_isBelowThreshold(a){this._minDiameter=Math.min(this._minDiameter,a.mag());const d=25/(Math.PI*this._minDiameter)*360,g=this._startVector;if(!g)return!1;const x=Ua(a,g);return Math.abs(x)<d}}function Cu(_){return Math.abs(_.y)>Math.abs(_.x)}class Zp extends os{constructor(a){super(),this._map=a}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(a){this._lastPoints=a,Cu(a[0].sub(a[1]))&&(this._valid=!1)}_move(a,d,g){const x=this._lastPoints;if(!x)return;const w=a[0].sub(x[0]),S=a[1].sub(x[1]);return this._map._cooperativeGestures&&!l.c$()&&g.touches.length<3||(this._valid=this.gestureBeginsVertically(w,S,g.timeStamp),!this._valid)?void 0:(this._lastPoints=a,this._active=!0,{pitchDelta:(w.y+S.y)/2*-.5})}gestureBeginsVertically(a,d,g){if(this._valid!==void 0)return this._valid;const x=a.mag()>=2,w=d.mag()>=2;if(!x&&!w)return;if(!x||!w)return this._firstMove==null&&(this._firstMove=g),g-this._firstMove<100&&void 0;const S=a.y>0==d.y>0;return Cu(a)&&Cu(d)&&S}}const xl={panStep:100,bearingStep:15,pitchStep:10};class Pu{constructor(){const a=xl;this._panStep=a.panStep,this._bearingStep=a.bearingStep,this._pitchStep=a.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(a){if(a.altKey||a.ctrlKey||a.metaKey)return;let d=0,g=0,x=0,w=0,S=0;switch(a.keyCode){case 61:case 107:case 171:case 187:d=1;break;case 189:case 109:case 173:d=-1;break;case 37:a.shiftKey?g=-1:(a.preventDefault(),w=-1);break;case 39:a.shiftKey?g=1:(a.preventDefault(),w=1);break;case 38:a.shiftKey?x=1:(a.preventDefault(),S=-1);break;case 40:a.shiftKey?x=-1:(a.preventDefault(),S=1);break;default:return}return this._rotationDisabled&&(g=0,x=0),{cameraAnimation:C=>{const R=C.getZoom();C.easeTo({duration:300,easeId:"keyboardHandler",easing:Yp,zoom:d?Math.round(R)+d*(a.shiftKey?2:1):R,bearing:C.getBearing()+g*this._bearingStep,pitch:C.getPitch()+x*this._pitchStep,offset:[-w*this._panStep,-S*this._panStep],center:C.getCenter()},{originalEvent:a})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Yp(_){return _*(2-_)}const Iu=4.000244140625,Kp=1/450;class Tg{constructor(a,d){this._map=a,this._el=a.getCanvasContainer(),this._handler=d,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Kp,l.aY(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(a){this._defaultZoomRate=a}setWheelZoomRate(a){this._wheelZoomRate=a}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(a){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!a&&a.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(a){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(a.ctrlKey||a.metaKey||this.isZooming()||l.c$()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let d=a.deltaMode===WheelEvent.DOM_DELTA_LINE?40*a.deltaY:a.deltaY;const g=l.f.now(),x=g-(this._lastWheelEventTime||0);this._lastWheelEventTime=g,d!==0&&d%Iu==0?this._type="wheel":d!==0&&Math.abs(d)<4?this._type="trackpad":x>400?(this._type=null,this._lastValue=d,this._timeout=setTimeout(this._onTimeout,40,a)):this._type||(this._type=Math.abs(x*d)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,d+=this._lastValue)),a.shiftKey&&d&&(d/=4),this._type&&(this._lastWheelEvent=a,this._delta-=d,this._active||this._start(a)),a.preventDefault()}_onTimeout(a){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(a)}_start(a){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const d=je(this._el,a);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:d,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const a=this._map.transform;this._type==="wheel"&&a.projection.wrap&&(a._center.lng>=180||a._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const d=()=>a._terrainEnabled()&&this._aroundCoord?a.computeZoomRelativeTo(this._aroundCoord):a.zoom;if(this._delta!==0){const D=this._type==="wheel"&&Math.abs(this._delta)>Iu?this._wheelZoomRate:this._defaultZoomRate;let N=2/(1+Math.exp(-Math.abs(this._delta*D)));this._delta<0&&N!==0&&(N=1/N);const B=d(),j=Math.pow(2,B),$=typeof this._targetZoom=="number"?a.zoomScale(this._targetZoom):j;this._targetZoom=Math.min(a.maxZoom,Math.max(a.minZoom,a.scaleZoom($*N))),this._type==="wheel"&&(this._startZoom=B,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const g=typeof this._targetZoom=="number"?this._targetZoom:d(),x=this._startZoom,w=this._easing;let S,C=!1;if(this._type==="wheel"&&x&&w){const D=Math.min((l.f.now()-this._lastWheelEventTime)/200,1),N=w(D);S=l.U(x,g,N),D<1?this._frameId||(this._frameId=!0):C=!0}else S=g,C=!0;this._active=!0,C&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let R=S-d();return R*this._lastDelta<0&&(R=0),{noInertia:!0,needsRenderFrame:!C,zoomDelta:R,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(a){let d=l.d0;if(this._prevEase){const g=this._prevEase,x=(l.f.now()-g.start)/g.duration,w=g.easing(x+.01)-g.easing(x),S=.27/Math.sqrt(w*w+1e-4)*.01,C=Math.sqrt(.0729-S*S);d=l.c_(S,C,.25,1)}return this._prevEase={start:l.f.now(),duration:a,easing:d},d}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=U("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class Eg{constructor(a,d){this._clickZoom=a,this._tapZoom=d}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Sg{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(a,d){return a.preventDefault(),{cameraAnimation:g=>{g.easeTo({duration:300,zoom:g.getZoom()+(a.shiftKey?-1:1),around:g.unproject(d)},{originalEvent:a})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ag{constructor(){this._tap=new Su({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(a,d,g){this._swipePoint||(this._tapTime&&a.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?g.length>0&&(this._swipePoint=d[0],this._swipeTouch=g[0].identifier):this._tap.touchstart(a,d,g))}touchmove(a,d,g){if(this._tapTime){if(this._swipePoint){if(g[0].identifier!==this._swipeTouch)return;const x=d[0],w=x.y-this._swipePoint.y;return this._swipePoint=x,a.preventDefault(),this._active=!0,{zoomDelta:w/128}}}else this._tap.touchmove(a,d,g)}touchend(a,d,g){this._tapTime?this._swipePoint&&g.length===0&&this.reset():this._tap.touchend(a,d,g)&&(this._tapTime=a.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Mg{constructor(a,d,g){this._el=a,this._mousePan=d,this._touchPan=g}enable(a){this._inertiaOptions=a||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Cg{constructor(a,d,g){this._pitchWithRotate=a.pitchWithRotate,this._mouseRotate=d,this._mousePitch=g}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Pg{constructor(a,d,g,x){this._el=a,this._touchZoom=d,this._touchRotate=g,this._tapDragZoom=x,this._rotationDisabled=!1,this._enabled=!0}enable(a){this._touchZoom.enable(a),this._rotationDisabled||this._touchRotate.enable(a),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Ru=_=>_.zoom||_.drag||_.pitch||_.rotate;class Ig extends l.b{}class Rg{constructor(){this.constants=[1,1,.01],this.radius=0}setup(a,d){const g=l.N.sub([],d,a);this.radius=l.N.length(g[2]<0?l.N.div([],g,this.constants):[g[0],g[1],0])}projectRay(a){l.N.div(a,a,this.constants),l.N.normalize(a,a),l.N.mul(a,a,this.constants);const d=l.N.scale([],a,this.radius);if(d[2]>0){const g=l.N.scale([],[0,0,1],l.N.dot(d,[0,0,1])),x=l.N.scale([],l.N.normalize([],[d[0],d[1],0]),this.radius),w=l.N.add([],d,l.N.scale([],l.N.sub([],l.N.add([],x,g),d),2));d[0]=w[0],d[1]=w[1]}return d}}function Ou(_){return _.panDelta&&_.panDelta.mag()||_.zoomDelta||_.bearingDelta||_.pitchDelta}class H1{constructor(a,d){this._map=a,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Mr(a),this._bearingSnap=d.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Rg,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(d),l.aY(["handleEvent","handleWindowEvent"],this);const g=this._el;this._listeners=[[g,"touchstart",{passive:!0}],[g,"touchmove",{passive:!1}],[g,"touchend",void 0],[g,"touchcancel",void 0],[g,"mousedown",void 0],[g,"mousemove",void 0],[g,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[g,"mouseover",void 0],[g,"mouseout",void 0],[g,"dblclick",void 0],[g,"click",void 0],[g,"keydown",{capture:!1}],[g,"keyup",void 0],[g,"wheel",{passive:!1}],[g,"contextmenu",void 0],[window,"blur",void 0]];for(const[x,w,S]of this._listeners){const C=x===document?this.handleWindowEvent:this.handleEvent;x.addEventListener(w,C,S)}}destroy(){for(const[a,d,g]of this._listeners){const x=a===document?this.handleWindowEvent:this.handleEvent;a.removeEventListener(d,x,g)}}_addDefaultHandlers(a){const d=this._map,g=d.getCanvasContainer();this._add("mapEvent",new $p(d,a));const x=d.boxZoom=new za(d,a);this._add("boxZoom",x);const w=new Wp,S=new Sg;d.doubleClickZoom=new Eg(S,w),this._add("tapZoom",w),this._add("clickZoom",S);const C=new Ag;this._add("tapDragZoom",C);const R=d.touchPitch=new Zp(d);this._add("touchPitch",R);const D=new Au(a),N=new sd(a);d.dragRotate=new Cg(a,D,N),this._add("mouseRotate",D,["mousePitch"]),this._add("mousePitch",N,["mouseRotate"]);const B=new qp(a),j=new Gp(d,a);d.dragPan=new Mg(g,B,j),this._add("mousePan",B),this._add("touchPan",j,["touchZoom","touchRotate"]);const $=new Xp,Z=new Mu;d.touchZoomRotate=new Pg(g,Z,$,C),this._add("touchRotate",$,["touchPan","touchZoom"]),this._add("touchZoom",Z,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Ba(d));const X=d.scrollZoom=new Tg(d,this);this._add("scrollZoom",X,["mousePan"]);const K=d.keyboard=new Pu;this._add("keyboard",K);for(const q of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])a.interactive&&a[q]&&d[q].enable(a[q])}_add(a,d,g){this._handlers.push({handlerName:a,handler:d,allowed:g}),this._handlersById[a]=d}stop(a){if(!this._updatingCamera){for(const{handler:d}of this._handlers)d.reset();this._inertia.clear(),this._fireEvents({},{},a),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:a}of this._handlers)if(a.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Ru(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(a,d,g){for(const x in a)if(x!==g&&(!d||d.indexOf(x)<0))return!0;return!1}handleWindowEvent(a){this.handleEvent(a,`${a.type}Window`)}_getMapTouches(a){const d=[];for(const g of a)this._el.contains(g.target)&&d.push(g);return d}handleEvent(a,d){this._updatingCamera=!0;const g=a.type==="renderFrame",x=g?void 0:a,w={needsRenderFrame:!1},S={},C={},R=a.touches?this._getMapTouches(a.touches):void 0,D=R?st(this._el,R):g?void 0:je(this._el,a);for(const{handlerName:j,handler:$,allowed:Z}of this._handlers){if(!$.isEnabled())continue;let X;this._blockedByActive(C,Z,j)?$.reset():$[d||a.type]&&(X=$[d||a.type](a,D,R),this.mergeHandlerResult(w,S,X,j,x),X&&X.needsRenderFrame&&this._triggerRenderFrame()),(X||$.isActive())&&(C[j]=$)}const N={};for(const j in this._previousActiveHandlers)C[j]||(N[j]=x);this._previousActiveHandlers=C,(Object.keys(N).length||Ou(w))&&(this._changes.push([w,S,N]),this._triggerRenderFrame()),(Object.keys(C).length||Ou(w))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:B}=w;B&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],B(this._map))}mergeHandlerResult(a,d,g,x,w){if(!g)return;l.e(a,g);const S={handlerName:x,originalEvent:g.originalEvent||w};g.zoomDelta!==void 0&&(d.zoom=S),g.panDelta!==void 0&&(d.drag=S),g.pitchDelta!==void 0&&(d.pitch=S),g.bearingDelta!==void 0&&(d.rotate=S)}_applyChanges(){const a={},d={},g={};for(const[x,w,S]of this._changes)x.panDelta&&(a.panDelta=(a.panDelta||new l.P(0,0))._add(x.panDelta)),x.zoomDelta&&(a.zoomDelta=(a.zoomDelta||0)+x.zoomDelta),x.bearingDelta&&(a.bearingDelta=(a.bearingDelta||0)+x.bearingDelta),x.pitchDelta&&(a.pitchDelta=(a.pitchDelta||0)+x.pitchDelta),x.around!==void 0&&(a.around=x.around),x.aroundCoord!==void 0&&(a.aroundCoord=x.aroundCoord),x.pinchAround!==void 0&&(a.pinchAround=x.pinchAround),x.noInertia&&(a.noInertia=x.noInertia),l.e(d,w),l.e(g,S);this._updateMapTransform(a,d,g),this._changes=[]}_updateMapTransform(a,d,g){const x=this._map,w=x.transform,S=ee=>[ee.x,ee.y,ee.z];if((ee=>{const ae=this._eventsInProgress.drag;return ae&&!this._handlersById[ae.handlerName].isActive()})()&&!Ou(a)){const ee=w.zoom;w.cameraElevationReference="sea",this._originalZoom!=null&&w._orthographicProjectionAtLowPitch&&w.projection.name!=="globe"&&w.pitch===0?(w.cameraElevationReference="ground",w.zoom=this._originalZoom):(w.recenterOnTerrain(),w.cameraElevationReference="ground"),ee!==w.zoom&&this._map._update(!0)}if(w._isCameraConstrained&&x._stop(!0),!Ou(a))return void this._fireEvents(d,g,!0);let{panDelta:C,zoomDelta:R,bearingDelta:D,pitchDelta:N,around:B,aroundCoord:j,pinchAround:$}=a;w._isCameraConstrained&&(R>0&&(R=0),w._isCameraConstrained=!1),$!==void 0&&(B=$),(R||(ee=>d[ee]&&!this._eventsInProgress[ee])("drag"))&&B&&(this._dragOrigin=S(w.pointCoordinate3D(B)),this._originalZoom=w.zoom,this._trackingEllipsoid.setup(w._camera.position,this._dragOrigin)),w.cameraElevationReference="sea",x._stop(!0),B=B||x.transform.centerPoint,D&&(w.bearing+=D),N&&(w.pitch+=N),w._updateCameraState();const Z=[0,0,0];if(C)if(w.projection.name==="mercator"){const ee=this._trackingEllipsoid.projectRay(w.screenPointToMercatorRay(B).dir),ae=this._trackingEllipsoid.projectRay(w.screenPointToMercatorRay(B.sub(C)).dir);Z[0]=ae[0]-ee[0],Z[1]=ae[1]-ee[1]}else{const ee=w.pointCoordinate(B);if(w.projection.name==="globe"){C=C.rotate(-w.angle);const ae=w._pixelsPerMercatorPixel/w.worldSize;Z[0]=-C.x*l.d1(l.au(ee.y))*ae,Z[1]=-C.y*l.d1(w.center.lat)*ae}else{const ae=w.pointCoordinate(B.sub(C));ee&&ae&&(Z[0]=ae.x-ee.x,Z[1]=ae.y-ee.y)}}const X=w.zoom,K=[0,0,0];if(R){const ee=S(j||w.pointCoordinate3D(B)),ae={dir:l.N.normalize([],l.N.sub([],ee,w._camera.position))};if(ae.dir[2]<0){const re=w.zoomDeltaToMovement(ee,R);l.N.scale(K,ae.dir,re)}}const q=l.N.add(Z,Z,K);w._translateCameraConstrained(q),R&&Math.abs(w.zoom-X)>1e-4&&w.recenterOnTerrain(),w.cameraElevationReference="ground",this._map._update(),a.noInertia||this._inertia.record(a),this._fireEvents(d,g,!0)}_fireEvents(a,d,g){const x=Ru(this._eventsInProgress),w=Ru(a),S={};for(const N in a){const{originalEvent:B}=a[N];this._eventsInProgress[N]||(S[`${N}start`]=B),this._eventsInProgress[N]=a[N]}!x&&w&&this._fireEvent("movestart",w.originalEvent);for(const N in S)this._fireEvent(N,S[N]);w&&this._fireEvent("move",w.originalEvent);for(const N in a){const{originalEvent:B}=a[N];this._fireEvent(N,B)}const C={};let R;for(const N in this._eventsInProgress){const{handlerName:B,originalEvent:j}=this._eventsInProgress[N];this._handlersById[B].isActive()||(delete this._eventsInProgress[N],R=d[B]||j,C[`${N}end`]=R)}for(const N in C)this._fireEvent(N,C[N]);const D=Ru(this._eventsInProgress);if(g&&(x||w)&&!D){this._updatingCamera=!0;const N=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),B=j=>j!==0&&-this._bearingSnap<j&&j<this._bearingSnap;N?(B(N.bearing||this._map.getBearing())&&(N.bearing=0),this._map.easeTo(N,{originalEvent:R})):(this._map.fire(new l.b("moveend",{originalEvent:R})),B(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(a,d){this._map.fire(new l.b(a,d?{originalEvent:d}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(a=>{this._frameId=void 0,this.handleEvent(new Ig("renderFrame",{timeStamp:a})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const Og="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class wn extends l.E{constructor(a,d){super(),this._moving=!1,this._zooming=!1,this.transform=a,this._bearingSnap=d.bearingSnap,this._respectPrefersReducedMotion=d.respectPrefersReducedMotion!==!1,l.aY(["_renderFrameCallback"],this)}getCenter(){return new l.bn(this.transform.center.lng,this.transform.center.lat)}setCenter(a,d){return this.jumpTo({center:a},d)}panBy(a,d,g){return a=l.P.convert(a).mult(-1),this.panTo(this.transform.center,l.e({offset:a},d),g)}panTo(a,d,g){return this.easeTo(l.e({center:a},d),g)}getZoom(){return this.transform.zoom}setZoom(a,d){return this.jumpTo({zoom:a},d),this}zoomTo(a,d,g){return this.easeTo(l.e({zoom:a},d),g)}zoomIn(a,d){return this.zoomTo(this.getZoom()+1,a,d),this}zoomOut(a,d){return this.zoomTo(this.getZoom()-1,a,d),this}getBearing(){return this.transform.bearing}setBearing(a,d){return this.jumpTo({bearing:a},d),this}getPadding(){return this.transform.padding}setPadding(a,d){return this.jumpTo({padding:a},d),this}rotateTo(a,d,g){return this.easeTo(l.e({bearing:a},d),g)}resetNorth(a,d){return this.rotateTo(0,l.e({duration:1e3},a),d),this}resetNorthPitch(a,d){return this.easeTo(l.e({bearing:0,pitch:0,duration:1e3},a),d),this}snapToNorth(a,d){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(a,d):this}getPitch(){return this.transform.pitch}setPitch(a,d){return this.jumpTo({pitch:a},d),this}cameraForBounds(a,d){a=l.ad.convert(a);const g=d&&d.bearing||0,x=d&&d.pitch||0,w=a.getNorthWest(),S=a.getSouthEast();return this._cameraForBounds(this.transform,w,S,g,x,d)}_extendCameraOptions(a){const d={top:0,bottom:0,right:0,left:0};if(typeof(a=l.e({padding:d,offset:[0,0],maxZoom:this.transform.maxZoom},a)).padding=="number"){const g=a.padding;a.padding={top:g,bottom:g,right:g,left:g}}return a.padding=l.e(d,a.padding),a}_minimumAABBFrustumDistance(a,d){const g=d.max[0]-d.min[0],x=d.max[1]-d.min[1];return g/x>a.aspect?g/(2*Math.tan(.5*a.fovX)*a.aspect):x/(2*Math.tan(.5*a.fovY)*a.aspect)}_cameraForBoundsOnGlobe(a,d,g,x,w,S){const C=a.clone(),R=this._extendCameraOptions(S);C.bearing=x,C.pitch=w;const D=l.bn.convert(d),N=l.bn.convert(g),B=.5*(D.lat+N.lat),j=.5*(D.lng+N.lng),$=l.d2(B,j),Z=l.N.normalize([],$),X=l.N.normalize([],l.N.cross([],Z,[0,1,0])),K=l.N.cross([],X,Z),q=[X[0],X[1],X[2],0,K[0],K[1],K[2],0,Z[0],Z[1],Z[2],0,0,0,0,1],ee=[$,l.d2(D.lat,D.lng),l.d2(N.lat,D.lng),l.d2(N.lat,N.lng),l.d2(D.lat,N.lng),l.d2(B,D.lng),l.d2(B,N.lng),l.d2(D.lat,j),l.d2(N.lat,j)];let ae=l.bS.fromPoints(ee.map(Ne=>[l.N.dot(X,Ne),l.N.dot(K,Ne),l.N.dot(Z,Ne)]));const re=l.N.transformMat4([],ae.center,q);l.N.squaredLength(re)===0&&l.N.set(re,0,0,1),l.N.normalize(re,re),l.N.scale(re,re,l.ab),C.center=l.d3(re);const le=C.getWorldToCameraMatrix(),Q=l.a6.invert(new Float64Array(16),le);ae=l.bS.applyTransform(ae,l.a6.multiply([],le,q)),l.N.transformMat4(re,re,le);const ce=.5*(ae.max[2]-ae.min[2]),ve=this._minimumAABBFrustumDistance(C,ae),we=l.N.scale([],[0,0,1],ce),Ce=l.N.add(we,re,we),Ue=ve+(C.pitch===0?0:l.N.distance(re,Ce)),Re=C.globeCenterInViewSpace,Ye=l.N.sub([],re,[Re[0],Re[1],Re[2]]);l.N.normalize(Ye,Ye),l.N.scale(Ye,Ye,Ue);const Ge=l.N.add([],re,Ye);l.N.transformMat4(Ge,Ge,Q);const pt=l.d4/l.ab,ke=l.N.length(Ge),He=l.bl(Math.max(ke*pt-l.d4,Number.EPSILON),0),Me=Math.min(C.zoomFromMercatorZAdjusted(He),R.maxZoom);return Me>.5*(l.bG+l.bx)?(C.setProjection({name:"mercator"}),C.zoom=Me,this._cameraForBounds(C,d,g,x,w,S)):{center:C.center,zoom:Me,bearing:x,pitch:w}}queryTerrainElevation(a,d){const g=this.transform.elevation;return g?(d=l.e({},{exaggerated:!0},d),g.getAtPoint(l.L.fromLngLat(a),null,d.exaggerated)):null}_cameraForBounds(a,d,g,x,w,S){if(a.projection.name==="globe")return this._cameraForBoundsOnGlobe(a,d,g,x,w,S);const C=a.clone(),R=this._extendCameraOptions(S),D=C.padding;C.bearing=x,C.pitch=w;const N=l.bn.convert(d),B=l.bn.convert(g),j=new l.bn(N.lng,B.lat),$=new l.bn(B.lng,N.lat),Z=C.project(N),X=C.project(B),K=this.queryTerrainElevation(N),q=this.queryTerrainElevation(B),ee=this.queryTerrainElevation(j),ae=this.queryTerrainElevation($),re=[[Z.x,Z.y,Math.min(K||0,q||0,ee||0,ae||0)],[X.x,X.y,Math.max(K||0,q||0,ee||0,ae||0)]];let le=l.bS.fromPoints(re);const Q=C.getWorldToCameraMatrix(),ce=l.a6.invert(new Float64Array(16),Q);le=l.bS.applyTransform(le,Q);const ve=l.N.sub([],le.max,le.min),we=D.left||0,Ce=D.right||0,Ue=D.bottom||0,Re=D.top||0,{left:Ye,right:Ge,top:pt,bottom:ke}=R.padding,He=.5*(we+Ce),Me=.5*(Re+Ue),Ne=Math.min(C.scaleZoom(C.scale*Math.min((C.width-(we+Ce+Ye+Ge))/ve[0],(C.height-(Ue+Re+ke+pt))/ve[1])),R.maxZoom),mt=C.scale/C.zoomScale(Ne);le=new l.bS([le.min[0]-(Ye+He)*mt,le.min[1]-(ke+Me)*mt,le.min[2]],[le.max[0]+(Ge+He)*mt,le.max[1]+(pt+Me)*mt,le.max[2]]);const Mt=.5*ve[2],Tt=this._minimumAABBFrustumDistance(C,le),Lt=[0,0,1,0];l.a7.transformMat4(Lt,Lt,Q),l.a7.normalize(Lt,Lt);const Zt=l.N.scale([],Lt,Tt+Mt),si=l.N.add([],le.center,Zt),ei=(typeof R.offset.x=="number"&&typeof R.offset.y=="number"?new l.P(R.offset.x,R.offset.y):l.P.convert(R.offset)).rotate(-l.bj(x));le.center[0]-=ei.x*mt,le.center[1]+=ei.y*mt,l.N.transformMat4(le.center,le.center,ce),l.N.transformMat4(si,si,ce);const ii=[le.center[0],le.center[1],si[2]*C.pixelsPerMeter];l.N.scale(ii,ii,1/C.worldSize);const Ii=l.at(ii[0]),gi=l.au(ii[1]),Ti=Math.min(C._zoomFromMercatorZ(ii[2]),R.maxZoom),wi=new l.bn(Ii,gi);return C.mercatorFromTransition&&Ti<.5*(l.bG+l.bx)?(C.setProjection({name:"globe"}),C.zoom=Ti,this._cameraForBounds(C,d,g,x,w,S)):{center:wi,zoom:Ti,bearing:x,pitch:w}}fitBounds(a,d,g){const x=this.cameraForBounds(a,d);return this._fitInternal(x,d,g)}fitScreenCoordinates(a,d,g,x,w){const S=l.P.convert(a),C=l.P.convert(d),R=new l.P(Math.min(S.x,C.x),Math.min(S.y,C.y)),D=new l.P(Math.max(S.x,C.x),Math.max(S.y,C.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(S,C))return this;const N=this.transform.pointLocation3D(R),B=this.transform.pointLocation3D(D),j=this.transform.pointLocation3D(new l.P(R.x,D.y)),$=this.transform.pointLocation3D(new l.P(D.x,R.y)),Z=[Math.min(N.lng,B.lng,j.lng,$.lng),Math.min(N.lat,B.lat,j.lat,$.lat)],X=[Math.max(N.lng,B.lng,j.lng,$.lng),Math.max(N.lat,B.lat,j.lat,$.lat)],K=x&&x.pitch?x.pitch:this.getPitch(),q=this._cameraForBounds(this.transform,Z,X,g,K,x);return this._fitInternal(q,x,w)}_fitInternal(a,d,g){return a?(delete(d=l.e(a,d)).padding,d.linear?this.easeTo(d,g):this.flyTo(d,g)):this}jumpTo(a,d){this.stop();const g=a.preloadOnly?this.transform.clone():this.transform;let x=!1,w=!1,S=!1;return"zoom"in a&&g.zoom!==+a.zoom&&(x=!0,g.zoom=+a.zoom),a.center!==void 0&&(g.center=l.bn.convert(a.center)),"bearing"in a&&g.bearing!==+a.bearing&&(w=!0,g.bearing=+a.bearing),"pitch"in a&&g.pitch!==+a.pitch&&(S=!0,g.pitch=+a.pitch),a.padding==null||g.isPaddingEqual(a.padding)||(g.padding=a.padding),a.preloadOnly?(this._preloadTiles(g),this):(this.fire(new l.b("movestart",d)).fire(new l.b("move",d)),x&&this.fire(new l.b("zoomstart",d)).fire(new l.b("zoom",d)).fire(new l.b("zoomend",d)),w&&this.fire(new l.b("rotatestart",d)).fire(new l.b("rotate",d)).fire(new l.b("rotateend",d)),S&&this.fire(new l.b("pitchstart",d)).fire(new l.b("pitch",d)).fire(new l.b("pitchend",d)),this.fire(new l.b("moveend",d)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||l.w(Og),this.transform.getFreeCameraOptions()}setFreeCameraOptions(a,d){const g=this.transform;if(!g.projection.supportsFreeCamera)return l.w(Og),this;this.stop();const x=g.zoom,w=g.pitch,S=g.bearing;g.setFreeCameraOptions(a);const C=x!==g.zoom,R=w!==g.pitch,D=S!==g.bearing;return this.fire(new l.b("movestart",d)).fire(new l.b("move",d)),C&&this.fire(new l.b("zoomstart",d)).fire(new l.b("zoom",d)).fire(new l.b("zoomend",d)),D&&this.fire(new l.b("rotatestart",d)).fire(new l.b("rotate",d)).fire(new l.b("rotateend",d)),R&&this.fire(new l.b("pitchstart",d)).fire(new l.b("pitch",d)).fire(new l.b("pitchend",d)),this.fire(new l.b("moveend",d)),this}easeTo(a,d){this._stop(!1,a.easeId),((a=l.e({offset:[0,0],duration:500,easing:l.d0},a)).animate===!1||this._prefersReducedMotion(a))&&(a.duration=0);const g=this.transform,x=this.getZoom(),w=this.getBearing(),S=this.getPitch(),C=this.getPadding(),R="zoom"in a?+a.zoom:x,D="bearing"in a?this._normalizeBearing(a.bearing,w):w,N="pitch"in a?+a.pitch:S,B="padding"in a?a.padding:g.padding,j=l.P.convert(a.offset);let $,Z,X;if(g.projection.name==="globe"){const we=l.L.fromLngLat(g.center),Ce=j.rotate(-g.angle);we.x+=Ce.x/g.worldSize,we.y+=Ce.y/g.worldSize;const Ue=we.toLngLat(),Re=l.bn.convert(a.center||Ue);this._normalizeCenter(Re),$=g.centerPoint.add(Ce),Z=new l.P(we.x,we.y).mult(g.worldSize),X=new l.P(l.a5(Re.lng),l.ae(Re.lat)).mult(g.worldSize).sub(Z)}else{$=g.centerPoint.add(j);const we=g.pointLocation($),Ce=l.bn.convert(a.center||we);this._normalizeCenter(Ce),Z=g.project(we),X=g.project(Ce).sub(Z)}const K=g.zoomScale(R-x);let q,ee;a.around&&(q=l.bn.convert(a.around),ee=g.locationPoint(q));const ae=this._zooming||R!==x,re=this._rotating||w!==D,le=this._pitching||N!==S,Q=!g.isPaddingEqual(B),ce=we=>Ce=>{if(ae&&(we.zoom=l.U(x,R,Ce)),re&&(we.bearing=l.U(w,D,Ce)),le&&(we.pitch=l.U(S,N,Ce)),Q&&(we.interpolatePadding(C,B,Ce),$=we.centerPoint.add(j)),q)we.setLocationAtPoint(q,ee);else{const Ue=we.zoomScale(we.zoom-x),Re=R>x?Math.min(2,K):Math.max(.5,K),Ye=Math.pow(Re,1-Ce),Ge=we.unproject(Z.add(X.mult(Ce*Ye)).mult(Ue));we.setLocationAtPoint(we.renderWorldCopies?Ge.wrap():Ge,$)}return a.preloadOnly||this._fireMoveEvents(d),we};if(a.preloadOnly){const we=this._emulate(ce,a.duration,g);return this._preloadTiles(we),this}const ve={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=ae,this._rotating=re,this._pitching=le,this._easeId=a.easeId,this._prepareEase(d,a.noMoveStart,ve),this._ease(ce(g),we=>{g.cameraElevationReference==="sea"&&g.recenterOnTerrain(),this._afterEase(d,we)},a),this}_prepareEase(a,d,g={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),d||g.moving||this.fire(new l.b("movestart",a)),this._zooming&&!g.zooming&&this.fire(new l.b("zoomstart",a)),this._rotating&&!g.rotating&&this.fire(new l.b("rotatestart",a)),this._pitching&&!g.pitching&&this.fire(new l.b("pitchstart",a))}_fireMoveEvents(a){this.fire(new l.b("move",a)),this._zooming&&this.fire(new l.b("zoom",a)),this._rotating&&this.fire(new l.b("rotate",a)),this._pitching&&this.fire(new l.b("pitch",a))}_afterEase(a,d){if(this._easeId&&d&&this._easeId===d)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const g=this._zooming,x=this._rotating,w=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,g&&this.fire(new l.b("zoomend",a)),x&&this.fire(new l.b("rotateend",a)),w&&this.fire(new l.b("pitchend",a)),this.fire(new l.b("moveend",a))}flyTo(a,d){if(this._prefersReducedMotion(a)){const ke=l.ac(a,["center","zoom","bearing","pitch","around"]);return this.jumpTo(ke,d)}this.stop(),a=l.e({offset:[0,0],speed:1.2,curve:1.42,easing:l.d0},a);const g=this.transform,x=this.getZoom(),w=this.getBearing(),S=this.getPitch(),C="zoom"in a?l.aa(+a.zoom,g.minZoom,g.maxZoom):x,R="bearing"in a?this._normalizeBearing(a.bearing,w):w,D="pitch"in a?+a.pitch:S,N=g.zoomScale(C-x),B=l.P.convert(a.offset),j=g.centerPoint.add(B),$=g.pointLocation(j);let Z=a.center;if(Z&&a.padding){const ke=this._cameraForBounds(this.transform,Z,Z,R,D,a);ke&&(Z=ke.center)}Z=l.bn.convert(Z||$),this._normalizeCenter(Z);const X=g.project($),K=g.project(Z).sub(X);let q=a.curve;const ee=Math.max(g.width,g.height),ae=ee/N,re=K.mag();if("minZoom"in a){const ke=l.aa(Math.min(a.minZoom,x,C),g.minZoom,g.maxZoom),He=ee/g.zoomScale(ke-x);q=Math.sqrt(He/re*2)}const le=q*q;function Q(ke){const He=(ae*ae-ee*ee+(ke?-1:1)*le*le*re*re)/(2*(ke?ae:ee)*le*re);return Math.log(Math.sqrt(He*He+1)-He)}function ce(ke){return(Math.exp(ke)-Math.exp(-ke))/2}function ve(ke){return(Math.exp(ke)+Math.exp(-ke))/2}const we=Q(0);let Ce=function(ke){return ve(we)/ve(we+q*ke)},Ue=function(ke){return ee*((ve(we)*(ce(He=we+q*ke)/ve(He))-ce(we))/le)/re;var He},Re=(Q(1)-we)/q;if(Math.abs(re)<1e-6||!isFinite(Re)){if(Math.abs(ee-ae)<1e-6)return this.easeTo(a,d);const ke=ae<ee?-1:1;Re=Math.abs(Math.log(ae/ee))/q,Ue=function(){return 0},Ce=function(He){return Math.exp(ke*q*He)}}a.duration="duration"in a?+a.duration:1e3*Re/("screenSpeed"in a?+a.screenSpeed/q:+a.speed),a.maxDuration&&a.duration>a.maxDuration&&(a.duration=0);const Ye=w!==R,Ge=D!==S,pt=ke=>He=>{const Me=He*Re,Ne=1/Ce(Me);ke.zoom=He===1?C:x+ke.scaleZoom(Ne),Ye&&(ke.bearing=l.U(w,R,He)),Ge&&(ke.pitch=l.U(S,D,He));const mt=He===1?Z:ke.unproject(X.add(K.mult(Ue(Me))).mult(Ne));return ke.setLocationAtPoint(ke.renderWorldCopies?mt.wrap():mt,j),ke._updateCameraOnTerrain(),a.preloadOnly||this._fireMoveEvents(d),ke};if(a.preloadOnly){const ke=this._emulate(pt,a.duration,g);return this._preloadTiles(ke),this}return this._zooming=!0,this._rotating=Ye,this._pitching=Ge,this._prepareEase(d,!1),this._ease(pt(g),()=>this._afterEase(d),a),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(a,d){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const g=this._onEaseEnd;this._onEaseEnd=void 0,g.call(this,d)}if(!a){const g=this.handlers;g&&g.stop(!1)}return this}_ease(a,d,g){g.animate===!1||g.duration===0?(a(1),d()):(this._easeStart=l.f.now(),this._easeOptions=g,this._onEaseFrame=a,this._onEaseEnd=d,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const a=Math.min((l.f.now()-this._easeStart)/this._easeOptions.duration,1),d=this._onEaseFrame;d&&d(this._easeOptions.easing(a)),a<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(a,d){a=l.bh(a,-180,180);const g=Math.abs(a-d);return Math.abs(a-360-d)<g&&(a-=360),Math.abs(a+360-d)<g&&(a+=360),a}_normalizeCenter(a){const d=this.transform;if(d.maxBounds||d.projection.name!=="globe"&&!d.renderWorldCopies)return;const g=a.lng-d.center.lng;a.lng+=g>180?-360:g<-180?360:0}_prefersReducedMotion(a){return this._respectPrefersReducedMotion&&l.f.prefersReducedMotion&&!(a&&a.essential)}_emulate(a,d,g){const x=Math.ceil(15*d/1e3),w=[],S=a(g.clone());for(let C=0;C<=x;C++){const R=S(C/x);w.push(R.clone())}return w}}class Jp{constructor(a={}){this.options=a,l.aY(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(a){const d=this.options&&this.options.compact;return this._map=a,this._container=U("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=U("button","mapboxgl-ctrl-attrib-button",this._container),U("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=U("div","mapboxgl-ctrl-attrib-inner",this._container),d&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),d===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(a,d){const g=this._map._getUIString(`AttributionControl.${d}`);a.removeAttribute("title"),a.firstElementChild&&a.firstElementChild.setAttribute("title",g)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let a=this._editLink;a||(a=this._editLink=this._container.querySelector(".mapbox-improve-map"));const d=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||l.d5.ACCESS_TOKEN}];if(a){const g=d.reduce((x,w,S)=>(w.value&&(x+=`${w.key}=${w.value}${S<d.length-1?"&":""}`),x),"?");a.href=`${l.d5.FEEDBACK_URL}/${g}#${Vp(this._map,!0)}`,a.rel="noopener nofollow",this._setElementTitle(a,"MapFeedback")}}_updateData(a){!a||a.sourceDataType!=="metadata"&&a.sourceDataType!=="visibility"&&a.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let a=[];if(this._map.style.stylesheet){const x=this._map.style.stylesheet;this.styleOwner=x.owner,this.styleId=x.id}const d=this._map.style._mergedSourceCaches;for(const x in d){const w=d[x];if(w.used){const S=w.getSource();S.attribution&&a.indexOf(S.attribution)<0&&a.push(S.attribution)}}a.sort((x,w)=>x.length-w.length),a=a.filter((x,w)=>{for(let S=w+1;S<a.length;S++)if(a[S].indexOf(x)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?a=[...this.options.customAttribution,...a]:a.unshift(this.options.customAttribution));const g=a.join(" | ");g!==this._attribHTML&&(this._attribHTML=g,a.length?(this._innerContainer.innerHTML=g,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class kg{constructor(){l.aY(["_updateLogo","_updateCompact"],this)}onAdd(a){this._map=a,this._container=U("div","mapboxgl-ctrl");const d=U("a","mapboxgl-ctrl-logo");return d.target="_blank",d.rel="noopener nofollow",d.href="https://www.mapbox.com/",d.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),d.setAttribute("rel","noopener nofollow"),this._container.appendChild(d),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(a){a&&a.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const a=this._map.style._sourceCaches;if(Object.entries(a).length===0)return!0;for(const d in a){const g=a[d].getSource();if(g.hasOwnProperty("mapbox_logo")&&!g.mapbox_logo)return!1}return!0}_updateCompact(){const a=this._container.children;if(a.length){const d=a[0];this._map.getCanvasContainer().offsetWidth<250?d.classList.add("mapboxgl-compact"):d.classList.remove("mapboxgl-compact")}}}class Dg{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(a){const d=++this._id;return this._queue.push({callback:a,id:d,cancelled:!1}),d}remove(a){const d=this._currentlyRunning,g=d?this._queue.concat(d):this._queue;for(const x of g)if(x.id===a)return void(x.cancelled=!0)}run(a=0){const d=this._currentlyRunning=this._queue;this._queue=[];for(const g of d)if(!g.cancelled&&(g.callback(a),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function ku(_,a,d){if(_=new l.bn(_.lng,_.lat),a){const g=new l.bn(_.lng-360,_.lat),x=new l.bn(_.lng+360,_.lat),w=360*Math.ceil(Math.abs(_.lng-d.center.lng)/360),S=d.locationPoint(_).distSqr(a),C=a.x<0||a.y<0||a.x>d.width||a.y>d.height;d.locationPoint(g).distSqr(a)<S&&(C||Math.abs(g.lng-d.center.lng)<w)?_=g:d.locationPoint(x).distSqr(a)<S&&(C||Math.abs(x.lng-d.center.lng)<w)&&(_=x)}for(;Math.abs(_.lng-d.center.lng)>180;){const g=d.locationPoint(_);if(g.x>=0&&g.y>=0&&g.x<=d.width&&g.y<=d.height)break;_.lng>d.center.lng?_.lng-=360:_.lng+=360}return _}const ad={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class Qp extends l.E{constructor(a,d){if(super(),(a instanceof HTMLElement||d)&&(a=l.e({element:a},d)),l.aY(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=a&&a.anchor||"center",this._color=a&&a.color||"#3FB1CE",this._scale=a&&a.scale||1,this._draggable=a&&a.draggable||!1,this._clickTolerance=a&&a.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=a&&a.rotation||0,this._rotationAlignment=a&&a.rotationAlignment||"auto",this._pitchAlignment=a&&a.pitchAlignment&&a.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=a&&a.occludedOpacity||.2,a&&a.element)this._element=a.element,this._offset=l.P.convert(a&&a.offset||[0,0]);else{this._defaultMarker=!0,this._element=U("div");const w=41,S=27,C=H("svg",{display:"block",height:w*this._scale+"px",width:S*this._scale+"px",viewBox:`0 0 ${S} ${w}`},this._element),R=H("radialGradient",{id:"shadowGradient"},H("defs",{},C));H("stop",{offset:"10%","stop-opacity":.4},R),H("stop",{offset:"100%","stop-opacity":.05},R),H("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},C),H("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},C),H("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},C),H("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},C),this._offset=l.P.convert(a&&a.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",w=>{w.preventDefault()}),this._element.addEventListener("mousedown",w=>{w.preventDefault()});const g=this._element.classList;for(const w in ad)g.remove(`mapboxgl-marker-anchor-${w}`);g.add(`mapboxgl-marker-anchor-${this._anchor}`);const x=a&&a.className?a.className.trim().split(/\s+/):[];g.add(...x),this._popup=null}addTo(a){return a===this._map||(this.remove(),this._map=a,a.getCanvasContainer().appendChild(this._element),a.on("move",this._updateMoving),a.on("moveend",this._update),a.on("remove",this._clearFadeTimer),a._addMarker(this),this.setDraggable(this._draggable),this._update(),a.on("click",this._onMapClick)),this}remove(){const a=this._map;return a&&(a.off("click",this._onMapClick),a.off("move",this._updateMoving),a.off("moveend",this._update),a.off("mousedown",this._addDragHandler),a.off("touchstart",this._addDragHandler),a.off("mouseup",this._onUp),a.off("touchend",this._onUp),a.off("mousemove",this._onMove),a.off("touchmove",this._onMove),a.off("remove",this._clearFadeTimer),a._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(a){return this._lngLat=l.bn.convert(a),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(a){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),a){if(!("offset"in a.options)){const x=Math.sqrt(Math.pow(13.5,2)/2);a.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[x,-1*(38.1-13.5+x)],"bottom-right":[-x,-1*(38.1-13.5+x)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=a,a._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(a){const d=a.code,g=a.charCode||a.keyCode;d!=="Space"&&d!=="Enter"&&g!==32&&g!==13||this.togglePopup()}_onMapClick(a){const d=a.originalEvent.target,g=this._element;this._popup&&(d===g||g.contains(d))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const a=this._popup;return a?(a.isOpen()?(a.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(a.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const a=this._map,d=this._pos;if(!a||!d)return!1;const g=a.unproject(d),x=a.getFreeCameraOptions();if(!x.position)return!1;const w=x.position.toLngLat();return w.distanceTo(g)<.9*w.distanceTo(this._lngLat)}_evaluateOpacity(){const a=this._map;if(!a)return;const d=this._pos;if(!d||d.x<0||d.x>a.transform.width||d.y<0||d.y>a.transform.height)return void this._clearFadeTimer();const g=a.unproject(d);let x;a._showingGlobe()&&l.d6(a.transform,this._lngLat)?x=0:(x=1-a._queryFogOpacity(g),a.transform._terrainEnabled()&&a.getTerrain()&&this._behindTerrain()&&(x*=this._occludedOpacity)),this._element.style.opacity=`${x}`,this._element.style.pointerEvents=x>0?"auto":"none",this._popup&&this._popup._setOpacity(x),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const a=this._pos;if(!a||!this._map)return;const d=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${a.x}px,${a.y}px)
            ${ad[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${d.x}px,${d.y}px)
        `}_calculateXYTransform(){const a=this._pos,d=this._map,g=this.getPitchAlignment();if(!d||!a||g!=="map")return"";if(!d._showingGlobe()){const R=d.getPitch();return R?`rotateX(${R}deg)`:""}const x=l.bF(l.d7(d.transform,this._lngLat)),w=a.sub(l.d8(d.transform)),S=Math.abs(w.x)+Math.abs(w.y);if(S===0)return"";const C=x/S;return`rotateX(${-w.y*C}deg) rotateY(${w.x*C}deg)`}_calculateZTransform(){const a=this._pos,d=this._map;if(!d||!a)return"";let g=0;const x=this.getRotationAlignment();if(x==="map")if(d._showingGlobe()){const w=d.project(new l.bn(this._lngLat.lng,this._lngLat.lat+.001)),S=d.project(new l.bn(this._lngLat.lng,this._lngLat.lat-.001)).sub(w);g=l.bF(Math.atan2(S.y,S.x))-90}else g=-d.getBearing();else if(x==="horizon"){const w=l.O(4,6,d.getZoom()),S=l.d8(d.transform);S.y+=w*d.transform.height;const C=a.sub(S),R=l.bF(Math.atan2(C.y,C.x));g=(R>90?R-270:R+90)*(1-w)}return g+=this._rotation,g?`rotateZ(${g}deg)`:""}_update(a){cancelAnimationFrame(this._updateFrameId);const d=this._map;d&&(d.transform.renderWorldCopies&&(this._lngLat=ku(this._lngLat,this._pos,d.transform)),this._pos=d.project(this._lngLat),a===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),d._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(d._showingGlobe()||d.getTerrain()||d.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(a){return this._offset=l.P.convert(a),this._update(),this}addClassName(a){return this._element.classList.add(a),this}removeClassName(a){return this._element.classList.remove(a),this}toggleClassName(a){return this._element.classList.toggle(a)}_onMove(a){const d=this._map;if(!d)return;const g=this._pointerdownPos,x=this._positionDelta;if(g&&x){if(!this._isDragging){const w=this._clickTolerance||d._clickTolerance;if(a.point.dist(g)<w)return;this._isDragging=!0}this._pos=a.point.sub(x),this._lngLat=d.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new l.b("dragstart"))),this.fire(new l.b("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const a=this._map;a&&(a.off("mousemove",this._onMove),a.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new l.b("dragend")),this._state="inactive"}_addDragHandler(a){const d=this._map,g=this._pos;d&&g&&this._element.contains(a.originalEvent.target)&&(a.preventDefault(),this._positionDelta=a.point.sub(g),this._pointerdownPos=a.point,this._state="pending",d.on("mousemove",this._onMove),d.on("touchmove",this._onMove),d.once("mouseup",this._onUp),d.once("touchend",this._onUp))}setDraggable(a){this._draggable=!!a;const d=this._map;return d&&(a?(d.on("mousedown",this._addDragHandler),d.on("touchstart",this._addDragHandler)):(d.off("mousedown",this._addDragHandler),d.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(a){return this._rotation=a||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(a){return this._rotationAlignment=a||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(a){return this._pitchAlignment=a||"auto",this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(a){return this._occludedOpacity=a||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const Lg={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},Ng=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Fg(_=new l.P(0,0),a="bottom"){if(typeof _=="number"){const d=Math.round(Math.sqrt(.5*Math.pow(_,2)));switch(a){case"top":return new l.P(0,_);case"top-left":return new l.P(d,d);case"top-right":return new l.P(-d,d);case"bottom":return new l.P(0,-_);case"bottom-left":return new l.P(d,-d);case"bottom-right":return new l.P(-d,-d);case"left":return new l.P(_,0);case"right":return new l.P(-_,0)}return new l.P(0,0)}return _ instanceof l.P||Array.isArray(_)?l.P.convert(_):l.P.convert(_[a]||[0,0])}class em{constructor(a){this.jumpTo(a)}getValue(a){if(a<=this._startTime)return this._start;if(a>=this._endTime)return this._end;const d=l.cc((a-this._startTime)/(this._endTime-this._startTime));return this._start*(1-d)+this._end*d}isEasing(a){return a>=this._startTime&&a<=this._endTime}jumpTo(a){this._startTime=-1/0,this._endTime=-1/0,this._start=a,this._end=a}easeTo(a,d,g){this._start=this.getValue(d),this._end=a,this._startTime=d,this._endTime=d+g}}const Du={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},Bg={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1};class tm{constructor(){this.showOverdrawInspector=!1,this.showTileBoundaries=!1,this.showParseStatus=!1,this.continuousRedraw=!1,this.showTileAABBs=!1,this.showPadding=!1,this.showTerrainWireframe=!1,this.showLayers2DWireframe=!1,this.showLayers3DWireframe=!1}}const ld={showCompass:!0,showZoom:!0,visualizePitch:!1};class sa{constructor(a,d,g=!1){this._clickTolerance=10,this.element=d,this.mouseRotate=new Au({clickTolerance:a.dragRotate._mouseRotate._clickTolerance}),this.map=a,g&&(this.mousePitch=new sd({clickTolerance:a.dragRotate._mousePitch._clickTolerance})),l.aY(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),d.addEventListener("mousedown",this.mousedown),d.addEventListener("touchstart",this.touchstart,{passive:!1}),d.addEventListener("touchmove",this.touchmove),d.addEventListener("touchend",this.touchend),d.addEventListener("touchcancel",this.reset)}down(a,d){this.mouseRotate.mousedown(a,d),this.mousePitch&&this.mousePitch.mousedown(a,d),me()}move(a,d){const g=this.map,x=this.mouseRotate.mousemoveWindow(a,d),w=x&&x.bearingDelta;if(w&&g.setBearing(g.getBearing()+w),this.mousePitch){const S=this.mousePitch.mousemoveWindow(a,d),C=S&&S.pitchDelta;C&&g.setPitch(g.getPitch()+C)}}off(){const a=this.element;a.removeEventListener("mousedown",this.mousedown),a.removeEventListener("touchstart",this.touchstart,{passive:!1}),a.removeEventListener("touchmove",this.touchmove),a.removeEventListener("touchend",this.touchend),a.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){pe(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(a){this.down(l.e({},a,{ctrlKey:!0,preventDefault:()=>a.preventDefault()}),je(this.element,a)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(a){this.move(a,je(this.element,a))}mouseup(a){this.mouseRotate.mouseupWindow(a),this.mousePitch&&this.mousePitch.mouseupWindow(a),this.offTemp()}touchstart(a){a.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=st(this.element,a.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>a.preventDefault()},this._startPos))}touchmove(a){a.targetTouches.length!==1?this.reset():(this._lastPos=st(this.element,a.targetTouches)[0],this.move({preventDefault:()=>a.preventDefault()},this._lastPos))}touchend(a){a.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const cd={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Ps={maxWidth:100,unit:"metric"},Va={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"};return{version:l.dk,supported:P,setRTLTextPlugin:l.dm,getRTLTextPluginStatus:l.dn,Map:class extends wn{constructor(_){const a=_;if((_=l.e({},Bg,_)).minZoom!=null&&_.maxZoom!=null&&_.minZoom>_.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(_.minPitch!=null&&_.maxPitch!=null&&_.minPitch>_.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(_.minPitch!=null&&_.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(_.maxPitch!=null&&_.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(_.antialias&&l.d9(window)&&(_.antialias=!1,l.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new au(_.minZoom,_.maxZoom,_.minPitch,_.maxPitch,_.renderWorldCopies),_),this._repaint=!1,this._interactive=_.interactive,this._minTileCacheSize=_.minTileCacheSize,this._maxTileCacheSize=_.maxTileCacheSize,this._failIfMajorPerformanceCaveat=_.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=_.preserveDrawingBuffer,this._antialias=_.antialias,this._trackResize=_.trackResize,this._bearingSnap=_.bearingSnap,this._refreshExpiredTiles=_.refreshExpiredTiles,this._fadeDuration=_.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=_.crossSourceCollisions,this._collectResourceTiming=_.collectResourceTiming,this._language=this._parseLanguage(_.language),this._worldview=_.worldview,this._renderTaskQueue=new Dg,this._domRenderTaskQueue=new Dg,this._controls=[],this._markers=[],this._popups=[],this._mapId=l.aC(),this._locale=l.e({},Du,_.locale),this._clickTolerance=_.clickTolerance,this._cooperativeGestures=_.cooperativeGestures,this._performanceMetricsCollection=_.performanceMetricsCollection,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new em(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._requestManager=new l.da(_.transformRequest,_.accessToken,_.testMode),this._silenceAuthErrors=!!_.testMode,this._contextCreateOptions=_.contextCreateOptions?{..._.contextCreateOptions}:{},typeof _.container=="string"){const d=document.getElementById(_.container);if(!d)throw new Error(`Container '${_.container.toString()}' not found.`);this._container=d}else{if(!(_.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=_.container}if(this._container.childNodes.length>0&&l.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),_.maxBounds&&this.setMaxBounds(_.maxBounds),l.aY(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._debugParams=new tm,this._tp=_.devtools?new xu(this):new xu,this._tp.registerParameter(this._debugParams,["Debug"],"showOverdrawInspector",void 0,()=>{this._update()}),this._tp.registerParameter(this._debugParams,["Debug"],"showTileBoundaries",void 0,()=>{this._update()}),this._tp.registerParameter(this._debugParams,["Debug"],"showParseStatus",void 0,()=>{this._update()}),this._tp.registerParameter(this._debugParams,["Debug"],"continuousRedraw",void 0,d=>{this.repaint=d}),this._tp.registerParameter(this._debugParams,["Debug"],"showTileAABBs",void 0,d=>{this.showTileAABBs=d}),this._tp.registerParameter(this._debugParams,["Debug"],"showPadding",void 0,d=>{this.showPadding=d}),this._tp.registerParameter(this._debugParams,["Debug","Wireframe"],"showTerrainWireframe",void 0,()=>{this._update()}),this._tp.registerParameter(this._debugParams,["Debug","Wireframe"],"showLayers2DWireframe",void 0,()=>{this._update()}),this._tp.registerParameter(this._debugParams,["Debug","Wireframe"],"showLayers3DWireframe",void 0,()=>{this._update()}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new H1(this,_),this._localFontFamily=_.localFontFamily,this._localIdeographFontFamily=_.localIdeographFontFamily,(_.style||!_.testMode)&&this.setStyle(_.style||l.d5.DEFAULT_STYLE,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),_.projection&&this.setProjection(_.projection),_.hash&&(this._hash=new id(typeof _.hash=="string"&&_.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){a.center==null&&a.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:_.center,zoom:_.zoom,bearing:_.bearing,pitch:_.pitch});const d=_.bounds;d&&(this.resize(),this.fitBounds(d,l.e({},_.fitBoundsOptions,{duration:0})))}this.resize(),_.attributionControl&&this.addControl(new Jp({customAttribution:_.customAttribution})),this._logoControl=new kg,this.addControl(this._logoControl,_.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",d=>{this._update(d.dataType==="style"),this.fire(new l.b(`${d.dataType}data`,d))}),this.on("dataloading",d=>{this.fire(new l.b(`${d.dataType}dataloading`,d))})}_getMapId(){return this._mapId}addControl(_,a){if(a===void 0&&(a=_.getDefaultPosition?_.getDefaultPosition():"top-right"),!_||!_.onAdd)return this.fire(new l.a(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const d=_.onAdd(this);this._controls.push(_);const g=this._controlPositions[a];return a.indexOf("bottom")!==-1?g.insertBefore(d,g.firstChild):g.appendChild(d),this}removeControl(_){if(!_||!_.onRemove)return this.fire(new l.a(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const a=this._controls.indexOf(_);return a>-1&&this._controls.splice(a,1),_.onRemove(this),this}hasControl(_){return this._controls.indexOf(_)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(_){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const a=!this._moving;return a&&this.fire(new l.b("movestart",_)).fire(new l.b("move",_)),this.fire(new l.b("resize",_)),a&&this.fire(new l.b("moveend",_)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(_){return this.transform.setMaxBounds(l.ad.convert(_)),this._update()}setMinZoom(_){if((_=_??-2)>=-2&&_<=this.transform.maxZoom)return this.transform.minZoom=_,this._update(),this.getZoom()<_?this.setZoom(_):this.fire(new l.b("zoomstart")).fire(new l.b("zoom")).fire(new l.b("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(_){if((_=_??22)>=this.transform.minZoom)return this.transform.maxZoom=_,this._update(),this.getZoom()>_?this.setZoom(_):this.fire(new l.b("zoomstart")).fire(new l.b("zoom")).fire(new l.b("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(_){if((_=_??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(_>=0&&_<=this.transform.maxPitch)return this.transform.minPitch=_,this._update(),this.getPitch()<_?this.setPitch(_):this.fire(new l.b("pitchstart")).fire(new l.b("pitch")).fire(new l.b("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(_){if((_=_??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(_>=this.transform.minPitch)return this.transform.maxPitch=_,this._update(),this.getPitch()>_?this.setPitch(_):this.fire(new l.b("pitchstart")).fire(new l.b("pitch")).fire(new l.b("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(_){return this.transform.renderWorldCopies=_,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(_){return _==="auto"?navigator.language:Array.isArray(_)?_.length===0?void 0:_.map(a=>a==="auto"?navigator.language:a):_}setLanguage(_){const a=this._parseLanguage(_);if(!this.style||a===this._language)return this;this._language=a,this.style.reloadSources();for(const d of this._controls)d._setLanguage&&d._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(_){return this.style&&_!==this._worldview?(this._worldview=_,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(_){return this._lazyInitEmptyStyle(),_?typeof _=="string"&&(_={name:_}):_=null,this._useExplicitProjection=!!_,this._prioritizeAndUpdateProjection(_,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const _=this.transform,a=_.projection.name;let d;a==="globe"&&_.zoom>=l.bx?(_.setMercatorFromTransition(),d=!0):a==="mercator"&&_.zoom<l.bx&&(_.setProjection({name:"globe"}),d=!0),d&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(_,a){return this._updateProjection(_||a||{name:"mercator"})}_updateProjection(_){let a;return a=_.name==="globe"&&this.transform.zoom>=l.bx?this.transform.setMercatorFromTransition():this.transform.setProjection(_),this.style.applyProjectionUpdate(),a&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(_){return this.transform.locationPoint3D(l.bn.convert(_))}unproject(_){return this.transform.pointLocation3D(l.P.convert(_))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(_,a,d){if(_==="mouseenter"||_==="mouseover"){let g=!1;const x=S=>{const C=a.filter(D=>this.getLayer(D)),R=C.length?this.queryRenderedFeatures(S.point,{layers:C}):[];R.length?g||(g=!0,d.call(this,new Ls(_,this,S.originalEvent,{features:R}))):g=!1},w=()=>{g=!1};return{layers:new Set(a),listener:d,delegates:{mousemove:x,mouseout:w}}}if(_==="mouseleave"||_==="mouseout"){let g=!1;const x=S=>{const C=a.filter(R=>this.getLayer(R));(C.length?this.queryRenderedFeatures(S.point,{layers:C}):[]).length?g=!0:g&&(g=!1,d.call(this,new Ls(_,this,S.originalEvent)))},w=S=>{g&&(g=!1,d.call(this,new Ls(_,this,S.originalEvent)))};return{layers:new Set(a),listener:d,delegates:{mousemove:x,mouseout:w}}}{const g=x=>{const w=a.filter(C=>this.getLayer(C)),S=w.length?this.queryRenderedFeatures(x.point,{layers:w}):[];S.length&&(x.features=S,d.call(this,x),delete x.features)};return{layers:new Set(a),listener:d,delegates:{[_]:g}}}}on(_,a,d){if(d===void 0)return super.on(_,a);if(Array.isArray(a)||(a=[a]),a){for(const x of a)if(!this._isValidId(x))return this}const g=this._createDelegatedListener(_,a,d);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[_]=this._delegatedListeners[_]||[],this._delegatedListeners[_].push(g);for(const x in g.delegates)this.on(x,g.delegates[x]);return this}once(_,a,d){if(d===void 0)return super.once(_,a);if(Array.isArray(a)||(a=[a]),a){for(const x of a)if(!this._isValidId(x))return this}const g=this._createDelegatedListener(_,a,d);for(const x in g.delegates)this.once(x,g.delegates[x]);return this}off(_,a,d){if(d===void 0)return super.off(_,a);a=new Set(Array.isArray(a)?a:[a]);for(const w of a)if(!this._isValidId(w))return this;const g=(w,S)=>{if(w.size!==S.size)return!1;for(const C of w)if(!S.has(C))return!1;return!0},x=this._delegatedListeners?this._delegatedListeners[_]:void 0;return x&&(w=>{for(let S=0;S<w.length;S++){const C=w[S];if(C.listener===d&&g(C.layers,a)){for(const R in C.delegates)this.off(R,C.delegates[R]);return w.splice(S,1),this}}})(x),this}queryRenderedFeatures(_,a){if(!this.style)return[];if(a!==void 0||_===void 0||_ instanceof l.P||Array.isArray(_)||(a=_,_=void 0),_=_||[[0,0],[this.transform.width,this.transform.height]],(a=a||{}).layers&&Array.isArray(a.layers)){for(const d of a.layers)if(!this._isValidId(d))return[]}return this.style.queryRenderedFeatures(_,a,this.transform)}querySourceFeatures(_,a){return this._isValidId(_)?this.style.querySourceFeatures(_,a):[]}isPointOnSurface(_){const{name:a}=this.transform.projection;return a!=="globe"&&a!=="mercator"&&l.w(`${a} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(l.P.convert(_))}setStyle(_,a){return(a=l.e({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},a)).diff!==!1&&a.localIdeographFontFamily===this._localIdeographFontFamily&&a.localFontFamily===this._localFontFamily&&this.style&&_?(this._diffStyle(_,a),this):(this._localIdeographFontFamily=a.localIdeographFontFamily,this._localFontFamily=a.localFontFamily,this._updateStyle(_,a))}_getUIString(_){const a=this._locale[_];if(a==null)throw new Error(`Missing UI string '${_}'`);return a}_updateStyle(_,a){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),_&&(this.style=new To(this,a||{}),this.style.setEventedParent(this,{style:this.style}),typeof _=="string"?this.style.loadURL(_):this.style.loadJSON(_)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new To(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(_,a){if(typeof _=="string"){const d=this._requestManager.normalizeStyleURL(_),g=this._requestManager.transformRequest(d,l.R.Style);l.g(g,(x,w)=>{x?this.fire(new l.a(x)):w&&this._updateDiff(w,a)})}else typeof _=="object"&&this._updateDiff(_,a)}_updateDiff(_,a){try{this.style.setState(_)&&this._update(!0)}catch(d){l.w(`Unable to perform style diff: ${d.message||d.error||d}.  Rebuilding the style from scratch.`),this._updateStyle(_,a)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(l.w("There is no style added to the map."),!1)}_isValidId(_){return _==null?(this.fire(new l.a(new Error("IDs can't be empty."))),!1):!l.c4(_)||(this.fire(new l.a(new Error(`IDs can't contain special symbols: "${_}".`))),!1)}addSource(_,a){return this._isValidId(_)?(this._lazyInitEmptyStyle(),this.style.addSource(_,a),this._update(!0)):this}isSourceLoaded(_){return!!this._isValidId(_)&&!!this.style&&this.style._isSourceCacheLoaded(_)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(_,a,d){this._lazyInitEmptyStyle(),this.style.addSourceType(_,a,d)}removeSource(_){return this._isValidId(_)?(this.style.removeSource(_),this._updateTerrain(),this._update(!0)):this}getSource(_){return this._isValidId(_)?this.style.getOwnSource(_):null}addImage(_,a,{pixelRatio:d=1,sdf:g=!1,stretchX:x,stretchY:w,content:S}={}){if(this._lazyInitEmptyStyle(),a instanceof HTMLImageElement||ImageBitmap&&a instanceof ImageBitmap){const{width:C,height:R,data:D}=l.f.getImageData(a);this.style.addImage(_,{data:new l.h({width:C,height:R},D),pixelRatio:d,stretchX:x,stretchY:w,content:S,sdf:g,version:0})}else if(a.width===void 0||a.height===void 0)this.fire(new l.a(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:C,height:R}=a,D=a;this.style.addImage(_,{data:new l.h({width:C,height:R},new Uint8Array(D.data)),pixelRatio:d,stretchX:x,stretchY:w,content:S,sdf:g,version:0,userImage:D}),D.onAdd&&D.onAdd(this,_)}}updateImage(_,a){this._lazyInitEmptyStyle();const d=this.style.getImage(_);if(!d)return void this.fire(new l.a(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const g=a instanceof HTMLImageElement||ImageBitmap&&a instanceof ImageBitmap?l.f.getImageData(a):a,{width:x,height:w}=g,S=g.data;if(x===void 0||w===void 0)return void this.fire(new l.a(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(x!==d.data.width||w!==d.data.height)return void this.fire(new l.a(new Error(`The width and height of the updated image (${x}, ${w})
                must be that same as the previous version of the image
                (${d.data.width}, ${d.data.height})`)));const C=!(a instanceof HTMLImageElement||ImageBitmap&&a instanceof ImageBitmap);d.data.replace(S,C),this.style.updateImage(_,d)}hasImage(_){return _?!!this.style&&!!this.style.getImage(_):(this.fire(new l.a(new Error("Missing required image id"))),!1)}removeImage(_){this.style.removeImage(_)}loadImage(_,a){l.d(this._requestManager.transformRequest(_,l.R.Image),(d,g)=>{a(d,g instanceof HTMLImageElement?l.f.getImageData(g):g)})}listImages(){return this.style.listImages()}addModel(_,a){this._lazyInitEmptyStyle(),this.style.addModel(_,a)}hasModel(_){return _?this.style.hasModel(_):(this.fire(new l.a(new Error("Missing required model id"))),!1)}removeModel(_){this.style.removeModel(_)}listModels(){return this.style.listModels()}addLayer(_,a){return this._isValidId(_.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(_,a),this._update(!0)):this}getSlot(_){const a=this.getLayer(_);return a&&a.slot||null}setSlot(_,a){return this.style.setSlot(_,a),this.style.mergeLayers(),this._update(!0)}addImport(_,a){return this.style.addImport(_,a),this}updateImport(_,a){return typeof a!="string"&&a.id!==_?(this.removeImport(_),this.addImport(a)):(this.style.updateImport(_,a),this._update(!0))}removeImport(_){return this.style.removeImport(_),this}moveImport(_,a){return this.style.moveImport(_,a),this._update(!0)}moveLayer(_,a){return this._isValidId(_)?(this.style.moveLayer(_,a),this._update(!0)):this}removeLayer(_){return this._isValidId(_)?(this.style.removeLayer(_),this._update(!0)):this}getLayer(_){return this._isValidId(_)?this.style.getOwnLayer(_):null}setLayerZoomRange(_,a,d){return this._isValidId(_)?(this.style.setLayerZoomRange(_,a,d),this._update(!0)):this}setFilter(_,a,d={}){return this._isValidId(_)?(this.style.setFilter(_,a,d),this._update(!0)):this}getFilter(_){return this._isValidId(_)?this.style.getFilter(_):null}setPaintProperty(_,a,d,g={}){return this._isValidId(_)?(this.style.setPaintProperty(_,a,d,g),this._update(!0)):this}getPaintProperty(_,a){return this._isValidId(_)?this.style.getPaintProperty(_,a):null}setLayoutProperty(_,a,d,g={}){return this._isValidId(_)?(this.style.setLayoutProperty(_,a,d,g),this._update(!0)):this}getLayoutProperty(_,a){return this._isValidId(_)?this.style.getLayoutProperty(_,a):null}getConfigProperty(_,a){return this.style.getConfigProperty(_,a)}setConfigProperty(_,a,d){return this.style.setConfigProperty(_,a,d),this._update(!0)}setLights(_){if(this._lazyInitEmptyStyle(),_&&_.length===1&&_[0].type==="flat"){const a=_[0];a.properties?this.style.setFlatLight(a.properties,a.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(_),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const _=this.style.getLights()||[];return _.length===0&&_.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),_}setLight(_,a={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:_}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(_){return this._lazyInitEmptyStyle(),!_&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(_),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(_){return this._lazyInitEmptyStyle(),this.style.setFog(_),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setCamera(_){return this.style.setCamera(_),this._triggerCameraUpdate(_)}_triggerCameraUpdate(_){return this._update(this.transform.setOrthographicProjectionAtLowPitch(_["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(_){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(l.bn.convert(_),this.transform):0}setFeatureState(_,a){return this._isValidId(_.source)?(this.style.setFeatureState(_,a),this._update()):this}removeFeatureState(_,a){return this._isValidId(_.source)?(this.style.removeFeatureState(_,a),this._update()):this}getFeatureState(_){return this._isValidId(_.source)?this.style.getFeatureState(_):null}_updateContainerDimensions(){if(!this._container)return;const _=this._container.getBoundingClientRect().width||400,a=this._container.getBoundingClientRect().height||300;let d,g,x,w=this._container;for(;w&&(!g||!x);){const S=window.getComputedStyle(w).transform;S&&S!=="none"&&(d=S.match(/matrix.*\((.+)\)/)[1].split(", "),d[0]&&d[0]!=="0"&&d[0]!=="1"&&(g=d[0]),d[3]&&d[3]!=="0"&&d[3]!=="1"&&(x=d[3])),w=w.parentElement}this._containerWidth=g?Math.abs(_/g):_,this._containerHeight=x?Math.abs(a/x):a}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&l.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const _=this._container;_.classList.add("mapboxgl-map"),(this._missingCSSCanary=U("div","mapboxgl-canary",_)).style.visibility="hidden",this._detectMissingCSS();const a=this._canvasContainer=U("div","mapboxgl-canvas-container",_);this._canvas=U("canvas","mapboxgl-canvas",a),this._interactive&&(a.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const d=this._controlContainer=U("div","mapboxgl-control-container",_),g=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(x=>{g[x]=U("div",`mapboxgl-ctrl-${x}`,d)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(_,a){const d=l.f.devicePixelRatio||1;this._canvas.width=d*Math.ceil(_),this._canvas.height=d*Math.ceil(a),this._canvas.style.width=`${_}px`,this._canvas.style.height=`${a}px`}_addMarker(_){this._markers.push(_)}_removeMarker(_){const a=this._markers.indexOf(_);a!==-1&&this._markers.splice(a,1)}_addPopup(_){this._popups.push(_)}_removePopup(_){const a=this._popups.indexOf(_);a!==-1&&this._popups.splice(a,1)}_setupPainter(){const _=l.e({},P.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),a=this._canvas.getContext("webgl2",_);a?(l.db(a,!0),this.painter=new wg(a,this._contextCreateOptions,this.transform,this._tp),this.on("data",d=>{d.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),l.dc.testSupport(a)):this.fire(new l.a(new Error("Failed to initialize WebGL")))}_contextLost(_){_.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new l.b("webglcontextlost",{originalEvent:_}))}_contextRestored(_){this._setupPainter(),this.resize(),this._update(),this.fire(new l.b("webglcontextrestored",{originalEvent:_}))}_onMapScroll(_){if(_.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(_){return this.style?(this._styleDirty=this._styleDirty||_,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(_){return this._update(),this._renderTaskQueue.add(_)}_cancelRenderFrame(_){this._renderTaskQueue.remove(_)}_requestDomTask(_){!this.loaded()||this.loaded()&&!this.isMoving()?_():this._domRenderTaskQueue.add(_)}_render(_){let a;this.fire(new l.b("renderstart"));const d=this.painter.context.extTimerQuery,g=l.f.now(),x=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(a=x.createQuery(),x.beginQuery(d.TIME_ELAPSED_EXT,a)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(_),this._domRenderTaskQueue.run(_),this._removed)return;this._updateProjectionTransition();const w=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const R=this.transform.zoom,D=this.transform.pitch,N=l.f.now(),B=new l.K(R,{now:N,fadeDuration:w,pitch:D,transition:this.style.transition});this.style.update(B)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let S=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),S=this._updateAverageElevation(g),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):S=this._updateAverageElevation(g),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,w,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries||this._debugParams.showTileBoundaries,showParseStatus:this.showParseStatus||this._debugParams.showParseStatus,wireframe:{terrain:this.showTerrainWireframe||this._debugParams.showTerrainWireframe,layers2D:this.showLayers2DWireframe||this._debugParams.showLayers2DWireframe,layers3D:this.showLayers3DWireframe||this._debugParams.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector||this._debugParams.showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs||this._debugParams.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:w,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding||this._debugParams.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new l.b("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new l.b("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),a){const R=l.f.now()-g;x.endQuery(d.TIME_ELAPSED_EXT),setTimeout(()=>{const D=x.getQueryParameter(a,x.QUERY_RESULT)/1e6;x.deleteQuery(a),this.fire(new l.b("gpu-timing-frame",{cpuTime:R,gpuTime:D}))},50)}if(this.listens("gpu-timing-layer")){const R=this.painter.collectGpuTimers();setTimeout(()=>{const D=this.painter.queryGpuTimers(R);this.fire(new l.b("gpu-timing-layer",{layerTimes:D}))},50)}if(this.listens("gpu-timing-deferred-render")){const R=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const D=this.painter.queryGpuTimeDeferredRender(R);this.fire(new l.b("gpu-timing-deferred-render",{gpuTime:D}))},50)}const C=this._sourcesDirty||this._styleDirty||this._placementDirty||S;if(C||this._repaint)this.triggerRepaint();else{const R=!this.isMoving()&&this.loaded();if(R&&(S=this._updateAverageElevation(g,!0)),S)this.triggerRepaint();else if(this._triggerFrame(!1),R&&(this.fire(new l.b("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const D=this._calculateSpeedIndex();this.fire(new l.b("speedindexcompleted",{speedIndex:D})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||C||(this._fullyLoaded=!0,this._performanceMetricsCollection&&l.dd(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(_){for(const a of this._markers)_&&!this.getRenderWorldCopies()&&(a._lngLat=a._lngLat.wrap()),a._update();for(const a of this._popups)!_||this.getRenderWorldCopies()||a._trackPointer||(a._lngLat=a._lngLat.wrap()),a._update()}_updateAverageElevation(_,a=!1){const d=x=>(this.transform.averageElevation=x,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&d(0);const g=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(g||(a||_-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(_)){const x=this.transform.averageElevation;let w=this.transform.sampleAverageElevation();this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(w)?w=0:this._averageElevationLastSampledAt=_;const S=Math.abs(x-w);if(S>1){if(this._isInitialLoad||g)return this._averageElevation.jumpTo(w),d(w);this._averageElevation.easeTo(w,_,300)}else if(S>1e-4)return this._averageElevation.jumpTo(w),d(w)}return!!this._averageElevation.isEasing(_)&&d(this._averageElevation.getValue(_))}_authenticate(){l.de(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,_=>{if(_&&(_.message===l.df||_.status===401)){const a=this.painter.context.gl;l.db(a,!1),this._logoControl instanceof kg&&this._logoControl._updateLogo(),a&&a.clear(a.DEPTH_BUFFER_BIT|a.COLOR_BUFFER_BIT|a.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new l.a(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),l.dg(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){const _=this._isDragging();this.painter.updateTerrain(this.style,_)}_calculateSpeedIndex(){const _=this.painter.canvasCopy(),a=this.painter.getCanvasCopiesAndTimestamps();a.timeStamps.push(performance.now());const d=this.painter.context.gl,g=d.createFramebuffer();function x(w){d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,w,0);const S=new Uint8Array(d.drawingBufferWidth*d.drawingBufferHeight*4);return d.readPixels(0,0,d.drawingBufferWidth,d.drawingBufferHeight,d.RGBA,d.UNSIGNED_BYTE,S),S}return d.bindFramebuffer(d.FRAMEBUFFER,g),this._canvasPixelComparison(x(_),a.canvasCopies.map(x),a.timeStamps)}_canvasPixelComparison(_,a,d){let g=d[1]-d[0];const x=_.length/4;for(let w=0;w<a.length;w++){const S=a[w];let C=0;for(let R=0;R<S.length;R+=4)S[R]===_[R]&&S[R+1]===_[R+1]&&S[R+2]===_[R+2]&&S[R+3]===_[R+3]&&(C+=1);g+=(d[w+2]-d[w+1])*(1-C/x)}return g}remove(){this._hash&&this._hash.remove();for(const a of this._controls)a.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const _=this.painter.context.gl.getExtension("WEBGL_lose_context");_&&_.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),l.dh(this.painter.context.gl),l.di.remove(),l.dj.remove(),this._removed=!0,this.fire(new l.b("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(_){this._renderNextFrame=this._renderNextFrame||_,this.style&&!this._frame&&(this._frame=l.f.frame(a=>{const d=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,d&&this._render(a)}))}_preloadTiles(_){const a=this.style?Object.values(this.style._sourceCaches):[];return l.b1(a,(d,g)=>d._preloadTiles(_,g),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(_){this._trackResize&&this.resize({originalEvent:_})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(_){this._showTileBoundaries!==_&&(this._showTileBoundaries=_,this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(_){this._showParseStatus!==_&&(this._showParseStatus=_,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(_){this._showTerrainWireframe!==_&&(this._showTerrainWireframe=_,this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(_){this._showLayers2DWireframe!==_&&(this._showLayers2DWireframe=_,this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(_){this._showLayers3DWireframe!==_&&(this._showLayers3DWireframe=_,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(_){this._speedIndexTiming!==_&&(this._speedIndexTiming=_,this._update())}get showPadding(){return!!this._showPadding}set showPadding(_){this._showPadding!==_&&(this._showPadding=_,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(_){this._showCollisionBoxes!==_&&(this._showCollisionBoxes=_,_?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(_){this._showOverdrawInspector!==_&&(this._showOverdrawInspector=_,this._update())}get repaint(){return!!this._repaint}set repaint(_){this._repaint!==_&&(this._repaint=_,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(_){this._vertices=_,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(_){this._showTileAABBs!==_&&(this._showTileAABBs=_,_&&this._update())}_setCacheLimits(_,a){l.dl(_,a)}get version(){return l.dk}},NavigationControl:class{constructor(_){this.options=l.e({},ld,_),this._container=U("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",a=>a.preventDefault()),this.options.showZoom&&(l.aY(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",a=>{this._map&&this._map.zoomIn({},{originalEvent:a})}),U("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",a=>{this._map&&this._map.zoomOut({},{originalEvent:a})}),U("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(l.aY(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",a=>{const d=this._map;d&&(this.options.visualizePitch?d.resetNorthPitch({},{originalEvent:a}):d.resetNorth({},{originalEvent:a}))}),this._compassIcon=U("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const _=this._map;if(!_)return;const a=_.getZoom(),d=a===_.getMaxZoom(),g=a===_.getMinZoom();this._zoomInButton.disabled=d,this._zoomOutButton.disabled=g,this._zoomInButton.setAttribute("aria-disabled",d.toString()),this._zoomOutButton.setAttribute("aria-disabled",g.toString())}_rotateCompassArrow(){const _=this._map;if(!_)return;const a=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(_.transform.pitch*(Math.PI/180)),.5)}) rotateX(${_.transform.pitch}deg) rotateZ(${_.transform.angle*(180/Math.PI)}deg)`:`rotate(${_.transform.angle*(180/Math.PI)}deg)`;_._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=a)})}onAdd(_){return this._map=_,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),_.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&_.on("pitch",this._rotateCompassArrow),_.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new sa(_,this._compass,this.options.visualizePitch)),this._container}onRemove(){const _=this._map;_&&(this._container.remove(),this.options.showZoom&&_.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&_.off("pitch",this._rotateCompassArrow),_.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(_,a){const d=U("button",_,this._container);return d.type="button",d.addEventListener("click",a),d}_setButtonTitle(_,a){if(!this._map)return;const d=this._map._getUIString(`NavigationControl.${a}`);_.setAttribute("aria-label",d),_.firstElementChild&&_.firstElementChild.setAttribute("title",d)}},GeolocateControl:class extends l.E{constructor(_){super();const a=navigator.geolocation;this.options=l.e({geolocation:a},cd,_),l.aY(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=wu(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(_){return this._map=_,this._container=U("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(_){const a=(d=!!this.options.geolocation)=>{this._supportsGeolocation=d,_(d)};this._supportsGeolocation!==void 0?_(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(d=>a(d.state!=="denied")).catch(()=>a()):a()}_isOutOfMapMaxBounds(_){const a=this._map.getMaxBounds(),d=_.coords;return!!a&&(d.longitude<a.getWest()||d.longitude>a.getEast()||d.latitude<a.getSouth()||d.latitude>a.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(_){if(this._map){if(this._isOutOfMapMaxBounds(_))return this._setErrorState(),this.fire(new l.b("outofmaxbounds",_)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=_,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(_),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(_),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new l.b("geolocate",_)),this._finish()}}_updateCamera(_){const a=new l.bn(_.coords.longitude,_.coords.latitude),d=_.coords.accuracy,g=this._map.getBearing(),x=l.e({bearing:g},this.options.fitBoundsOptions);this._map.fitBounds(a.toBounds(d),x,{geolocateSource:!0})}_updateMarker(_){if(_){const a=new l.bn(_.coords.longitude,_.coords.latitude);this._accuracyCircleMarker.setLngLat(a).addTo(this._map),this._userLocationDotMarker.setLngLat(a).addTo(this._map),this._accuracy=_.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const _=this._map.transform,a=l.bl(1,_._center.lat)*_.worldSize,d=Math.ceil(2*this._accuracy*a);this._circleElement.style.width=`${d}px`,this._circleElement.style.height=`${d}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(_){if(this._map){if(this.options.trackUserLocation)if(_.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const a=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",a),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",a),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(_.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new l.b("error",_)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(_){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",a=>a.preventDefault()),this._geolocateButton=U("button","mapboxgl-ctrl-geolocate",this._container),U("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",_===!1){l.w("Geolocation support is not available so the GeolocateControl will be disabled.");const a=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",a),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",a)}else{const a=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",a),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",a)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=U("div","mapboxgl-user-location"),this._dotElement.appendChild(U("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(U("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Qp({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=U("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Qp({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",a=>{a.geolocateSource||this._watchState!=="ACTIVE_LOCK"||a.originalEvent&&a.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new l.b("trackuserlocationend")))})}}_onDeviceOrientation(_){this._userLocationDotMarker&&(_.webkitCompassHeading?this._heading=_.webkitCompassHeading:_.absolute===!0&&(this._heading=-1*_.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return l.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new l.b("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new l.b("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new l.b("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let _;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(_={maximumAge:6e5,timeout:0},this._noTimeout=!0):(_=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,_),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const _=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(a=>{a==="granted"&&_()}).catch(console.error):_()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Jp,ScaleControl:class{constructor(_){this.options=l.e({},Ps,_),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),l.aY(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const _=this.options.maxWidth||100,a=this._map,d=a._containerHeight/2,g=a._containerWidth/2-_/2,x=a.unproject([g,d]),w=a.unproject([g+_,d]),S=x.distanceTo(w);if(this.options.unit==="imperial"){const C=3.2808*S;C>5280?this._setScale(_,C/5280,"mile"):this._setScale(_,C,"foot")}else this.options.unit==="nautical"?this._setScale(_,S/1852,"nautical-mile"):S>=1e3?this._setScale(_,S/1e3,"kilometer"):this._setScale(_,S,"meter")}_setScale(_,a,d){this._map._requestDomTask(()=>{const g=function(w){const S=Math.pow(10,`${Math.floor(w)}`.length-1);let C=w/S;return C=C>=10?10:C>=5?5:C>=3?3:C>=2?2:C>=1?1:function(R){const D=Math.pow(10,Math.ceil(-Math.log(R)/Math.LN10));return Math.round(R*D)/D}(C),S*C}(a),x=g/a;this._container.innerHTML=this._isNumberFormatSupported&&d!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:d}).format(g):`${g}&nbsp;${Va[d]}`,this._container.style.width=_*x+"px"})}onAdd(_){return this._map=_,this._language=_.getLanguage(),this._container=U("div","mapboxgl-ctrl mapboxgl-ctrl-scale",_.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(_){this._language=_,this._update()}setUnit(_){this.options.unit=_,this._update()}},FullscreenControl:class{constructor(_){this._fullscreen=!1,_&&_.container&&(_.container instanceof HTMLElement?this._container=_.container:l.w("Full screen control 'container' must be a DOM element.")),l.aY(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(_){return this._map=_,this._container||(this._container=this._map.getContainer()),this._controlContainer=U("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",l.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const _=this._fullscreenButton=U("button","mapboxgl-ctrl-fullscreen",this._controlContainer);U("span","mapboxgl-ctrl-icon",_).setAttribute("aria-hidden","true"),_.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const _=this._getTitle();this._fullscreenButton.setAttribute("aria-label",_),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",_)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends l.E{constructor(_){super(),this.options=l.e(Object.create(Lg),_),l.aY(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(_&&_.className?_.className.trim().split(/\s+/):[])}addTo(_){return this._map&&this.remove(),this._map=_,this.options.closeOnClick&&_.on("preclick",this._onClose),this.options.closeOnMove&&_.on("move",this._onClose),_.on("remove",this.remove),this._update(),_._addPopup(this),this._focusFirstElement(),this._trackPointer?(_.on("mousemove",this._onMouseEvent),_.on("mouseup",this._onMouseEvent),_._canvasContainer.classList.add("mapboxgl-track-pointer")):_.on("move",this._update),this.fire(new l.b("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const _=this._map;return _&&(_.off("move",this._update),_.off("move",this._onClose),_.off("preclick",this._onClose),_.off("click",this._onClose),_.off("remove",this.remove),_.off("mousemove",this._onMouseEvent),_.off("mouseup",this._onMouseEvent),_.off("drag",this._onMouseEvent),_._canvasContainer&&_._canvasContainer.classList.remove("mapboxgl-track-pointer"),_._removePopup(this),this._map=void 0),this.fire(new l.b("close")),this}getLngLat(){return this._lngLat}setLngLat(_){this._lngLat=l.bn.convert(_),this._pos=null,this._trackPointer=!1,this._update();const a=this._map;return a&&(a.on("move",this._update),a.off("mousemove",this._onMouseEvent),a._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const _=this._map;return _&&(_.off("move",this._update),_.on("mousemove",this._onMouseEvent),_.on("drag",this._onMouseEvent),_._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(_){return this.setDOMContent(document.createTextNode(_))}setHTML(_){const a=document.createDocumentFragment(),d=document.createElement("body");let g;for(d.innerHTML=_;g=d.firstChild,g;)a.appendChild(g);return this.setDOMContent(a)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(_){return this.options.maxWidth=_,this._update(),this}setDOMContent(_){let a=this._content;if(a)for(;a.hasChildNodes();)a.firstChild&&a.removeChild(a.firstChild);else a=this._content=U("div","mapboxgl-popup-content",this._container||void 0);if(a.appendChild(_),this.options.closeButton){const d=this._closeButton=U("button","mapboxgl-popup-close-button",a);d.type="button",d.setAttribute("aria-label","Close popup"),d.setAttribute("aria-hidden","true"),d.innerHTML="&#215;",d.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(_){return this._classList.add(_),this._updateClassList(),this}removeClassName(_){return this._classList.delete(_),this._updateClassList(),this}setOffset(_){return this.options.offset=_,this._update(),this}toggleClassName(_){let a;return this._classList.delete(_)?a=!1:(this._classList.add(_),a=!0),this._updateClassList(),a}_onMouseEvent(_){this._update(_.point)}_getAnchor(_){if(this.options.anchor)return this.options.anchor;const a=this._map,d=this._container,g=this._pos;if(!a||!d||!g)return"bottom";const x=d.offsetWidth,w=d.offsetHeight,S=g.x<x/2,C=g.x>a.transform.width-x/2;if(g.y+_<w)return S?"top-left":C?"top-right":"top";if(g.y>a.transform.height-w){if(S)return"bottom-left";if(C)return"bottom-right"}return S?"left":C?"right":"bottom"}_updateClassList(){const _=this._container;if(!_)return;const a=[...this._classList];a.push("mapboxgl-popup"),this._anchor&&a.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&a.push("mapboxgl-popup-track-pointer"),_.className=a.join(" ")}_update(_){const a=this._map,d=this._content;if(!a||!this._lngLat&&!this._trackPointer||!d)return;let g=this._container;if(g||(g=this._container=U("div","mapboxgl-popup",a.getContainer()),this._tip=U("div","mapboxgl-popup-tip",g),g.appendChild(d)),this.options.maxWidth&&g.style.maxWidth!==this.options.maxWidth&&(g.style.maxWidth=this.options.maxWidth),a.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=ku(this._lngLat,this._pos,a.transform)),!this._trackPointer||_){const x=this._pos=this._trackPointer&&_?_:a.project(this._lngLat),w=Fg(this.options.offset),S=this._anchor=this._getAnchor(w.y),C=Fg(this.options.offset,S),R=x.add(C).round();a._requestDomTask(()=>{this._container&&S&&(this._container.style.transform=`${ad[S]} translate(${R.x}px,${R.y}px)`)})}if(!this._marker&&a._showingGlobe()){const x=l.d6(a.transform,this._lngLat)?0:1;this._setOpacity(x)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const _=this._container.querySelector(Ng);_&&_.focus()}_onClose(){this.remove()}_setOpacity(_){this._container&&(this._container.style.opacity=`${_}`),this._content&&(this._content.style.pointerEvents=_?"auto":"none")}},Marker:Qp,Style:To,LngLat:l.bn,LngLatBounds:l.ad,Point:l.P,MercatorCoordinate:l.L,FreeCameraOptions:su,Evented:l.E,config:l.d5,prewarm:l.dp,clearPrewarmedResources:l.dq,get accessToken(){return l.d5.ACCESS_TOKEN},set accessToken(_){l.d5.ACCESS_TOKEN=_},get baseApiUrl(){return l.d5.API_URL},set baseApiUrl(_){l.d5.API_URL=_},get workerCount(){return l.dr.workerCount},set workerCount(_){l.dr.workerCount=_},get maxParallelImageRequests(){return l.d5.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(_){l.d5.MAX_PARALLEL_IMAGE_REQUESTS=_},clearStorage(_){l.ds(_)},get workerUrl(){return l.dt.workerUrl},set workerUrl(_){l.dt.workerUrl=_},get workerClass(){return l.dt.workerClass},set workerClass(_){l.dt.workerClass=_},get workerParams(){return l.dt.workerParams},set workerParams(_){l.dt.workerParams=_},get dracoUrl(){return l.du()},set dracoUrl(_){l.dv(_)},get meshoptUrl(){return l.dw()},set meshoptUrl(_){l.dx(_)},setNow:l.f.setNow,restoreNow:l.f.restoreNow}});var v=h;return v})})(pN);var OJ=pN.exports;const nO=i1(OJ);function kJ(t){let e,i="",s,c,h,p='<div id="cesiumContainer" style="" class="svelte-9iqq6b"></div>',v,l;return{c(){e=Vt("script"),e.innerHTML=i,c=or(),h=Vt("div"),h.innerHTML=p,this.h()},l(A){const P=nk("svelte-rc6uig",document.head);e=jt(P,"SCRIPT",{src:!0,"data-svelte-h":!0}),rn(e)!=="svelte-qvkiq1"&&(e.innerHTML=i),P.forEach(bt),c=ar(A),h=jt(A,"DIV",{class:!0,"data-svelte-h":!0}),rn(h)!=="svelte-xdau3z"&&(h.innerHTML=p),this.h()},h(){$z(e.src,s="https://ajax.googleapis.com/ajax/libs/cesiumjs/1.105/Build/Cesium/Cesium.js")||tt(e,"src",s),tt(h,"class","parent svelte-9iqq6b")},m(A,P){Et(document.head,e),Zi(A,c,P),Zi(A,h,P),v||(l=Ss(e,"load",t[0]),v=!0)},p:Es,i:Es,o:Es,d(A){A&&(bt(c),bt(h)),bt(e),v=!1,l()}}}function DJ(t,e,i){const s="AIzaSyBRQrRe8Ife25sH5b32ELrhwqkABnlXAqM";let{coords:c}=e;function h(){console.log("playing");const p=new Cesium.Viewer("cesiumContainer",{imageryProvider:!1,requestRenderMode:!0,navigationHelpButton:!1,animation:!1,timeline:!1,baseLayerPicker:!1,geocoder:!1,sceneModePicker:!1,fullscreenButton:!1,homeButton:!1,infoBox:!1,selectionIndicator:!1,navigationInstructionsInitiallyVisible:!1});p.scene.primitives.add(new Cesium.Cesium3DTileset({url:`https://tile.googleapis.com/v1/3dtiles/root.json?key=${s}`}));var v=.96,l=-1.2,A=0,P=400;console.log("setting coords",c[0],c[1]);var O=Cesium.Cartesian3.fromDegrees(c[0]-2e-4,c[1]-1e-4,P),L={heading:v,pitch:l,roll:A};p.camera.setView({destination:O,orientation:L,endTransform:Cesium.Matrix4.IDENTITY}),p.camera.changed.addEventListener(function(){var U=p.camera.positionCartographic,H=Cesium.Math.toDegrees(U.latitude),Y=Cesium.Math.toDegrees(U.longitude),J=p.camera.heading,oe=p.camera.pitch,me=p.camera.roll;console.log(Y,H,J,oe,me)})}return t1(async()=>{}),t.$$set=p=>{"coords"in p&&i(1,c=p.coords)},t.$$.update=()=>{t.$$.dirty&2&&console.log(c)},[h,c]}class LJ extends Xc{constructor(e){super(),Zc(this,e,DJ,kJ,zl,{coords:1})}}const NJ=t=>{let e;return t?e=t:typeof fetch>"u"?e=(...i)=>ff(()=>Promise.resolve().then(()=>W_),void 0,import.meta.url).then(({default:s})=>s(...i)):e=fetch,(...i)=>e(...i)};class VE extends Error{constructor(e,i="FunctionsError",s){super(e),this.name=i,this.context=s}}class FJ extends VE{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class BJ extends VE{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class zJ extends VE{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var GT;(function(t){t.Any="any",t.ApNortheast1="ap-northeast-1",t.ApNortheast2="ap-northeast-2",t.ApSouth1="ap-south-1",t.ApSoutheast1="ap-southeast-1",t.ApSoutheast2="ap-southeast-2",t.CaCentral1="ca-central-1",t.EuCentral1="eu-central-1",t.EuWest1="eu-west-1",t.EuWest2="eu-west-2",t.EuWest3="eu-west-3",t.SaEast1="sa-east-1",t.UsEast1="us-east-1",t.UsWest1="us-west-1",t.UsWest2="us-west-2"})(GT||(GT={}));var UJ=function(t,e,i,s){function c(h){return h instanceof i?h:new i(function(p){p(h)})}return new(i||(i=Promise))(function(h,p){function v(P){try{A(s.next(P))}catch(O){p(O)}}function l(P){try{A(s.throw(P))}catch(O){p(O)}}function A(P){P.done?h(P.value):c(P.value).then(v,l)}A((s=s.apply(t,e||[])).next())})};class VJ{constructor(e,{headers:i={},customFetch:s,region:c=GT.Any}={}){this.url=e,this.headers=i,this.region=c,this.fetch=NJ(s)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,i={}){var s;return UJ(this,void 0,void 0,function*(){try{const{headers:c,method:h,body:p}=i;let v={},{region:l}=i;l||(l=this.region),l&&l!=="any"&&(v["x-region"]=l);let A;p&&(c&&!Object.prototype.hasOwnProperty.call(c,"Content-Type")||!c)&&(typeof Blob<"u"&&p instanceof Blob||p instanceof ArrayBuffer?(v["Content-Type"]="application/octet-stream",A=p):typeof p=="string"?(v["Content-Type"]="text/plain",A=p):typeof FormData<"u"&&p instanceof FormData?A=p:(v["Content-Type"]="application/json",A=JSON.stringify(p)));const P=yield this.fetch(`${this.url}/${e}`,{method:h||"POST",headers:Object.assign(Object.assign(Object.assign({},v),this.headers),c),body:A}).catch(H=>{throw new FJ(H)}),O=P.headers.get("x-relay-error");if(O&&O==="true")throw new BJ(P);if(!P.ok)throw new zJ(P);let L=((s=P.headers.get("Content-Type"))!==null&&s!==void 0?s:"text/plain").split(";")[0].trim(),U;return L==="application/json"?U=yield P.json():L==="application/octet-stream"?U=yield P.blob():L==="text/event-stream"?U=P:L==="multipart/form-data"?U=yield P.formData():U=yield P.text(),{data:U,error:null}}catch(c){return{data:null,error:c}}})}}var jJ=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},Mf=jJ();const $J=Mf.fetch,jE=Mf.fetch.bind(Mf),_N=Mf.Headers,WJ=Mf.Request,HJ=Mf.Response,W_=Object.freeze(Object.defineProperty({__proto__:null,Headers:_N,Request:WJ,Response:HJ,default:jE,fetch:$J},Symbol.toStringTag,{value:"Module"}));class qJ extends Error{constructor(e){super(e.message),this.name="PostgrestError",this.details=e.details,this.hint=e.hint,this.code=e.code}}class GJ{constructor(e){this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=e.headers,this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=e.shouldThrowOnError,this.signal=e.signal,this.isMaybeSingle=e.isMaybeSingle,e.fetch?this.fetch=e.fetch:typeof fetch>"u"?this.fetch=jE:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}then(e,i){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers["Accept-Profile"]=this.schema:this.headers["Content-Profile"]=this.schema),this.method!=="GET"&&this.method!=="HEAD"&&(this.headers["Content-Type"]="application/json");const s=this.fetch;let c=s(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async h=>{var p,v,l;let A=null,P=null,O=null,L=h.status,U=h.statusText;if(h.ok){if(this.method!=="HEAD"){const oe=await h.text();oe===""||(this.headers.Accept==="text/csv"||this.headers.Accept&&this.headers.Accept.includes("application/vnd.pgrst.plan+text")?P=oe:P=JSON.parse(oe))}const Y=(p=this.headers.Prefer)===null||p===void 0?void 0:p.match(/count=(exact|planned|estimated)/),J=(v=h.headers.get("content-range"))===null||v===void 0?void 0:v.split("/");Y&&J&&J.length>1&&(O=parseInt(J[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(P)&&(P.length>1?(A={code:"PGRST116",details:`Results contain ${P.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},P=null,O=null,L=406,U="Not Acceptable"):P.length===1?P=P[0]:P=null)}else{const Y=await h.text();try{A=JSON.parse(Y),Array.isArray(A)&&h.status===404&&(P=[],A=null,L=200,U="OK")}catch{h.status===404&&Y===""?(L=204,U="No Content"):A={message:Y}}if(A&&this.isMaybeSingle&&(!((l=A==null?void 0:A.details)===null||l===void 0)&&l.includes("0 rows"))&&(A=null,L=200,U="OK"),A&&this.shouldThrowOnError)throw new qJ(A)}return{error:A,data:P,count:O,status:L,statusText:U}});return this.shouldThrowOnError||(c=c.catch(h=>{var p,v,l;return{error:{message:`${(p=h==null?void 0:h.name)!==null&&p!==void 0?p:"FetchError"}: ${h==null?void 0:h.message}`,details:`${(v=h==null?void 0:h.stack)!==null&&v!==void 0?v:""}`,hint:"",code:`${(l=h==null?void 0:h.code)!==null&&l!==void 0?l:""}`},data:null,count:null,status:0,statusText:""}})),c.then(e,i)}}class XJ extends GJ{select(e){let i=!1;const s=(e??"*").split("").map(c=>/\s/.test(c)&&!i?"":(c==='"'&&(i=!i),c)).join("");return this.url.searchParams.set("select",s),this.headers.Prefer&&(this.headers.Prefer+=","),this.headers.Prefer+="return=representation",this}order(e,{ascending:i=!0,nullsFirst:s,foreignTable:c,referencedTable:h=c}={}){const p=h?`${h}.order`:"order",v=this.url.searchParams.get(p);return this.url.searchParams.set(p,`${v?`${v},`:""}${e}.${i?"asc":"desc"}${s===void 0?"":s?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:i,referencedTable:s=i}={}){const c=typeof s>"u"?"limit":`${s}.limit`;return this.url.searchParams.set(c,`${e}`),this}range(e,i,{foreignTable:s,referencedTable:c=s}={}){const h=typeof c>"u"?"offset":`${c}.offset`,p=typeof c>"u"?"limit":`${c}.limit`;return this.url.searchParams.set(h,`${e}`),this.url.searchParams.set(p,`${i-e+1}`),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.Accept="application/vnd.pgrst.object+json",this}maybeSingle(){return this.method==="GET"?this.headers.Accept="application/json":this.headers.Accept="application/vnd.pgrst.object+json",this.isMaybeSingle=!0,this}csv(){return this.headers.Accept="text/csv",this}geojson(){return this.headers.Accept="application/geo+json",this}explain({analyze:e=!1,verbose:i=!1,settings:s=!1,buffers:c=!1,wal:h=!1,format:p="text"}={}){var v;const l=[e?"analyze":null,i?"verbose":null,s?"settings":null,c?"buffers":null,h?"wal":null].filter(Boolean).join("|"),A=(v=this.headers.Accept)!==null&&v!==void 0?v:"application/json";return this.headers.Accept=`application/vnd.pgrst.plan+${p}; for="${A}"; options=${l};`,p==="json"?this:this}rollback(){var e;return((e=this.headers.Prefer)!==null&&e!==void 0?e:"").trim().length>0?this.headers.Prefer+=",tx=rollback":this.headers.Prefer="tx=rollback",this}returns(){return this}}class Hd extends XJ{eq(e,i){return this.url.searchParams.append(e,`eq.${i}`),this}neq(e,i){return this.url.searchParams.append(e,`neq.${i}`),this}gt(e,i){return this.url.searchParams.append(e,`gt.${i}`),this}gte(e,i){return this.url.searchParams.append(e,`gte.${i}`),this}lt(e,i){return this.url.searchParams.append(e,`lt.${i}`),this}lte(e,i){return this.url.searchParams.append(e,`lte.${i}`),this}like(e,i){return this.url.searchParams.append(e,`like.${i}`),this}likeAllOf(e,i){return this.url.searchParams.append(e,`like(all).{${i.join(",")}}`),this}likeAnyOf(e,i){return this.url.searchParams.append(e,`like(any).{${i.join(",")}}`),this}ilike(e,i){return this.url.searchParams.append(e,`ilike.${i}`),this}ilikeAllOf(e,i){return this.url.searchParams.append(e,`ilike(all).{${i.join(",")}}`),this}ilikeAnyOf(e,i){return this.url.searchParams.append(e,`ilike(any).{${i.join(",")}}`),this}is(e,i){return this.url.searchParams.append(e,`is.${i}`),this}in(e,i){const s=Array.from(new Set(i)).map(c=>typeof c=="string"&&new RegExp("[,()]").test(c)?`"${c}"`:`${c}`).join(",");return this.url.searchParams.append(e,`in.(${s})`),this}contains(e,i){return typeof i=="string"?this.url.searchParams.append(e,`cs.${i}`):Array.isArray(i)?this.url.searchParams.append(e,`cs.{${i.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(i)}`),this}containedBy(e,i){return typeof i=="string"?this.url.searchParams.append(e,`cd.${i}`):Array.isArray(i)?this.url.searchParams.append(e,`cd.{${i.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(i)}`),this}rangeGt(e,i){return this.url.searchParams.append(e,`sr.${i}`),this}rangeGte(e,i){return this.url.searchParams.append(e,`nxl.${i}`),this}rangeLt(e,i){return this.url.searchParams.append(e,`sl.${i}`),this}rangeLte(e,i){return this.url.searchParams.append(e,`nxr.${i}`),this}rangeAdjacent(e,i){return this.url.searchParams.append(e,`adj.${i}`),this}overlaps(e,i){return typeof i=="string"?this.url.searchParams.append(e,`ov.${i}`):this.url.searchParams.append(e,`ov.{${i.join(",")}}`),this}textSearch(e,i,{config:s,type:c}={}){let h="";c==="plain"?h="pl":c==="phrase"?h="ph":c==="websearch"&&(h="w");const p=s===void 0?"":`(${s})`;return this.url.searchParams.append(e,`${h}fts${p}.${i}`),this}match(e){return Object.entries(e).forEach(([i,s])=>{this.url.searchParams.append(i,`eq.${s}`)}),this}not(e,i,s){return this.url.searchParams.append(e,`not.${i}.${s}`),this}or(e,{foreignTable:i,referencedTable:s=i}={}){const c=s?`${s}.or`:"or";return this.url.searchParams.append(c,`(${e})`),this}filter(e,i,s){return this.url.searchParams.append(e,`${i}.${s}`),this}}class ZJ{constructor(e,{headers:i={},schema:s,fetch:c}){this.url=e,this.headers=i,this.schema=s,this.fetch=c}select(e,{head:i=!1,count:s}={}){const c=i?"HEAD":"GET";let h=!1;const p=(e??"*").split("").map(v=>/\s/.test(v)&&!h?"":(v==='"'&&(h=!h),v)).join("");return this.url.searchParams.set("select",p),s&&(this.headers.Prefer=`count=${s}`),new Hd({method:c,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}insert(e,{count:i,defaultToNull:s=!0}={}){const c="POST",h=[];if(this.headers.Prefer&&h.push(this.headers.Prefer),i&&h.push(`count=${i}`),s||h.push("missing=default"),this.headers.Prefer=h.join(","),Array.isArray(e)){const p=e.reduce((v,l)=>v.concat(Object.keys(l)),[]);if(p.length>0){const v=[...new Set(p)].map(l=>`"${l}"`);this.url.searchParams.set("columns",v.join(","))}}return new Hd({method:c,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}upsert(e,{onConflict:i,ignoreDuplicates:s=!1,count:c,defaultToNull:h=!0}={}){const p="POST",v=[`resolution=${s?"ignore":"merge"}-duplicates`];if(i!==void 0&&this.url.searchParams.set("on_conflict",i),this.headers.Prefer&&v.push(this.headers.Prefer),c&&v.push(`count=${c}`),h||v.push("missing=default"),this.headers.Prefer=v.join(","),Array.isArray(e)){const l=e.reduce((A,P)=>A.concat(Object.keys(P)),[]);if(l.length>0){const A=[...new Set(l)].map(P=>`"${P}"`);this.url.searchParams.set("columns",A.join(","))}}return new Hd({method:p,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}update(e,{count:i}={}){const s="PATCH",c=[];return this.headers.Prefer&&c.push(this.headers.Prefer),i&&c.push(`count=${i}`),this.headers.Prefer=c.join(","),new Hd({method:s,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}delete({count:e}={}){const i="DELETE",s=[];return e&&s.push(`count=${e}`),this.headers.Prefer&&s.unshift(this.headers.Prefer),this.headers.Prefer=s.join(","),new Hd({method:i,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}}const YJ="1.15.2",KJ={"X-Client-Info":`postgrest-js/${YJ}`};class $E{constructor(e,{headers:i={},schema:s,fetch:c}={}){this.url=e,this.headers=Object.assign(Object.assign({},KJ),i),this.schemaName=s,this.fetch=c}from(e){const i=new URL(`${this.url}/${e}`);return new ZJ(i,{headers:Object.assign({},this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new $E(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,i={},{head:s=!1,get:c=!1,count:h}={}){let p;const v=new URL(`${this.url}/rpc/${e}`);let l;s||c?(p=s?"HEAD":"GET",Object.entries(i).filter(([P,O])=>O!==void 0).map(([P,O])=>[P,Array.isArray(O)?`{${O.join(",")}}`:`${O}`]).forEach(([P,O])=>{v.searchParams.append(P,O)})):(p="POST",l=i);const A=Object.assign({},this.headers);return h&&(A.Prefer=`count=${h}`),new Hd({method:p,url:v,headers:A,schema:this.schemaName,body:l,fetch:this.fetch,allowEmpty:!1})}}const JJ="2.9.5",QJ={"X-Client-Info":`realtime-js/${JJ}`},eQ="1.0.0",gN=1e4,tQ=1e3;var cf;(function(t){t[t.connecting=0]="connecting",t[t.open=1]="open",t[t.closing=2]="closing",t[t.closed=3]="closed"})(cf||(cf={}));var Lo;(function(t){t.closed="closed",t.errored="errored",t.joined="joined",t.joining="joining",t.leaving="leaving"})(Lo||(Lo={}));var _a;(function(t){t.close="phx_close",t.error="phx_error",t.join="phx_join",t.reply="phx_reply",t.leave="phx_leave",t.access_token="access_token"})(_a||(_a={}));var XT;(function(t){t.websocket="websocket"})(XT||(XT={}));var Qu;(function(t){t.Connecting="connecting",t.Open="open",t.Closing="closing",t.Closed="closed"})(Qu||(Qu={}));class yN{constructor(e,i){this.callback=e,this.timerCalc=i,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=i}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}class iQ{constructor(){this.HEADER_LENGTH=1}decode(e,i){return e.constructor===ArrayBuffer?i(this._binaryDecode(e)):i(typeof e=="string"?JSON.parse(e):{})}_binaryDecode(e){const i=new DataView(e),s=new TextDecoder;return this._decodeBroadcast(e,i,s)}_decodeBroadcast(e,i,s){const c=i.getUint8(1),h=i.getUint8(2);let p=this.HEADER_LENGTH+2;const v=s.decode(e.slice(p,p+c));p=p+c;const l=s.decode(e.slice(p,p+h));p=p+h;const A=JSON.parse(s.decode(e.slice(p,e.byteLength)));return{ref:null,topic:v,event:l,payload:A}}}class aw{constructor(e,i,s={},c=gN){this.channel=e,this.event=i,this.payload=s,this.timeout=c,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,i){var s;return this._hasReceived(e)&&i((s=this.receivedResp)===null||s===void 0?void 0:s.response),this.recHooks.push({status:e,callback:i}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=i=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=i,this._matchReceive(i)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,i){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:i})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:i}){this.recHooks.filter(s=>s.status===e).forEach(s=>s.callback(i))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var sO;(function(t){t.SYNC="sync",t.JOIN="join",t.LEAVE="leave"})(sO||(sO={}));class h_{constructor(e,i){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const s=(i==null?void 0:i.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(s.state,{},c=>{const{onJoin:h,onLeave:p,onSync:v}=this.caller;this.joinRef=this.channel._joinRef(),this.state=h_.syncState(this.state,c,h,p),this.pendingDiffs.forEach(l=>{this.state=h_.syncDiff(this.state,l,h,p)}),this.pendingDiffs=[],v()}),this.channel._on(s.diff,{},c=>{const{onJoin:h,onLeave:p,onSync:v}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(c):(this.state=h_.syncDiff(this.state,c,h,p),v())}),this.onJoin((c,h,p)=>{this.channel._trigger("presence",{event:"join",key:c,currentPresences:h,newPresences:p})}),this.onLeave((c,h,p)=>{this.channel._trigger("presence",{event:"leave",key:c,currentPresences:h,leftPresences:p})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,i,s,c){const h=this.cloneDeep(e),p=this.transformState(i),v={},l={};return this.map(h,(A,P)=>{p[A]||(l[A]=P)}),this.map(p,(A,P)=>{const O=h[A];if(O){const L=P.map(J=>J.presence_ref),U=O.map(J=>J.presence_ref),H=P.filter(J=>U.indexOf(J.presence_ref)<0),Y=O.filter(J=>L.indexOf(J.presence_ref)<0);H.length>0&&(v[A]=H),Y.length>0&&(l[A]=Y)}else v[A]=P}),this.syncDiff(h,{joins:v,leaves:l},s,c)}static syncDiff(e,i,s,c){const{joins:h,leaves:p}={joins:this.transformState(i.joins),leaves:this.transformState(i.leaves)};return s||(s=()=>{}),c||(c=()=>{}),this.map(h,(v,l)=>{var A;const P=(A=e[v])!==null&&A!==void 0?A:[];if(e[v]=this.cloneDeep(l),P.length>0){const O=e[v].map(U=>U.presence_ref),L=P.filter(U=>O.indexOf(U.presence_ref)<0);e[v].unshift(...L)}s(v,P,l)}),this.map(p,(v,l)=>{let A=e[v];if(!A)return;const P=l.map(O=>O.presence_ref);A=A.filter(O=>P.indexOf(O.presence_ref)<0),e[v]=A,c(v,A,l),A.length===0&&delete e[v]}),e}static map(e,i){return Object.getOwnPropertyNames(e).map(s=>i(s,e[s]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((i,s)=>{const c=e[s];return"metas"in c?i[s]=c.metas.map(h=>(h.presence_ref=h.phx_ref,delete h.phx_ref,delete h.phx_ref_prev,h)):i[s]=c,i},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var Fn;(function(t){t.abstime="abstime",t.bool="bool",t.date="date",t.daterange="daterange",t.float4="float4",t.float8="float8",t.int2="int2",t.int4="int4",t.int4range="int4range",t.int8="int8",t.int8range="int8range",t.json="json",t.jsonb="jsonb",t.money="money",t.numeric="numeric",t.oid="oid",t.reltime="reltime",t.text="text",t.time="time",t.timestamp="timestamp",t.timestamptz="timestamptz",t.timetz="timetz",t.tsrange="tsrange",t.tstzrange="tstzrange"})(Fn||(Fn={}));const oO=(t,e,i={})=>{var s;const c=(s=i.skipTypes)!==null&&s!==void 0?s:[];return Object.keys(e).reduce((h,p)=>(h[p]=rQ(p,t,e,c),h),{})},rQ=(t,e,i,s)=>{const c=e.find(v=>v.name===t),h=c==null?void 0:c.type,p=i[t];return h&&!s.includes(h)?vN(h,p):ZT(p)},vN=(t,e)=>{if(t.charAt(0)==="_"){const i=t.slice(1,t.length);return aQ(e,i)}switch(t){case Fn.bool:return nQ(e);case Fn.float4:case Fn.float8:case Fn.int2:case Fn.int4:case Fn.int8:case Fn.numeric:case Fn.oid:return sQ(e);case Fn.json:case Fn.jsonb:return oQ(e);case Fn.timestamp:return lQ(e);case Fn.abstime:case Fn.date:case Fn.daterange:case Fn.int4range:case Fn.int8range:case Fn.money:case Fn.reltime:case Fn.text:case Fn.time:case Fn.timestamptz:case Fn.timetz:case Fn.tsrange:case Fn.tstzrange:return ZT(e);default:return ZT(e)}},ZT=t=>t,nQ=t=>{switch(t){case"t":return!0;case"f":return!1;default:return t}},sQ=t=>{if(typeof t=="string"){const e=parseFloat(t);if(!Number.isNaN(e))return e}return t},oQ=t=>{if(typeof t=="string")try{return JSON.parse(t)}catch(e){return console.log(`JSON parse error: ${e}`),t}return t},aQ=(t,e)=>{if(typeof t!="string")return t;const i=t.length-1,s=t[i];if(t[0]==="{"&&s==="}"){let h;const p=t.slice(1,i);try{h=JSON.parse("["+p+"]")}catch{h=p?p.split(","):[]}return h.map(v=>vN(e,v))}return t},lQ=t=>typeof t=="string"?t.replace(" ","T"):t;var aO;(function(t){t.ALL="*",t.INSERT="INSERT",t.UPDATE="UPDATE",t.DELETE="DELETE"})(aO||(aO={}));var lO;(function(t){t.BROADCAST="broadcast",t.PRESENCE="presence",t.POSTGRES_CHANGES="postgres_changes"})(lO||(lO={}));var cO;(function(t){t.SUBSCRIBED="SUBSCRIBED",t.TIMED_OUT="TIMED_OUT",t.CLOSED="CLOSED",t.CHANNEL_ERROR="CHANNEL_ERROR"})(cO||(cO={}));class WE{constructor(e,i={config:{}},s){this.topic=e,this.params=i,this.socket=s,this.bindings={},this.state=Lo.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:""}},i.config),this.timeout=this.socket.timeout,this.joinPush=new aw(this,_a.join,this.params,this.timeout),this.rejoinTimer=new yN(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=Lo.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(c=>c.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=Lo.closed,this.socket._remove(this)}),this._onError(c=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,c),this.state=Lo.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=Lo.errored,this.rejoinTimer.scheduleTimeout())}),this._on(_a.reply,{},(c,h)=>{this._trigger(this._replyEventName(h),c)}),this.presence=new h_(this),this.broadcastEndpointURL=this._broadcastEndpointURL()}subscribe(e,i=this.timeout){var s,c;if(this.socket.isConnected()||this.socket.connect(),this.joinedOnce)throw"tried to subscribe multiple times. 'subscribe' can only be called a single time per channel instance";{const{config:{broadcast:h,presence:p}}=this.params;this._onError(A=>e&&e("CHANNEL_ERROR",A)),this._onClose(()=>e&&e("CLOSED"));const v={},l={broadcast:h,presence:p,postgres_changes:(c=(s=this.bindings.postgres_changes)===null||s===void 0?void 0:s.map(A=>A.filter))!==null&&c!==void 0?c:[]};this.socket.accessToken&&(v.access_token=this.socket.accessToken),this.updateJoinPayload(Object.assign({config:l},v)),this.joinedOnce=!0,this._rejoin(i),this.joinPush.receive("ok",({postgres_changes:A})=>{var P;if(this.socket.accessToken&&this.socket.setAuth(this.socket.accessToken),A===void 0){e&&e("SUBSCRIBED");return}else{const O=this.bindings.postgres_changes,L=(P=O==null?void 0:O.length)!==null&&P!==void 0?P:0,U=[];for(let H=0;H<L;H++){const Y=O[H],{filter:{event:J,schema:oe,table:me,filter:pe}}=Y,be=A&&A[H];if(be&&be.event===J&&be.schema===oe&&be.table===me&&be.filter===pe)U.push(Object.assign(Object.assign({},Y),{id:be.id}));else{this.unsubscribe(),e&&e("CHANNEL_ERROR",new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=U,e&&e("SUBSCRIBED");return}}).receive("error",A=>{e&&e("CHANNEL_ERROR",new Error(JSON.stringify(Object.values(A).join(", ")||"error")))}).receive("timeout",()=>{e&&e("TIMED_OUT")})}return this}presenceState(){return this.presence.state}async track(e,i={}){return await this.send({type:"presence",event:"track",payload:e},i.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,i,s){return this._on(e,i,s)}async send(e,i={}){var s,c;if(!this._canPush()&&e.type==="broadcast"){const{event:h,payload:p}=e,v={method:"POST",headers:{apikey:(s=this.socket.apiKey)!==null&&s!==void 0?s:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:h,payload:p}]})};try{return(await this._fetchWithTimeout(this.broadcastEndpointURL,v,(c=i.timeout)!==null&&c!==void 0?c:this.timeout)).ok?"ok":"error"}catch(l){return l.name==="AbortError"?"timed out":"error"}}else return new Promise(h=>{var p,v,l;const A=this._push(e.type,e,i.timeout||this.timeout);e.type==="broadcast"&&!(!((l=(v=(p=this.params)===null||p===void 0?void 0:p.config)===null||v===void 0?void 0:v.broadcast)===null||l===void 0)&&l.ack)&&h("ok"),A.receive("ok",()=>h("ok")),A.receive("error",()=>h("error")),A.receive("timeout",()=>h("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=Lo.leaving;const i=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(_a.close,"leave",this._joinRef())};return this.rejoinTimer.reset(),this.joinPush.destroy(),new Promise(s=>{const c=new aw(this,_a.leave,{},e);c.receive("ok",()=>{i(),s("ok")}).receive("timeout",()=>{i(),s("timed out")}).receive("error",()=>{s("error")}),c.send(),this._canPush()||c.trigger("ok",{})})}_broadcastEndpointURL(){let e=this.socket.endPoint;return e=e.replace(/^ws/i,"http"),e=e.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),e.replace(/\/+$/,"")+"/api/broadcast"}async _fetchWithTimeout(e,i,s){const c=new AbortController,h=setTimeout(()=>c.abort(),s),p=await this.socket.fetch(e,Object.assign(Object.assign({},i),{signal:c.signal}));return clearTimeout(h),p}_push(e,i,s=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let c=new aw(this,e,i,s);return this._canPush()?c.send():(c.startTimeout(),this.pushBuffer.push(c)),c}_onMessage(e,i,s){return i}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,i,s){var c,h;const p=e.toLocaleLowerCase(),{close:v,error:l,leave:A,join:P}=_a;if(s&&[v,l,A,P].indexOf(p)>=0&&s!==this._joinRef())return;let L=this._onMessage(p,i,s);if(i&&!L)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(p)?(c=this.bindings.postgres_changes)===null||c===void 0||c.filter(U=>{var H,Y,J;return((H=U.filter)===null||H===void 0?void 0:H.event)==="*"||((J=(Y=U.filter)===null||Y===void 0?void 0:Y.event)===null||J===void 0?void 0:J.toLocaleLowerCase())===p}).map(U=>U.callback(L,s)):(h=this.bindings[p])===null||h===void 0||h.filter(U=>{var H,Y,J,oe,me,pe;if(["broadcast","presence","postgres_changes"].includes(p))if("id"in U){const be=U.id,Oe=(H=U.filter)===null||H===void 0?void 0:H.event;return be&&((Y=i.ids)===null||Y===void 0?void 0:Y.includes(be))&&(Oe==="*"||(Oe==null?void 0:Oe.toLocaleLowerCase())===((J=i.data)===null||J===void 0?void 0:J.type.toLocaleLowerCase()))}else{const be=(me=(oe=U==null?void 0:U.filter)===null||oe===void 0?void 0:oe.event)===null||me===void 0?void 0:me.toLocaleLowerCase();return be==="*"||be===((pe=i==null?void 0:i.event)===null||pe===void 0?void 0:pe.toLocaleLowerCase())}else return U.type.toLocaleLowerCase()===p}).map(U=>{if(typeof L=="object"&&"ids"in L){const H=L.data,{schema:Y,table:J,commit_timestamp:oe,type:me,errors:pe}=H;L=Object.assign(Object.assign({},{schema:Y,table:J,commit_timestamp:oe,eventType:me,new:{},old:{},errors:pe}),this._getPayloadRecords(H))}U.callback(L,s)})}_isClosed(){return this.state===Lo.closed}_isJoined(){return this.state===Lo.joined}_isJoining(){return this.state===Lo.joining}_isLeaving(){return this.state===Lo.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,i,s){const c=e.toLocaleLowerCase(),h={type:c,filter:i,callback:s};return this.bindings[c]?this.bindings[c].push(h):this.bindings[c]=[h],this}_off(e,i){const s=e.toLocaleLowerCase();return this.bindings[s]=this.bindings[s].filter(c=>{var h;return!(((h=c.type)===null||h===void 0?void 0:h.toLocaleLowerCase())===s&&WE.isEqual(c.filter,i))}),this}static isEqual(e,i){if(Object.keys(e).length!==Object.keys(i).length)return!1;for(const s in e)if(e[s]!==i[s])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(_a.close,{},e)}_onError(e){this._on(_a.error,{},i=>e(i))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=Lo.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const i={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(i.new=oO(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(i.old=oO(e.columns,e.old_record)),i}}const cQ=()=>{},uQ=typeof WebSocket<"u";class hQ{constructor(e,i){var s;this.accessToken=null,this.apiKey=null,this.channels=[],this.endPoint="",this.headers=QJ,this.params={},this.timeout=gN,this.heartbeatIntervalMs=3e4,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.ref=0,this.logger=cQ,this.conn=null,this.sendBuffer=[],this.serializer=new iQ,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this._resolveFetch=h=>{let p;return h?p=h:typeof fetch>"u"?p=(...v)=>ff(()=>Promise.resolve().then(()=>W_),void 0,import.meta.url).then(({default:l})=>l(...v)):p=fetch,(...v)=>p(...v)},this.endPoint=`${e}/${XT.websocket}`,i!=null&&i.transport?this.transport=i.transport:this.transport=null,i!=null&&i.params&&(this.params=i.params),i!=null&&i.headers&&(this.headers=Object.assign(Object.assign({},this.headers),i.headers)),i!=null&&i.timeout&&(this.timeout=i.timeout),i!=null&&i.logger&&(this.logger=i.logger),i!=null&&i.heartbeatIntervalMs&&(this.heartbeatIntervalMs=i.heartbeatIntervalMs);const c=(s=i==null?void 0:i.params)===null||s===void 0?void 0:s.apikey;c&&(this.accessToken=c,this.apiKey=c),this.reconnectAfterMs=i!=null&&i.reconnectAfterMs?i.reconnectAfterMs:h=>[1e3,2e3,5e3,1e4][h-1]||1e4,this.encode=i!=null&&i.encode?i.encode:(h,p)=>p(JSON.stringify(h)),this.decode=i!=null&&i.decode?i.decode:this.serializer.decode.bind(this.serializer),this.reconnectTimer=new yN(async()=>{this.disconnect(),this.connect()},this.reconnectAfterMs),this.fetch=this._resolveFetch(i==null?void 0:i.fetch)}connect(){if(!this.conn){if(this.transport){this.conn=new this.transport(this._endPointURL(),void 0,{headers:this.headers});return}if(uQ){this.conn=new WebSocket(this._endPointURL()),this.setupConnection();return}this.conn=new dQ(this._endPointURL(),void 0,{close:()=>{this.conn=null}}),ff(()=>import("../chunks/browser.BVZztmgU.js").then(e=>e.b),__vite__mapDeps([0,1,2,3]),import.meta.url).then(({default:e})=>{this.conn=new e(this._endPointURL(),void 0,{headers:this.headers}),this.setupConnection()})}}disconnect(e,i){this.conn&&(this.conn.onclose=function(){},e?this.conn.close(e,i??""):this.conn.close(),this.conn=null,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.reset())}getChannels(){return this.channels}async removeChannel(e){const i=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),i}async removeAllChannels(){const e=await Promise.all(this.channels.map(i=>i.unsubscribe()));return this.disconnect(),e}log(e,i,s){this.logger(e,i,s)}connectionState(){switch(this.conn&&this.conn.readyState){case cf.connecting:return Qu.Connecting;case cf.open:return Qu.Open;case cf.closing:return Qu.Closing;default:return Qu.Closed}}isConnected(){return this.connectionState()===Qu.Open}channel(e,i={config:{}}){const s=new WE(`realtime:${e}`,i,this);return this.channels.push(s),s}push(e){const{topic:i,event:s,payload:c,ref:h}=e,p=()=>{this.encode(e,v=>{var l;(l=this.conn)===null||l===void 0||l.send(v)})};this.log("push",`${i} ${s} (${h})`,c),this.isConnected()?p():this.sendBuffer.push(p)}setAuth(e){this.accessToken=e,this.channels.forEach(i=>{e&&i.updateJoinPayload({access_token:e}),i.joinedOnce&&i._isJoined()&&i._push(_a.access_token,{access_token:e})})}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let i=this.channels.find(s=>s.topic===e&&(s._isJoined()||s._isJoining()));i&&(this.log("transport",`leaving duplicate topic "${e}"`),i.unsubscribe())}_remove(e){this.channels=this.channels.filter(i=>i._joinRef()!==e._joinRef())}setupConnection(){this.conn&&(this.conn.binaryType="arraybuffer",this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_endPointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:eQ}))}_onConnMessage(e){this.decode(e.data,i=>{let{topic:s,event:c,payload:h,ref:p}=i;(p&&p===this.pendingHeartbeatRef||c===(h==null?void 0:h.type))&&(this.pendingHeartbeatRef=null),this.log("receive",`${h.status||""} ${s} ${c} ${p&&"("+p+")"||""}`,h),this.channels.filter(v=>v._isMember(s)).forEach(v=>v._trigger(c,h,p)),this.stateChangeCallbacks.message.forEach(v=>v(i))})}_onConnOpen(){this.log("transport",`connected to ${this._endPointURL()}`),this._flushSendBuffer(),this.reconnectTimer.reset(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this._sendHeartbeat(),this.heartbeatIntervalMs),this.stateChangeCallbacks.open.forEach(e=>e())}_onConnClose(e){this.log("transport","close",e),this._triggerChanError(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(i=>i(e))}_onConnError(e){this.log("transport",e.message),this._triggerChanError(),this.stateChangeCallbacks.error.forEach(i=>i(e))}_triggerChanError(){this.channels.forEach(e=>e._trigger(_a.error))}_appendParams(e,i){if(Object.keys(i).length===0)return e;const s=e.match(/\?/)?"&":"?",c=new URLSearchParams(i);return`${e}${s}${c}`}_flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_sendHeartbeat(){var e;if(this.isConnected()){if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),(e=this.conn)===null||e===void 0||e.close(tQ,"hearbeat timeout");return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.setAuth(this.accessToken)}}}class dQ{constructor(e,i,s){this.binaryType="arraybuffer",this.onclose=()=>{},this.onerror=()=>{},this.onmessage=()=>{},this.onopen=()=>{},this.readyState=cf.connecting,this.send=()=>{},this.url=null,this.url=e,this.close=s.close}}class HE extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function Ys(t){return typeof t=="object"&&t!==null&&"__isStorageError"in t}class fQ extends HE{constructor(e,i){super(e),this.name="StorageApiError",this.status=i}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class uO extends HE{constructor(e,i){super(e),this.name="StorageUnknownError",this.originalError=i}}var pQ=function(t,e,i,s){function c(h){return h instanceof i?h:new i(function(p){p(h)})}return new(i||(i=Promise))(function(h,p){function v(P){try{A(s.next(P))}catch(O){p(O)}}function l(P){try{A(s.throw(P))}catch(O){p(O)}}function A(P){P.done?h(P.value):c(P.value).then(v,l)}A((s=s.apply(t,e||[])).next())})};const xN=t=>{let e;return t?e=t:typeof fetch>"u"?e=(...i)=>ff(()=>Promise.resolve().then(()=>W_),void 0,import.meta.url).then(({default:s})=>s(...i)):e=fetch,(...i)=>e(...i)},mQ=()=>pQ(void 0,void 0,void 0,function*(){return typeof Response>"u"?(yield ff(()=>Promise.resolve().then(()=>W_),void 0,import.meta.url)).Response:Response});var kf=function(t,e,i,s){function c(h){return h instanceof i?h:new i(function(p){p(h)})}return new(i||(i=Promise))(function(h,p){function v(P){try{A(s.next(P))}catch(O){p(O)}}function l(P){try{A(s.throw(P))}catch(O){p(O)}}function A(P){P.done?h(P.value):c(P.value).then(v,l)}A((s=s.apply(t,e||[])).next())})};const lw=t=>t.msg||t.message||t.error_description||t.error||JSON.stringify(t),_Q=(t,e)=>kf(void 0,void 0,void 0,function*(){const i=yield mQ();t instanceof i?t.json().then(s=>{e(new fQ(lw(s),t.status||500))}).catch(s=>{e(new uO(lw(s),s))}):e(new uO(lw(t),t))}),gQ=(t,e,i,s)=>{const c={method:t,headers:(e==null?void 0:e.headers)||{}};return t==="GET"?c:(c.headers=Object.assign({"Content-Type":"application/json"},e==null?void 0:e.headers),c.body=JSON.stringify(s),Object.assign(Object.assign({},c),i))};function y1(t,e,i,s,c,h){return kf(this,void 0,void 0,function*(){return new Promise((p,v)=>{t(i,gQ(e,s,c,h)).then(l=>{if(!l.ok)throw l;return s!=null&&s.noResolveJson?l:l.json()}).then(l=>p(l)).catch(l=>_Q(l,v))})})}function YT(t,e,i,s){return kf(this,void 0,void 0,function*(){return y1(t,"GET",e,i,s)})}function Pc(t,e,i,s,c){return kf(this,void 0,void 0,function*(){return y1(t,"POST",e,s,c,i)})}function yQ(t,e,i,s,c){return kf(this,void 0,void 0,function*(){return y1(t,"PUT",e,s,c,i)})}function bN(t,e,i,s,c){return kf(this,void 0,void 0,function*(){return y1(t,"DELETE",e,s,c,i)})}var $o=function(t,e,i,s){function c(h){return h instanceof i?h:new i(function(p){p(h)})}return new(i||(i=Promise))(function(h,p){function v(P){try{A(s.next(P))}catch(O){p(O)}}function l(P){try{A(s.throw(P))}catch(O){p(O)}}function A(P){P.done?h(P.value):c(P.value).then(v,l)}A((s=s.apply(t,e||[])).next())})};const vQ={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},hO={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class xQ{constructor(e,i={},s,c){this.url=e,this.headers=i,this.bucketId=s,this.fetch=xN(c)}uploadOrUpdate(e,i,s,c){return $o(this,void 0,void 0,function*(){try{let h;const p=Object.assign(Object.assign({},hO),c),v=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(p.upsert)});typeof Blob<"u"&&s instanceof Blob?(h=new FormData,h.append("cacheControl",p.cacheControl),h.append("",s)):typeof FormData<"u"&&s instanceof FormData?(h=s,h.append("cacheControl",p.cacheControl)):(h=s,v["cache-control"]=`max-age=${p.cacheControl}`,v["content-type"]=p.contentType);const l=this._removeEmptyFolders(i),A=this._getFinalPath(l),P=yield this.fetch(`${this.url}/object/${A}`,Object.assign({method:e,body:h,headers:v},p!=null&&p.duplex?{duplex:p.duplex}:{})),O=yield P.json();return P.ok?{data:{path:l,id:O.Id,fullPath:O.Key},error:null}:{data:null,error:O}}catch(h){if(Ys(h))return{data:null,error:h};throw h}})}upload(e,i,s){return $o(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,i,s)})}uploadToSignedUrl(e,i,s,c){return $o(this,void 0,void 0,function*(){const h=this._removeEmptyFolders(e),p=this._getFinalPath(h),v=new URL(this.url+`/object/upload/sign/${p}`);v.searchParams.set("token",i);try{let l;const A=Object.assign({upsert:hO.upsert},c),P=Object.assign(Object.assign({},this.headers),{"x-upsert":String(A.upsert)});typeof Blob<"u"&&s instanceof Blob?(l=new FormData,l.append("cacheControl",A.cacheControl),l.append("",s)):typeof FormData<"u"&&s instanceof FormData?(l=s,l.append("cacheControl",A.cacheControl)):(l=s,P["cache-control"]=`max-age=${A.cacheControl}`,P["content-type"]=A.contentType);const O=yield this.fetch(v.toString(),{method:"PUT",body:l,headers:P}),L=yield O.json();return O.ok?{data:{path:h,fullPath:L.Key},error:null}:{data:null,error:L}}catch(l){if(Ys(l))return{data:null,error:l};throw l}})}createSignedUploadUrl(e){return $o(this,void 0,void 0,function*(){try{let i=this._getFinalPath(e);const s=yield Pc(this.fetch,`${this.url}/object/upload/sign/${i}`,{},{headers:this.headers}),c=new URL(this.url+s.url),h=c.searchParams.get("token");if(!h)throw new HE("No token returned by API");return{data:{signedUrl:c.toString(),path:e,token:h},error:null}}catch(i){if(Ys(i))return{data:null,error:i};throw i}})}update(e,i,s){return $o(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,i,s)})}move(e,i){return $o(this,void 0,void 0,function*(){try{return{data:yield Pc(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:i},{headers:this.headers}),error:null}}catch(s){if(Ys(s))return{data:null,error:s};throw s}})}copy(e,i){return $o(this,void 0,void 0,function*(){try{return{data:{path:(yield Pc(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:i},{headers:this.headers})).Key},error:null}}catch(s){if(Ys(s))return{data:null,error:s};throw s}})}createSignedUrl(e,i,s){return $o(this,void 0,void 0,function*(){try{let c=this._getFinalPath(e),h=yield Pc(this.fetch,`${this.url}/object/sign/${c}`,Object.assign({expiresIn:i},s!=null&&s.transform?{transform:s.transform}:{}),{headers:this.headers});const p=s!=null&&s.download?`&download=${s.download===!0?"":s.download}`:"";return h={signedUrl:encodeURI(`${this.url}${h.signedURL}${p}`)},{data:h,error:null}}catch(c){if(Ys(c))return{data:null,error:c};throw c}})}createSignedUrls(e,i,s){return $o(this,void 0,void 0,function*(){try{const c=yield Pc(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:i,paths:e},{headers:this.headers}),h=s!=null&&s.download?`&download=${s.download===!0?"":s.download}`:"";return{data:c.map(p=>Object.assign(Object.assign({},p),{signedUrl:p.signedURL?encodeURI(`${this.url}${p.signedURL}${h}`):null})),error:null}}catch(c){if(Ys(c))return{data:null,error:c};throw c}})}download(e,i){return $o(this,void 0,void 0,function*(){const c=typeof(i==null?void 0:i.transform)<"u"?"render/image/authenticated":"object",h=this.transformOptsToQueryString((i==null?void 0:i.transform)||{}),p=h?`?${h}`:"";try{const v=this._getFinalPath(e);return{data:yield(yield YT(this.fetch,`${this.url}/${c}/${v}${p}`,{headers:this.headers,noResolveJson:!0})).blob(),error:null}}catch(v){if(Ys(v))return{data:null,error:v};throw v}})}getPublicUrl(e,i){const s=this._getFinalPath(e),c=[],h=i!=null&&i.download?`download=${i.download===!0?"":i.download}`:"";h!==""&&c.push(h);const v=typeof(i==null?void 0:i.transform)<"u"?"render/image":"object",l=this.transformOptsToQueryString((i==null?void 0:i.transform)||{});l!==""&&c.push(l);let A=c.join("&");return A!==""&&(A=`?${A}`),{data:{publicUrl:encodeURI(`${this.url}/${v}/public/${s}${A}`)}}}remove(e){return $o(this,void 0,void 0,function*(){try{return{data:yield bN(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(i){if(Ys(i))return{data:null,error:i};throw i}})}list(e,i,s){return $o(this,void 0,void 0,function*(){try{const c=Object.assign(Object.assign(Object.assign({},vQ),i),{prefix:e||""});return{data:yield Pc(this.fetch,`${this.url}/object/list/${this.bucketId}`,c,{headers:this.headers},s),error:null}}catch(c){if(Ys(c))return{data:null,error:c};throw c}})}_getFinalPath(e){return`${this.bucketId}/${e}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const i=[];return e.width&&i.push(`width=${e.width}`),e.height&&i.push(`height=${e.height}`),e.resize&&i.push(`resize=${e.resize}`),e.format&&i.push(`format=${e.format}`),e.quality&&i.push(`quality=${e.quality}`),i.join("&")}}const bQ="2.5.5",wQ={"X-Client-Info":`storage-js/${bQ}`};var Ud=function(t,e,i,s){function c(h){return h instanceof i?h:new i(function(p){p(h)})}return new(i||(i=Promise))(function(h,p){function v(P){try{A(s.next(P))}catch(O){p(O)}}function l(P){try{A(s.throw(P))}catch(O){p(O)}}function A(P){P.done?h(P.value):c(P.value).then(v,l)}A((s=s.apply(t,e||[])).next())})};class TQ{constructor(e,i={},s){this.url=e,this.headers=Object.assign(Object.assign({},wQ),i),this.fetch=xN(s)}listBuckets(){return Ud(this,void 0,void 0,function*(){try{return{data:yield YT(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(Ys(e))return{data:null,error:e};throw e}})}getBucket(e){return Ud(this,void 0,void 0,function*(){try{return{data:yield YT(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(i){if(Ys(i))return{data:null,error:i};throw i}})}createBucket(e,i={public:!1}){return Ud(this,void 0,void 0,function*(){try{return{data:yield Pc(this.fetch,`${this.url}/bucket`,{id:e,name:e,public:i.public,file_size_limit:i.fileSizeLimit,allowed_mime_types:i.allowedMimeTypes},{headers:this.headers}),error:null}}catch(s){if(Ys(s))return{data:null,error:s};throw s}})}updateBucket(e,i){return Ud(this,void 0,void 0,function*(){try{return{data:yield yQ(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:i.public,file_size_limit:i.fileSizeLimit,allowed_mime_types:i.allowedMimeTypes},{headers:this.headers}),error:null}}catch(s){if(Ys(s))return{data:null,error:s};throw s}})}emptyBucket(e){return Ud(this,void 0,void 0,function*(){try{return{data:yield Pc(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(i){if(Ys(i))return{data:null,error:i};throw i}})}deleteBucket(e){return Ud(this,void 0,void 0,function*(){try{return{data:yield bN(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(i){if(Ys(i))return{data:null,error:i};throw i}})}}class EQ extends TQ{constructor(e,i={},s){super(e,i,s)}from(e){return new xQ(this.url,this.headers,e,this.fetch)}}const SQ="2.43.4";let Qm="";typeof Deno<"u"?Qm="deno":typeof document<"u"?Qm="web":typeof navigator<"u"&&navigator.product==="ReactNative"?Qm="react-native":Qm="node";const AQ={"X-Client-Info":`supabase-js-${Qm}/${SQ}`},MQ={headers:AQ},CQ={schema:"public"},PQ={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},IQ={};var RQ=function(t,e,i,s){function c(h){return h instanceof i?h:new i(function(p){p(h)})}return new(i||(i=Promise))(function(h,p){function v(P){try{A(s.next(P))}catch(O){p(O)}}function l(P){try{A(s.throw(P))}catch(O){p(O)}}function A(P){P.done?h(P.value):c(P.value).then(v,l)}A((s=s.apply(t,e||[])).next())})};const OQ=t=>{let e;return t?e=t:typeof fetch>"u"?e=jE:e=fetch,(...i)=>e(...i)},kQ=()=>typeof Headers>"u"?_N:Headers,DQ=(t,e,i)=>{const s=OQ(i),c=kQ();return(h,p)=>RQ(void 0,void 0,void 0,function*(){var v;const l=(v=yield e())!==null&&v!==void 0?v:t;let A=new c(p==null?void 0:p.headers);return A.has("apikey")||A.set("apikey",t),A.has("Authorization")||A.set("Authorization",`Bearer ${l}`),s(h,Object.assign(Object.assign({},p),{headers:A}))})};function LQ(t){return t.replace(/\/$/,"")}function NQ(t,e){const{db:i,auth:s,realtime:c,global:h}=t,{db:p,auth:v,realtime:l,global:A}=e;return{db:Object.assign(Object.assign({},p),i),auth:Object.assign(Object.assign({},v),s),realtime:Object.assign(Object.assign({},l),c),global:Object.assign(Object.assign({},A),h)}}const wN="2.64.2",FQ="http://localhost:9999",BQ="supabase.auth.token",zQ={"X-Client-Info":`gotrue-js/${wN}`},dO=10,KT="X-Supabase-Api-Version",TN={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}};function UQ(t){return Math.round(Date.now()/1e3)+t}function VQ(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=Math.random()*16|0;return(t=="x"?e:e&3|8).toString(16)})}const ma=()=>typeof document<"u",Gu={tested:!1,writable:!1},d_=()=>{if(!ma())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(Gu.tested)return Gu.writable;const t=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(t,t),globalThis.localStorage.removeItem(t),Gu.tested=!0,Gu.writable=!0}catch{Gu.tested=!0,Gu.writable=!1}return Gu.writable};function cw(t){const e={},i=new URL(t);if(i.hash&&i.hash[0]==="#")try{new URLSearchParams(i.hash.substring(1)).forEach((c,h)=>{e[h]=c})}catch{}return i.searchParams.forEach((s,c)=>{e[c]=s}),e}const EN=t=>{let e;return t?e=t:typeof fetch>"u"?e=(...i)=>ff(()=>Promise.resolve().then(()=>W_),void 0,import.meta.url).then(({default:s})=>s(...i)):e=fetch,(...i)=>e(...i)},jQ=t=>typeof t=="object"&&t!==null&&"status"in t&&"ok"in t&&"json"in t&&typeof t.json=="function",SN=async(t,e,i)=>{await t.setItem(e,JSON.stringify(i))},b0=async(t,e)=>{const i=await t.getItem(e);if(!i)return null;try{return JSON.parse(i)}catch{return i}},uw=async(t,e)=>{await t.removeItem(e)};function $Q(t){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let i="",s,c,h,p,v,l,A,P=0;for(t=t.replace("-","+").replace("_","/");P<t.length;)p=e.indexOf(t.charAt(P++)),v=e.indexOf(t.charAt(P++)),l=e.indexOf(t.charAt(P++)),A=e.indexOf(t.charAt(P++)),s=p<<2|v>>4,c=(v&15)<<4|l>>2,h=(l&3)<<6|A,i=i+String.fromCharCode(s),l!=64&&c!=0&&(i=i+String.fromCharCode(c)),A!=64&&h!=0&&(i=i+String.fromCharCode(h));return i}class v1{constructor(){this.promise=new v1.promiseConstructor((e,i)=>{this.resolve=e,this.reject=i})}}v1.promiseConstructor=Promise;function fO(t){const e=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}=?$|[a-z0-9_-]{2}(==)?$)$/i,i=t.split(".");if(i.length!==3)throw new Error("JWT is not valid: not a JWT structure");if(!e.test(i[1]))throw new Error("JWT is not valid: payload is not in base64url format");const s=i[1];return JSON.parse($Q(s))}async function WQ(t){return await new Promise(e=>{setTimeout(()=>e(null),t)})}function HQ(t,e){return new Promise((s,c)=>{(async()=>{for(let h=0;h<1/0;h++)try{const p=await t(h);if(!e(h,null,p)){s(p);return}}catch(p){if(!e(h,p)){c(p);return}}})()})}function qQ(t){return("0"+t.toString(16)).substr(-2)}function GQ(){const e=new Uint32Array(56);if(typeof crypto>"u"){const i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",s=i.length;let c="";for(let h=0;h<56;h++)c+=i.charAt(Math.floor(Math.random()*s));return c}return crypto.getRandomValues(e),Array.from(e,qQ).join("")}async function XQ(t){const i=new TextEncoder().encode(t),s=await crypto.subtle.digest("SHA-256",i),c=new Uint8Array(s);return Array.from(c).map(h=>String.fromCharCode(h)).join("")}function ZQ(t){return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function YQ(t){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),t;const i=await XQ(t);return ZQ(i)}async function Vd(t,e,i=!1){const s=GQ();let c=s;i&&(c+="/PASSWORD_RECOVERY"),await SN(t,`${e}-code-verifier`,c);const h=await YQ(s);return[h,s===h?"plain":"s256"]}const KQ=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function JQ(t){const e=t.headers.get(KT);if(!e||!e.match(KQ))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}class qE extends Error{constructor(e,i,s){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=i,this.code=s}}function zr(t){return typeof t=="object"&&t!==null&&"__isAuthError"in t}class QQ extends qE{constructor(e,i,s){super(e,i,s),this.name="AuthApiError",this.status=i,this.code=s}}function eee(t){return zr(t)&&t.name==="AuthApiError"}class AN extends qE{constructor(e,i){super(e),this.name="AuthUnknownError",this.originalError=i}}class Oh extends qE{constructor(e,i,s,c){super(e,s,c),this.name=i,this.status=s}}class Xu extends Oh{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}class hw extends Oh{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class w0 extends Oh{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class T0 extends Oh{constructor(e,i=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=i}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class pO extends Oh{constructor(e,i=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=i}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class JT extends Oh{constructor(e,i){super(e,"AuthRetryableFetchError",i,void 0)}}function dw(t){return zr(t)&&t.name==="AuthRetryableFetchError"}class mO extends Oh{constructor(e,i,s){super(e,"AuthWeakPasswordError",i,"weak_password"),this.reasons=s}}var tee=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var c=0,s=Object.getOwnPropertySymbols(t);c<s.length;c++)e.indexOf(s[c])<0&&Object.prototype.propertyIsEnumerable.call(t,s[c])&&(i[s[c]]=t[s[c]]);return i};const Ku=t=>t.msg||t.message||t.error_description||t.error||JSON.stringify(t),iee=[502,503,504];async function _O(t){var e;if(!jQ(t))throw new JT(Ku(t),0);if(iee.includes(t.status))throw new JT(Ku(t),t.status);let i;try{i=await t.json()}catch(h){throw new AN(Ku(h),h)}let s;const c=JQ(t);if(c&&c.getTime()>=TN["2024-01-01"].timestamp&&typeof i=="object"&&i&&typeof i.code=="string"?s=i.code:typeof i=="object"&&i&&typeof i.error_code=="string"&&(s=i.error_code),s){if(s==="weak_password")throw new mO(Ku(i),t.status,((e=i.weak_password)===null||e===void 0?void 0:e.reasons)||[])}else if(typeof i=="object"&&i&&typeof i.weak_password=="object"&&i.weak_password&&Array.isArray(i.weak_password.reasons)&&i.weak_password.reasons.length&&i.weak_password.reasons.reduce((h,p)=>h&&typeof p=="string",!0))throw new mO(Ku(i),t.status,i.weak_password.reasons);throw new QQ(Ku(i),t.status||500,s)}const ree=(t,e,i,s)=>{const c={method:t,headers:(e==null?void 0:e.headers)||{}};return t==="GET"?c:(c.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),c.body=JSON.stringify(s),Object.assign(Object.assign({},c),i))};async function Wr(t,e,i,s){var c;const h=Object.assign({},s==null?void 0:s.headers);h[KT]||(h[KT]=TN["2024-01-01"].name),s!=null&&s.jwt&&(h.Authorization=`Bearer ${s.jwt}`);const p=(c=s==null?void 0:s.query)!==null&&c!==void 0?c:{};s!=null&&s.redirectTo&&(p.redirect_to=s.redirectTo);const v=Object.keys(p).length?"?"+new URLSearchParams(p).toString():"",l=await nee(t,e,i+v,{headers:h,noResolveJson:s==null?void 0:s.noResolveJson},{},s==null?void 0:s.body);return s!=null&&s.xform?s==null?void 0:s.xform(l):{data:Object.assign({},l),error:null}}async function nee(t,e,i,s,c,h){const p=ree(e,s,c,h);let v;try{v=await t(i,Object.assign({},p))}catch(l){throw console.error(l),new JT(Ku(l),0)}if(v.ok||await _O(v),s!=null&&s.noResolveJson)return v;try{return await v.json()}catch(l){await _O(l)}}function Ac(t){var e;let i=null;lee(t)&&(i=Object.assign({},t),t.expires_at||(i.expires_at=UQ(t.expires_in)));const s=(e=t.user)!==null&&e!==void 0?e:t;return{data:{session:i,user:s},error:null}}function gO(t){const e=Ac(t);return!e.error&&t.weak_password&&typeof t.weak_password=="object"&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.message&&typeof t.weak_password.message=="string"&&t.weak_password.reasons.reduce((i,s)=>i&&typeof s=="string",!0)&&(e.data.weak_password=t.weak_password),e}function Oc(t){var e;return{data:{user:(e=t.user)!==null&&e!==void 0?e:t},error:null}}function see(t){return{data:t,error:null}}function oee(t){const{action_link:e,email_otp:i,hashed_token:s,redirect_to:c,verification_type:h}=t,p=tee(t,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),v={action_link:e,email_otp:i,hashed_token:s,redirect_to:c,verification_type:h},l=Object.assign({},p);return{data:{properties:v,user:l},error:null}}function aee(t){return t}function lee(t){return t.access_token&&t.refresh_token&&t.expires_in}var cee=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var c=0,s=Object.getOwnPropertySymbols(t);c<s.length;c++)e.indexOf(s[c])<0&&Object.prototype.propertyIsEnumerable.call(t,s[c])&&(i[s[c]]=t[s[c]]);return i};class uee{constructor({url:e="",headers:i={},fetch:s}){this.url=e,this.headers=i,this.fetch=EN(s),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(e,i="global"){try{return await Wr(this.fetch,"POST",`${this.url}/logout?scope=${i}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(s){if(zr(s))return{data:null,error:s};throw s}}async inviteUserByEmail(e,i={}){try{return await Wr(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:i.data},headers:this.headers,redirectTo:i.redirectTo,xform:Oc})}catch(s){if(zr(s))return{data:{user:null},error:s};throw s}}async generateLink(e){try{const{options:i}=e,s=cee(e,["options"]),c=Object.assign(Object.assign({},s),i);return"newEmail"in s&&(c.new_email=s==null?void 0:s.newEmail,delete c.newEmail),await Wr(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:c,headers:this.headers,xform:oee,redirectTo:i==null?void 0:i.redirectTo})}catch(i){if(zr(i))return{data:{properties:null,user:null},error:i};throw i}}async createUser(e){try{return await Wr(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:Oc})}catch(i){if(zr(i))return{data:{user:null},error:i};throw i}}async listUsers(e){var i,s,c,h,p,v,l;try{const A={nextPage:null,lastPage:0,total:0},P=await Wr(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(i=e==null?void 0:e.page)===null||i===void 0?void 0:i.toString())!==null&&s!==void 0?s:"",per_page:(h=(c=e==null?void 0:e.perPage)===null||c===void 0?void 0:c.toString())!==null&&h!==void 0?h:""},xform:aee});if(P.error)throw P.error;const O=await P.json(),L=(p=P.headers.get("x-total-count"))!==null&&p!==void 0?p:0,U=(l=(v=P.headers.get("link"))===null||v===void 0?void 0:v.split(","))!==null&&l!==void 0?l:[];return U.length>0&&(U.forEach(H=>{const Y=parseInt(H.split(";")[0].split("=")[1].substring(0,1)),J=JSON.parse(H.split(";")[1].split("=")[1]);A[`${J}Page`]=Y}),A.total=parseInt(L)),{data:Object.assign(Object.assign({},O),A),error:null}}catch(A){if(zr(A))return{data:{users:[]},error:A};throw A}}async getUserById(e){try{return await Wr(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:Oc})}catch(i){if(zr(i))return{data:{user:null},error:i};throw i}}async updateUserById(e,i){try{return await Wr(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:i,headers:this.headers,xform:Oc})}catch(s){if(zr(s))return{data:{user:null},error:s};throw s}}async deleteUser(e,i=!1){try{return await Wr(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:i},xform:Oc})}catch(s){if(zr(s))return{data:{user:null},error:s};throw s}}async _listFactors(e){try{const{data:i,error:s}=await Wr(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:c=>({data:{factors:c},error:null})});return{data:i,error:s}}catch(i){if(zr(i))return{data:null,error:i};throw i}}async _deleteFactor(e){try{return{data:await Wr(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(i){if(zr(i))return{data:null,error:i};throw i}}}const hee={getItem:t=>d_()?globalThis.localStorage.getItem(t):null,setItem:(t,e)=>{d_()&&globalThis.localStorage.setItem(t,e)},removeItem:t=>{d_()&&globalThis.localStorage.removeItem(t)}};function yO(t={}){return{getItem:e=>t[e]||null,setItem:(e,i)=>{t[e]=i},removeItem:e=>{delete t[e]}}}function dee(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}const jd={debug:!!(globalThis&&d_()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class MN extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class fee extends MN{}async function pee(t,e,i){jd.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",t,e);const s=new globalThis.AbortController;return e>0&&setTimeout(()=>{s.abort(),jd.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",t)},e),await globalThis.navigator.locks.request(t,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:s.signal},async c=>{if(c){jd.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",t,c.name);try{return await i()}finally{jd.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",t,c.name)}}else{if(e===0)throw jd.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",t),new fee(`Acquiring an exclusive Navigator LockManager lock "${t}" immediately failed`);if(jd.debug)try{const h=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(h,null,"  "))}catch(h){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",h)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await i()}})}dee();const mee={url:FQ,storageKey:BQ,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:zQ,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1},Vm=30*1e3,vO=3;async function xO(t,e,i){return await i()}class D_{constructor(e){var i,s;this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=D_.nextInstanceID,D_.nextInstanceID+=1,this.instanceID>0&&ma()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");const c=Object.assign(Object.assign({},mee),e);if(this.logDebugMessages=!!c.debug,typeof c.debug=="function"&&(this.logger=c.debug),this.persistSession=c.persistSession,this.storageKey=c.storageKey,this.autoRefreshToken=c.autoRefreshToken,this.admin=new uee({url:c.url,headers:c.headers,fetch:c.fetch}),this.url=c.url,this.headers=c.headers,this.fetch=EN(c.fetch),this.lock=c.lock||xO,this.detectSessionInUrl=c.detectSessionInUrl,this.flowType=c.flowType,this.hasCustomAuthorizationHeader=c.hasCustomAuthorizationHeader,c.lock?this.lock=c.lock:ma()&&(!((i=globalThis==null?void 0:globalThis.navigator)===null||i===void 0)&&i.locks)?this.lock=pee:this.lock=xO,this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?c.storage?this.storage=c.storage:d_()?this.storage=hee:(this.memoryStorage={},this.storage=yO(this.memoryStorage)):(this.memoryStorage={},this.storage=yO(this.memoryStorage)),ma()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(h){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",h)}(s=this.broadcastChannel)===null||s===void 0||s.addEventListener("message",async h=>{this._debug("received broadcast notification from other tab or client",h),await this._notifyAllSubscribers(h.data.event,h.data.session,!1)})}this.initialize()}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${wN}) ${new Date().toISOString()}`,...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){try{const e=ma()?await this._isPKCEFlow():!1;if(this._debug("#_initialize()","begin","is PKCE flow",e),e||this.detectSessionInUrl&&this._isImplicitGrantFlow()){const{data:i,error:s}=await this._getSessionFromURL(e);if(s)return this._debug("#_initialize()","error detecting session from URL",s),(s==null?void 0:s.message)==="Identity is already linked"||(s==null?void 0:s.message)==="Identity is already linked to another user"?{error:s}:(await this._removeSession(),{error:s});const{session:c,redirectType:h}=i;return this._debug("#_initialize()","detected session in URL",c,"redirect type",h),await this._saveSession(c),setTimeout(async()=>{h==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",c):await this._notifyAllSubscribers("SIGNED_IN",c)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(e){return zr(e)?{error:e}:{error:new AN("Unexpected error during initialization",e)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var i,s,c;try{await this._removeSession();const h=await Wr(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(s=(i=e==null?void 0:e.options)===null||i===void 0?void 0:i.data)!==null&&s!==void 0?s:{},gotrue_meta_security:{captcha_token:(c=e==null?void 0:e.options)===null||c===void 0?void 0:c.captchaToken}},xform:Ac}),{data:p,error:v}=h;if(v||!p)return{data:{user:null,session:null},error:v};const l=p.session,A=p.user;return p.session&&(await this._saveSession(p.session),await this._notifyAllSubscribers("SIGNED_IN",l)),{data:{user:A,session:l},error:null}}catch(h){if(zr(h))return{data:{user:null,session:null},error:h};throw h}}async signUp(e){var i,s,c;try{await this._removeSession();let h;if("email"in e){const{email:P,password:O,options:L}=e;let U=null,H=null;this.flowType==="pkce"&&([U,H]=await Vd(this.storage,this.storageKey)),h=await Wr(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:L==null?void 0:L.emailRedirectTo,body:{email:P,password:O,data:(i=L==null?void 0:L.data)!==null&&i!==void 0?i:{},gotrue_meta_security:{captcha_token:L==null?void 0:L.captchaToken},code_challenge:U,code_challenge_method:H},xform:Ac})}else if("phone"in e){const{phone:P,password:O,options:L}=e;h=await Wr(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:P,password:O,data:(s=L==null?void 0:L.data)!==null&&s!==void 0?s:{},channel:(c=L==null?void 0:L.channel)!==null&&c!==void 0?c:"sms",gotrue_meta_security:{captcha_token:L==null?void 0:L.captchaToken}},xform:Ac})}else throw new w0("You must provide either an email or phone number and a password");const{data:p,error:v}=h;if(v||!p)return{data:{user:null,session:null},error:v};const l=p.session,A=p.user;return p.session&&(await this._saveSession(p.session),await this._notifyAllSubscribers("SIGNED_IN",l)),{data:{user:A,session:l},error:null}}catch(h){if(zr(h))return{data:{user:null,session:null},error:h};throw h}}async signInWithPassword(e){try{await this._removeSession();let i;if("email"in e){const{email:h,password:p,options:v}=e;i=await Wr(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:h,password:p,gotrue_meta_security:{captcha_token:v==null?void 0:v.captchaToken}},xform:gO})}else if("phone"in e){const{phone:h,password:p,options:v}=e;i=await Wr(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:h,password:p,gotrue_meta_security:{captcha_token:v==null?void 0:v.captchaToken}},xform:gO})}else throw new w0("You must provide either an email or phone number and a password");const{data:s,error:c}=i;return c?{data:{user:null,session:null},error:c}:!s||!s.session||!s.user?{data:{user:null,session:null},error:new hw}:(s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",s.session)),{data:Object.assign({user:s.user,session:s.session},s.weak_password?{weakPassword:s.weak_password}:null),error:c})}catch(i){if(zr(i))return{data:{user:null,session:null},error:i};throw i}}async signInWithOAuth(e){var i,s,c,h;return await this._removeSession(),await this._handleProviderSignIn(e.provider,{redirectTo:(i=e.options)===null||i===void 0?void 0:i.redirectTo,scopes:(s=e.options)===null||s===void 0?void 0:s.scopes,queryParams:(c=e.options)===null||c===void 0?void 0:c.queryParams,skipBrowserRedirect:(h=e.options)===null||h===void 0?void 0:h.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async _exchangeCodeForSession(e){const i=await b0(this.storage,`${this.storageKey}-code-verifier`),[s,c]=(i??"").split("/"),{data:h,error:p}=await Wr(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:s},xform:Ac});return await uw(this.storage,`${this.storageKey}-code-verifier`),p?{data:{user:null,session:null,redirectType:null},error:p}:!h||!h.session||!h.user?{data:{user:null,session:null,redirectType:null},error:new hw}:(h.session&&(await this._saveSession(h.session),await this._notifyAllSubscribers("SIGNED_IN",h.session)),{data:Object.assign(Object.assign({},h),{redirectType:c??null}),error:p})}async signInWithIdToken(e){await this._removeSession();try{const{options:i,provider:s,token:c,access_token:h,nonce:p}=e,v=await Wr(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:s,id_token:c,access_token:h,nonce:p,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}},xform:Ac}),{data:l,error:A}=v;return A?{data:{user:null,session:null},error:A}:!l||!l.session||!l.user?{data:{user:null,session:null},error:new hw}:(l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",l.session)),{data:l,error:A})}catch(i){if(zr(i))return{data:{user:null,session:null},error:i};throw i}}async signInWithOtp(e){var i,s,c,h,p;try{if(await this._removeSession(),"email"in e){const{email:v,options:l}=e;let A=null,P=null;this.flowType==="pkce"&&([A,P]=await Vd(this.storage,this.storageKey));const{error:O}=await Wr(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:v,data:(i=l==null?void 0:l.data)!==null&&i!==void 0?i:{},create_user:(s=l==null?void 0:l.shouldCreateUser)!==null&&s!==void 0?s:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},code_challenge:A,code_challenge_method:P},redirectTo:l==null?void 0:l.emailRedirectTo});return{data:{user:null,session:null},error:O}}if("phone"in e){const{phone:v,options:l}=e,{data:A,error:P}=await Wr(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:v,data:(c=l==null?void 0:l.data)!==null&&c!==void 0?c:{},create_user:(h=l==null?void 0:l.shouldCreateUser)!==null&&h!==void 0?h:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},channel:(p=l==null?void 0:l.channel)!==null&&p!==void 0?p:"sms"}});return{data:{user:null,session:null,messageId:A==null?void 0:A.message_id},error:P}}throw new w0("You must provide either an email or phone number.")}catch(v){if(zr(v))return{data:{user:null,session:null},error:v};throw v}}async verifyOtp(e){var i,s;try{e.type!=="email_change"&&e.type!=="phone_change"&&await this._removeSession();let c,h;"options"in e&&(c=(i=e.options)===null||i===void 0?void 0:i.redirectTo,h=(s=e.options)===null||s===void 0?void 0:s.captchaToken);const{data:p,error:v}=await Wr(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:h}}),redirectTo:c,xform:Ac});if(v)throw v;if(!p)throw new Error("An error occurred on token verification.");const l=p.session,A=p.user;return l!=null&&l.access_token&&(await this._saveSession(l),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",l)),{data:{user:A,session:l},error:null}}catch(c){if(zr(c))return{data:{user:null,session:null},error:c};throw c}}async signInWithSSO(e){var i,s,c;try{await this._removeSession();let h=null,p=null;return this.flowType==="pkce"&&([h,p]=await Vd(this.storage,this.storageKey)),await Wr(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(s=(i=e.options)===null||i===void 0?void 0:i.redirectTo)!==null&&s!==void 0?s:void 0}),!((c=e==null?void 0:e.options)===null||c===void 0)&&c.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:h,code_challenge_method:p}),headers:this.headers,xform:see})}catch(h){if(zr(h))return{data:null,error:h};throw h}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:i},error:s}=e;if(s)throw s;if(!i)throw new Xu;const{error:c}=await Wr(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:i.access_token});return{data:{user:null,session:null},error:c}})}catch(e){if(zr(e))return{data:{user:null,session:null},error:e};throw e}}async resend(e){try{e.type!="email_change"&&e.type!="phone_change"&&await this._removeSession();const i=`${this.url}/resend`;if("email"in e){const{email:s,type:c,options:h}=e,{error:p}=await Wr(this.fetch,"POST",i,{headers:this.headers,body:{email:s,type:c,gotrue_meta_security:{captcha_token:h==null?void 0:h.captchaToken}},redirectTo:h==null?void 0:h.emailRedirectTo});return{data:{user:null,session:null},error:p}}else if("phone"in e){const{phone:s,type:c,options:h}=e,{data:p,error:v}=await Wr(this.fetch,"POST",i,{headers:this.headers,body:{phone:s,type:c,gotrue_meta_security:{captcha_token:h==null?void 0:h.captchaToken}}});return{data:{user:null,session:null,messageId:p==null?void 0:p.message_id},error:v}}throw new w0("You must provide either an email or phone number and a type")}catch(i){if(zr(i))return{data:{user:null,session:null},error:i};throw i}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async i=>i))}async _acquireLock(e,i){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const s=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),c=(async()=>(await s,await i()))();return this.pendingInLock.push((async()=>{try{await c}catch{}})()),c}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const s=i();for(this.pendingInLock.push((async()=>{try{await s}catch{}})()),await s;this.pendingInLock.length;){const c=[...this.pendingInLock];await Promise.all(c),this.pendingInLock.splice(0,c.length)}return await s}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const i=await this.__loadSession();return await e(i)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const i=await b0(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",i),i!==null&&(this._isValidSession(i)?e=i:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const s=e.expires_at?e.expires_at<=Date.now()/1e3:!1;if(this._debug("#__loadSession()",`session has${s?"":" not"} expired`,"expires_at",e.expires_at),!s){if(this.storage.isServer){const p=this.suppressGetSessionWarning;e=new Proxy(e,{get(l,A,P){return!p&&A==="user"&&console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and many not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),Reflect.get(l,A,P)}})}return{data:{session:e},error:null}}const{session:c,error:h}=await this._callRefreshToken(e.refresh_token);return h?{data:{session:null},error:h}:{data:{session:c},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(e){try{return e?await Wr(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:Oc}):await this._useSession(async i=>{var s,c,h;const{data:p,error:v}=i;if(v)throw v;return!(!((s=p.session)===null||s===void 0)&&s.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new Xu}:await Wr(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(h=(c=p.session)===null||c===void 0?void 0:c.access_token)!==null&&h!==void 0?h:void 0,xform:Oc})})}catch(i){if(zr(i))return{data:{user:null},error:i};throw i}}async updateUser(e,i={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,i))}async _updateUser(e,i={}){try{return await this._useSession(async s=>{const{data:c,error:h}=s;if(h)throw h;if(!c.session)throw new Xu;const p=c.session;let v=null,l=null;this.flowType==="pkce"&&e.email!=null&&([v,l]=await Vd(this.storage,this.storageKey));const{data:A,error:P}=await Wr(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:i==null?void 0:i.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:v,code_challenge_method:l}),jwt:p.access_token,xform:Oc});if(P)throw P;return p.user=A.user,await this._saveSession(p),await this._notifyAllSubscribers("USER_UPDATED",p),{data:{user:p.user},error:null}})}catch(s){if(zr(s))return{data:{user:null},error:s};throw s}}_decodeJWT(e){return fO(e)}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new Xu;const i=Date.now()/1e3;let s=i,c=!0,h=null;const p=fO(e.access_token);if(p.exp&&(s=p.exp,c=s<=i),c){const{session:v,error:l}=await this._callRefreshToken(e.refresh_token);if(l)return{data:{user:null,session:null},error:l};if(!v)return{data:{user:null,session:null},error:null};h=v}else{const{data:v,error:l}=await this._getUser(e.access_token);if(l)throw l;h={access_token:e.access_token,refresh_token:e.refresh_token,user:v.user,token_type:"bearer",expires_in:s-i,expires_at:s},await this._saveSession(h),await this._notifyAllSubscribers("SIGNED_IN",h)}return{data:{user:h.user,session:h},error:null}}catch(i){if(zr(i))return{data:{session:null,user:null},error:i};throw i}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async i=>{var s;if(!e){const{data:p,error:v}=i;if(v)throw v;e=(s=p.session)!==null&&s!==void 0?s:void 0}if(!(e!=null&&e.refresh_token))throw new Xu;const{session:c,error:h}=await this._callRefreshToken(e.refresh_token);return h?{data:{user:null,session:null},error:h}:c?{data:{user:c.user,session:c},error:null}:{data:{user:null,session:null},error:null}})}catch(i){if(zr(i))return{data:{user:null,session:null},error:i};throw i}}async _getSessionFromURL(e){try{if(!ma())throw new T0("No browser detected.");if(this.flowType==="implicit"&&!this._isImplicitGrantFlow())throw new T0("Not a valid implicit grant flow url.");if(this.flowType=="pkce"&&!e)throw new pO("Not a valid PKCE flow url.");const i=cw(window.location.href);if(e){if(!i.code)throw new pO("No code detected.");const{data:me,error:pe}=await this._exchangeCodeForSession(i.code);if(pe)throw pe;const be=new URL(window.location.href);return be.searchParams.delete("code"),window.history.replaceState(window.history.state,"",be.toString()),{data:{session:me.session,redirectType:null},error:null}}if(i.error||i.error_description||i.error_code)throw new T0(i.error_description||"Error in URL with unspecified error_description",{error:i.error||"unspecified_error",code:i.error_code||"unspecified_code"});const{provider_token:s,provider_refresh_token:c,access_token:h,refresh_token:p,expires_in:v,expires_at:l,token_type:A}=i;if(!h||!v||!p||!A)throw new T0("No session defined in URL");const P=Math.round(Date.now()/1e3),O=parseInt(v);let L=P+O;l&&(L=parseInt(l));const U=L-P;U*1e3<=Vm&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${U}s, should have been closer to ${O}s`);const H=L-O;P-H>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",H,L,P):P-H<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clok for skew",H,L,P);const{data:Y,error:J}=await this._getUser(h);if(J)throw J;const oe={provider_token:s,provider_refresh_token:c,access_token:h,expires_in:O,expires_at:L,refresh_token:p,token_type:A,user:Y.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:oe,redirectType:i.type},error:null}}catch(i){if(zr(i))return{data:{session:null,redirectType:null},error:i};throw i}}_isImplicitGrantFlow(){const e=cw(window.location.href);return!!(ma()&&(e.access_token||e.error_description))}async _isPKCEFlow(){const e=cw(window.location.href),i=await b0(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&i)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async i=>{var s;const{data:c,error:h}=i;if(h)return{error:h};const p=(s=c.session)===null||s===void 0?void 0:s.access_token;if(p){const{error:v}=await this.admin.signOut(p,e);if(v&&!(eee(v)&&(v.status===404||v.status===401||v.status===403)))return{error:v}}return e!=="others"&&(await this._removeSession(),await uw(this.storage,`${this.storageKey}-code-verifier`),await this._notifyAllSubscribers("SIGNED_OUT",null)),{error:null}})}onAuthStateChange(e){const i=VQ(),s={id:i,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",i),this.stateChangeEmitters.delete(i)}};return this._debug("#onAuthStateChange()","registered callback with id",i),this.stateChangeEmitters.set(i,s),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(i)})))(),{data:{subscription:s}}}async _emitInitialSession(e){return await this._useSession(async i=>{var s,c;try{const{data:{session:h},error:p}=i;if(p)throw p;await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",h)),this._debug("INITIAL_SESSION","callback id",e,"session",h)}catch(h){await((c=this.stateChangeEmitters.get(e))===null||c===void 0?void 0:c.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",h),console.error(h)}})}async resetPasswordForEmail(e,i={}){let s=null,c=null;this.flowType==="pkce"&&([s,c]=await Vd(this.storage,this.storageKey,!0));try{return await Wr(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:s,code_challenge_method:c,gotrue_meta_security:{captcha_token:i.captchaToken}},headers:this.headers,redirectTo:i.redirectTo})}catch(h){if(zr(h))return{data:null,error:h};throw h}}async getUserIdentities(){var e;try{const{data:i,error:s}=await this.getUser();if(s)throw s;return{data:{identities:(e=i.user.identities)!==null&&e!==void 0?e:[]},error:null}}catch(i){if(zr(i))return{data:null,error:i};throw i}}async linkIdentity(e){var i;try{const{data:s,error:c}=await this._useSession(async h=>{var p,v,l,A,P;const{data:O,error:L}=h;if(L)throw L;const U=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(p=e.options)===null||p===void 0?void 0:p.redirectTo,scopes:(v=e.options)===null||v===void 0?void 0:v.scopes,queryParams:(l=e.options)===null||l===void 0?void 0:l.queryParams,skipBrowserRedirect:!0});return await Wr(this.fetch,"GET",U,{headers:this.headers,jwt:(P=(A=O.session)===null||A===void 0?void 0:A.access_token)!==null&&P!==void 0?P:void 0})});if(c)throw c;return ma()&&!(!((i=e.options)===null||i===void 0)&&i.skipBrowserRedirect)&&window.location.assign(s==null?void 0:s.url),{data:{provider:e.provider,url:s==null?void 0:s.url},error:null}}catch(s){if(zr(s))return{data:{provider:e.provider,url:null},error:s};throw s}}async unlinkIdentity(e){try{return await this._useSession(async i=>{var s,c;const{data:h,error:p}=i;if(p)throw p;return await Wr(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(c=(s=h.session)===null||s===void 0?void 0:s.access_token)!==null&&c!==void 0?c:void 0})})}catch(i){if(zr(i))return{data:null,error:i};throw i}}async _refreshAccessToken(e){const i=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(i,"begin");try{const s=Date.now();return await HQ(async c=>(c>0&&await WQ(200*Math.pow(2,c-1)),this._debug(i,"refreshing attempt",c),await Wr(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:Ac})),(c,h)=>{const p=200*Math.pow(2,c);return h&&dw(h)&&Date.now()+p-s<Vm})}catch(s){if(this._debug(i,"error",s),zr(s))return{data:{session:null,user:null},error:s};throw s}finally{this._debug(i,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,i){const s=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:i.redirectTo,scopes:i.scopes,queryParams:i.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",i,"url",s),ma()&&!i.skipBrowserRedirect&&window.location.assign(s),{data:{provider:e,url:s},error:null}}async _recoverAndRefresh(){var e;const i="#_recoverAndRefresh()";this._debug(i,"begin");try{const s=await b0(this.storage,this.storageKey);if(this._debug(i,"session from storage",s),!this._isValidSession(s)){this._debug(i,"session is not valid"),s!==null&&await this._removeSession();return}const c=Math.round(Date.now()/1e3),h=((e=s.expires_at)!==null&&e!==void 0?e:1/0)<c+dO;if(this._debug(i,`session has${h?"":" not"} expired with margin of ${dO}s`),h){if(this.autoRefreshToken&&s.refresh_token){const{error:p}=await this._callRefreshToken(s.refresh_token);p&&(console.error(p),dw(p)||(this._debug(i,"refresh failed with a non-retryable error, removing the session",p),await this._removeSession()))}}else await this._notifyAllSubscribers("SIGNED_IN",s)}catch(s){this._debug(i,"error",s),console.error(s);return}finally{this._debug(i,"end")}}async _callRefreshToken(e){var i,s;if(!e)throw new Xu;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const c=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(c,"begin");try{this.refreshingDeferred=new v1;const{data:h,error:p}=await this._refreshAccessToken(e);if(p)throw p;if(!h.session)throw new Xu;await this._saveSession(h.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",h.session);const v={session:h.session,error:null};return this.refreshingDeferred.resolve(v),v}catch(h){if(this._debug(c,"error",h),zr(h)){const p={session:null,error:h};return dw(h)||(await this._removeSession(),await this._notifyAllSubscribers("SIGNED_OUT",null)),(i=this.refreshingDeferred)===null||i===void 0||i.resolve(p),p}throw(s=this.refreshingDeferred)===null||s===void 0||s.reject(h),h}finally{this.refreshingDeferred=null,this._debug(c,"end")}}async _notifyAllSubscribers(e,i,s=!0){const c=`#_notifyAllSubscribers(${e})`;this._debug(c,"begin",i,`broadcast = ${s}`);try{this.broadcastChannel&&s&&this.broadcastChannel.postMessage({event:e,session:i});const h=[],p=Array.from(this.stateChangeEmitters.values()).map(async v=>{try{await v.callback(e,i)}catch(l){h.push(l)}});if(await Promise.all(p),h.length>0){for(let v=0;v<h.length;v+=1)console.error(h[v]);throw h[0]}}finally{this._debug(c,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await SN(this.storage,this.storageKey,e)}async _removeSession(){this._debug("#_removeSession()"),await uw(this.storage,this.storageKey)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&ma()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(i){console.error("removing visibilitychange callback failed",i)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),Vm);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async i=>{const{data:{session:s}}=i;if(!s||!s.refresh_token||!s.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const c=Math.floor((s.expires_at*1e3-e)/Vm);this._debug("#_autoRefreshTokenTick()",`access token expires in ${c} ticks, a tick lasts ${Vm}ms, refresh threshold is ${vO} ticks`),c<=vO&&await this._callRefreshToken(s.refresh_token)})}catch(i){console.error("Auto refresh tick failed with error. This is likely a transient error.",i)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof MN)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!ma()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const i=`#_onVisibilityChanged(${e})`;this._debug(i,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(i,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,i,s){const c=[`provider=${encodeURIComponent(i)}`];if(s!=null&&s.redirectTo&&c.push(`redirect_to=${encodeURIComponent(s.redirectTo)}`),s!=null&&s.scopes&&c.push(`scopes=${encodeURIComponent(s.scopes)}`),this.flowType==="pkce"){const[h,p]=await Vd(this.storage,this.storageKey),v=new URLSearchParams({code_challenge:`${encodeURIComponent(h)}`,code_challenge_method:`${encodeURIComponent(p)}`});c.push(v.toString())}if(s!=null&&s.queryParams){const h=new URLSearchParams(s.queryParams);c.push(h.toString())}return s!=null&&s.skipBrowserRedirect&&c.push(`skip_http_redirect=${s.skipBrowserRedirect}`),`${e}?${c.join("&")}`}async _unenroll(e){try{return await this._useSession(async i=>{var s;const{data:c,error:h}=i;return h?{data:null,error:h}:await Wr(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(s=c==null?void 0:c.session)===null||s===void 0?void 0:s.access_token})})}catch(i){if(zr(i))return{data:null,error:i};throw i}}async _enroll(e){try{return await this._useSession(async i=>{var s,c;const{data:h,error:p}=i;if(p)return{data:null,error:p};const{data:v,error:l}=await Wr(this.fetch,"POST",`${this.url}/factors`,{body:{friendly_name:e.friendlyName,factor_type:e.factorType,issuer:e.issuer},headers:this.headers,jwt:(s=h==null?void 0:h.session)===null||s===void 0?void 0:s.access_token});return l?{data:null,error:l}:(!((c=v==null?void 0:v.totp)===null||c===void 0)&&c.qr_code&&(v.totp.qr_code=`data:image/svg+xml;utf-8,${v.totp.qr_code}`),{data:v,error:null})})}catch(i){if(zr(i))return{data:null,error:i};throw i}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async i=>{var s;const{data:c,error:h}=i;if(h)return{data:null,error:h};const{data:p,error:v}=await Wr(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:(s=c==null?void 0:c.session)===null||s===void 0?void 0:s.access_token});return v?{data:null,error:v}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+p.expires_in},p)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",p),{data:p,error:v})})}catch(i){if(zr(i))return{data:null,error:i};throw i}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async i=>{var s;const{data:c,error:h}=i;return h?{data:null,error:h}:await Wr(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{headers:this.headers,jwt:(s=c==null?void 0:c.session)===null||s===void 0?void 0:s.access_token})})}catch(i){if(zr(i))return{data:null,error:i};throw i}})}async _challengeAndVerify(e){const{data:i,error:s}=await this._challenge({factorId:e.factorId});return s?{data:null,error:s}:await this._verify({factorId:e.factorId,challengeId:i.id,code:e.code})}async _listFactors(){const{data:{user:e},error:i}=await this.getUser();if(i)return{data:null,error:i};const s=(e==null?void 0:e.factors)||[],c=s.filter(h=>h.factor_type==="totp"&&h.status==="verified");return{data:{all:s,totp:c},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async e=>{var i,s;const{data:{session:c},error:h}=e;if(h)return{data:null,error:h};if(!c)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const p=this._decodeJWT(c.access_token);let v=null;p.aal&&(v=p.aal);let l=v;((s=(i=c.user.factors)===null||i===void 0?void 0:i.filter(O=>O.status==="verified"))!==null&&s!==void 0?s:[]).length>0&&(l="aal2");const P=p.amr||[];return{data:{currentLevel:v,nextLevel:l,currentAuthenticationMethods:P},error:null}}))}}D_.nextInstanceID=0;const _ee=D_;class gee extends _ee{constructor(e){super(e)}}var yee=function(t,e,i,s){function c(h){return h instanceof i?h:new i(function(p){p(h)})}return new(i||(i=Promise))(function(h,p){function v(P){try{A(s.next(P))}catch(O){p(O)}}function l(P){try{A(s.throw(P))}catch(O){p(O)}}function A(P){P.done?h(P.value):c(P.value).then(v,l)}A((s=s.apply(t,e||[])).next())})};class vee{constructor(e,i,s){var c,h,p;if(this.supabaseUrl=e,this.supabaseKey=i,!e)throw new Error("supabaseUrl is required.");if(!i)throw new Error("supabaseKey is required.");const v=LQ(e);this.realtimeUrl=`${v}/realtime/v1`.replace(/^http/i,"ws"),this.authUrl=`${v}/auth/v1`,this.storageUrl=`${v}/storage/v1`,this.functionsUrl=`${v}/functions/v1`;const l=`sb-${new URL(this.authUrl).hostname.split(".")[0]}-auth-token`,A={db:CQ,realtime:IQ,auth:Object.assign(Object.assign({},PQ),{storageKey:l}),global:MQ},P=NQ(s??{},A);this.storageKey=(c=P.auth.storageKey)!==null&&c!==void 0?c:"",this.headers=(h=P.global.headers)!==null&&h!==void 0?h:{},this.auth=this._initSupabaseAuthClient((p=P.auth)!==null&&p!==void 0?p:{},this.headers,P.global.fetch),this.fetch=DQ(i,this._getAccessToken.bind(this),P.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers},P.realtime)),this.rest=new $E(`${v}/rest/v1`,{headers:this.headers,schema:P.db.schema,fetch:this.fetch}),this._listenForAuthEvents()}get functions(){return new VJ(this.functionsUrl,{headers:this.headers,customFetch:this.fetch})}get storage(){return new EQ(this.storageUrl,this.headers,this.fetch)}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,i={},s={}){return this.rest.rpc(e,i,s)}channel(e,i={config:{}}){return this.realtime.channel(e,i)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,i;return yee(this,void 0,void 0,function*(){const{data:s}=yield this.auth.getSession();return(i=(e=s.session)===null||e===void 0?void 0:e.access_token)!==null&&i!==void 0?i:null})}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:i,detectSessionInUrl:s,storage:c,storageKey:h,flowType:p,debug:v},l,A){var P;const O={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new gee({url:this.authUrl,headers:Object.assign(Object.assign({},O),l),storageKey:h,autoRefreshToken:e,persistSession:i,detectSessionInUrl:s,storage:c,flowType:p,debug:v,fetch:A,hasCustomAuthorizationHeader:(P="Authorization"in this.headers)!==null&&P!==void 0?P:!1})}_initRealtimeClient(e){return new hQ(this.realtimeUrl,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e==null?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((i,s)=>{this._handleTokenChanged(i,"CLIENT",s==null?void 0:s.access_token)})}_handleTokenChanged(e,i,s){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==s?(this.realtime.setAuth(s??null),this.changedAccessToken=s):e==="SIGNED_OUT"&&(this.realtime.setAuth(this.supabaseKey),i=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const xee=(t,e,i)=>new vee(t,e,i),CN="https://dbmtysppmiwwjwaeneex.supabase.co",PN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRibXR5c3BwbWl3d2p3YWVuZWV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2NDQ5NTI0NDUsImV4cCI6MTk2MDUyODQ0NX0.i_1JrAfv5fieeVaiJrVIQPL6V0_-H9sR-PKIuGDAIfI";console.log(CN,PN);const x1=xee(CN,PN),bee=async t=>{let{data:e,error:i}=await x1.from("courts_comments").select().eq("court_id",t).eq("moderation",!0);if(i){console.error(i);return}return e},wee=async(t,e)=>{const i=await x1.from("courts_comments").insert([{court_id:t,comment:e}],{returning:"minimal"}).select();if(i.error)throw console.log(i.error),new Error("insert failed");return!0},Tee=async()=>{try{const{data:t,error:e}=await x1.rpc("courts_calc");if(e)throw e;return t}catch(t){console.error("Error fetching map counts:",t)}},Eee=async t=>{const e=await x1.from("courts_faves").insert([{court_id:t}],{returning:"minimal"}).select();if(e.error)throw console.log(e.error),new Error("insert failed");return!0};function bO(t,e,i){const s=t.slice();s[1]=e[i];const c=new Date(s[1].created_at);return s[9]=c,s}function wO(t){let e,i=t[0].length+"",s,c,h,p=t[0].length>1?"s":"",v;return{c(){e=Vt("p"),s=so(i),c=so(" comment"),h=Vt("span"),v=so(p),this.h()},l(l){e=jt(l,"P",{class:!0});var A=$i(e);s=oo(A,i),c=oo(A," comment"),h=jt(A,"SPAN",{});var P=$i(h);v=oo(P,p),P.forEach(bt),A.forEach(bt),this.h()},h(){tt(e,"class","comment-count svelte-13hikzc")},m(l,A){Zi(l,e,A),Et(e,s),Et(e,c),Et(e,h),Et(h,v)},p(l,A){A&1&&i!==(i=l[0].length+"")&&Uc(s,i),A&1&&p!==(p=l[0].length>1?"s":"")&&Uc(v,p)},d(l){l&&bt(e)}}}function TO(t){let e,i,s=t[9].toLocaleDateString("en-US",t[4])+"",c,h=t[1].comment+"",p;return{c(){e=Vt("p"),i=Vt("span"),c=so(s),p=so(h),this.h()},l(v){e=jt(v,"P",{class:!0});var l=$i(e);i=jt(l,"SPAN",{class:!0});var A=$i(i);c=oo(A,s),A.forEach(bt),p=oo(l,h),l.forEach(bt),this.h()},h(){tt(i,"class","svelte-13hikzc"),tt(e,"class","comment svelte-13hikzc")},m(v,l){Zi(v,e,l),Et(e,i),Et(i,c),Et(e,p)},p(v,l){l&1&&s!==(s=v[9].toLocaleDateString("en-US",v[4])+"")&&Uc(c,s),l&1&&h!==(h=v[1].comment+"")&&Uc(p,h)},d(v){v&&bt(e)}}}function See(t){let e,i,s,c,h="Close",p,v,l,A,P="Share your comments:",O,L,U,H,Y,J,oe,me,pe,be,Oe,je=t[0].length>0&&wO(t),st=Vc(t[0]),ut=[];for(let xe=0;xe<st.length;xe+=1)ut[xe]=TO(bO(t,st,xe));return{c(){e=Vt("div"),i=Vt("div"),s=Vt("div"),c=Vt("button"),c.textContent=h,p=or(),je&&je.c(),v=or();for(let xe=0;xe<ut.length;xe+=1)ut[xe].c();l=or(),A=Vt("p"),A.textContent=P,O=or(),L=Vt("form"),U=Vt("textarea"),H=or(),Y=Vt("button"),J=so("Submit Comment"),this.h()},l(xe){e=jt(xe,"DIV",{class:!0});var it=$i(e);i=jt(it,"DIV",{class:!0});var Be=$i(i);s=jt(Be,"DIV",{class:!0});var Qe=$i(s);c=jt(Qe,"BUTTON",{class:!0,"data-svelte-h":!0}),rn(c)!=="svelte-bxc8wg"&&(c.textContent=h),p=ar(Qe),je&&je.l(Qe),v=ar(Qe);for(let Ie=0;Ie<ut.length;Ie+=1)ut[Ie].l(Qe);l=ar(Qe),A=jt(Qe,"P",{class:!0,"data-svelte-h":!0}),rn(A)!=="svelte-161vlou"&&(A.textContent=P),O=ar(Qe),L=jt(Qe,"FORM",{});var Ct=$i(L);U=jt(Ct,"TEXTAREA",{rows:!0,placeholder:!0,class:!0}),$i(U).forEach(bt),H=ar(Ct),Y=jt(Ct,"BUTTON",{type:!0});var Kt=$i(Y);J=oo(Kt,"Submit Comment"),Kt.forEach(bt),Ct.forEach(bt),Qe.forEach(bt),Be.forEach(bt),it.forEach(bt),this.h()},h(){tt(c,"class","close svelte-13hikzc"),tt(A,"class","instructions svelte-13hikzc"),tt(U,"rows","4"),tt(U,"placeholder","Write your comment..."),tt(U,"class","svelte-13hikzc"),tt(Y,"type","submit"),Y.disabled=oe=t[1].trim()==="",tt(s,"class","comment-wrapper svelte-13hikzc"),tt(i,"class","modal svelte-13hikzc"),tt(e,"class","blackout svelte-13hikzc")},m(xe,it){Zi(xe,e,it),Et(e,i),Et(i,s),Et(s,c),Et(s,p),je&&je.m(s,null),Et(s,v);for(let Be=0;Be<ut.length;Be+=1)ut[Be]&&ut[Be].m(s,null);Et(s,l),Et(s,A),Et(s,O),Et(s,L),Et(L,U),c3(U,t[1]),Et(L,H),Et(L,Y),Et(Y,J),pe=!0,be||(Oe=[Ss(c,"click",t[2]),Ss(U,"input",t[6]),Ss(L,"submit",Wz(t[3]))],be=!0)},p(xe,[it]){if(xe[0].length>0?je?je.p(xe,it):(je=wO(xe),je.c(),je.m(s,v)):je&&(je.d(1),je=null),it&17){st=Vc(xe[0]);let Be;for(Be=0;Be<st.length;Be+=1){const Qe=bO(xe,st,Be);ut[Be]?ut[Be].p(Qe,it):(ut[Be]=TO(Qe),ut[Be].c(),ut[Be].m(s,l))}for(;Be<ut.length;Be+=1)ut[Be].d(1);ut.length=st.length}it&2&&c3(U,xe[1]),(!pe||it&2&&oe!==(oe=xe[1].trim()===""))&&(Y.disabled=oe)},i(xe){pe||(xe&&Gc(()=>{pe&&(me||(me=nl(i,sl,{y:-100,duration:300},!0)),me.run(1))}),pe=!0)},o(xe){xe&&(me||(me=nl(i,sl,{y:-100,duration:300},!1)),me.run(0)),pe=!1},d(xe){xe&&bt(e),je&&je.d(),e1(ut,xe),xe&&me&&me.end(),be=!1,L_(Oe)}}}function Aee(t,e,i){let s;Fc(t,u_,L=>i(7,s=L));const c=ok();let{commentId:h}=e,p="",v=[];new Promise(async(L,U)=>{i(0,v=await bee(h))});function l(){Rc(u_,s=!1,s)}function A(){p.trim()!==""&&(i(1,p=p.trim()),wee(h,p),Rc(u_,s=!1,s),c("formSubmit",h))}const P={year:"numeric",month:"long",day:"numeric"};function O(){p=this.value,i(1,p)}return t.$$set=L=>{"commentId"in L&&i(5,h=L.commentId)},[v,p,l,A,P,h,O]}class Mee extends Xc{constructor(e){super(),Zc(this,e,Aee,See,zl,{commentId:5})}}var Df=Pee,Cee=Object.prototype.hasOwnProperty;function Pee(){for(var t={},e=0;e<arguments.length;e++){var i=arguments[e];for(var s in i)Cee.call(i,s)&&(t[s]=i[s])}return t}var IN={exports:{}};(function(t,e){(function(){var i={};t.exports=i,i.simpleFilter=function(s,c){return c.filter(function(h){return i.test(s,h)})},i.test=function(s,c){return i.match(s,c)!==null},i.match=function(s,c,h){h=h||{};var p=0,v=[],l=c.length,A=0,P=0,O=h.pre||"",L=h.post||"",U=h.caseSensitive&&c||c.toLowerCase(),H;s=h.caseSensitive&&s||s.toLowerCase();for(var Y=0;Y<l;Y++)H=c[Y],U[Y]===s[p]?(H=O+H+L,p+=1,P+=1+P):P=0,A+=P,v[v.length]=H;return p===s.length?(A=U===s?1/0:A,{rendered:v.join(""),score:A}):null},i.filter=function(s,c,h){return!c||c.length===0?[]:typeof s!="string"?c:(h=h||{},c.reduce(function(p,v,l,A){var P=v;h.extract&&(P=h.extract(v));var O=i.match(s,P,h);return O!=null&&(p[p.length]={string:O.rendered,score:O.score,index:l,original:v}),p},[]).sort(function(p,v){var l=v.score-p.score;return l||p.index-v.index}))}})()})(IN);var Iee=IN.exports,vo=function(t){return this.component=t,this.items=[],this.active=0,this.wrapper=document.createElement("div"),this.wrapper.className="suggestions-wrapper",this.element=document.createElement("ul"),this.element.className="suggestions",this.wrapper.appendChild(this.element),this.selectingListItem=!1,t.el.parentNode.insertBefore(this.wrapper,t.el.nextSibling),this};vo.prototype.show=function(){this.element.style.display="block"};vo.prototype.hide=function(){this.element.style.display="none"};vo.prototype.add=function(t){this.items.push(t)};vo.prototype.clear=function(){this.items=[],this.active=0};vo.prototype.isEmpty=function(){return!this.items.length};vo.prototype.isVisible=function(){return this.element.style.display==="block"};vo.prototype.draw=function(){if(this.element.innerHTML="",this.items.length===0){this.hide();return}for(var t=0;t<this.items.length;t++)this.drawItem(this.items[t],this.active===t);this.show()};vo.prototype.drawItem=function(t,e){var i=document.createElement("li"),s=document.createElement("a");e&&(i.className+=" active"),s.innerHTML=t.string,i.appendChild(s),this.element.appendChild(i),i.addEventListener("mousedown",(function(){this.selectingListItem=!0}).bind(this)),i.addEventListener("mouseup",(function(){this.handleMouseUp.call(this,t)}).bind(this))};vo.prototype.handleMouseUp=function(t){this.selectingListItem=!1,this.component.value(t.original),this.clear(),this.draw()};vo.prototype.move=function(t){this.active=t,this.draw()};vo.prototype.previous=function(){this.move(this.active===0?this.items.length-1:this.active-1)};vo.prototype.next=function(){this.move(this.active===this.items.length-1?0:this.active+1)};vo.prototype.drawError=function(t){var e=document.createElement("li");e.innerHTML=t,this.element.appendChild(e),this.show()};var Ree=vo,Oee=Df,kee=Iee,Dee=Ree,Qs=function(t,e,i){return i=i||{},this.options=Oee({minLength:2,limit:5,filter:!0,hideOnBlur:!0},i),this.el=t,this.data=e||[],this.list=new Dee(this),this.query="",this.selected=null,this.list.draw(),this.el.addEventListener("keyup",(function(s){this.handleKeyUp(s.keyCode)}).bind(this),!1),this.el.addEventListener("keydown",(function(s){this.handleKeyDown(s)}).bind(this)),this.el.addEventListener("focus",(function(){this.handleFocus()}).bind(this)),this.el.addEventListener("blur",(function(){this.handleBlur()}).bind(this)),this.el.addEventListener("paste",(function(s){this.handlePaste(s)}).bind(this)),this.render=this.options.render?this.options.render.bind(this):this.render.bind(this),this.getItemValue=this.options.getItemValue?this.options.getItemValue.bind(this):this.getItemValue.bind(this),this};Qs.prototype.handleKeyUp=function(t){t===40||t===38||t===27||t===13||t===9||this.handleInputChange(this.el.value)};Qs.prototype.handleKeyDown=function(t){switch(t.keyCode){case 13:case 9:this.list.isEmpty()||(this.list.isVisible()&&t.preventDefault(),this.value(this.list.items[this.list.active].original),this.list.hide());break;case 27:this.list.isEmpty()||this.list.hide();break;case 38:this.list.previous();break;case 40:this.list.next();break}};Qs.prototype.handleBlur=function(){!this.list.selectingListItem&&this.options.hideOnBlur&&this.list.hide()};Qs.prototype.handlePaste=function(t){if(t.clipboardData)this.handleInputChange(t.clipboardData.getData("Text"));else{var e=this;setTimeout(function(){e.handleInputChange(t.target.value)},100)}};Qs.prototype.handleInputChange=function(t){if(this.query=this.normalize(t),this.list.clear(),this.query.length<this.options.minLength){this.list.draw();return}this.getCandidates((function(e){for(var i=0;i<e.length&&(this.list.add(e[i]),i!==this.options.limit-1);i++);this.list.draw()}).bind(this))};Qs.prototype.handleFocus=function(){this.list.isEmpty()||this.list.show(),this.list.selectingListItem=!1};Qs.prototype.update=function(t){this.data=t,this.handleKeyUp()};Qs.prototype.clear=function(){this.data=[],this.list.clear()};Qs.prototype.normalize=function(t){return t=t.toLowerCase(),t};Qs.prototype.match=function(t,e){return t.indexOf(e)>-1};Qs.prototype.value=function(t){if(this.selected=t,this.el.value=this.getItemValue(t),document.createEvent){var e=document.createEvent("HTMLEvents");e.initEvent("change",!0,!1),this.el.dispatchEvent(e)}else this.el.fireEvent("onchange")};Qs.prototype.getCandidates=function(t){var e={pre:"<strong>",post:"</strong>",extract:(function(s){return this.getItemValue(s)}).bind(this)},i;this.options.filter?(i=kee.filter(this.query,this.data,e),i=i.map((function(s){return{original:s.original,string:this.render(s.original,s.string)}}).bind(this))):i=this.data.map((function(s){var c=this.render(s);return{original:s,string:c}}).bind(this)),t(i)};Qs.prototype.getItemValue=function(t){return t};Qs.prototype.render=function(t,e){if(e)return e;for(var i=t.original?this.getItemValue(t.original):this.getItemValue(t),s=this.normalize(i),c=s.lastIndexOf(this.query);c>-1;){var h=c+this.query.length;i=i.slice(0,c)+"<strong>"+i.slice(c,h)+"</strong>"+i.slice(h),c=s.slice(0,c).lastIndexOf(this.query)}return i};Qs.prototype.renderError=function(t){this.list.drawError(t)};var Lee=Qs,RN=Lee,Nee=RN;typeof window<"u"&&(window.Suggestions=RN);var GE={exports:{}},uf=typeof Reflect=="object"?Reflect:null,EO=uf&&typeof uf.apply=="function"?uf.apply:function(e,i,s){return Function.prototype.apply.call(e,i,s)},N0;uf&&typeof uf.ownKeys=="function"?N0=uf.ownKeys:Object.getOwnPropertySymbols?N0=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:N0=function(e){return Object.getOwnPropertyNames(e)};function Fee(t){console&&console.warn&&console.warn(t)}var ON=Number.isNaN||function(e){return e!==e};function Cn(){Cn.init.call(this)}GE.exports=Cn;GE.exports.once=Vee;Cn.EventEmitter=Cn;Cn.prototype._events=void 0;Cn.prototype._eventsCount=0;Cn.prototype._maxListeners=void 0;var SO=10;function b1(t){if(typeof t!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}Object.defineProperty(Cn,"defaultMaxListeners",{enumerable:!0,get:function(){return SO},set:function(t){if(typeof t!="number"||t<0||ON(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");SO=t}});Cn.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};Cn.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||ON(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function kN(t){return t._maxListeners===void 0?Cn.defaultMaxListeners:t._maxListeners}Cn.prototype.getMaxListeners=function(){return kN(this)};Cn.prototype.emit=function(e){for(var i=[],s=1;s<arguments.length;s++)i.push(arguments[s]);var c=e==="error",h=this._events;if(h!==void 0)c=c&&h.error===void 0;else if(!c)return!1;if(c){var p;if(i.length>0&&(p=i[0]),p instanceof Error)throw p;var v=new Error("Unhandled error."+(p?" ("+p.message+")":""));throw v.context=p,v}var l=h[e];if(l===void 0)return!1;if(typeof l=="function")EO(l,this,i);else for(var A=l.length,P=BN(l,A),s=0;s<A;++s)EO(P[s],this,i);return!0};function DN(t,e,i,s){var c,h,p;if(b1(i),h=t._events,h===void 0?(h=t._events=Object.create(null),t._eventsCount=0):(h.newListener!==void 0&&(t.emit("newListener",e,i.listener?i.listener:i),h=t._events),p=h[e]),p===void 0)p=h[e]=i,++t._eventsCount;else if(typeof p=="function"?p=h[e]=s?[i,p]:[p,i]:s?p.unshift(i):p.push(i),c=kN(t),c>0&&p.length>c&&!p.warned){p.warned=!0;var v=new Error("Possible EventEmitter memory leak detected. "+p.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");v.name="MaxListenersExceededWarning",v.emitter=t,v.type=e,v.count=p.length,Fee(v)}return t}Cn.prototype.addListener=function(e,i){return DN(this,e,i,!1)};Cn.prototype.on=Cn.prototype.addListener;Cn.prototype.prependListener=function(e,i){return DN(this,e,i,!0)};function Bee(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function LN(t,e,i){var s={fired:!1,wrapFn:void 0,target:t,type:e,listener:i},c=Bee.bind(s);return c.listener=i,s.wrapFn=c,c}Cn.prototype.once=function(e,i){return b1(i),this.on(e,LN(this,e,i)),this};Cn.prototype.prependOnceListener=function(e,i){return b1(i),this.prependListener(e,LN(this,e,i)),this};Cn.prototype.removeListener=function(e,i){var s,c,h,p,v;if(b1(i),c=this._events,c===void 0)return this;if(s=c[e],s===void 0)return this;if(s===i||s.listener===i)--this._eventsCount===0?this._events=Object.create(null):(delete c[e],c.removeListener&&this.emit("removeListener",e,s.listener||i));else if(typeof s!="function"){for(h=-1,p=s.length-1;p>=0;p--)if(s[p]===i||s[p].listener===i){v=s[p].listener,h=p;break}if(h<0)return this;h===0?s.shift():zee(s,h),s.length===1&&(c[e]=s[0]),c.removeListener!==void 0&&this.emit("removeListener",e,v||i)}return this};Cn.prototype.off=Cn.prototype.removeListener;Cn.prototype.removeAllListeners=function(e){var i,s,c;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var h=Object.keys(s),p;for(c=0;c<h.length;++c)p=h[c],p!=="removeListener"&&this.removeAllListeners(p);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(i=s[e],typeof i=="function")this.removeListener(e,i);else if(i!==void 0)for(c=i.length-1;c>=0;c--)this.removeListener(e,i[c]);return this};function NN(t,e,i){var s=t._events;if(s===void 0)return[];var c=s[e];return c===void 0?[]:typeof c=="function"?i?[c.listener||c]:[c]:i?Uee(c):BN(c,c.length)}Cn.prototype.listeners=function(e){return NN(this,e,!0)};Cn.prototype.rawListeners=function(e){return NN(this,e,!1)};Cn.listenerCount=function(t,e){return typeof t.listenerCount=="function"?t.listenerCount(e):FN.call(t,e)};Cn.prototype.listenerCount=FN;function FN(t){var e=this._events;if(e!==void 0){var i=e[t];if(typeof i=="function")return 1;if(i!==void 0)return i.length}return 0}Cn.prototype.eventNames=function(){return this._eventsCount>0?N0(this._events):[]};function BN(t,e){for(var i=new Array(e),s=0;s<e;++s)i[s]=t[s];return i}function zee(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}function Uee(t){for(var e=new Array(t.length),i=0;i<e.length;++i)e[i]=t[i].listener||t[i];return e}function Vee(t,e){return new Promise(function(i,s){function c(p){t.removeListener(e,h),s(p)}function h(){typeof t.removeListener=="function"&&t.removeListener("error",c),i([].slice.call(arguments))}zN(t,e,h,{once:!0}),e!=="error"&&jee(t,c,{once:!0})})}function jee(t,e,i){typeof t.on=="function"&&zN(t,"error",e,i)}function zN(t,e,i,s){if(typeof t.on=="function")s.once?t.once(e,i):t.on(e,i);else if(typeof t.addEventListener=="function")t.addEventListener(e,function c(h){s.once&&t.removeEventListener(e,c),i(h)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t)}var $ee=GE.exports,Wee={fr:{name:"France",bbox:[[-4.59235,41.380007],[9.560016,51.148506]]},us:{name:"United States",bbox:[[-171.791111,18.91619],[-66.96466,71.357764]]},ru:{name:"Russia",bbox:[[19.66064,41.151416],[190.10042,81.2504]]},ca:{name:"Canada",bbox:[[-140.99778,41.675105],[-52.648099,83.23324]]}};function Hee(t){var e=t.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);return e?{key:e[1],value:e[2]}:null}function qee(t){var e=t.match(/<?([^>]*)>(.*)/);if(!e)return null;var i=e[1],s=e[2].split(";"),c=null,h=s.reduce(function(p,v){var l=Hee(v);return l?l.key==="rel"?(c||(c=l.value),p):(p[l.key]=l.value,p):p},{});return c?{url:i,rel:c,params:h}:null}function Gee(t){return t?t.split(/,\s*</).reduce(function(e,i){var s=qee(i);if(!s)return e;var c=s.rel.split(/\s+/);return c.forEach(function(h){e[h]||(e[h]={url:s.url,params:s.params})}),e},{}):{}}var Xee=Gee,Zee=Xee;function XE(t,e){this.request=t,this.headers=e.headers,this.rawBody=e.body,this.statusCode=e.statusCode;try{this.body=JSON.parse(e.body||"{}")}catch{this.body=e.body}this.links=Zee(this.headers.link)}XE.prototype.hasNextPage=function(){return!!this.links.next};XE.prototype.nextPage=function(){return this.hasNextPage()?this.request._extend({path:this.links.next.url}):null};var Yee=XE,w1={API_ORIGIN:"https://api.mapbox.com",EVENT_PROGRESS_DOWNLOAD:"downloadProgress",EVENT_PROGRESS_UPLOAD:"uploadProgress",EVENT_ERROR:"error",EVENT_RESPONSE:"response",ERROR_HTTP:"HttpError",ERROR_REQUEST_ABORTED:"RequestAbortedError"},AO=w1;function Kee(t){var e=t.type||AO.ERROR_HTTP,i;if(t.body)try{i=JSON.parse(t.body)}catch{i=t.body}else i=null;var s=t.message||null;s||(typeof i=="string"?s=i:i&&typeof i.message=="string"?s=i.message:e===AO.ERROR_REQUEST_ABORTED&&(s="Request aborted")),this.message=s,this.type=e,this.statusCode=t.statusCode||null,this.request=t.request,this.body=i}var Jee=Kee;function Qee(t){var e=t.indexOf(":"),i=t.substring(0,e).trim().toLowerCase(),s=t.substring(e+1).trim();return{name:i,value:s}}function ete(t){var e={};return t&&t.trim().split(/[\r|\n]+/).forEach(function(i){var s=Qee(i);e[s.name]=s.value}),e}var tte=ete,ite=Yee,MO=Jee,fw=w1,rte=tte,wv={};function nte(t){var e=wv[t.id];e&&(e.abort(),delete wv[t.id])}function ste(t,e){return new ite(t,{body:e.response,headers:rte(e.getAllResponseHeaders()),statusCode:e.status})}function CO(t){var e=t.total,i=t.loaded,s=100*i/e;return{total:e,transferred:i,percent:s}}function UN(t,e){return new Promise(function(i,s){e.onprogress=function(p){t.emitter.emit(fw.EVENT_PROGRESS_DOWNLOAD,CO(p))};var c=t.file;c&&(e.upload.onprogress=function(p){t.emitter.emit(fw.EVENT_PROGRESS_UPLOAD,CO(p))}),e.onerror=function(p){s(p)},e.onabort=function(){var p=new MO({request:t,type:fw.ERROR_REQUEST_ABORTED});s(p)},e.onload=function(){if(delete wv[t.id],e.status<200||e.status>=400){var p=new MO({request:t,body:e.response,statusCode:e.status});s(p);return}i(e)};var h=t.body;typeof h=="string"?e.send(h):h?e.send(JSON.stringify(h)):c?e.send(c):e.send(),wv[t.id]=e}).then(function(i){return ste(t,i)})}function VN(t,e){var i=t.url(e),s=new window.XMLHttpRequest;return s.open(t.method,i),Object.keys(t.headers).forEach(function(c){s.setRequestHeader(c,t.headers[c])}),s}function ote(t){return Promise.resolve().then(function(){var e=VN(t,t.client.accessToken);return UN(t,e)})}var ate={browserAbort:nte,sendRequestXhr:UN,browserSend:ote,createRequestXhr:VN},Tv={exports:{}};/*! http://mths.be/base64 v0.1.0 by @mathias | MIT license */Tv.exports;(function(t,e){(function(i){var s=e,c=t&&t.exports==s&&t,h=typeof oh=="object"&&oh;(h.global===h||h.window===h)&&(i=h);var p=function(H){this.message=H};p.prototype=new Error,p.prototype.name="InvalidCharacterError";var v=function(H){throw new p(H)},l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",A=/[\t\n\f\r ]/g,P=function(H){H=String(H).replace(A,"");var Y=H.length;Y%4==0&&(H=H.replace(/==?$/,""),Y=H.length),(Y%4==1||/[^+a-zA-Z0-9/]/.test(H))&&v("Invalid character: the string to be decoded is not correctly encoded.");for(var J=0,oe,me,pe="",be=-1;++be<Y;)me=l.indexOf(H.charAt(be)),oe=J%4?oe*64+me:me,J++%4&&(pe+=String.fromCharCode(255&oe>>(-2*J&6)));return pe},O=function(H){H=String(H),/[^\0-\xFF]/.test(H)&&v("The string to be encoded contains characters outside of the Latin1 range.");for(var Y=H.length%3,J="",oe=-1,me,pe,be,Oe,je=H.length-Y;++oe<je;)me=H.charCodeAt(oe)<<16,pe=H.charCodeAt(++oe)<<8,be=H.charCodeAt(++oe),Oe=me+pe+be,J+=l.charAt(Oe>>18&63)+l.charAt(Oe>>12&63)+l.charAt(Oe>>6&63)+l.charAt(Oe&63);return Y==2?(me=H.charCodeAt(oe)<<8,pe=H.charCodeAt(++oe),Oe=me+pe,J+=l.charAt(Oe>>10)+l.charAt(Oe>>4&63)+l.charAt(Oe<<2&63)+"="):Y==1&&(Oe=H.charCodeAt(oe),J+=l.charAt(Oe>>2)+l.charAt(Oe<<4&63)+"=="),J},L={encode:O,decode:P,version:"0.1.0"};if(s&&!s.nodeType)if(c)c.exports=L;else for(var U in L)L.hasOwnProperty(U)&&(s[U]=L[U]);else i.base64=L})(oh)})(Tv,Tv.exports);var lte=Tv.exports,cte=lte,pw={};function ute(t){if(pw[t])return pw[t];var e=t.split("."),i=e[0],s=e[1];if(!s)throw new Error("Invalid token");var c=hte(s),h={usage:i,user:c.u};return Zu(c,"a")&&(h.authorization=c.a),Zu(c,"exp")&&(h.expires=c.exp*1e3),Zu(c,"iat")&&(h.created=c.iat*1e3),Zu(c,"scopes")&&(h.scopes=c.scopes),Zu(c,"client")&&(h.client=c.client),Zu(c,"ll")&&(h.lastLogin=c.ll),Zu(c,"iu")&&(h.impersonator=c.iu),pw[t]=h,h}function hte(t){try{return JSON.parse(cte.decode(t))}catch{throw new Error("Invalid token")}}function Zu(t,e){return Object.prototype.hasOwnProperty.call(t,e)}var jN=ute,$N={exports:{}};(function(t){var e=Object.prototype.hasOwnProperty,i="~";function s(){}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(i=!1));function c(l,A,P){this.fn=l,this.context=A,this.once=P||!1}function h(l,A,P,O,L){if(typeof P!="function")throw new TypeError("The listener must be a function");var U=new c(P,O||l,L),H=i?i+A:A;return l._events[H]?l._events[H].fn?l._events[H]=[l._events[H],U]:l._events[H].push(U):(l._events[H]=U,l._eventsCount++),l}function p(l,A){--l._eventsCount===0?l._events=new s:delete l._events[A]}function v(){this._events=new s,this._eventsCount=0}v.prototype.eventNames=function(){var A=[],P,O;if(this._eventsCount===0)return A;for(O in P=this._events)e.call(P,O)&&A.push(i?O.slice(1):O);return Object.getOwnPropertySymbols?A.concat(Object.getOwnPropertySymbols(P)):A},v.prototype.listeners=function(A){var P=i?i+A:A,O=this._events[P];if(!O)return[];if(O.fn)return[O.fn];for(var L=0,U=O.length,H=new Array(U);L<U;L++)H[L]=O[L].fn;return H},v.prototype.listenerCount=function(A){var P=i?i+A:A,O=this._events[P];return O?O.fn?1:O.length:0},v.prototype.emit=function(A,P,O,L,U,H){var Y=i?i+A:A;if(!this._events[Y])return!1;var J=this._events[Y],oe=arguments.length,me,pe;if(J.fn){switch(J.once&&this.removeListener(A,J.fn,void 0,!0),oe){case 1:return J.fn.call(J.context),!0;case 2:return J.fn.call(J.context,P),!0;case 3:return J.fn.call(J.context,P,O),!0;case 4:return J.fn.call(J.context,P,O,L),!0;case 5:return J.fn.call(J.context,P,O,L,U),!0;case 6:return J.fn.call(J.context,P,O,L,U,H),!0}for(pe=1,me=new Array(oe-1);pe<oe;pe++)me[pe-1]=arguments[pe];J.fn.apply(J.context,me)}else{var be=J.length,Oe;for(pe=0;pe<be;pe++)switch(J[pe].once&&this.removeListener(A,J[pe].fn,void 0,!0),oe){case 1:J[pe].fn.call(J[pe].context);break;case 2:J[pe].fn.call(J[pe].context,P);break;case 3:J[pe].fn.call(J[pe].context,P,O);break;case 4:J[pe].fn.call(J[pe].context,P,O,L);break;default:if(!me)for(Oe=1,me=new Array(oe-1);Oe<oe;Oe++)me[Oe-1]=arguments[Oe];J[pe].fn.apply(J[pe].context,me)}}return!0},v.prototype.on=function(A,P,O){return h(this,A,P,O,!1)},v.prototype.once=function(A,P,O){return h(this,A,P,O,!0)},v.prototype.removeListener=function(A,P,O,L){var U=i?i+A:A;if(!this._events[U])return this;if(!P)return p(this,U),this;var H=this._events[U];if(H.fn)H.fn===P&&(!L||H.once)&&(!O||H.context===O)&&p(this,U);else{for(var Y=0,J=[],oe=H.length;Y<oe;Y++)(H[Y].fn!==P||L&&!H[Y].once||O&&H[Y].context!==O)&&J.push(H[Y]);J.length?this._events[U]=J.length===1?J[0]:J:p(this,U)}return this},v.prototype.removeAllListeners=function(A){var P;return A?(P=i?i+A:A,this._events[P]&&p(this,P)):(this._events=new s,this._eventsCount=0),this},v.prototype.off=v.prototype.removeListener,v.prototype.addListener=v.prototype.on,v.prefixed=i,v.EventEmitter=v,t.exports=v})($N);var dte=$N.exports;function fte(t){return t.map(encodeURIComponent).join(",")}function WN(t){return Array.isArray(t)?fte(t):encodeURIComponent(String(t))}function HN(t,e,i){if(i===!1||i===null)return t;var s=/\?/.test(t)?"&":"?",c=encodeURIComponent(e);return i!==void 0&&i!==""&&i!==!0&&(c+="="+WN(i)),""+t+s+c}function pte(t,e){if(!e)return t;var i=t;return Object.keys(e).forEach(function(s){var c=e[s];c!==void 0&&(Array.isArray(c)&&(c=c.filter(function(h){return h!=null}).join(",")),i=HN(i,s,c))}),i}function mte(t,e){if(!e||t.slice(0,4)==="http")return t;var i=t[0]==="/"?"":"/";return""+e.replace(/\/$/,"")+i+t}function _te(t,e){return e?t.replace(/\/:([a-zA-Z0-9]+)/g,function(i,s){var c=e[s];if(c===void 0)throw new Error("Unspecified route parameter "+s);var h=WN(c);return"/"+h}):t}var gte={appendQueryObject:pte,appendQueryParam:HN,prependOrigin:mte,interpolateRouteParams:_te},yte=jN,ZE=Df,vte=dte,E0=gte,PO=w1,xte=1;function Hc(t,e){if(!t)throw new Error("MapiRequest requires a client");if(!e||!e.path||!e.method)throw new Error("MapiRequest requires an options object with path and method properties");var i={};e.body&&(i["content-type"]="application/json");var s=ZE(i,e.headers),c=Object.keys(s).reduce(function(h,p){return h[p.toLowerCase()]=s[p],h},{});this.id=xte++,this._options=e,this.emitter=new vte,this.client=t,this.response=null,this.error=null,this.sent=!1,this.aborted=!1,this.path=e.path,this.method=e.method,this.origin=e.origin||t.origin,this.query=e.query||{},this.params=e.params||{},this.body=e.body||null,this.file=e.file||null,this.encoding=e.encoding||"utf8",this.sendFileAs=e.sendFileAs||null,this.headers=c}Hc.prototype.url=function(e){var i=E0.prependOrigin(this.path,this.origin);i=E0.appendQueryObject(i,this.query);var s=this.params,c=e??this.client.accessToken;if(c){i=E0.appendQueryParam(i,"access_token",c);var h=yte(c).user;s=ZE({ownerId:h},s)}return i=E0.interpolateRouteParams(i,s),i};Hc.prototype.send=function(){var e=this;if(e.sent)throw new Error("This request has already been sent. Check the response and error properties. Create a new request with clone().");return e.sent=!0,e.client.sendRequest(e).then(function(i){return e.response=i,e.emitter.emit(PO.EVENT_RESPONSE,i),i},function(i){throw e.error=i,e.emitter.emit(PO.EVENT_ERROR,i),i})};Hc.prototype.abort=function(){this._nextPageRequest&&(this._nextPageRequest.abort(),delete this._nextPageRequest),!(this.response||this.error||this.aborted)&&(this.aborted=!0,this.client.abortRequest(this))};Hc.prototype.eachPage=function(e){var i=this;function s(p){function v(){delete i._nextPageRequest;var l=p.nextPage();l&&(i._nextPageRequest=l,h(l))}e(null,p,v)}function c(p){e(p,null,function(){})}function h(p){p.send().then(s,c)}h(this)};Hc.prototype.clone=function(){return this._extend()};Hc.prototype._extend=function(e){var i=ZE(this._options,e);return new Hc(this.client,i)};var bte=Hc,wte=jN,Tte=bte,Ete=w1;function qN(t){if(!t||!t.accessToken)throw new Error("Cannot create a client without an access token");wte(t.accessToken),this.accessToken=t.accessToken,this.origin=t.origin||Ete.API_ORIGIN}qN.prototype.createRequest=function(e){return new Tte(this,e)};var GN=qN,XN=ate,ZN=GN;function Cf(t){ZN.call(this,t)}Cf.prototype=Object.create(ZN.prototype);Cf.prototype.constructor=Cf;Cf.prototype.sendRequest=XN.browserSend;Cf.prototype.abortRequest=XN.browserAbort;function Ste(t){return new Cf(t)}var YN=Ste,Ate=YN,Mte=Ate,Cte=Object.prototype.toString,Pte=function(t){var e;return Cte.call(t)==="[object Object]"&&(e=Object.getPrototypeOf(t),e===null||e===Object.getPrototypeOf({}))},Ite=Pte,Rte=Df,KN="value",mw=`
  `,zn={};zn.assert=function(t,e){return e=e||{},function(i){var s=qc(t,i);if(s){var c=YE(s,e);throw e.apiName&&(c=e.apiName+": "+c),new Error(c)}}};zn.shape=function(e){var i=Lte(e);return function(c){var h=qc(zn.plainObject,c);if(h)return h;for(var p,v,l=[],A=0;A<i.length;A++)p=i[A].key,v=i[A].value,h=qc(v,c[p]),h&&l.push([p].concat(h));return l.length<2?l[0]:function(P){l=l.map(function(U){var H=U[0],Y=YE(U,P).split(`
`).join(mw);return"- "+H+": "+Y});var O=P.path.join("."),L=O===KN?"":" of "+O;return"The following properties"+L+" have invalid values:"+mw+l.join(mw)}}};zn.strictShape=function(e){var i=zn.shape(e);return function(c){var h=i(c);if(h)return h;var p=Object.keys(c).reduce(function(v,l){return e[l]===void 0&&v.push(l),v},[]);if(p.length!==0)return function(){return"The following keys are invalid: "+p.join(", ")}}};zn.arrayOf=function(e){return JN(e)};zn.tuple=function(){var e=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return JN(e)};function JN(t){var e=Array.isArray(t),i=function(s){return e?t[s]:t};return function(c){var h=qc(zn.plainArray,c);if(h)return h;if(e&&c.length!==t.length)return"an array with "+t.length+" items";for(var p=0;p<c.length;p++)if(h=qc(i(p),c[p]),h)return[p].concat(h)}}zn.required=function(e){function i(s){return s==null?function(c){return QN(c,eF(c.path)?"cannot be undefined/null.":"is required.")}:e.apply(this,arguments)}return i.__required=!0,i};zn.oneOfType=function(){var e=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return function(s){var c=e.map(function(h){return qc(h,s)}).filter(Boolean);if(c.length===e.length)return c.every(function(h){return h.length===1&&typeof h[0]=="string"})?Ote(c.map(function(h){return h[0]})):c.reduce(function(h,p){return p.length>h.length?p:h})}};zn.equal=function(e){return function(s){if(s!==e)return JSON.stringify(e)}};zn.oneOf=function(){var e=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments),i=e.map(function(s){return zn.equal(s)});return zn.oneOfType.apply(this,i)};zn.range=function(e){var i=e[0],s=e[1];return function(h){var p=qc(zn.number,h);if(p||h<i||h>s)return"number between "+i+" & "+s+" (inclusive)"}};zn.any=function(){};zn.boolean=function(e){if(typeof e!="boolean")return"boolean"};zn.number=function(e){if(typeof e!="number")return"number"};zn.plainArray=function(e){if(!Array.isArray(e))return"array"};zn.plainObject=function(e){if(!Ite(e))return"object"};zn.string=function(e){if(typeof e!="string")return"string"};zn.func=function(e){if(typeof e!="function")return"function"};function qc(t,e){if(!(e==null&&!t.hasOwnProperty("__required"))){var i=t(e);if(i)return Array.isArray(i)?i:[i]}}function YE(t,e){var i=t.length,s=t[i-1],c=t.slice(0,i-1);return c.length===0&&(c=[KN]),e=Rte(e,{path:c}),typeof s=="function"?s(e):QN(e,kte(s))}function Ote(t){return t.length<2?t[0]:t.length===2?t.join(" or "):t.slice(0,-1).join(", ")+", or "+t.slice(-1)}function kte(t){return"must be "+Dte(t)+"."}function Dte(t){return/^an? /.test(t)?t:/^[aeiou]/i.test(t)?"an "+t:/^[a-z]/i.test(t)?"a "+t:t}function QN(t,e){var i=eF(t.path),s=t.path.join(".")+" "+e,c=i?"Item at position ":"";return c+s}function eF(t){return typeof t[t.length-1]=="number"||typeof t[0]=="number"}function Lte(t){return Object.keys(t||{}).map(function(e){return{key:e,value:t[e]}})}zn.validate=qc;zn.processMessage=YE;var Nte=zn,Fte=Df,hf=Nte;function Bte(t){if(typeof window<"u")return t instanceof oh.Blob||t instanceof oh.ArrayBuffer?void 0:"Blob or ArrayBuffer";if(!(typeof t=="string"||t.pipe!==void 0))return"Filename or Readable stream"}function zte(t,e){return hf.assert(hf.strictShape(t),e)}function Ute(t){var e="date";if(typeof t=="boolean")return e;try{var i=new Date(t);if(i.getTime&&isNaN(i.getTime()))return e}catch{return e}}function Vte(t){return hf.tuple(hf.number,hf.number)(t)}var jte=Fte(hf,{file:Bte,date:Ute,coordinates:Vte,assertShape:zte});function $te(t,e){var i=function(s,c){return e.indexOf(s)!==-1&&c!==void 0};return typeof e=="function"&&(i=e),Object.keys(t).filter(function(s){return i(s,t[s])}).reduce(function(s,c){return s[c]=t[c],s},{})}var Wte=$te;function Hte(t,e){return Object.keys(t).reduce(function(i,s){return i[s]=e(s,t[s]),i},{})}var qte=Hte,Gte=qte;function Xte(t){return Gte(t,function(e,i){return typeof i=="boolean"?JSON.stringify(i):i})}var Zte=Xte,Yte=GN,Kte=YN;function Jte(t){return function(e){var i;Yte.prototype.isPrototypeOf(e)?i=e:i=Kte(e);var s=Object.create(t);return s.client=i,s}}var Qte=Jte,tF=Df,Hr=jte,Ev=Wte,iF=Zte,eie=Qte,KE={},rF=["country","region","postcode","district","place","locality","neighborhood","address","poi","poi.landmark"];KE.forwardGeocode=function(t){Hr.assertShape({query:Hr.required(Hr.string),mode:Hr.oneOf("mapbox.places","mapbox.places-permanent"),countries:Hr.arrayOf(Hr.string),proximity:Hr.oneOf(Hr.coordinates,"ip"),types:Hr.arrayOf(Hr.oneOf(rF)),autocomplete:Hr.boolean,bbox:Hr.arrayOf(Hr.number),limit:Hr.number,language:Hr.arrayOf(Hr.string),routing:Hr.boolean,fuzzyMatch:Hr.boolean,worldview:Hr.string})(t),t.mode=t.mode||"mapbox.places";var e=iF(tF({country:t.countries},Ev(t,["proximity","types","autocomplete","bbox","limit","language","routing","fuzzyMatch","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:Ev(t,["mode","query"]),query:e})};KE.reverseGeocode=function(t){Hr.assertShape({query:Hr.required(Hr.coordinates),mode:Hr.oneOf("mapbox.places","mapbox.places-permanent"),countries:Hr.arrayOf(Hr.string),types:Hr.arrayOf(Hr.oneOf(rF)),bbox:Hr.arrayOf(Hr.number),limit:Hr.number,language:Hr.arrayOf(Hr.string),reverseMode:Hr.oneOf("distance","score"),routing:Hr.boolean,worldview:Hr.string})(t),t.mode=t.mode||"mapbox.places";var e=iF(tF({country:t.countries},Ev(t,["country","types","bbox","limit","language","reverseMode","routing","worldview"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:Ev(t,["mode","query"]),query:e})};var tie=eie(KE);let iie="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",nF=t=>crypto.getRandomValues(new Uint8Array(t)),sF=(t,e,i)=>{let s=(2<<Math.log(t.length-1)/Math.LN2)-1,c=-~(1.6*s*e/t.length);return(h=e)=>{let p="";for(;;){let v=i(c),l=c;for(;l--;)if(p+=t[v[l]&s]||"",p.length===h)return p}}},rie=(t,e=21)=>sF(t,e,nF),nie=(t=21)=>crypto.getRandomValues(new Uint8Array(t)).reduce((e,i)=>(i&=63,i<36?e+=i.toString(36):i<62?e+=(i-26).toString(36).toUpperCase():i>62?e+="-":e+="_",e),"");const sie=Object.freeze(Object.defineProperty({__proto__:null,customAlphabet:rie,customRandom:sF,nanoid:nie,random:nF,urlAlphabet:iie},Symbol.toStringTag,{value:"Module"})),oie=Zz(sie);var aie=oie.nanoid;function oF(t){this.origin=t.origin||"https://api.mapbox.com",this.endpoint="events/v2",this.access_token=t.accessToken,this.version="0.2.0",this.sessionID=this.generateSessionID(),this.userAgent=this.getUserAgent(),this.options=t,this.send=this.send.bind(this),this.countries=t.countries?t.countries.split(","):null,this.types=t.types?t.types.split(","):null,this.bbox=t.bbox?t.bbox:null,this.language=t.language?t.language.split(","):null,this.limit=t.limit?+t.limit:null,this.locale=navigator.language||null,this.enableEventLogging=this.shouldEnableLogging(t),this.eventQueue=new Array,this.flushInterval=t.flushInterval||1e3,this.maxQueueSize=t.maxQueueSize||100,this.timer=this.flushInterval?setTimeout(this.flush.bind(this),this.flushInterval):null,this.lastSentInput="",this.lastSentIndex=0}oF.prototype={select:function(t,e){var i=this.getSelectedIndex(t,e),s=this.getEventPayload("search.select",e);if(s.resultIndex=i,s.resultPlaceName=t.place_name,s.resultId=t.id,!(i===this.lastSentIndex&&s.queryString===this.lastSentInput||i==-1)&&(this.lastSentIndex=i,this.lastSentInput=s.queryString,!!s.queryString))return this.push(s)},start:function(t){var e=this.getEventPayload("search.start",t);if(e.queryString)return this.push(e)},keyevent:function(t,e){if(t.key&&!(t.metaKey||[9,27,37,39,13,38,40].indexOf(t.keyCode)!==-1)){var i=this.getEventPayload("search.keystroke",e);if(i.lastAction=t.key,!!i.queryString)return this.push(i)}},send:function(t,e){if(!this.enableEventLogging)return e?e():void 0;var i=this.getRequestOptions(t);this.request(i,(function(s){if(s)return this.handleError(s,e);if(e)return e()}).bind(this))},getRequestOptions:function(t){Array.isArray(t)||(t=[t]);var e={method:"POST",host:this.origin,path:this.endpoint+"?access_token="+this.access_token,headers:{"Content-Type":"application/json"},body:JSON.stringify(t)};return e},getEventPayload:function(t,e){var i;e.options.proximity?typeof e.options.proximity=="object"?i=[e.options.proximity.longitude,e.options.proximity.latitude]:e.options.proximity==="ip"?i=[999,999]:i=e.options.proximity:i=null;var s=e._map?e._map.getZoom():void 0,c={event:t,created:+new Date,sessionIdentifier:this.sessionID,country:this.countries,userAgent:this.userAgent,language:this.language,bbox:this.bbox,types:this.types,endpoint:"mapbox.places",autocomplete:e.options.autocomplete,fuzzyMatch:e.options.fuzzyMatch,proximity:i,limit:e.options.limit,routing:e.options.routing,worldview:e.options.worldview,mapZoom:s,keyboardLocale:this.locale};return t==="search.select"?c.queryString=e.inputString:t!="search.select"&&e._inputEl?c.queryString=e._inputEl.value:c.queryString=e.inputString,c},request:function(t,e){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(this.readyState==4)return this.status==204?e(null):e(this.statusText)},i.open(t.method,t.host+"/"+t.path,!0);for(var s in t.headers){var c=t.headers[s];i.setRequestHeader(s,c)}i.send(t.body)},handleError:function(t,e){if(e)return e(t)},generateSessionID:function(){return aie()},getUserAgent:function(){return"mapbox-gl-geocoder."+this.version+"."+navigator.userAgent},getSelectedIndex:function(t,e){if(e._typeahead){var i=e._typeahead.data,s=t.id,c=i.map(function(p){return p.id}),h=c.indexOf(s);return h}},shouldEnableLogging:function(t){return!(t.enableEventLogging===!1||t.origin&&t.origin!=="https://api.mapbox.com"||t.localGeocoder||t.filter)},flush:function(){this.eventQueue.length>0&&(this.send(this.eventQueue),this.eventQueue=new Array),this.timer&&clearTimeout(this.timer),this.flushInterval&&(this.timer=setTimeout(this.flush.bind(this),this.flushInterval))},push:function(t,e){this.eventQueue.push(t),(this.eventQueue.length>=this.maxQueueSize||e)&&this.flush()},remove:function(){this.flush()}};var lie=oF,cie={de:"Suche",it:"Ricerca",en:"Search",nl:"Zoeken",fr:"Chercher",ca:"Cerca",he:"לחפש",ja:"サーチ",lv:"Meklēt",pt:"Procurar",sr:"Претрага",zh:"搜索",cs:"Vyhledávání",hu:"Keresés",ka:"ძიება",nb:"Søke",sk:"Vyhľadávanie",th:"ค้นหา",fi:"Hae",is:"Leita",ko:"수색",pl:"Szukaj",sl:"Iskanje",fa:"جستجو",ru:"Поиск"},uie={placeholder:cie},aF={exports:{}};(function(t){(function(e,i,s){t.exports?t.exports=s():e[i]=s()})(oh,"subtag",function(){var e="",i=/^([a-zA-Z]{2,3})(?:[_-]+([a-zA-Z]{3})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{4})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{2}|[0-9]{3})(?=$|[_-]+))?/;function s(l){return l.match(i)||[]}function c(l){return s(l).filter(function(A,P){return A&&P})}function h(l){return l=s(l),{language:l[1]||e,extlang:l[2]||e,script:l[3]||e,region:l[4]||e}}function p(l,A,P){Object.defineProperty(l,A,{value:P,enumerable:!0})}function v(l,A,P){function O(L){return s(L)[l]||e}p(O,"pattern",A),p(h,P,O)}return v(1,/^[a-zA-Z]{2,3}$/,"language"),v(2,/^[a-zA-Z]{3}$/,"extlang"),v(3,/^[a-zA-Z]{4}$/,"script"),v(4,/^[a-zA-Z]{2}$|^[0-9]{3}$/,"region"),p(h,"split",c),h})})(aF);var hie=aF.exports;function lF(){}lF.prototype={isSupport:function(){return!!window.navigator.geolocation},getCurrentPosition:function(){const t={enableHighAccuracy:!0};return new Promise(function(e,i){window.navigator.geolocation.getCurrentPosition(e,i,t)})}};var die=lF;function fie(t,e){const i=cF(t),s=["address","street","place","country"];var c;if(typeof e=="function")return e(i);const h=s.indexOf(e);return h===-1?c=s:c=s.slice(h),c.reduce(function(p,v){return i[v]?(p!==""&&(p=p+", "),p+i[v]):p},"")}function cF(t){const e=t.address||"",i=t.text||"",s=t.place_name||"",h={address:s.split(",")[0],houseNumber:e,street:i,placeName:s};return t.context.forEach(function(p){const v=p.id.split(".")[0];h[v]=p.text}),h}const pie=/^[ ]*(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)[ ]*$/;var mie={transformFeatureToGeolocationText:fie,getAddressInfo:cF,REVERSE_GEOCODE_COORD_RGX:pie},_ie=Nee,gie=Yz,Ju=Df,yie=$ee.EventEmitter,IO=Wee,_w=Mte,gw=tie,vie=lie,xie=uie,bie=hie,wie=die,RO=mie;const Sc={FORWARD:0,LOCAL:1,REVERSE:2};function Tie(){var t=document.createElement("div");return t.className="mapboxgl-ctrl-geocoder--powered-by",t.innerHTML='<a href="https://www.mapbox.com/search-service" target="_blank">Powered by Mapbox</a>',t}function uF(t){this._eventEmitter=new yie,this.options=Ju({},this.options,t),this.inputString="",this.fresh=!0,this.lastSelected=null,this.geolocation=new wie}uF.prototype={options:{zoom:16,flyTo:!0,trackProximity:!0,minLength:2,reverseGeocode:!1,flipCoordinates:!1,limit:5,origin:"https://api.mapbox.com",enableEventLogging:!0,marker:!0,mapboxgl:null,collapsed:!1,clearAndBlurOnEsc:!1,clearOnBlur:!1,enableGeolocation:!1,addressAccuracy:"street",getItemValue:function(t){return t.place_name},render:function(t){var e=t.place_name.split(",");return'<div class="mapboxgl-ctrl-geocoder--suggestion"><div class="mapboxgl-ctrl-geocoder--suggestion-title">'+e[0]+'</div><div class="mapboxgl-ctrl-geocoder--suggestion-address">'+e.splice(1,e.length).join(",")+"</div></div>"}},addTo:function(t){function e(i,s){if(!document.body.contains(s))throw new Error("Element provided to #addTo() exists, but is not in the DOM");const c=i.onAdd();s.appendChild(c)}if(t._controlContainer)t.addControl(this);else if(t instanceof HTMLElement)e(this,t);else if(typeof t=="string"){const i=document.querySelectorAll(t);if(i.length===0)throw new Error("Element ",t,"not found.");if(i.length>1)throw new Error("Geocoder can only be added to a single html element");e(this,i[0])}else throw new Error("Error: addTo must be a mapbox-gl-js map, an html element, or a CSS selector query for a single html element")},onAdd:function(t){if(t&&typeof t!="string"&&(this._map=t),this.setLanguage(),this.options.localGeocoderOnly||(this.geocoderService=gw(_w({accessToken:this.options.accessToken,origin:this.options.origin}))),this.options.localGeocoderOnly&&!this.options.localGeocoder)throw new Error("A localGeocoder function must be specified to use localGeocoderOnly mode");this.eventManager=new vie(this.options),this._onChange=this._onChange.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onPaste=this._onPaste.bind(this),this._onBlur=this._onBlur.bind(this),this._showButton=this._showButton.bind(this),this._hideButton=this._hideButton.bind(this),this._onQueryResult=this._onQueryResult.bind(this),this.clear=this.clear.bind(this),this._updateProximity=this._updateProximity.bind(this),this._collapse=this._collapse.bind(this),this._unCollapse=this._unCollapse.bind(this),this._clear=this._clear.bind(this),this._clearOnBlur=this._clearOnBlur.bind(this),this._geolocateUser=this._geolocateUser.bind(this);var e=this.container=document.createElement("div");e.className="mapboxgl-ctrl-geocoder mapboxgl-ctrl";var i=this.createIcon("search",'<path d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z"/>');this._inputEl=document.createElement("input"),this._inputEl.type="text",this._inputEl.className="mapboxgl-ctrl-geocoder--input",this.setPlaceholder(),this.options.collapsed&&(this._collapse(),this.container.addEventListener("mouseenter",this._unCollapse),this.container.addEventListener("mouseleave",this._collapse),this._inputEl.addEventListener("focus",this._unCollapse)),(this.options.collapsed||this.options.clearOnBlur)&&this._inputEl.addEventListener("blur",this._onBlur),this._inputEl.addEventListener("keydown",gie(this._onKeyDown,200)),this._inputEl.addEventListener("paste",this._onPaste),this._inputEl.addEventListener("change",this._onChange),this.container.addEventListener("mouseenter",this._showButton),this.container.addEventListener("mouseleave",this._hideButton),this._inputEl.addEventListener("keyup",(function(A){this.eventManager.keyevent(A,this)}).bind(this));var s=document.createElement("div");s.classList.add("mapboxgl-ctrl-geocoder--pin-right"),this._clearEl=document.createElement("button"),this._clearEl.setAttribute("aria-label","Clear"),this._clearEl.addEventListener("click",this.clear),this._clearEl.className="mapboxgl-ctrl-geocoder--button";var c=this.createIcon("close",'<path d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z"/>');if(this._clearEl.appendChild(c),this._loadingEl=this.createIcon("loading",'<path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"/><path opacity=".1" d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z"/>'),s.appendChild(this._clearEl),s.appendChild(this._loadingEl),e.appendChild(i),e.appendChild(this._inputEl),e.appendChild(s),this.options.enableGeolocation&&this.geolocation.isSupport()){this._geolocateEl=document.createElement("button"),this._geolocateEl.setAttribute("aria-label","Geolocate"),this._geolocateEl.addEventListener("click",this._geolocateUser),this._geolocateEl.className="mapboxgl-ctrl-geocoder--button";var h=this.createIcon("geolocate",'<path d="M12.999 3.677L2.042 8.269c-.962.403-.747 1.823.29 1.912l5.032.431.431 5.033c.089 1.037 1.509 1.252 1.912.29l4.592-10.957c.345-.822-.477-1.644-1.299-1.299z" fill="#4264fb"/>');this._geolocateEl.appendChild(h),s.appendChild(this._geolocateEl),this._showGeolocateButton()}var p=this._typeahead=new _ie(this._inputEl,[],{filter:!1,minLength:this.options.minLength,limit:this.options.limit});this.setRenderFunction(this.options.render),p.getItemValue=this.options.getItemValue;var v=p.list.draw,l=this._footerNode=Tie();return p.list.draw=function(){v.call(this),l.addEventListener("mousedown",(function(){this.selectingListItem=!0}).bind(this)),l.addEventListener("mouseup",(function(){this.selectingListItem=!1}).bind(this)),this.element.appendChild(l)},this.mapMarker=null,this._handleMarker=this._handleMarker.bind(this),this._map&&(this.options.trackProximity&&(this._updateProximity(),this._map.on("moveend",this._updateProximity)),this._mapboxgl=this.options.mapboxgl,!this._mapboxgl&&this.options.marker&&(console.error("No mapboxgl detected in options. Map markers are disabled. Please set options.mapboxgl."),this.options.marker=!1)),e},_geolocateUser:function(){this._hideGeolocateButton(),this._showLoadingIcon(),this.geolocation.getCurrentPosition().then((function(t){this._hideLoadingIcon();const e={geometry:{type:"Point",coordinates:[t.coords.longitude,t.coords.latitude]}};this._handleMarker(e),this._fly(e),this._typeahead.clear(),this._typeahead.selected=!0,this.lastSelected=JSON.stringify(e),this._showClearButton(),this.fresh=!1;const i={limit:1,language:[this.options.language],query:e.geometry.coordinates,types:["address"]};if(this.options.localGeocoderOnly){const s=e.geometry.coordinates[0]+","+e.geometry.coordinates[1];this._setInputValue(s),this._eventEmitter.emit("result",{result:e})}else this.geocoderService.reverseGeocode(i).send().then((function(s){const c=s.body.features[0];if(c){const h=RO.transformFeatureToGeolocationText(c,this.options.addressAccuracy);this._setInputValue(h),c.user_coordinates=e.geometry.coordinates,this._eventEmitter.emit("result",{result:c})}else this._eventEmitter.emit("result",{result:{user_coordinates:e.geometry.coordinates}})}).bind(this))}).bind(this)).catch((function(t){t.code===1?this._renderUserDeniedGeolocationError():this._renderLocationError(),this._hideLoadingIcon(),this._showGeolocateButton(),this._hideAttribution()}).bind(this))},createIcon:function(t,e){var i=document.createElementNS("http://www.w3.org/2000/svg","svg");return i.setAttribute("class","mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-"+t),i.setAttribute("viewBox","0 0 18 18"),i.setAttribute("xml:space","preserve"),i.setAttribute("width",18),i.setAttribute("height",18),i.innerHTML=e,i},onRemove:function(){return this.container.parentNode.removeChild(this.container),this.options.trackProximity&&this._map&&this._map.off("moveend",this._updateProximity),this._removeMarker(),this._map=null,this},_setInputValue:function(t){this._inputEl.value=t,setTimeout((function(){this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0)}).bind(this),1)},_onPaste:function(t){var e=(t.clipboardData||window.clipboardData).getData("text");e.length>=this.options.minLength&&this._geocode(e)},_onKeyDown:function(t){var e=27,i=9;if(t.keyCode===e&&this.options.clearAndBlurOnEsc)return this._clear(t),this._inputEl.blur();var s=t.target&&t.target.shadowRoot?t.target.shadowRoot.activeElement:t.target,c=s?s.value:"";if(!c)return this.fresh=!0,t.keyCode!==i&&this.clear(t),this._showGeolocateButton(),this._hideClearButton();this._hideGeolocateButton(),!(t.metaKey||[i,e,37,39,13,38,40].indexOf(t.keyCode)!==-1)&&s.value.length>=this.options.minLength&&this._geocode(s.value)},_showButton:function(){this._typeahead.selected&&this._showClearButton()},_hideButton:function(){this._typeahead.selected&&this._hideClearButton()},_showClearButton:function(){this._clearEl.style.display="block"},_hideClearButton:function(){this._clearEl.style.display="none"},_showGeolocateButton:function(){this._geolocateEl&&this.geolocation.isSupport()&&(this._geolocateEl.style.display="block")},_hideGeolocateButton:function(){this._geolocateEl&&(this._geolocateEl.style.display="none")},_showLoadingIcon:function(){this._loadingEl.style.display="block"},_hideLoadingIcon:function(){this._loadingEl.style.display="none"},_showAttribution:function(){this._footerNode.style.display="block"},_hideAttribution:function(){this._footerNode.style.display="none"},_onBlur:function(t){this.options.clearOnBlur&&this._clearOnBlur(t),this.options.collapsed&&this._collapse()},_onChange:function(){var t=this._typeahead.selected;t&&JSON.stringify(t)!==this.lastSelected&&(this._hideClearButton(),this.options.flyTo&&this._fly(t),this.options.marker&&this._mapboxgl&&this._handleMarker(t),this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0),this.lastSelected=JSON.stringify(t),this._eventEmitter.emit("result",{result:t}),this.eventManager.select(t,this))},_fly:function(t){var e;if(t.properties&&IO[t.properties.short_code])e=Ju({},this.options.flyTo),this._map&&this._map.fitBounds(IO[t.properties.short_code].bbox,e);else if(t.bbox){var i=t.bbox;e=Ju({},this.options.flyTo),this._map&&this._map.fitBounds([[i[0],i[1]],[i[2],i[3]]],e)}else{var s={zoom:this.options.zoom};e=Ju({},s,this.options.flyTo),t.center?e.center=t.center:t.geometry&&t.geometry.type&&t.geometry.type==="Point"&&t.geometry.coordinates&&(e.center=t.geometry.coordinates),this._map&&this._map.flyTo(e)}},_requestType:function(t,e){var i;return t.localGeocoderOnly?i=Sc.LOCAL:t.reverseGeocode&&RO.REVERSE_GEOCODE_COORD_RGX.test(e)?i=Sc.REVERSE:i=Sc.FORWARD,i},_setupConfig:function(t,e){const i=["bbox","limit","proximity","countries","types","language","reverseMode","mode","autocomplete","fuzzyMatch","routing","worldview"],s=/[\s,]+/;var c=this,h=i.reduce(function(v,l){if(c.options[l]===void 0||c.options[l]===null)return v;["countries","types","language"].indexOf(l)>-1?v[l]=c.options[l].split(s):v[l]=c.options[l];const A=typeof c.options[l].longitude=="number"&&typeof c.options[l].latitude=="number";if(l==="proximity"&&A){const P=c.options[l].longitude,O=c.options[l].latitude;v[l]=[P,O]}return v},{});switch(t){case Sc.REVERSE:{var p=e.split(s).map(function(v){return parseFloat(v,10)});c.options.flipCoordinates||p.reverse(),h.types&&h.types[0],h=Ju(h,{query:p,limit:1}),["proximity","autocomplete","fuzzyMatch","bbox"].forEach(function(v){v in h&&delete h[v]})}break;case Sc.FORWARD:{const v=e.trim();/^(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)?$/.test(v)&&(e=e.replace(/,/g," ")),h=Ju(h,{query:e})}break}return h},_geocode:function(t){this.inputString=t,this._showLoadingIcon(),this._eventEmitter.emit("loading",{query:t});const e=this._requestType(this.options,t),i=this._setupConfig(e,t);var s;switch(e){case Sc.LOCAL:s=Promise.resolve();break;case Sc.FORWARD:s=this.geocoderService.forwardGeocode(i).send();break;case Sc.REVERSE:s=this.geocoderService.reverseGeocode(i).send();break}var c=this.options.localGeocoder?this.options.localGeocoder(t)||[]:[],h=[],p=null;return s.catch((function(v){p=v}).bind(this)).then((function(v){this._hideLoadingIcon();var l={};return v?v.statusCode=="200"&&(l=v.body,l.request=v.request,l.headers=v.headers):l={type:"FeatureCollection",features:[]},l.config=i,this.fresh&&(this.eventManager.start(this),this.fresh=!1),l.features=l.features?c.concat(l.features):c,this.options.externalGeocoder?(h=this.options.externalGeocoder(t,l.features)||Promise.resolve([]),h.then(function(A){return l.features=l.features?A.concat(l.features):A,l},function(){return l})):l}).bind(this)).then((function(v){if(p)throw p;this.options.filter&&v.features.length&&(v.features=v.features.filter(this.options.filter)),v.features.length?(this._showClearButton(),this._hideGeolocateButton(),this._showAttribution(),this._eventEmitter.emit("results",v),this._typeahead.update(v.features)):(this._hideClearButton(),this._hideAttribution(),this._typeahead.selected=null,this._renderNoResults(),this._eventEmitter.emit("results",v))}).bind(this)).catch((function(v){this._hideLoadingIcon(),this._hideAttribution(),c.length&&this.options.localGeocoder||h.length&&this.options.externalGeocoder?(this._showClearButton(),this._hideGeolocateButton(),this._typeahead.update(c)):(this._hideClearButton(),this._typeahead.selected=null,this._renderError()),this._eventEmitter.emit("results",{features:c}),this._eventEmitter.emit("error",{error:v})}).bind(this)),s},_clear:function(t){t&&t.preventDefault(),this._inputEl.value="",this._typeahead.selected=null,this._typeahead.clear(),this._onChange(),this._hideClearButton(),this._showGeolocateButton(),this._removeMarker(),this.lastSelected=null,this._eventEmitter.emit("clear"),this.fresh=!0},clear:function(t){this._clear(t),this._inputEl.focus()},_clearOnBlur:function(t){var e=this;t.relatedTarget&&e._clear(t)},_onQueryResult:function(t){var e=t.body;if(e.features.length){var i=e.features[0];this._typeahead.selected=i,this._inputEl.value=i.place_name,this._onChange()}},_updateProximity:function(){if(!(!this._map||!this.options.trackProximity))if(this._map.getZoom()>9){var t=this._map.getCenter().wrap();this.setProximity({longitude:t.lng,latitude:t.lat},!1)}else this.setProximity(null,!1)},_collapse:function(){!this._inputEl.value&&this._inputEl!==document.activeElement&&this.container.classList.add("mapboxgl-ctrl-geocoder--collapsed")},_unCollapse:function(){this.container.classList.remove("mapboxgl-ctrl-geocoder--collapsed")},query:function(t){return this._geocode(t).then(this._onQueryResult),this},_renderError:function(){var t="<div class='mapbox-gl-geocoder--error'>There was an error reaching the server</div>";this._renderMessage(t)},_renderLocationError:function(){var t="<div class='mapbox-gl-geocoder--error'>A location error has occurred</div>";this._renderMessage(t)},_renderNoResults:function(){var t="<div class='mapbox-gl-geocoder--error mapbox-gl-geocoder--no-results'>No results found</div>";this._renderMessage(t)},_renderUserDeniedGeolocationError:function(){var t="<div class='mapbox-gl-geocoder--error'>Geolocation permission denied</div>";this._renderMessage(t)},_renderMessage:function(t){this._typeahead.update([]),this._typeahead.selected=null,this._typeahead.clear(),this._typeahead.renderError(t)},_getPlaceholderText:function(){if(this.options.placeholder)return this.options.placeholder;if(this.options.language){var t=this.options.language.split(",")[0],e=bie.language(t),i=xie.placeholder[e];if(i)return i}return"Search"},setInput:function(t,e){return e===void 0&&(e=!1),this._inputEl.value=t,this._typeahead.selected=null,this._typeahead.clear(),t.length>=this.options.minLength&&(e?this._geocode(t):this._onChange()),this},setProximity:function(t,e=!0){return this.options.proximity=t,e&&(this.options.trackProximity=!1),this},getProximity:function(){return this.options.proximity},setRenderFunction:function(t){return t&&typeof t=="function"&&(this._typeahead.render=t),this},getRenderFunction:function(){return this._typeahead.render},setLanguage:function(t){var e=navigator.language||navigator.userLanguage||navigator.browserLanguage;return this.options.language=t||this.options.language||e,this},getLanguage:function(){return this.options.language},getZoom:function(){return this.options.zoom},setZoom:function(t){return this.options.zoom=t,this},getFlyTo:function(){return this.options.flyTo},setFlyTo:function(t){return this.options.flyTo=t,this},getPlaceholder:function(){return this.options.placeholder},setPlaceholder:function(t){return this.options.placeholder=t||this._getPlaceholderText(),this._inputEl.placeholder=this.options.placeholder,this._inputEl.setAttribute("aria-label",this.options.placeholder),this},getBbox:function(){return this.options.bbox},setBbox:function(t){return this.options.bbox=t,this},getCountries:function(){return this.options.countries},setCountries:function(t){return this.options.countries=t,this},getTypes:function(){return this.options.types},setTypes:function(t){return this.options.types=t,this},getMinLength:function(){return this.options.minLength},setMinLength:function(t){return this.options.minLength=t,this._typeahead&&(this._typeahead.options.minLength=t),this},getLimit:function(){return this.options.limit},setLimit:function(t){return this.options.limit=t,this._typeahead&&(this._typeahead.options.limit=t),this},getFilter:function(){return this.options.filter},setFilter:function(t){return this.options.filter=t,this},setOrigin:function(t){return this.options.origin=t,this.geocoderService=gw(_w({accessToken:this.options.accessToken,origin:this.options.origin})),this},getOrigin:function(){return this.options.origin},setAccessToken:function(t){return this.options.accessToken=t,this.geocoderService=gw(_w({accessToken:this.options.accessToken,origin:this.options.origin})),this},setAutocomplete:function(t){return this.options.autocomplete=t,this},getAutocomplete:function(){return this.options.autocomplete},setFuzzyMatch:function(t){return this.options.fuzzyMatch=t,this},getFuzzyMatch:function(){return this.options.fuzzyMatch},setRouting:function(t){return this.options.routing=t,this},getRouting:function(){return this.options.routing},setWorldview:function(t){return this.options.worldview=t,this},getWorldview:function(){return this.options.worldview},_handleMarker:function(t){if(this._map){this._removeMarker();var e={color:"#4668F2"},i=Ju({},e,this.options.marker);return this.mapMarker=new this._mapboxgl.Marker(i),t.center?this.mapMarker.setLngLat(t.center).addTo(this._map):t.geometry&&t.geometry.type&&t.geometry.type==="Point"&&t.geometry.coordinates&&this.mapMarker.setLngLat(t.geometry.coordinates).addTo(this._map),this}},_removeMarker:function(){this.mapMarker&&(this.mapMarker.remove(),this.mapMarker=null)},on:function(t,e){return this._eventEmitter.on(t,e),this},off:function(t,e){return this._eventEmitter.removeListener(t,e),this.eventManager.remove(),this}};var Eie=uF;const Sie=i1(Eie);function OO(t,e,i){const s=t.slice();return s[126]=e[i],s}function kO(t,e,i){const s=t.slice();return s[129]=e[i],s[131]=i,s}function DO(t){let e,i,s="Close",c,h,p,v="↗️ Google Maps",l,A,P,O,L,U,H,Y=t[2]&&!t[10]&&LO(t),J=(!t[2]||t[10])&&NO(t);return{c(){e=Vt("div"),i=Vt("button"),i.textContent=s,c=or(),h=Vt("a"),p=Vt("button"),p.textContent=v,A=or(),Y&&Y.c(),P=or(),J&&J.c(),this.h()},l(oe){e=jt(oe,"DIV",{class:!0});var me=$i(e);i=jt(me,"BUTTON",{class:!0,"data-svelte-h":!0}),rn(i)!=="svelte-ylojzz"&&(i.textContent=s),c=ar(me),h=jt(me,"A",{target:!0,href:!0});var pe=$i(h);p=jt(pe,"BUTTON",{class:!0,"data-svelte-h":!0}),rn(p)!=="svelte-1du5rck"&&(p.textContent=v),pe.forEach(bt),A=ar(me),Y&&Y.l(me),P=ar(me),J&&J.l(me),me.forEach(bt),this.h()},h(){tt(i,"class","three-d-close svelte-7y73op"),tt(p,"class","maps-link svelte-7y73op"),tt(h,"target","_blank"),tt(h,"href",l="http://maps.google.com/maps?q="+t[24][1]+","+t[24][0]),tt(e,"class","three-d svelte-7y73op"),Wo(e,"show3D",t[10])},m(oe,me){Zi(oe,e,me),Et(e,i),Et(e,c),Et(e,h),Et(h,p),Et(e,A),Y&&Y.m(e,null),Et(e,P),J&&J.m(e,null),L=!0,U||(H=Ss(i,"click",t[47]),U=!0)},p(oe,me){(!L||me[0]&16777216&&l!==(l="http://maps.google.com/maps?q="+oe[24][1]+","+oe[24][0]))&&tt(h,"href",l),oe[2]&&!oe[10]?Y?Y.p(oe,me):(Y=LO(oe),Y.c(),Y.m(e,P)):Y&&(Y.d(1),Y=null),!oe[2]||oe[10]?J?(J.p(oe,me),me[0]&1028&&yr(J,1)):(J=NO(oe),J.c(),yr(J,1),J.m(e,null)):J&&(Fo(),Kr(J,1,1,()=>{J=null}),Bo()),(!L||me[0]&1024)&&Wo(e,"show3D",oe[10])},i(oe){L||(yr(J),oe&&(O||Gc(()=>{O=QT(e,sl,{y:-20,duration:500}),O.start()})),L=!0)},o(oe){Kr(J),L=!1},d(oe){oe&&bt(e),Y&&Y.d(),J&&J.d(),U=!1,H()}}}function LO(t){let e,i="Show 3D (experimental)",s,c;return{c(){e=Vt("button"),e.textContent=i,this.h()},l(h){e=jt(h,"BUTTON",{class:!0,"data-svelte-h":!0}),rn(e)!=="svelte-1gimkf0"&&(e.textContent=i),this.h()},h(){tt(e,"class","show-3d-link maps-link svelte-7y73op")},m(h,p){Zi(h,e,p),s||(c=Ss(e,"click",t[48]),s=!0)},p:Es,d(h){h&&bt(e),s=!1,c()}}}function NO(t){let e,i="Explore by Pan and Zooming",s,c,h;return c=new LJ({props:{coords:t[24]}}),{c(){e=Vt("p"),e.textContent=i,s=or(),mh(c.$$.fragment),this.h()},l(p){e=jt(p,"P",{class:!0,"data-svelte-h":!0}),rn(e)!=="svelte-w0hcp3"&&(e.textContent=i),s=ar(p),_h(c.$$.fragment,p),this.h()},h(){tt(e,"class","instructions svelte-7y73op")},m(p,v){Zi(p,e,v),Zi(p,s,v),gh(c,p,v),h=!0},p(p,v){const l={};v[0]&16777216&&(l.coords=p[24]),c.$set(l)},i(p){h||(yr(c.$$.fragment,p),h=!0)},o(p){Kr(c.$$.fragment,p),h=!1},d(p){p&&(bt(e),bt(s)),yh(c,p)}}}function FO(t){let e,i,s,c,h=t[27]&&t[20]&&BO(t),p=t[26]&&zO(t),v=t[28]&&VO(t);return{c(){e=Vt("div"),h&&h.c(),i=or(),p&&p.c(),s=or(),v&&v.c(),this.h()},l(l){e=jt(l,"DIV",{class:!0,style:!0});var A=$i(e);h&&h.l(A),i=ar(A),p&&p.l(A),s=ar(A),v&&v.l(A),A.forEach(bt),this.h()},h(){tt(e,"class","loading-overlay svelte-7y73op"),An(e,"display",(t[23],""))},m(l,A){Zi(l,e,A),h&&h.m(e,null),Et(e,i),p&&p.m(e,null),Et(e,s),v&&v.m(e,null),c=!0},p(l,A){l[27]&&l[20]?h?(h.p(l,A),A[0]&135266304&&yr(h,1)):(h=BO(l),h.c(),yr(h,1),h.m(e,i)):h&&(Fo(),Kr(h,1,1,()=>{h=null}),Bo()),l[26]?p?(p.p(l,A),A[0]&67108864&&yr(p,1)):(p=zO(l),p.c(),yr(p,1),p.m(e,s)):p&&(Fo(),Kr(p,1,1,()=>{p=null}),Bo()),l[28]?v?(v.p(l,A),A[0]&268435456&&yr(v,1)):(v=VO(l),v.c(),yr(v,1),v.m(e,null)):v&&(Fo(),Kr(v,1,1,()=>{v=null}),Bo()),(!c||A[0]&8388608)&&An(e,"display",(l[23],""))},i(l){c||(yr(h),yr(p),yr(v),c=!0)},o(l){Kr(h),Kr(p),Kr(v),c=!1},d(l){l&&bt(e),h&&h.d(),p&&p.d(),v&&v.d()}}}function BO(t){let e,i,s;return i=new EJ({props:{sizes:t[19],geoJSON:t[27],courtData:t[20],viewportHeight:t[0],viewportWidth:t[1]}}),i.$on("finished",t[45]),{c(){e=Vt("div"),mh(i.$$.fragment),this.h()},l(c){e=jt(c,"DIV",{class:!0});var h=$i(e);_h(i.$$.fragment,h),h.forEach(bt),this.h()},h(){tt(e,"class","world-map svelte-7y73op")},m(c,h){Zi(c,e,h),gh(i,e,null),s=!0},p(c,h){const p={};h[0]&524288&&(p.sizes=c[19]),h[0]&134217728&&(p.geoJSON=c[27]),h[0]&1048576&&(p.courtData=c[20]),h[0]&1&&(p.viewportHeight=c[0]),h[0]&2&&(p.viewportWidth=c[1]),i.$set(p)},i(c){s||(yr(i.$$.fragment,c),s=!0)},o(c){Kr(i.$$.fragment,c),s=!1},d(c){c&&bt(e),yh(i)}}}function zO(t){let e,i,s,c=!t[28]&&UO(t);return{c(){e=Vt("div"),c&&c.c(),this.h()},l(h){e=jt(h,"DIV",{class:!0});var p=$i(e);c&&c.l(p),p.forEach(bt),this.h()},h(){tt(e,"class","loading-text loading-start svelte-7y73op")},m(h,p){Zi(h,e,p),c&&c.m(e,null),s=!0},p(h,p){h[28]?c&&(Fo(),Kr(c,1,1,()=>{c=null}),Bo()):c?(c.p(h,p),p[0]&268435456&&yr(c,1)):(c=UO(h),c.c(),yr(c,1),c.m(e,null))},i(h){s||(yr(c),h&&Gc(()=>{s&&(i||(i=nl(e,sl,{y:20,duration:1e3,delay:500},!0)),i.run(1))}),s=!0)},o(h){Kr(c),h&&(i||(i=nl(e,sl,{y:20,duration:1e3,delay:500},!1)),i.run(0)),s=!1},d(h){h&&bt(e),c&&c.d(),h&&i&&i.end()}}}function UO(t){var O,L;let e,i,s=t[36](Math.round(t[34]*((O=t[20])==null?void 0:O.length)/100)*100)+"",c,h,p=t[36]((L=t[20])==null?void 0:L.length)+"",v,l,A,P;return{c(){e=Vt("p"),i=so("Loading Satellite Imagery of "),c=so(s),h=so(" of "),v=so(p),l=so(" Basketball Courts"),this.h()},l(U){e=jt(U,"P",{class:!0});var H=$i(e);i=oo(H,"Loading Satellite Imagery of "),c=oo(H,s),h=oo(H," of "),v=oo(H,p),l=oo(H," Basketball Courts"),H.forEach(bt),this.h()},h(){tt(e,"class","every every-start svelte-7y73op")},m(U,H){Zi(U,e,H),Et(e,i),Et(e,c),Et(e,h),Et(e,v),Et(e,l),P=!0},p(U,H){var Y,J;(!P||H[0]&1048576|H[1]&8)&&s!==(s=U[36](Math.round(U[34]*((Y=U[20])==null?void 0:Y.length)/100)*100)+"")&&Uc(c,s),(!P||H[0]&1048576)&&p!==(p=U[36]((J=U[20])==null?void 0:J.length)+"")&&Uc(v,p)},i(U){P||(U&&Gc(()=>{P&&(A||(A=nl(e,sl,{y:20,duration:1e3,delay:0},!0)),A.run(1))}),P=!0)},o(U){U&&(A||(A=nl(e,sl,{y:20,duration:1e3,delay:0},!1)),A.run(0)),P=!1},d(U){U&&bt(e),U&&A&&A.end()}}}function VO(t){let e,i,s,c,h,p,v='<span class="svelte-7y73op">Every Outdoor Basketball Court in the U.S.A.</span>',l,A,P='<span class="svelte-7y73op">Help us document the stories behind the 59,507 outdoor courts in America.</span>',O,L,U;function H(oe,me){return oe[12]?Aie:Mie}let Y=H(t),J=Y(t);return{c(){e=Vt("div"),i=Vt("div"),s=Vt("a"),c=new ak(!1),h=or(),p=Vt("p"),p.innerHTML=v,l=or(),A=Vt("p"),A.innerHTML=P,O=or(),J.c(),this.h()},l(oe){e=jt(oe,"DIV",{class:!0});var me=$i(e);i=jt(me,"DIV",{class:!0});var pe=$i(i);s=jt(pe,"A",{href:!0,target:!0,class:!0});var be=$i(s);c=lk(be,!1),be.forEach(bt),pe.forEach(bt),h=ar(me),p=jt(me,"P",{class:!0,"data-svelte-h":!0}),rn(p)!=="svelte-1x853zu"&&(p.innerHTML=v),l=ar(me),A=jt(me,"P",{class:!0,"data-svelte-h":!0}),rn(A)!=="svelte-brmps9"&&(A.innerHTML=P),O=ar(me),J.l(me),me.forEach(bt),this.h()},h(){c.a=null,tt(s,"href","https://pudding.cool"),tt(s,"target","_blank"),tt(s,"class","svelte-7y73op"),tt(i,"class","logo svelte-7y73op"),tt(p,"class","every svelte-7y73op"),tt(A,"class","every every-small svelte-7y73op"),tt(e,"class","loading-text svelte-7y73op")},m(oe,me){Zi(oe,e,me),Et(e,i),Et(i,s),c.m(fN,s),Et(e,h),Et(e,p),Et(e,l),Et(e,A),Et(e,O),J.m(e,null),U=!0},p(oe,me){Y===(Y=H(oe))&&J?J.p(oe,me):(J.d(1),J=Y(oe),J&&(J.c(),J.m(e,null)))},i(oe){U||(oe&&Gc(()=>{U&&(L||(L=nl(e,sl,{y:20,duration:1e3,delay:500},!0)),L.run(1))}),U=!0)},o(oe){oe&&(L||(L=nl(e,sl,{y:20,duration:1e3,delay:500},!1)),L.run(0)),U=!1},d(oe){oe&&bt(e),J.d(),oe&&L&&L.end()}}}function Aie(t){let e,i,s="Begin Exploring",c,h;return{c(){e=Vt("div"),i=Vt("button"),i.textContent=s,this.h()},l(p){e=jt(p,"DIV",{class:!0});var v=$i(e);i=jt(v,"BUTTON",{class:!0,"data-svelte-h":!0}),rn(i)!=="svelte-1ibfhhu"&&(i.textContent=s),v.forEach(bt),this.h()},h(){tt(i,"class","start-button svelte-7y73op"),tt(e,"class","start-button-container")},m(p,v){Zi(p,e,v),Et(e,i),c||(h=Ss(i,"click",t[49]),c=!0)},p:Es,d(p){p&&bt(e),c=!1,h()}}}function Mie(t){let e,i='<span class="svelte-7y73op">Still loading...</span>';return{c(){e=Vt("p"),e.innerHTML=i,this.h()},l(s){e=jt(s,"P",{class:!0,"data-svelte-h":!0}),rn(e)!=="svelte-cs25od"&&(e.innerHTML=i),this.h()},h(){tt(e,"class","every every-small svelte-7y73op")},m(s,c){Zi(s,e,c)},p:Es,d(s){s&&bt(e)}}}function jO(t){let e,i,s='<span class="svelte-7y73op">Loading...</span>',c,h,p;return{c(){e=Vt("div"),i=Vt("p"),i.innerHTML=s,this.h()},l(v){e=jt(v,"DIV",{class:!0});var l=$i(e);i=jt(l,"P",{class:!0,"data-svelte-h":!0}),rn(i)!=="svelte-19ao4sv"&&(i.innerHTML=s),l.forEach(bt),this.h()},h(){tt(i,"class","every every-small svelte-7y73op"),tt(e,"class",c="waiting "+(t[9]>10&&t[11]?"shift-up":"")+" svelte-7y73op"),Wo(e,"mapBoxVisible",t[11])},m(v,l){Zi(v,e,l),Et(e,i),p=!0},p(v,l){(!p||l[0]&2560&&c!==(c="waiting "+(v[9]>10&&v[11]?"shift-up":"")+" svelte-7y73op"))&&tt(e,"class",c),(!p||l[0]&2560)&&Wo(e,"mapBoxVisible",v[11])},i(v){p||(v&&Gc(()=>{p&&(h||(h=nl(e,xv,{duration:500},!0)),h.run(1))}),p=!0)},o(v){v&&(h||(h=nl(e,xv,{duration:500},!1)),h.run(0)),p=!1},d(v){v&&bt(e),v&&h&&h.end()}}}function $O(t){let e,i;return e=new Mee({props:{commentId:t[21]}}),e.$on("formSubmit",t[38]),{c(){mh(e.$$.fragment)},l(s){_h(e.$$.fragment,s)},m(s,c){gh(e,s,c),i=!0},p(s,c){const h={};c[0]&2097152&&(h.commentId=s[21]),e.$set(h)},i(s){i||(yr(e.$$.fragment,s),i=!0)},o(s){Kr(e.$$.fragment,s),i=!1},d(s){yh(e,s)}}}function WO(t){let e,i;return e=new RJ({}),{c(){mh(e.$$.fragment)},l(s){_h(e.$$.fragment,s)},m(s,c){gh(e,s,c),i=!0},i(s){i||(yr(e.$$.fragment,s),i=!0)},o(s){Kr(e.$$.fragment,s),i=!1},d(s){yh(e,s)}}}function HO(t){let e,i='<p class="svelte-7y73op">Zoom-in to Explore, like a Map!</p> <div class="finger svelte-7y73op"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 76 114"><path fill="#fff" d="M75 67v16c0 6-2 12-6 16-2 3-4 7-4 10v3a1 1 0 0 1-1 2 1 1 0 0 1-2-1v-4c0-4 2-8 5-12s5-9 5-14V67a4 4 0 0 0-1-3 3 3 0 0 0-4 0 4 4 0 0 0-2 3 1 1 0 1 1-3 0v-5a3 3 0 0 0-3-4 3 3 0 0 0-4 4v5a1 1 0 1 1-3 0v-5a3 3 0 0 0-2-3 4 4 0 0 0-4 0 3 3 0 0 0-1 3v5a1 1 0 1 1-3 0V35a4 4 0 0 0-4-4 4 4 0 0 0-4 4v42a1 1 0 1 1-3 0V66a4 4 0 0 0-4 4v13c0 5 2 10 5 14s5 8 5 12v4a2 2 0 0 1-2 1 2 2 0 0 1-1-2v-3c0-3-2-7-4-10-4-4-6-10-6-16V70a7 7 0 0 1 7-7V35a7 7 0 0 1 7-7 7 7 0 0 1 7 7v21a7 7 0 0 1 7 0l2 2a7 7 0 0 1 5-3 6 6 0 0 1 6 6h1a6 6 0 0 1 9 6ZM27 47a2 2 0 0 0 1-3 14 14 0 1 1 20 0 1 1 0 1 0 2 3 17 17 0 1 0-24 0h1ZM17 33H5l2-2a2 2 0 0 0-2-2l-4 5a1 1 0 0 0 0 2l4 5a2 2 0 0 0 2-3l-2-2h12a2 2 0 0 0 0-3Zm58 1-4-5a1 1 0 0 0-2 2l2 2H60a2 2 0 0 0 0 3h11l-2 2a1 1 0 1 0 2 3l4-5a1 1 0 0 0 0-2ZM40 5v10a1 1 0 1 1-3 0V5l-2 2a1 1 0 0 1-3-2l5-5a2 2 0 0 1 2 0l5 5a1 1 0 0 1-2 2l-2-2Z"></path></svg></div>',s,c,h;return{c(){e=Vt("div"),e.innerHTML=i,this.h()},l(p){e=jt(p,"DIV",{class:!0,"data-svelte-h":!0}),rn(e)!=="svelte-bk9v5p"&&(e.innerHTML=i),this.h()},h(){tt(e,"class","helper svelte-7y73op")},m(p,v){Zi(p,e,v),h=!0},i(p){h||(p&&Gc(()=>{h&&(c&&c.end(1),s=QT(e,xv,{delay:1e3,duration:2e3}),s.start())}),h=!0)},o(p){s&&s.invalidate(),p&&(c=Xz(e,xv,{duration:3e3})),h=!1},d(p){p&&bt(e),p&&c&&c.end()}}}function qO(t){let e,i,s=(t[6].length>15?t[6].slice(0,12).concat("..."):t[6])+"",c,h,p,v,l,A,P;return{c(){e=Vt("div"),i=Vt("button"),c=so(s),h=or(),p=e_("svg"),v=e_("path"),l=e_("path"),this.h()},l(O){e=jt(O,"DIV",{class:!0});var L=$i(e);i=jt(L,"BUTTON",{class:!0});var U=$i(i);c=oo(U,s),h=ar(U),p=t_(U,"svg",{xmlns:!0,x:!0,y:!0,viewBox:!0,width:!0,height:!0,"xml:space":!0,class:!0});var H=$i(p);v=t_(H,"path",{d:!0}),$i(v).forEach(bt),l=t_(H,"path",{d:!0}),$i(l).forEach(bt),H.forEach(bt),U.forEach(bt),L.forEach(bt),this.h()},h(){tt(v,"d","M0.5,8C0.37,8,0.24,7.95,0.15,7.85c-0.2-0.2-0.2-0.51,0-0.71l7-7c0.2-0.2,0.51-0.2,0.71,0s0.2,0.51,0,0.71l-7,7 C0.76,7.95,0.63,8,0.5,8z"),tt(l,"d","M7.5,8C7.37,8,7.24,7.95,7.15,7.85l-7-7c-0.2-0.2-0.2-0.51,0-0.71s0.51-0.2,0.71,0l7,7c0.2,0.2,0.2,0.51,0,0.71 C7.76,7.95,7.63,8,7.5,8z"),tt(p,"xmlns","http://www.w3.org/2000/svg"),tt(p,"x","0px"),tt(p,"y","0px"),tt(p,"viewBox","0 0 8 8"),tt(p,"width","8px"),tt(p,"height","8px"),tt(p,"xml:space","preserve"),tt(p,"class","svelte-1x4usti svelte-7y73op"),tt(i,"class","svelte-7y73op"),tt(e,"class","location-queried svelte-7y73op")},m(O,L){Zi(O,e,L),Et(e,i),Et(i,c),Et(i,h),Et(i,p),Et(p,v),Et(p,l),A||(P=Ss(i,"click",t[50]),A=!0)},p(O,L){L[0]&64&&s!==(s=(O[6].length>15?O[6].slice(0,12).concat("..."):O[6])+"")&&Uc(c,s)},d(O){O&&bt(e),A=!1,P()}}}function GO(t){let e,i,s="zoom in",c,h,p="zoom out",v,l;return{c(){e=Vt("div"),i=Vt("button"),i.textContent=s,c=or(),h=Vt("button"),h.textContent=p,this.h()},l(A){e=jt(A,"DIV",{class:!0});var P=$i(e);i=jt(P,"BUTTON",{class:!0,"data-svelte-h":!0}),rn(i)!=="svelte-1d2rxg3"&&(i.textContent=s),c=ar(P),h=jt(P,"BUTTON",{class:!0,"data-svelte-h":!0}),rn(h)!=="svelte-2rqyrx"&&(h.textContent=p),P.forEach(bt),this.h()},h(){tt(i,"class","svelte-7y73op"),tt(h,"class","svelte-7y73op"),tt(e,"class","zoom svelte-7y73op")},m(A,P){Zi(A,e,P),Et(e,i),Et(e,c),Et(e,h),v||(l=[Ss(i,"click",t[52]),Ss(h,"click",t[53])],v=!0)},p:Es,d(A){A&&bt(e),v=!1,L_(l)}}}function XO(t){let e,i,s,c;function h(){return t[54](t[129])}return{c(){e=Vt("button"),this.h()},l(p){e=jt(p,"BUTTON",{class:!0,style:!0});var v=$i(e);v.forEach(bt),this.h()},h(){tt(e,"class",i=u3(t[129]==t[13]?"swatch-selected":"")+" svelte-7y73op"),An(e,"background",t[129]),An(e,"border-top-right-radius",t[131]==t[35].length-1?"5px":""),An(e,"border-bottom-right-radius",t[131]==t[35].length-1?"5px":""),An(e,"border-top-left-radius",t[131]==0?"5px":""),An(e,"border-bottom-left-radius",t[131]==0?"5px":"")},m(p,v){Zi(p,e,v),s||(c=Ss(e,"click",h),s=!0)},p(p,v){t=p,v[0]&8192&&i!==(i=u3(t[129]==t[13]?"swatch-selected":"")+" svelte-7y73op")&&tt(e,"class",i)},d(p){p&&bt(e),s=!1,c()}}}function ZO(t){let e,i,s,c,h,p,v,l,A="About",P,O;return{c(){e=Vt("div"),i=Vt("div"),s=Vt("label"),c=Vt("input"),h=so(" Keyboard Navigation"),p=or(),v=Vt("div"),l=Vt("button"),l.textContent=A,this.h()},l(L){e=jt(L,"DIV",{class:!0});var U=$i(e);i=jt(U,"DIV",{class:!0});var H=$i(i);s=jt(H,"LABEL",{for:!0,class:!0});var Y=$i(s);c=jt(Y,"INPUT",{id:!0,name:!0,type:!0,class:!0}),h=oo(Y," Keyboard Navigation"),Y.forEach(bt),H.forEach(bt),p=ar(U),v=jt(U,"DIV",{class:!0});var J=$i(v);l=jt(J,"BUTTON",{class:!0,"data-svelte-h":!0}),rn(l)!=="svelte-go2gp6"&&(l.textContent=A),J.forEach(bt),U.forEach(bt),this.h()},h(){tt(c,"id","checkbox1"),tt(c,"name","checkbox"),tt(c,"type","checkbox"),tt(c,"class","svelte-7y73op"),tt(s,"for","checkbox1"),tt(s,"class","svelte-7y73op"),tt(i,"class","keyboard-controls svelte-7y73op"),tt(l,"class","svelte-7y73op"),tt(v,"class","about svelte-7y73op"),tt(e,"class","about-keyboard svelte-7y73op")},m(L,U){Zi(L,e,U),Et(e,i),Et(i,s),Et(s,c),c.checked=t[7],Et(s,h),Et(e,p),Et(e,v),Et(v,l),P||(O=[Ss(c,"change",t[57]),Ss(l,"click",t[58])],P=!0)},p(L,U){U[0]&128&&(c.checked=L[7])},d(L){L&&bt(e),P=!1,L_(O)}}}function YO(t){let e,i,s,c;return{c(){e=Vt("div"),i=e_("svg"),s=e_("path"),this.h()},l(h){e=jt(h,"DIV",{class:!0,style:!0});var p=$i(e);i=t_(p,"svg",{viewBox:!0,fill:!0,xmlns:!0,class:!0});var v=$i(i);s=t_(v,"path",{d:!0,fill:!0}),$i(s).forEach(bt),v.forEach(bt),p.forEach(bt),this.h()},h(){tt(s,"d","M108.993 28.105C109.106 33.5843 107.785 38.7298 105.622 43.7363C103.599 48.409 101.013 52.7481 97.7541 56.6698C96.3211 58.3664 94.86 60.0352 93.2865 61.5928C84.9975 69.9091 76.54 78.0586 67.7172 85.8186C64.8512 88.3219 61.9852 90.8251 58.782 92.939C56.5903 94.3853 52.8252 94.3575 50.6335 92.8278C49.5939 92.1046 48.5262 91.3814 47.5708 90.5748C36.4158 81.1459 25.6262 71.2998 15.286 60.9809C9.35732 55.0566 4.97401 48.1865 2.22039 40.2874C0.871683 36.3935 -0.0274579 32.3327 0.000640266 28.2162C0.0568366 18.843 3.51291 10.9995 11.549 5.52015C14.1902 3.71225 17.1124 2.4606 20.0908 1.32024C21.9172 0.652705 23.7998 0.430212 25.7104 0.207701C33.6903 -0.682341 40.8834 1.29246 47.2898 6.04862C49.3129 7.55057 51.2517 9.2194 53.2185 10.8326C53.8367 11.3332 55.2697 11.361 55.8879 10.8882C56.3936 10.4988 56.9275 10.1651 57.4333 9.77566C58.4167 8.96906 59.3158 8.07904 60.2993 7.27243C61.2827 6.46583 62.2942 5.71487 63.362 5.01952C68.5601 1.62624 74.2359 -0.0982711 80.5018 0.0129841C87.8074 0.124239 94.1856 2.62753 99.8053 7.189C103.879 10.471 106.549 14.7265 108.066 19.6774C108.909 22.4309 108.965 25.2679 108.993 28.105Z"),tt(s,"fill","#FF0000"),tt(i,"viewBox","0 0 109 94"),tt(i,"fill","none"),tt(i,"xmlns","http://www.w3.org/2000/svg"),tt(i,"class","svelte-7y73op"),tt(e,"class","heart-popup svelte-7y73op"),An(e,"width",30/Math.pow(2,6-t[3])+10+"px"),An(e,"left",t[29][0]+"px"),An(e,"top",t[29][1]-50+"px")},m(h,p){Zi(h,e,p),Et(e,i),Et(i,s)},p(h,p){p[0]&8&&An(e,"width",30/Math.pow(2,6-h[3])+10+"px"),p[0]&536870912&&An(e,"left",h[29][0]+"px"),p[0]&536870912&&An(e,"top",h[29][1]-50+"px")},i(h){h&&(c||Gc(()=>{c=QT(e,sl,{y:20,duration:5e3}),c.start()}))},o:Es,d(h){h&&bt(e)}}}function KO(t){let e,i="";return{c(){e=Vt("div"),e.innerHTML=i,this.h()},l(s){e=jt(s,"DIV",{class:!0,"data-svelte-h":!0}),rn(e)!=="svelte-18f8tb9"&&(e.innerHTML=i),this.h()},h(){tt(e,"class","search-results svelte-7y73op")},m(s,c){Zi(s,e,c)},d(s){s&&bt(e)}}}function JO(t){let e,i=Vc(t[15]),s=[];for(let c=0;c<i.length;c+=1)s[c]=QO(OO(t,i,c));return{c(){e=Vt("div");for(let c=0;c<s.length;c+=1)s[c].c();this.h()},l(c){e=jt(c,"DIV",{class:!0});var h=$i(e);for(let p=0;p<s.length;p+=1)s[p].l(h);h.forEach(bt),this.h()},h(){tt(e,"class","screen-coords svelte-7y73op")},m(c,h){Zi(c,e,h);for(let p=0;p<s.length;p+=1)s[p]&&s[p].m(e,null)},p(c,h){if(h[0]&32768|h[1]&512){i=Vc(c[15]);let p;for(p=0;p<i.length;p+=1){const v=OO(c,i,p);s[p]?s[p].p(v,h):(s[p]=QO(v),s[p].c(),s[p].m(e,null))}for(;p<s.length;p+=1)s[p].d(1);s.length=i.length}},d(c){c&&bt(e),e1(s,c)}}}function QO(t){let e,i,s="",c,h,p="",v,l,A="",P,O,L;function U(...J){return t[60](t[126],...J)}function H(...J){return t[61](t[126],...J)}function Y(...J){return t[62](t[126],...J)}return{c(){e=Vt("div"),i=Vt("button"),i.innerHTML=s,c=or(),h=Vt("button"),h.innerHTML=p,v=or(),l=Vt("button"),l.innerHTML=A,P=or(),this.h()},l(J){e=jt(J,"DIV",{class:!0,style:!0});var oe=$i(e);i=jt(oe,"BUTTON",{class:!0,"data-svelte-h":!0}),rn(i)!=="svelte-9zpd79"&&(i.innerHTML=s),c=ar(oe),h=jt(oe,"BUTTON",{class:!0,"data-svelte-h":!0}),rn(h)!=="svelte-g6q2an"&&(h.innerHTML=p),v=ar(oe),l=jt(oe,"BUTTON",{class:!0,"data-svelte-h":!0}),rn(l)!=="svelte-t3jczr"&&(l.innerHTML=A),P=ar(oe),oe.forEach(bt),this.h()},h(){tt(i,"class","like svelte-7y73op"),tt(h,"class","comment svelte-7y73op"),tt(l,"class","mag svelte-7y73op"),tt(e,"class","screen-coord svelte-7y73op"),An(e,"left",t[126].screenPosition[0]+"px"),An(e,"top",t[126].screenPosition[1]+"px"),An(e,"width",t[126].screenWidth+"px"),An(e,"height",t[126].screenWidth+"px")},m(J,oe){Zi(J,e,oe),Et(e,i),Et(e,c),Et(e,h),Et(e,v),Et(e,l),Et(e,P),O||(L=[Ss(i,"click",U),Ss(h,"click",H),Ss(l,"click",Y)],O=!0)},p(J,oe){t=J,oe[0]&32768&&An(e,"left",t[126].screenPosition[0]+"px"),oe[0]&32768&&An(e,"top",t[126].screenPosition[1]+"px"),oe[0]&32768&&An(e,"width",t[126].screenWidth+"px"),oe[0]&32768&&An(e,"height",t[126].screenWidth+"px")},d(J){J&&bt(e),O=!1,L_(L)}}}function ek(t){let e,i;return{c(){e=Vt("div"),this.h()},l(s){e=jt(s,"DIV",{class:!0,style:!0});var c=$i(e);c.forEach(bt),this.h()},h(){tt(e,"class",i="noise-overlay mounted "+(t[4]?"hide-overlay":"")+" svelte-7y73op"),An(e,"background","url(assets/noise-light.png)")},m(s,c){Zi(s,e,c)},p(s,c){c[0]&16&&i!==(i="noise-overlay mounted "+(s[4]?"hide-overlay":"")+" svelte-7y73op")&&tt(e,"class",i)},d(s){s&&bt(e)}}}function Cie(t){let e,i,s,c,h,p,v,l,A,P,O,L,U,H,Y,J,oe,me,pe,be="Court Color",Oe,je,st,ut,xe="Sort By",it,Be,Qe,Ct="♡",Kt,Ie,fi="💬",Yi,ri,vr,Gr,Tr,Ar,kr,$r="",Vn,Pn,Si=t[29],Ir,Er,Ki,In,gn,Kn,mr,cn,Dr,yn,Rn,ir=t[32]==!0&&DO(t),Ni=!t[4]&&FO(t),_r=t[14]&&jO(t),Ur=t[33]==!0&&$O(t),Cr=t[31]&&WO(),Oi=t[8]&&HO(),Nr=t[6]&&qO(t),Ke=t[7]&&GO(t),ie=Vc(t[35]),he=[];for(let Se=0;Se<ie.length;Se+=1)he[Se]=XO(kO(t,ie,Se));let Te=t[1]>500&&ZO(t),Xe=YO(t),Je=t[20]&&KO(),lt=t[15].length>0&&t[7]&&JO(t),It=t[22]&&t[1]>500&&ek(t);return{c(){ir&&ir.c(),e=or(),Ni&&Ni.c(),i=or(),_r&&_r.c(),s=or(),c=Vt("div"),Ur&&Ur.c(),h=or(),Cr&&Cr.c(),p=or(),Oi&&Oi.c(),v=or(),l=Vt("div"),A=Vt("div"),P=Vt("a"),O=new ak(!1),L=or(),U=Vt("div"),H=Vt("div"),Nr&&Nr.c(),Y=or(),J=Vt("div"),Ke&&Ke.c(),oe=or(),me=Vt("div"),pe=Vt("span"),pe.textContent=be,Oe=or(),je=Vt("div");for(let Se=0;Se<he.length;Se+=1)he[Se].c();st=or(),ut=Vt("span"),ut.textContent=xe,it=or(),Be=Vt("div"),Qe=Vt("button"),Qe.textContent=Ct,Kt=or(),Ie=Vt("button"),Ie.textContent=fi,Yi=or(),Te&&Te.c(),vr=or(),Gr=Vt("div"),Ar=or(),kr=Vt("div"),kr.innerHTML=$r,Vn=or(),Pn=Vt("div"),Xe.c(),Ir=or(),Er=Vt("p"),Ki=so("Like Added to Court "),In=so(t[17]),gn=or(),Je&&Je.c(),Kn=or(),lt&&lt.c(),mr=or(),It&&It.c(),cn=df(),this.h()},l(Se){ir&&ir.l(Se),e=ar(Se),Ni&&Ni.l(Se),i=ar(Se),_r&&_r.l(Se),s=ar(Se),c=jt(Se,"DIV",{class:!0,id:!0});var ot=$i(c);Ur&&Ur.l(ot),h=ar(ot),Cr&&Cr.l(ot),ot.forEach(bt),p=ar(Se),Oi&&Oi.l(Se),v=ar(Se),l=jt(Se,"DIV",{class:!0});var xt=$i(l);A=jt(xt,"DIV",{class:!0});var $t=$i(A);P=jt($t,"A",{href:!0,target:!0,class:!0});var pi=$i(P);O=lk(pi,!1),pi.forEach(bt),$t.forEach(bt),L=ar(xt),U=jt(xt,"DIV",{class:!0});var Wi=$i(U);H=jt(Wi,"DIV",{id:!0,class:!0});var xr=$i(H);Nr&&Nr.l(xr),xr.forEach(bt),Y=ar(Wi),J=jt(Wi,"DIV",{class:!0});var Hi=$i(J);Ke&&Ke.l(Hi),oe=ar(Hi),me=jt(Hi,"DIV",{class:!0});var Ci=$i(me);pe=jt(Ci,"SPAN",{class:!0,"data-svelte-h":!0}),rn(pe)!=="svelte-1x22fca"&&(pe.textContent=be),Oe=ar(Ci),je=jt(Ci,"DIV",{class:!0});var zi=$i(je);for(let Ln=0;Ln<he.length;Ln+=1)he[Ln].l(zi);zi.forEach(bt),st=ar(Ci),ut=jt(Ci,"SPAN",{class:!0,"data-svelte-h":!0}),rn(ut)!=="svelte-1eada5v"&&(ut.textContent=xe),it=ar(Ci),Be=jt(Ci,"DIV",{class:!0});var er=$i(Be);Qe=jt(er,"BUTTON",{class:!0,"data-svelte-h":!0}),rn(Qe)!=="svelte-1ja0pf5"&&(Qe.textContent=Ct),Kt=ar(er),Ie=jt(er,"BUTTON",{class:!0,"data-svelte-h":!0}),rn(Ie)!=="svelte-69dauq"&&(Ie.textContent=fi),er.forEach(bt),Ci.forEach(bt),Yi=ar(Hi),Te&&Te.l(Hi),Hi.forEach(bt),Wi.forEach(bt),xt.forEach(bt),vr=ar(Se),Gr=jt(Se,"DIV",{class:!0});var Rr=$i(Gr);Rr.forEach(bt),Ar=ar(Se),kr=jt(Se,"DIV",{id:!0,class:!0,"data-svelte-h":!0}),rn(kr)!=="svelte-1l2brqn"&&(kr.innerHTML=$r),Vn=ar(Se),Pn=jt(Se,"DIV",{class:!0});var nn=$i(Pn);Xe.l(nn),Ir=ar(nn),Er=jt(nn,"P",{class:!0});var br=$i(Er);Ki=oo(br,"Like Added to Court "),In=oo(br,t[17]),br.forEach(bt),nn.forEach(bt),gn=ar(Se),Je&&Je.l(Se),Kn=ar(Se),lt&&lt.l(Se),mr=ar(Se),It&&It.l(Se),cn=df(),this.h()},h(){tt(c,"class","overlay svelte-7y73op"),tt(c,"id","overlay"),O.a=null,tt(P,"href","https://pudding.cool"),tt(P,"target","_blank"),tt(P,"class","svelte-7y73op"),tt(A,"class","toolbar-logo svelte-7y73op"),tt(H,"id","geocoder"),tt(H,"class","geocoder svelte-7y73op"),tt(pe,"class","svelte-7y73op"),tt(je,"class","color-swatches svelte-7y73op"),tt(ut,"class","sorted-by svelte-7y73op"),tt(Qe,"class","svelte-7y73op"),tt(Ie,"class","svelte-7y73op"),tt(Be,"class","sort-buttons svelte-7y73op"),tt(me,"class","color-finder svelte-7y73op"),tt(J,"class","bottom svelte-7y73op"),tt(U,"class","settings svelte-7y73op"),tt(l,"class",ri="toolbar "+(t[4]?"toolbar-visible":"")+" svelte-7y73op"),tt(Gr,"class",Tr="el "+(t[9]>10&&t[11]?"showDeck":"")+" "+(t[11]?"shrunk":"")+" svelte-7y73op"),Wo(Gr,"showEl",t[5]),tt(kr,"id","mapbox-map-container"),tt(kr,"class","svelte-7y73op"),Wo(kr,"mapBoxVisible",t[11]),tt(Er,"class","svelte-7y73op"),tt(Pn,"class","favorite-text svelte-7y73op"),Wo(Pn,"favoriteActive",t[25])},m(Se,ot){ir&&ir.m(Se,ot),Zi(Se,e,ot),Ni&&Ni.m(Se,ot),Zi(Se,i,ot),_r&&_r.m(Se,ot),Zi(Se,s,ot),Zi(Se,c,ot),Ur&&Ur.m(c,null),Et(c,h),Cr&&Cr.m(c,null),Zi(Se,p,ot),Oi&&Oi.m(Se,ot),Zi(Se,v,ot),Zi(Se,l,ot),Et(l,A),Et(A,P),O.m(fN,P),Et(l,L),Et(l,U),Et(U,H),Nr&&Nr.m(H,null),t[51](H),Et(U,Y),Et(U,J),Ke&&Ke.m(J,null),Et(J,oe),Et(J,me),Et(me,pe),Et(me,Oe),Et(me,je);for(let xt=0;xt<he.length;xt+=1)he[xt]&&he[xt].m(je,null);Et(me,st),Et(me,ut),Et(me,it),Et(me,Be),Et(Be,Qe),Et(Be,Kt),Et(Be,Ie),Et(J,Yi),Te&&Te.m(J,null),Zi(Se,vr,ot),Zi(Se,Gr,ot),t[59](Gr),Zi(Se,Ar,ot),Zi(Se,kr,ot),Zi(Se,Vn,ot),Zi(Se,Pn,ot),Xe.m(Pn,null),Et(Pn,Ir),Et(Pn,Er),Et(Er,Ki),Et(Er,In),Zi(Se,gn,ot),Je&&Je.m(Se,ot),Zi(Se,Kn,ot),lt&&lt.m(Se,ot),Zi(Se,mr,ot),It&&It.m(Se,ot),Zi(Se,cn,ot),Dr=!0,yn||(Rn=[Ss(Qe,"click",t[55]),Ss(Ie,"click",t[56])],yn=!0)},p(Se,ot){if(Se[32]==!0?ir?(ir.p(Se,ot),ot[1]&2&&yr(ir,1)):(ir=DO(Se),ir.c(),yr(ir,1),ir.m(e.parentNode,e)):ir&&(Fo(),Kr(ir,1,1,()=>{ir=null}),Bo()),Se[4]?Ni&&(Fo(),Kr(Ni,1,1,()=>{Ni=null}),Bo()):Ni?(Ni.p(Se,ot),ot[0]&16&&yr(Ni,1)):(Ni=FO(Se),Ni.c(),yr(Ni,1),Ni.m(i.parentNode,i)),Se[14]?_r?(_r.p(Se,ot),ot[0]&16384&&yr(_r,1)):(_r=jO(Se),_r.c(),yr(_r,1),_r.m(s.parentNode,s)):_r&&(Fo(),Kr(_r,1,1,()=>{_r=null}),Bo()),Se[33]==!0?Ur?(Ur.p(Se,ot),ot[1]&4&&yr(Ur,1)):(Ur=$O(Se),Ur.c(),yr(Ur,1),Ur.m(c,h)):Ur&&(Fo(),Kr(Ur,1,1,()=>{Ur=null}),Bo()),Se[31]?Cr?ot[1]&1&&yr(Cr,1):(Cr=WO(),Cr.c(),yr(Cr,1),Cr.m(c,null)):Cr&&(Fo(),Kr(Cr,1,1,()=>{Cr=null}),Bo()),Se[8]?Oi?ot[0]&256&&yr(Oi,1):(Oi=HO(),Oi.c(),yr(Oi,1),Oi.m(v.parentNode,v)):Oi&&(Fo(),Kr(Oi,1,1,()=>{Oi=null}),Bo()),Se[6]?Nr?Nr.p(Se,ot):(Nr=qO(Se),Nr.c(),Nr.m(H,null)):Nr&&(Nr.d(1),Nr=null),Se[7]?Ke?Ke.p(Se,ot):(Ke=GO(Se),Ke.c(),Ke.m(J,oe)):Ke&&(Ke.d(1),Ke=null),ot[0]&8192|ot[1]&8208){ie=Vc(Se[35]);let xt;for(xt=0;xt<ie.length;xt+=1){const $t=kO(Se,ie,xt);he[xt]?he[xt].p($t,ot):(he[xt]=XO($t),he[xt].c(),he[xt].m(je,null))}for(;xt<he.length;xt+=1)he[xt].d(1);he.length=ie.length}Se[1]>500?Te?Te.p(Se,ot):(Te=ZO(Se),Te.c(),Te.m(J,null)):Te&&(Te.d(1),Te=null),(!Dr||ot[0]&16&&ri!==(ri="toolbar "+(Se[4]?"toolbar-visible":"")+" svelte-7y73op"))&&tt(l,"class",ri),(!Dr||ot[0]&2560&&Tr!==(Tr="el "+(Se[9]>10&&Se[11]?"showDeck":"")+" "+(Se[11]?"shrunk":"")+" svelte-7y73op"))&&tt(Gr,"class",Tr),(!Dr||ot[0]&2592)&&Wo(Gr,"showEl",Se[5]),(!Dr||ot[0]&2048)&&Wo(kr,"mapBoxVisible",Se[11]),ot[0]&536870912&&zl(Si,Si=Se[29])?(Fo(),Kr(Xe,1,1,Es),Bo(),Xe=YO(Se),Xe.c(),yr(Xe,1),Xe.m(Pn,Ir)):Xe.p(Se,ot),(!Dr||ot[0]&131072)&&Uc(In,Se[17]),(!Dr||ot[0]&33554432)&&Wo(Pn,"favoriteActive",Se[25]),Se[20]?Je||(Je=KO(),Je.c(),Je.m(Kn.parentNode,Kn)):Je&&(Je.d(1),Je=null),Se[15].length>0&&Se[7]?lt?lt.p(Se,ot):(lt=JO(Se),lt.c(),lt.m(mr.parentNode,mr)):lt&&(lt.d(1),lt=null),Se[22]&&Se[1]>500?It?It.p(Se,ot):(It=ek(Se),It.c(),It.m(cn.parentNode,cn)):It&&(It.d(1),It=null)},i(Se){Dr||(yr(ir),yr(Ni),yr(_r),yr(Ur),yr(Cr),yr(Oi),yr(Xe),Dr=!0)},o(Se){Kr(ir),Kr(Ni),Kr(_r),Kr(Ur),Kr(Cr),Kr(Oi),Kr(Xe),Dr=!1},d(Se){Se&&(bt(e),bt(i),bt(s),bt(c),bt(p),bt(v),bt(l),bt(vr),bt(Gr),bt(Ar),bt(kr),bt(Vn),bt(Pn),bt(gn),bt(Kn),bt(mr),bt(cn)),ir&&ir.d(Se),Ni&&Ni.d(Se),_r&&_r.d(Se),Ur&&Ur.d(),Cr&&Cr.d(),Oi&&Oi.d(Se),Nr&&Nr.d(),t[51](null),Ke&&Ke.d(),e1(he,Se),Te&&Te.d(),t[59](null),Xe.d(Se),Je&&Je.d(Se),lt&&lt.d(Se),It&&It.d(Se),yn=!1,L_(Rn)}}}let Pie=64,Iie=64;function Rie(t){return{...t,target:[Math.max(-1e5,t.target[0]),0]}}function Oie(t,e,i){let s,c,h,p,v,l=Es,A=()=>(l(),l=Hz(s,Rt=>i(34,v=Rt)),s);Fc(t,bv,Rt=>i(31,c=Rt)),Fc(t,x0,Rt=>i(32,h=Rt)),Fc(t,u_,Rt=>i(33,p=Rt)),t.$$.on_destroy.push(()=>l());let{viewportHeight:P}=e,{viewportWidth:O}=e,L=!0,U=!0,H=!1,Y=0,J=!1,oe,me=!1,pe=0,be=!1,Oe,je=!0,st=!1,ut=!0,xe=!1,it=!1,Be;O<500&&(be=!0,pe=4,je=!1,ut=!1);let Qe,Ct,Kt=!1,Ie=null,fi=!1,Yi=["rgb(45, 181, 77)","rgb(66, 102, 235)","rgb(96, 216, 230)","rgb(168, 59, 157)","rgb(207, 21, 24)","rgb(225, 108, 51)","rgb(227, 198, 36)","rgb(235, 122, 184)"],ri=nE(","),vr=[],Gr,Tr=1,Ar=4.5;O<500&&(Ar=4.99);let kr,$r,Vn,Pn,Si,Ir,Er,Ki=[],In=!1,gn,Kn,mr=!1,cn={},Dr,yn=[0],Rn=[],ir=[],Ni=[],_r,Ur={},Cr={},Oi=[0],Nr,Ke;async function ie(){nO.accessToken="pk.eyJ1IjoiZG9jazQyNDIiLCJhIjoiY2x5YzVlcXZ4MW1qajJsb3RoeWI0bzhmZyJ9.DY653tAkLZCDMMEPuFvoGA",Nr=new nO.Map({container:"mapbox-map-container",interactive:!0,style:"mapbox://styles/dock4242/cm1p1kdvj00d501pd7l4g1dc5",center:[-74,40.7],zoom:9}),Nr.on("zoom",async()=>{i(9,Oe=Nr.getZoom())}),Nr.on("movestart",()=>{i(14,fi=!0)}),Nr.on("moveend",async()=>{Ke&&(console.log("clearing timeout"),clearTimeout(Ke)),Ke=setTimeout(async()=>{console.log("timeout triggered");let Rt=Nr.getBounds(),mi={result:{bbox:[Rt._sw.lng,Rt._sw.lat,Rt._ne.lng,Rt._ne.lat]}};Oe>10&&(await kt(mi,!1),console.log(Ir.length),Ci())},2e3)}),i(20,Ir=await Te([],Ct)),$r.setProps({controller:{scrollZoom:!1,dragPan:!0,touchZoom:!1,doubleClickZoom:!1,touchRotate:!1,dragRotate:!1}})}async function he(){Kt&&!je&&!ut&&(i(14,fi=!0),je=!0,ut=!0,await xr(),await pi(),$r.setProps({layers:ir.concat([ot,xt,$t])}),setTimeout(()=>{i(14,fi=!1)},500),console.log("show text layer",Tr,pe))}function Te(Rt,mi){let rr=Object.keys(Ur),zt=Object.keys(Cr),Qt;Rt.length>0?Qt=mi.filter(Sr=>Rt.indexOf(Sr.id)>-1):Qt=mi.map(Sr=>Sr);let Ut=O,Pi=P;it&&(Ut=O),Qe=CJ(Ut,Pi,Qt.length,10,it);let dr=Qe.rowSize;return Qt=Qt.map((Sr,Qr)=>{let on=0,$n=0,ue=Sr.id.replace(".jpg",""),ge=Dr.has(+ue)?Dr.get(+ue):null;ge&&(on=ge.count?ge.count:0,$n=ge.comment_count?ge.comment_count:0),rr.indexOf(ue)>-1&&(on=on+Ur[ue]),zt.indexOf(ue)>-1&&($n=$n+Cr[ue]);let _e=Qr%dr*Si.size+Qr%dr*.1,ze=Math.floor(Qr/dr)*Si.size+Math.floor(Qr/dr)*.1;return{coordinates:[_e,ze],id:ue,color:Sr.color,court_count:Qr,latLong:Sr.center.split(",").map(ft=>+ft),location:Sr.location,state:Sr.state,geo:Sr.geo,squareSize:dr,likes:on,comments:$n}}),vt&&(Qt=Qt.sort((Sr,Qr)=>{if(vt=="heart")return Qr.likes-Sr.likes;if(vt=="comment")return Qr.comments-Sr.comments}),Qt.forEach((Sr,Qr)=>{let on=Qr%dr*Si.size+Qr%dr*.1,$n=Math.floor(Qr/dr)*Si.size+Math.floor(Qr/dr)*.1;Sr.coordinates=[on,$n]})),Qt}async function Xe(){let Rt={};for(let mi of yn){let rr=Ct.map(Qt=>({geo:Qt.geo,x:+Qt.x,y:+Qt.y,width:Pie,height:Iie,mask:!1,id:Qt.id.replace(".jpg","").replace(".jpeg","")})).filter(Qt=>Qt.geo==mi);const zt={};for(let Qt of rr)zt[Qt.id]=Qt;Rt[mi]=zt}return Rt}function Je(){return new Promise(async(Rt,mi)=>{await ch("assets/load.basis").then(()=>{console.log("BasisLoader preloaded"),Rt()})})}function lt(Rt){return new Promise(async(mi,rr)=>{await ch(`assets/${Rt}.basis`).then(zt=>{console.log("basis loaded ",Rt);let Ut={data:zt[0],width:4096,height:4096,compressed:!0};Rn[Rt].iconAtlas=Ut,mi()})})}let It=0,Se=yn.length-1,ot,xt,$t;async function pi(){return new Promise(async(Rt,mi)=>{let rr={marker:{width:1500,height:1510,x:0,y:0,mask:!1}},zt={id:"IconLayer_test",getIcon:Qt=>"marker",data:Ir,getPosition:Qt=>Qt.coordinates,getSize:Si.size,sizeUnits:"common",visible:je,iconMapping:rr,iconAtlas:"assets/toolbar-3.png"};be||(zt.transitions={getPosition:{duration:500,easing:zy}}),xt=new Af({...zt}),Rt()})}async function Wi(){return new Promise(async(Rt,mi)=>{let rr=[];for(let zt of Ir){let Qt=JSON.stringify(zt.likes),Ut=JSON.stringify(zt.comments);rr.push({text:`${zt.location}, ${zt.state}`,position:[zt.coordinates[0]-.48*Si.size,zt.coordinates[1]+.44*Si.size],size:.08*Si.size}),rr.push({text:Qt,position:[zt.coordinates[0]+.41*Si.size,zt.coordinates[1]+.438*Si.size],size:.066*Si.size}),rr.push({text:Ut,position:[zt.coordinates[0]+.41*Si.size,zt.coordinates[1]+.314*Si.size],size:.066*Si.size})}Rt(rr)})}async function xr(){return new Promise(async(Rt,mi)=>{console.log(Be,je);let rr={data:Be,id:"TextLayer-test",getPosition:zt=>zt.position,getText:zt=>zt.text,maxWidth:10,getAlignmentBaseline:"top",fontFamily:"-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif",getAlignmentBaseline:"center",getColor:[255,255,255],visible:je,getSize:zt=>zt.size,getTextAnchor:"start",sizeUnits:"common",updateTriggers:{getText:Oi}};be||(rr.transitions={getPosition:{duration:500,easing:zy}}),$t=new gv({...rr}),Rt()})}async function Hi(){i(14,fi=!0),be&&(je=!1,ut=!1),await br(),await ns(),Be=await Wi(),nt(1,!0),setTimeout(async()=>{await pi(),await xr(),$r.setProps({layers:ir.concat([ot,xt,$t])}),vt||(Oi=[Oi[0]+1],Oi=[...Oi]),i(14,fi=!1)},1e3)}async function Ci(){let Rt;i(14,fi=!0),it?(ir=[],Be=await Wi()):(await br(),await ns(),Be=await Wi()),vt||(console.log("changing court fave count"),Oi=[Oi[0]+1],Oi=[...Oi]),Qe.rowSize!==0&&!it?(Rt=Math.log2(Qe.size/Si.size),nt(Rt-.2,!1)):it&&(Rt=Math.log2(Qe.size/Si.size),nt(Rt,!1)),await rs(),await xr(),await pi(),$r.setProps({layers:ir.concat([ot,xt,$t])}),setTimeout(async()=>{i(14,fi=!1)},100)}async function zi(){await pi(),Be=await Wi(),await xr(),$r.setProps({layers:ir.concat([ot,xt,$t])}),i(4,L=!0),i(8,me=!0),setTimeout(()=>{i(8,me=!1)},6e3)}async function er(){for(;await Rr();)ns(),$r.setProps({layers:ir});i(12,Kt=!0),console.log("loading done")}function Rr(){return console.log("fetching new chunk"),It<Se?(It++,new Promise(async(Rt,mi)=>{console.log(It),await ch(`assets/${It}.basis`).then(rr=>{console.log("basis loaded ",It);let Qt={data:rr[0],width:4096,height:4096,compressed:!0};Rn[It].iconAtlas=Qt,Rt(!0)})})):null}async function nn(){for(let Rt of yn){let mi={id:`IconLayer_${Rt}`,getIcon:rr=>rr.id,getPosition:rr=>rr.coordinates,getSize:Si.size,mask:!1,sizeUnits:"common",iconMapping:cn[Rt]};O>500&&(mi.transitions={getPosition:{duration:500,easing:zy}}),Rn.push(mi)}return await Je(),L||s.set(1).then(()=>{i(28,Ln=!0)}),await Promise.all(yn.slice(0,1).map(async Rt=>{await lt(Rt)})),!0}async function br(){console.log(Rn);for(let Rt in Rn){let mi=Ir.filter(rr=>rr.geo==yn[Rt]);Rn[Rt].data=mi}return!0}let Ln;async function rs(){return new Promise(async(Rt,mi)=>{ot=new WT({tileSize:512,debounceTime:100,courtsFaveCount:Oi,id:"tileLayer_",coordinateSystem:qr.CARTESIAN,onViewportLoad:zt=>{console.log(zt,"hi");let Qt=Ni.length;if(Ni=Array.from(zt.flatMap(Ut=>Ut.content?Ut.content:[]).reduce((Ut,Pi)=>(Ut.has(+Pi.id)||Ut.set(+Pi.id,Pi),Ut),new Map).values()),Qt==0&&Ni.length>0&&kr){const Ut=O,Pi=P,dr=[kr[0],kr[1],0],Sr=-Ut/2,Qr=Ut/2,on=Pi/2,$n=-Pi/2,ue=new WL({width:Ut,height:Pi,left:Sr,right:Qr,top:on,bottom:$n,target:dr,zoom:Tr});un(ue)}},getTileData:async({id:zt,bbox:Qt,signal:Ut})=>Tr<Ar&&!it||Ut.aborted?null:et(Qt,zt,Ut),updateTriggers:{renderSubLayers:[Oi],getTileData:[Oi]},renderSubLayers:zt=>{zt.tile;let Qt=[];if(zt.data&&zt.data.length>0)for(let Ut in zt.data){zt.data[Ut].tileId=zt.id;let Pi=zt.data[Ut].id,dr=zt.data[Ut].coordinates,Sr=[dr[0]-Si.size/2,dr[1]+Si.size/2,dr[0]+Si.size/2,dr[1]-Si.size/2],Qr="jpg",on=`https://s3.amazonaws.com/pudding.cool/projects/courts/${Qr}/${Pi}.${Qr}`;if(O<500&&(Qr="webp",on=`https://s3.amazonaws.com/pudding.cool/projects/courts/${Qr}/150/${Pi}.${Qr}`),Tr>Ar&&zt.tile.zoom>3||it){const $n=new IT(zt,{image:on,id:`${zt.id}_${Pi}_bitmap`,bounds:Sr});Qt.push($n)}}return zt.tile,Qt}}),Rt()})}async function ns(){ir=[];for(let Rt in Rn.slice(0,It+1)){let mi=new Af({...Rn[Rt]});ir.push(mi)}return!0}function Yr(Rt,mi){return Rt&&mi?mi.project([Rt[0]-Si.size/2,Rt[1]-Si.size/2]):[0,0]}function un(Rt){i(15,vr=Ni.map(mi=>{let rr=Yr(mi.coordinates,Rt),zt=Yr([Si.size*2,0],Rt)[0]-Yr([Si.size,0],Rt)[0];return{id:mi.id,screenPosition:rr,screenWidth:zt,info:mi}}))}async function et(Rt,mi,rr){if(console.log("getting data"),await new Promise(Sr=>setTimeout(Sr,100)),!Ct)return[];if(rr.aborted)return null;const{left:zt,right:Qt,top:Ut,bottom:Pi}=Rt;let dr=[];for(let Sr=0;Sr<Ir.length;Sr++){const Qr=Ir[Sr],[on,$n]=Qr.coordinates;it?on>=zt&&on<=Qt&&$n>=Ut&&$n<=Pi&&dr.push(Qr):on+Si.size/2>=zt&&on+Si.size/2<=Qt&&$n+Si.size/2>=Ut&&$n+Si.size/2<=Pi&&dr.push(Qr)}return dr}t1(async()=>{i(22,In=!0),Ct=await new Promise(async(zt,Qt)=>{const Ut=await q5("assets/data.csv");zt(Ut)});let Rt=O,mi=P;it&&(Rt=200),i(19,Si=AJ(Rt,mi,Ct.length)),await new Promise(async(zt,Qt)=>{const Pi=await(await fetch("assets/land-110m.json")).json();zt(Pi)}).then(zt=>{i(27,_r=zt)}),await new Promise(async(zt,Qt)=>{i(26,Dr=Qz(await Tee(),Ut=>Ut.court_id)),console.log(Dr),zt(Dr)}).then(zt=>{console.log(zt)});let rr=dN();Z8({basis:{format:rr,maxConcurrency:1,CDN:!1,worker:!0,useLocalLibraries:!0,workerUrl:"libs-2/basis-worker.js"},worker:!0,CDN:!1,maxConcurrency:1,useLocalLibraries:!0}),eD(_J),i(20,Ir=await Te([],Ct)),Y=[...Ir],console.log("sprite positions loaded"),cn=await Xe(),await nn(),await br(),oe=new Sie({accessToken:"pk.eyJ1IjoiZG9jazQyNDIiLCJhIjoiY2x5YzVlcXZ4MW1qajJsb3RoeWI0bzhmZyJ9.DY653tAkLZCDMMEPuFvoGA",types:"region,postcode,district,place,neighborhood",options:{marker:!1}}),oe.addTo(Pn),oe.setPlaceholder("Search for a location..."),oe.setCountries("pr,us,vi,gu"),oe.on("result",async zt=>{if("result".indexOf(Object.keys(zt))>-1)if(vt=null,i(13,Ie=null),it)Nr.fitBounds(zt.result.bbox);else{await kt(zt,!1),Ci();const Qt=document.querySelector(".mapboxgl-ctrl-geocoder input");Qt&&Qt.blur(),i(6,H=zt.result.text)}}),$r=new TT({parent:Gr,views:new Cc,initialViewState:{target:[O/2,P/2,0],zoom:Tr,transitionInterpolator:new C_(["zoom","target"]),transitionDuration:1e3},getCursor:({isDragging:zt})=>xe?"pointer":zt?"grabbing":"grab",onHover:({x:zt,y:Qt})=>{if(!be){let Ut=vr.filter(Pi=>{let dr=[Pi.screenPosition[0],Pi.screenPosition[0]+Pi.screenWidth,Pi.screenPosition[1],Pi.screenPosition[1]+Pi.screenWidth];return dr[0]<zt&&dr[1]>zt&&dr[2]<Qt&&Qt<dr[3]});if(Ut.length>0){let Pi=Ut[0],dr=(zt-Pi.screenPosition[0])/Pi.screenWidth,Sr=(Qt-Pi.screenPosition[1])/Pi.screenWidth;dr>.79?(Sr>.89||Sr>.75)&&(xe=!0):dr<.1&&Sr<.13?xe=!0:xe=!1}else xe=!1}},onClick:({x:zt,y:Qt})=>{console.log(zt,Qt);let Ut=vr.filter(Pi=>{let dr=[Pi.screenPosition[0],Pi.screenPosition[0]+Pi.screenWidth,Pi.screenPosition[1],Pi.screenPosition[1]+Pi.screenWidth];return dr[0]<zt&&dr[1]>zt&&dr[2]<Qt&&Qt<dr[3]});if(Ut.length>0){let Pi=Ut[0],dr=(zt-Pi.screenPosition[0])/Pi.screenWidth,Sr=(Qt-Pi.screenPosition[1])/Pi.screenWidth;dr>.79?Sr>.89?(console.log("heart clicked"),St(Pi.id,Pi,[zt,Qt])):Sr>.75&&wt(Pi.id):dr<.1&&Sr<.13&&(Pi.info.id,i(24,Kn=Pi.info.latLong),Rc(x0,h=!0,h))}},onLoad:()=>{i(23,gn=!0),er(),i(11,it=!0),ie()},onResize:zt=>{console.log("reszing",zt)},onViewStateChange:({viewState:zt})=>{i(3,Tr=zt.zoom),kr=zt.target;let Qt=O,Ut=P,Pi=new Cc().makeViewport({width:Qt,height:Ut,viewState:zt});un(Pi),$r.setProps({viewState:Rie(zt)})},controller:!0,layers:ir})});function nt(Rt,mi){return new Promise((rr,zt)=>{console.log("zoomStart");const Qt=new C_({transitionProps:["zoom","target"]});let Ut=[Math.floor(Qe.rowSize*Si.size/2),Math.floor(Ir.length/Qe.rowSize)*Si.size/2,0];if(mi)$r.setProps({views:new Cc,initialViewState:{target:[O/2,P/2,0],zoom:1,controller:!0,layers:ir}});else if(it)console.log("resetting zoom"),$r.setProps({views:new Cc,viewState:{target:[Math.floor(O/Qe.size*Si.size/2)-2,0,0],zoom:Rt,controller:!0,transitionDuration:0}});else if(be)$r.setProps({views:new Cc,initialViewState:{target:Ut,zoom:Rt,controller:!0,layers:ir}});else{let Pi=1e3;Ir.length==Ct.length&&O<500&&(Pi=0),$r.setProps({views:new Cc,initialViewState:{target:Ut,zoom:Rt,controller:!0,transitionDuration:Pi,transitionInterpolator:Qt,transitionEasing:zy,layers:ir,onTransitionEnd:()=>{}}})}})}let yt=[-100,-100];async function St(Rt,mi,rr){i(29,yt=rr),i(17,Vn=`#${ri(mi.info.court_count)} in ${mi.info.location}, ${mi.info.state}`),i(25,mr=!0),Ur[Rt]=(Ur[Rt]||0)+1,i(20,Ir=await Te(Ki,Ct)),Be=await Wi(),Oi=[Oi[0]+1],Oi=[...Oi],await xr(),$r.setProps({layers:ir.concat([ot,xt,$t])}),Eee(Rt),setTimeout(()=>{i(25,mr=!1)},3e3)}async function wt(Rt){i(21,Er=Rt),Rc(u_,p=!0,p)}async function Dt(Rt){const mi=Rt.detail;Cr[mi]=(Cr[mi]||0)+1,Oi=[Oi[0]+1],Oi=[...Oi],i(20,Ir=await Te(Ki,Ct)),Be=[...await Wi()],Oi=[Oi[0]+1],Oi=[...Oi],await xr(),$r.setProps({layers:ir.concat([ot,xt,$t])})}function kt(Rt,mi){return console.log(Rt),new Promise((rr,zt)=>{Rt?(Ki=DU(Ct,Rt,"bbox"),Ki.length==0&&(Ki=["none"])):mi?(Ki=LU(Ct,mi),Ki.length==0&&(Ki=["none"])):Ki=[],i(20,Ir=Te(Ki,Ct)),rr()})}let vt=null;async function Ft(Rt){vt=Rt,i(13,Ie=null),oe.setInput(""),i(6,H=null),await kt(!1,!1),Hi()}async function At(Rt,mi,rr){Rt=="like"?St(mi.id,mi,[rr.x,rr.y]):Rt=="comment"?wt(mi.id):Rt=="mag"&&(mi.info.id,i(24,Kn=mi.info.latLong),Rc(x0,h=!0,h))}async function ui(){Rc(bv,c=!0,c)}async function bi(Rt){console.log(Tr),Rt=="out"?nt(Tr-1):nt(Tr+1)}async function Gt(){oe.setInput(""),vt=null,i(6,H=null),Ki=[],vt=null,i(13,Ie=null),i(20,Ir=Y),Hi()}async function hr(Rt){vt=null,oe.setInput(""),i(6,H=null),Ie!==Rt?(i(13,Ie=Rt),await kt(!1,Rt),Ci()):(i(13,Ie=null),i(20,Ir=Y),Hi())}function Lr(){console.log("world finished"),i(5,U=!0)}const Pr=()=>{Rc(x0,h=!1,h)},bn=()=>{i(10,st=!0)},jn=()=>zi(),qi=()=>Gt();function hn(Rt){vw[Rt?"unshift":"push"](()=>{Pn=Rt,i(18,Pn)})}const ss=()=>bi("in"),sn=()=>bi("out"),ws=Rt=>hr(Rt),As=()=>Ft("heart"),hs=()=>Ft("comment");function ks(){J=this.checked,i(7,J)}const lo=()=>ui();function Ta(Rt){vw[Rt?"unshift":"push"](()=>{Gr=Rt,i(16,Gr)})}const eo=(Rt,mi)=>At("like",Rt,mi),Ms=(Rt,mi)=>At("comment",Rt,mi),xo=(Rt,mi)=>At("mag",Rt,mi);return t.$$set=Rt=>{"viewportHeight"in Rt&&i(0,P=Rt.viewportHeight),"viewportWidth"in Rt&&i(1,O=Rt.viewportWidth)},t.$$.update=()=>{t.$$.dirty[0]&8&&console.log(Tr),t.$$.dirty[0]&12|t.$$.dirty[1]&32768&&be&&Tr>pe&&he()},A(i(30,s=qT(0,{duration:1e4}))),[P,O,be,Tr,L,U,H,J,me,Oe,st,it,Kt,Ie,fi,vr,Gr,Vn,Pn,Si,Ir,Er,In,gn,Kn,mr,Dr,_r,Ln,yt,s,c,h,p,v,Yi,ri,zi,Dt,Ft,At,ui,bi,Gt,hr,Lr,pe,Pr,bn,jn,qi,hn,ss,sn,ws,As,hs,ks,lo,Ta,eo,Ms,xo]}class kie extends Xc{constructor(e){super(),Zc(this,e,Oie,Cie,zl,{viewportHeight:0,viewportWidth:1},null,[-1,-1,-1,-1,-1])}}function tk(t){let e,i;return e=new kie({props:{viewportWidth:t[0].width,viewportHeight:t[0].height}}),{c(){mh(e.$$.fragment)},l(s){_h(e.$$.fragment,s)},m(s,c){gh(e,s,c),i=!0},p(s,c){const h={};c&1&&(h.viewportWidth=s[0].width),c&1&&(h.viewportHeight=s[0].height),e.$set(h)},i(s){i||(yr(e.$$.fragment,s),i=!0)},o(s){Kr(e.$$.fragment,s),i=!1},d(s){yh(e,s)}}}function Die(t){let e,i,s="",c,h=t[1]&&t[0]&&tk(t);return{c(){h&&h.c(),e=or(),i=Vt("div"),i.innerHTML=s,this.h()},l(p){h&&h.l(p),e=ar(p),i=jt(p,"DIV",{class:!0,"data-svelte-h":!0}),rn(i)!=="svelte-199sfvp"&&(i.innerHTML=s),this.h()},h(){tt(i,"class","overlay svelte-16ft1lt")},m(p,v){h&&h.m(p,v),Zi(p,e,v),Zi(p,i,v),c=!0},p(p,[v]){p[1]&&p[0]?h?(h.p(p,v),v&3&&yr(h,1)):(h=tk(p),h.c(),yr(h,1),h.m(e.parentNode,e)):h&&(Fo(),Kr(h,1,1,()=>{h=null}),Bo())},i(p){c||(yr(h),c=!0)},o(p){Kr(h),c=!1},d(p){p&&(bt(e),bt(i)),h&&h.d(p)}}}function Lie(t,e,i){let s;Fc(t,Kz,h=>i(0,s=h));let c;return t1(async()=>{i(1,c=!0)}),t.$$.update=()=>{t.$$.dirty&1&&console.log(s)},[s,c]}class Nie extends Xc{constructor(e){super(),Zc(this,e,Lie,Die,zl,{})}}const Fie="Title TK",Bie="Description tk.",ik={title:Fie,description:Bie};function zie(){console.log("--- --- --- --- --- ---"),console.log("svelte-starter: 5.17.0"),console.log("build: 2024-10-01-23:58"),console.log("--- --- --- --- --- ---")}function Uie(t){let e,i,s,c;return e=new n5({props:{title:t[1],description:t[2],url:t[3],preloadFont:t[0],keywords:t[4]}}),s=new Nie({}),{c(){mh(e.$$.fragment),i=or(),mh(s.$$.fragment)},l(h){_h(e.$$.fragment,h),i=ar(h),_h(s.$$.fragment,h)},m(h,p){gh(e,h,p),Zi(h,i,p),gh(s,h,p),c=!0},p:Es,i(h){c||(yr(e.$$.fragment,h),yr(s.$$.fragment,h),c=!0)},o(h){Kr(e.$$.fragment,h),Kr(s.$$.fragment,h),c=!1},d(h){h&&bt(i),yh(e,h),yh(s,h)}}}function Vie(t,e,i){let{data:s}=e;zie();const c=[],{title:h,description:p,url:v,keywords:l}=ik;return h3("copy",ik),h3("data",s.data),t.$$set=A=>{"data"in A&&i(5,s=A.data)},[c,h,p,v,l,s]}class Qie extends Xc{constructor(e){super(),Zc(this,e,Vie,Uie,zl,{data:5})}}export{Qie as component};
